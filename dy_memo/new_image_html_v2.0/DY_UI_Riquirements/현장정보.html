<!doctype html>
<html lang="ko" data-theme="light">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
  <title>INOPNC · 현장정보 카드</title>
  
  <!-- 캐시 방지 메타 태그 -->
  <meta http-equiv="Cache-Control" content="no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;600;700;800;900&display=swap" rel="stylesheet"/>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            'good': '#0068FE'
          }
        }
      }
    }
  </script>

  <style>
    :root{
      --font:'Noto Sans KR',system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
      --bg:#f5f7fb; --card:#ffffff; --text:#101828; --muted:#667085; --line:#E6ECF4;
      --brand:#1A254F; --brand-ghost:rgba(26,37,79,.06); --blue:#0068FE; --navy:#1A254F;
    }
    body{ margin:0; background:var(--bg); color:var(--text); font-family:var(--font); font-size:15px; }
    main.container{ max-width:720px; margin:0 auto; padding:20px 16px 80px; }

    /* 카드/버튼 기본 */
    .card{ background:var(--card); border:1px solid var(--line); border-radius:14px; padding:14px; box-shadow:0 2px 10px rgba(2,6,23,.04); }
    .row{ display:flex; align-items:center; gap:10px; }
    .between{ display:flex; align-items:center; justify-content:space-between; gap:12px; }
    .muted{ color:var(--muted); }
    .btn{ 
        height:36px; 
        border-radius:10px; 
        border:1px solid var(--line); 
        background:#fff; 
        padding:0 12px; 
        font-family: "Noto Sans KR", system-ui, sans-serif;
        font-size:13px; 
        font-weight:700; 
        color:#1f2937; 
        cursor:pointer;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        overflow: hidden;
    }
    .btn:hover{ 
        background:var(--brand-ghost);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    .btn:active{
        transform: translateY(0);
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
        transition: all 0.1s ease;
    }
    .btn:focus{
        outline: none;
        box-shadow: 0 0 0 3px rgba(26, 37, 79, 0.3);
    }
    .btn.clicked{
        animation: buttonRipple 0.6s ease-out;
    }
    .btn-blue{ border-color:#BBD7FF; color:#1A56DB; background:#EFF6FF; }
    .btn-ghost{ background:#fff; }
    .btn-icon{ 
      height: 30px;
      padding: 0 10px;
      border-radius: 8px;
      font-family: "Noto Sans KR", system-ui, sans-serif;
      font-weight: 700;
      font-size: 13px;
      background: #fff;
      border: 1px solid var(--line);
      color: #1f2937;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      user-select: none;
      position: relative;
      overflow: hidden;
    }
    
    /* 버튼 호버 효과 (상세버튼과 동일) */
    .btn-icon:hover {
      background: var(--brand-ghost);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    
    /* 버튼 클릭 효과 (홈의 작업공정 선택박스와 동일) */
    .btn-icon:active {
      transform: scale(0.95);
      transition: transform 0.1s ease;
    }
    
    /* 버튼 포커스 효과 */
    .btn-icon:focus {
      outline: none;
      border-color: #1890ff;
      box-shadow: 0 0 0 3px rgba(24, 144, 255, 0.3);
    }
    
    /* 버튼 클릭 시 리플 효과 (홈의 작업공정 선택박스와 동일) */
    .btn-icon.clicked {
      animation: chipRipple 0.6s ease-out;
    }
    
    /* 칩 리플 애니메이션 */
    @keyframes chipRipple {
      0% {
        transform: scale(1);
        box-shadow: 0 0 0 0 rgba(26, 86, 219, 0.4);
      }
      50% {
        transform: scale(1.02);
        box-shadow: 0 0 0 8px rgba(26, 86, 219, 0.1);
      }
      100% {
        transform: scale(1);
        box-shadow: 0 0 0 0 rgba(26, 86, 219, 0);
      }
    }
    
    /* 다크모드 버튼 스타일 (상세버튼과 동일) */
    [data-theme="dark"] .btn-icon {
      background: var(--card);
      border-color: var(--line);
      color: var(--text);
    }
    
    [data-theme="dark"] .btn-icon:hover {
      background: var(--brand-ghost);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }
    
    [data-theme="dark"] .btn-icon:focus {
      border-color: #2F6BFF;
      box-shadow: 0 0 0 3px rgba(47, 107, 255, 0.3);
    }
    
    [data-theme="dark"] .btn-icon.clicked {
      animation: chipRippleDark 0.6s ease-out;
    }
    
    /* 다크모드 알림팝업 X 닫기 버튼 스타일 */
    [data-theme="dark"] .preview-close {
      background: var(--card);
      border-color: var(--line);
      color: var(--text);
    }
    
    [data-theme="dark"] .preview-close:hover {
      background: var(--brand-ghost);
      border-color: var(--brand);
      color: var(--brand);
    }
    
    /* 다크모드 칩 리플 애니메이션 */
    @keyframes chipRippleDark {
      0% {
        transform: scale(1);
        box-shadow: 0 0 0 0 rgba(47, 107, 255, 0.4);
      }
      50% {
        transform: scale(1.02);
        box-shadow: 0 0 0 8px rgba(47, 107, 255, 0.1);
      }
      100% {
        transform: scale(1);
        box-shadow: 0 0 0 0 rgba(47, 107, 255, 0);
      }
    }
    
    /* 버튼 리플 애니메이션 */
    @keyframes buttonRipple {
        0% {
            transform: scale(1);
            box-shadow: 0 0 0 0 rgba(26, 37, 79, 0.4);
        }
        50% {
            transform: scale(1.02);
            box-shadow: 0 0 0 8px rgba(26, 37, 79, 0.1);
        }
        100% {
            transform: scale(1);
            box-shadow: 0 0 0 0 rgba(26, 37, 79, 0);
        }
    }
    
    /* 리플 이펙트 스타일 */
    .ripple-ink {
        position: absolute;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.35);
        transform: scale(0);
        animation: ripple 0.45s ease-out;
        pointer-events: none;
    }
    
    @keyframes ripple {
        to {
            transform: scale(1);
            opacity: 0;
        }
    }
    .chip{ height:40px; border:1px solid var(--line); border-radius:12px; padding:0 12px; display:inline-flex; align-items:center; font-size:14px; font-weight:600; background:#fff; }
    .pill{ padding:6px 12px; border:1px solid var(--line); border-radius:16px; font-size:13px; font-weight:700; background:#fff; cursor:pointer; }
    .pill[data-active="true"]{ background:#EFF6FF; color:#1A56DB; border-color:#BBD7FF; }

    /* 빠른메뉴 제목타이틀과 동일 */
    .quick-title{ display:flex; align-items:center; gap:6px; font-weight:700; font-size:15px; line-height:1.4; color:#1A254F; }
    .section-title{ font-weight:700; font-size:15px; color:#1A254F; }

    /* 홈 작업 내용 기록과 동일한 폰트 스타일 */
    .q {
      font-family: "Noto Sans KR", system-ui, sans-serif;
      font-weight: 700;
      font-size: 17px;
      line-height: 1.4;
      color: #1A254F;
    }
    
    /* 다크모드에서 q 클래스 색상 */
    [data-theme="dark"] .q{ color:#E9EEF5; }
    
    /* 현장 정보 카드 스타일 */
    .site-info-card .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
    }
    .site-info-card .site-name {
      font-family: "Noto Sans KR", system-ui, sans-serif;
      font-weight: 700;
      font-size: 17px;
      line-height: 1.4;
      color: #1A254F;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      max-width: 200px;
      min-width: 0;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .site-name-icon {
      width: 35px;
      height: 35px;
      flex-shrink: 0;
      object-fit: contain;
    }
    .site-info-card .header-info {
      display: flex;
      align-items: center;
      gap: 12px;
      flex-shrink: 0;
    }
    .site-info-card .work-date {
      font-family: 'Noto Sans KR', system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      font-size: 14px;
      font-weight: 600;
      color: #1A254F;
    }
    
    /* 다크모드에서 작업일자 색상 */
    [data-theme="dark"] .site-info-card .work-date {
      color: #E9EEF5;
    }
    
    /* 다크모드에서 현장명 색상 (홈의 .q 클래스와 동일) */
    [data-theme="dark"] .site-info-card .site-name {
      color: #E9EEF5;
    }
    .site-info-card .divider,
    .site-search-card .divider {
      height: 1px;
      background: #E6ECF4;
      margin: 12px 0;
    }
    
    [data-theme="dark"] .site-info-card .divider,
    [data-theme="dark"] .site-search-card .divider {
      background: #374151;
    }
    .site-info-card .info-section {
      margin-bottom: 12px;
    }
    .site-info-card .info-row {
      display: grid;
      grid-template-columns: 80px 1fr auto;
      gap: 2px;
      align-items: center;
      padding: 8px 0;
    }
    .site-info-card .btn-detail {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      height: 28px;
      background-color: rgba(41, 52, 208, 0.15);
      color: #2934D0;
      border: none;
      border-radius: 16px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      user-select: none;
      position: relative;
      overflow: hidden;
      padding: 6px 12px;
      min-width: 50px;
      text-shadow: none !important;
      box-shadow: none !important;
    }
    
    /* 상세버튼 호버 효과 (홈의 추가태그와 동일) */
    .site-info-card .btn-detail:hover {
      background-color: rgba(41, 52, 208, 0.25);
    }
    
    /* 다크모드 상세버튼 스타일 (홈의 추가태그와 동일) */
    [data-theme="dark"] .site-info-card .btn-detail {
      background-color: rgba(41, 52, 208, 0.3);
      color: #5B6BFF;
      font-weight: 600;
      border: none;
    }
    
    [data-theme="dark"] .site-info-card .btn-detail:hover {
      background-color: rgba(41, 52, 208, 0.4);
    }
    .site-info-card .detail-section {
      border-top: 1px solid var(--line);
      padding-top: 12px;
      margin-top: 12px;
    }
    
    /* 상세 정보 - 홈의 작성내용요약과 동일한 스타일 */
    .detail-section .space-y-3 > * + * {
      margin-top: 12px;
    }
    
    .detail-section .flex {
      display: flex;
    }
    
    .detail-section .justify-between {
      justify-content: space-between;
    }
    
    .detail-section .flex-col {
      flex-direction: column;
    }
    
    .detail-section .flex-1 {
      flex: 1 1 0%;
    }
    
    .detail-section .mr-4 {
      margin-right: 16px;
    }
    
    .detail-section .text-xs {
      font-size: 12px;
      line-height: 16px;
    }
    
    .detail-section .text-sm {
      font-size: 14px;
      line-height: 20px;
    }
    
    .detail-section .text-gray-500 {
      color: #6b7280;
    }
    
    .detail-section .font-medium {
      font-weight: 500;
    }
    
    .detail-section .mb-1 {
      margin-bottom: 4px;
    }
    
    /* 다크모드 상세 정보 */
    [data-theme="dark"] .detail-section .text-gray-500 {
      color: #9ca3af;
    }
    
    [data-theme="dark"] .detail-section .font-medium {
      color: #ffffff;
    }
    
    /* 현장 자료 버튼 스타일 (홈의 처음부터/저장하기 버튼과 동일) */
    .flex-1 {
      flex: 1 1 0%;
    }
    
    .h-\[48px\] {
      height: 48px;
    }
    
    .rounded-xl {
      border-radius: 12px;
    }
    
    .bg-gray-200 {
      background-color: #e5e7eb;
    }
    
    .text-gray-700 {
      color: #374151;
    }
    
    .bg-good {
      background-color: #1A254F;
    }
    
    .text-white {
      color: #ffffff;
    }
    
    .font-bold {
      font-weight: 700;
    }
    
    .gap-2 {
      gap: 8px;
    }
    
    .mt-4 {
      margin-top: 16px;
    }
    
    /* 현장 정보 검색 카드박스 스타일 */
    .site-search-card {
      margin-top: 16px;
    }
    
    .search-controls {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-bottom: 16px;
    }
    
    .search-bar {
      display: flex;
      gap: 8px;
      align-items: center;
    }
    
    .search-input {
      flex: 1;
      height: 40px;
      padding: 0 12px;
      border: 1px solid var(--line);
      border-radius: 8px;
      font-family: "Noto Sans KR", system-ui, sans-serif;
      font-size: 14px;
      background: var(--card);
      color: var(--text);
      transition: border-color 0.2s ease;
    }
    
    .search-input:focus {
      outline: none;
      border-color: #1890ff;
      box-shadow: 0 0 0 2px rgba(24, 144, 255, 0.2);
    }
    
    .search-btn {
      width: 40px;
      height: 40px;
      border: 1px solid var(--line);
      border-radius: 8px;
      background: var(--card);
      color: var(--text);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
    }
    
    .search-btn:hover {
      background: var(--brand-ghost);
      border-color: #1890ff;
    }
    
    .sort-controls {
      display: flex;
      gap: 8px;
    }
    
    .sort-btn {
      padding: 6px 12px;
      border: 1px solid var(--line);
      border-radius: 6px;
      background: var(--card);
      color: var(--text);
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .sort-btn.active {
      background: #1890ff;
      color: #ffffff;
      border-color: #1890ff;
    }
    
    .sort-btn:hover:not(.active) {
      background: var(--brand-ghost);
      border-color: #1890ff;
    }
    
    .site-summary-list {
      display: flex;
      flex-direction: column;
      gap: 0;
      background: #f8f9fa;
      border-radius: 12px;
      overflow: hidden;
    }
    
    .site-summary-item:first-child {
      border-top-left-radius: 0 !important;
      border-top-right-radius: 0 !important;
    }
    
    .site-summary-item:last-child {
      border-bottom-left-radius: 0 !important;
      border-bottom-right-radius: 0 !important;
    }
    
    .site-summary-item:hover {
      background: #f8f9fa;
      border-radius: 0 !important;
    }
    
    .site-summary-item:first-child:hover {
      border-top-left-radius: 0 !important;
      border-top-right-radius: 0 !important;
    }
    
    .site-summary-item:last-child:hover {
      border-bottom-left-radius: 0 !important;
      border-bottom-right-radius: 0 !important;
    }
    
    .site-summary-item:active {
      border-radius: 0 !important;
    }
    
    .site-summary-item {
      display: flex;
      align-items: center;
      padding: 16px 20px;
      background: #ffffff;
      border-bottom: 1px solid #e9ecef;
      cursor: pointer;
      transition: all 0.2s ease;
      position: relative;
    }
    
    .site-summary-item:last-child {
      border-bottom: none;
    }
    
    .site-summary-item:hover {
      background: #f8f9fa;
    }
    
    .site-summary-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    
    .site-summary-title {
      font-family: "Noto Sans KR", system-ui, sans-serif;
      font-weight: 600;
      font-size: 15px;
      color: #1a56db;
      line-height: 1.3;
    }
    
    .site-summary-site {
      font-family: "Noto Sans KR", system-ui, sans-serif;
      font-size: 13px;
      color: #6b7280;
      font-weight: 500;
    }
    
    .site-summary-date {
      font-family: "Noto Sans KR", system-ui, sans-serif;
      font-size: 13px;
      color: #6b7280;
      font-weight: 500;
      margin-left: auto;
      flex-shrink: 0;
    }
    
    /* 다크모드 스타일 */
    [data-theme="dark"] .search-input {
      background: var(--card);
      color: var(--text);
      border-color: var(--line);
    }
    
    [data-theme="dark"] .search-btn {
      background: var(--card);
      color: var(--text);
      border-color: var(--line);
    }
    
    [data-theme="dark"] .sort-btn {
      background: var(--card);
      color: var(--text);
      border-color: var(--line);
    }
    
    [data-theme="dark"] .site-item {
      background: var(--card);
      border-color: var(--line);
    }
    
    [data-theme="dark"] .site-summary-list {
      background: #1f2937;
    }
    
    [data-theme="dark"] .site-summary-item {
      background: var(--card);
      border-bottom-color: #374151;
    }
    
    [data-theme="dark"] .site-summary-item:hover {
      background: #374151;
    }
    
    [data-theme="dark"] .site-summary-title {
      color: #60a5fa;
    }
    
    [data-theme="dark"] .site-summary-site,
    [data-theme="dark"] .site-summary-date {
      color: #9ca3af;
    }
    
    .info-label{ font-family: "Noto Sans KR", system-ui, sans-serif; font-weight:700; color:#1A254F; min-width:0; }
    .info-val{ font-family: "Noto Sans KR", system-ui, sans-serif; min-width:0; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    .btn-wrap{ display:flex; gap:6px; }

    /* 새로운 검색바 스타일 (첨부이미지 스타일) */
    .search-bar-container {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 16px;
      width: 100%;
    }
    
    .search-input-wrapper {
      position: relative;
      flex: 1;
      display: flex;
      align-items: center;
      background: #f5f8fd;
      border-radius: 20px;
      padding: 8px 12px;
      height: 48px;
      min-width: 0;
      width: 100%;
    }
    
    .search-icon {
      color: #999;
      margin-right: 8px;
      flex-shrink: 0;
    }
    
    .search-input-new {
      flex: 1;
      border: none;
      background: transparent;
      outline: none;
      font: 400 16px 'Noto Sans KR', system-ui, -apple-system, 'Segoe UI', Roboto, 'Apple SD Gothic Neo', 'Malgun Gothic', sans-serif;
      color: #333;
      padding: 0;
    }
    
    .search-input-new::placeholder {
      color: #8a8a8a;
      font-weight: 400;
    }
    
    .clear-btn {
      background: none;
      border: none;
      color: #999;
      cursor: pointer;
      padding: 4px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }
    
    .clear-btn:hover {
      background: #e0e0e0;
    }
    
    .cancel-btn {
      background: none;
      border: none;
      color: #8a8a8a;
      font: 400 16px 'Noto Sans KR', system-ui, -apple-system, 'Segoe UI', Roboto, 'Apple SD Gothic Neo', 'Malgun Gothic', sans-serif;
      cursor: pointer;
      padding: 8px 12px;
      flex-shrink: 0;
      white-space: nowrap;
    }
    
    .cancel-btn:hover {
      color: #666;
    }
    
    /* 다크모드 검색바 스타일 */
    [data-theme="dark"] .search-input-wrapper {
      background: #2a2a2a;
    }
    
    [data-theme="dark"] .search-icon {
      color: #666;
    }
    
    [data-theme="dark"] .search-input-new {
      color: #E9EEF5;
    }
    
    [data-theme="dark"] .search-input-new::placeholder {
      color: #8a8a8a;
    }
    
    [data-theme="dark"] .clear-btn {
      color: #666;
    }
    
    [data-theme="dark"] .clear-btn:hover {
      background: #3a3a3a;
    }
    
    [data-theme="dark"] .cancel-btn {
      color: #8a8a8a;
    }

    /* NPC 추가 기능 선택 팝업 스타일 */
    .npc-add-menu-popup {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 10000;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .npc-add-menu-content {
      background: var(--card);
      border-radius: 16px;
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
      max-width: 400px;
      width: 90%;
      max-height: 80vh;
      overflow: hidden;
    }

    .npc-add-menu-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 20px 24px 16px;
      border-bottom: 1px solid var(--line);
    }

    .npc-add-menu-header h3 {
      margin: 0;
      font-size: 18px;
      font-weight: 700;
      color: var(--text);
      font-family: "Noto Sans KR", system-ui, sans-serif;
    }

    .npc-add-menu-close {
      /* 통일된 닫기 버튼 스타일 */
      padding: 8px 16px;
      border: 1px solid var(--line);
      background: var(--bg);
      color: var(--text);
      font-size: 14px;
      font-weight: 600;
      font-family: "Noto Sans KR", system-ui, sans-serif;
      cursor: pointer;
      border-radius: 6px;
      transition: all 0.2s ease;
    }

    .npc-add-menu-close:hover {
      background: var(--brand-ghost);
      border-color: var(--brand);
      color: var(--brand);
    }

    .npc-add-menu-options {
      display: flex;
      gap: 12px;
      padding: 20px 24px;
      justify-content: center;
    }

    .npc-add-menu-option {
      padding: 12px 20px;
      border: none;
      background: #f5f8fd;
      border-radius: 20px;
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 14px;
      font-weight: 600;
      color: #374151;
      font-family: "Noto Sans KR", system-ui, sans-serif;
      white-space: nowrap;
      min-width: 80px;
      text-align: center;
    }

    .npc-add-menu-option:hover {
      background: #e5e7eb;
      color: #1f2937;
    }

    .npc-add-menu-option:active {
      background: #d1d5db;
      transform: translateY(1px);
    }

    /* 다크모드 스타일 */
    [data-theme="dark"] .npc-add-menu-option {
      background: #374151;
      color: #e5e7eb;
    }

    [data-theme="dark"] .npc-add-menu-option:hover {
      background: #4b5563;
      color: #f3f4f6;
    }

    [data-theme="dark"] .npc-add-menu-option:active {
      background: #6b7280;
    }

    [data-theme="dark"] .npc-add-menu-close {
      background: var(--card);
      border-color: var(--line);
      color: var(--text);
    }
    
    [data-theme="dark"] .npc-add-menu-close:hover {
      background: var(--brand-ghost);
      border-color: var(--brand);
      color: var(--brand);
    }
    
    [data-theme="dark"] .cancel-btn:hover {
      color: #999;
    }

    /* 홈의 버튼 스타일과 동일하게 적용 */
    #siteDrawingBtn {
      background-color: #99A4BE !important;
      color: #ffffff !important;
      font-weight: 700 !important;
      font-size: 14px !important;
      transition: all 0.3s ease;
      cursor: pointer;
    }
    
    #siteDrawingBtn:hover {
      background-color: #8A96B0 !important;
    }
    
    #ptwBtn {
      background-color: #1A254F !important;
      color: #ffffff !important;
      font-weight: 700 !important;
      font-size: 14px !important;
      transition: all 0.3s ease;
      cursor: pointer;
    }
    
    #ptwBtn:hover {
      background-color: #162043 !important;
    }
    
    /* 다크모드 버튼 스타일 */
    [data-theme="dark"] #siteDrawingBtn {
      background-color: #2A323C !important;
      color: #E9EEF5 !important;
      font-weight: 700 !important;
      font-size: 14px !important;
    }
    
    [data-theme="dark"] #siteDrawingBtn:hover {
      background-color: #3A424C !important;
    }
    
    [data-theme="dark"] #ptwBtn {
      background-color: #2F6BFF !important;
      color: #ffffff !important;
      font-weight: 700 !important;
      font-size: 14px !important;
    }
    
    [data-theme="dark"] #ptwBtn:hover {
      background-color: #4A7BFF !important;
    }

    @media (max-width:420px){
      .info-row{ grid-template-columns:96px 1fr auto; gap: 2px; }
      .site-info-card .site-name {
        max-width: 150px;
      }
      
      /* 모바일 검색바 반응형 */
      .search-bar-container {
        gap: 8px;
        margin-bottom: 12px;
      }
      
      .search-input-wrapper {
        padding: 6px 10px;
        height: 44px;
      }
      
      .search-input-new {
        font-size: 14px;
      }
      
      .cancel-btn {
        font-size: 14px;
        padding: 6px 8px;
      }
    }
    
    @media (max-width:360px){
      .search-bar-container {
        gap: 6px;
      }
      
      .search-input-wrapper {
        padding: 4px 8px;
        height: 40px;
      }
      
      .search-input-new {
        font-size: 13px;
      }
      
      .cancel-btn {
        font-size: 13px;
        padding: 4px 6px;
      }
      
      .site-info-card .site-name {
        max-width: 120px;
      }
    }
    
    /* 큰글씨 모드에서 현장명 크기 조정 (홈의 .q 클래스와 동일) */
    body.fs-150 .site-info-card .site-name {
      font-size: 1.25rem;
      margin-bottom: 0.5rem;
      word-break: keep-all;
      overflow-wrap: break-word;
      line-height: 1.4;
    }
    
    /* 소속, 안전, 주소, 숙소 폰트 스타일 (워크로그 급여요약표 기본급과 동일) */
    .site-info-card .info-label {
      font-family: "Noto Sans KR", system-ui, sans-serif;
      font-size: 15px;
      font-weight: 600;
      color: #6b7280;
    }
    
    .site-info-card .info-val {
      font-family: "Noto Sans KR", system-ui, sans-serif;
      font-size: 15px;
      font-weight: 600;
      color: #111827;
    }

    /* 현장정보와 동일한 성격의 폰트 (급여명세서 휴무와 같은 회색계열) */
    .site-info-card .info-label {
      font-family: "Noto Sans KR", system-ui, sans-serif;
      font-size: 15px;
      font-weight: 600;
      color: #6b7280;
    }

    /* 정보 값 폰트 색상 (급여명세서 최근 3개월과 같은 색상) */
    .site-info-card .info-val {
      font-family: "Noto Sans KR", system-ui, sans-serif;
      font-size: 15px;
      font-weight: 600;
      color: #111827;
    }

    /* 현장명 폰트 색상 (이안전과 같은 색상) */
    .site-summary-title {
      color: #1A254F;
      font-family: "Noto Sans KR", system-ui, sans-serif;
      font-size: 15px;
      font-weight: 600;
    }
    
    /* 다크모드에서 소속, 안전, 주소, 숙소 폰트 색상 (워크로그 급여요약표와 동일) */
    [data-theme="dark"] .site-info-card .info-label {
      color: #ffffff;
    }
    
    [data-theme="dark"] .site-info-card .info-val {
      color: #ffffff;
    }

    /* 다크모드에서 현장명 폰트 색상 */
    [data-theme="dark"] .site-summary-title {
      color: #ffffff;
    }

    
    /* 큰글씨 모드에서 소속, 안전, 주소, 숙소 폰트 크기 조정 (워크로그 급여요약표와 동일) */
    body.fs-150 .site-info-card .info-label {
      font-size: 1.125rem;
      word-break: keep-all;
      overflow-wrap: break-word;
      line-height: 1.3;
    }

    /* 주소, 숙소 내용 클릭 시 내용 표시 효과 */
    .site-info-card .info-val.expandable {
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
      white-space: nowrap;
      text-overflow: ellipsis;
    }

    .site-info-card .info-val.expandable.expanded {
      white-space: normal;
      word-break: break-all;
      background-color: rgba(26, 37, 79, 0.08);
      border-radius: 6px;
      padding: 8px 12px;
      margin: -8px -12px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      z-index: 10;
      position: relative;
    }

    /* 다크모드에서 주소, 숙소 확장 효과 */
    [data-theme="dark"] .site-info-card .info-val.expandable.expanded {
      background-color: rgba(255, 255, 255, 0.15);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    }

    
    body.fs-150 .site-info-card .info-val {
      font-size: 1.125rem;
      word-break: keep-all;
      overflow-wrap: break-word;
      line-height: 1.3;
    }
    





    
    /* 텍스트 선택 시 배경색 제거 */
    ::selection {
      background: transparent;
    }
    
    ::-moz-selection {
      background: transparent;
    }
    
    /* 첨부파일 팝업 스타일 */
    .attachment-popup {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 10000;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .attachment-popup.show {
      display: flex;
    }

    .attachment-popup-content {
      background: var(--card);
      border-radius: 16px;
      max-width: 500px;
      width: 100%;
      max-height: calc(100vh - 40px);
      overflow: hidden;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
      animation: popupSlideIn 0.3s ease-out;
      display: flex;
      flex-direction: column;
    }

    @keyframes popupSlideIn {
      from {
        opacity: 0;
        transform: translateY(-20px) scale(0.95);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    .attachment-popup-header {
      padding: 20px 24px 16px;
      border-bottom: 1px solid var(--line);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .attachment-popup-title {
      font-family: "Noto Sans KR", system-ui, sans-serif;
      font-size: 18px;
      font-weight: 700;
      color: var(--text);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .attachment-popup-close {
      padding: 8px 16px;
      border: 1px solid var(--line);
      background: var(--bg);
      color: var(--text);
      font-size: 14px;
      font-weight: 600;
      font-family: "Noto Sans KR", system-ui, sans-serif;
      cursor: pointer;
      border-radius: 6px;
      transition: all 0.2s ease;
    }

    .attachment-popup-close:hover {
      background: var(--brand-ghost);
      border-color: var(--brand);
      color: var(--brand);
    }

    .attachment-popup-body {
      padding: 20px 24px;
      max-height: 60vh;
      overflow-y: auto;
    }

    .attachment-preview {
      display: none;
      margin: 16px 12px 0 12px;
      border: 1px solid var(--line);
      border-radius: 8px;
      overflow: hidden;
      max-height: 60vh;
      flex-shrink: 0;
    }

    .attachment-preview.show {
      display: flex;
      flex-direction: column;
    }

    .preview-header {
      background: var(--bg);
      padding: 12px 16px;
      border-bottom: 1px solid var(--line);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .preview-title {
      font-family: "Noto Sans KR", system-ui, sans-serif;
      font-size: 14px;
      font-weight: 600;
      color: var(--text);
    }

    .preview-close {
      /* 기존 팝업의 닫기 버튼과 동일한 CSS 적용 */
      padding: 8px 16px;
      border: 1px solid var(--line);
      background: var(--bg);
      color: var(--text);
      font-size: 14px;
      font-weight: 600;
      font-family: "Noto Sans KR", system-ui, sans-serif;
      cursor: pointer;
      border-radius: 6px;
      transition: all 0.2s ease;
    }

    .preview-close:hover {
      background: var(--brand-ghost);
      border-color: var(--brand);
      color: var(--brand);
    }

    .preview-content {
      padding: 16px;
      background: var(--card);
      min-height: 200px;
      max-height: 50vh;
      overflow-y: auto;
      display: flex;
      align-items: center;
      justify-content: center;
      flex: 1;
    }

    .preview-pdf {
      width: 100%;
      height: 100%;
      min-height: 300px;
      max-height: 50vh;
      border: none;
    }

    .preview-image {
      max-width: 100%;
      max-height: 50vh;
      object-fit: contain;
      border-radius: 4px;
    }

    .preview-text {
      font-family: "Noto Sans KR", system-ui, sans-serif;
      font-size: 14px;
      color: var(--muted);
      text-align: center;
    }

    .preview-actions {
      display: flex;
      gap: 8px;
      margin-top: 12px;
      margin-bottom: 12px;
      margin-right: 12px;
      justify-content: flex-end;
    }

    .preview-btn {
      padding: 8px 16px;
      border: 1px solid var(--line);
      border-radius: 6px;
      background: var(--card);
      color: var(--text);
      font-family: "Noto Sans KR", system-ui, sans-serif;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .preview-btn:hover {
      background: var(--brand-ghost);
      border-color: var(--brand);
    }

    .preview-btn.primary {
      background: var(--brand);
      color: #ffffff;
      border-color: var(--brand);
    }

    .preview-btn.primary:hover {
      background: #162043;
    }

    .attachment-section {
      margin-bottom: 24px;
    }

    .attachment-section:last-child {
      margin-bottom: 0;
    }

    .attachment-section-title {
      font-family: "Noto Sans KR", system-ui, sans-serif;
      font-size: 16px;
      font-weight: 600;
      color: var(--text);
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .attachment-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .attachment-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 16px;
      background: var(--bg);
      border: 1px solid var(--line);
      border-radius: 8px;
      transition: all 0.2s ease;
    }

    .attachment-item:hover {
      background: var(--brand-ghost);
      border-color: var(--brand);
    }

    .attachment-info {
      display: flex;
      align-items: center;
      gap: 12px;
      flex: 1;
      min-width: 0;
    }

    .attachment-icon {
      width: 20px;
      height: 20px;
      flex-shrink: 0;
      object-fit: contain;
    }

    .attachment-details {
      flex: 1;
      min-width: 0;
    }

    .attachment-name {
      font-family: "Noto Sans KR", system-ui, sans-serif;
      font-size: 14px;
      font-weight: 600;
      color: var(--text);
      margin-bottom: 2px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .attachment-meta {
      font-family: "Noto Sans KR", system-ui, sans-serif;
      font-size: 12px;
      color: var(--muted);
    }

    .attachment-actions {
      display: flex;
      gap: 8px;
      flex-shrink: 0;
    }

    .attachment-btn {
      padding: 6px 12px;
      border: 1px solid var(--line);
      border-radius: 6px;
      background: var(--card);
      color: var(--text);
      font-family: "Noto Sans KR", system-ui, sans-serif;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .attachment-btn:hover {
      background: var(--brand-ghost);
      border-color: var(--brand);
    }

    .attachment-btn.primary {
      background: var(--brand);
      color: #ffffff;
      border-color: var(--brand);
    }

    .attachment-btn.primary:hover {
      background: #162043;
    }

    .attachment-empty {
      text-align: center;
      padding: 40px 20px;
      color: var(--muted);
      font-family: "Noto Sans KR", system-ui, sans-serif;
      font-size: 14px;
    }

    /* NPC-1000 자재관리 카드 스타일 - 홈 디자인 적용 */
    .npc-card {
      background: var(--card);
      border: 1px solid #E6ECF4;
      border-radius: 14px;
      padding: 14px;
      box-shadow: 0 2px 10px rgba(2,6,23,.04);
      margin-top: 20px;
      margin-bottom: 0;
    }
    
    [data-theme="dark"] .npc-card {
      border-color: var(--line) !important;
    }
    
    .npc-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
      padding-bottom: 12px;
      border-bottom: 1px solid #E6ECF4;
    }
    
    .npc-actions {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .npc-tag-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      height: 28px;
      background-color: rgba(0, 176, 208, 0.15);
      color: #00B0D0;
      border: none;
      border-radius: 16px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      user-select: none;
      position: relative;
      overflow: hidden;
      padding: 6px 12px;
      min-width: 50px;
      text-shadow: none !important;
      box-shadow: none !important;
      font-family: "Noto Sans KR", system-ui, sans-serif;
    }
    
    .npc-tag-btn:hover {
      background-color: rgba(0, 176, 208, 0.25);
    }
    
    /* 다크모드 추가 태그 스타일 */
    [data-theme="dark"] .npc-tag-btn {
      background-color: rgba(0, 176, 208, 0.3);
      color: #00B0D0;
      font-weight: 600;
      border: none;
    }
    
    [data-theme="dark"] .npc-tag-btn:hover {
      background-color: rgba(0, 176, 208, 0.4);
    }
    
    [data-theme="dark"] .npc-header {
      border-bottom-color: var(--line);
    }
    
    .npc-title {
      display: flex;
      align-items: center;
      gap: 8px;
      font-family: "Noto Sans KR", system-ui, sans-serif;
      font-weight: 700;
      font-size: 17px;
      line-height: 1.4;
      color: #1A254F;
    }
    
    .npc-title-icon {
      width: 35px;
      height: 35px;
      flex-shrink: 0;
      object-fit: contain;
      /* 이미지 로딩 실패 시 대체 처리 */
      background-color: #f8f9fa;
      border-radius: 6px;
    }
    
    /* 이미지 로딩 실패 시 대체 아이콘 표시 */
    .npc-title-icon:not([src]),
    .npc-title-icon[src=""],
    .npc-title-icon[src*="error"] {
      background: #f8f9fa url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzUiIGhlaWdodD0iMzUiIHZpZXdCb3g9IjAgMCAzNSAzNSIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjM1IiBoZWlnaHQ9IjM1IiByeD0iNiIgZmlsbD0iI0Y4RjlGQSIvPgo8cGF0aCBkPSJNMTcuNSAxMEwyNSAxNy41TDE3LjUgMjVMMTAgMTcuNUwxNy41IDEwWiIgZmlsbD0iIzlDQUFBRiIvPgo8cGF0aCBkPSJNMTcuNSAxNUwyMSAxNy41TDE3LjUgMjBMMTQgMTcuNUwxNy41IDE1WiIgZmlsbD0iI0ZGRkZGRiIvPgo8L3N2Zz4=') no-repeat center;
      background-size: 20px 20px;
    }
    
    /* 다크모드에서 이미지 로딩 실패 시 대체 아이콘 */
    [data-theme="dark"] .npc-title-icon:not([src]),
    [data-theme="dark"] .npc-title-icon[src=""],
    [data-theme="dark"] .npc-title-icon[src*="error"] {
      background: #374151 url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzUiIGhlaWdodD0iMzUiIHZpZXdCb3g9IjAgMCAzNSAzNSIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjM1IiBoZWlnaHQ9IjM1IiByeD0iNiIgZmlsbD0iIzM3NDE1MSIvPgo8cGF0aCBkPSJNMTcuNSAxMEwyNSAxNy41TDE3LjUgMjVMMTAgMTcuNUwxNy41IDEwWiIgZmlsbD0iIzlDQUFBRiIvPgo8cGF0aCBkPSJNMTcuNSAxNUwyMSAxNy41TDE3LjUgMjBMMTQgMTcuNUwxNy41IDE1WiIgZmlsbD0iI0ZGRkZGRiIvPgo8L3N2Zz4=') no-repeat center;
      background-size: 20px 20px;
    }
    
    [data-theme="dark"] .npc-title {
      color: #E9EEF5;
    }
    
    .npc-date-picker {
      border: 1px solid var(--line);
      border-radius: 8px;
      padding: 8px 12px;
      font-family: "Noto Sans KR", system-ui, sans-serif;
      font-size: 14px;
      background: var(--card);
      color: var(--text);
    }
    
    .npc-kpi-grid {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 12px;
      margin-bottom: 12px;
    }
    
    .npc-kpi-item {
      background: var(--card);
      border: 1px solid #E6ECF4;
      border-radius: 14px;
      padding: 14px;
      box-shadow: 0 2px 10px rgba(2,6,23,.04);
    }
    
    [data-theme="dark"] .npc-kpi-item {
      border-color: var(--line) !important;
    }
    
    .npc-kpi-label {
      font-family: "Noto Sans KR", system-ui, sans-serif;
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 2px;
    }
    
    .npc-kpi-value {
      font-family: "Noto Sans KR", system-ui, sans-serif;
      font-size: 24px;
      font-weight: 600;
      color: var(--text);
    }
    
    .npc-kpi-value.brand {
      color: #2934D0;
    }
    
    .npc-kpi-value.stock {
      color: #0068FE;
    }
    
    .npc-kpi-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 4px;
    }
    
    .npc-chip {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      border-radius: 9999px;
      border: 1px solid var(--line);
      padding: 4px 10px;
      font-family: "Noto Sans KR", system-ui, sans-serif;
      font-size: 12px;
      color: #1A254F;
      background: var(--card);
    }
    
    .npc-close-btn {
      /* 통일된 닫기 버튼 스타일 */
      padding: 8px 16px;
      border: 1px solid var(--line);
      background: var(--bg);
      color: var(--text);
      font-size: 14px;
      font-weight: 600;
      font-family: "Noto Sans KR", system-ui, sans-serif;
      cursor: pointer;
      border-radius: 6px;
      transition: all 0.2s ease;
    }
    
    .npc-close-btn:hover {
      background: var(--brand-ghost);
      border-color: var(--brand);
      color: var(--brand);
    }
    
    .npc-close-btn:active {
      transform: scale(0.98);
    }
    
    [data-theme="dark"] .npc-close-btn {
      background: var(--card);
      border-color: var(--line);
      color: var(--text);
    }
    
    [data-theme="dark"] .npc-close-btn:hover {
      background: var(--brand-ghost);
      border-color: var(--brand);
      color: var(--brand);
    }
    
    /* 다크모드 테이블 셀 클릭 효과 */
    [data-theme="dark"] .npc-table td.expanded {
      background-color: #374151;
    }
    
    .npc-buttons {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 8px;
    }
    
    .npc-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      border-radius: 10px;
      padding: 0 12px;
      font-family: "Noto Sans KR", system-ui, sans-serif;
      font-size: 13px;
      font-weight: 700;
      color: #1f2937;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
      height: 48px;
      border: 1px solid var(--line);
      background: #fff;
    }
    
    .npc-btn:hover {
      background: var(--brand-ghost);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    
    .npc-btn:active {
      transform: translateY(0);
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
      transition: all 0.1s ease;
    }
    
    .npc-btn:focus {
      outline: none;
      box-shadow: 0 0 0 3px rgba(26, 37, 79, 0.3);
    }
    
    .npc-btn-primary {
      background: #1A254F;
      color: white;
      border-color: #1A254F;
    }
    
    .npc-btn-primary:hover {
      background: #2934D0;
      border-color: #2934D0;
    }
    
    .npc-btn-ghost {
      background: #fff;
      color: #1f2937;
      border-color: var(--line);
    }
    
    .npc-btn-ghost:hover {
      background: var(--brand-ghost);
    }
    
    /* NPC 모달 스타일 - 홈 디자인 적용 */
    .npc-modal {
      border-radius: 14px;
      width: 96%;
      max-width: 768px;
      padding: 0;
      border: 1px solid #E6ECF4;
      background: var(--card);
      box-shadow: 0 2px 10px rgba(2,6,23,.04);
    }
    
    [data-theme="dark"] .npc-modal {
      border-color: var(--line) !important;
    }
    
    .npc-modal-header {
      padding: 12px;
      border-bottom: 1px solid var(--line);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .npc-modal-title {
      font-family: "Noto Sans KR", system-ui, sans-serif;
      font-weight: 700;
      font-size: 17px;
      line-height: 1.4;
      color: #1A254F;
    }
    
    [data-theme="dark"] .npc-modal-title {
      color: #E9EEF5;
    }
    
    .npc-modal-body {
      padding: 12px;
    }
    
    .npc-modal-footer {
      padding: 12px;
      display: flex;
      gap: 8px;
      font-size: 14px;
    }
    
    .npc-table {
      width: 100%;
      font-size: 14px;
    }
    
    .npc-table th {
      padding: 8px 12px;
      text-align: left;
      color: #99A4BE;
      background: #F6F9FF;
      font-family: "Noto Sans KR", system-ui, sans-serif;
      font-weight: 600;
    }
    
    .npc-table td {
      padding: 8px 12px;
      font-family: "Noto Sans KR", system-ui, sans-serif;
      white-space: nowrap;
      position: relative;
      cursor: pointer;
      transition: all 0.3s ease;
      overflow: hidden;
    }
    
    .npc-table td.expanded {
      white-space: normal;
      word-break: break-word;
      min-width: fit-content;
      width: auto;
      max-width: none;
      background-color: var(--soft);
      border-radius: 4px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      z-index: 10;
    }
    
    .npc-table tr {
      border-bottom: 1px solid var(--line);
    }
    
    .npc-form {
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    
    .npc-form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
    }
    
    .npc-form-group {
      display: flex;
      flex-direction: column;
    }
    
    .npc-form-label {
      font-family: "Noto Sans KR", system-ui, sans-serif;
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 4px;
    }
    
    .npc-form-input {
      width: 100%;
      border-radius: 8px;
      border: 1px solid #E6ECF4;
      padding: 8px 12px;
      font-family: "Noto Sans KR", system-ui, sans-serif;
      font-size: 14px;
      background: var(--card);
      color: var(--text);
      transition: border-color 0.2s ease;
    }
    
    .npc-form-input:focus {
      outline: none;
      border-color: #1890ff;
      box-shadow: 0 0 0 2px rgba(24, 144, 255, 0.2);
    }
    
    /* 드롭다운 화살표 스타일 */
    .npc-form-input select,
    select.npc-form-input {
      appearance: none;
      -webkit-appearance: none;
      -moz-appearance: none;
      background-image: url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTIiIGhlaWdodD0iOCIgdmlld0JveD0iMCAwIDEyIDgiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxwYXRoIGQ9Ik0xIDFMNiA2TDExIDEiIHN0cm9rZT0iIzlDQkFBRiIgc3Ryb2tlLXdpZHRoPSIxLjUiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCIvPgo8L3N2Zz4=');
      background-repeat: no-repeat;
      background-position: calc(100% - 10px) center;
      background-size: 12px 8px;
      padding-right: 28px;
    }
    
    /* 다크모드 드롭다운 화살표 */
    [data-theme="dark"] .npc-form-input select,
    [data-theme="dark"] select.npc-form-input {
      background-image: url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTIiIGhlaWdodD0iOCIgdmlld0JveD0iMCAwIDEyIDgiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxwYXRoIGQ9Ik0xIDFMNiA2TDExIDEiIHN0cm9rZT0iI0FEQjVCRCIgc3Ryb2tlLXdpZHRoPSIxLjUiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCIvPgo8L3N2Zz4=');
    }
    
    [data-theme="dark"] .npc-form-input {
      border-color: var(--line);
    }
    
    .npc-form-textarea {
      width: 100%;
      border-radius: 8px;
      border: 1px solid #E6ECF4;
      padding: 8px 12px;
      font-family: "Noto Sans KR", system-ui, sans-serif;
      font-size: 14px;
      background: var(--card);
      color: var(--text);
      resize: vertical;
      min-height: 80px;
      transition: border-color 0.2s ease;
    }
    
    .npc-form-textarea:focus {
      outline: none;
      border-color: #1890ff;
      box-shadow: 0 0 0 2px rgba(24, 144, 255, 0.2);
    }
    
    [data-theme="dark"] .npc-form-textarea {
      border-color: var(--line);
    }
    
    .npc-form-actions {
      padding-top: 8px;
      display: flex;
      justify-content: flex-end;
    }
    
    /* 다크모드 NPC 스타일 */
    [data-theme="dark"] .npc-card {
      background: var(--card);
      border-color: var(--line);
    }
    
    [data-theme="dark"] .npc-kpi-item {
      background: var(--card);
      border-color: var(--line);
    }
    
    [data-theme="dark"] .npc-table th {
      background: #374151;
      color: #9CA3AF;
    }
    
    [data-theme="dark"] .npc-chip {
      background: var(--card);
      border-color: var(--line);
      color: var(--text);
    }
    
    [data-theme="dark"] .npc-btn-ghost {
      background: var(--card);
      border-color: var(--line);
      color: var(--text);
    }
    
    [data-theme="dark"] .npc-btn-ghost:hover {
      background: #374151;
    }
    
    /* 반응형 NPC 스타일 */
    @media (max-width: 768px) {
      .npc-buttons {
        grid-template-columns: 1fr 1fr 1fr;
        gap: 6px;
      }
      
      .npc-btn {
        width: 100%;
        justify-content: center;
      }
      
      .npc-form-row {
        grid-template-columns: 1fr;
      }
      
      .npc-modal {
        width: 98%;
        max-width: none;
      }
    }

    /* 현장 정보 팝업 스타일 */
    .site-info-section {
      margin-bottom: 20px;
    }

    .site-info-section:last-child {
      margin-bottom: 0;
    }

    .site-info-section-title {
      font-family: "Noto Sans KR", system-ui, sans-serif;
      font-size: 16px;
      font-weight: 600;
      color: var(--text);
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .site-info-section-title > span:first-child {
      font-size: 16px;
      font-weight: 600;
    }

    .site-info-header-actions {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .site-info-date {
      font-family: "Noto Sans KR", system-ui, sans-serif;
      font-size: 14px;
      font-weight: 400;
      color: var(--text);
    }

    .site-info-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .site-info-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 16px;
      background: var(--bg);
      border: 1px solid var(--line);
      border-radius: 8px;
      transition: all 0.2s ease;
    }

    .site-info-item:hover {
      background: var(--brand-ghost);
      border-color: var(--brand);
    }

    .site-info-content {
      display: flex;
      align-items: center;
      gap: 12px;
      flex: 1;
      min-width: 0;
    }

    .site-info-label {
      font-family: "Noto Sans KR", system-ui, sans-serif;
      font-size: 14px;
      font-weight: 600;
      color: var(--text);
      min-width: 60px;
      flex-shrink: 0;
    }

    .site-info-value {
      font-family: "Noto Sans KR", system-ui, sans-serif;
      font-size: 14px;
      font-weight: 400;
      color: var(--text);
      flex: 1;
      min-width: 0;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .site-info-actions {
      display: flex;
      gap: 8px;
      flex-shrink: 0;
    }

    .site-info-btn {
      padding: 6px 12px;
      border: 1px solid var(--line);
      border-radius: 6px;
      background: var(--card);
      color: var(--text);
      font-family: "Noto Sans KR", system-ui, sans-serif;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .site-info-btn:hover {
      background: var(--brand-ghost);
      border-color: var(--brand);
    }

    .site-info-btn.primary {
      background: var(--brand);
      color: #ffffff;
      border-color: var(--brand);
    }

    .site-info-btn.primary:hover {
      background: #162043;
    }

    /* 상세 버튼 스타일 (상세 태그와 동일) */
    .site-info-btn.detail {
      background: #f8f9fa;
      color: #6c757d;
      border: 1px solid #dee2e6;
      font-size: 12px;
      padding: 4px 8px;
      border-radius: 4px;
    }

    .site-info-btn.detail:hover {
      background: #e9ecef;
      color: #495057;
    }

    /* 상세 정보 스타일 */
    .site-detail-section {
      padding: 20px;
    }

    .site-detail-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 12px;
      border-bottom: 1px solid var(--line);
    }

    .site-detail-header h3 {
      font-family: "Noto Sans KR", system-ui, sans-serif;
      font-size: 18px;
      font-weight: 600;
      color: var(--text);
      margin: 0;
    }

    .site-detail-content {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .detail-item {
      display: flex;
      flex-direction: column;
      gap: 8px;
      padding: 16px;
      background: var(--bg);
      border: 1px solid var(--line);
      border-radius: 8px;
    }

    .detail-label {
      font-family: "Noto Sans KR", system-ui, sans-serif;
      font-size: 14px;
      font-weight: 600;
      color: var(--text);
    }

    .detail-value {
      font-family: "Noto Sans KR", system-ui, sans-serif;
      font-size: 14px;
      font-weight: 400;
      color: var(--text);
      line-height: 1.5;
    }

    /* 다크모드 현장 정보 스타일 */
    [data-theme="dark"] .site-info-item {
      background: #1A1A1A;
      border-color: var(--line);
    }

    [data-theme="dark"] .site-info-item:hover {
      background: rgba(255, 255, 255, 0.1);
    }

    [data-theme="dark"] .site-info-btn {
      background: #1A1A1A;
      border-color: var(--line);
      color: var(--text);
    }

    [data-theme="dark"] .site-info-btn:hover {
      background: rgba(255, 255, 255, 0.1);
    }

    /* 다크모드 상세 정보 스타일 */
    [data-theme="dark"] .detail-item {
      background: #1A1A1A;
      border-color: var(--line);
    }

    /* 다크모드 상세 버튼 스타일 */
    [data-theme="dark"] .site-info-btn.detail {
      background: #2d3748;
      color: #a0aec0;
      border-color: #4a5568;
    }

    [data-theme="dark"] .site-info-btn.detail:hover {
      background: #4a5568;
      color: #e2e8f0;
    }

    /* 반응형 디자인 - 모바일 */
    @media (max-width: 768px) {
      .attachment-popup {
        padding: 10px;
      }
      
      .attachment-popup-content {
        max-width: 100%;
        max-height: calc(100vh - 20px);
        border-radius: 12px;
      }
      
      .attachment-popup-body {
        padding: 16px 20px;
        max-height: calc(100vh - 120px);
      }
      
      .attachment-preview {
        max-height: 50vh;
        margin: 12px 8px 0 8px;
      }
      
      .preview-actions {
        margin-right: 8px;
        margin-bottom: 8px;
      }
      
      .preview-content {
        max-height: 40vh;
        padding: 12px;
      }
      
      .preview-pdf {
        max-height: 40vh;
        min-height: 250px;
      }
      
      .preview-image {
        max-height: 40vh;
      }
      
      .site-info-section-title {
        gap: 8px;
        flex-wrap: wrap;
      }
      
      .site-info-date {
        font-size: 12px;
      }
      
      .site-detail-section {
        padding: 16px;
      }
      
      .site-detail-header {
        flex-direction: column;
        gap: 12px;
        align-items: flex-start;
      }
      
      .site-detail-header h3 {
        font-size: 16px;
      }
      
      .detail-item {
        padding: 12px;
      }
      
      .detail-label {
        font-size: 13px;
      }
      
      .detail-value {
        font-size: 13px;
      }
    }

    /* 다크모드 팝업 스타일 */
    [data-theme="dark"] .attachment-popup-content {
      background: var(--card);
      border: 1px solid var(--line);
    }

    [data-theme="dark"] .attachment-item {
      background: #1A1A1A;
      border-color: var(--line);
    }

    [data-theme="dark"] .attachment-item:hover {
      background: rgba(255, 255, 255, 0.1);
    }

    [data-theme="dark"] .attachment-btn {
      background: #1A1A1A;
      border-color: var(--line);
      color: var(--text);
    }

    [data-theme="dark"] .attachment-btn:hover {
      background: rgba(255, 255, 255, 0.1);
    }

    /* 반응형 디자인 */
    @media (max-width: 480px) {
      .attachment-popup {
        padding: 10px;
      }
      
      .attachment-popup-content {
        max-height: 90vh;
      }
      
      .attachment-popup-header {
        padding: 16px 20px 12px;
      }
      
      .attachment-popup-body {
        padding: 16px 20px;
      }
      
      .attachment-popup-title {
        font-size: 16px;
      }
      
      .attachment-item {
        padding: 10px 12px;
      }
      
      .attachment-actions {
        flex-direction: column;
        gap: 4px;
      }
      
      .attachment-btn {
        padding: 4px 8px;
        font-size: 11px;
      }
    }

    /* 하단 탭바 완전 숨김 처리 */
    .bottom-nav, .tabbar, .footer-nav, .gnb { display:none !important; }
    body { padding-bottom: 0 !important; }
  </style>
  <script src="/assets/common.js" defer></script>
</head>
<body>
  <main class="container">
    <!-- 현장 정보 카드 -->
    <section class="card site-info-card" style="margin-top:12px">
      <!-- 상단: 현장명, 상세보기 버튼 -->
      <div class="card-header">
        <div class="site-name" id="siteName">
          <img src="image/현장정보.png" alt="현장정보" class="site-name-icon">
          현장 미선택
        </div>
        <div class="header-info">
          <span class="work-date" id="workDate">날짜</span>
          <button class="btn btn-detail" id="toggleDetail">상세</button>
      </div>
      </div>
      
      <!-- 구분선 -->
      <div class="divider"></div>
      
      <!-- 기본 정보 -->
      <div class="info-section">
        <div class="info-row">
          <div class="info-label">소속</div>
          <div class="info-val" id="orgName">-</div>
          <div class="btn-wrap">
            <button class="btn btn-icon" data-call="#mgrPhone">통화</button>
          </div>
          <div style="display:none" id="mgrPhone">010-1234-5678</div>
        </div>
        <div class="info-row">
          <div class="info-label">소장</div>
          <div class="info-val" id="directorName">-</div>
          <div class="btn-wrap">
            <button class="btn btn-icon" data-call="#directorPhone">통화</button>
          </div>
          <div style="display:none" id="directorPhone">010-5555-7777</div>
        </div>
        <div class="info-row">
          <div class="info-label">안전</div>
          <div class="info-val" id="safetyName">-</div>
          <div class="btn-wrap">
            <button class="btn btn-icon" data-call="#safetyPhone">통화</button>
          </div>
          <div style="display:none" id="safetyPhone">010-9876-5432</div>
        </div>
        <div class="info-row">
          <div class="info-label">주소</div>
          <div class="info-val expandable" id="addr">-</div>
          <div class="btn-wrap">
            <button class="btn btn-icon" data-copy="#addr">복사</button>
            <button class="btn btn-icon" data-tmap="#addr">T맵</button>
          </div>
        </div>
        <div class="info-row">
          <div class="info-label">숙소</div>
          <div class="info-val expandable" id="lodge">-</div>
          <div class="btn-wrap">
            <button class="btn btn-icon" data-copy="#lodge">복사</button>
            <button class="btn btn-icon" data-tmap="#lodge">T맵</button>
          </div>
          </div>
        </div>

      
      <!-- 상세 정보 (숨김) - 홈의 작성내용요약과 동일한 구조 -->
      <div class="detail-section" id="detailSection" style="display:none">
        <div class="space-y-3">
          <!-- 첫 번째 행: 작성자, 부재명 -->
          <div class="flex justify-between">
            <div class="flex flex-col flex-1 mr-4">
              <div class="text-xs text-gray-500 mb-1">작성자</div>
              <div class="text-sm font-medium" id="writer">-</div>
          </div>
            <div class="flex flex-col flex-1">
              <div class="text-xs text-gray-500 mb-1">부재명</div>
              <div class="text-sm font-medium" id="partName">-</div>
          </div>
        </div>

          <!-- 두 번째 행: 작업공정, 작업유형 -->
          <div class="flex justify-between">
            <div class="flex flex-col flex-1 mr-4">
              <div class="text-xs text-gray-500 mb-1">작업공정</div>
              <div class="text-sm font-medium" id="workProcess">-</div>
        </div>
            <div class="flex flex-col flex-1">
              <div class="text-xs text-gray-500 mb-1">작업유형</div>
              <div class="text-sm font-medium" id="workType">-</div>
        </div>
        </div>

          <!-- 세 번째 행: 블럭/동/호수, 공수 -->
          <div class="flex justify-between">
            <div class="flex flex-col flex-1 mr-4">
              <div class="text-xs text-gray-500 mb-1">블럭 / 동 / 호수</div>
              <div class="text-sm font-medium" id="blockInfo">- / - / -</div>
        </div>
            <div class="flex flex-col flex-1">
              <div class="text-xs text-gray-500 mb-1">공수</div>
              <div class="text-sm font-medium" id="laborQty">1일</div>
        </div>
        </div>

          <!-- 네 번째 행: 사진·문서, 문서 내용 -->
          <div class="flex justify-between">
            <div class="flex flex-col flex-1 mr-4">
              <div class="text-xs text-gray-500 mb-1">사진·문서</div>
              <div class="text-sm font-medium" id="photoDocument">보수 전 0장 / 보수 후 0장</div>
        </div>
            <div class="flex flex-col flex-1">
              <div class="text-xs text-gray-500 mb-1">문서 내용</div>
              <div class="text-sm font-medium" id="documentContent">영수증 0장 / 도면 0장</div>
        </div>
        </div>
        </div>
      </div>

      <!-- 현장 자료 버튼 (홈의 처음부터/저장하기 버튼과 동일한 스타일) -->
      <div class="mt-4">
        <div class="flex gap-2">
          <button id="siteDrawingBtn" class="flex-1 h-[48px] rounded-xl">현장 공도면</button>
          <button id="ptwBtn" class="flex-1 h-[48px] rounded-xl">PTW</button>
      </div>
      </div>
    </section>

    <!-- 현장 정보 검색 카드박스 -->
    <section class="card site-search-card">
      <div class="card-header">
        <div class="q">참여 현장</div>
      </div>
      
      <!-- 구분선 -->
      <div class="divider"></div>
      
      <!-- 검색바 (첨부이미지 스타일) -->
      <div class="search-bar-container">
        <div class="search-input-wrapper">
          <svg class="search-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="11" cy="11" r="8"></circle>
            <path d="m21 21-4.35-4.35"></path>
          </svg>
          <input type="text" id="siteSearchInput" placeholder="현장명 검색" class="search-input-new">
          <button id="clearSearchBtn" class="clear-btn" style="display: none;">
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="18" y1="6" x2="6" y2="18"></line>
              <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
          </button>
      </div>
        <button id="cancelSearchBtn" class="cancel-btn">취소</button>
      </div>
      
      
      <!-- 현장 정보 리스트 (이미지와 유사한 형태) -->
      <div class="site-summary-list" id="siteList">
        <!-- 동적으로 생성될 현장 정보 요약 카드들 -->
      </div>
      
      <!-- 구분선 -->
      <div class="divider"></div>
      
      <!-- NPC-1000 자재관리 -->
      <div class="npc-header">
        <div class="npc-title-group">
          <h3 class="npc-title">
            <img src="image/재고관리.png" alt="재고관리" class="npc-title-icon">
            NPC-1000 재고관리
          </h3>
        </div>
        <div class="npc-actions">
          <button id="npcBtnNewTag" class="npc-tag-btn">추가</button>
        </div>
      </div>

      <!-- KPI -->
      <div class="npc-kpi-grid">
        <div class="npc-kpi-item">
          <p class="npc-kpi-label">입고</p>
          <p id="npcKpiIn" class="npc-kpi-value">0</p>
        </div>
        <div class="npc-kpi-item">
          <p class="npc-kpi-label">사용</p>
          <p id="npcKpiUsed" class="npc-kpi-value">0</p>
        </div>
        <div class="npc-kpi-item">
          <p class="npc-kpi-label">재고</p>
          <p id="npcKpiStock" class="npc-kpi-value stock">0</p>
        </div>
      </div>

      <div class="npc-buttons">
        <button id="npcBtnLog" class="npc-btn npc-btn-ghost">로그 보기</button>
        <button id="npcBtnRequest" class="npc-btn npc-btn-ghost">자재 요청</button>
        <button id="npcBtnRecord" class="npc-btn npc-btn-primary">입고 기록</button>
      </div>
    </section>
  </main>

  <!-- 첨부파일 팝업 -->
  <div class="attachment-popup" id="attachmentPopup">
    <div class="attachment-popup-content">
      <div class="attachment-popup-header">
        <div class="attachment-popup-title">
          <span id="popupSiteName">현장명</span>
        </div>
        <button class="attachment-popup-close" id="closeAttachmentPopup">닫기</button>
      </div>
      <div class="attachment-popup-body" id="attachmentPopupBody">
        <!-- 동적으로 생성될 현장 정보 -->
      </div>
      
      <!-- 첨부파일 미리보기 영역 -->
      <div class="attachment-preview" id="attachmentPreview">
        <div class="preview-header">
          <div class="preview-title" id="previewTitle">파일 미리보기</div>
          <button class="preview-close" id="closePreview">닫기</button>
        </div>
        <div class="preview-content" id="previewContent">
          <div class="preview-text">파일을 선택하여 미리보기를 확인하세요.</div>
        </div>
        <div class="preview-actions" id="previewActions" style="display: none;">
          <button class="preview-btn" id="fullscreenBtn">전체화면</button>
          <button class="preview-btn primary" id="downloadPreviewBtn">다운로드</button>
        </div>
      </div>
    </div>
  </div>

  <!-- NPC-1000 모달: 로그 -->
  <dialog id="npcDlgLog" class="npc-modal">
    <div class="npc-modal-header">
      <b class="npc-modal-title">입고/사용 로그</b>
      <button onclick="npcDlgLog.close()" class="npc-close-btn">닫기</button>
    </div>
    <div class="npc-modal-body">
    </div>
    <div style="border-top: 1px solid var(--line);">
      <table class="npc-table">
        <thead>
          <tr>
            <th style="width: 80px;">현장</th>
            <th style="width: 80px;">날짜</th>
            <th style="width: 60px;">유형</th>
            <th style="width: 70px; text-align: right;">수량</th>
            <th>메모</th>
          </tr>
        </thead>
        <tbody id="npcLogBody">
        </tbody>
      </table>
    </div>
    <div class="npc-modal-footer">
      <span class="npc-chip">입고: <b id="npcSumIn">0</b></span>
      <span class="npc-chip">사용: <b id="npcSumOut">0</b></span>
    </div>
  </dialog>

  <!-- NPC-1000 모달: 기록 입력 -->
  <dialog id="npcDlgRecord" class="npc-modal" style="max-width: 448px;">
    <form method="dialog" class="npc-form">
      <div class="npc-modal-header">
        <b class="npc-modal-title">입고/사용 기록</b>
        <button class="npc-close-btn">닫기</button>
      </div>
      <div class="npc-form-row">
        <div class="npc-form-group">
          <p class="npc-form-label">현장</p>
          <select id="npcRecSite" class="npc-form-input"></select>
        </div>
        <div class="npc-form-group">
          <p class="npc-form-label">날짜</p>
          <input id="npcRecDate" type="date" class="npc-form-input"/>
        </div>
      </div>
      <div class="npc-form-row">
        <div class="npc-form-group">
          <p class="npc-form-label">유형</p>
          <select id="npcRecType" class="npc-form-input">
            <option value="in">입고</option>
            <option value="out">사용</option>
          </select>
        </div>
        <div class="npc-form-group">
          <p class="npc-form-label">수량(말)</p>
          <input id="npcRecQty" type="number" min="1" class="npc-form-input" value="1"/>
        </div>
      </div>
      <div class="npc-form-group">
        <p class="npc-form-label">메모</p>
        <input id="npcRecMemo" class="npc-form-input" placeholder="선택사항"/>
      </div>
      <div class="npc-form-actions">
        <button id="npcRecSave" class="npc-btn npc-btn-primary" value="default">저장</button>
      </div>
    </form>
  </dialog>

  <!-- NPC-1000 모달: 자재 요청 -->
  <dialog id="npcDlgRequest" class="npc-modal" style="max-width: 448px;">
    <form method="dialog" class="npc-form">
      <div class="npc-modal-header">
        <b class="npc-modal-title">자재 요청</b>
        <button class="npc-close-btn">닫기</button>
      </div>
      <div class="npc-form-group">
        <p class="npc-form-label">현장</p>
        <select id="npcReqSite" class="npc-form-input"></select>
      </div>
      <div class="npc-form-group">
        <p class="npc-form-label">요청 수량(말)</p>
        <input id="npcReqQty" type="number" min="1" class="npc-form-input" value="1"/>
      </div>
      <div class="npc-form-group">
        <p class="npc-form-label">사유</p>
        <textarea id="npcReqMemo" rows="3" class="npc-form-textarea" placeholder="요청 배경/특이사항"></textarea>
      </div>
      <div class="npc-form-actions">
        <button id="npcReqSubmit" class="npc-btn npc-btn-primary" value="default">요청 제출</button>
      </div>
    </form>
  </dialog>

  <!-- NPC-1000 추가 기능 선택 팝업 -->
  <div id="npcAddMenuPopup" class="npc-add-menu-popup" style="display: none;">
    <div class="npc-add-menu-content">
      <div class="npc-add-menu-header">
        <h3>기능 선택</h3>
        <button id="npcAddMenuClose" class="npc-add-menu-close">닫기</button>
      </div>
      <div class="npc-add-menu-options">
        <button class="npc-add-menu-option" data-action="request">자재요청</button>
        <button class="npc-add-menu-option" data-action="record">입고기록</button>
      </div>
    </div>
  </div>

  <script>
    // 하단 탭바 DOM에서 완전 제거
    document.addEventListener('DOMContentLoaded', ()=>{
      document.querySelectorAll('.bottom-nav, .tabbar, .footer-nav, .gnb')
        .forEach(el => el.remove());
      document.body.style.paddingBottom = '0';
    });

    /* ====== 홈과 연동될 키 이름(원하는 대로 변경 가능) ====== */
    const HOME_STATE_KEYS = {
      siteName: 'state_site', // 홈의 state.site와 연동
      authorName: 'inopnc_author',
      org: 'orgName',
      addr: 'address',
      lodge: 'lodging',
      mgrName: 'managerName',
      mgrPhone: 'managerPhone',
      directorName: 'directorName',
      directorPhone: 'directorPhone',
      safetyName: 'safetyName',
      safetyPhone: 'safetyPhone',
      workDate: 'workDate',
      workType: 'workType',
      partName: 'partName',
      laborQty: 'laborQty',
      workProcess: 'workProcess',
      blockInfo: 'blockInfo',
      photoDrawing: 'photoDrawing',
    };

    // 값 읽기 도우미
    const readLS = (k, def='') => {
      try { const v = localStorage.getItem(k); return v ?? def; } catch(e){ return def; }
    };

    // 최근 현장 정보 가져오기
    function getRecentSiteInfo() {
      try {
        const workLogData = JSON.parse(localStorage.getItem('workLogData') || '[]');
        if (workLogData.length > 0) {
          // 최근 데이터부터 정렬하여 가장 최근 현장 정보 반환
          const sortedData = workLogData.sort((a, b) => new Date(b.date) - new Date(a.date));
          const recentData = sortedData[0];
          
          return {
            siteName: recentData.site || '',
            date: recentData.date || '',
            writer: recentData.writer || '',
            part: recentData.part || '',
            workType: recentData.workType || '',
            laborQty: recentData.men ? `${recentData.men}일` : '1일',
            workProcess: recentData.procData || '',
            blockInfo: recentData.blockInfo || '',
            photoDrawing: recentData.photoDrawing || ''
          };
        }
      } catch (e) {
        console.error('최근 현장 정보 읽기 오류:', e);
      }
      return null;
    }




    /* ===== 버튼 클릭 효과 초기화 ===== */
    function initButtonClickEffects() {
      // 모든 버튼에 클릭 효과 추가
      document.querySelectorAll('.btn').forEach(button => {
        button.addEventListener('click', function(e) {
          // 클릭된 버튼에 애니메이션 클래스 추가
          this.classList.add('clicked');
          
          // 애니메이션 완료 후 클래스 제거
          setTimeout(() => {
            this.classList.remove('clicked');
          }, 600);
          
          // 리플 효과 생성
          createButtonRippleEffect(e, this);
        });
      });
    }

    /* ===== 버튼 리플 효과 생성 함수 ===== */
    function createButtonRippleEffect(event, element) {
      const ripple = document.createElement('span');
      const rect = element.getBoundingClientRect();
      const size = Math.max(rect.width, rect.height);
      const x = event.clientX - rect.left - size / 2;
      const y = event.clientY - rect.top - size / 2;
      
      ripple.style.width = ripple.style.height = size + 'px';
      ripple.style.left = x + 'px';
      ripple.style.top = y + 'px';
      ripple.classList.add('ripple-ink');
      
      element.appendChild(ripple);
      
      // 애니메이션 완료 후 리플 요소 제거
      setTimeout(() => {
        ripple.remove();
      }, 450);
    }

    // UI 바인딩
    function setText(sel, val){ 
      const el=document.querySelector(sel); 
      if(el) {
        if (sel === '#siteName') {
          // 현장명의 경우 아이콘과 함께 설정
          el.innerHTML = `<img src="image/현장정보.png" alt="현장정보" class="site-name-icon">${val || '현장 미선택'}`;
        } else {
          el.textContent = val || '-';
        }
      }
    }
    
    // 날짜 포맷팅 함수 (YYYY-MM-DD → MM/DD 형식)
    function formatDate(dateString) {
      if (!dateString) return '날짜';
      try {
        const date = new Date(dateString);
        const month = (date.getMonth() + 1).toString().padStart(2, '0');
        const day = date.getDate().toString().padStart(2, '0');
        return `${month}/${day}`;
      } catch (e) {
        return '날짜';
      }
    }

    // 상세보기 버튼 텍스트 업데이트 함수 (전역)
    function updateDetailButtonText() {
      const toggleBtn = document.getElementById('toggleDetail');
      const detailSection = document.getElementById('detailSection');
      
      if (toggleBtn && detailSection) {
        const isVisible = detailSection.style.display !== 'none';
        toggleBtn.textContent = isVisible ? '간단' : '상세';
      }
    }

    // 상세보기 토글 기능
    function initDetailToggle() {
      const toggleBtn = document.getElementById('toggleDetail');
      const detailSection = document.getElementById('detailSection');
      
      if (toggleBtn && detailSection) {
        // 초기 버튼 텍스트 설정
        updateDetailButtonText();
        
        toggleBtn.addEventListener('click', () => {
          const isVisible = detailSection.style.display !== 'none';
          detailSection.style.display = isVisible ? 'none' : 'block';
          updateDetailButtonText();
        });
      }
    }

    // 현장별 소속 정보 매핑 함수
    function getOrgInfoBySite(siteName) {
      const orgMapping = {
        'site3': {
          name: '현대건설',
          manager: '이소장',
          managerPhone: '010-3456-7890'
        },
        'site4': {
          name: '대림건설',
          manager: '최소장',
          managerPhone: '010-4567-8901'
        },
        'site5': {
          name: 'GS건설',
          manager: '정소장',
          managerPhone: '010-5678-9012'
        },
        'NPC-1000': {
          name: 'NPC-1000',
          manager: 'NPC소장',
          managerPhone: '010-1000-0000'
        },
        'NPC-1001': {
          name: 'NPC-1001',
          manager: 'NPC소장',
          managerPhone: '010-1001-0001'
        }
      };
      
      // 기본값
      const defaultOrg = {
        name: 'INOPNC',
        manager: '김소장',
        managerPhone: '010-1234-5678'
      };
      
      return orgMapping[siteName] || defaultOrg;
    }

    // 홈 데이터 연동 함수
    function initFromHome(){
      // 카드 헤더 정보 - 홈에서 선택한 현장명 자동 연동
      const homeSiteName = readLS('state_site') || readLS('selectedSiteName') || '';
      let siteName = homeSiteName;
      let workDate = '';
      
      // 현장 미선택 시 최근 현장 정보 가져오기
      if (!siteName) {
        const recentInfo = getRecentSiteInfo();
        if (recentInfo) {
          siteName = recentInfo.siteName || '현장 미선택';
          workDate = recentInfo.date ? formatDate(recentInfo.date) : '날짜';
        } else {
          siteName = '현장 미선택';
          workDate = '날짜';
        }
      } else {
        // 현장이 선택된 경우 현재 홈 데이터 사용
        // 홈의 state.date 또는 workDate에서 작업일자 가져오기
        const homeWorkDate = readLS('state_date') || readLS('workDate') || '';
        workDate = homeWorkDate ? formatDate(homeWorkDate) : '날짜';
      }
      
      setText('#siteName', siteName);
      setText('#workDate', workDate);
      
      // 상세 정보 데이터 로드 (현장선택값과 날짜값에 일치하는 데이터)
      loadDetailData(siteName, workDate);
      
      // 상세보기 버튼 텍스트 업데이트
      updateDetailButtonText();
      
      // 소속 정보 - 선택된 현장에 따라 자동 설정
      const orgInfo = getOrgInfoBySite(siteName);
      setText('#orgName', orgInfo.name);
      setText('#mgrName', orgInfo.manager);
      setText('#mgrPhone', orgInfo.managerPhone);
      
      // 기본 필드
      setText('#addr', readLS(HOME_STATE_KEYS.addr, '서울시 강남구 테헤란로 456'));
      setText('#lodge', readLS(HOME_STATE_KEYS.lodge, '서울시 강남구 테헤란로 456'));
      
      const directorN = readLS(HOME_STATE_KEYS.directorName, '이소장');
      setText('#directorName', directorN);
      setText('#directorPhone', readLS(HOME_STATE_KEYS.directorPhone, '010-5555-7777'));
      
      const safetyN = readLS(HOME_STATE_KEYS.safetyName, '이안전');
      setText('#safetyName', safetyN);
      setText('#safetyPhone', readLS(HOME_STATE_KEYS.safetyPhone, '010-9876-5432'));
    }
    
    // 상세 정보 데이터 로드 함수 (홈의 작성내용요약과 정확히 동일)
    function loadDetailData(siteName, workDate) {
      try {
        // workLogData에서 현장명과 날짜가 일치하는 데이터 찾기
        const workLogData = JSON.parse(localStorage.getItem('workLogData') || '[]');
        const matchingData = workLogData.find(item => 
          item.site === siteName && 
          item.date === workDate
        );
        
        if (matchingData) {
          // 작성자 (홈과 동일)
          setText('#writer', matchingData.writer || '-');
          
          // 부재명 (홈과 동일한 로직)
          const partName = Array.isArray(matchingData.part) && matchingData.part.length > 0 
            ? matchingData.part.join(', ') 
            : (matchingData.part || '-');
          setText('#partName', partName);
          
          // 작업공정 (홈과 동일한 로직)
          const workProcess = Array.isArray(matchingData.proc) && matchingData.proc.length > 0 
            ? matchingData.proc.join(', ') 
            : (matchingData.proc || '-');
          setText('#workProcess', workProcess);
          
          // 작업유형 (홈과 동일한 로직)
          const workType = Array.isArray(matchingData.area) && matchingData.area.length > 0 
            ? matchingData.area.map(item => item.label || item.value).join(', ') 
            : (matchingData.area || '-');
          setText('#workType', workType);
          
          // 블럭/동/호수 (홈과 정확히 동일한 형식)
          const blockInfo = `${matchingData.block && matchingData.block.val ? matchingData.block.val : '-'} / ${matchingData.dong || '-'} / ${matchingData.ho || '-'}`;
          setText('#blockInfo', blockInfo);
          
          // 공수 (홈과 동일)
          setText('#laborQty', `${matchingData.men || 1}일`);
          
          // 사진·문서 (홈과 정확히 동일한 형식)
          const preCount = matchingData.photos && matchingData.photos.before ? matchingData.photos.before : 0;
          const postCount = matchingData.photos && matchingData.photos.after ? matchingData.photos.after : 0;
          setText('#photoDocument', `보수 전 ${preCount}장 / 보수 후 ${postCount}장`);
          
          // 문서 내용 (홈과 정확히 동일한 형식)
          const receiptCount = matchingData.photos && matchingData.photos.docs && matchingData.photos.docs.receipt ? matchingData.photos.docs.receipt.length : 0;
          const drawingCount = matchingData.photos && matchingData.photos.docs && matchingData.photos.docs.drawing ? matchingData.photos.docs.drawing.length : 0;
          setText('#documentContent', `영수증 ${receiptCount}장 / 도면 ${drawingCount}장`);
        } else {
          // 일치하는 데이터가 없으면 기본값으로 표기 (홈과 동일)
          setText('#writer', '-');
          setText('#partName', '-');
          setText('#workProcess', '-');
          setText('#workType', '-');
          setText('#blockInfo', '- / - / -');
          setText('#laborQty', '1일');
          setText('#photoDocument', '보수 전 0장 / 보수 후 0장');
          setText('#documentContent', '영수증 0장 / 도면 0장');
        }
      } catch (error) {
        console.error('상세 데이터 로드 오류:', error);
        // 오류 발생 시 기본값으로 표기
        setText('#writer', '-');
        setText('#partName', '-');
        setText('#workProcess', '-');
        setText('#workType', '-');
        setText('#blockInfo', '- / - / -');
        setText('#laborQty', '1일');
        setText('#photoDocument', '보수 전 0장 / 보수 후 0장');
        setText('#documentContent', '영수증 0장 / 도면 0장');
      }
    }

    // 복사/T맵
    async function copyFromSelector(sel){
      const el = document.querySelector(sel);
      const text = el ? el.textContent.trim() : '';
      if(!text) return;
      try{ await navigator.clipboard.writeText(text); alert('복사되었습니다.'); }catch(e){ alert('복사 실패: 권한을 확인하세요.'); }
    }
    function openTmapFromSelector(sel){
      const el = document.querySelector(sel);
      const q = el ? el.textContent.trim() : '';
      if(!q) {
        alert('주소 정보가 없습니다.');
        return;
      }
      
      // T맵 앱 스킴 URL
      const tmapScheme = `tmap://search?name=${encodeURIComponent(q)}`;
      
      // T맵 웹 버전 URL (폴백용)
      const tmapWebUrl = `https://tmapapi.sktelecom.com/main/map.html?q=${encodeURIComponent(q)}`;
      
      // 카카오맵 URL (최종 폴백용)
      const kakaoMapUrl = `https://map.kakao.com/?q=${encodeURIComponent(q)}`;
      
      try {
        // T맵 앱으로 연결 시도
        const link = document.createElement('a');
        link.href = tmapScheme;
        link.style.display = 'none';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        // T맵 앱이 설치되어 있지 않은 경우를 대비한 폴백
        setTimeout(() => {
          // 사용자에게 선택권 제공
          const useTmapWeb = confirm(`T맵 앱이 설치되어 있지 않습니다.\n\n"확인"을 누르면 T맵 웹으로 이동합니다.\n"취소"를 누르면 카카오맵으로 이동합니다.`);
          
          if (useTmapWeb) {
            window.open(tmapWebUrl, '_blank');
          } else {
            window.open(kakaoMapUrl, '_blank');
          }
        }, 1000);
        
      } catch (error) {
        console.error('T맵 연결 오류:', error);
        // 오류 발생 시 카카오맵으로 폴백
        window.open(kakaoMapUrl, '_blank');
      }
    }



    // 이벤트 바인딩
    function bindActions(){
      document.querySelectorAll('[data-copy]').forEach(b=>{
        b.addEventListener('click', (e)=> {
          // 리플 효과 추가
          b.classList.add('clicked');
          setTimeout(() => b.classList.remove('clicked'), 600);
          copyFromSelector(b.getAttribute('data-copy'));
        });
      });
      document.querySelectorAll('[data-tmap]').forEach(b=>{
        b.addEventListener('click', (e)=> {
          // 리플 효과 추가
          b.classList.add('clicked');
          setTimeout(() => b.classList.remove('clicked'), 600);
          openTmapFromSelector(b.getAttribute('data-tmap'));
        });
      });
      document.querySelectorAll('[data-call]').forEach(b=>{
        b.addEventListener('click', (e)=> {
          // 리플 효과 추가
          b.classList.add('clicked');
          setTimeout(() => b.classList.remove('clicked'), 600);
          callPhone(b.getAttribute('data-call'));
        });
      });
      
      // 상세버튼 클릭 이벤트 추가 (통화버튼과 동일한 효과)
      const detailBtn = document.getElementById('toggleDetail');
      if (detailBtn) {
        detailBtn.addEventListener('click', (e) => {
          // 리플 효과 추가
          detailBtn.classList.add('clicked');
          setTimeout(() => detailBtn.classList.remove('clicked'), 600);
        });
        
        // 포커스 효과 추가 (통화버튼과 동일)
        detailBtn.addEventListener('focus', (e) => {
          e.target.style.outline = 'none';
          e.target.style.borderColor = '#1890ff';
          e.target.style.boxShadow = '0 0 0 3px rgba(24, 144, 255, 0.3)';
        });
        
        detailBtn.addEventListener('blur', (e) => {
          e.target.style.borderColor = '';
          e.target.style.boxShadow = '';
        });
      }
    }

    // 전화 걸기 함수
    function callPhone(phoneSelector) {
      const phoneEl = document.querySelector(phoneSelector);
      const phone = phoneEl ? phoneEl.textContent.trim() : '';
      if (!phone) return;
      window.location.href = `tel:${phone}`;
    }

    // localStorage 변경 감지하여 실시간 업데이트
    function initRealtimeUpdate() {
      window.addEventListener('storage', (e) => {
        if (e.key === 'state_site' || e.key === 'selectedSiteName' || e.key === 'workLogData' || e.key === 'state_date' || e.key === 'workDate') {
          updateSiteInfo();
        }
      });
      
      // 같은 탭에서의 localStorage 변경도 감지 (storage 이벤트는 다른 탭에서만 발생)
      const originalSetItem = localStorage.setItem;
      localStorage.setItem = function(key, value) {
        originalSetItem.apply(this, arguments);
        if (key === 'state_site' || key === 'selectedSiteName' || key === 'workLogData' || key === 'state_date' || key === 'workDate') {
          setTimeout(() => updateSiteInfo(), 100);
        }
      };
    }
    
    // 현장 정보 업데이트 함수
    function updateSiteInfo() {
      const homeSiteName = readLS('state_site') || readLS('selectedSiteName') || '';
      let siteName = homeSiteName;
      let workDate = '';
      
      // 현장 미선택 시 최근 현장 정보 가져오기
      if (!siteName) {
        const recentInfo = getRecentSiteInfo();
        if (recentInfo) {
          siteName = recentInfo.siteName || '현장 미선택';
          workDate = recentInfo.date ? formatDate(recentInfo.date) : '날짜';
        } else {
          siteName = '현장 미선택';
          workDate = '날짜';
        }
      } else {
        // 현장이 선택된 경우 현재 홈 데이터 사용
        // 홈의 state.date 또는 workDate에서 작업일자 가져오기
        const homeWorkDate = readLS('state_date') || readLS('workDate') || '';
        workDate = homeWorkDate ? formatDate(homeWorkDate) : '날짜';
      }
      
      setText('#siteName', siteName);
      setText('#workDate', workDate);
      
      // 소속 정보 - 선택된 현장에 따라 자동 업데이트
      const orgInfo = getOrgInfoBySite(siteName);
      setText('#orgName', orgInfo.name);
      setText('#mgrName', orgInfo.manager);
      setText('#mgrPhone', orgInfo.managerPhone);
      
      loadDetailData(siteName, workDate);
      updateDetailButtonText();
    }

    // 현장 자료 버튼 기능
    function initSiteDocumentButtons() {
      const siteDrawingBtn = document.getElementById('siteDrawingBtn');
      const ptwBtn = document.getElementById('ptwBtn');
      
      if (siteDrawingBtn) {
        siteDrawingBtn.addEventListener('click', () => {
          const currentSite = document.getElementById('siteName').textContent;
          if (currentSite && currentSite !== '현장 미선택') {
            openSiteDocument('drawing', currentSite);
          } else {
            alert('현장을 먼저 선택해주세요.');
          }
        });
      }
      
      if (ptwBtn) {
        ptwBtn.addEventListener('click', () => {
          const currentSite = document.getElementById('siteName').textContent;
          if (currentSite && currentSite !== '현장 미선택') {
            openSiteDocument('ptw', currentSite);
          } else {
            alert('현장을 먼저 선택해주세요.');
          }
        });
      }
    }
    
    // 현장 자료 열기 함수
    function openSiteDocument(type, siteName) {
      // 관리자가 업로드한 현장별 자료 시뮬레이션
      const documents = {
        'site1': {
          drawing: [
            { name: 'site1_공도면_001.pdf', url: '#', size: '2.3MB' },
            { name: 'site1_공도면_002.pdf', url: '#', size: '1.8MB' }
          ],
          ptw: [
            { name: 'site1_PTW_안전작업허가서.pdf', url: '#', size: '1.2MB' },
            { name: 'site1_PTW_작업계획서.pdf', url: '#', size: '0.9MB' }
          ]
        },
      };
      
      const siteDocs = documents[siteName] || documents['site1'];
      const docList = siteDocs[type] || [];
      
      if (docList.length === 0) {
        alert(`${siteName}의 ${type === 'drawing' ? '현장 공도면' : 'PTW'} 자료가 없습니다.`);
        return;
      }
      
      // 자료 목록 표시 및 다운로드/공유 옵션 제공
      showDocumentList(type === 'drawing' ? '현장 공도면' : 'PTW', docList, siteName);
    }
    
    // 자료 목록 표시 함수
    function showDocumentList(title, documents, siteName) {
      const message = `${siteName} - ${title}\n\n` + 
        documents.map((doc, index) => `${index + 1}. ${doc.name} (${doc.size})`).join('\n') +
        '\n\n미리보기, 핸드폰 저장, 카톡 공유 기능이 구현됩니다.';
      
      if (confirm(message + '\n\n확인을 누르면 다운로드 시뮬레이션이 실행됩니다.')) {
        // 실제 구현에서는 파일 다운로드, 미리보기, 공유 기능을 구현
        console.log(`${title} 다운로드 시뮬레이션:`, documents);
        alert(`${title} 자료 다운로드가 시작됩니다.`);
      }
    }
    
    // 테스트용 현장 데이터 생성
    function createTestSiteData() {
      const testData = [
        {
          site: 'site3',
          date: '2025-06-02', 
          writer: '김작성자',
          men: 4,
          part: ['지하', '블럭'],
          timestamp: new Date('2025-06-02').getTime()
        },
        {
          site: 'site4',
          date: '2025-03-12',
          writer: '김작성자',
          men: 2,
          part: ['기초', '철근'],
          timestamp: new Date('2025-03-12').getTime()
        },
        {
          site: 'site5',
          date: '2024-11-09',
          writer: '김작성자',
          men: 5,
          part: ['구조', '마감'],
          timestamp: new Date('2024-11-09').getTime()
        },
        {
          site: 'NPC-1000',
          date: '2025-01-15',
          writer: '김작성자',
          men: 3,
          part: ['NPC', '시설'],
          timestamp: new Date('2025-01-15').getTime()
        },
        {
          site: 'NPC-1001',
          date: '2024-12-20',
          writer: '김작성자',
          men: 2,
          part: ['NPC', '유지보수'],
          timestamp: new Date('2024-12-20').getTime()
        }
      ];
      
      // localStorage에 테스트 데이터 저장
      const existingData = JSON.parse(localStorage.getItem('workLogData') || '[]');
      const combinedData = [...existingData, ...testData];
      localStorage.setItem('workLogData', JSON.stringify(combinedData));
      
      return testData;
    }
    
    // 전역 함수들 (탭 메뉴에서 접근 가능하도록)
    
    // 검색 기능
    function performSearch() {
      const newSearchInput = document.getElementById('siteSearchInput');
      const query = newSearchInput ? newSearchInput.value.toLowerCase().trim() : '';
      const workLogData = JSON.parse(localStorage.getItem('workLogData') || '[]');
      const currentAuthor = readLS('inopnc_author', '');
      
      // 작성자가 참여한 현장만 필터링
      let filteredData = workLogData.filter(item => 
        item.writer && item.writer.toLowerCase() === currentAuthor.toLowerCase()
      );
      
      // 검색어가 있으면 추가 필터링
      if (query) {
        filteredData = filteredData.filter(item => {
          const siteName = item.site.toLowerCase();
          const formattedSiteName = formatSiteTitle(item.site).toLowerCase();
          return siteName.includes(query) || formattedSiteName.includes(query);
        });
      }
      
      // 최신순 정렬
      filteredData.sort((a, b) => new Date(b.timestamp || b.date) - new Date(a.timestamp || a.date));
      
      // [소속]현장명 중복 제거: 동일현장 시 1개만 최신순으로 노출
      const uniqueSites = removeDuplicateSitesByFormattedName(filteredData);
      
      renderSiteList(uniqueSites.slice(0, 2)); // 최대 2개만 표시
    }

    // [소속]현장명별 중복 제거 함수: 동일현장 시 1개만 최신순으로 노출
    function removeDuplicateSitesByFormattedName(sites) {
      const siteMap = new Map();
      
      sites.forEach(site => {
        const formattedSiteName = formatSiteTitle(site.site);
        const existingSite = siteMap.get(formattedSiteName);
        
        // 기존 현장이 없거나, 현재 현장의 날짜가 더 최신인 경우
        if (!existingSite || new Date(site.timestamp || site.date) > new Date(existingSite.timestamp || existingSite.date)) {
          siteMap.set(formattedSiteName, site);
        }
      });
      
      // Map을 배열로 변환하고 날짜순으로 정렬 (최신순)
      return Array.from(siteMap.values()).sort((a, b) => new Date(b.timestamp || b.date) - new Date(a.timestamp || a.date));
    }


    // 현장 리스트 렌더링 (이미지와 유사한 형태)
    function renderSiteList(sites) {
      const siteList = document.getElementById('siteList');
      if (!siteList) return;
      
      if (sites.length === 0) {
        const currentAuthor = readLS('inopnc_author', '');
        if (currentAuthor) {
          siteList.innerHTML = '<div class="site-summary-item"><div class="site-summary-content"><div class="site-summary-title">작성자 "' + currentAuthor + '"가 참여한 현장이 없습니다.</div></div></div>';
        } else {
          siteList.innerHTML = '<div class="site-summary-item"><div class="site-summary-content"><div class="site-summary-title">작성자 정보가 없습니다.</div></div></div>';
        }
        return;
      }
      
      // 전달받은 현장 리스트 표시 (이미 중복 제거 및 최신순 정렬됨)
      siteList.innerHTML = sites.map(site => {
        // 현장명을 더 읽기 쉽게 포맷팅
        const siteTitle = formatSiteTitle(site.site);
        const formattedDate = formatDateForList(site.date);
        
        // [소속] 현장명 형태로 표시
        const displayTitle = siteTitle;
        
        return `
          <div class="site-summary-item" onclick="selectSiteFromList('${site.site}', '${site.date}')">
            <div class="site-summary-content">
              <div class="site-summary-title">${displayTitle}</div>
              <div class="site-summary-site" style="display: none;">${site.site}</div>
          </div>
            <div class="site-summary-date">${formattedDate}</div>
        </div>
        `;
      }).join('');
    }


    // 현장명 포맷팅 함수
    function formatSiteTitle(siteName) {
      // site2, site3 등을 더 읽기 쉽게 변환
      const siteMapping = {
        'site3': '[현대] 대전 도안 리버파크',
        'site4': '[롯데] 여수 죽림',
        'site5': '[한화] 시흥시청역 테라타워',
        'NPC-1000': '[NPC-1000] 시설 관리',
        'NPC-1001': '[NPC-1001] 유지보수'
      };
      
      return siteMapping[siteName] || `[${siteName}]`;
    }

    // 리스트용 날짜 포맷팅 함수
    function formatDateForList(dateString) {
      if (!dateString) return '';
      
      try {
        const date = new Date(dateString);
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}.${month}.${day}`;
      } catch (e) {
        return dateString;
      }
    }


    // 현장 정보 검색 기능
    function initSiteSearch() {
      const searchInput = document.getElementById('siteSearchInput');
      const siteList = document.getElementById('siteList');
      
      // 테스트 데이터 생성
      createTestSiteData();
      
      // 테스트용 작성자 정보 설정
      if (!localStorage.getItem('inopnc_author')) {
        localStorage.setItem('inopnc_author', '김작성자');
      }
      
      
      
      // 이벤트 리스너
      // 새로운 검색바 이벤트 리스너
      const newSearchInput = document.getElementById('siteSearchInput');
      const clearBtn = document.getElementById('clearSearchBtn');
      const cancelBtn = document.getElementById('cancelSearchBtn');
      
      if (newSearchInput) {
        newSearchInput.addEventListener('input', (e) => {
          performSearch();
          // 입력이 있으면 clear 버튼 표시
          if (e.target.value) {
            clearBtn.style.display = 'flex';
          } else {
            clearBtn.style.display = 'none';
          }
        });
        
        newSearchInput.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') performSearch();
        });
      }
      
      if (clearBtn) {
        clearBtn.addEventListener('click', () => {
          newSearchInput.value = '';
          clearBtn.style.display = 'none';
          performSearch();
        });
      }
      
      if (cancelBtn) {
        cancelBtn.addEventListener('click', () => {
          // 검색어 초기화
          newSearchInput.value = '';
          clearBtn.style.display = 'none';
          // 검색 결과 초기화 (모든 현장 표시)
          performSearch();
          // 입력 필드에서 포커스 제거
          newSearchInput.blur();
        });
      }
      
      // 초기 로드
      performSearch();
      
      // 작성자 정보 변경 시 자동 업데이트
      window.addEventListener('storage', (e) => {
        if (e.key === 'inopnc_author') {
          performSearch();
        }
      });
    }
    
    // 현장 리스트에서 현장 선택
    function selectSiteFromList(siteName, date) {
      console.log('현장 선택:', siteName, date); // 디버깅용
      
      // 첨부파일 팝업 표시
      showAttachmentPopup(siteName);
      
      // 선택된 현장 정보를 메인 카드에 반영
      setText('#siteName', siteName);
      setText('#workDate', formatDate(date));
      
      // NPC 카드 데이터 업데이트
      updateNpcForSite(siteName);
      
      // 소속 정보 업데이트
      const orgInfo = getOrgInfoBySite(siteName);
      setText('#orgName', orgInfo.name);
      setText('#mgrName', orgInfo.manager);
      setText('#mgrPhone', orgInfo.managerPhone);
      
      // 소장 정보 업데이트
      setText('#directorName', orgInfo.manager);
      setText('#directorPhone', orgInfo.managerPhone);
      
      // 상세 정보 로드
      loadDetailData(siteName, date);
      updateDetailButtonText();
      
      // 선택된 현장을 localStorage에 저장
      localStorage.setItem('state_site', siteName);
      localStorage.setItem('state_date', date);
      
      // 선택 완료 알림 (선택사항)
      console.log('현장 정보 조회 완료:', {
        siteName: siteName,
        date: date,
        orgInfo: orgInfo
      });
      
      // 시각적 피드백 (선택사항)
      const selectedItem = event?.target?.closest('.site-summary-item');
      if (selectedItem) {
        // 선택된 항목에 시각적 표시
        document.querySelectorAll('.site-summary-item').forEach(item => {
          item.style.backgroundColor = '';
        });
        selectedItem.style.backgroundColor = 'rgba(26, 37, 79, 0.1)';
        
        // 2초 후 배경색 제거
        setTimeout(() => {
          selectedItem.style.backgroundColor = '';
        }, 2000);
      }
    }

    // 현장 정보 팝업 표시
    function showAttachmentPopup(siteName) {
      const popup = document.getElementById('attachmentPopup');
      const popupSiteName = document.getElementById('popupSiteName');
      const popupBody = document.getElementById('attachmentPopupBody');
      
      // 팝업 제목 설정
      const formattedSiteName = formatSiteTitle(siteName);
      popupSiteName.textContent = formattedSiteName;
      
      // 현장 정보 데이터 가져오기
      const siteInfo = getSiteInfo(siteName);
      
      // 팝업 내용 렌더링
      renderSiteInfoPopup(siteInfo, popupBody);
      
      // 팝업 표시
      popup.classList.add('show');
      document.body.style.overflow = 'hidden'; // 배경 스크롤 방지
    }

    // 첨부파일 팝업 닫기
    function hideAttachmentPopup() {
      const popup = document.getElementById('attachmentPopup');
      popup.classList.remove('show');
      document.body.style.overflow = ''; // 스크롤 복원
    }

    // 현장 정보 데이터 가져오기
    function getSiteInfo(siteName) {
      const siteInfoData = {
        'site3': {
          org: '현대건설',
          manager: '이소장',
          managerPhone: '010-3456-7890',
          director: '이소장',
          directorPhone: '010-5555-7777',
          safety: '이안전',
          safetyPhone: '010-9876-5432',
          address: '대전시 유성구 도안동 123',
          lodging: '대전시 유성구 도안동 123',
          lastUpdated: '2025.01.14',
          process: '철근 배근',
          block: 'B',
          building: '2',
          unit: '201',
          photosBefore: 3,
          photosAfter: 4,
          subtitle: '기둥 철근',
          workType: '배근작업',
          duration: '1일',
          receipts: 1,
          drawings: [
            { name: 'site3_공도면_001.pdf', size: '2.8MB', date: '2025.06.01' }
          ],
          ptw: [
            { name: 'site3_PTW_허가서.pdf', size: '1.5MB', date: '2025.06.02' }
          ]
        },
        'site4': {
          org: '대림건설',
          manager: '최소장',
          managerPhone: '010-4567-8901',
          director: '이소장',
          directorPhone: '010-5555-7777',
          safety: '이안전',
          safetyPhone: '010-9876-5432',
          address: '전라남도 여수시 죽림동 456',
          lodging: '전라남도 여수시 죽림동 456',
          lastUpdated: '2025.01.13',
          process: '거푸집 설치',
          block: 'C',
          building: '3',
          unit: '301',
          photosBefore: 2,
          photosAfter: 6,
          subtitle: '슬래브 거푸집',
          workType: '거푸집작업',
          duration: '3일',
          receipts: 3,
          drawings: [
            { name: 'site4_공도면_001.pdf', size: '3.1MB', date: '2025.03.10' }
          ],
          ptw: [
            { name: 'site4_PTW_허가서.pdf', size: '1.3MB', date: '2025.03.12' }
          ]
        },
        'site5': {
          org: 'GS건설',
          manager: '정소장',
          managerPhone: '010-5678-9012',
          director: '이소장',
          directorPhone: '010-5555-7777',
          safety: '이안전',
          safetyPhone: '010-9876-5432',
          address: '경기도 시흥시 정왕동 789',
          lodging: '경기도 시흥시 정왕동 789',
          lastUpdated: '2025.01.12',
          process: '마감 작업',
          block: 'D',
          building: '4',
          unit: '401',
          photosBefore: 4,
          photosAfter: 2,
          subtitle: '벽체 마감',
          workType: '마감작업',
          duration: '1일',
          receipts: 1,
          drawings: [
            { name: 'site5_공도면_001.pdf', size: '2.9MB', date: '2024.11.08' }
          ],
          ptw: [
            { name: 'site5_PTW_허가서.pdf', size: '1.4MB', date: '2024.11.09' }
          ]
        },
        'NPC-1000': {
          org: 'NPC-1000',
          manager: 'NPC소장',
          managerPhone: '010-1000-0000',
          director: '이소장',
          directorPhone: '010-5555-7777',
          safety: '이안전',
          safetyPhone: '010-9876-5432',
          address: 'NPC-1000 시설 위치',
          lodging: 'NPC-1000 숙소 위치',
          lastUpdated: '2025.01.15',
          process: '시설 점검',
          block: 'E',
          building: '5',
          unit: '501',
          photosBefore: 0,
          photosAfter: 0,
          subtitle: '시설 점검',
          workType: '점검작업',
          duration: '1일',
          receipts: 0,
          drawings: [
            { name: 'NPC-1000_시설도면.pdf', size: '2.5MB', date: '2025.01.14' }
          ],
          ptw: [
            { name: 'NPC-1000_작업허가서.pdf', size: '1.1MB', date: '2025.01.15' }
          ]
        },
        'NPC-1001': {
          org: 'NPC-1001',
          manager: 'NPC소장',
          managerPhone: '010-1001-0001',
          director: '이소장',
          directorPhone: '010-5555-7777',
          safety: '이안전',
          safetyPhone: '010-9876-5432',
          address: 'NPC-1001 시설 위치',
          lodging: 'NPC-1001 숙소 위치',
          lastUpdated: '2025.01.11',
          process: '유지보수',
          block: 'F',
          building: '6',
          unit: '601',
          photosBefore: 1,
          photosAfter: 1,
          subtitle: '설비 유지보수',
          workType: '유지보수작업',
          duration: '1일',
          receipts: 0,
          drawings: [
            { name: 'NPC-1001_유지보수도면.pdf', size: '2.2MB', date: '2024.12.19' }
          ],
          ptw: [
            { name: 'NPC-1001_작업허가서.pdf', size: '1.0MB', date: '2024.12.20' }
          ]
        }
      };
      
      return siteInfoData[siteName] || {
        org: '-',
        manager: '-',
        managerPhone: '-',
        director: '-',
        directorPhone: '-',
        safety: '-',
        safetyPhone: '-',
        address: '-',
        lodging: '-',
        drawings: [],
        ptw: []
      };
    }

    // 최신 날짜 자동 계산 함수
    function getLatestDate(siteInfo) {
      const dates = [];
      
      // drawings에서 날짜 추출
      if (siteInfo.drawings && siteInfo.drawings.length > 0) {
        siteInfo.drawings.forEach(drawing => {
          if (drawing.date) {
            dates.push(new Date(drawing.date.replace(/\./g, '-')));
          }
        });
      }
      
      // ptw에서 날짜 추출
      if (siteInfo.ptw && siteInfo.ptw.length > 0) {
        siteInfo.ptw.forEach(ptw => {
          if (ptw.date) {
            dates.push(new Date(ptw.date.replace(/\./g, '-')));
          }
        });
      }
      
      // lastUpdated 날짜 추가
      if (siteInfo.lastUpdated) {
        dates.push(new Date(siteInfo.lastUpdated.replace(/\./g, '-')));
      }
      
      // 가장 최신 날짜 찾기
      if (dates.length > 0) {
        const latestDate = new Date(Math.max(...dates));
        return latestDate.toISOString().split('T')[0].replace(/-/g, '.');
      }
      
      // 기본값 반환
      return '2025.01.15';
    }

    // 현장 정보 팝업 렌더링
    function renderSiteInfoPopup(siteInfo, container) {
      // 최신 날짜 자동 계산
      const latestDate = getLatestDate(siteInfo);
      
      let html = `
        <div class="site-info-section">
          <div class="site-info-section-title">
            <span>현장 정보</span>
            <span class="site-info-date">${latestDate}</span>
            <button class="site-info-btn detail" onclick="toggleSiteDetails()">상세</button>
          </div>
          <div class="site-info-list">
            <div class="site-info-item">
              <div class="site-info-content">
                <div class="site-info-label">소속</div>
                <div class="site-info-value">${siteInfo.org}</div>
              </div>
              <div class="site-info-actions">
                <button class="site-info-btn" onclick="callPhone('${siteInfo.managerPhone}')">통화</button>
              </div>
            </div>
            <div class="site-info-item">
              <div class="site-info-content">
                <div class="site-info-label">소장</div>
                <div class="site-info-value">${siteInfo.manager}</div>
              </div>
              <div class="site-info-actions">
                <button class="site-info-btn" onclick="callPhone('${siteInfo.managerPhone}')">통화</button>
              </div>
            </div>
            <div class="site-info-item">
              <div class="site-info-content">
                <div class="site-info-label">안전</div>
                <div class="site-info-value">${siteInfo.safety}</div>
              </div>
              <div class="site-info-actions">
                <button class="site-info-btn" onclick="callPhone('${siteInfo.safetyPhone}')">통화</button>
              </div>
            </div>
            <div class="site-info-item">
              <div class="site-info-content">
                <div class="site-info-label">주소</div>
                <div class="site-info-value">${siteInfo.address}</div>
              </div>
              <div class="site-info-actions">
                <button class="site-info-btn" onclick="copyText('${siteInfo.address}')">복사</button>
                <button class="site-info-btn" onclick="openTmap('${siteInfo.address}')">T맵</button>
              </div>
            </div>
            <div class="site-info-item">
              <div class="site-info-content">
                <div class="site-info-label">숙소</div>
                <div class="site-info-value">${siteInfo.lodging}</div>
              </div>
              <div class="site-info-actions">
                <button class="site-info-btn" onclick="copyText('${siteInfo.lodging}')">복사</button>
                <button class="site-info-btn" onclick="openTmap('${siteInfo.lodging}')">T맵</button>
              </div>
            </div>
          </div>
        </div>
        
        <div class="site-info-section">
          <div class="site-info-section-title">현장 공도면</div>
          <div class="site-info-list">
            ${siteInfo.drawings.length > 0 ? siteInfo.drawings.map(drawing => `
              <div class="site-info-item">
                <div class="site-info-content">
                  <div class="site-info-label">도면</div>
                  <div class="site-info-value">${drawing.name} (${drawing.size})</div>
                </div>
                <div class="site-info-actions">
                  <button class="site-info-btn" onclick="previewFile('${drawing.name}')">미리보기</button>
                  <button class="site-info-btn primary" onclick="downloadFile('${drawing.name}')">다운로드</button>
                </div>
              </div>
            `).join('') : '<div class="attachment-empty">현장 공도면이 없습니다.</div>'}
          </div>
        </div>
        
        <div class="site-info-section">
          <div class="site-info-section-title">PTW</div>
          <div class="site-info-list">
            ${siteInfo.ptw.length > 0 ? (() => {
              // 날짜 기준으로 정렬하여 최신 1개만 선택
              const sortedPtw = siteInfo.ptw.sort((a, b) => new Date(b.date) - new Date(a.date));
              const latestPtw = sortedPtw[0];
              return `
                <div class="site-info-item">
                  <div class="site-info-content">
                    <div class="site-info-label">문서</div>
                    <div class="site-info-value">${latestPtw.name} (${latestPtw.size})</div>
                  </div>
                  <div class="site-info-actions">
                    <button class="site-info-btn" onclick="previewFile('${latestPtw.name}')">미리보기</button>
                    <button class="site-info-btn primary" onclick="downloadFile('${latestPtw.name}')">다운로드</button>
                  </div>
                </div>
              `;
            })() : '<div class="attachment-empty">PTW 문서가 없습니다.</div>'}
          </div>
        </div>
      `;
      
      container.innerHTML = html;
    }

    // 현장별 첨부파일 데이터 가져오기
    function getSiteAttachments(siteName) {
      const attachmentData = {
        'site3': {
          drawings: [
            { name: 'site3_공도면_001.pdf', size: '2.8MB', date: '2025.06.01', type: 'pdf' }
          ],
          ptw: [
            { name: 'site3_PTW_허가서.pdf', size: '1.5MB', date: '2025.06.02', type: 'pdf' }
          ],
          photos: [
            { name: 'site3_현장사진_001.jpg', size: '2.0MB', date: '2025.06.02', type: 'jpg' }
          ]
        },
        'site4': {
          drawings: [
            { name: 'site4_공도면_001.pdf', size: '3.1MB', date: '2025.03.10', type: 'pdf' }
          ],
          ptw: [
            { name: 'site4_PTW_허가서.pdf', size: '1.3MB', date: '2025.03.12', type: 'pdf' }
          ],
          photos: [
            { name: 'site4_현장사진_001.jpg', size: '1.8MB', date: '2025.03.12', type: 'jpg' }
          ]
        },
        'site5': {
          drawings: [
            { name: 'site5_공도면_001.pdf', size: '2.9MB', date: '2024.11.08', type: 'pdf' }
          ],
          ptw: [
            { name: 'site5_PTW_허가서.pdf', size: '1.4MB', date: '2024.11.09', type: 'pdf' }
          ],
          photos: [
            { name: 'site5_현장사진_001.jpg', size: '2.2MB', date: '2024.11.09', type: 'jpg' }
          ]
        },
        'NPC-1000': {
          drawings: [
            { name: 'NPC-1000_시설도면.pdf', size: '2.5MB', date: '2025.01.14', type: 'pdf' }
          ],
          ptw: [
            { name: 'NPC-1000_작업허가서.pdf', size: '1.1MB', date: '2025.01.15', type: 'pdf' }
          ],
          photos: [
            { name: 'NPC-1000_시설사진_001.jpg', size: '1.7MB', date: '2025.01.15', type: 'jpg' }
          ]
        },
        'NPC-1001': {
          drawings: [
            { name: 'NPC-1001_유지보수도면.pdf', size: '2.2MB', date: '2024.12.19', type: 'pdf' }
          ],
          ptw: [
            { name: 'NPC-1001_작업허가서.pdf', size: '1.0MB', date: '2024.12.20', type: 'pdf' }
          ],
          photos: [
            { name: 'NPC-1001_유지보수사진_001.jpg', size: '1.9MB', date: '2024.12.20', type: 'jpg' }
          ]
        }
      };
      
      return attachmentData[siteName] || { drawings: [], ptw: [], photos: [] };
    }

    // 첨부파일 팝업 렌더링
    function renderAttachmentPopup(attachments, container) {
      const sections = [
        { title: '현장 공도면', icon: 'image/사진대지.png', items: attachments.drawings },
        { title: 'PTW', icon: 'image/문서함.png', items: attachments.ptw },
        { title: '현장 사진', icon: 'image/사진대지.png', items: attachments.photos }
      ];
      
      let html = '';
      
      sections.forEach(section => {
        if (section.items.length > 0) {
          html += `
            <div class="attachment-section">
              <div class="attachment-section-title">
                <img src="${section.icon}" alt="${section.title}" class="attachment-icon">
                ${section.title}
              </div>
              <div class="attachment-list">
                ${section.items.map(item => `
                  <div class="attachment-item">
                    <div class="attachment-info">
                      <img src="image/${getFileIcon(item.type)}" alt="${item.type}" class="attachment-icon">
                      <div class="attachment-details">
                        <div class="attachment-name">${item.name}</div>
                        <div class="attachment-meta">${item.size} • ${item.date}</div>
                      </div>
                    </div>
                    <div class="attachment-actions">
                      <button class="attachment-btn" onclick="previewFile('${item.name}')">미리보기</button>
                      <button class="attachment-btn primary" onclick="downloadFile('${item.name}')">다운로드</button>
                    </div>
                  </div>
                `).join('')}
              </div>
            </div>
          `;
        }
      });
      
      if (html === '') {
        html = '<div class="attachment-empty">첨부파일이 없습니다.</div>';
      }
      
      container.innerHTML = html;
    }

    // 파일 타입별 아이콘 반환
    function getFileIcon(type) {
      const iconMap = {
        'pdf': '문서함.png',
        'dwg': '사진대지.png',
        'jpg': '사진대지.png',
        'jpeg': '사진대지.png',
        'png': '사진대지.png'
      };
      return iconMap[type.toLowerCase()] || '문서함.png';
    }

    // 파일 미리보기
    function previewFile(fileName) {
      const preview = document.getElementById('attachmentPreview');
      const previewTitle = document.getElementById('previewTitle');
      const previewContent = document.getElementById('previewContent');
      const previewActions = document.getElementById('previewActions');
      
      // 미리보기 제목 설정
      previewTitle.textContent = fileName;
      
      // 파일 타입에 따른 미리보기 처리
      const fileType = getFileTypeFromName(fileName);
      const fileContent = getFileContent(fileName);
      
      let previewHtml = '';
      
      if (fileType === 'pdf') {
        previewHtml = `
          <iframe src="${fileContent}" class="preview-pdf" type="application/pdf">
            <div class="preview-text">PDF 뷰어를 지원하지 않는 브라우저입니다.<br>다운로드 버튼을 사용해주세요.</div>
          </iframe>
        `;
      } else if (['jpg', 'jpeg', 'png', 'gif'].includes(fileType)) {
        previewHtml = `
          <img src="${fileContent}" alt="${fileName}" class="preview-image" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
          <div class="preview-text" style="display: none;">이미지를 불러올 수 없습니다.</div>
        `;
      } else if (fileType === 'dwg') {
        previewHtml = `
          <div class="preview-text">
            <div style="margin-bottom: 16px;">DWG 파일은 미리보기를 지원하지 않습니다.</div>
            <div style="font-size: 12px; color: var(--muted);">AutoCAD 또는 호환 프로그램으로 열어주세요.</div>
          </div>
        `;
      } else {
        previewHtml = `
          <div class="preview-text">
            <div style="margin-bottom: 16px;">이 파일 형식은 미리보기를 지원하지 않습니다.</div>
            <div style="font-size: 12px; color: var(--muted);">다운로드하여 확인해주세요.</div>
          </div>
        `;
      }
      
      previewContent.innerHTML = previewHtml;
      previewActions.style.display = 'flex';
      preview.classList.add('show');
      
      // 다운로드 버튼에 파일명 설정
      const downloadBtn = document.getElementById('downloadPreviewBtn');
      downloadBtn.onclick = () => downloadFile(fileName);
      
      // 전체화면 버튼 설정
      const fullscreenBtn = document.getElementById('fullscreenBtn');
      fullscreenBtn.onclick = () => openFullscreen(fileName, fileContent, fileType);
      
      console.log('파일 미리보기:', fileName, fileType);
    }

    // 파일명에서 파일 타입 추출
    function getFileTypeFromName(fileName) {
      const extension = fileName.split('.').pop().toLowerCase();
      return extension;
    }

    // 파일 URL 생성 (실제 구현에서는 서버에서 파일을 제공)
    function getFileUrl(fileName) {
      // 실제 구현에서는 서버 API를 통해 파일 URL을 가져와야 함
      // 현재는 시뮬레이션용 URL 생성
      return `#${fileName}`;
    }

    // 샘플 파일 내용 생성 (실제 구현에서는 서버에서 가져옴)
    function getFileContent(fileName) {
      const fileType = getFileTypeFromName(fileName);
      
      if (fileType === 'pdf') {
        // PDF 파일의 경우 실제 PDF URL 또는 데이터 URL 사용
        return `data:application/pdf;base64,JVBERi0xLjQKJcfsj6IKNSAwIG9iago8PAovVHlwZSAvUGFnZQovUGFyZW50IDMgMCBSCi9NZWRpYUJveCBbMCAwIDU5NSA4NDJdCi9SZXNvdXJjZXMgPDwKL0ZvbnQgPDwKL0YxIDYgMCBSCj4+Cj4+Ci9Db250ZW50cyA3IDAgUgo+PgplbmRvYmoKNiAwIG9iago8PAovVHlwZSAvRm9udAovU3VidHlwZSAvVHlwZTEKL0Jhc2VGb250IC9IZWx2ZXRpY2EKPj4KZW5kb2JqCjcgMCBvYmoKPDwKL0xlbmd0aCA0NAo+PgpzdHJlYW0KQlQKL0YxIDEyIFRmCjcyIDcyMCBUZAooSGVsbG8gV29ybGQpIFRqCkVUCmVuZHN0cmVhbQplbmRvYmoKOCAwIG9iago8PAovVHlwZSAvRm9udAovU3VidHlwZSAvVHlwZTEKL0Jhc2VGb250IC9IZWx2ZXRpY2EKL0VuY29kaW5nIC9XaW5BbnNpRW5jb2RpbmcKPj4KZW5kb2JqCjkgMCBvYmoKPDwKL1R5cGUgL0ZvbnQKL1N1YnR5cGUgL1R5cGUxCi9CYXNlRm9udCAvSGVsdmV0aWNhCi9FbmNvZGluZyAvV2luQW5zaUVuY29kaW5nCj4+CmVuZG9iagoxMCAwIG9iago8PAovVHlwZSAvRm9udAovU3VidHlwZSAvVHlwZTEKL0Jhc2VGb250IC9IZWx2ZXRpY2EKL0VuY29kaW5nIC9XaW5BbnNpRW5jb2RpbmcKPj4KZW5kb2JqCjExIDAgb2JqCjw8Ci9UeXBlIC9Gb250Ci9TdWJ0eXBlIC9UeXBlMQovQmFzZUZvbnQgL0hlbHZldGljYQovRW5jb2RpbmcgL1dpbkFuc2lFbmNvZGluZwo+PgplbmRvYmoKMTIgMCBvYmoKPDwKL1R5cGUgL0ZvbnQKL1N1YnR5cGUgL1R5cGUxCi9CYXNlRm9udCAvSGVsdmV0aWNhCi9FbmNvZGluZyAvV2luQW5zaUVuY29kaW5nCj4+CmVuZG9iagoxMyAwIG9iago8PAovVHlwZSAvRm9udAovU3VidHlwZSAvVHlwZTEKL0Jhc2VGb250IC9IZWx2ZXRpY2EKL0VuY29kaW5nIC9XaW5BbnNpRW5jb2RpbmcKPj4KZW5kb2JqCjE0IDAgb2JqCjw8Ci9UeXBlIC9Gb250Ci9TdWJ0eXBlIC9UeXBlMQovQmFzZUZvbnQgL0hlbHZldGljYQovRW5jb2RpbmcgL1dpbkFuc2lFbmNvZGluZwo+PgplbmRvYmoKMTUgMCBvYmoKPDwKL1R5cGUgL0ZvbnQKL1N1YnR5cGUgL1R5cGUxCi9CYXNlRm9udCAvSGVsdmV0aWNhCi9FbmNvZGluZyAvV2luQW5zaUVuY29kaW5nCj4+CmVuZG9iagoxNiAwIG9iago8PAovVHlwZSAvRm9udAovU3VidHlwZSAvVHlwZTEKL0Jhc2VGb250IC9IZWx2ZXRpY2EKL0VuY29kaW5nIC9XaW5BbnNpRW5jb2RpbmcKPj4KZW5kb2JqCjE3IDAgb2JqCjw8Ci9UeXBlIC9Gb250Ci9TdWJ0eXBlIC9UeXBlMQovQmFzZUZvbnQgL0hlbHZldGljYQovRW5jb2RpbmcgL1dpbkFuc2lFbmNvZGluZwo+PgplbmRvYmoKMTggMCBvYmoKPDwKL1R5cGUgL0ZvbnQKL1N1YnR5cGUgL1R5cGUxCi9CYXNlRm9udCAvSGVsdmV0aWNhCi9FbmNvZGluZyAvV2luQW5zaUVuY29kaW5nCj4+CmVuZG9iagoxOSAwIG9iago8PAovVHlwZSAvRm9udAovU3VidHlwZSAvVHlwZTEKL0Jhc2VGb250IC9IZWx2ZXRpY2EKL0VuY29kaW5nIC9XaW5BbnNpRW5jb2RpbmcKPj4KZW5kb2JqCjIwIDAgb2JqCjw8Ci9UeXBlIC9Gb250Ci9TdWJ0eXBlIC9UeXBlMQovQmFzZUZvbnQgL0hlbHZldGljYQovRW5jb2RpbmcgL1dpbkFuc2lFbmNvZGluZwo+PgplbmRvYmoKMSAwIG9iago8PAovVHlwZSAvQ2F0YWxvZwovUGFnZXMgMyAwIFIKPj4KZW5kb2JqCjIgMCBvYmoKPDwKL1R5cGUgL1BhZ2VzCi9LaWRzIFszIDAgUl0KL0NvdW50IDEKPj4KZW5kb2JqCjMgMCBvYmoKPDwKL1R5cGUgL1BhZ2VzCi9LaWRzIFs1IDAgUl0KL0NvdW50IDEKPj4KZW5kb2JqCjQgMCBvYmoKPDwKL1R5cGUgL0NhdGFsb2cKL1BhZ2VzIDIgMCBSCj4+CmVuZG9iagp4cmVmCjAgMjEKMDAwMDAwMDAwMCA2NTUzNSBmIAowMDAwMDAwMDA5IDAwMDAwIG4gCjAwMDAwMDAwNTggMDAwMDAgbiAKMDAwMDAwMDExNSAwMDAwMCBuIAowMDAwMDAwMTc0IDAwMDAwIG4gCjAwMDAwMDAyMzMgMDAwMDAgbiAKMDAwMDAwMDI5MiAwMDAwMCBuIAowMDAwMDAwMzUxIDAwMDAwIG4gCjAwMDAwMDA0MTAgMDAwMDAgbiAKMDAwMDAwMDQ2OSAwMDAwMCBuIAowMDAwMDAwNTI4IDAwMDAwIG4gCjAwMDAwMDA1ODcgMDAwMDAgbiAKMDAwMDAwMDY0NiAwMDAwMCBuIAowMDAwMDAwNzA1IDAwMDAwIG4gCjAwMDAwMDA3NjQgMDAwMDAgbiAKMDAwMDAwMDgyMyAwMDAwMCBuIAowMDAwMDAwODgyIDAwMDAwIG4gCjAwMDAwMDA5NDEgMDAwMDAgbiAKMDAwMDAwMDk5OSAwMDAwMCBuIAowMDAwMDAxMDU4IDAwMDAwIG4gCjAwMDAwMDEwNzcgMDAwMDAgbiAKdHJhaWxlcgo8PAovU2l6ZSAyMQovUm9vdCA0IDAgUgo+PgpzdGFydHhyZWYKMTE3NwolJUVPRgo=`;
      } else if (['jpg', 'jpeg', 'png'].includes(fileType)) {
        // 이미지 파일의 경우 샘플 이미지 URL 사용
        return `data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAwIiBoZWlnaHQ9IjMwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZjBmMGYwIi8+CiAgPHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCwgc2Fucy1zZXJpZiIgZm9udC1zaXplPSIxOCIgZmlsbD0iIzY2NiIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPkltYWdlIFByZXZpZXc8L3RleHQ+CiAgPHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCwgc2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzk5OSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9IjEuNWVtIj5GaWxlOiAke2ZpbGVOYW1lfTwvdGV4dD4KPC9zdmc+`;
      }
      
      return `#${fileName}`;
    }

    // 전체화면 미리보기
    function openFullscreen(fileName, fileContent, fileType) {
      // 전체화면 팝업 생성
      const fullscreenPopup = document.createElement('div');
      fullscreenPopup.className = 'attachment-popup show';
      fullscreenPopup.style.zIndex = '10001';
      
      let content = '';
      if (fileType === 'pdf') {
        content = `<iframe src="${fileContent}" style="width: 100%; height: 100vh; border: none;"></iframe>`;
      } else if (['jpg', 'jpeg', 'png', 'gif'].includes(fileType)) {
        content = `<img src="${fileContent}" alt="${fileName}" style="max-width: 100%; max-height: 100vh; object-fit: contain;">`;
      } else {
        content = `<div style="display: flex; align-items: center; justify-content: center; height: 100vh; font-size: 18px; color: var(--muted);">전체화면 미리보기를 지원하지 않는 파일 형식입니다.</div>`;
      }
      
      fullscreenPopup.innerHTML = `
        <div style="position: relative; width: 100%; height: 100%;">
          <button onclick="this.closest('.attachment-popup').remove()" style="position: absolute; top: 20px; right: 20px; z-index: 10002; background: rgba(0,0,0,0.7); color: white; border: none; border-radius: 50%; width: 40px; height: 40px; font-size: 20px; cursor: pointer;">×</button>
          ${content}
        </div>
      `;
      
      document.body.appendChild(fullscreenPopup);
      
      // ESC 키로 닫기
      const closeHandler = (e) => {
        if (e.key === 'Escape') {
          fullscreenPopup.remove();
          document.removeEventListener('keydown', closeHandler);
        }
      };
      document.addEventListener('keydown', closeHandler);
    }

    // 미리보기 닫기
    function closePreview() {
      const preview = document.getElementById('attachmentPreview');
      preview.classList.remove('show');
    }

    // 파일 다운로드
    function downloadFile(fileName) {
      alert(`${fileName} 다운로드가 시작됩니다.`);
      console.log('파일 다운로드:', fileName);
    }

    // 전화 걸기
    function callPhone(phoneNumber) {
      if (phoneNumber && phoneNumber !== '-') {
        window.location.href = `tel:${phoneNumber}`;
      } else {
        alert('전화번호가 없습니다.');
      }
    }

    // 텍스트 복사
    async function copyText(text) {
      if (text && text !== '-') {
        try {
          await navigator.clipboard.writeText(text);
          alert('복사되었습니다.');
        } catch (e) {
          alert('복사 실패: 권한을 확인하세요.');
        }
      } else {
        alert('복사할 내용이 없습니다.');
      }
    }

    // T맵 열기
    function openTmap(address) {
      if (address && address !== '-') {
        // T맵 앱 스킴 URL
        const tmapScheme = `tmap://search?name=${encodeURIComponent(address)}`;
        
        // T맵 웹 버전 URL (폴백용)
        const tmapWebUrl = `https://tmapapi.sktelecom.com/main/map.html?q=${encodeURIComponent(address)}`;
        
        // 카카오맵 URL (최종 폴백용)
        const kakaoMapUrl = `https://map.kakao.com/?q=${encodeURIComponent(address)}`;
        
        try {
          // T맵 앱으로 연결 시도
          const link = document.createElement('a');
          link.href = tmapScheme;
          link.style.display = 'none';
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          
          // T맵 앱이 설치되어 있지 않은 경우를 대비한 폴백
          setTimeout(() => {
            // 사용자에게 선택권 제공
            const useTmapWeb = confirm(`T맵 앱이 설치되어 있지 않습니다.\n\n"확인"을 누르면 T맵 웹으로 이동합니다.\n"취소"를 누르면 카카오맵으로 이동합니다.`);
            
            if (useTmapWeb) {
              window.open(tmapWebUrl, '_blank');
            } else {
              window.open(kakaoMapUrl, '_blank');
            }
          }, 1000);
          
        } catch (error) {
          console.error('T맵 연결 오류:', error);
          // 오류 발생 시 카카오맵으로 폴백
          window.open(kakaoMapUrl, '_blank');
        }
      } else {
        alert('주소 정보가 없습니다.');
      }
    }

    // 상세 정보 토글
    function toggleSiteDetails() {
      const popup = document.getElementById('attachmentPopup');
      const popupContent = popup.querySelector('.attachment-popup-content');
      const popupBody = document.getElementById('attachmentPopupBody');
      
      // 현재 팝업 내용을 상세 정보로 교체
      const currentSiteName = document.getElementById('popupSiteName').textContent;
      const siteInfo = getSiteInfo(currentSiteName);
      
      // 상세 정보 HTML 생성 (연동된 데이터)
      const detailHtml = `
        <div class="site-detail-section">
          <div class="site-detail-header">
            <h3>${currentSiteName} 상세 정보</h3>
            <button class="site-info-btn detail" onclick="goBackToSiteInfo()">뒤로가기</button>
          </div>
          <div class="site-detail-content">
            <div class="detail-item">
              <div class="detail-label">작성자</div>
              <div class="detail-value">${siteInfo.manager || '-'}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">부재명</div>
              <div class="detail-value">${siteInfo.subtitle || '-'}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">작업공정</div>
              <div class="detail-value">${siteInfo.process || '-'}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">작업유형</div>
              <div class="detail-value">${siteInfo.workType || '-'}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">블럭 / 동 / 호수</div>
              <div class="detail-value">${siteInfo.block || '-'} / ${siteInfo.building || '-'} / ${siteInfo.unit || '-'}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">공수</div>
              <div class="detail-value">${siteInfo.duration || '1일'}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">사진·문서</div>
              <div class="detail-value">보수 전 ${siteInfo.photosBefore || 0}장 / 보수 후 ${siteInfo.photosAfter || 0}장</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">최종 업데이트</div>
              <div class="detail-value">${getLatestDate(siteInfo)}</div>
            </div>
          </div>
        </div>
      `;
      
      // 팝업 내용 교체
      popupBody.innerHTML = detailHtml;
      
      // 팝업 크기 조정
      popupContent.style.maxHeight = '90vh';
      popupContent.style.overflowY = 'auto';
    }

    // 현장 정보로 돌아가기
    function goBackToSiteInfo() {
      const popup = document.getElementById('attachmentPopup');
      const popupContent = popup.querySelector('.attachment-popup-content');
      const popupBody = document.getElementById('attachmentPopupBody');
      
      // 현재 현장명으로 원래 현장 정보 다시 로드
      const currentSiteName = document.getElementById('popupSiteName').textContent;
      const siteInfo = getSiteInfo(currentSiteName);
      renderSiteInfoPopup(siteInfo, popupBody);
      
      // 팝업 크기 원래대로
      popupContent.style.maxHeight = 'calc(100vh - 40px)';
    }

    // 오늘의 현장정보 조회 (상세 버튼 클릭 시)
    function showTodaySiteInfo(orgName) {
      // 팝업 닫기
      hideAttachmentPopup();
      
      // 오늘의 현장정보 조회 기능 실행
      // 기존의 오늘의 현장정보 조회 로직과 동일하게 동작
      const today = new Date();
      const todayStr = today.toISOString().split('T')[0].replace(/-/g, '.');
      
      // 현장명 설정
      const siteNameElement = document.getElementById('siteName');
      if (siteNameElement) {
        setText('#siteName', orgName);
      }
      
      // 날짜 설정
      const dateElement = document.getElementById('date');
      if (dateElement) {
        setText('#date', todayStr);
      }
      
      // 현장 정보 업데이트
      updateSiteInfo(orgName, todayStr);
      
      // 현장 리스트에서 해당 현장 선택 표시
      const siteListItems = document.querySelectorAll('.site-summary-item');
      siteListItems.forEach(item => {
        const siteNameSpan = item.querySelector('.site-summary-name');
        if (siteNameSpan && siteNameSpan.textContent.includes(orgName)) {
          item.classList.add('selected');
          // 선택된 항목 스크롤
          item.scrollIntoView({ behavior: 'smooth', block: 'center' });
        } else {
          item.classList.remove('selected');
        }
      });
      
      // 성공 메시지
      showToast(`${orgName} 현장의 오늘 정보를 조회했습니다.`);
    }

    // 첨부파일 팝업 이벤트 초기화
    function initAttachmentPopup() {
      const popup = document.getElementById('attachmentPopup');
      const closeBtn = document.getElementById('closeAttachmentPopup');
      const previewCloseBtn = document.getElementById('closePreview');
      
      // 팝업 닫기 버튼 클릭
      closeBtn.addEventListener('click', hideAttachmentPopup);
      
      // 미리보기 닫기 버튼 클릭
      previewCloseBtn.addEventListener('click', closePreview);
      
      // 배경 클릭 시 닫기
      popup.addEventListener('click', (e) => {
        if (e.target === popup) {
          hideAttachmentPopup();
        }
      });
      
      // ESC 키로 닫기
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          if (popup.classList.contains('show')) {
            hideAttachmentPopup();
          }
        }
      });
    }

    // 주소, 숙소 확장 기능 초기화
    function initExpandableContent() {
      const expandableElements = document.querySelectorAll('.info-val.expandable');
      
      expandableElements.forEach(element => {
        element.addEventListener('click', function() {
          // 다른 확장된 요소들 닫기
          expandableElements.forEach(el => {
            if (el !== this) {
              el.classList.remove('expanded');
            }
          });
          
          // 현재 요소 토글
          this.classList.toggle('expanded');
        });
      });
    }

    // NPC-1000 자재관리 기능
    /* ===== 현장 데이터 ===== */
    const NPC_SITES = [
      { id:'b', name:'site3', initialStock:300, logs:[
        {date:'2025-01-14', type:'out', qty:50, memo:'파일기초'},
        {date:'2025-01-15', type:'out', qty:60, memo:'양생보강'}
      ]},
      { id:'c', name:'site4', initialStock:0, logs:[
        {date:'2025-01-15', type:'in', qty:300, memo:'긴급 입고'},
        {date:'2025-01-15', type:'out', qty:60, memo:'타설 1구역'}
      ]},
      { id:'d', name:'site5', initialStock:500, logs:[
        {date:'2025-01-15', type:'out', qty:80, memo:'기초공사'},
        {date:'2025-01-15', type:'in', qty:150, memo:'정기 입고'}
      ]},
      { id:'e', name:'NPC-1000', initialStock:200, logs:[
        {date:'2025-01-15', type:'out', qty:30, memo:'슬라브 공사'},
        {date:'2025-01-15', type:'in', qty:100, memo:'긴급 납품'}
      ]},
      { id:'f', name:'NPC-1001', initialStock:150, logs:[
        {date:'2025-01-15', type:'out', qty:25, memo:'유지보수'},
        {date:'2025-01-15', type:'in', qty:80, memo:'정기 점검'}
      ]}
    ];

    // 자재 요청 데이터
    const NPC_REQUESTS = [];

    /* ===== 유틸 ===== */
    const ymd = (d=new Date()) => d.toISOString().slice(0,10);
    const fmt = n => (n||0).toLocaleString('ko-KR');
    function stockOf(site){
      let s = site.initialStock||0, latest=null;
      site.logs.forEach(l=>{ s += (l.type==='in'? l.qty : -l.qty); if(!latest||l.date>latest) latest=l.date; });
      return {s, latest};
    }

    /* ===== NPC 요소 ===== */
    const npcKpiIn=document.getElementById('npcKpiIn');
    const npcKpiUsed=document.getElementById('npcKpiUsed');
    const npcKpiStock=document.getElementById('npcKpiStock');

    const npcBtnLog=document.getElementById('npcBtnLog');
    const npcBtnRecord=document.getElementById('npcBtnRecord');
    const npcBtnRequest=document.getElementById('npcBtnRequest');
    const npcBtnNewTag=document.getElementById('npcBtnNewTag');

    const npcDlgLog=document.getElementById('npcDlgLog');
    const npcLogBody=document.getElementById('npcLogBody');
    const npcSumIn=document.getElementById('npcSumIn');
    const npcSumOut=document.getElementById('npcSumOut');

    const npcDlgRecord=document.getElementById('npcDlgRecord');
    const npcRecSite=document.getElementById('npcRecSite');
    const npcRecDate=document.getElementById('npcRecDate');
    const npcRecType=document.getElementById('npcRecType');
    const npcRecQty=document.getElementById('npcRecQty');
    const npcRecMemo=document.getElementById('npcRecMemo');
    const npcRecSave=document.getElementById('npcRecSave');

    const npcDlgRequest=document.getElementById('npcDlgRequest');
    const npcReqSite=document.getElementById('npcReqSite');
    const npcReqQty=document.getElementById('npcReqQty');
    const npcReqMemo=document.getElementById('npcReqMemo');
    const npcReqSubmit=document.getElementById('npcReqSubmit');

    /* ===== NPC 상태: 현재 현장 ===== */
    let npcCurrent = null;
    let selectedSiteName = null;

    /* ===== NPC 동작 ===== */
    function renderNpcKPI(){
      console.log('renderNpcKPI 호출, npcCurrent:', npcCurrent); // 디버깅용
      
      if (!npcCurrent) {
        console.log('npcCurrent가 없음, 0으로 설정'); // 디버깅용
        npcKpiIn.textContent = '0';
        npcKpiUsed.textContent = '0';
        npcKpiStock.textContent = '0';
        return;
      }
      
      const today = ymd(new Date());
      console.log('오늘 날짜:', today); // 디버깅용
      console.log('현장 로그:', npcCurrent.logs); // 디버깅용
      
      const inQty = npcCurrent.logs.filter(l=>l.type==='in' && l.date===today).reduce((a,b)=>a+b.qty,0);
      const used = npcCurrent.logs.filter(l=>l.type==='out' && l.date===today).reduce((a,b)=>a+b.qty,0);
      
      // 입고-사용=재고 공식 적용
      const totalIn = npcCurrent.logs.filter(l=>l.type==='in').reduce((a,b)=>a+b.qty,0);
      const totalUsed = npcCurrent.logs.filter(l=>l.type==='out').reduce((a,b)=>a+b.qty,0);
      const currentStock = (npcCurrent.initialStock || 0) + totalIn - totalUsed;
      
      console.log('계산 결과:', { inQty, used, totalIn, totalUsed, currentStock, initialStock: npcCurrent.initialStock }); // 디버깅용
      
      npcKpiIn.textContent = fmt(inQty);
      npcKpiUsed.textContent = used > 0 ? `-${fmt(used)}` : '0';
      npcKpiStock.textContent = fmt(currentStock);
    }

    // 현장 선택 시 NPC 데이터 업데이트
    function updateNpcForSite(siteName) {
      console.log('updateNpcForSite 호출:', siteName); // 디버깅용
      console.log('NPC_SITES:', NPC_SITES); // 디버깅용
      
      // 현장명을 기반으로 NPC 데이터 찾기
      const site = NPC_SITES.find(s => s.name === siteName);
      console.log('찾은 현장:', site); // 디버깅용
      
      if (site) {
        npcCurrent = site;
        selectedSiteName = siteName;
        console.log('NPC 현장 설정 완료:', npcCurrent); // 디버깅용
        renderNpcKPI();
      } else {
        // 현장이 없으면 기본 데이터로 설정
        console.log('현장을 찾을 수 없음, 기본 현장으로 설정'); // 디버깅용
        npcCurrent = NPC_SITES[0];
        selectedSiteName = NPC_SITES[0].name;
        renderNpcKPI();
      }
    }



    // NPC 로그 보기
    npcBtnLog.onclick = ()=>{
      if (!npcCurrent) {
        alert('현장을 먼저 선택해주세요.');
        return;
      }
      
      const today = ymd(new Date());
      const rows = npcCurrent.logs.filter(l=>l.date===today);
      npcLogBody.innerHTML = rows.map(l=>{
        const label = l.type==='in'?'입고':'사용', tone = l.type==='in'?'text-tag2':'text-red-500', sign=l.type==='in'?'+':'−';
        const siteName = npcCurrent.name || '현장명';
        const date = l.date;
        const memo = l.memo || '';
        const qty = `${sign}${fmt(l.qty)}`;
        
        return `<tr class="border-t border-line">
          <td>${siteName}</td>
          <td>${date}</td>
          <td><span class="npc-chip ${tone} border-current/30">${label}</span></td>
          <td class="text-right font-bold ${tone}">${qty}</td>
          <td>${memo}</td>
        </tr>`;
      }).join('') || `<tr class="border-t border-line"><td colspan="5" class="py-6 text-center text-gray99">기록 없음</td></tr>`;
      const ins = rows.filter(l=>l.type==='in').reduce((a,b)=>a+b.qty,0);
      const outs= rows.filter(l=>l.type==='out').reduce((a,b)=>a+b.qty,0);
      npcSumIn.textContent=fmt(ins); npcSumOut.textContent=fmt(outs);
      
      // 테이블 셀 클릭 이벤트 추가
      setTimeout(() => {
        const tableCells = npcLogBody.querySelectorAll('td');
        tableCells.forEach(cell => {
          cell.addEventListener('click', function() {
            // 다른 셀들의 expanded 클래스 제거
            tableCells.forEach(otherCell => {
              if (otherCell !== this) {
                otherCell.classList.remove('expanded');
              }
            });
            
            // 현재 셀의 expanded 클래스 토글
            this.classList.toggle('expanded');
          });
        });
      }, 100);
      
      npcDlgLog.showModal();
    };

    // NPC 기록 입력
    npcBtnRecord.onclick = ()=> {
      if (!selectedSiteName) {
        alert('현장을 먼저 선택해주세요.');
        return;
      }
      // 참여 현장에서 선택된 현장으로 자동 설정
      npcRecSite.value = selectedSiteName;
      npcRecDate.value = ymd(new Date());
      npcRecType.value = 'in';
      npcRecQty.value = 1;
      npcRecMemo.value = '';
      npcDlgRecord.showModal();
    };

    npcRecSave.onclick = (e)=>{
      e.preventDefault();
      const site = NPC_SITES.find(s=>s.name===npcRecSite.value);
      if (!site) {
        alert('현장을 선택해주세요.');
        return;
      }
      
      const qty = Number(npcRecQty.value||0);
      if (qty <= 0) {
        alert('수량을 입력해주세요.');
        return;
      }

      site.logs.push({ 
        date: npcRecDate.value||ymd(new Date()), 
        type: npcRecType.value, 
        qty: qty, 
        memo: npcRecMemo.value?.trim() 
      });
      
      if(site.id===npcCurrent.id) renderNpcKPI();
      npcDlgRecord.close();
      alert('기록이 저장되었습니다.');
    };

    // NPC 자재 요청
    npcBtnRequest.onclick = ()=> {
      if (!selectedSiteName) {
        alert('현장을 먼저 선택해주세요.');
        return;
      }
      // 참여 현장에서 선택된 현장으로 자동 설정
      npcReqSite.value = selectedSiteName;
      npcReqQty.value = 1;
      npcReqMemo.value = '';
      npcDlgRequest.showModal();
    };

    npcReqSubmit.onclick = (e)=>{
      e.preventDefault();
      
      if (!npcReqSite.value) {
        alert('현장을 선택해주세요.');
        return;
      }
      
      const qty = Number(npcReqQty.value||0);
      if (qty <= 0) {
        alert('요청 수량을 입력해주세요.');
        return;
      }

      NPC_REQUESTS.push({
        siteName: npcReqSite.value,
        qty: qty,
        reason: npcReqMemo.value?.trim(),
        date: ymd(new Date()),
        status: '요청됨'
      });

      npcDlgRequest.close();
      alert('자재 요청이 제출되었습니다.');
    };

    // 새로운 태그 버튼 (추가) - 팝업 메뉴 표시
    npcBtnNewTag.onclick = () => {
      showNpcAddMenu();
    };

    // NPC 추가 기능 선택 팝업 표시
    function showNpcAddMenu() {
      const popup = document.getElementById('npcAddMenuPopup');
      if (popup) {
        popup.style.display = 'flex';
      }
    }

    // NPC 추가 기능 선택 팝업 숨기기
    function hideNpcAddMenu() {
      const popup = document.getElementById('npcAddMenuPopup');
      if (popup) {
        popup.style.display = 'none';
      }
    }

    // 수동 현장 선택 모드 - 입고 기록
    function openRecordModalForNewSite() {
      npcRecSite.value = ''; // 현장 선택 초기화
      npcRecDate.value = ymd(new Date());
      npcRecType.value = 'in';
      npcRecQty.value = 1;
      npcRecMemo.value = '';
      npcDlgRecord.showModal();
    }

    // 수동 현장 선택 모드 - 자재 요청
    function openRequestModalForNewSite() {
      npcReqSite.value = ''; // 현장 선택 초기화
      npcReqQty.value = 1;
      npcReqMemo.value = '';
      npcDlgRequest.showModal();
    }



    /* ===== 초기화 ===== */
    function initNpcTitleIconFallback() {
      const npcTitleIcon = document.querySelector('.npc-title-icon');
      
      if (npcTitleIcon) {
        // 이미지 로딩 실패 시 처리
        npcTitleIcon.addEventListener('error', function() {
          console.log('NPC 제목 아이콘 로딩 실패:', this.src);
          
          // 외부 링크로 대체 시도
          const fallbackSrc = 'https://postfiles.pstatic.net/MjAyNTA5MDlfMTAg/MDAxNzU3MzczOTIzODc2.V3ORy11Kszltv6qJ6M3zt4qFtdNopNi1sYcrZALvFD0g.5ZpgJNYRXfyedL0hVpIfo1sxqgBPUAO9SmMjmKf7qZgg.PNG/%EC%9E%AC%EA%B3%A0%EA%B4%80%EB%A6%AC.png?type=w966';
          
          // 외부 링크로 대체
          this.src = fallbackSrc;
          console.log('외부 링크로 대체:', fallbackSrc);
        });
        
        // 이미지 로딩 성공 시 처리
        npcTitleIcon.addEventListener('load', function() {
          console.log('NPC 제목 아이콘 로딩 성공:', this.src);
        });
      }
    }

    function initNpcCard() {
      console.log('initNpcCard 호출'); // 디버깅용
      npcRecDate.value = ymd(new Date());
      npcRecSite.innerHTML = NPC_SITES.map(s=>`<option>${s.name}</option>`).join('');
      npcReqSite.innerHTML = NPC_SITES.map(s=>`<option>${s.name}</option>`).join('');
      // 초기에는 첫 번째 현장으로 설정
      npcCurrent = NPC_SITES[0];
      selectedSiteName = NPC_SITES[0].name;
      console.log('초기 NPC 현장 설정:', npcCurrent); // 디버깅용
      renderNpcKPI();
    }

    // 테스트 함수 (개발용)
    function testNpcData() {
      console.log('=== NPC 데이터 테스트 ===');
      console.log('NPC_SITES:', NPC_SITES);
      console.log('현재 npcCurrent:', npcCurrent);
      console.log('현재 selectedSiteName:', selectedSiteName);
      
      // 각 현장별 데이터 테스트
      NPC_SITES.forEach(site => {
        console.log(`\n--- ${site.name} 현장 데이터 ---`);
        console.log('초기 재고:', site.initialStock);
        console.log('로그:', site.logs);
        
        const totalIn = site.logs.filter(l=>l.type==='in').reduce((a,b)=>a+b.qty,0);
        const totalUsed = site.logs.filter(l=>l.type==='out').reduce((a,b)=>a+b.qty,0);
        const currentStock = site.initialStock + totalIn - totalUsed;
        
        console.log('총 입고:', totalIn);
        console.log('총 사용:', totalUsed);
        console.log('현재 재고:', currentStock);
      });
    }

    // NPC 추가 메뉴 팝업 이벤트 리스너 초기화
    function initNpcAddMenu() {
      const popup = document.getElementById('npcAddMenuPopup');
      const closeBtn = document.getElementById('npcAddMenuClose');
      const options = popup?.querySelectorAll('.npc-add-menu-option');

      // 닫기 버튼 이벤트
      if (closeBtn) {
        closeBtn.addEventListener('click', hideNpcAddMenu);
      }

      // 배경 클릭 시 닫기
      if (popup) {
        popup.addEventListener('click', (e) => {
          if (e.target === popup) {
            hideNpcAddMenu();
          }
        });
      }

      // 옵션 클릭 이벤트
      if (options) {
        options.forEach(option => {
          option.addEventListener('click', () => {
            const action = option.getAttribute('data-action');
            hideNpcAddMenu();
            
            switch(action) {
              case 'record':
                openRecordModalForNewSite();
                break;
              case 'request':
                openRequestModalForNewSite();
                break;
            }
          });
        });
      }
    }

    // 시작
    document.addEventListener('DOMContentLoaded', ()=>{
      initButtonClickEffects();
      bindActions();
      initDetailToggle();
      initFromHome();
      initRealtimeUpdate();
      initNpcTitleIconFallback();
      initNpcCard();
      initSiteDocumentButtons();
      initSiteSearch();
      initExpandableContent();
      initAttachmentPopup();
      initNpcAddMenu();
      
      // 테스트 함수를 전역으로 노출 (개발용)
      window.testNpcData = testNpcData;
    });

    // CacheGuard v1 — stale 화면 방지 (bfcache/정적캐시/SW)
    (function CacheGuard(){
      const CFG = {
        VERSION_URL: '/version.json',   // 빌드 버전 endpoint
        VERSION_KEY: 'app_version',     // 로컬 저장 키
        STALE_WARN_MS: 10*60*1000,      // 10분 이상 비활성 → 경고 토스트
        PATCH_LINKS: true               // CSS/JS/IMG에 ?v=버전 자동 부착
      };
      const LS = localStorage;

      // 0) 뒤로가기 bfcache 복귀 → 강제 최신화
      window.addEventListener('pageshow', e => { if (e.persisted) location.reload(); });

      // 1) 서비스워커가 있으면 즉시 업데이트/적용
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.getRegistrations().then(regs=>{
          regs.forEach(reg=>{
            reg.update().catch(()=>{});
            if (reg.waiting) reg.waiting.postMessage({type:'SKIP_WAITING'});
          });
        });
        navigator.serviceWorker.addEventListener('controllerchange', ()=> location.reload());
      }

      // 2) 버전 체크 → 바뀌면 전체 리로드
      async function fetchVersion(){
        try{
          const r = await fetch(CFG.VERSION_URL + '?t=' + Date.now(), { cache:'no-store' });
          if(!r.ok) return null;
          const j = await r.json();
          return String(j.version || '');
        }catch(e){ return null; }
      }
      function patchStaticLinks(ver){
        if(!CFG.PATCH_LINKS || !ver) return;
        const sel = 'link[rel=stylesheet][href],script[src],img[src]';
        document.querySelectorAll(sel).forEach(el=>{
          const attr = el.tagName==='LINK' ? 'href' : 'src';
          const url = new URL(el.getAttribute(attr), location.origin);
          // 이미 버전 파라미터 있으면 교체
          url.searchParams.set('v', ver);
          el.setAttribute(attr, url.pathname + '?' + url.searchParams.toString());
        });
      }
      (async function init(){
        const newV = await fetchVersion();
        const oldV = LS.getItem(CFG.VERSION_KEY);

        if (newV && newV !== oldV) {
          LS.setItem(CFG.VERSION_KEY, newV);
          patchStaticLinks(newV);       // 정적 리소스 캐시 무효화
          // 첫 로드면 링크만 패치하고, 두번째부터는 완전 새로고침
          if (oldV) { location.reload(true); return; }
        } else if (newV && !oldV) {
          LS.setItem(CFG.VERSION_KEY, newV);
          patchStaticLinks(newV);
        }

        // 가시성 복귀 시 데이터만 재조회(옵션)
        document.addEventListener('visibilitychange', ()=>{
          if (document.visibilityState==='visible') {
            // 여기에 페이지별 갱신 함수 연결: renderKPI?.(); refreshList?.();
            const last = Number(LS.getItem('last_active_ts')||0), now=Date.now();
            if (last && now-last > CFG.STALE_WARN_MS) toast('최신 내용으로 갱신했어요.');
            LS.setItem('last_active_ts', String(now));
          }
        });
        LS.setItem('last_active_ts', String(Date.now()));
      })();

      // 3) 간단 토스트
      function toast(msg){
        let el = document.getElementById('cg-toast');
        if(!el){
          el = Object.assign(document.createElement('div'), { id:'cg-toast' });
          el.style.cssText = 'position:fixed;left:50%;bottom:72px;transform:translateX(-50%);background:#1A254F;color:#fff;padding:10px 14px;border-radius:10px;font:600 13px/1 system-ui;z-index:9999;box-shadow:0 6px 24px rgba(0,0,0,.2);opacity:0;transition:opacity .2s';
          document.body.appendChild(el);
        }
        el.textContent = msg; el.style.opacity='1'; setTimeout(()=> el.style.opacity='0', 1800);
      }
    })();
  </script>
</body>
</html>

