# DY0928 급여관리 도구 개선 기획안

## 1. 배경 · 목표

- 계산 정책 일원화(모바일/관리자)와 운영 효율을 위해 관리자용 급여관리 도구를 재구성한다.
- HTML 급여명세(현 구조) 유지, PDF는 제외. 대신 관리/설정 기능과 운영 흐름을 강화한다.
- 계산 정책은 DY0928 급여 계산 정책(문서)과 동일하게 적용한다.
  - 1공수=8시간, 일당=시급×8, 연장시급=기본시급×1.5
  - 일용/프리: 연장수당 없음, 3.3%(3%+0.3%) 공제
  - 상용직: employment_tax_rates 기본치(없으면 가드 세율) 적용
  - 개인 세율(custom_tax_rates)이 있으면 최우선 적용

## 2. 사용자 · 권한

- 시스템관리자(system_admin), 관리자(admin) 접근
  - 조직 제한이 있을 경우(멀티 테넌시), 해당 조직 소속 현장/사용자 데이터만 필터
- 보기/발행/승인/지급 액션은 관리자 이상에서만 수행

## 3. 정보 구조 (IA) · 네비게이션

- 메뉴: 관리자 > 도구 > 급여관리 도구
- 탭 구성(페이지 내):
  1. 대시보드(요약) 2) 개인세율 3) 기본세율 4) 급여계산 미리보기 5) 스냅샷 6) 규칙(선택)

## 4. 주요 기능

1. 대시보드(요약)
   - 이번 달/최근 3개월 총액, 공제, 실지급 합계 카드
   - 상태별 스냅샷 카운트(issued/approved/paid)
   - 개인세율 설정 미완 사용자 수(경고 배지)

2. 개인세율 관리(개인별 설정)
   - 대상: worker_salary_settings
   - 필드: employment_type(freelancer/daily_worker/regular_employee), daily_rate, custom_tax_rates(JSON: income_tax, local_tax, national_pension, health_insurance, employment_insurance), effective_date, is_active
   - 리스트 + 검색(이름/이메일/역할/현장), 정렬(수정일/이름)
   - 편집 패널(사이드/모달):
     - 일당, 고용형태, 개인세율 입력(%)
     - 적용 시작일(effective_date)·활성 토글
     - 저장 시 새 레코드 생성(히스토리 유지) 또는 현재 활성 레코드 업데이트(옵션)
   - 일괄 적용: 선택 사용자에 동일한 개인세율/일당 적용(선택)
   - 유효성: % 0~100, 일당 정수, effective_date ≤ 대상월

3. 기본세율 관리(고용형태별 디폴트)
   - 대상: employment_tax_rates
   - 필드: employment_type, income_tax_rate, pension_rate, health_insurance_rate, employment_insurance_rate
   - 리스트/편집 패널, 가드 세율을 함께 노출(참고)

4. 급여계산 미리보기(What-if)
   - 입력: 사용자, 연·월, (선택)현장, (선택)추가 공수/시간 덮어쓰기
   - 출력: 정책 로직으로 월간 결과(총공수, 기본급/연장/보너스, 공제 상세, 실수령액)
   - 세율 출처 배지: 개인설정/형태기본/가드
   - 디버그(개발 모드): records 개수, 합계(labor/work), 샘플 목록

5. 스냅샷 관리(발행/승인/지급)
   - 조회/필터: 사용자, 상태(issued/approved/paid), 연·월
   - 발행: 선택 사용자×선택 월 스냅샷 생성(정책 로직 적용)
   - 승인/지급: 상태 전이, 타임스탬프 기록
   - HTML 보기: 기존 /payslip/[userId]/[year]/[month]

6. 규칙 관리(선택)
   - 대상: salary_calculation_rules(시급/일급/연장배율 등 실험적 룰)
   - MVP에서는 숨김 또는 Read-only 추천

## 5. 화면 설계(요약)

- 공통 UI 원칙
  - 라이트/다크 고대비 입력 컴포넌트(테두리/배경/포커스 링)
  - 서버 상태/에러 배지, 비동기 로딩 인디케이터
  - 표: 고정 헤더, 정렬/필터, 빈 상태 안내

1. 대시보드
   - 상단 카드: 총액, 공제, 실수령, 스냅샷 상태별 카운트
   - 최근 월별 추세 미니차트(선택)

2. 개인세율
   - 좌: 필터(검색, 고용형태, 활성여부)
   - 우: 테이블(이름, 역할, 현장, 고용형태, 일당, 개인세율 요약, 적용일, 수정일)
   - 행 선택 → 우측 패널: 일당/형태/개인세율 편집, 저장/취소
   - CTA: ‘일괄 적용’, ‘신규 항목’

3. 기본세율
   - employment_type 별 카드/테이블, 입력(%), 저장
   - 가드 세율(문서의 기본값)도 함께 표기

4. 급여계산 미리보기
   - 상단 컨트롤: 사용자, 월, (선택)현장, 시뮬레이션 옵션
   - 결과 카드: 공수/근무·연장합계, 지급/공제 상세, 세율 출처 배지, 금액 요약
   - HTML 명세 보기 버튼(새 창)

5. 스냅샷
   - 필터/리스트/상태 액션(승인/지급), HTML 보기, 내보내기(CSV, 선택)

## 6. 데이터 모델 · 매핑

- worker_salary_settings
  - worker_id, employment_type, daily_rate, custom_tax_rates(JSON, %), effective_date, is_active, created_at/updated_at
  - 정책: 활성 + 적용일≤기준일 중 최신 1건 적용
- salary_info(레거시)
  - hourly_rate, overtime_rate → 폴백(일당=시급×8)
- employment_tax_rates
  - employment_type별 소득세/4대보험 기본률
- salary_snapshots(또는 동등 테이블)
  - worker_id, year, month, status(issued/approved/paid), salary(JSON), issued_at/approved_at/paid_at

## 7. API/서비스(초안, 구현은 후속)

- GET /admin/payroll/rates/personal?… → worker_salary_settings 목록
- POST /admin/payroll/rates/personal → 신규/업데이트(히스토리 전략 옵션)
- GET /admin/payroll/rates/defaults → employment_tax_rates
- POST /admin/payroll/rates/defaults → 업데이트
- POST /admin/payroll/preview → { userId, year, month, siteId?, overrides? } → 월 계산 결과
- POST /admin/payroll/snapshots/publish → { userId|ids[], year, month }
- POST /admin/payroll/snapshots/approve → { userId, year, month }
- POST /admin/payroll/snapshots/pay → { userId, year, month }
- GET /admin/payroll/snapshots?status=&year=&month=&userId=

메모: 내부 계산은 lib/services/salary-calculation.service 재사용. 스냅샷은 월 API와 1:1 일치하도록 개인세율/형태 스냅샷 필드에 포함.

## 8. UX 세부

- 세율 출처 배지: ‘개인설정/형태기본/가드’, 툴팁에 적용 퍼센트 표시
- 유효성/가이던스: % 단위 입력, 0~100 범위 경고, 저장 전 미리보기 지원(선택)
- A11y: 키보드 내비게이션, 적절한 aria-\*, 포커스 스타일, 테이블 행 액션에 툴팁
- 로딩/에러: 비동기 상태 명확 표시, 재시도/취소 제공

## 9. 성능 · 보안

- 페이지네이션: 목록 API는 범위 질의(range); 인덱스( worker_id, effective_date )
- 캐시: 정적 기본세율은 SWR 캐시 가능. 개인세율 저장 후 해당 사용자 캐시 무효화
- 보안/RLS: 관리자 전용 라우트는 서비스 롤, 특정 조직 제한 시 조직 검증(사이트/사용자 매핑)

## 10. 마이그레이션 · 정합

- profiles.\* 기반 레거시 세율 → worker_salary_settings로 이전(스크립트 제공)
- 개인세율 없는 사용자: 고용형태 기본 → 가드 세율 순 적용
- 스냅샷 일치성: 발행 시 개인세율/형태/일당을 snapshot에도 저장하여 월 API와 동일 수치 유지

## 11. 단계별 롤아웃(권장)

- Phase 1 (MVP)
  - 스냅샷 화면 유지·정리(대비/필터), 급여계산 미리보기 신설, 개인세율 최소 CRUD
  - 기본세율 Read-only 노출(가드 세율 포함)
- Phase 2
  - 개인세율 히스토리 전략(신규 행/덮어쓰기) 완비, 기본세율 편집,
  - 스냅샷 발행/승인/지급 일괄 처리, CSV 내보내기
- Phase 3
  - 규칙 관리(실험), 대시보드 차트, 일괄 적용/승인 워크플로우, 알림 연동(선택)

## 12. 리스크 · 대응

- 레거시/신규 혼재: 저장소 합치기 전, 레거시 화면은 숨김 유지. API 안정화 후 연결
- 데이터 품질: work_records 누락/불일치 → 월 계산 디버그 패널에서 합계/샘플로 검증 지원
- 조직 제한: 멀티테넌시 환경 대비하여 모든 목록/행동에 조직 필터 필수 적용

---

본 기획은 기존 API/컴포넌트 재사용 여부와 무관하게 UI/UX와 기능 범위, 데이터 정책을 우선 정의한다. 구현 시점에 현행 서비스(salary-calculation.service)·스냅샷 API와 정합을 맞추되, 필요시 전용 관리자 라우트를 신규 설계한다.
