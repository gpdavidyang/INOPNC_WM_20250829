# 본인 공수 입력 관리 및 캘린더 연동 구현 (2026-02-05)

## 1. 개요

본 문서는 작업자가 자신의 출력(공수) 정보를 캘린더를 통해 직접 확인하고, 누락되거나 잘못된 정보를 수정할 수 있도록 하는 기능의 구현 내용을 기술합니다. 특히 "승인(Approved)"된 작업일지의 데이터 무결성을 보장하기 위해 엄격한 상태 관리가 적용되었습니다.

## 2. 주요 기능

### 2.1 승인 상태 기반 수정 제어 (Strict Status Control)

- **승인(Approved) 상태**: 작업일지가 관리자에 의해 승인된 경우, 작업자는 자신의 공수를 수정할 수 없습니다. UI는 "승인 완료 (수정 불가)" 상태로 표시되며 입력 폼은 읽기 전용(Read-only)으로 전환됩니다.
- **기타 상태 (임시/제출/반려)**: 자유롭게 공수를 입력하거나 수정할 수 있습니다.

### 2.2 공수 입력 및 수정 (Upsert Logic)

- **Upsert 방식 적용**: 서버 액션(`upsertMyLabor`)을 통해 데이터 존재 여부를 확인합니다.
  - 기존 본인 입력 내역이 있음 -> 공수 시간 **업데이트**
  - 기존 내역이 없음 -> 새로운 공수 내역 **생성**
- 이를 통해 중복 데이터 생성을 방지하고 항상 최신 상태를 유지합니다.

### 2.3 캘린더 연동 및 인터랙션 (Calendar Integration)

- **기록이 있는 날짜 클릭**:
  - 상세 시트(Bottom Sheet)가 열립니다.
  - "공수 입력/수정하기" 버튼을 통해 모달을 열어 수정할 수 있습니다 (미승인 시).
- **기록이 없는(빈) 날짜 클릭**:
  - 즉시 **작업일지 작성 페이지**로 이동합니다.
  - 클릭한 날짜가 자동으로 **프리필(Pre-filled)** 되어, 날짜 선택 없이 바로 일지를 작성할 수 있습니다.

## 3. 기술적 구현 사항

### 3.1 Backend: `upsertMyLabor` (`app/actions/mobile/daily-reports.ts`)

- `submitMyLabor`를 대체하여 구현되었습니다.
- **Workflow**:
  1. 사용자 인증 및 프로필 확인
  2. 해당 날짜/현장의 작업일지 조회 (`daily_reports`)
  3. **Blocking**: `status === 'approved'`이면 `AppError(Forbidden)` 발생
  4. 작업일지 미존재 시 `status: 'submitted'` 상태로 신규 생성
  5. `daily_report_workers` 테이블에서 본인 이름(혹은 본인입력 마킹)으로 조회하여 `UDPATE` 또는 `INSERT` 수행

### 3.2 Frontend: `AttendancePage` (`modules/mobile/pages/attendance-page.tsx`)

- **캘린더 클릭 핸들러 (`openDetailSheetForDay`)**:
  - 해당 날짜에 데이터(`recordsForDay`)가 없으면 `localStorage`에 날짜를 저장하고 `/mobile`로 리다이렉트합니다.
- **수정 UI (Inline Bottom Sheet)**:
  - 별도의 모달(Modal) 대신 상세 시트 내부에서 `isEditingLabor` 상태를 통해 뷰 모드와 수정 모드를 전환합니다.
  - 이를 통해 사용자는 화면 이탈 없이 더 자연스러운 흐름으로 공수를 수정할 수 있습니다.

### 3.3 Frontend: `HomePage` (`modules/mobile/components/home/HomePage.tsx`)

- **프리필 로직 개선**:
  - 기존에는 `siteId`가 필수였으나, 캘린더에서 날짜만 가지고 진입하는 경우를 지원하기 위해 `workDate`만 존재하는 경우에도 `hasPrefill` 상태가 활성화되도록 조건을 완화했습니다.

## 4. 사용자 워크플로우 예시

1. **공수 수정 (미승인 건)**
   - 캘린더에서 '1.0공수'가 표시된 날짜 클릭
   - 상세 시트 오픈 -> '공수 입력/수정하기' 클릭
   - **시트 내부에서 입력 폼이 나타남**
   - '0.5공수'로 변경 후 '저장하기' 클릭 -> 수정 모드 종료 및 **반영 완료**

2. **공수 수정 시도 (승인 건)**
   - 캘린더에서 승인된(파란색) 날짜 클릭
   - 상세 시트 오픈 -> 버튼이 **'승인 완료 (수정 불가)'**로 비활성화됨 -> **수정 불가**

3. **신규 작성 (빈 날짜)**
   - 캘린더의 빈 날짜(예: 3일) 클릭
   - 화면이 전환되며 '일일 보고서 작성' 페이지로 이동
   - 날짜 필드에 '3일'이 자동 입력되어 있음
   - 현장 선택 후 작성 완료 -> **신규 생성 완료**
