# DY1001 진행도면 워크플로우 계획서

버전: v1.0 (초안)
작성일: 2025-10-01

## 1) 목표

- 현장정보 > 상세화면의 ‘진행도면’ 버튼을 클릭하면 해당 현장의 “가장 최근 진행도면(progress_drawing)”을 즉시 열람/마킹할 수 있도록 연동한다.
- 문서함 > 도면문서함(사이트 문서)과 스키마를 공유하여 단일 출처를 사용한다.
- 진행도면이 없을 경우, 명확한 안내와 업로드로 유도한다.
- 도면마킹도구(/mobile/markup-tool)와의 연계를 강화한다(최신 도면 즉시 마킹, 게시 시 진행도면 등록).

## 2) 현재 구조 요약 (재사용 지점)

- 도면 목록 API: `app/api/docs/drawings/route.ts`
  - 테이블: `site_documents`
  - 카테고리: `blueprint | progress_drawing | other` → 쿼리 파라미터 `category=plan|progress|other`
- 도면 업로드 API(사이트 문서): `app/api/site-documents/upload/route.ts`
  - `documentType` 값으로 `progress_drawing` 지정 시 진행도면으로 저장
- 문서함(모바일): `app/mobile/documents/page.tsx` → `app/documents/hub/page.tsx` 재사용
  - 탭: 도면문서함(업로드/목록) `DrawingsTab`
- 마킹 저장(게시 포함): `app/api/docs/drawings/markups/save/route.ts`
  - 게시(`published=true`) 시 `site_documents`에 `progress_drawing` 레코드 생성(프리뷰를 진행도면으로 등록)
- 현장정보 상세(모바일 화면): `modules/mobile/components/site/SiteInfoPage.tsx`
  - ‘진행도면’ 버튼 현존: `modules/mobile/components/site/SiteInfoPage.tsx:3493`
  - 현재는 첨부 팝업(focus='drawings')만 열림 → 최신 진행도면 직접 연결로 변경 필요

## 3) 데이터 모델 및 FK (검증/보강)

- 테이블: `site_documents`
  - `id uuid PK`
  - `site_id uuid NOT NULL` → `sites.id` FK
  - `document_type text CHECK (IN('ptw','blueprint','progress_drawing','other'))`
  - `file_name text`, `file_url text`, `file_size int`, `mime_type text`
  - `uploaded_by uuid` → `profiles.id` FK
  - `is_active boolean default true`, `version int default 1`, `notes text`
  - 인덱스:
    - `(site_id, document_type, created_at desc)`
    - `(site_id, created_at desc)`
- 테이블: `markup_documents`
  - `site_id uuid` → `sites.id` FK
  - `original_blueprint_url text`, `markup_data jsonb`, `markup_count int`
  - 선택(확장): `source_site_document_id uuid NULL` → `site_documents.id` FK (나중에 도입 고려)

권장 마이그레이션(필요 시):

- FK 보강 및 인덱스 추가 스크립트(요약)
  - `ALTER TABLE site_documents ADD CONSTRAINT site_documents_site_id_fkey FOREIGN KEY (site_id) REFERENCES sites(id) ON DELETE CASCADE;`
  - `CREATE INDEX IF NOT EXISTS idx_site_docs_site_type_created_at ON site_documents (site_id, document_type, created_at DESC);`

## 4) 연동 시나리오(UX 플로우)

1. 사용자가 ‘현장정보 > 상세화면’에서 ‘진행도면’ 클릭
2. 클라이언트가 최신 진행도면 조회
   - API: `GET /api/docs/drawings?siteId={SITE_ID}&category=progress&limit=1&page=1`
3. 분기 처리
   - 최신 진행도면 있음
     - 액션 시트 표시(또는 즉시 실행 옵션):
       - 보기: 서명 URL 체크 후 새 탭 열기
       - 도면 마킹 열기: 마킹툴에 선택된 도면 전달(로컬스토리지 bridge) 후 `/mobile/markup-tool` 이동
       - 문서함에서 보기: `/mobile/documents` 이동(해당 현장/카테고리 프리셋)
   - 최신 진행도면 없음
     - 안내 메시지 + CTA 버튼 2개
       - ‘도면 업로드’ → `/mobile/documents`의 도면문서함 탭으로 이동(현장=현재, 카테고리=진행 프리셋)
       - ‘도면마킹 도구로 이동’(선택) → `mode=upload`로 마킹툴을 열어 업로드→마킹→게시(게시 시 진행도면 자동 등록)

권장 안내 문구(없을 때):

- “해당 현장의 진행도면이 등록되어 있지 않습니다. 문서함 > 도면문서함에서 ‘진행도면’을 업로드해 주세요.”
- 보조: “마킹 도구에서 게시를 완료하면 진행도면으로 자동 등록됩니다.”

## 5) 상세 동작 설계

- 현장정보 화면 버튼(변경): `modules/mobile/components/site/SiteInfoPage.tsx:3493`
  - 기존: `handleAttachmentOpen('drawings')`
  - 변경: `handleOpenLatestProgressDrawing()` (신규 함수)
    - 1. `GET /api/docs/drawings?siteId={id}&category=progress&limit=1&page=1` 호출
    - 2. 결과가 있으면 액션 시트 표시
      - 보기: 파일 가용성 체크 → `/api/files/signed-url?url=` 로 서명 URL → 새 탭
      - 마킹: `localStorage.setItem('selected_drawing', JSON.stringify({ id, name, url, type:'progress' }))` 후 `/mobile/markup-tool` 이동
      - 문서함: `/mobile/documents?tab=drawings&siteId={id}&category=progress`
    - 3. 결과가 없으면 안내/CTA 렌더링

- 문서함(도면문서함) 초기 프리셋: `app/documents/hub/page.tsx` (DrawingsTab)
  - 초기 마운트에서 URL 쿼리(`siteId`, `category`, `q`, `page`)를 파싱해 `site`, `category`, `page`, `q` 상태를 설정
  - 예: `/mobile/documents?tab=drawings&siteId={id}&category=progress`

- 마킹도구 연계: `app/mobile/markup-tool/page.tsx`
  - 이미 `localStorage['selected_drawing']`를 읽어 초기 도면 로딩 가능
  - 업로드/브라우저 모드: `?mode=upload | browse` 지원 중
  - 게시 시 진행도면 자동 등록: `POST /api/docs/drawings/markups/save` (published=true) → `site_documents(document_type='progress_drawing')` insert

## 6) 업로드/인식 정책

- 사용자가 ‘진행도면’ 플로우에서 업로드 시, 반드시 `documentType='progress_drawing'`로 저장
  - 문서함 DrawingsTab 업로드는 이미 `progress_drawing` 대응(카테고리 ‘progress’ 선택 시)
  - 프리셋으로 ‘현장=현재, 카테고리=progress’가 자동 선택되도록 쿼리 연동
- 마킹도구에서 ‘게시’ 버튼 사용 시, 프리뷰를 `progress_drawing`으로 자동 등록(현존 구현 유지)

## 7) 에러/빈 상태 처리

- 최신 진행도면 없음:
  - 메시지: “해당 현장의 진행도면이 등록되어 있지 않습니다.”
  - 보조: “문서함에서 진행도면을 업로드하거나, 마킹 도구에서 게시하세요.”
  - CTA: [도면 업로드] → `/mobile/documents?...category=progress` / [마킹 도구 열기]
- 파일 404/권한 오류:
  - “파일을 찾을 수 없거나 접근 권한이 없습니다. 관리자에게 문의하세요.”

## 8) 보안/권한

- 파트너 권한 제한: `app/api/docs/drawings/route.ts`가 `partner_site_mappings`로 접근 허용 사이트 검증
- 현장정보 화면에서 동일 제약 준수(서버 API 결과 재사용)

## 9) 구현 체크리스트 (코드 레벨)

- [ ] SiteInfoPage: `handleOpenLatestProgressDrawing()` 추가 및 버튼 핸들러 교체
- [ ] Action Sheet UI(간단 모달) 또는 기존 토스트/확인 다이얼로그로 옵션 제공
- [ ] 문서함 DrawingsTab: URL 쿼리 파싱 로직 추가(`siteId`, `category`, `page`, `q`)
- [ ] 필요 시 안내 컴포넌트(빈 상태) 추가
- [ ] 문구 다국어/한국어 고정 여부 결정(현 단계 한국어 고정)
- [ ] 마킹툴: 선택된 도면 브리징(localStorage) 동작 검증

참고 파일 경로

- 현장정보: `modules/mobile/components/site/SiteInfoPage.tsx:3493`
- 도면문서함: `app/documents/hub/page.tsx` (DrawingsTab)
- 도면 목록 API: `app/api/docs/drawings/route.ts`
- 도면 업로드 API: `app/api/site-documents/upload/route.ts`
- 마킹 저장/게시: `app/api/docs/drawings/markups/save/route.ts`

## 10) 테스트 시나리오

1. 최신 진행도면 존재
   - 현장 A에 `progress_drawing` 2건(다른 생성일) → 버튼 클릭 시 가장 최근 1건으로 액션 시트 노출
   - 보기: 정상 열람(서명 URL 체크, 200)
   - 마킹: `/mobile/markup-tool`로 전환 후 선택 도면 로드됨
2. 최신 진행도면 없음
   - 안내 메시지+CTA 노출 → 문서함 이동 시 `siteId`, `category=progress` 프리셋 확인
   - 마킹도구 `mode=upload` 진입 후 게시 시 진행도면 자동 등록 확인
3. 파트너 권한 제한
   - 허용되지 않은 현장 siteId로 API 호출 시 403 반환 → UI 안내
4. 오프라인/불안정 네트워크
   - 문서함 SW 캐시 사용(가능 시) / 실패 시 에러 토스트

## 11) 마이그레이션/인덱싱 가이드

- FK/인덱스가 없다면 위 3) 항목 적용
- 대량 설치 환경에서 최신 조회 최적화: `(site_id, document_type, created_at DESC)` 커버링 인덱스 권장

## 12) 롤아웃 계획

- 1단계: 기능 플래그 없이 클라이언트 변경(서버 API는 기존 재사용) → QA
- 2단계: 문서함 DrawingsTab 쿼리 프리셋 릴리스 → 이동 경험 향상
- 3단계(선택): `markup_documents.source_site_document_id` 도입으로 추적성 강화

## 13) 구현 메모(간단 의사코드)

- SiteInfoPage 변경 예시

```
// modules/mobile/components/site/SiteInfoPage.tsx
async function handleOpenLatestProgressDrawing() {
  const res = await fetch(`/api/docs/drawings?siteId=${currentSite.id}&category=progress&limit=1&page=1`)
  const json = await res.json()
  const item = Array.isArray(json?.data) ? json.data[0] : null
  if (!item) {
    // 안내 + 이동 선택
    // openConfirm({ message: '진행도면이 없습니다...', actions: [...] })
    window.location.href = `/mobile/documents?tab=drawings&siteId=${currentSite.id}&category=progress`
    return
  }
  // 액션 선택: 보기 / 마킹 / 문서함
  const drawing = { id: item.id, name: item.title || '진행도면', url: item.url, type: 'progress' }
  localStorage.setItem('selected_drawing', JSON.stringify(drawing))
  window.location.href = '/mobile/markup-tool'
}
```

이 문서를 기준으로 구현을 진행한다. 세부 UI/문구는 QA 중 조정 가능.
