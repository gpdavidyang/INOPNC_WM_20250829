# DY1205 · 로그인/인증 관련 프로세스와 구현 개선 방향

## 1. 작성 목적 및 범위

- 로그인, 가입, 아이디·비밀번호 찾기 등 계정 수명주기에 대한 현황을 정리하고, 보안·운영상 취약 지점을 식별한다.
- 식별된 문제를 기반으로 기술적 개선 방향과 운영 지침(담당자 핸드오프/지원 프로세스 포함)을 정의한다.
- 문서 범위는 Next.js 애플리케이션 내부 구현과 Supabase Auth 연동에 한정하며, 외부 포털·서드파티 시스템은 포함하지 않는다.

## 2. 현황 분석

### 2.1 로그인 및 세션 동기화

1. 사용자는 `/auth/login`에서 이메일/비밀번호를 입력하면 브라우저에서 `supabase.auth.signInWithPassword`를 직접 호출한다(`app/auth/login/page.tsx:161`).
2. 인증 성공 시 클라이언트 세션 토큰을 `/api/auth/sync-session`으로 전달하여 서버 쿠키를 갱신한다(`app/auth/login/page.tsx:239`, `app/api/auth/sync-session/route.ts:27-84`).
3. 이어서 `/api/auth/me`를 호출해 Ultra Simple Auth 결과(역할별 UI 트랙, 제한 여부 등)를 조회하고(`app/auth/login/page.tsx:255`, `app/api/auth/me/route.ts:1-68`), 반환된 `uiTrack` 값으로 리다이렉트한다.
4. `rememberMe`가 활성화된 사용자는 브라우저 `localStorage`에 이메일을 저장하며, 이후 방문 시 `/api/auth/me` 응답을 확인해 자동 리디렉션한다(`app/auth/login/page.tsx:30-92`).

### 2.2 가입 및 승인

- 일반 사용자는 `/auth/signup-request`에서 이름/회사/휴대폰/이메일과 파트너사를 제출한다(`app/auth/signup-request/page.tsx:43-157`).
- 제출 시 서버는 별도의 인증 없이 Supabase 서비스 롤 키로 `signup_requests` 테이블에 데이터를 적재한다(`app/api/auth/signup-request/route.ts:6-69`).
- 관리자는 대시보드에서 요청을 확인하고, 서버 액션 `approveSignupRequest`를 호출해 실제 Supabase 사용자·프로필·배정을 생성한 뒤 임시 비밀번호를 발급한다(`app/auth/actions.ts:520-695`).
- 승인 시 생성된 임시 비밀번호는 `signup_requests.temporary_password`에 평문으로 저장되며, 관리자 UI에도 그대로 노출된다(`components/admin/legacy/signup-requests-client.tsx:364-379`).

### 2.3 아이디 찾기

- 로그인 화면에 모달 형태의 아이디 찾기 폼이 포함되어 있으며(`app/auth/login/page.tsx:270-305`), 이름/휴대폰/선택적 이메일을 입력받는다.
- API는 동일 요청 IP 기준 RateLimiter를 적용하며, 이름+휴대폰과 일치하는 프로필을 찾으면 마스킹된 이메일을 반환하고, 없으면 항상 “안내 메일 전송” 문구를 돌려준다(`app/api/auth/find-id/route.ts:12-55`).
- 별도의 2차 인증 없이 단순 지식 기반 정보만으로 이메일 힌트를 받을 수 있다.

### 2.4 비밀번호 찾기·변경 흐름

1. **공개 비밀번호 재설정 페이지** – `/auth/reset-password`는 “이메일 확인 없이 즉시 적용”된다는 문구와 함께 이메일/새 비밀번호(숫자 6자리 이상만 허용)를 입력받아 `/api/admin/password/direct-reset`을 호출한다(`app/auth/reset-password/reset-password-form.tsx:14-230`). API는 아무 인증 없이 Supabase Admin API로 해당 사용자의 비밀번호를 변경한다(`app/api/admin/password/direct-reset/route.ts:6-56`).
2. **Supabase 표준 복구** – 서버 액션 `requestPasswordReset`은 Supabase의 토큰 기반 리커버리 메일을 발송하도록 구현되어 있다(`app/auth/actions.ts:364-381`). 메일 링크는 `/auth/update-password`로 리디렉션되며, 쿼리 파라미터의 토큰을 사용해 `supabase.auth.updateUser`를 호출한다(`app/auth/update-password/update-password-form.tsx:22-95`).
3. **로그인 상태 비밀번호 변경** – 로그인된 사용자는 `updatePassword` 서버 액션을 통해 현재 비밀번호로 재인증한 뒤 새 비밀번호를 설정한다(`app/auth/actions.ts:283-312`).

### 2.5 라우팅 및 쿠키

- 미들웨어는 공개 라우트를 `/auth/login`, `/auth/reset-password`, `/auth/signup-request`로 한정하고 있으며, `/auth/update-password`는 인증 필요 경로로 분류되어 세션 쿠키가 없으면 접근이 차단된다(`middleware.ts:144-185`).
- 로그인/승인 과정에서 `user-role`과 `ui-track` 쿠키가 클라이언트 접근 가능한 형태로 저장되어 UI 라우팅 결정에 활용된다(`app/auth/actions.ts:97-138`, `middleware.ts:105-142`).

## 3. 문제점 및 취약지점

1. **익명 Direct Reset API 노출 (Critical)**
   - `/api/admin/password/direct-reset`은 어떤 인증·토큰 검증 없이 이메일 문자열과 숫자 6자리 이상만 입력하면 서비스 롤 키로 Supabase 비밀번호를 강제로 변경한다(`app/api/admin/password/direct-reset/route.ts:6-56`).
   - `/auth/reset-password` 페이지는 “이메일 확인 없이 즉시 적용”이라는 문구를 노출하고 동일 엔드포인트를 호출하므로, 누구나 타인의 계정을 탈취할 수 있다(`app/auth/reset-password/reset-password-form.tsx:14-230`).
   - Rate limit, 감사 로그, 관리자 권한 검증이 전혀 없어 완전한 계정 점유가 가능한 수준이다.

2. **표준 복구 흐름 단절 및 미사용**
   - Supabase가 제공하는 토큰 기반 메일 복구 액션은 존재하지만(`app/auth/actions.ts:364-381`), UI에서는 `/auth/reset-password`만 노출되고 `/auth/update-password`는 인증된 사용자만 접근 가능하도록 막혀 있다(`middleware.ts:144-185`).
   - 결과적으로 안전한 메일 기반 흐름은 사용자에게 제공되지 않으며, 모두가 취약한 Direct Reset을 사용하게 된다.

3. **비밀번호 정책 혼선 및 약한 기본값**
   - 공개 재설정 페이지는 숫자 6자리 이상의 단순 규칙만 강제한다(`app/auth/reset-password/reset-password-form.tsx:19-204`).
   - 반면 토큰 기반 페이지는 8자 이상 + 대/소문자 + 숫자를 요구한다(`app/auth/update-password/update-password-form.tsx:36-75`).
   - 가입 승인 시 생성되는 임시 비밀번호도 `Temp<랜덤6자리>!2024` 형식으로 길이가 짧고 예측 가능하다(`app/auth/actions.ts:470-478`). 정책 불일치로 인해 공격자는 가장 약한 경로를 선택할 수 있다.

4. **임시 비밀번호 평문 저장 및 노출**
   - 승인 시 발급된 임시 비밀번호는 DB와 관리자 UI에 평문으로 남으며(`app/auth/actions.ts:636-690`, `components/admin/legacy/signup-requests-client.tsx:364-379`), 누구든 UI 접근 권한만 있으면 복사할 수 있다.
   - 평문 저장은 개인정보보호법 및 ISMS 요구사항에 반하며, 관리자 계정 탈취 시 즉시 대규모 계정 침해로 이어질 수 있다.

5. **가입요청·아이디 찾기 API 보호 미흡**
   - 가입요청 API는 서비스 롤 키를 사용하지만 캡차·레이트리밋이 없어 자동 스팸 또는 파트너사 ID 추측 공격에 취약하다(`app/api/auth/signup-request/route.ts:6-69`).
   - 아이디 찾기는 이름+휴대폰만으로 이메일 힌트를 제공하며 2차 인증이 없다(`app/api/auth/find-id/route.ts:12-55`). 휴대폰 정보가 유출된 경우 타인의 계정 식별이 가능하다.

### 3.1 비기술 사용자용 해설

- **타인이 내 비밀번호를 바꿀 수 있는 상태**: 지금 “비밀번호 찾기” 버튼을 누르면, 누구든 내 이메일 주소만 알아도 새로운 숫자 비밀번호를 직접 입력해 계정을 바꿀 수 있다.
- **보안 메일을 건너뛰는 흐름**: 원래는 이메일로 온 링크를 클릭해야 본인임을 증명할 수 있는데, 현재 화면은 이 절차를 생략해 본인 확인이 되지 않는다.
- **임시 비밀번호가 그대로 노출**: 관리자 화면에서 발급된 임시 비밀번호를 그대로 읽을 수 있어, 내부자나 침입자가 이를 보면 쉽게 로그인할 수 있다.
- **아이디 찾기가 너무 단순**: 이름과 휴대폰 번호만 알아도 계정의 이메일 주소를 확인할 수 있어, 개인정보가 새어나갔을 때 다른 사람의 계정을 찾기 쉽다.
- **자동 가입 공격 가능성**: 가입 요청 화면에는 ‘사람이 입력한 것인지’를 판별하는 장치가 없어, 프로그램이 수십·수백 건을 자동으로 올릴 수 있다.

## 4. 개선 방향

1. **Direct Reset 폐지 및 보호된 운영 인터페이스 도입**
   - `/api/admin/password/direct-reset`를 즉시 비활성화하고, 동일 기능이 필요하다면 관리자 인증(세션 기반 RBAC + 감사 로그)과 강력한 RateLimiter를 갖춘 별도 백오피스로 한정한다.
   - `/auth/reset-password`는 토큰 발송 페이지로 변경하여 사용자가 이메일 주소만 입력하면 `requestPasswordReset`을 호출하도록 한다.

2. **미들웨어 공백 해소**
   - `/auth/update-password`를 공개 라우트에 포함해 Supabase가 발급하는 토큰 링크를 정상 작동시키고, 페이지 초기 진입 시 토큰 유효성 검증을 수행한다.
   - 토큰 기반 페이지에서만 실제 비밀번호 변경을 허용하고, Direct Reset을 통한 무단 변경을 차단한다.

3. **비밀번호 정책 단일화와 강화**
   - 모든 비밀번호 설정 UX에서 동일한 최소 길이·복잡도(예: 10자 이상 + 대/소문자 + 숫자 + 특수문자 중 2종 이상)를 enforced 하고, 클라이언트/서버 양쪽에서 검증한다.
   - 임시 비밀번호는 1회성 코드(예: 6~8자리 OTP)를 발급 후 이메일/문자로 전달하거나, 최초 로그인 시 즉시 변경을 강제하는 워크플로로 전환한다.

4. **임시 비밀번호 저장 방식 개선**
   - `signup_requests.temporary_password` 컬럼을 제거하거나 암호화/만료시간을 적용하고, 관리자 UI에는 “재전송” 기능만 제공한다.
   - 임시 비밀번호는 전송 후 즉시 폐기하고, 재발급 시 새로운 값을 생성하도록 한다.

5. **가입/아이디 찾기 악용 방지**
   - `/api/auth/signup-request`에 IP·이메일 기준 RateLimiter와 ReCAPTCHA/문자 OTP를 도입하고, 반복 제출을 차단한다.
   - 아이디 찾기 시 휴대폰 인증(일회성 코드) 또는 관리자 검증 단계를 추가하고, 마스킹된 이메일 노출 회수를 제한한다.

6. **감사·모니터링 강화**
   - 모든 인증·재설정 이벤트를 `log_auth_event`(또는 Supabase edge function)으로 전송해 추적한다.
   - 실패 시나리오(잘못된 비밀번호, 존재하지 않는 계정, rate limit 등)에 대한 경보 기준을 정의한다.

### 4.1 외부 보안 체크리스트 반영

- **비밀번호 재설정 링크 관리**: 이메일로 발송된 재설정 링크는 딥링크/앱링크를 적용해 모바일에서도 즉시 열리고, 유효시간을 10~30분 이내로 제한한다. 비용이 발생하는 SMS 대신 이메일+Google Authenticator(또는 타 무료 TOTP 앱) 기반 OTP를 기본 채널로 삼는다.
- **토큰 재발급/백오프**: 토큰 유효시간이 지나면 즉시 무효화하고, 동일 계정에서 반복 요청 시 3회 실패 후 30초, 5회 실패 후 5분과 같이 점증적 지연(backoff)을 준다.
- **아이디 마스킹 & 자동 인증**: 인증 메일에서는 `ab***@gmail.com` 형태로 마스킹된 아이디만 노출한다. iOS/Android의 자동 OTP 읽기 API를 활용해 사용자가 직접 코드를 입력하지 않아도 되도록 한다.
- **중복 세션 차단**: 인증 단계는 기존 세션과 분리해 처리하고, SMS가 발송되더라도 이전 인증 상태를 유지하지 않는다.
- **신규 가입/초기 비밀번호 정책**: 최초 비밀번호는 NIST 권고 수준(대·소문자+숫자+특수문자, 개인정보 포함 금지)으로 생성하고, Google Authenticator 기반 2차 인증 등록을 빠르게 유도한다. 최초 로그인 시 즉시 비밀번호 변경 플로우를 강제한다.
- **로그인 실패 알림**: “비밀번호 오류”와 “아이디 또는 비밀번호를 확인해 주세요”와 같이 중립적인 안내 메시지를 구분해 전달하고, 실패 횟수별로 지연을 두어 무차별 대입을 지연시킨다.
- **인프라 방어/비용 관리**: 악성 트래픽 차단은 Cloudflare WAF/Edge 등에서 우선 처리해 백엔드 비용을 최소화한다. OTP/알림은 이메일 기반을 우선 사용해 추가 비용을 줄인다.

## 5. 개발 우선순위 및 단계

| 단계               | 목표                  | 주요 작업                                                                                                                                                                                                                                                                          | 완료 기준                                                                                         |
| ------------------ | --------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------- |
| **Phase 1 (즉시)** | 치명적 취약점 제거    | - `/api/admin/password/direct-reset` 비활성화<br>- `/auth/reset-password`를 토큰 요청 화면으로 전환하고 `/auth/update-password`를 공개 라우트로 이동<br>- 이메일 기반 TOTP(Google Authenticator)·링크 만료/딥링크 적용<br>- 임시 비밀번호 평문 저장 제거 및 재설정 플로우 리팩터링 | Direct Reset 경로 제거, 사용자에게는 안전한 메일 기반 재설정만 노출, 임시 비밀번호 평문 저장 없음 |
| **Phase 2**        | 가입·아이디 찾기 보강 | - `/auth/signup-request` 입력 시 파트너사 선택 옵션화 + “미지정” 허용<br>- 관리자 승인 UI에서 조직/현장 강제 지정 + 추적 로그<br>- 아이디 찾기/가입 상태 API에 OTP·RateLimiter·마스킹 적용                                                                                         | 미지정 요청을 본사에서 완결할 수 있고, 정보 노출 없이 아이디/가입 상태 확인 가능                  |
| **Phase 3**        | 운영·모니터링 고도화  | - `log_auth_event` 기반 감사 로그 저장/관제 대시보드<br>- 실패 백오프, 알림 메시지, Cloudflare Edge 방어 룰 적용<br>- OTP 정책/관리 콘솔 및 자동화 테스트 추가                                                                                                                     | 관제 지표/알림이 운영 대시보드에 표준화되고, 백오프·OTP 정책이 배포됨                             |

> **권장 진행 방식**: Phase 1을 별도의 단일 배포로 우선 마무리한 뒤, Phase 2/3은 모듈별(가입, 아이디 찾기, 관제)로 브랜치를 나눠 순차 배포한다.

## 5. 운영 프로세스 제안

### 5.1 가입

1. 사용자는 `/auth/signup-request`에서 이름·회사·직책·연락처 등 기본 정보만 제출하며, **파트너사 입력은 선택** 항목으로 둔다.
2. 시스템은 중복 요청을 차단하고, 제출 즉시 확인 메일을 발송한다.
3. 관리자는 요청을 검토하면서 실제 소속 파트너사를 파악해 승인 시점에 조직/현장 배정을 직접 연결한다(사용자가 모르는 경우에도 본사에서 확정 가능).
4. 최초 로그인 시 강제 비밀번호 변경과 개인정보 확인 절차를 수행한다.

### 5.2 아이디 찾기

1. 고객센터 또는 자동화된 폼을 통해 이름/휴대폰/이메일 마지막 자릿수를 수집한다.
2. 필수적으로 휴대폰 OTP 또는 이메일 인증 링크를 통해 본인 여부를 검증한다.
3. 인증 완료 후 마스킹된 아이디와 로그인 링크를 전달하며, 일정 횟수 이상 실패 시 고객센터로 연결한다.

### 5.3 비밀번호 찾기/재설정

1. 사용자 입력: 이메일(+선택적 조직 정보) → `/api/auth/reset-password`에서 Supabase 메일 발송.
2. 메일 링크: `/auth/update-password?access_token=...` → 토큰 검증 후 새 비밀번호 정책 안내.
3. 새 비밀번호 입력 시 기준에 부합하는지 서버·클라이언트 모두 확인하고, 성공 시 모든 세션을 무효화하며 감사 로그를 남긴다.
4. 운영자는 Direct Reset이 필요한 경우 내부 관리자 콘솔에서 MFA를 통과한 뒤 임시 링크를 발급한다.

### 5.4 로그인 및 세션 관리

1. 로그인 실패 원인(승인 대기, 비활성, 비밀번호 오류 등)을 메시지와 함께 CTA로 안내하고, 실패 횟수 기반 rate limit을 적용한다.
2. 성공 시 `ui-track` 쿠키는 서버에서만 서명된 형태로 발급하고, 클라이언트에서 임의 변경할 수 없도록 한다.
3. 로그아웃·세션 만료 시 모든 Supabase 토큰과 UI 쿠키를 즉시 폐기하고, 감사 로그를 기록한다.

### 5.5 모니터링 체크리스트

- 일일: 비밀번호 재설정 시도 수, 실패율, rate limit 트리거 현황.
- 주간: 가입요청 승인/거절 건수, 임시 비밀번호 사용률, 관리자 Direct Reset 사용 여부.
- 실시간: 인증 실패 급증, 동일 IP 다중 계정 시도, 아이디 찾기 API 남용 경보.

## 6. 사용자 관점 변화 요약

| 시나리오                 | 현재 사용자 경험                                                                                                                             | 개선 후 사용자 경험                                                                                                                                                                                       |
| ------------------------ | -------------------------------------------------------------------------------------------------------------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 비밀번호 분실            | 공개 `/auth/reset-password` 화면에서 이메일·새 비밀번호(숫자 6자리)를 입력하면 즉시 변경됨. 본인 확인이나 메일 인증이 없어 타인이 탈취 가능. | `/auth/reset-password`는 “재설정 메일 요청” 페이지로 전환되어 이메일만 수집하고 인증 메일을 발송. 사용자는 메일 링크(토큰)로 `/auth/update-password`에 접근해 강화된 정책(복잡도)으로 새 비밀번호를 등록. |
| 이메일/아이디 기억 안 남 | 로그인 화면 모달에서 이름·휴대폰만 입력하면 마스킹된 이메일을 즉시 확인. 휴대폰 정보만 있으면 타인 계정 식별 가능.                           | 휴대폰 OTP 또는 이메일 인증을 통과해야 결과를 제공. 횟수 제한·감사 로그가 적용되어 타인 계정 조회가 어렵고, 본인은 동일 화면에서 인증 후 안내를 받음.                                                     |
| 신규 가입                | 누구나 승인 요청을 제출할 수 있어 스팸/중복이 잦고, 승인 후 임시 비밀번호를 관리자나 사용자에게 평문으로 전달.                               | ReCAPTCHA/OTP로 자동 제출을 막고, 승인 시 1회용 로그인 링크를 이메일/SMS로 전달하여 사용자만 접근 가능. 최초 로그인 즉시 비밀번호 변경 화면으로 이동.                                                     |
| 로그인 실패              | 실패 원인에 따라 CTA가 안내되긴 하나, 비밀번호 틀림과 계정 부재 구분이 명확하지 않고, 세션/쿠키 조작 위험이 존재.                            | 실패 횟수 기반 RateLimiter와 명확한 메시지를 제공하며, 서버 서명된 `ui-track` 쿠키로만 라우팅이 결정되어 세션 하이재킹 위험이 낮아짐.                                                                     |
| 운영자 지원              | 관리자 UI에서 임시 비밀번호를 평문으로 확인·복사해 사용자에게 전달. 저장/전달 과정에서 유출 가능.                                            | 운영자는 MFA가 적용된 내부 콘솔에서 일회성 링크나 OTP만 재발급하고, 평문 비밀번호를 직접 보지 않음. 모든 발급 내역은 감사 로그에 남음.                                                                    |

### 6.1 설명

- **신뢰성 향상**: 사용자는 항상 이메일(또는 휴대폰)로 본인 인증을 거친 뒤에만 비밀번호를 바꾸거나 아이디를 확인하게 되어, 본인이 아닌 누군가가 임의로 계정을 바꾸는 일이 차단된다.
- **경험 일관성**: 모든 경로에서 동일한 비밀번호 정책이 적용되고, 표준화된 재설정 화면으로 안내되어 “어디서 무엇을 해야 하는지” 혼란이 줄어든다.
- **보안 안내 강화**: 로그인 실패, 승인 대기, 비밀번호 재설정 등 상황에서 구체적 메시지와 다음 단계(CTA)가 제공되므로, 사용자는 고객센터에 문의하기 전에 스스로 문제를 해결할 수 있다.
- **운영 투명성**: 운영자가 비밀번호를 직접 전달하지 않고 시스템이 일회성 링크를 발송하므로, 사용자도 “누가 내 계정을 만졌는지” 명확히 알 수 있고 사고 원인 분석이 가능하다.

---

위 개선안을 순차적으로 적용해 Direct Reset 취약점을 제거하고, 표준화된 비밀번호 복구 흐름과 운영 통제 체계를 확립해야 한다.
