# DY1012 · 모바일 도면 마킹 업무흐름 가이드

본 문서는 모바일 앱의 홈 화면에서 소속/현장 선택 후 도면 마킹(표시)까지의 주요 업무흐름을 정의합니다. 공도면(현장에 등록된 도면)이 있는 경우와 없는 경우로 분기되는 UI/기능 차이를 중심으로 작성되었습니다.

## 1) 용어 정의
- 소속: 사용자가 속한 회사/파트너 조직 단위
- 현장: 공사 프로젝트 단위(현장 식별자 기반)
- 공도면: 현장에 등록되어 사용자에게 공개된 기준 도면(버전/구역/층 포함)
- 마킹: 도면 위에 핀/선/영역/텍스트 등으로 작업 정보를 표시하는 행위
- 작업 항목: 마킹으로 생성되는 관리 단위(공종/유형/담당/기한 등 메타데이터 포함)
- 상태: 작업 항목의 진행 상태(draft, submitted, in_review, approved, rejected)

## 2) 전제 조건
- Supabase Auth 로그인 완료 및 권한 부여
- 모바일 홈 화면에서 `소속`과 `현장` 선택 가능
- 네트워크 연결이 불안정한 상황을 고려하여 오프라인 임시저장/동기화 UI 제공

## 3) 상위 플로우(개요)
```
모바일 홈
  └─ 소속 선택
      └─ 현장 선택
          └─ 공도면 존재 여부 확인
              ├─ [있음] 도면 목록/뷰어 → 마킹 → 임시저장/제출 → 검토/확정
              └─ [없음] 도면 없음 안내 → (도면 요청 / 사진 기반 마킹 / 도면 업로드 권한자 액션)
```

## 4) 분기 A: 공도면이 있는 경우
### A-1. 도면 접근
- 홈 상단의 `소속/현장 선택기`에서 선택 완료 시, 하단 카드/탭에 현장별 도면 섹션 노출
- `도면 목록`에는 다음 필터/정렬 제공(권장):
  - 버전/리비전, 층/구역, 도면 분류(건축/전기/설비 등), 최근 수정순
- 도면 썸네일 진입 또는 `열기` 버튼으로 `도면 뷰어` 진입

### A-2. 도면 뷰어 핵심 기능
- 확대/축소, 이동, 레이어 토글(참조선/치수 등)
- 마킹 도구:
  - 핀(점), 폴리라인(선), 폴리곤(영역), 텍스트, (옵션)치수
- 마킹 생성 시 속성 패널 입력(권장 필드):
  - 공종, 작업 유형(예: 시공/보수/확인), 우선순위, 담당자, 마감일, 설명
  - 첨부: 사진/동영상/파일
- 마킹은 도면 좌표 및 페이지/뷰포트에 고정되어 재방문 시 동일 위치로 복원

### A-3. 저장과 협업
- 임시저장: 로컬/오프라인 큐에 보관, 네트워크 복구 시 자동 동기화
- 제출: 검토 요청 상태로 전환(예: `submitted`)
- 코멘트/상태 변경: 검토자(반장/관리자)가 코멘트 추가 및 `approved/rejected` 처리
- 히스토리: 상태 변경 이력과 첨부 변경 이력 확인 가능

### A-4. 예외/에러 처리
- 권한 부족: 도면 열람 가능하나 마킹 생성 제한(읽기 전용 배지 표시)
- 지원하지 않는 파일: 벡터화/렌더 실패 시 이미지 렌더로 폴백
- 대용량 도면: 타일링/페이지 로딩 지연 표시 및 진행 상태 토스트

## 5) 분기 B: 공도면이 없는 경우
### B-1. 안내 및 대체 흐름 제안
- `도면이 없습니다` 상태 화면 노출 및 액션 제공:
  1) 도면 업로드 요청 만들기(요청 양식 제출 → 관리자/파트너에 알림)
  2) 현장 사진 기반 마킹(사진을 캔버스로 사용하여 핀/영역 표기)
  3) (권한자 전용) 도면 직접 업로드/등록

### B-2. 사진 기반 마킹
- 사진 촬영 또는 갤러리 선택 → 뷰어 유사 UI에서 마킹 도구 사용
- 생성된 작업 항목은 `도면 참조 없음` 상태로 저장되며, 이후 도면이 등록되면 매핑 가능(옵션)

### B-3. 업로드 요청/처리
- 일반 사용자: 업로드 요청 생성 → 요청 상태 추적(대기/처리 중/완료)
- 권한자(관리자/파트너): 도면 업로드 화면에서 파일 등록, 버전/층/구역 메타데이터 입력 → 공개 범위 설정 → 게시

## 6) 화면 구성 요약
- 홈 화면: 소속/현장 선택기, 현장 단축 액션(도면/작업/보고)
- 도면 목록: 필터/정렬, 썸네일, 최근 업데이트 표기, 오프라인 배지
- 도면 뷰어: 캔버스, 마킹 도구 모음, 속성 패널, 첨부, 히스토리
- 도면 없음 화면: 요청 생성, 사진 기반 마킹, 권한자 업로드 진입

## 7) 권한과 라우팅(요약)
- 역할 예: 작업자(Worker), 반장/현장소장(Supervisor), 관리자/Admin, 파트너/Partner
- UI Track System에 따라 버튼/액션 가시성 제어:
  - Worker: 마킹 생성/제출 가능, 도면 업로드는 불가
  - Supervisor/Admin: 검토/승인, 도면 업로드 가능(역할 정책에 따름)
  - Partner: 파트너 소속 현장에 한해 관리 기능 접근

## 8) 데이터와 동기화(개념)
- 핵심 엔티티: Organization(소속), Site(현장), Drawing(도면), Page, Markup(마킹), Attachment(첨부)
- 상태: Markup.status = draft → submitted → in_review → approved/rejected
- 오프라인: 로컬 큐(queued) → 동기화(syncing) → 완료(synced) / 실패(failed)

## 9) 시나리오 예시
### 시나리오 A: 도면이 있는 현장
1. 홈 → 소속 A / 현장 X 선택
2. 도면 목록에서 `B1 평면도 v2` 선택 → 뷰어 진입
3. 폴리곤 마킹 생성, 공종=전기, 유형=점검, 담당=홍길동, 기한=10/15, 사진 2장 첨부
4. 임시저장 후 지하에서 오프라인 작업 지속 → 신호 복구 시 자동 동기화
5. 제출 → 반장이 코멘트 후 승인

### 시나리오 B: 도면이 없는 현장
1. 홈 → 소속 B / 현장 Y 선택 → `도면 없음` 화면 확인
2. `업로드 요청` 생성 또는 `사진 기반 마킹` 선택
3. 사진 기반 마킹으로 작업 항목 생성 후 팀과 공유
4. 관리자 도면 업로드 완료 후, 관련 작업과 매핑(옵션)

## 10) QA 체크리스트(권장)
- 소속/현장 변경 시 도면/권한 캐시가 올바르게 갱신되는가?
- 공도면 유/무에 따라 화면 분기가 정확히 전환되는가?
- 오프라인 임시저장 후 온라인 전환 시 충돌 없이 동기화되는가?
- 권한에 따라 버튼(마킹 생성/업로드/승인)이 올바르게 노출/비활성화되는가?
- 대용량 도면에서도 뷰어 성능이 기준을 충족하는가?
- 제출/승인 이력과 첨부 파일 미리보기가 정상 동작하는가?

## 11) 향후 확장 포인트
- 표준 마킹 템플릿(공종별 기본 필드/색상) 지원
- 자동층/구역 감지(공간 좌표 기반 레이어링)
- 마킹 일괄 내보내기(PDF/Excel 보고서)
- 도면 비교(버전 간 차이 검출) 및 변경 이력 뷰

---
문서 버전: DY1012 / 최초 작성 2025-10-12
