# DY1120 · 커뮤니케이션 개선안

- **작성일**: 2025-11-20
- **작성자**: Admin Platform 팀
- **범위**: `/dashboard/admin/communication` 페이지와 연계된 API (`/api/announcements`, `/api/admin/notifications/**`), Supabase `announcements`, `notification_logs`, `notification_engagement`, `partner_site_mappings` 계열

---

## 1. 배경 및 목표

본사 관리자 커뮤니케이션 화면은 `공지 작성 → 공지 목록 → 전달 로그`의 세 단계를 제공하지만,

1. 데이터 원천이 분리되어 있고, 2) 탭 간 맥락 이동이 없으며, 3) 현장관리자/작업자/파트너 계정과의 연동이 느슨하다.  
   이 문서는 **재사용 가능한 공지 파이프라인**과 **역할 기반 교차 조회**를 확보하기 위한 개선 방향과 구현 계획을 정의한다.

**핵심 목표**

1. **데이터 단일화**: 공지/알림/전달 로그를 단일 뷰와 캐싱 계층으로 통합하여 API 비용을 절감한다.
2. **운영 UX 개선**: 관리자에게 템플릿, 저장된 필터, 전달 상태 트래킹 등 반복 업무를 줄여 주는 도구를 제공한다.
3. **역할 연동 강화**: 현장관리자, 작업자, 파트너 계정과의 매핑을 명시해 “어떤 대상에게 어떤 공지가 갔는가”를 추적 가능하게 만든다.

---

## 2. 현 상태 요약

| 구분 | 기능                                 | 데이터 소스                                                         | 문제점                                                                            |
| ---- | ------------------------------------ | ------------------------------------------------------------------- | --------------------------------------------------------------------------------- |
| 탭   | 공지 작성 (`AnnouncementCreateForm`) | `announcements`, `/api/mobile/sites/list`                           | 대상 미선택 시 전체 발송 처리 로직이 명확히 시각화되지 않음.                      |
| 탭   | 공지 목록 (`AnnounceTable`)          | `/api/announcements` (REST)                                         | 검색/필터가 프론트 단순 GET 재조회에 한정되고, 대상 역할/현장 조건 미리보기 부재. |
| 탭   | 전달 로그 (`NotificationsTable`)     | Supabase 직접 질의 (`notification_logs`, `notification_engagement`) | 로그, 즐겨찾기 정보, 상태 변경을 각각 별도 호출로 처리 → 응답 지연 및 API 중복.   |
| 권한 | 현장관리자/작업자/파트너와의 연동    | `site_assignments`, `partner_site_mappings`                         | 전달 로그에 대상 소속/현장 히스토리가 없어, 파트너 민원 대응이 어려움.            |

**운영 상 제약**

- 공지와 실제 전달된 알림 사이에 추적 가능한 ID 체인이 없어서, 특정 공지가 어떤 사용자에게 언제 도달했는지 역추적하려면 여러 테이블을 수동 조인해야 한다.
- `notification_logs` 검색 범위가 제한적이고 페이징/필터/즐겨찾기 상태가 페르시스트되지 않아, 매번 동일한 필터를 반복 입력해야 한다.
- API 구조가 서로 다르기 때문에(REST + Supabase directly) 캐시/권한 관리를 통합하기 어렵다.

---

## 3. 개선 방향

1. **데이터 계층 통합**
   - `announcements` ↔ `notification_logs`를 연결하는 `announcement_dispatches`(뷰 혹은 테이블)를 만들고, 단일 API(`/api/admin/communication/overview`)로 공지·로그·즐겨찾기 정보를 제공한다.
   - `notification_logs` 조회 시 PostgREST RPC 또는 뷰를 사용해 검색/정렬/카운트를 한 번에 해결한다.  
     → 요청당 round-trip 을 2회 이상 줄이고, 프론트에서 동일 로직을 재구현하지 않는다.

2. **운영 UX 강화**
   - 공지 작성 폼에 “대상 미선택 시 전체” 안내를 명시적 라벨링 + 미리보기 배지로 표기.
   - 템플릿/최근 사용 대상 세트 저장, 다국어 안내문 예시, 실시간 유효성 검증.
   - 공지 목록에 **저장된 필터**/**역할·현장 배지**/**활성 타임라인** 표시.
   - 전달 로그는 **Saved Views**, **무한 스크롤**, **상태/즐겨찾기 탭** 제공으로 운영자의 탐색 비용을 최소화한다.

3. **역할 연동 및 감사 추적**
   - 로그 데이터에 `target_site_id`, `target_partner_company_id`, `target_role`을 저장(또는 뷰에서 join)해, 현장관리자/작업자/파트너 흐름을 한 곳에서 확인.
   - `partner_site_mappings`와 매칭하여 “이 알림이 파트너사와 합의된 현장 범위 안에 있는가”를 자동 검증하는 백엔드 훅을 추가.
   - 로그에 `dispatch_batch_id`를 부여하여 공지 한 건과 관련된 모든 개별 전달을 묶어서 검색할 수 있게 한다.

---

## 4. 상세 개선 항목

### 4.1 데이터/백엔드

- [ ] Supabase 뷰 `communication_overview_v`
  ```sql
  SELECT a.id as announcement_id,
         a.title,
         a.priority,
         a.target_roles,
         a.site_filters,
         n.id as log_id,
         n.sent_at,
         n.status,
         n.user_id,
         p.role as profile_role,
         p.partner_company_id,
         sa.site_id,
         ps.partner_company_id as mapped_partner_company_id,
         ne.engagement_type,
         ne.engaged_at
  FROM announcements a
  LEFT JOIN announcement_dispatches d ON d.announcement_id = a.id
  LEFT JOIN notification_logs n ON n.dispatch_id = d.id
  LEFT JOIN profiles p ON p.id = n.user_id
  LEFT JOIN site_assignments sa ON sa.user_id = p.id AND sa.is_active = true
  LEFT JOIN partner_site_mappings ps ON ps.site_id = sa.site_id AND ps.is_active = true
  LEFT JOIN LATERAL (
    SELECT engagement_type, engaged_at
    FROM notification_engagement
    WHERE notification_id = n.id
      AND engagement_type IN ('admin_starred','admin_unstarred')
    ORDER BY engaged_at DESC
    LIMIT 1
  ) ne ON true;
  ```
- [ ] `/api/admin/communication/overview` Route Handler: 검색/페이징/즐겨찾기 업데이트/상태 변경을 단일 API로 처리.
- [ ] `announcement_dispatches` 생성: 공지 발행 시 대상 사용자 리스트와 디스패치 메타를 저장해 추적성을 확보.
- [ ] `notification_logs`에 `target_role`, `target_partner_company_id`, `target_site_id` 컬럼 추가 또는 계산 컬럼 확보.

### 4.2 프론트엔드/UX

- [ ] **작성 탭**: 대상 미선택 시 “전사 공지” 배지, 대상 프리뷰 모달, 임시 저장/템플릿 기능, 예상 발송 인원 계산(뷰 기반).
- [ ] **공지 목록 탭**: 역할/현장/활성 상태별 칩 필터, “해당 공지의 전달 현황”을 보여주는 Drawer(Dispatch 리스트).
- [ ] **전달 로그 탭**:
  - 무한 스크롤 + 컬럼 커스터마이즈 (대상 역할, 소속, 현장, 디스패치 ID).
  - Saved View (e.g., “현장관리자 알림만 표시”).
  - 즐겨찾기 상태는 Optimistic Update로 즉시 반영하며 API 응답으로 동기화.
  - 상태 변경 버튼을 토글형으로 단순화하고, 작업 이력을 `notification_engagement`에 추가 저장.

### 4.3 권한/감사

- [ ] `requireAdminProfile` 외에도, `site_manager`가 자신의 현장 공지 로그를 조회할 수 있는 제한적 API 제공(Phase 2).
- [ ] 파트너 사용자 요청 시 `partner_site_mappings` 기반으로 허용된 현장만 조회 가능한 파생 API 추가.
- [ ] 모든 상태 변경/즐겨찾기/재전송 이벤트를 `notification_engagement`에 기록하여 감사를 위한 타임라인 제공.

---

## 5. 구현 계획 (Phase별)

| Phase                     | 기간  | 주요 산출물                                                                            | 책임                      |
| ------------------------- | ----- | -------------------------------------------------------------------------------------- | ------------------------- |
| **Phase 0** – 분석 준비   | 1주   | 스키마 설계 확정, API 계약서, UI 와이어프레임                                          | Admin Platform PO, Design |
| **Phase 1** – 데이터 계층 | 1주   | `communication_overview_v`, `announcement_dispatches`, 신규 API, 마이그레이션 스크립트 | Backend                   |
| **Phase 2** – UX/기능     | 1.5주 | 작성/목록/로그 탭 UI 개편, 템플릿 & Saved Filter                                       | Frontend                  |
| **Phase 3** – 역할 연동   | 1주   | site_manager/partner 조회 API, 감사 로그 대시보드, RLS 점검                            | Backend + QA              |
| **Phase 4** – QA & 배포   | 0.5주 | Playwright 시나리오, Supabase RLS 테스트, 운영 가이드                                  | QA                        |

### Phase 4 세부 플랜

1. **API 회귀 테스트**
   - `npm run test -- NotificationsOverview` (신규 Jest suite)로 `/api/admin/communication/overview`, `/api/admin/communication/engagement`, `/api/communication/logs` 3가지 모드를 mocking 없이 검증.
   - `scripts/audit-required-docs.ts` 패턴을 참고해 `scripts/audit-communication-logs.ts` 초안 작성: dispatch/로그 orphan 유무 검사.

2. **E2E/Playwright**
   - `playwright.config.ts`에 `communication.spec.ts` 추가:
     1. Admin 계정으로 공지 생성 → 로그 탭에서 필터·감사 카드 확인.
     2. Site Manager 계정으로 `/mobile/communication/logs` 접근 → 제한 범위 내 알림만 노출되는지 검증.
     3. 즐겨찾기/상태 변경 버튼 클릭 후 감사 로그 타임라인에서 이벤트가 갱신되는지 polling.

3. **RLS & 권한 점검**
   - Supabase SQL 콘솔에서 다음 체크 수행:
     ```sql
     -- 파트너 계정이 타사 현장 로그 조회 불가
     select * from api.communication_logs('partner-user-uuid', 'other-site-uuid');
     -- Admin은 모든 로그 fetch 가능
     select * from communication_overview_v limit 10;
     ```
   - `notification_engagement` 정책이 admin insert 를 허용하도록 service-role만 사용했는지 audit.

4. **운영 가이드**
   - `docs/ADMIN_RESTORATION_HANDOFF.md`에:
     - 새 API 목록 및 호출 예시.
     - 감사 로그 카드 사용법(필터/정렬 방법).
     - 모바일 커뮤니케이션 로그 접근 권한 표.
   - FAQ 초안: “전달 로그가 비어 있어요”, “파트너가 다른 현장을 본다 주장” 등.

5. **릴리즈 체크리스트 보강**
   - Slack #ops 에 배포 공지 템플릿 공유.
   - `/api/admin/communication/overview`와 `/api/communication/logs`에 대한 Grafana 알람 임계치 정의 (p95 > 500ms, 5xx > 2%).

**병행 과제**

- Supabase 마이그레이션: 컬럼/뷰 추가 → `supabase/migrations/202511200900_comm_plan.sql`
- 테스트: `__tests__/admin/communication-overview.test.ts` (API), `e2e/communication.spec.ts` (UI)
- 문서화: 본 문서 + 운영 매뉴얼 업데이트 (`docs/ADMIN_RESTORATION_HANDOFF.md` 보강)

---

## 6. 검증 및 모니터링

- **테스트 시나리오**
  1. 공지 작성 → dispatch 생성 → 5개 대상 → 로그/즐겨찾기/상태 변경 흐름 검증.
  2. Saved Filter (역할=현장관리자) 적용 후 새로 고침 시 상태 유지.
  3. 파트너 계정이 허용되지 않은 현장을 조회할 경우 403 반환.
  4. 로그 5만 건 이상일 때 무한 스크롤 성능(초당 2회 요청 이내).

- **모니터링 포인트**
  - `/api/admin/communication/overview` 응답 시간 300ms 이하.
  - `announcement_dispatches`와 `notification_logs` 사이의 orphan 건수 주기적 체크.
  - 즐겨찾기/상태 변경 실패율 < 0.5%.

- **릴리즈 체크리스트**
  - [ ] Supabase 마이그레이션 적용 및 백업 완료.
  - [ ] Admin/QA 계정으로 Smoke Test 수행.
  - [ ] 운영자 가이드(FAQ, Saved Filter 설명) 배포.
  - [ ] 모니터링 대시보드(Alert) 설정.

---

## 7. 기대 효과

- 공지 발행부터 전달 로그까지 **엔드-투-엔드 추적 가능** → 파트너 문의 대응 시간이 평균 60% 단축.
- Saved Filter/템플릿 도입으로 **반복 공지 작성 시간 40% 절약**.
- 단일 API/뷰 도입으로 **알림 로그 조회 쿼리 비용 35% 절감**, 페이지 응답도 2x 개선 예상.
- 역할 기반 로그 공유(현장관리자/파트너)로 **현장 단위 커뮤니케이션 자율성**을 확보하고, 본사 escalations 감소.

---

> 본 문서는 2025-11 Sprint 기준 계획이며, Phase 3 이후 범위(파트너 전용 뷰 확대 등)는 사용자 피드백 분석 후 재조정한다.
