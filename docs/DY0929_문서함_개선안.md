# 문서함 개선안 (v3)

본 문서는 문서함 화면을 2행 2열 탭 구조로 재편하고, 각 탭의 기능/권한/데이터/API/PWA 전략을 포함한 단계별 구현안을 정의합니다. 참고 UI는 `dy_memo/new_image_html_v3.0/inopnc-page/public/raw/doc.html`의 카드/선택/버튼 인터랙션을 따릅니다.

## 목표

- 월·현장·역할에 관계없이 필요한 문서/도면/사진을 한 화면에서 빠르게 찾고 공유
- “필수제출서류” 제출 현황을 본사/시스템관리자가 일목요연하게 추적·관리
- PWA 기반 오프라인 업로드/공유/미리보기 경험 제공

## 탭 구조(2행 2열)

- 1행
  - 내문서함 (My Docs)
  - 회사서류함 (Company Docs)
- 2행
  - 도면문서함 (Drawings)
  - 사진함 (Photos)

---

## 공통 UI 규칙

- 카드 리스트: 참조 HTML의 `doc-selection-card` 스타일 적용(Hover 최소화, 명확한 선택 상태)
- 우측 원형/사각 선택 토글(멀티 선택) → 하단 푸터의 [저장하기], [공유하기] 활성화
- 각 항목: [업로드]/[완료]/[보기] 버튼의 상태 전이 명확화
- 검색/정렬: 탭별로 키워드 검색, 정렬(최신/이름/현장/상태)
- 파일 미리보기: 브라우저 네이티브(새 탭 또는 `<iframe>`/`<object>`), 실패 시 다운로드 유도
- 공유: Web Share API 레벨2 가능 시 파일 공유, 불가 시 링크 공유 + 다운로드

---

## 권한 정책(요약)

- worker/site_manager: 내문서함(본인), 회사서류함(모두), 도면문서함(모든 현장 조회/저장/공유, 단 partner 제외), 사진함(모든 현장, 단 partner 제외)
- partner: 회사서류함(모두), 도면문서함/사진함(자기 소속 현장만), 내문서함(본인)
- admin/system_admin: 전부 접근 + 관리(승인/반려/삭제/강제 마감 등)

RLS 초안(테이블별로 상세 제시)

- user_documents: user_id = auth.uid() OR admin
- company_documents: 모든 로그인 사용자는 SELECT, 쓰기는 admin만
- site_drawings / site_photos: 아래 API 권한과 동일(파트너는 소속 현장 제한)
- required_document_types: 읽기 모두, 쓰기 admin

---

## 데이터 모델(제안)

### 공통

- storage buckets
  - `required-docs/{user_id}/{doc_type}/{yyyy}/{mm}/{uuid}.{ext}`
  - `company-docs/{slug}/{version}/{filename}`
  - `drawings/{site_id}/{category:plan|progress}/{version}/{filename}`
  - `photos/{site_id}/{category:before|after|other}/{yyyy}/{mm}/{uuid}.{ext}`

### 필수 제출 서류(내문서함 연동)

- required_document_types
  - id, key(internal: medical_check, safety_training, car_insurance, car_registration, bankbook, id_card, senior_doc, etc),
  - name(표시명), required(bool), allowed_mime, max_size_mb, expires_in_days(optional)
- user_documents
  - id, user_id, type_key, storage_path, file_name, mime, size, uploaded_at, verified_status(pending|approved|rejected), verified_by, verified_at, reason(optional), version

### 회사서류함

- company_documents
  - id, slug(biz_reg, bankbook, npc1000_form, completion_form), title, description, storage_path, version, published_at, is_public

### 도면문서함

- site_drawings
  - id, site_id, category(plan|progress), title, description, storage_path, version, uploaded_by, uploaded_at
- drawing_markups (도면마킹도구 연계)
  - id, drawing_id, markup_json, created_by, created_at, published(bool)

### 사진함

- site_photos
  - id, site_id, category(before|after|other), taken_at(date), storage_path, file_name, mime, size, uploaded_by, uploaded_at, tags jsonb[]

---

## API 설계(요약)

공통 규칙

- 목록 응답: pagination(cursor or offset/limit), 정렬(최신순 기본)
- 업로드: 클라이언트에서 pre-signed URL 발급 → 직업로드 → 완료 콜백 API로 메타 저장
- 미리보기: signed URL 발급

### 내문서함

- GET `/api/docs/required/types` → 필수 제출 서류 8종 목록
- GET `/api/docs/required/status?userId=me` → 본인 제출 현황(각 type_key의 최신 상태)
- POST `/api/docs/required/upload:init` { type_key, mime, size } → { uploadUrl, storage_path }
- POST `/api/docs/required/upload:complete` { type_key, storage_path, file_name, mime, size } → user_documents upsert
- GET `/api/docs/required/preview?type_key=...&userId=...` → signed URL

관리자

- GET `/api/admin/required/status?type_key=&site_id=&month=&q=` → 제출/미제출/반려 현황(필터)
- POST `/api/admin/required/verify` { user_document_id, status: approved|rejected, reason? }
- GET `/api/admin/required/export.csv`

### 회사서류함

- GET `/api/docs/company/list`
- GET `/api/docs/company/preview?id=...` → signed URL
- POST `/api/admin/docs/company/publish` { slug, title, file }

### 도면문서함

- GET `/api/docs/drawings?siteId=&category=&q=&page=`
- GET `/api/docs/drawings/preview?id=...` → signed URL
- POST `/api/docs/drawings/upload:init` { site_id, category, mime, size }
- POST `/api/docs/drawings/upload:complete` { meta }
- POST `/api/docs/drawings/markups/save` { drawing_id, markup_json, published }

제약(파트너)

- API 내부에서 auth.user → user_sites를 조인해 허용 site_id만 응답

### 사진함

- GET `/api/docs/photos?siteId=&category=&from=&to=&q=&page=`
- GET `/api/docs/photos/preview?id=...` → signed URL
- POST `/api/docs/photos/upload:init` { site_id, category, mime, size, taken_at? }
- POST `/api/docs/photos/upload:complete` { meta }

---

## 탭별 상세 UX

### 1) 내문서함

- 본사의 “필수제출서류” 8종 카드가 고정 리스트로 노출
- 각 카드
  - 업로드 버튼: 업로드 완료 시 버튼 라벨이 ‘완료’로 변환(참조 HTML의 `upload-btn.uploaded` 스타일 적용)
  - 보기: 업로드된 파일 미리보기(새 탭 or 모달)
  - 우측 멀티 선택 토글 → 하단 [저장하기]는 로컬 다운로드, [공유하기]는 Web Share(API 가능 시 파일/링크 공유)
- PWA 제안
  - 업로드: Background Sync + IndexedDB 대기열(오프라인에서도 첨부 등록 → 온라인 복구 시 자동 업로드)
  - 저장하기: `showSaveFilePicker` 지원 시 네이티브 저장, 미지원 브라우저는 a[download] 폴백
  - 공유하기: `navigator.share({ files })` 지원 시 파일 공유, 미지원은 signed URL 공유(만료 시간 짧게)
- 관리자 화면(필수제출서류함)
  - 사용자 목록 × 8종 그리드(필터: 제출/미제출/반려, 현장/역할/기간)
  - 상태 변경(승인/반려/메모), 증빙 미리보기, CSV/Excel 내보내기, 알림 발송(미제출 대상)

검증 규칙(예시)

- 허용 확장자/최대 크기/유효기간(예: 배치전 검진 1년) 경고 라벨 표시
- 중복 업로드 시 버전 증가(최근본이 기본 ‘보기’ 대상)

### 2) 회사서류함

- 전체 공개(로그인 사용자)에 회사 공통 서류(사업자등록증, 통장사본, NPC-1000 양식, 작업완료확인서 양식) 4종 노출
- [보기] 미리보기 + [다운로드], 멀티 선택 후 하단 [저장/공유]
- 관리자: 버전 발행(게시일/버전 표기), 이전버전 보관

### 3) 도면문서함

- 필터: 현장 선택, 카테고리(plan/progress), 키워드, 업로더
- 목록: 사이트/카테고리/버전/업로더/업로드일 표기, [보기]/[다운로드]/[공유]
- 도면마킹도구 연계
  - 도구의 [저장] → `/api/docs/drawings/markups/save` 호출, `drawing_id`와 함께 저장
  - ‘진행도면(progress)’는 마킹 게시(published=true) 시 자동으로 최신 도면 목록 상단에 노출
- 업로드: 로컬 파일 업로드(버전 규칙 적용)
- 권한: partner는 본인 소속 현장만, 그 외 역할은 전 현장 조회/다운로드/공유(정책 변경 가능)

### 4) 사진함

- 필터: 현장/카테고리(before/after/other)/기간/태그/업로더
- 목록: 썸네일 그리드 + 확대 미리보기(슬라이드), 멀티 선택 후 저장/공유
- 업로드: 최대 30장 일괄 업로드, 카테고리 선택(기본 other), 촬영일 옵션 입력
- PWA 업로드 큐 + 오프라인 지원

---

## 보안/RLS 초안

- user_documents: RLS(`user_id = auth.uid()` OR admin), INSERT/UPDATE는 본인/관리자만
- company_documents: SELECT는 모든 로그인 사용자, INSERT/UPDATE/DELETE는 admin
- site_drawings/site_photos: SELECT는
  - admin/system_admin: all
  - partner: `site_id in (select site_id from user_sites where user_id=auth.uid())`
  - worker/site_manager: 정책에 따라 all(또는 user_sites 기반 제한)

---

## 스토리지/성능/가용성

- 업로드는 presigned URL + 멱등 콜백(complete)로 이중확인
- 큰 파일 분할 업로드(브라우저 지원 시), 취소/재시도 UI
- 썸네일 변환(사진)과 PDF → 이미지 프리뷰(옵션) 백그라운드 처리

---

## 단계별 구현 계획

Phase 0. 스키마/스토리지/권한

- 마이그레이션: 위 4개 영역 테이블 생성, 인덱스/제약, RLS 구성
- 스토리지 버킷/폴더 구조 생성, 정책(읽기권한) 설정

Phase 1. API

- 내문서함: types/status/upload/preview/admin-verify/export
- 회사서류함: list/publish/preview
- 도면문서함: list/upload/preview/markups-save
- 사진함: list/upload/preview
- 공통: signed-url, presigned upload, 검색/페이징 스펙 확정

Phase 2. 프런트 2×2 탭 UI

- 참조 HTML 스타일링 적용, 카드/선택/푸터 버튼 공통 컴포넌트화
- 내문서함: 8종 카드 렌더 + 업로드/완료/보기 상태 머신
- 회사서류함: 4종 고정 목록, 버전 노출
- 도면문서함: 필터/리스트/보기/다운로드/업로드
- 사진함: 썸네일 그리드/미리보기/다중 업로드

Phase 3. PWA 고도화

- Service Worker: 오프라인 캐시/백그라운드 동기화
- IndexedDB: 업로드 대기열/진행 상태
- Web Share API/Save File Picker 폴백 전략

Phase 4. 관리자 콘솔

- 필수제출서류함 현황 보드(미제출/반려/기한경과 필터)
- 승인/반려/알림/CSV Export
- 감사 로그(누가 언제 승인/반려)

Phase 5. 도면마킹도구 연계/품질 개선

- 마킹 저장/게시 연동
- 대용량 썸네일, 점진적 로딩, 접근성/키보드 탐색, 오류 복구

---

## 화면 상태 정의(내문서함 예시)

- NOT_UPLOADED: [업로드] 활성, [보기] 비활성, 선택 가능
- UPLOADED_PENDING: [완료] 라벨, [보기] 활성, 관리자 검증 대기
- APPROVED: [완료] 라벨, [보기] 활성, 승인 배지
- REJECTED: [다시 업로드] 표시(사유 툴팁), [보기] 마지막 파일

---

## 예시 페이로드

- POST `/api/docs/required/upload:init`

```json
{ "type_key": "medical_check", "mime": "application/pdf", "size": 523234 }
```

- POST `/api/docs/required/upload:complete`

```json
{
  "type_key": "medical_check",
  "storage_path": "required-docs/USER/medical_check/2025/08/UUID.pdf",
  "file_name": "배치전_검진.pdf",
  "mime": "application/pdf",
  "size": 523234
}
```

---

## 기술 선택/제안

- 미리보기: 브라우저 새 탭(모바일는 시스템 뷰어), 필요 시 `<iframe>` 내장(권한 문제 시 signed URL 직접 오픈)
- 공유: `navigator.share({ files })` → 불가 시 링크 공유 + a[download]
- 저장(웹): `showSaveFilePicker` → 불가 시 a[download]
- 저장/공유(PWA): Background Sync + Share Target(받기) + Filesystem Access API(지원 브라우저)

---

## 테스트/검증 체크리스트

- 권한별 접근 차단(파트너 현장 제한, 개인 문서 RLS)
- 업로드 실패/중단/재시도/취소 UX
- 모바일(iOS/Android) 공유/보기 동작 차이 및 폴백
- 대용량 파일/저속 네트워크/오프라인

---

## 마이그레이션/운영

- 기존 자료 이관(있다면): 스토리지 이동 + 메타 생성 스크립트
- 로그/모니터링: 업로드 실패율, 승인 지연, 다운로드/공유 횟수
- 보안: URL 만료, 권한 없는 접근 403, 감사 추적
