# INOPNC ê±´ì„¤ í”„ë¡œì íŠ¸ ê´€ë¦¬ ì‹œìŠ¤í…œ - ìƒì„¸ êµ¬í˜„ ëª…ì„¸ì„œ

## ğŸ“‹ ë¬¸ì„œ ê°œìš”

**ì‘ì„±ì¼**: 2025ë…„ 1ì›” 22ì¼  
**í”„ë¡œì íŠ¸ëª…**: INOPNC í˜„ì¥ë³„ ê±´ì„¤ í”„ë¡œì íŠ¸ ê´€ë¦¬ ì‹œìŠ¤í…œ  
**ë¶„ì„ ëŒ€ìƒ**: INOPNC_WM_20250829-main ì „ì²´ ì½”ë“œë² ì´ìŠ¤  
**ëª©ì **: ìš”êµ¬ì‚¬í•­ ëŒ€ë¹„ ë¯¸êµ¬í˜„/ë¯¸ì—°ë™/ì˜¤ë¥˜ ê¸°ëŠ¥ ìƒì„¸ ë¶„ì„ ë° êµ¬í˜„ ëª…ì„¸ ì‘ì„±

---

## ğŸ¯ Executive Summary

### í˜„ì¬ êµ¬í˜„ ìƒíƒœ ì¢…í•© í‰ê°€

| êµ¬ë¶„                    | êµ¬í˜„ë¥  | ìƒíƒœ         | ì£¼ìš” ì´ìŠˆ                                       |
| ----------------------- | ------ | ------------ | ----------------------------------------------- |
| **ì¸ì¦ ì‹œìŠ¤í…œ**         | 70%    | âš ï¸ ë¶€ë¶„ êµ¬í˜„ | íšŒì‚¬ëª… ê²€ìƒ‰ ê¸°ëŠ¥ ë¯¸êµ¬í˜„, 2ë‹¨ê³„ ì¸ì¦ ë¯¸êµ¬í˜„      |
| **ì‘ì—…ì¼ì§€ ì‹œìŠ¤í…œ**     | 85%    | âœ… ì–‘í˜¸      | ì¶œë ¥ì¼ë³´ ìë™ ì—°ë™ ë¡œì§ ê²€ì¦ í•„ìš”               |
| **ì‚¬ì§„ëŒ€ì§€ ê´€ë¦¬**       | 80%    | âœ… ì–‘í˜¸      | ìë™ ì••ì¶• ì²˜ë¦¬ ë¯¸êµ¬í˜„, 30ì¥ ì œí•œ ê²€ì¦ í•„ìš”      |
| **ë„ë©´ ë§ˆí‚¹**           | 75%    | âš ï¸ ë¶€ë¶„ êµ¬í˜„ | PDF ë·°ì–´ ë¯¸êµ¬í˜„, Undo/Redo ê¸°ëŠ¥ ë¯¸êµ¬í˜„          |
| **ê¸‰ì—¬ ê´€ë¦¬**           | 90%    | âœ… ìš°ìˆ˜      | 3.3% ì›ì²œì„¸ êµ¬í˜„ ì™„ë£Œ, ëª…ì„¸ì„œ ìƒì„± ì™„ë£Œ         |
| **ì•Œë¦¼ ì‹œìŠ¤í…œ**         | 60%    | âš ï¸ ë¶€ë¶„ êµ¬í˜„ | ì¹´ì¹´ì˜¤ ì•Œë¦¼í†¡ ë¯¸ì—°ë™, ì˜¤í›„ 4ì‹œ ìë™ ë°œì†¡ ë¯¸êµ¬í˜„ |
| **ìì¬ ê´€ë¦¬(NPC-1000)** | 85%    | âœ… ì–‘í˜¸      | ìë™ ì¬ê³  ê³„ì‚° êµ¬í˜„ ì™„ë£Œ                        |
| **UI/UX ë””ìì¸**        | 75%    | âš ï¸ ë¶€ë¶„ êµ¬í˜„ | ì¼ë¶€ ë””ìì¸ í† í° ë¯¸ì ìš©, ìš©ì–´ í†µì¼ í•„ìš”         |

---

## 1. íšŒì›ê°€ì… ë° ì¸ì¦ ì‹œìŠ¤í…œ (F-01)

### 1.1 í˜„ì¬ êµ¬í˜„ ìƒíƒœ

#### âœ… êµ¬í˜„ ì™„ë£Œ

- ê¸°ë³¸ íšŒì›ê°€ì… í¼ (`app/auth/signup/page.tsx`)
- ì´ë©”ì¼/ë¹„ë°€ë²ˆí˜¸ ê¸°ë°˜ ì¸ì¦
- ì—­í• (role) ì„ íƒ ê¸°ëŠ¥
- ìŠ¹ì¸ ëŒ€ê¸° ì‹œìŠ¤í…œ (`signup_requests` í…Œì´ë¸”)

#### âŒ ë¯¸êµ¬í˜„ ê¸°ëŠ¥

**1.1.1 íšŒì‚¬ëª… ê²€ìƒ‰ ë° ì„ íƒ ê¸°ëŠ¥**

```typescript
// ìš”êµ¬ì‚¬í•­: íšŒì‚¬ëª… ê²€ìƒ‰ â†’ ì„ íƒ â†’ ì§ì±…/ì´ë¦„/ì „í™”ë²ˆí˜¸ ì…ë ¥
// í˜„ì¬ ìƒíƒœ: íšŒì‚¬ëª… ì…ë ¥ í•„ë“œ ìì²´ê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŒ

// í•„ìš” êµ¬í˜„:
interface CompanySearchProps {
  onSelect: (company: Company) => void
}

// 1. íšŒì‚¬ ê²€ìƒ‰ ì»´í¬ë„ŒíŠ¸ ìƒì„±
// app/auth/signup/components/CompanySearch.tsx
export function CompanySearch({ onSelect }: CompanySearchProps) {
  const [query, setQuery] = useState('')
  const [companies, setCompanies] = useState<Company[]>([])

  // íšŒì‚¬ ê²€ìƒ‰ API í˜¸ì¶œ
  const searchCompanies = async (searchTerm: string) => {
    const { data } = await supabase
      .from('organizations')
      .select('*')
      .ilike('name', `%${searchTerm}%`)
      .limit(10)
    return data
  }

  // êµ¬í˜„ í•„ìš”
}

// 2. Database Schema ì¶”ê°€ í•„ìš”
// organizations í…Œì´ë¸”ì´ ì¡´ì¬í•˜ì§€ë§Œ signup í”Œë¡œìš°ì™€ ì—°ë™ ì•ˆë¨
```

**1.1.2 ì´ë©”ì¼/íœ´ëŒ€í° ì¸ì¦ í•„ìˆ˜**

```typescript
// ìš”êµ¬ì‚¬í•­: ì´ë©”ì¼ ë° íœ´ëŒ€í° ì¸ì¦ í•„ìˆ˜
// í˜„ì¬ ìƒíƒœ: ì¸ì¦ ë¡œì§ ì—†ìŒ

// í•„ìš” êµ¬í˜„:
// 1. ì´ë©”ì¼ ì¸ì¦ ì½”ë“œ ë°œì†¡
interface EmailVerificationRequest {
  email: string
  code: string
}

// app/api/auth/verify-email/route.ts
export async function POST(request: Request) {
  const { email, code } = await request.json()

  // 1. ì¸ì¦ ì½”ë“œ ìƒì„± ë° ì €ì¥
  // 2. ì´ë©”ì¼ ë°œì†¡ (Resend/SendGrid)
  // 3. ì½”ë“œ ê²€ì¦

  // í˜„ì¬: auth_identity_verifications í…Œì´ë¸”ì€ ì¡´ì¬í•˜ë‚˜
  // íšŒì›ê°€ì… í”Œë¡œìš°ì™€ ì—°ë™ ì•ˆë¨
}

// 2. íœ´ëŒ€í° SMS ì¸ì¦
// app/api/auth/verify-phone/route.ts
// í˜„ì¬: ì™„ì „ ë¯¸êµ¬í˜„
```

**1.1.3 ê°„í¸ë¹„ë°€ë²ˆí˜¸(PIN) ë° 2ë‹¨ê³„ ì¸ì¦**

```typescript
// ìš”êµ¬ì‚¬í•­: PIN ì„¤ì • ë° 2ë‹¨ê³„ ì¸ì¦ ì§€ì›
// í˜„ì¬ ìƒíƒœ: ì™„ì „ ë¯¸êµ¬í˜„

// í•„ìš” êµ¬í˜„:
// 1. PIN ì„¤ì • UI ë° ì €ì¥
interface PINSettings {
  user_id: string;
  pin_hash: string;
  enabled: boolean;
  created_at: string;
}

// 2. Database Schema ì¶”ê°€
CREATE TABLE user_pin_settings (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES profiles(id) NOT NULL,
  pin_hash TEXT NOT NULL,
  enabled BOOLEAN DEFAULT true,
  last_used_at TIMESTAMP WITH TIME ZONE,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

// 3. 2ë‹¨ê³„ ì¸ì¦ (TOTP)
// ì™„ì „ ë¯¸êµ¬í˜„ - ë¼ì´ë¸ŒëŸ¬ë¦¬ ì¶”ê°€ í•„ìš” (speakeasy, qrcode)
```

**1.1.4 ì†Œì† íšŒì‚¬ëª… ê¸°ì¤€ ë°ì´í„° ë¶„ë¦¬**

```typescript
// ìš”êµ¬ì‚¬í•­: íšŒì‚¬ëª… ê¸°ì¤€ìœ¼ë¡œ í”„ë¡œì íŠ¸ ë°ì´í„° ì² ì €íˆ ë¶„ë¦¬
// í˜„ì¬ ìƒíƒœ: RLS ì •ì±… ì¡´ì¬í•˜ë‚˜ organization_id ê¸°ë°˜ ë¶„ë¦¬ ë¶ˆì™„ì „

// í•„ìš” êµ¬í˜„:
// 1. profiles í…Œì´ë¸”ì— organization_id ì»¬ëŸ¼ í™•ì¸
// í˜„ì¬: organization_id ì»¬ëŸ¼ ì¡´ì¬í•˜ë‚˜ signup ì‹œ ìë™ í• ë‹¹ ì•ˆë¨

// 2. RLS ì •ì±… ê°•í™”
CREATE POLICY "users_see_own_org_data" ON sites
FOR SELECT USING (
  organization_id IN (
    SELECT organization_id FROM profiles WHERE id = auth.uid()
  )
);

// 3. ëª¨ë“  ì£¼ìš” í…Œì´ë¸”ì— organization_id ì¶”ê°€ ë° RLS ì ìš©
// í˜„ì¬: ì¼ë¶€ í…Œì´ë¸”ë§Œ ì ìš©ë¨
```

### 1.2 êµ¬í˜„ ìš°ì„ ìˆœìœ„

| ìˆœìœ„ | ê¸°ëŠ¥                | ì¤‘ìš”ë„      | ì˜ˆìƒ ê³µìˆ˜ |
| ---- | ------------------- | ----------- | --------- |
| 1    | íšŒì‚¬ëª… ê²€ìƒ‰ ë° ì„ íƒ | ğŸ”´ Critical | 3ì¼       |
| 2    | ì´ë©”ì¼ ì¸ì¦         | ğŸ”´ Critical | 2ì¼       |
| 3    | íœ´ëŒ€í° ì¸ì¦         | ğŸŸ¡ High     | 3ì¼       |
| 4    | ë°ì´í„° ë¶„ë¦¬ ê°•í™”    | ğŸ”´ Critical | 2ì¼       |
| 5    | PIN ì„¤ì •            | ğŸŸ¢ Medium   | 2ì¼       |
| 6    | 2ë‹¨ê³„ ì¸ì¦          | ğŸŸ¢ Medium   | 4ì¼       |

---

## 2. ì‘ì—…ì¼ì§€ ë° ì¶œë ¥ì¼ë³´ ìë™ ì—°ë™ (F-02, F-03, F-10)

### 2.1 í˜„ì¬ êµ¬í˜„ ìƒíƒœ

#### âœ… êµ¬í˜„ ì™„ë£Œ

- ì‘ì—…ì¼ì§€ ì‘ì„± í¼ (`components/daily-reports/daily-report-form.tsx`)
- ë‚ ì§œ, í˜„ì¥ëª…, ì‘ì—…ë‚´ìš©, ê³µìˆ˜ ì…ë ¥
- ì‚¬ì§„ëŒ€ì§€, ë„ë©´ë§ˆí‚¹ ì—°ë™
- Database: `daily_reports`, `daily_report_workers` í…Œì´ë¸”

#### âš ï¸ ë¶€ë¶„ êµ¬í˜„

**2.1.1 ì¶œë ¥ì¼ë³´ ìë™ ì—°ë™ ë¡œì§**

```typescript
// ìš”êµ¬ì‚¬í•­: ì‘ì—…ì¼ì§€ ì €ì¥ ì‹œ ë‚ ì§œ, í˜„ì¥ëª…, ê³µìˆ˜ê°€ ì¶œë ¥ì¼ë³´ë¡œ ìë™ ë°˜ì˜
// í˜„ì¬ ìƒíƒœ: ì‘ì—…ì¼ì§€ì™€ ì¶œë ¥ì¼ë³´ê°€ ë³„ë„ í…Œì´ë¸”ë¡œ ì¡´ì¬í•˜ë‚˜ ìë™ ì—°ë™ ë¯¸í™•ì¸

// í˜„ì¬ êµ¬ì¡°:
// - daily_reports: ì‘ì—…ì¼ì§€
// - daily_report_workers: ì‘ì—…ìë³„ ê³µìˆ˜
// - attendance_records: ì¶œì„ ê¸°ë¡ (ì¶œë ¥ì¼ë³´ ì—­í• )

// í•„ìš” ê²€ì¦:
// 1. ì‘ì—…ì¼ì§€ ì €ì¥ ì‹œ attendance_records ìë™ ìƒì„± ì—¬ë¶€
// app/actions/admin/daily-reports.ts í™•ì¸ í•„ìš”

export async function createDailyReport(data: DailyReportInput) {
  // 1. daily_reports INSERT
  const report = await supabase.from('daily_reports').insert({...});

  // 2. daily_report_workers INSERT
  await supabase.from('daily_report_workers').insert(workers);

  // âŒ ë¬¸ì œ: attendance_records ìë™ ìƒì„± ë¡œì§ ì—†ìŒ!
  // í•„ìš”: Trigger ë˜ëŠ” Application Levelì—ì„œ ì²˜ë¦¬
}

// í•´ê²° ë°©ì•ˆ 1: Database Trigger
CREATE OR REPLACE FUNCTION sync_daily_report_to_attendance()
RETURNS TRIGGER AS $$
BEGIN
  INSERT INTO attendance_records (
    user_id,
    site_id,
    work_date,
    work_hours,
    status,
    daily_report_id
  )
  SELECT
    drw.worker_id,
    NEW.site_id,
    NEW.work_date,
    drw.work_hours,
    'present',
    NEW.id
  FROM daily_report_workers drw
  WHERE drw.daily_report_id = NEW.id
  ON CONFLICT (user_id, work_date) DO UPDATE
  SET work_hours = EXCLUDED.work_hours,
      updated_at = NOW();

  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trigger_sync_attendance
AFTER INSERT OR UPDATE ON daily_reports
FOR EACH ROW EXECUTE FUNCTION sync_daily_report_to_attendance();
```

**2.1.2 ìˆ˜ì • ì´ë ¥ ë¡œê·¸ ë° ì›ë³¸ ë°ì´í„° ìœ ì§€**

```typescript
// ìš”êµ¬ì‚¬í•­: ìˆ˜ì • ì‹œ ì´ë ¥ ë¡œê·¸ ê¸°ë¡ ë° ì›ë³¸ ë°ì´í„° ìœ ì§€ í•„ìˆ˜
// í˜„ì¬ ìƒíƒœ: updated_at ì»¬ëŸ¼ë§Œ ì¡´ì¬, ì´ë ¥ í…Œì´ë¸” ì—†ìŒ

// í•„ìš” êµ¬í˜„:
// 1. ì´ë ¥ í…Œì´ë¸” ìƒì„±
CREATE TABLE daily_report_history (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  daily_report_id UUID REFERENCES daily_reports(id) NOT NULL,
  changed_by UUID REFERENCES profiles(id),
  change_type TEXT CHECK (change_type IN ('created', 'updated', 'deleted')),
  old_data JSONB,
  new_data JSONB,
  changed_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  change_reason TEXT
);

// 2. Trigger ìƒì„±
CREATE OR REPLACE FUNCTION log_daily_report_changes()
RETURNS TRIGGER AS $$
BEGIN
  IF TG_OP = 'UPDATE' THEN
    INSERT INTO daily_report_history (
      daily_report_id,
      changed_by,
      change_type,
      old_data,
      new_data
    ) VALUES (
      NEW.id,
      auth.uid(),
      'updated',
      to_jsonb(OLD),
      to_jsonb(NEW)
    );
  END IF;
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

// 3. Application Level ì´ë ¥ ì¡°íšŒ API
// app/api/daily-reports/[id]/history/route.ts
// í˜„ì¬: ì™„ì „ ë¯¸êµ¬í˜„
```

**2.1.3 ì‘ì—…ìëª… ë¯¸ì…ë ¥ ì‹œ ì•Œë¦¼**

```typescript
// ìš”êµ¬ì‚¬í•­: ì‘ì—…ìëª… ë¯¸ì…ë ¥ ì‹œ ì•Œë¦¼ ë°œìƒ
// í˜„ì¬ ìƒíƒœ: í”„ë¡ íŠ¸ì—”ë“œ validationë§Œ ì¡´ì¬

// í˜„ì¬ êµ¬í˜„:
// components/daily-reports/daily-report-form.tsx
if (!workers || workers.length === 0) {
  toast.error('ì‘ì—…ìë¥¼ ì¶”ê°€í•´ì£¼ì„¸ìš”')
  return
}

// âœ… ê¸°ë³¸ êµ¬í˜„ ì™„ë£Œ
// âš ï¸ ê°œì„  í•„ìš”: ì €ì¥ í›„ ì•Œë¦¼ ì‹œìŠ¤í…œ ì—°ë™
```

### 2.2 êµ¬í˜„ ìš°ì„ ìˆœìœ„

| ìˆœìœ„ | ê¸°ëŠ¥                       | ì¤‘ìš”ë„      | ì˜ˆìƒ ê³µìˆ˜ |
| ---- | -------------------------- | ----------- | --------- |
| 1    | ì¶œë ¥ì¼ë³´ ìë™ ì—°ë™ Trigger | ğŸ”´ Critical | 2ì¼       |
| 2    | ìˆ˜ì • ì´ë ¥ ë¡œê·¸ ì‹œìŠ¤í…œ      | ğŸ”´ Critical | 3ì¼       |
| 3    | ì´ë ¥ ì¡°íšŒ UI               | ğŸŸ¡ High     | 2ì¼       |

---

## 3. ì‚¬ì§„ëŒ€ì§€ ë° ë„ë©´ ë§ˆí‚¹ (F-04, F-05, F-07)

### 3.1 ì‚¬ì§„ëŒ€ì§€ (Photo Sheet)

#### âœ… êµ¬í˜„ ì™„ë£Œ

- ì‚¬ì§„ ì—…ë¡œë“œ ê¸°ëŠ¥
- ë³´ìˆ˜ ì „/í›„ íƒ­ êµ¬ë¶„ (`components/photo-sheet/PhotoSheetEditor.tsx`)
- Firebase Storage ì—°ë™

#### âŒ ë¯¸êµ¬í˜„ ê¸°ëŠ¥

**3.1.1 ìë™ ì••ì¶• ì²˜ë¦¬**

```typescript
// ìš”êµ¬ì‚¬í•­: ì¥ë‹¹ 10MB ì´ë‚´, ìë™ ì••ì¶• ì²˜ë¦¬
// í˜„ì¬ ìƒíƒœ: íŒŒì¼ í¬ê¸° ê²€ì¦ë§Œ ì¡´ì¬, ìë™ ì••ì¶• ì—†ìŒ

// í˜„ì¬ êµ¬í˜„:
// lib/file-validation.ts
export const MAX_FILE_SIZE = 10 * 1024 * 1024 // 10MB

if (file.size > MAX_FILE_SIZE) {
  throw new Error('íŒŒì¼ í¬ê¸°ëŠ” 10MB ì´í•˜ì—¬ì•¼ í•©ë‹ˆë‹¤')
}

// âŒ ë¬¸ì œ: 10MB ì´ˆê³¼ ì‹œ ê±°ë¶€ë§Œ í•¨, ìë™ ì••ì¶• ì—†ìŒ

// í•„ìš” êµ¬í˜„:
import imageCompression from 'browser-image-compression'

export async function compressImage(file: File): Promise<File> {
  const options = {
    maxSizeMB: 10,
    maxWidthOrHeight: 1920,
    useWebWorker: true,
    fileType: 'image/jpeg',
  }

  try {
    const compressedFile = await imageCompression(file, options)
    return compressedFile
  } catch (error) {
    console.error('Image compression failed:', error)
    throw error
  }
}

// ì ìš© ìœ„ì¹˜:
// components/photo-sheet/PhotoSheetEditor.tsx
const handleFileUpload = async (files: FileList) => {
  for (const file of files) {
    const compressed = await compressImage(file)
    // upload compressed file
  }
}
```

**3.1.2 ìµœëŒ€ 30ì¥ ì œí•œ ê²€ì¦**

```typescript
// ìš”êµ¬ì‚¬í•­: ìµœëŒ€ 30ì¥
// í˜„ì¬ ìƒíƒœ: í”„ë¡ íŠ¸ì—”ë“œ ê²€ì¦ë§Œ ì¡´ì¬, DB ì œì•½ ì—†ìŒ

// í•„ìš” êµ¬í˜„:
// 1. Database ì œì•½ ì¶”ê°€
ALTER TABLE photo_sheets
ADD CONSTRAINT check_photo_count
CHECK (array_length(photos, 1) <= 30);

// 2. API Level ê²€ì¦
// app/api/photo-sheets/route.ts
if (photos.length > 30) {
  return NextResponse.json(
    { error: 'ì‚¬ì§„ì€ ìµœëŒ€ 30ì¥ê¹Œì§€ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤' },
    { status: 400 }
  );
}
```

### 3.2 ë„ë©´ ë§ˆí‚¹ (Drawing Markup)

#### âœ… êµ¬í˜„ ì™„ë£Œ

- Canvas ê¸°ë°˜ ë§ˆí‚¹ ë„êµ¬ (`components/markup/SharedMarkupEditor.tsx`)
- íœ, ë„í˜•, í…ìŠ¤íŠ¸ ë„êµ¬
- ë§ˆí‚¹ ë°ì´í„° JSON ì €ì¥
- SVG ì§€ì›

#### âŒ ë¯¸êµ¬í˜„ ê¸°ëŠ¥

**3.2.1 PDF ë·°ì–´**

```typescript
// ìš”êµ¬ì‚¬í•­: SVG/PDF ê¸°ë°˜ ë·°ì–´
// í˜„ì¬ ìƒíƒœ: SVGë§Œ ì§€ì›, PDF ë·°ì–´ ë¯¸êµ¬í˜„

// í•„ìš” êµ¬í˜„:
// 1. PDF.js ë¼ì´ë¸ŒëŸ¬ë¦¬ ì¶”ê°€
import * as pdfjsLib from 'pdfjs-dist';

// 2. PDF ë Œë”ë§ ì»´í¬ë„ŒíŠ¸
// components/markup/PDFViewer.tsx
export function PDFViewer({ pdfUrl }: { pdfUrl: string }) {
  const canvasRef = useRef<HTMLCanvasElement>(null);

  useEffect(() => {
    const loadPDF = async () => {
      const pdf = await pdfjsLib.getDocument(pdfUrl).promise;
      const page = await pdf.getPage(1);

      const viewport = page.getViewport({ scale: 1.5 });
      const canvas = canvasRef.current;
      const context = canvas.getContext('2d');

      canvas.height = viewport.height;
      canvas.width = viewport.width;

      await page.render({
        canvasContext: context,
        viewport: viewport,
      }).promise;
    };

    loadPDF();
  }, [pdfUrl]);

  return <canvas ref={canvasRef} />;
}

// 3. PDF ìœ„ì— ë§ˆí‚¹ ë ˆì´ì–´ ì¶”ê°€
// í˜„ì¬: ì™„ì „ ë¯¸êµ¬í˜„
```

**3.2.2 Undo/Redo ê¸°ëŠ¥**

```typescript
// ìš”êµ¬ì‚¬í•­: Undo/Redo ê¸°ëŠ¥
// í˜„ì¬ ìƒíƒœ: ë¯¸êµ¬í˜„

// í•„ìš” êµ¬í˜„:
interface MarkupHistory {
  past: MarkupData[]
  present: MarkupData
  future: MarkupData[]
}

export function useMarkupHistory() {
  const [history, setHistory] = useState<MarkupHistory>({
    past: [],
    present: { shapes: [] },
    future: [],
  })

  const undo = () => {
    if (history.past.length === 0) return

    const previous = history.past[history.past.length - 1]
    const newPast = history.past.slice(0, history.past.length - 1)

    setHistory({
      past: newPast,
      present: previous,
      future: [history.present, ...history.future],
    })
  }

  const redo = () => {
    if (history.future.length === 0) return

    const next = history.future[0]
    const newFuture = history.future.slice(1)

    setHistory({
      past: [...history.past, history.present],
      present: next,
      future: newFuture,
    })
  }

  return { undo, redo, canUndo: history.past.length > 0, canRedo: history.future.length > 0 }
}

// ì ìš© ìœ„ì¹˜:
// components/markup/SharedMarkupEditor.tsx
```

**3.2.3 A4 PDF ë³´ê³ ì„œ ìë™ ìƒì„±**

```typescript
// ìš”êµ¬ì‚¬í•­: ì‘ì—…ì¼ì§€ + ì‚¬ì§„ + ë„ë©´ ë§ˆí‚¹ â†’ A4 PDF ìë™ ìƒì„±
// í˜„ì¬ ìƒíƒœ: ë¶€ë¶„ êµ¬í˜„ (lib/pdf/photo-grid-pdfkit.ts)

// ê°œì„  í•„ìš”:
// 1. í†µí•© PDF ìƒì„± í•¨ìˆ˜
export async function generateWorkReportPDF(reportId: string) {
  // 1. ì‘ì—…ì¼ì§€ ë°ì´í„° ì¡°íšŒ
  const report = await getDailyReportWithRelations(reportId)

  // 2. ì‚¬ì§„ëŒ€ì§€ ì¡°íšŒ
  const photos = await getPhotoSheetsByReport(reportId)

  // 3. ë„ë©´ ë§ˆí‚¹ ì¡°íšŒ
  const markups = await getMarkupsByReport(reportId)

  // 4. PDF ìƒì„±
  const pdf = new PDFDocument({ size: 'A4' })

  // í˜ì´ì§€ 1: ì‘ì—…ì¼ì§€ ì •ë³´
  pdf.fontSize(20).text('ì‘ì—…ì¼ì§€', { align: 'center' })
  pdf.fontSize(12).text(`í˜„ì¥ëª…: ${report.site.name}`)
  pdf.text(`ì‘ì—…ì¼: ${report.work_date}`)

  // í˜ì´ì§€ 2-N: ì‚¬ì§„ëŒ€ì§€
  photos.forEach((photo, index) => {
    pdf.addPage()
    pdf.image(photo.url, { fit: [500, 600] })
  })

  // í˜ì´ì§€ N+1: ë„ë©´ ë§ˆí‚¹
  markups.forEach(markup => {
    pdf.addPage()
    // SVG/Canvas ë Œë”ë§
  })

  return pdf
}

// íŒŒì¼ëª… ê·œì¹™ ì ìš©
const filename = `[${report.site.name}]_ì‘ì—…ë³´ê³ ì„œ_${format(report.work_date, 'yyyyMMdd')}.pdf`
```

### 3.3 êµ¬í˜„ ìš°ì„ ìˆœìœ„

| ìˆœìœ„ | ê¸°ëŠ¥                 | ì¤‘ìš”ë„      | ì˜ˆìƒ ê³µìˆ˜ |
| ---- | -------------------- | ----------- | --------- |
| 1    | ì´ë¯¸ì§€ ìë™ ì••ì¶•     | ğŸ”´ Critical | 1ì¼       |
| 2    | PDF ë·°ì–´ êµ¬í˜„        | ğŸŸ¡ High     | 3ì¼       |
| 3    | Undo/Redo ê¸°ëŠ¥       | ğŸŸ¡ High     | 2ì¼       |
| 4    | í†µí•© PDF ë³´ê³ ì„œ ìƒì„± | ğŸ”´ Critical | 3ì¼       |

---

## 4. ê¸‰ì—¬ ê´€ë¦¬ ë° ì •ì‚° (F-10)

### 4.1 í˜„ì¬ êµ¬í˜„ ìƒíƒœ

#### âœ… êµ¬í˜„ ì™„ë£Œ (ìš°ìˆ˜)

- ì›”ë³„ ê³µìˆ˜ í•©ì‚° ê¸°ë°˜ ì‚°ì¶œ (`lib/salary/calculator.ts`)
- 3.3% ì›ì²œì„¸ ê³µì œ ë°˜ì˜ âœ…
- ê³ ìš©ë…¸ë™ë¶€ í‘œì¤€ ì–‘ì‹ PDF ëª…ì„¸ì„œ (`lib/salary/enhanced-pdf-generator.ts`)
- ê´€ë¦¬ì í™•ì • ê¸°ëŠ¥
- Excel ë‚´ë³´ë‚´ê¸°

#### âš ï¸ ê²€ì¦ í•„ìš”

**4.1.1 3.3% ì›ì²œì„¸ ê³„ì‚° ë¡œì§ ê²€ì¦**

```typescript
// í˜„ì¬ êµ¬í˜„:
// lib/salary/calculator.ts
export function calculateSalary(params: SalaryCalculationParams) {
  const { baseAmount, workHours, calculationType, taxRate = 3.3 } = params;

  const basePay = baseAmount * workHours;
  const grossPay = basePay - deductions;

  let taxAmount = 0;
  let netPay = grossPay;

  if (calculationType === 'tax_prepaid') {
    // 3.3% ì„ ì·¨ ë°©ì‹
    taxAmount = grossPay * (taxRate / 100);
    netPay = grossPay - taxAmount;
  }

  return { grossPay, taxAmount, netPay, ... };
}

// âœ… êµ¬í˜„ ì™„ë£Œ
// âš ï¸ ê²€ì¦ í•„ìš”:
// 1. ì§€ë°©ì†Œë“ì„¸ 0.33% ë³„ë„ ê³„ì‚° ì—¬ë¶€
// 2. ì¼ìš©ì§/í”„ë¦¬ëœì„œ êµ¬ë¶„ ê³„ì‚°
```

**4.1.2 ëª…ì„¸ì„œ ë‹¤ìš´ë¡œë“œ ê¶Œí•œ**

```typescript
// ìš”êµ¬ì‚¬í•­: ê´€ë¦¬ì í™•ì • ë°ì´í„°ë§Œ ëª…ì„¸ì„œ ë°˜ì˜
// í˜„ì¬ ìƒíƒœ: í™•ì • ì—¬ë¶€ í•„í„°ë§ ë¡œì§ í™•ì¸ í•„ìš”

// app/api/salary/monthly/route.ts
export async function GET(request: Request) {
  const { searchParams } = new URL(request.url)
  const userId = searchParams.get('userId')
  const month = searchParams.get('month')

  // âš ï¸ í™•ì¸ í•„ìš”: is_confirmed í•„í„°ë§
  const { data } = await supabase
    .from('salary_calculations')
    .select('*')
    .eq('user_id', userId)
    .eq('month', month)
    .eq('is_confirmed', true) // â† ì´ ì¡°ê±´ í™•ì¸ í•„ìš”

  return NextResponse.json(data)
}
```

### 4.2 êµ¬í˜„ ìš°ì„ ìˆœìœ„

| ìˆœìœ„ | ê¸°ëŠ¥                    | ì¤‘ìš”ë„  | ì˜ˆìƒ ê³µìˆ˜ |
| ---- | ----------------------- | ------- | --------- |
| 1    | ì„¸ê¸ˆ ê³„ì‚° ë¡œì§ ê²€ì¦     | ğŸŸ¡ High | 1ì¼       |
| 2    | í™•ì • ë°ì´í„° í•„í„°ë§ ê²€ì¦ | ğŸŸ¡ High | 0.5ì¼     |

---

## 5. ì•Œë¦¼ ë° ê³µìœ  (F-09, F-12)

### 5.1 í˜„ì¬ êµ¬í˜„ ìƒíƒœ

#### âœ… êµ¬í˜„ ì™„ë£Œ

- FCM í‘¸ì‹œ ì•Œë¦¼ ê¸°ë³¸ êµ¬ì¡° (`lib/push-notifications.ts`)
- ì•Œë¦¼ í…Œì´ë¸” ë° API (`app/api/notifications/route.ts`)
- ì´ë©”ì¼ ì•Œë¦¼ ê¸°ëŠ¥

#### âŒ ë¯¸êµ¬í˜„ ê¸°ëŠ¥

**5.1.1 ë§¤ì¼ ì˜¤í›„ 4ì‹œ ë¯¸ì‘ì„± ì•Œë¦¼**

```typescript
// ìš”êµ¬ì‚¬í•­: ë§¤ì¼ ì˜¤í›„ 4ì‹œ, ë‹¹ì¼ ì¼ì§€ ë¯¸ì‘ì„±ìì—ê²Œ FCM í‘¸ì‹œ ë° ì¹´ì¹´ì˜¤ ì•Œë¦¼í†¡
// í˜„ì¬ ìƒíƒœ: ìŠ¤ì¼€ì¤„ëŸ¬ API ì¡´ì¬í•˜ë‚˜ ì¹´ì¹´ì˜¤ ì•Œë¦¼í†¡ ë¯¸ì—°ë™

// í˜„ì¬ êµ¬í˜„:
// app/api/daily-reports/reminder/schedule/route.ts
export async function POST() {
  // 1. ë‹¹ì¼ ì¼ì§€ ë¯¸ì‘ì„±ì ì¡°íšŒ
  const users = await getUsersWithoutTodayReport();

  // 2. FCM í‘¸ì‹œ ë°œì†¡
  for (const user of users) {
    await sendPushNotification(user.fcm_token, {
      title: 'ì‘ì—…ì¼ì§€ ì‘ì„± ì•Œë¦¼',
      body: 'ì˜¤ëŠ˜ì˜ ì‘ì—…ì¼ì§€ë¥¼ ì‘ì„±í•´ì£¼ì„¸ìš”',
    });
  }

  // âŒ ì¹´ì¹´ì˜¤ ì•Œë¦¼í†¡ ë¯¸êµ¬í˜„
}

// í•„ìš” êµ¬í˜„:
// 1. ì¹´ì¹´ì˜¤ ì•Œë¦¼í†¡ API ì—°ë™
import axios from 'axios';

interface KakaoAlimtalkParams {
  phone: string;
  templateCode: string;
  variables: Record<string, string>;
}

export async function sendKakaoAlimtalk(params: KakaoAlimtalkParams) {
  const response = await axios.post(
    'https://api.aligo.in/send/',
    {
      key: process.env.KAKAO_API_KEY,
      user_id: process.env.KAKAO_USER_ID,
      sender: process.env.KAKAO_SENDER,
      receiver: params.phone,
      msg: renderTemplate(params.templateCode, params.variables),
    }
  );

  return response.data;
}

// 2. í…œí”Œë¦¿ ë“±ë¡
// ì¹´ì¹´ì˜¤ ë¹„ì¦ˆë‹ˆìŠ¤ ì±„ë„ì—ì„œ í…œí”Œë¦¿ ì‚¬ì „ ë“±ë¡ í•„ìš”
// í…œí”Œë¦¿ ì˜ˆì‹œ:
// "ì•ˆë…•í•˜ì„¸ìš” #{name}ë‹˜, ì˜¤ëŠ˜(#{date}) ì‘ì—…ì¼ì§€ë¥¼ ì•„ì§ ì‘ì„±í•˜ì§€ ì•Šìœ¼ì…¨ìŠµë‹ˆë‹¤.
// ì‘ì„± ë°”ëë‹ˆë‹¤. - INOPNC"

// 3. Cron Job ì„¤ì •
// vercel.json ë˜ëŠ” ë³„ë„ ìŠ¤ì¼€ì¤„ëŸ¬
{
  "crons": [{
    "path": "/api/daily-reports/reminder/schedule",
    "schedule": "0 16 * * *"  // ë§¤ì¼ ì˜¤í›„ 4ì‹œ (KST: 0 7 * * *)
  }]
}
```

**5.1.2 ë³´ê³ ì„œ ì¹´ì¹´ì˜¤í†¡ ê³µìœ **

```typescript
// ìš”êµ¬ì‚¬í•­: ìƒì„±ëœ ë³´ê³ ì„œë¥¼ ì¹´ì¹´ì˜¤í†¡ APIë¡œ ì™¸ë¶€ ê±°ë˜ì²˜ì— ì¦‰ì‹œ ì „ì†¡
// í˜„ì¬ ìƒíƒœ: ì™„ì „ ë¯¸êµ¬í˜„

// í•„ìš” êµ¬í˜„:
// 1. ì¹´ì¹´ì˜¤í†¡ ê³µìœ  API
export async function shareReportViaKakao(reportId: string, recipients: string[]) {
  // 1. PDF ë³´ê³ ì„œ ìƒì„±
  const pdfUrl = await generateWorkReportPDF(reportId);

  // 2. ì¹´ì¹´ì˜¤í†¡ íŒŒì¼ ì „ì†¡ API
  // ì£¼ì˜: ì¹´ì¹´ì˜¤í†¡ APIëŠ” íŒŒì¼ ì§ì ‘ ì „ì†¡ ë¶ˆê°€
  // í•´ê²°: ì›¹ ë§í¬ ê³µìœ  + ë‹¤ìš´ë¡œë“œ í˜ì´ì§€

  const shareUrl = `${process.env.NEXT_PUBLIC_URL}/reports/${reportId}/download`;

  // 3. ì¹´ì¹´ì˜¤ ì•Œë¦¼í†¡ìœ¼ë¡œ ë§í¬ ì „ì†¡
  for (const phone of recipients) {
    await sendKakaoAlimtalk({
      phone,
      templateCode: 'REPORT_SHARE',
      variables: {
        reportName: `ì‘ì—…ë³´ê³ ì„œ_${reportId}`,
        downloadUrl: shareUrl,
      },
    });
  }
}

// 2. ë‹¤ìš´ë¡œë“œ í˜ì´ì§€
// app/reports/[id]/download/page.tsx
export default async function ReportDownloadPage({ params }: { params: { id: string } }) {
  const report = await getReport(params.id);
  const pdfUrl = await generateWorkReportPDF(params.id);

  return (
    <div>
      <h1>ì‘ì—…ë³´ê³ ì„œ ë‹¤ìš´ë¡œë“œ</h1>
      <a href={pdfUrl} download>PDF ë‹¤ìš´ë¡œë“œ</a>
    </div>
  );
}
```

### 5.2 êµ¬í˜„ ìš°ì„ ìˆœìœ„

| ìˆœìœ„ | ê¸°ëŠ¥                    | ì¤‘ìš”ë„      | ì˜ˆìƒ ê³µìˆ˜ |
| ---- | ----------------------- | ----------- | --------- |
| 1    | ì¹´ì¹´ì˜¤ ì•Œë¦¼í†¡ API ì—°ë™  | ğŸ”´ Critical | 3ì¼       |
| 2    | ì˜¤í›„ 4ì‹œ ìë™ ì•Œë¦¼ Cron | ğŸ”´ Critical | 1ì¼       |
| 3    | ë³´ê³ ì„œ ì¹´ì¹´ì˜¤í†¡ ê³µìœ     | ğŸŸ¡ High     | 2ì¼       |

---

## 6. UI/UX ë””ìì¸ ë° ì‹œìŠ¤í…œ ê·œì¹™ (F-13, F-14)

### 6.1 ë””ìì¸ í† í° êµ¬í˜„ ìƒíƒœ

#### âœ… êµ¬í˜„ ì™„ë£Œ

- CSS ë³€ìˆ˜ ê¸°ë°˜ ìƒ‰ìƒ ì‹œìŠ¤í…œ (`app/globals.css`)
- Tailwind ì„¤ì • (`tailwind.config.ts`)
- í°íŠ¸: Pretendard (Noto Sans KR ëŒ€ì‹  ì‚¬ìš© ì¤‘)

#### âš ï¸ ë¶€ë¶„ êµ¬í˜„

**6.1.1 ë¸Œëœë“œ ì»¬ëŸ¬ ì ìš© ê²€ì¦**

```css
/* ìš”êµ¬ì‚¬í•­ */
--brand:
  #1a254f (ë‚¨ìƒ‰ ë²„íŠ¼) --accent: #0068fe (ê°•ì¡° ë¸”ë£¨) --warn: #ea3829 (ì£¼ì˜/ê²½ê³ ) --sky: #00bcd4
    (í•˜ëŠ˜ìƒ‰ ë²„íŠ¼) /* í˜„ì¬ êµ¬í˜„ */ /* app/globals.css */: root {--brand: #1a254f; /* âœ… ì¼ì¹˜ */
    --num: #0068fe; /* âš ï¸ accent ëŒ€ì‹  num ì‚¬ìš© */ /* --warn: ë¯¸ì •ì˜ */ /* --sky: ë¯¸ì •ì˜ */}
    /* í•„ìš” ìˆ˜ì • */: root {--brand: #1a254f; --accent: #0068fe; --warn: #ea3829; --sky: #00bcd4;}
    /* Tailwind ì„¤ì • ì¶”ê°€ */ // tailwind.config.ts
  colors: {brand: 'var(--brand)',
  accent: 'var(--accent)', warn: 'var(--warn)', sky: 'var(--sky)', };
```

**6.1.2 ë‹¤í¬ëª¨ë“œ ìƒ‰ìƒ ê²€ì¦**

```css
/* ìš”êµ¬ì‚¬í•­ */
--bg: #0f172a (ë°°ê²½) --card: #111827 (ì¹´ë“œ) /* í˜„ì¬ êµ¬í˜„ */ [data-theme= 'dark'] {--bg: #0f172a;
  /* âœ… ì¼ì¹˜ */ --card: #0f172a; /* âŒ ë¶ˆì¼ì¹˜ - #111827 ì´ì–´ì•¼ í•¨ */} /* ìˆ˜ì • í•„ìš” */ [data-theme=
  'dark'] {--bg: #0f172a; --card: #111827;};
```

### 6.2 UI ì»´í¬ë„ŒíŠ¸ ê°œì„ ì‚¬í•­

**6.2.1 í•˜ë‹¨ ë„¤ë¹„ê²Œì´ì…˜ ë°” ìˆ˜ì •**

```typescript
// ìš”êµ¬ì‚¬í•­: "í™ˆ" â†’ "ë¹ ë¥¸ë©”ë‰´" ë³€ê²½, ë…¸ë€ ì¤„ ì œê±°
// ìœ„ì¹˜: components/navigation/BottomNav.tsx ë˜ëŠ” modules/mobile/components/layout/BottomNav.tsx

// í˜„ì¬:
<NavItem icon={HomeIcon} label="í™ˆ" href="/dashboard" />

// ìˆ˜ì •:
<NavItem icon={MenuIcon} label="ë¹ ë¥¸ë©”ë‰´" href="/dashboard" />

// ë…¸ë€ ì¤„ ì œê±°:
// í˜„ì¬ ìŠ¤íƒ€ì¼ì—ì„œ border-yellow-* í´ë˜ìŠ¤ ì œê±°
```

**6.2.2 ìš©ì–´ í†µì¼**

```typescript
// ìš”êµ¬ì‚¬í•­: "ë¶€ìœ„ëª…" â†’ "ë¶€ì¬ëª…"
// ê²€ìƒ‰ í•„ìš” íŒŒì¼:
// - components/daily-reports/**/*.tsx
// - app/dashboard/**/*.tsx

// ì¼ê´„ ë³€ê²½:
// 1. ë°ì´í„°ë² ì´ìŠ¤ ì»¬ëŸ¼ëª… í™•ì¸
// 2. í”„ë¡ íŠ¸ì—”ë“œ ë¼ë²¨ ë³€ê²½
// 3. API ì‘ë‹µ í•„ë“œëª… í™•ì¸
```

**6.2.3 ì‘ì—…ì ì…ë ¥ ë“œë¡­ë°•ìŠ¤ ìš°ì„  ë…¸ì¶œ**

```typescript
// ìš”êµ¬ì‚¬í•­: ë“œë¡­ë°•ìŠ¤ ìš°ì„ , ì§ì ‘ ì…ë ¥ì€ ì˜ˆì™¸
// ìœ„ì¹˜: components/daily-reports/daily-report-form.tsx

// í˜„ì¬:
<input type="text" placeholder="ì‘ì—…ìëª… ì…ë ¥" />

// ìˆ˜ì •:
<Select>
  <SelectTrigger>
    <SelectValue placeholder="ì‘ì—…ì ì„ íƒ" />
  </SelectTrigger>
  <SelectContent>
    {workers.map(worker => (
      <SelectItem key={worker.id} value={worker.id}>
        {worker.full_name}
      </SelectItem>
    ))}
    <SelectItem value="__custom__">ì§ì ‘ ì…ë ¥</SelectItem>
  </SelectContent>
</Select>

{selectedWorker === '__custom__' && (
  <input type="text" placeholder="ì‘ì—…ìëª… ì§ì ‘ ì…ë ¥" />
)}
```

**6.2.4 ì§„í–‰ë¥  í‘œì‹œ ì œê±°**

```typescript
// ìš”êµ¬ì‚¬í•­: ì‘ì—…ì¼ì§€ ì‘ì„± ì‹œ ì§„í–‰ë¥  í‘œì‹œ ì œê±°
// ìœ„ì¹˜: components/daily-reports/daily-report-form.tsx

// ì œê±° ëŒ€ìƒ:
<Progress value={completionPercentage} />
<span>{completionPercentage}% ì™„ë£Œ</span>
```

### 6.3 êµ¬í˜„ ìš°ì„ ìˆœìœ„

| ìˆœìœ„ | ê¸°ëŠ¥                 | ì¤‘ìš”ë„    | ì˜ˆìƒ ê³µìˆ˜ |
| ---- | -------------------- | --------- | --------- |
| 1    | ë¸Œëœë“œ ì»¬ëŸ¬ ìˆ˜ì •     | ğŸŸ¡ High   | 0.5ì¼     |
| 2    | ìš©ì–´ í†µì¼ (ë¶€ì¬ëª…)   | ğŸŸ¡ High   | 0.5ì¼     |
| 3    | í•˜ë‹¨ ë„¤ë¹„ ìˆ˜ì •       | ğŸŸ¢ Medium | 0.5ì¼     |
| 4    | ì‘ì—…ì ë“œë¡­ë°•ìŠ¤ ìš°ì„  | ğŸŸ¡ High   | 1ì¼       |
| 5    | ì§„í–‰ë¥  í‘œì‹œ ì œê±°     | ğŸŸ¢ Medium | 0.25ì¼    |

---

## 7. ìì¬ ê´€ë¦¬ (NPC-1000) (F-11)

### 7.1 í˜„ì¬ êµ¬í˜„ ìƒíƒœ

#### âœ… êµ¬í˜„ ì™„ë£Œ (ìš°ìˆ˜)

- ì…ê³ /ì¶œê³ /ì¬ê³  ê´€ë¦¬ (`app/actions/npc-materials.ts`)
- ìë™ ì¬ê³  ê³„ì‚° âœ…
- í˜„ì¥ë³„ ìì¬ ìš”ì²­ ê¸°ëŠ¥
- ì‹¤ì‹œê°„ ì¬ê³  í˜„í™©

#### âš ï¸ ê²€ì¦ í•„ìš”

**7.1.1 ìë™ ì¬ê³  ê³„ì‚° ë¡œì§**

```typescript
// í˜„ì¬ êµ¬í˜„:
// app/actions/npc-materials.ts
export async function updateMaterialStock(materialId: string, change: number) {
  const { data: material } = await supabase
    .from('materials')
    .select('current_stock')
    .eq('id', materialId)
    .single();

  const newStock = material.current_stock + change;

  await supabase
    .from('materials')
    .update({ current_stock: newStock })
    .eq('id', materialId);
}

// âœ… ê¸°ë³¸ êµ¬í˜„ ì™„ë£Œ
// âš ï¸ ê²€ì¦ í•„ìš”:
// 1. ë™ì‹œì„± ì œì–´ (Race Condition)
// 2. ìŒìˆ˜ ì¬ê³  ë°©ì§€
// 3. íŠ¸ëœì­ì…˜ ì²˜ë¦¬

// ê°œì„  ë°©ì•ˆ:
// Database Functionìœ¼ë¡œ ì´ë™
CREATE OR REPLACE FUNCTION update_material_stock(
  p_material_id UUID,
  p_change_amount DECIMAL
) RETURNS VOID AS $$
BEGIN
  UPDATE materials
  SET current_stock = current_stock + p_change_amount,
      updated_at = NOW()
  WHERE id = p_material_id
    AND (current_stock + p_change_amount) >= 0; -- ìŒìˆ˜ ë°©ì§€

  IF NOT FOUND THEN
    RAISE EXCEPTION 'ì¬ê³ ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤';
  END IF;
END;
$$ LANGUAGE plpgsql;
```

### 7.2 êµ¬í˜„ ìš°ì„ ìˆœìœ„

| ìˆœìœ„ | ê¸°ëŠ¥                  | ì¤‘ìš”ë„  | ì˜ˆìƒ ê³µìˆ˜ |
| ---- | --------------------- | ------- | --------- |
| 1    | ì¬ê³  ê³„ì‚° ë™ì‹œì„± ì œì–´ | ğŸŸ¡ High | 1ì¼       |
| 2    | ìŒìˆ˜ ì¬ê³  ë°©ì§€ ê²€ì¦   | ğŸŸ¡ High | 0.5ì¼     |

---

## 8. ë°ì´í„° ì²˜ë¦¬ ë° ì‚°ì¶œë¬¼ ë¡œì§

### 8.1 ë³´ê³ ì„œ íŒŒì¼ëª… ê·œì¹™

```typescript
// ìš”êµ¬ì‚¬í•­: [í˜„ì¥ëª…]_ì‘ì—…ë³´ê³ ì„œ_YYYYMMDD.pdf
// í˜„ì¬ ìƒíƒœ: ë¶€ë¶„ êµ¬í˜„

// í•„ìš” êµ¬í˜„:
import { format } from 'date-fns'

export function generateReportFilename(siteName: string, workDate: Date): string {
  const dateStr = format(workDate, 'yyyyMMdd')
  return `[${siteName}]_ì‘ì—…ë³´ê³ ì„œ_${dateStr}.pdf`
}

// ì ìš© ìœ„ì¹˜:
// lib/pdf/photo-grid-pdfkit.ts
// app/api/daily-reports/[id]/pdf/route.ts
```

### 8.2 ì˜¤í”„ë¼ì¸ ëŒ€ì‘

```typescript
// ìš”êµ¬ì‚¬í•­: ë„¤íŠ¸ì›Œí¬ ë¶ˆì•ˆì • ì‹œ ë¡œì»¬ ì„ì‹œ ì €ì¥ ë° ì¬ì—…ë¡œë“œ
// í˜„ì¬ ìƒíƒœ: ê¸°ë³¸ êµ¬ì¡° ì¡´ì¬ (hooks/useOfflineSupport.tsx)

// ê°œì„  í•„ìš”:
// 1. IndexedDB ì €ì¥
import { openDB } from 'idb'

const db = await openDB('inopnc-offline', 1, {
  upgrade(db) {
    db.createObjectStore('pending-reports', { keyPath: 'id' })
    db.createObjectStore('pending-photos', { keyPath: 'id' })
  },
})

// 2. ì˜¤í”„ë¼ì¸ ê°ì§€ ë° ì €ì¥
export function useOfflineReportSync() {
  const isOnline = useOnlineStatus()

  const saveDraft = async (report: DailyReportDraft) => {
    await db.put('pending-reports', {
      ...report,
      savedAt: new Date(),
    })
  }

  const syncPendingReports = async () => {
    if (!isOnline) return

    const pending = await db.getAll('pending-reports')

    for (const report of pending) {
      try {
        await createDailyReport(report)
        await db.delete('pending-reports', report.id)
      } catch (error) {
        console.error('Sync failed:', error)
      }
    }
  }

  useEffect(() => {
    if (isOnline) {
      syncPendingReports()
    }
  }, [isOnline])

  return { saveDraft, syncPendingReports }
}
```

---

## 9. ì—­í• ë³„ ê¶Œí•œ ë° ê¸°ëŠ¥ ê²€ì¦

### 9.1 ì‘ì—…ì (Worker)

| ê¸°ëŠ¥             | êµ¬í˜„ ìƒíƒœ | ë¹„ê³             |
| ---------------- | --------- | --------------- |
| ì‘ì—…ì¼ì§€ ì‘ì„±    | âœ… ì™„ë£Œ   |                 |
| ì‚¬ì§„ ì—…ë¡œë“œ      | âœ… ì™„ë£Œ   |                 |
| ë„ë©´ ì¡°íšŒ/ë§ˆí‚¹   | âš ï¸ ë¶€ë¶„   | PDF ë·°ì–´ ë¯¸êµ¬í˜„ |
| ê¸‰ì—¬ ëª…ì„¸ì„œ í™•ì¸ | âœ… ì™„ë£Œ   |                 |
| ë‚´ ë¬¸ì„œí•¨ ê´€ë¦¬   | âœ… ì™„ë£Œ   |                 |

### 9.2 í˜„ì¥ê´€ë¦¬ì (Site Manager)

| ê¸°ëŠ¥             | êµ¬í˜„ ìƒíƒœ | ë¹„ê³              |
| ---------------- | --------- | ---------------- |
| ì „ì²´ í˜„ì¥ ê´€ë¦¬   | âœ… ì™„ë£Œ   |                  |
| ì‚¬ìš©ì ê´€ë¦¬      | âœ… ì™„ë£Œ   |                  |
| ë³´ê³ ì„œ í™•ì¸/ìˆ˜ì • | âœ… ì™„ë£Œ   | ì´ë ¥ ë¡œê·¸ ë¯¸êµ¬í˜„ |
| ê¸‰ì—¬ í™•ì •        | âœ… ì™„ë£Œ   |                  |
| ê³µí†µì–‘ì‹ ê´€ë¦¬    | âš ï¸ ë¶€ë¶„   |                  |
| ìì¬ ê´€ë¦¬        | âœ… ì™„ë£Œ   |                  |

### 9.3 íŒŒíŠ¸ë„ˆì‚¬ (Customer)

| ê¸°ëŠ¥                   | êµ¬í˜„ ìƒíƒœ    | ë¹„ê³  |
| ---------------------- | ------------ | ---- |
| í˜„ì¥ë³„ ë„ë©´ ë³´ê¸°       | âœ… ì™„ë£Œ      |      |
| ì‘ì—…ì™„ë£Œ í™•ì¸ì„œ ì—…ë¡œë“œ | âš ï¸ í™•ì¸ í•„ìš” |      |
| PTW ì¡°íšŒ               | âŒ ë¯¸êµ¬í˜„    |      |
| í•˜ìí˜„í™© ë„ë©´ ë§ˆí‚¹     | âš ï¸ ë¶€ë¶„      |      |

### 9.4 ìƒì‚°ì (Producer)

| ê¸°ëŠ¥                | êµ¬í˜„ ìƒíƒœ | ë¹„ê³  |
| ------------------- | --------- | ---- |
| ì¬ê³  ê´€ë¦¬           | âœ… ì™„ë£Œ   |      |
| ê±°ë˜ì²˜ë³„ ì¶œê³ í˜„í™©   | âœ… ì™„ë£Œ   |      |
| ì „ìì„¸ê¸ˆê³„ì‚°ì„œ ë°œí–‰ | âŒ ë¯¸êµ¬í˜„ |      |
| ê±°ë˜ëª…ì„¸ì„œ ê´€ë¦¬     | âš ï¸ ë¶€ë¶„   |      |

---

## 10. êµ¬í˜„ ë¡œë“œë§µ ë° ìš°ì„ ìˆœìœ„

### Phase 1: Critical (1-2ì£¼)

| ìˆœìœ„ | ê¸°ëŠ¥                       | ë‹´ë‹¹               | ê³µìˆ˜ |
| ---- | -------------------------- | ------------------ | ---- |
| 1    | íšŒì‚¬ëª… ê²€ìƒ‰ ë° ì„ íƒ        | Backend + Frontend | 3ì¼  |
| 2    | ì¶œë ¥ì¼ë³´ ìë™ ì—°ë™ Trigger | Backend            | 2ì¼  |
| 3    | ìˆ˜ì • ì´ë ¥ ë¡œê·¸ ì‹œìŠ¤í…œ      | Backend            | 3ì¼  |
| 4    | ì¹´ì¹´ì˜¤ ì•Œë¦¼í†¡ API ì—°ë™     | Backend            | 3ì¼  |
| 5    | ì´ë¯¸ì§€ ìë™ ì••ì¶•           | Frontend           | 1ì¼  |
| 6    | í†µí•© PDF ë³´ê³ ì„œ ìƒì„±       | Backend            | 3ì¼  |

**ì´ ê³µìˆ˜: 15ì¼ (3ì£¼)**

### Phase 2: High Priority (2-3ì£¼)

| ìˆœìœ„ | ê¸°ëŠ¥                 | ë‹´ë‹¹     | ê³µìˆ˜ |
| ---- | -------------------- | -------- | ---- |
| 1    | ì´ë©”ì¼ ì¸ì¦          | Backend  | 2ì¼  |
| 2    | íœ´ëŒ€í° ì¸ì¦          | Backend  | 3ì¼  |
| 3    | PDF ë·°ì–´ êµ¬í˜„        | Frontend | 3ì¼  |
| 4    | Undo/Redo ê¸°ëŠ¥       | Frontend | 2ì¼  |
| 5    | ì‘ì—…ì ë“œë¡­ë°•ìŠ¤ ìš°ì„  | Frontend | 1ì¼  |
| 6    | ë³´ê³ ì„œ ì¹´ì¹´ì˜¤í†¡ ê³µìœ  | Backend  | 2ì¼  |

**ì´ ê³µìˆ˜: 13ì¼ (2.5ì£¼)**

### Phase 3: Medium Priority (1-2ì£¼)

| ìˆœìœ„ | ê¸°ëŠ¥                  | ë‹´ë‹¹               | ê³µìˆ˜  |
| ---- | --------------------- | ------------------ | ----- |
| 1    | PIN ì„¤ì •              | Backend + Frontend | 2ì¼   |
| 2    | 2ë‹¨ê³„ ì¸ì¦            | Backend + Frontend | 4ì¼   |
| 3    | ë¸Œëœë“œ ì»¬ëŸ¬ ìˆ˜ì •      | Frontend           | 0.5ì¼ |
| 4    | ìš©ì–´ í†µì¼             | Frontend           | 0.5ì¼ |
| 5    | ì¬ê³  ê³„ì‚° ë™ì‹œì„± ì œì–´ | Backend            | 1ì¼   |

**ì´ ê³µìˆ˜: 8ì¼ (1.5ì£¼)**

---

## 11. ê¸°ìˆ  ìŠ¤íƒ ë° ë¼ì´ë¸ŒëŸ¬ë¦¬ ì¶”ê°€ í•„ìš”

### 11.1 ì¶”ê°€ í•„ìš” ë¼ì´ë¸ŒëŸ¬ë¦¬

```json
{
  "dependencies": {
    "browser-image-compression": "^2.0.2",
    "pdfjs-dist": "^3.11.174",
    "idb": "^7.1.1",
    "speakeasy": "^2.0.0",
    "qrcode": "^1.5.3",
    "axios": "^1.6.0"
  }
}
```

### 11.2 í™˜ê²½ ë³€ìˆ˜ ì¶”ê°€

```env
# ì¹´ì¹´ì˜¤ ì•Œë¦¼í†¡
KAKAO_API_KEY=your_api_key
KAKAO_USER_ID=your_user_id
KAKAO_SENDER=your_sender_number

# ì´ë©”ì¼ ì¸ì¦
RESEND_API_KEY=your_resend_key
# ë˜ëŠ”
SENDGRID_API_KEY=your_sendgrid_key

# SMS ì¸ì¦
SMS_API_KEY=your_sms_api_key
SMS_API_SECRET=your_sms_secret
```

---

## 12. Database Schema ì¶”ê°€/ìˆ˜ì • í•„ìš”

### 12.1 ì‹ ê·œ í…Œì´ë¸”

```sql
-- 1. íšŒì‚¬ ì¡°ì§ (organizationsëŠ” ì¡´ì¬í•˜ë‚˜ signup ì—°ë™ í•„ìš”)
-- í™•ì¸ í•„ìš”

-- 2. PIN ì„¤ì •
CREATE TABLE user_pin_settings (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES profiles(id) NOT NULL UNIQUE,
  pin_hash TEXT NOT NULL,
  enabled BOOLEAN DEFAULT true,
  last_used_at TIMESTAMP WITH TIME ZONE,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- 3. ì‘ì—…ì¼ì§€ ì´ë ¥
CREATE TABLE daily_report_history (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  daily_report_id UUID REFERENCES daily_reports(id) NOT NULL,
  changed_by UUID REFERENCES profiles(id),
  change_type TEXT CHECK (change_type IN ('created', 'updated', 'deleted')),
  old_data JSONB,
  new_data JSONB,
  changed_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  change_reason TEXT
);

-- 4. ì´ë©”ì¼/íœ´ëŒ€í° ì¸ì¦ (auth_identity_verifications ì¡´ì¬í•˜ë‚˜ í™•ì¥ í•„ìš”)
ALTER TABLE auth_identity_verifications
ADD COLUMN IF NOT EXISTS phone TEXT,
ADD COLUMN IF NOT EXISTS verification_type TEXT CHECK (verification_type IN ('email', 'phone', 'both'));

-- 5. 2ë‹¨ê³„ ì¸ì¦
CREATE TABLE user_2fa_settings (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES profiles(id) NOT NULL UNIQUE,
  secret TEXT NOT NULL,
  enabled BOOLEAN DEFAULT false,
  backup_codes TEXT[],
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

### 12.2 Trigger ì¶”ê°€

```sql
-- 1. ì¶œë ¥ì¼ë³´ ìë™ ì—°ë™
CREATE OR REPLACE FUNCTION sync_daily_report_to_attendance()
RETURNS TRIGGER AS $$
BEGIN
  INSERT INTO attendance_records (
    user_id, site_id, work_date, work_hours, status, daily_report_id
  )
  SELECT
    drw.worker_id, NEW.site_id, NEW.work_date, drw.work_hours, 'present', NEW.id
  FROM daily_report_workers drw
  WHERE drw.daily_report_id = NEW.id
  ON CONFLICT (user_id, work_date) DO UPDATE
  SET work_hours = EXCLUDED.work_hours, updated_at = NOW();

  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trigger_sync_attendance
AFTER INSERT OR UPDATE ON daily_reports
FOR EACH ROW EXECUTE FUNCTION sync_daily_report_to_attendance();

-- 2. ì‘ì—…ì¼ì§€ ì´ë ¥ ë¡œê·¸
CREATE OR REPLACE FUNCTION log_daily_report_changes()
RETURNS TRIGGER AS $$
BEGIN
  IF TG_OP = 'UPDATE' THEN
    INSERT INTO daily_report_history (
      daily_report_id, changed_by, change_type, old_data, new_data
    ) VALUES (
      NEW.id, auth.uid(), 'updated', to_jsonb(OLD), to_jsonb(NEW)
    );
  END IF;
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trigger_log_report_changes
AFTER UPDATE ON daily_reports
FOR EACH ROW EXECUTE FUNCTION log_daily_report_changes();
```

---

## 13. í…ŒìŠ¤íŠ¸ ê³„íš

### 13.1 ë‹¨ìœ„ í…ŒìŠ¤íŠ¸

```typescript
// 1. ê¸‰ì—¬ ê³„ì‚° ë¡œì§
describe('Salary Calculator', () => {
  it('should calculate 3.3% tax correctly', () => {
    const result = calculateSalary({
      baseAmount: 100000,
      workHours: 8,
      calculationType: 'tax_prepaid',
      taxRate: 3.3,
    })

    expect(result.taxAmount).toBe(3300)
    expect(result.netPay).toBe(96700)
  })
})

// 2. ì¬ê³  ê³„ì‚°
describe('Material Stock', () => {
  it('should prevent negative stock', async () => {
    await expect(updateMaterialStock('material-id', -1000)).rejects.toThrow('ì¬ê³ ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤')
  })
})
```

### 13.2 í†µí•© í…ŒìŠ¤íŠ¸

```typescript
// 1. ì‘ì—…ì¼ì§€ â†’ ì¶œë ¥ì¼ë³´ ì—°ë™
describe('Daily Report to Attendance Sync', () => {
  it('should auto-create attendance records', async () => {
    const report = await createDailyReport({
      site_id: 'site-1',
      work_date: '2025-01-22',
      workers: [{ worker_id: 'user-1', work_hours: 8 }],
    })

    const attendance = await getAttendanceRecord('user-1', '2025-01-22')
    expect(attendance).toBeDefined()
    expect(attendance.work_hours).toBe(8)
  })
})
```

### 13.3 E2E í…ŒìŠ¤íŠ¸

```typescript
// Playwright
test('complete work log flow', async ({ page }) => {
  await page.goto('/dashboard/daily-reports/new')

  // 1. í˜„ì¥ ì„ íƒ
  await page.click('[data-testid="site-select"]')
  await page.click('text=í…ŒìŠ¤íŠ¸ í˜„ì¥')

  // 2. ì‘ì—…ì ì¶”ê°€
  await page.click('[data-testid="add-worker"]')
  await page.selectOption('[data-testid="worker-select"]', 'worker-1')

  // 3. ì‚¬ì§„ ì—…ë¡œë“œ
  await page.setInputFiles('[data-testid="photo-upload"]', 'test-image.jpg')

  // 4. ì €ì¥
  await page.click('[data-testid="submit-report"]')

  // 5. ê²€ì¦
  await expect(page.locator('text=ì‘ì—…ì¼ì§€ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤')).toBeVisible()
})
```

---

## 14. ë°°í¬ ë° ëª¨ë‹ˆí„°ë§

### 14.1 ë°°í¬ ì²´í¬ë¦¬ìŠ¤íŠ¸

- [ ] í™˜ê²½ ë³€ìˆ˜ ì„¤ì • (ì¹´ì¹´ì˜¤, SMS, ì´ë©”ì¼)
- [ ] Database Migration ì‹¤í–‰
- [ ] Trigger ìƒì„± í™•ì¸
- [ ] Cron Job ì„¤ì • (ì˜¤í›„ 4ì‹œ ì•Œë¦¼)
- [ ] ì´ë¯¸ì§€ ì••ì¶• ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì¹˜
- [ ] PDF.js ì›Œì»¤ íŒŒì¼ ë°°í¬

### 14.2 ëª¨ë‹ˆí„°ë§ í•­ëª©

```typescript
// 1. ì•Œë¦¼ ë°œì†¡ ì„±ê³µë¥ 
// 2. PDF ìƒì„± ì„±ê³µë¥ 
// 3. ì´ë¯¸ì§€ ì—…ë¡œë“œ ì„±ê³µë¥ 
// 4. ì¬ê³  ê³„ì‚° ì˜¤ë¥˜ìœ¨
// 5. API ì‘ë‹µ ì‹œê°„

// Sentry ë˜ëŠ” LogRocket ì—°ë™ ê¶Œì¥
```

---

## 15. ê²°ë¡  ë° ê¶Œì¥ì‚¬í•­

### 15.1 ì¦‰ì‹œ êµ¬í˜„ í•„ìš” (Critical)

1. **íšŒì‚¬ëª… ê²€ìƒ‰ ê¸°ëŠ¥** - íšŒì›ê°€ì… í”Œë¡œìš°ì˜ í•µì‹¬
2. **ì¶œë ¥ì¼ë³´ ìë™ ì—°ë™** - ë°ì´í„° ì •í•©ì„± ë³´ì¥
3. **ì¹´ì¹´ì˜¤ ì•Œë¦¼í†¡ ì—°ë™** - ì‚¬ìš©ì ê²½í—˜ í•µì‹¬
4. **ì´ë¯¸ì§€ ìë™ ì••ì¶•** - ìŠ¤í† ë¦¬ì§€ ë¹„ìš© ì ˆê°
5. **ìˆ˜ì • ì´ë ¥ ë¡œê·¸** - ê°ì‚¬ ì¶”ì  í•„ìˆ˜

### 15.2 ë‹¨ê³„ì  êµ¬í˜„ ê°€ëŠ¥ (High)

1. **PDF ë·°ì–´** - SVGë¡œ ìš°ì„  ìš´ì˜ ê°€ëŠ¥
2. **2ë‹¨ê³„ ì¸ì¦** - ë³´ì•ˆ ê°•í™” (ì„ íƒì )
3. **Undo/Redo** - UX ê°œì„  (ì„ íƒì )

### 15.3 ê¸°ìˆ  ë¶€ì±„ ê´€ë¦¬

1. **TypeScript any íƒ€ì… ì œê±°** - íƒ€ì… ì•ˆì •ì„± ê°•í™”
2. **ì»´í¬ë„ŒíŠ¸ ë¦¬íŒ©í† ë§** - ì¬ì‚¬ìš©ì„± í–¥ìƒ
3. **API ì‘ë‹µ í‘œì¤€í™”** - ì¼ê´€ì„± í™•ë³´
4. **ì—ëŸ¬ í•¸ë“¤ë§ í†µì¼** - ì‚¬ìš©ì ê²½í—˜ ê°œì„ 

---

## ë¶€ë¡ A: API ì—”ë“œí¬ì¸íŠ¸ ëª…ì„¸

### A.1 ì‹ ê·œ API í•„ìš”

```typescript
// 1. íšŒì‚¬ ê²€ìƒ‰
GET /api/organizations/search?q={query}

// 2. ì´ë©”ì¼ ì¸ì¦
POST /api/auth/verify-email/send
POST /api/auth/verify-email/confirm

// 3. íœ´ëŒ€í° ì¸ì¦
POST /api/auth/verify-phone/send
POST /api/auth/verify-phone/confirm

// 4. ì¹´ì¹´ì˜¤ ì•Œë¦¼í†¡
POST /api/notifications/kakao/send

// 5. ì‘ì—…ì¼ì§€ ì´ë ¥
GET /api/daily-reports/{id}/history

// 6. í†µí•© PDF ìƒì„±
GET /api/daily-reports/{id}/pdf/full
```

---

## ë¶€ë¡ B: ìš©ì–´ ì‚¬ì „

| í•œê¸€      | ì˜ë¬¸              | ë¹„ê³                |
| --------- | ----------------- | ------------------ |
| ì‘ì—…ì¼ì§€  | Daily Report      | Work Logì™€ í˜¼ìš© ì¤‘ |
| ì¶œë ¥ì¼ë³´  | Attendance Report |                    |
| ì‚¬ì§„ëŒ€ì§€  | Photo Sheet       | Photo Gridì™€ í˜¼ìš©  |
| ë„ë©´ ë§ˆí‚¹ | Drawing Markup    |                    |
| ë¶€ì¬ëª…    | Member Name       | ë¶€ìœ„ëª…ì—ì„œ ë³€ê²½    |
| ê³µìˆ˜      | Labor Hours       | Man-hours          |
| ì›ì²œì„¸    | Withholding Tax   |                    |

---

**ë¬¸ì„œ ë²„ì „**: 1.0  
**ìµœì¢… ìˆ˜ì •ì¼**: 2025-01-22  
**ì‘ì„±ì**: Senior Development Team  
**ê²€í†  í•„ìš”**: âœ… Backend Lead, âœ… Frontend Lead, âœ… PM
