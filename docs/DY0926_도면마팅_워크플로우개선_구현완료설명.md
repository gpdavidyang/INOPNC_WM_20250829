# DY0926 도면마팅 워크플로우 개선 – 구현 완료 설명

## 1) 개요

- 목적: 공도면 미등록/오류 상황에서도 사용자가 자연스럽게 마킹을 시작·저장할 수 있도록 UX 보완, 마킹 산출물을 서버에 정식 보관, 작업일지와의 연계를 표준화.
- 범위: 홈 > 도면마킹 섹션, 마킹 도구(/mobile/markup-tool), 작업일지 베타 화면(/mobile/worklogs), 백엔드 마킹/작업일지 API.

---

## 2) Phase 1 – 빠른 UX 보완 (완료)

### 홈 > 도면마킹(DrawingQuickAction)

- 공도면 조회 실패/미등록 안내 + 대체 경로 CTA 추가
  - 촬영본 업로드(저장): `/mobile/markup-tool?mode=upload&source=photo&saveOnly=1`
  - 사진으로 마킹하기(디지털): `/mobile/markup-tool?mode=upload&source=photo`
  - 재시도 버튼
- 다건 선택 모달: 대표 도면 자동 선택 + 리스트에서 다른 공도면 선택 가능
- 최근 마킹 표시: 서버 `/api/markup-documents/list?site_id=` 우선, 없으면 localStorage fallback
- 파라미터 기반 진입: “마킹 시작” → `/mobile/markup-tool?mode=start&siteId=...&docId=...`
- 파일: `modules/mobile/components/home/DrawingQuickAction.tsx`

### 저장 UX/데이터 신뢰성 기반 마련

- 작업일지 폼 저장/임시저장 → `/api/mobile/daily-reports` (React Query mutation)
- 자재 사용 입력 컴포넌트 추가 → payload `materials`로 전달
- 백엔드 `/api/mobile/daily-reports` 정리: 불필요 필드 옵션화/제거, `location_info`/`additional_notes` 저장, 공수 합계로 `total_workers` 계산
- 파일: `modules/mobile/components/home/HomePage.tsx`, `modules/mobile/components/home/MaterialsInput.tsx`, `modules/mobile/hooks/use-worklog-mutations.ts`, `app/api/mobile/daily-reports/route.ts`

---

## 3) Phase 2 – 서버 보관/연계 강화 (진행 중, 1차 완료)

### 마킹 도구 저장 → 서버 보관 + 작업일지 링크

- 저장 시 `/api/markup-documents` POST로 문서 생성
- URL 파라미터의 `worklogId`가 있으면 `PATCH /api/markup-documents/{id}`로 `linked_worklog_id` 연결
- 저장 성공 후 캐시 무효화: `['worklogs']`, `['worklog-calendar']`, `['markup-documents']`
- 파일: `app/mobile/markup-tool/page.tsx`, `app/api/markup-documents/[id]/route.ts`, `app/api/markup-documents/route.ts`

### 작업일지 상세에서 마킹 문서 목록/미리보기/열기

- 상세 뷰어(풀스크린)에 “진행도면(마킹)” 섹션 추가
- `/api/markup-documents?worklogId=...`로 연결 문서 조회, 미리보기(가능 시 preview/blueprint) 노출, 문서별 “열기” 버튼으로 마킹 도구 진입
- 파일: `modules/mobile/components/worklogs/DiaryDetailViewer.tsx`, `app/mobile/worklogs/page.tsx`

### 대표 도면 우선순위/정렬

- 대표 플래그 최우선(`is_primary_blueprint` | `isPrimary` | `metadata.is_primary`) → 업로드 최신순 정렬
- 파일: `modules/mobile/components/home/DrawingQuickAction.tsx`

---

## 4) 엔드포인트/계약 요약

- 마킹 목록(작업일지 링크 기준): `GET /api/markup-documents?worklogId=...`
- 마킹 생성: `POST /api/markup-documents` (title, original_blueprint_url, ...)
- 마킹 링크 업데이트: `PATCH /api/markup-documents/{id}` { linked_worklog_id }
- 최근 마킹(서버): `GET /api/markup-documents/list?site_id=...`
- 작업일지 생성/임시저장: `POST /api/mobile/daily-reports`
  - payload 정리: total_workers(공수 합계), location_info, additional_notes(memberTypes/processes/workTypes/추가인력 등), materials

---

## 5) 사용 방법(핵심 흐름)

1. 홈 > 도면마킹

- 현장 선택 → 공도면/최근마킹 로드
- 공도면 존재: “마킹 시작” 활성(파라미터 전달)
- 미등록/오류: 촬영본 업로드/사진으로 마킹하기/재시도
- 공도면 다건: “다른 공도면 선택하기” 모달

2. 마킹 도구(/mobile/markup-tool)

- 저장 → 서버 문서 생성 + (있으면) 작업일지 링크 → 캐시 무효화 → 복귀

3. 작업일지 상세(/mobile/worklogs)

- “진행도면(마킹)” 탭에서 연결 문서 목록/미리보기/열기 지원

---

## 6) 변경 파일(주요)

- 홈: `modules/mobile/components/home/DrawingQuickAction.tsx`, `modules/mobile/components/home/HomePage.tsx`, `modules/mobile/components/home/MaterialsInput.tsx`
- 마킹 도구: `app/mobile/markup-tool/page.tsx`
- 작업일지 베타: `app/mobile/worklogs/page.tsx`, `modules/mobile/components/worklogs/DiaryDetailViewer.tsx`
- API: `app/api/mobile/daily-reports/route.ts`, `app/api/markup-documents/route.ts`, `app/api/markup-documents/[id]/route.ts`, `app/api/markup-documents/list/route.ts`

---

## 7) 한계/보완 예정(다음 단계)

- 관리자(현장관리)에서 대표 도면 플래그 관리 UI 추가 및 프런트 정렬 기준 완전 반영
- 마킹 도구 초기화/이어하기에서 서버 데이터 prefetch 최적화
- 작업일지 상세 마킹 썸네일 품질 개선, 가로 스크롤/모달 뷰
- IndexedDB 보조 캐시/오프라인 전략 정교화

---

## 8) 검증 포인트

- 공도면 미등록 현장에서 대체 경로를 통해 마킹 저장 가능
- 저장된 마킹 문서가 해당 작업일지 상세의 마킹 탭에 나타나고, 열기로 도구 진입 가능
- 홈/작업일지 화면이 저장 직후 최신 데이터로 갱신(캐시 무효화)

---

## 9) 부록 – 파라미터 규칙

- 홈 → 마킹 시작: `/mobile/markup-tool?mode=start&siteId={siteId}&docId={docId}`
- 작업일지 상세 → 마킹 열기(문서별): `/mobile/markup-tool?mode=start&siteId={siteId}&worklogId={worklogId}&docId={docId}`
- 작업일지 상세 → 마킹 열기(브라우즈): `/mobile/markup-tool?mode=browse&siteId={siteId}&worklogId={worklogId}`

---

본 결과물은 기존 localStorage 의존도를 줄이고(서버 SSOT), 작업일지/현장관리/마킹을 하나의 흐름으로 연결하는 기반을 제공합니다.

---
