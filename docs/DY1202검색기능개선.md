# DY1202 검색 기능 개선 계획

## 1) 역할별 현재 상태 점검

- 본사관리자(관리자/Admin): 상단 헤더 `GlobalSearchModal`이 `/api/admin/global-search`를 호출하도록 연결됨. 검색 대상 = 현장(name/address), 사용자(full_name/email), 작업일지(member_name/process_type/work_description + site), 문서(title/description/file_name + site), 엔티티별 최대 5건. 권한: admin/system_admin만 허용.
- 생산관리자(Production Manager, 모바일 `/mobile/production/*` 포함): 상단 AppBar 검색은 `SearchPage`(모듈 공용)를 띄우며 `/api/announcements?search=`로 공지사항만 조회. 다른 엔티티 검색 불가.
- 파트너사(Partner/Customer Manager, `/mobile/partner`): PartnerMobileLayout도 동일 AppBar/`SearchPage` 사용 → 공지사항 검색만 가능. 데스크톱 파트너 화면에 전용 글로벌 검색 없음.

## 2) 문제점

- 관리자만 멀티-엔터티 검색 가능; 생산/파트너 역할은 공지사항으로 제한.
- 역할/접근 범위에 따른 데이터 필터링이 모바일 검색에 적용되지 않아, 향후 확장 시 권한 체크 설계 필요.
- 검색 UI/UX가 역할별로 다르게 동작해 일관성이 부족.

## 3) 개선 목표

- 역할별로 허용된 범위 내에서 상단 검색이 동일한 패턴으로 동작.
- 엔티티별 결과 cap: 본사관리자 20건, 기타 역할 5건으로 빠른 응답.
- 역할/소속(organization_id, partner_company_id, site scope)에 따른 안전한 필터링.

## 4) 구현 계획 (역할/범위별)

- 공통 백엔드
  - `/api/admin/global-search`를 `/api/search/global`로 확장하거나 파라미터(`role`, `scopes`)에 따라 분기:
    - admin/system_admin: 기존 대상 유지.
    - production_manager/site_manager: 본인 관리/할당된 site_id 리스트로 sites/daily_reports/문서 제한.
    - partner/customer_manager: restrictedOrgId/partner_company_id로 sites/daily_reports/문서 제한, 사용자 검색은 자기 조직/파트너 소속만.
  - 엔티티별 `limit=5` 기본, `max=20` 유지.
  - 필드:
    - 현장: name, address
    - 사용자: full_name, email
    - 작업일지: member_name, process_type, work_description, site.name
    - 문서: title, description, file_name, site.name
  - 인덱스 권장: `sites(name, address) gin_trgm`, `profiles(full_name, email) gin_trgm`, `daily_reports(member_name, process_type, work_description) gin_trgm`, `unified_document_system(title, description, file_name) gin_trgm`.

- 관리자 (본사) 프론트
  - 현행 `GlobalSearchModal` 유지, 단 엔티티 섹션 헤더/그룹핑 추가(가독성) + `limit=20`로 요청.

- 생산관리자 프론트 (모바일 AppBar)
  - `SearchPage`를 멀티-엔터티 검색으로 전환: API 호출을 `/api/search/global`로 변경, 역할/스코프는 서버에서 해석.
  - 결과 섹션: 작업일지, 현장, 문서, (공지사항은 별도 탭/하단).
  - 결과 클릭 시: 작업일지 → `/mobile/daily-reports/{id}`, 현장 → `/mobile/sites/{id}`, 문서 → `/documents/hub` 혹은 뷰어 DeepLink.

- 파트너사 프론트 (PartnerMobileLayout)
  - 동일 `SearchPage` 개선 버전 재사용, 단 결과는 파트너 소속 현장/문서/작업일지만 노출.
  - 사용자 검색은 파트너 조직 소속만 반환하거나 비활성화 옵션 제공.

## 5) 작업 단위/우선순위

1. 백엔드: `/api/search/global` 신설 또는 기존 확장 (role-aware 필터, per-entity 5 cap, error/log 관리).
2. 프론트: `SearchPage` 리팩터 (멀티 섹션 렌더, 로딩/empty 상태) + 클릭 라우팅.
3. 프론트: `GlobalSearchModal` 섹션 헤더 추가(선택) 및 서버 결과 스키마 정합성 확인.
4. 검증: admin/production_manager/customer_manager/partner 계정으로 E2E 스모크(각 역할에서 200/403/필터링 확인), 성능 측정(응답 < 300ms@p95 목표).
5. 인덱스 적용 및 쿼리 분석(EXPLAIN) 후 릴리스.

## 6) 역할별 권한 체크 요약

- admin/system_admin: 전체 데이터.
- production_manager/site_manager: 접근 가능한 site_id로 제한(사이트·작업일지·문서 join 조건 필수).
- partner/customer_manager: restrictedOrgId/partner_company_id 기반 site/문서/작업일지 제한, 사용자 검색은 동일 조직/파트너만.
- worker: 글로벌 검색 비노출(현행 유지).

## 7) 성능/품질

- 엔티티별 cap: admin 20, 그 외 기본 5(파라미터 상향은 20까지 허용).
- OR `ilike` 사용 시 prefix 매치 부하 완화 위해 trigram 인덱스 권장.
- 부분 실패 시 빈 배열로 복구, 서버 로그에 에러 기록(현재 구현과 동일).

## 8) 예상 산출물

- API: `app/api/search/global/route.ts` (또는 기존 경로 확장)
- UI: `modules/mobile/components/layout/SearchPage.tsx` 리팩터, `components/admin/legacy/GlobalSearchModal.tsx` 섹션 헤더 옵션
- 테스트: 역할별 수동 체크 리스트 +(선택) Playwright 스모크
