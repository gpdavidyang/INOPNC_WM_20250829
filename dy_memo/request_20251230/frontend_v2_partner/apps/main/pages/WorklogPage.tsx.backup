import React, { useState, useEffect } from 'react';
import { PlusCircle, Search, ChevronDown, ClipboardList, Package, Camera, Map as MapIcon, FileCheck as FileCheckIcon, AlertCircle, Check, Users, Pin, CheckCircle, CalendarDays, ChevronUp, X } from 'lucide-react';
import { MOCK_LOGS } from '../../worklog/constants';
import { WorkLog, LogStatus } from '@inopnc/shared';
import WorkLogDetail from '../../worklog/components/WorkLogDetail';
import SmartCreateSheet from '../../worklog/components/SmartCreateSheet';

type ViewMode = 'dashboard' | 'timeline';

const WorklogPage: React.FC = () => {
  const [logs, setLogs] = useState<WorkLog[]>(MOCK_LOGS);
  const [currentFilter, setCurrentFilter] = useState<LogStatus | 'all'>('all');
  const [sortOrder, setSortOrder] = useState<'latest' | 'name' | 'pinned'>('latest');
  const [searchQuery, setSearchQuery] = useState('');
  
  // List Management: Month Filter (YYYY-MM)
  const [selectedMonth, setSelectedMonth] = useState<string>(new Date().toISOString().slice(0, 7));

  // View State
  const [viewMode, setViewMode] = useState<ViewMode>('dashboard');
  const [timelineStatus, setTimelineStatus] = useState<LogStatus | null>(null);

  // Batch Selection State
  const [selectedIds, setSelectedIds] = useState<Set<number>>(new Set());

  // Modal & Sheet State
  const [selectedLog, setSelectedLog] = useState<WorkLog | null>(null);
  const [isSmartCreateOpen, setIsSmartCreateOpen] = useState(false);
  const [visibleCount, setVisibleCount] = useState(5);

  // Toast State
  const [toast, setToast] = useState<{ show: boolean, msg: string }>({ show: false, msg: '' });

  // Load shared data on mount
  useEffect(() => {
    try {
      const sharedLogs = localStorage.getItem('inopnc_work_log');
      if (sharedLogs) {
        const parsedLogs = JSON.parse(sharedLogs);
        // Convert shared format to WorkLog format
        const convertedLogs = parsedLogs.map((log: any) => ({
          id: parseInt(log.id.replace('LOG-', '')),
          site: log.siteName,
          siteId: log.siteId,
          date: log.workDate,
          status: log.status === '작성중' ? 'draft' : log.status,
          affiliation: log.dept,
          member: log.workSets?.[0]?.member || '',
          process: log.workSets?.[0]?.process || '',
          type: log.workSets?.[0]?.type || '',
          location: log.workSets?.[0]?.location?.floor || '',
          manpower: log.manpower ? [{ role: '작업자', val: log.manpower, worker: '작업자' }] : [],
          materials: [],
          photos: [],
          drawings: [],
          confirmationFiles: [],
          missing: [],
          rejectReason: undefined,
          isPinned: false,
          updatedAt: log.updatedAt || `${log.workDate} 09:00`
        }));
        setLogs([...convertedLogs, ...MOCK_LOGS]);
      }
    } catch (e) {
      console.error('Failed to load shared logs', e);
    }
  }, []);

  // Reset selection when changing views
  useEffect(() => {
    setSelectedIds(new Set());
  }, [viewMode, timelineStatus]);

  // --- Helper: Toast ---
  const showToast = (msg: string) => {
    setToast({ show: true, msg });
    setTimeout(() => setToast(prev => ({ ...prev, show: false })), 2000);
  };

  // --- Sorting & Filtering Logic ---
  const getSortedLogs = (sourceLogs: WorkLog[]) => {
    return [...sourceLogs].sort((a, b) => {
      if (sortOrder === 'pinned') {
          if (a.isPinned && !b.isPinned) return -1;
          if (!a.isPinned && b.isPinned) return 1;
          return new Date(b.date).getTime() - new Date(a.date).getTime();
      } else if (sortOrder === 'name') {
          return a.site.localeCompare(b.site) || new Date(b.date).getTime() - new Date(a.date).getTime();
      } else {
          return new Date(b.date).getTime() - new Date(a.date).getTime();
      }
    });
  };

  const dashboardLogs = getSortedLogs(logs).filter(log => {
    const matchStatus = currentFilter === 'all' || log.status === currentFilter;
    const matchSearch = log.site.toLowerCase().includes(searchQuery.toLowerCase());
    const matchMonth = log.date.startsWith(selectedMonth); // Filter by Month
    return matchStatus && matchSearch && matchMonth;
  });

  const timelineLogs = getSortedLogs(logs).filter(log => {
    const matchStatus = log.status === timelineStatus;
    const matchMonth = log.date.startsWith(selectedMonth); // Filter by Month
    return matchStatus && matchMonth;
  });

  const displayLogs = dashboardLogs.slice(0, visibleCount);

  // --- Handlers ---
  const handleDashboardFilter = (status: LogStatus | 'all') => {
    setCurrentFilter(status);
    setVisibleCount(5);
  };

  const handleSummaryClick = (status: LogStatus) => {
    setTimelineStatus(status);
    setViewMode('timeline');
    window.scrollTo(0, 0);
  };


  // Replaced direct creation with Smart Create Sheet opening
  const handleOpenSmartCreate = () => {
    setIsSmartCreateOpen(true);
  };

  const handleSmartCreateSubmit = (newLog: WorkLog) => {
    setLogs(prev => [newLog, ...prev]);
    setIsSmartCreateOpen(false);
    showToast("일지가 생성되었습니다. 상세내역을 입력하세요.");
    // Optional: Open the details immediately for the user to add photos
    // setSelectedLog(newLog); 
  };

  const handleSaveLog = (updatedLog: WorkLog) => {
    setLogs(prev => {
        const exists = prev.find(l => l.id === updatedLog.id);
        if (exists) {
            return prev.map(l => l.id === updatedLog.id ? updatedLog : l);
        }
        return [updatedLog, ...prev];
    });
    setSelectedLog(null);
    showToast("저장되었습니다.");
  };

  
  const handleTogglePin = (e: React.MouseEvent, id: number) => {
    e.stopPropagation();
    setLogs(prev => prev.map(log => 
        log.id === id ? { ...log, isPinned: !log.isPinned } : log
    ));
  };

  // --- Batch Selection Handlers ---
  const toggleSelection = (id: number) => {
    setSelectedIds(prev => {
        const next = new Set(prev);
        if (next.has(id)) next.delete(id);
        else next.add(id);
        return next;
    });
  };

  const handleBatchApprove = () => {
    if (selectedIds.size === 0) return alert('선택된 항목이 없습니다.');
    if (!confirm(`선택한 ${selectedIds.size}건을 통합 승인요청 하시겠습니까?`)) return;

    const now = new Date();
    const timestamp = `${now.toISOString().split('T')[0]} ${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;

    setLogs(prev => prev.map(log => 
        selectedIds.has(log.id) ? { ...log, status: 'pending', updatedAt: timestamp } : log
    ));
    
    showToast(`${selectedIds.size}건이 승인요청 되었습니다.`);
    setSelectedIds(new Set());
  };

  // --- Duplication Logic (Efficient Creation) ---
  const handleDuplicateLog = (logToCopy: WorkLog) => {
    const today = new Date().toISOString().split('T')[0];
    const newLog: WorkLog = {
        ...logToCopy, // Copy Site, Affiliation, Manpower, Materials, Drawings
        id: Date.now(), // New ID
        date: today, // Today's Date
        status: 'draft', // Reset to Draft
        photos: [], // Clear Daily Photos
        drawings: logToCopy.drawings, // Keep Drawings (often reused)
        confirmationFiles: [], // Clear Confirmation
        missing: [], // Clear Alerts
        rejectReason: undefined, 
        isDirect: true, // Treat as new entry
        isPinned: false
    };
    
    setLogs(prev => [newLog, ...prev]);
    setSelectedLog(newLog); 
    showToast("오늘 일자로 복사되었습니다. 내용을 수정하세요.");
  };


  const isSelectionEnabled = timelineStatus === 'draft' || timelineStatus === 'rejected';

  return (
    <div className="w-full max-w-[600px] mx-auto p-4 box-border pt-0" style={{ paddingBottom: '10px' }}>
      
      {/* ================= DASHBOARD VIEW ================= */}
      {viewMode === 'dashboard' && (
        <div className="animate-fade-in">
            {/* Sticky Header */}
            <div className="relative z-50 bg-bg-body -ml-4 -mr-4 px-4 pt-1 pb-1 mb-1 transition-colors">
                {/* Search */}
                <div className="relative mb-2 flex items-center group">
                    <input 
                        type="text" 
                        className="
                            w-full h-[54px] rounded-2xl bg-white border border-slate-200 px-[22px] pr-12 text-[17px] text-text-main font-medium 
                            transition-all duration-200 ease-out 
                            hover:border-slate-300 
                            focus:outline-none focus:bg-white dark:focus:bg-slate-800 
                            focus:border-[#31a3fa] focus:border-[1.5px] 
                            focus:shadow-[0_0_0_3px_rgba(49,163,250,0.15)] 
                            cursor-pointer focus:cursor-text
                        "
                        placeholder="현장명을 입력하세요."
                        value={searchQuery}
                        onChange={(e) => setSearchQuery(e.target.value)}
                    />
                    {searchQuery ? (
                        <button 
                            onClick={() => setSearchQuery('')}
                            className="absolute right-3.5 top-1/2 -translate-y-1/2 bg-slate-300 text-white rounded-full w-[22px] h-[22px] flex items-center justify-center border-none cursor-pointer"
                        >
                            <X size={14} />
                        </button>
                    ) : (
                        <Search className="absolute right-[18px] top-1/2 -translate-y-1/2 text-[#cbd5e1] pointer-events-none" size={20} />
                    )}
                </div>

                {/* Filters */}
                <div className="flex gap-2 mb-4 w-full">
                    <select 
                        className="flex-1 h-[54px] bg-white border border-slate-200 rounded-xl px-3.5 text-[17px] font-semibold text-text-main shadow-soft focus:outline-none focus:border-primary focus:shadow-[0_0_0_3px_rgba(49,163,250,0.15)] appearance-none"
                        value={sortOrder}
                        onChange={(e) => setSortOrder(e.target.value as any)}
                        style={{backgroundImage: `url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='20' height='20' viewBox='0 0 24 24' fill='none' stroke='%23333333' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E")`, backgroundRepeat: 'no-repeat', backgroundPosition: 'right 16px center'}}
                    >
                        <option value="latest">최신순</option>
                        <option value="name">이름순</option>
                    </select>
                    <input 
                        type="month" 
                        className="flex-1 h-[54px] bg-white border border-slate-200 rounded-xl px-3.5 text-[17px] font-semibold text-text-main shadow-soft focus:outline-none focus:border-primary focus:shadow-[0_0_0_3px_rgba(49,163,250,0.15)]"
                        value={selectedMonth}
                        onChange={(e) => setSelectedMonth(e.target.value)}
                    />
                </div>

                {/* Chip Filter */}
                <div className="overflow-hidden relative">
                    <div className="flex w-full gap-1.5 overflow-x-auto pb-1 items-center scrollbar-hide">
                        <FilterChip label="전체" active={currentFilter === 'all'} onClick={() => handleDashboardFilter('all')} />
                        <FilterChip label="작성중" active={currentFilter === 'draft'} onClick={() => handleDashboardFilter('draft')} />
                        <FilterChip label="반려됨" active={currentFilter === 'rejected'} onClick={() => handleDashboardFilter('rejected')} />
                        <FilterChip label="승인요청" active={currentFilter === 'pending'} onClick={() => handleDashboardFilter('pending')} />
                        <FilterChip label="승인완료" active={currentFilter === 'approved'} onClick={() => handleDashboardFilter('approved')} />
                    </div>
                </div>
            </div>

            {/* Summary Cards */}
            <div className="grid grid-cols-4 gap-2 mb-3">
                <SummaryCard label="작성중" count={logs.filter(l => l.status === 'draft').length} type="draft" onClick={() => handleSummaryClick('draft')} />
                <SummaryCard label="반려" count={logs.filter(l => l.status === 'rejected').length} type="rejected" onClick={() => handleSummaryClick('rejected')} />
                <SummaryCard label="승인요청" count={logs.filter(l => l.status === 'pending').length} type="pending" onClick={() => handleSummaryClick('pending')} />
                <SummaryCard label="승인완료" count={logs.filter(l => l.status === 'approved').length} type="approved" onClick={() => handleSummaryClick('approved')} />
            </div>

            {/* Add Button - Opens Smart Create Sheet */}
            <button 
                onClick={handleOpenSmartCreate}
                className="w-full h-[54px] rounded-[14px] text-[17px] font-bold flex items-center justify-center gap-2 cursor-pointer border border-dashed border-primary text-primary bg-white mb-3 active:bg-primary-bg transition"
            >
                <PlusCircle className="w-[22px] h-[22px]" /> 새 작업일지 등록
            </button>

            {/* Log List */}
            <div className="flex flex-col gap-2.5 pb-2">
                {displayLogs.length === 0 ? (
                    <div className="text-center py-10 text-text-sub flex flex-col items-center gap-2">
                         <CalendarDays className="w-8 h-8 text-gray-300" />
                         <span className="text-[15px] font-bold">해당 월에 데이터가 없습니다.</span>
                    </div>
                ) : (
                    displayLogs.map(log => (
                        <LogCard key={log.id} log={log} onClick={() => setSelectedLog(log)} onPinClick={handleTogglePin} />
                    ))
                )}
            </div>

            {/* Load More / Collapse Button */}
            {dashboardLogs.length > 5 && (
                <div className="pb-2">
                    {visibleCount < dashboardLogs.length ? (
                        <button 
                            onClick={() => setVisibleCount(prev => prev + 5)}
                            className="w-full h-[50px] flex items-center justify-center gap-1.5 bg-white border border-[#e2e8f0] rounded-full text-[15px] font-bold text-text-sub hover:bg-gray-50 active:scale-[0.98] transition shadow-sm"
                        >
                            더 보기 <ChevronDown className="w-4 h-4" />
                        </button>
                    ) : (
                        <button 
                            onClick={() => setVisibleCount(5)}
                            className="w-full h-[50px] flex items-center justify-center gap-1.5 bg-white border border-[#e2e8f0] rounded-full text-[15px] font-bold text-text-sub hover:bg-gray-50 active:scale-[0.98] transition shadow-sm"
                        >
                            접기 <ChevronUp className="w-4 h-4" />
                        </button>
                    )}
                </div>
            )}
        </div>
      )}

      {/* ================= TIMELINE VIEW ================= */}
      {viewMode === 'timeline' && (
        <div className="animate-slide-up pb-[calc(90px+env(safe-area-inset-bottom))]">
            <div className="px-0 pt-2">
                <div className="text-[15px] font-bold text-text-sub mb-3 px-4">* 날짜를 클릭하여 상세 내용을 확인/수정하세요.</div>
                
                <div className="flex flex-col gap-2.5 px-4">
                    {timelineLogs.length === 0 ? (
                        <div className="text-center py-10 text-text-sub">데이터가 없습니다.</div>
                    ) : (
                        timelineLogs.map(log => (
                            <TimelineItem 
                                key={log.id} 
                                log={log} 
                                selectable={isSelectionEnabled}
                                selected={selectedIds.has(log.id)}
                                onToggle={() => toggleSelection(log.id)}
                                onClick={() => setSelectedLog(log)} 
                            />
                        ))
                    )}
                </div>
            </div>

            {/* Sticky Footer for Bulk Action */}
            {isSelectionEnabled && (
                <div className="fixed bottom-0 left-0 right-0 bg-white border-t border-[#e2e8f0] px-3 pt-3 pb-[calc(12px+env(safe-area-inset-bottom))] z-[90] flex justify-center shadow-[0_-4px_15px_rgba(0,0,0,0.05)]">
                    <div className="w-full max-w-[600px] px-2">
                        <button 
                            onClick={handleBatchApprove}
                            disabled={selectedIds.size === 0}
                            className={`w-full h-[56px] rounded-2xl text-lg font-extrabold transition flex items-center justify-center gap-2
                                ${selectedIds.size > 0 
                                    ? 'bg-header-navy text-white hover:opacity-90' 
                                    : 'bg-gray-200 text-gray-500 cursor-not-allowed'}`}
                        >
                            {selectedIds.size > 0 ? `${selectedIds.size}건 통합 승인요청` : '통합 승인요청'}
                        </button>
                    </div>
                </div>
            )}
        </div>
      )}

      {/* Detail Modal */}
      {selectedLog && (
        <WorkLogDetail 
            key={selectedLog.id}
            log={selectedLog} 
            onClose={() => setSelectedLog(null)} 
            onSave={handleSaveLog}
            onDuplicate={handleDuplicateLog}
        />
      )}

      {/* Smart Create Sheet (Replaces QuickCreateSheet) */}
      {isSmartCreateOpen && (
        <SmartCreateSheet 
            isOpen={isSmartCreateOpen}
            onClose={() => setIsSmartCreateOpen(false)}
            onSubmit={handleSmartCreateSubmit}
            initialSiteId="all"
        />
      )}

      {/* Toast Message */}
      <div className={`fixed bottom-[90px] left-1/2 transform -translate-x-1/2 bg-[rgba(15,23,42,0.95)] text-white px-6 py-3 rounded-full text-[15px] font-bold flex items-center gap-2 shadow-xl z-[3000] transition-all duration-300 pointer-events-none ${toast.show ? 'opacity-100 translate-y-0' : 'opacity-0 translate-y-4'}`}>
        <CheckCircle className="w-[18px] h-[18px] text-green-400" />
        <span>{toast.msg}</span>
      </div>

      </div>
  );
};

// --- Sub Components ---

const SummaryCard: React.FC<{ label: string, count: number, type: string, onClick: () => void }> = ({ label, count, type, onClick }) => {
    let styleClass = "bg-white text-text-main border-transparent";
    if (type === 'draft') styleClass = "bg-primary-bg text-primary border-primary";
    else if (type === 'rejected') styleClass = "bg-white text-red-500 border-red-500";
    else if (type === 'pending') styleClass = "bg-[#f0f3f9] text-[#1e3a8a] border-[#1e3a8a]";
    else if (type === 'approved') styleClass = "bg-[#f4f6fa] text-[#475569] border-[#475569]";

    return (
        <div 
            onClick={onClick}
            className={`h-[90px] rounded-2xl flex flex-col items-center justify-center cursor-pointer shadow-sm border transition active:scale-95 ${styleClass}`}
        >
            <span className="text-2xl font-extrabold leading-none mb-1">{count}</span>
            <span className="text-[13px] font-bold">{label}</span>
        </div>
    );
};

const FilterChip: React.FC<{ label: string, active: boolean, onClick: () => void }> = ({ label, active, onClick }) => (
    <button 
        onClick={onClick}
        className={`flex-1 min-w-fit h-[40px] px-1 rounded-full text-[13px] font-bold border transition flex items-center justify-center whitespace-nowrap
            ${active ? 'border-primary text-primary bg-white shadow-[0_2px_6px_rgba(49,163,250,0.15)]' : 'bg-white border-[#e2e8f0] text-text-sub'}
        `}
    >
        {label}
    </button>
);

const LogCard: React.FC<{ log: WorkLog, onClick: () => void, onPinClick: (e: React.MouseEvent, id: number) => void }> = ({ log, onClick, onPinClick }) => {
    let statusBadge = <div className="bg-blue-500 text-white rounded-tr-xl rounded-bl-xl px-3.5 py-1.5 text-[13px] font-extrabold absolute top-0 right-0">작성중</div>;
    if (log.status === 'rejected') statusBadge = <div className="bg-red-500 text-white rounded-tr-xl rounded-bl-xl px-3.5 py-1.5 text-[13px] font-extrabold absolute top-0 right-0">반려됨</div>;
    if (log.status === 'pending') statusBadge = <div className="bg-purple-500 text-white rounded-tr-xl rounded-bl-xl px-3.5 py-1.5 text-[13px] font-extrabold absolute top-0 right-0">승인요청</div>;
    if (log.status === 'approved') statusBadge = <div className="bg-slate-500 text-white rounded-tr-xl rounded-bl-xl px-3.5 py-1.5 text-[13px] font-extrabold absolute top-0 right-0">승인완료</div>;

    const hasMaterials = log.materials && log.materials.length > 0;
    const hasPhotos = log.photos && log.photos.length > 0;
    const hasDrawings = log.drawings && log.drawings.length > 0;
    const hasConfirmation = log.confirmationFiles && log.confirmationFiles.length > 0;

    const pinnedClass = log.isPinned ? 'border-primary ring-1 ring-primary/20 bg-[#fdfdfd]' : 'border-transparent bg-white';
    const cardClassName = `rounded-[16px] p-[22px] relative cursor-pointer shadow-sm border transition active:scale-[0.98] overflow-hidden ${log.status === 'rejected' ? 'border-red-200 ring-2 ring-red-100 bg-white' : pinnedClass}`;

    // Get formatted worker name string
    const workerNames = log.manpower?.map(m => m.worker || m.role).filter(Boolean) || [];
    const workerDisplay = workerNames.length > 0 
        ? `${workerNames[0]}${workerNames.length > 1 ? ` 외 ${workerNames.length - 1}명` : ''}` 
        : `${log.manpower?.length || 0}명`;

    return (
        <div 
            onClick={onClick}
            className={cardClassName}
        >
            {statusBadge}
            <div className="flex justify-between items-center mb-1.5 pr-8">
                <span className="text-[15px] text-text-sub font-bold">{log.date}</span>
            </div>
            <div className="flex items-center gap-2 mb-2">
                <span className="bg-aff-bg text-aff-text border border-[#bae6fd] text-xs font-extrabold px-1.5 py-0.5 rounded-md">{log.affiliation}</span>
                <span className="text-[19px] font-extrabold text-text-main truncate">{log.site}</span>
                <button 
                    onClick={(e) => onPinClick(e, log.id)}
                    className={`p-1 transition-all shrink-0 ml-auto ${log.isPinned ? 'text-primary rotate-[-45deg]' : 'text-gray-300 hover:text-gray-400'}`}
                >
                    <Pin className={`w-5 h-5 ${log.isPinned ? 'fill-current' : ''}`} />
                </button>
            </div>
            <div className="text-[16px] text-text-sub font-bold mb-3">
                {[log.member, log.process, log.type, log.location].filter(Boolean).join(' | ')}
            </div>
            <div className="border-t border-dashed border-[#e2e8f0] pt-2.5 flex justify-between items-center">
                <div className="text-[15px] font-bold text-text-sub flex items-center gap-1">
                    <Users className="w-4 h-4" />
                    {workerDisplay}
                    <span className="text-primary">({log.manpower?.reduce((a, b) => a + b.val, 0) || 0}공수)</span>
                </div>
                <div className="flex gap-1.5 items-center pl-2 border-l border-[#e2e8f0]">
                    <ClipboardList className={`w-4 h-4 ${log.member ? 'text-header-navy' : 'text-gray-300'}`} />
                    <Package className={`w-4 h-4 ${hasMaterials ? 'text-header-navy' : 'text-gray-300'}`} />
                    <Camera className={`w-4 h-4 ${hasPhotos ? 'text-header-navy' : 'text-gray-300'}`} />
                    <MapIcon className={`w-4 h-4 ${hasDrawings ? 'text-header-navy' : 'text-gray-300'}`} />
                    <FileCheckIcon className={`w-4 h-4 ${hasConfirmation ? 'text-header-navy' : 'text-gray-300'}`} />
                </div>
            </div>
            {log.status === 'rejected' && log.rejectReason && (
                <div className="mt-3 bg-alert-reject-bg border-2 border-alert-reject-border text-alert-reject-text px-4 py-3.5 rounded-xl flex items-center gap-2.5 text-[15px] font-extrabold animate-pulse-reject">
                    <AlertCircle className="w-[22px] h-[22px] shrink-0" />
                    <span>반려: {log.rejectReason}</span>
                </div>
            )}
            {log.missing && log.missing.length > 0 && (
                <div className="mt-3 bg-alert-missing-bg border-2 border-alert-missing-border text-alert-missing-text px-4 py-3.5 rounded-xl flex items-center gap-2.5 text-[15px] font-extrabold">
                     <AlertCircle className="w-[22px] h-[22px] shrink-0" />
                    <span>누락: {log.missing.join(', ')}</span>
                </div>
            )}
        </div>
    );
};

const TimelineItem: React.FC<{ 
    log: WorkLog, 
    selectable: boolean, 
    selected: boolean, 
    onToggle: () => void, 
    onClick: () => void
}> = ({ 
    log, 
    selectable, 
    selected, 
    onToggle, 
    onClick
}) => {
    // Determine the save time part string (assuming updatedAt includes time "YYYY-MM-DD HH:MM")
    const timeString = log.updatedAt ? log.updatedAt.split(' ')[1] : '00:00';

    let statusBadge = <div className="bg-blue-500 text-white rounded-bl-xl px-3.5 py-1.5 text-[13px] font-extrabold absolute top-0 right-0 z-10">작성중</div>;
    if (log.status === 'rejected') statusBadge = <div className="bg-red-500 text-white rounded-bl-xl px-3.5 py-1.5 text-[13px] font-extrabold absolute top-0 right-0 z-10">반려됨</div>;
    if (log.status === 'pending') statusBadge = <div className="bg-purple-500 text-white rounded-bl-xl px-3.5 py-1.5 text-[13px] font-extrabold absolute top-0 right-0 z-10">승인요청</div>;
    if (log.status === 'approved') statusBadge = <div className="bg-slate-500 text-white rounded-bl-xl px-3.5 py-1.5 text-[13px] font-extrabold absolute top-0 right-0 z-10">승인완료</div>;
    
    return (
        <div 
            className={`relative p-5 rounded-2xl flex items-center gap-3 transition active:scale-[0.98] overflow-hidden
                ${selected 
                    ? 'border-2 border-primary bg-white shadow-md z-10' 
                    : 'border border-[#e2e8f0] bg-white shadow-sm' 
                }
            `}
        >
            {statusBadge}
            {selectable && (
                <div onClick={(e) => { e.stopPropagation(); onToggle(); }} className="p-2 -ml-2 cursor-pointer relative z-20">
                    <div className={`w-5 h-5 rounded border flex items-center justify-center shrink-0 transition
                        ${selected ? 'bg-primary border-primary text-white' : 'bg-white border-gray-300'}
                    `}>
                        {selected && <Check className="w-3.5 h-3.5" />}
                    </div>
                </div>
            )}

            <div className="flex-1 min-w-0 cursor-pointer pt-1" onClick={onClick}>
                <div className="flex items-center justify-between mb-1.5">
                    <span className="text-[14px] font-bold text-text-sub flex items-center gap-2">
                        {log.date}
                        <span className="w-[1px] h-3 bg-gray-300"></span>
                        <span className="text-gray-400">{timeString}</span>
                    </span>
                </div>
                <div className="text-[18px] font-extrabold text-text-main truncate mb-1 pr-16">{log.site}</div>
                <div className="text-[15px] text-text-sub truncate font-bold flex items-center gap-1.5">
                    {log.process} <span className="text-gray-300">|</span> {log.member}
                </div>
            </div>
        </div>
    );
};

export default WorklogPage;
