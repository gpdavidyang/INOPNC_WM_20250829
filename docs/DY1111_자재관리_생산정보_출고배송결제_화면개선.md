# DY1111 — 자재관리 생산정보/출고배송결제 화면 개선안

## 1. 배경

- **멀티 자재 요구사항**: `docs/DY1015_자재관리변경요구사항정리.txt`에서 단일 자재(NPC-1000) → 다중 자재 전환, 관리 마스터 CRUD, 생산/출고/결제에 걸친 데이터 확장을 요구.
- **생산관리자/모바일 요구**: `docs/DY1017_자재관리변경요구사항정리_모바일.txt`에서 자재별 월간 통계, 생산/출고 입력 폼, 배송·결제 상태 토글 등 세부 UI/데이터 포인트 정의.
- **현황**: `app/dashboard/admin/materials/page.tsx`의 `생산정보`, `출고배송결제` 탭은 단일 테이블 + 최소 필드만 제공하고 `app/actions/admin/materials.ts`의 API도 기본 컬럼만 노출. 다중 자재, 파트너, 결제, 배송 정책이 화면/서비스 계층 어디에도 반영되지 않음.

## 2. 현재 구현 문제 요약

### 2.1 Admin 생산정보 탭

- **단일 테이블 뷰**: `app/dashboard/admin/materials/page.tsx:716-754`는 생산번호/현장/수량/생산일/품질상태만 표시. 자재명, 거래처, 주문수량, 특이사항(요구문서의 “메모 위주”) 미노출.
- **통계 부재**: 자재별 월간 통계, 생산/출고/재고 합계 카드 없음 (`DY1017 1.1` 불충족).
- **입력/승인 플로우 없음**: 관리자 UI에서 생산정보 작성·승인/반려/특이사항 기록 기능 부재. API (`getMaterialProductions`, `createMaterialProduction`)도 단일 자재 구조를 가정하고 복수 아이템, 첨부, 거래처 필드를 지원하지 않음.

### 2.2 Admin 출고배송결제 탭

- **다중 자재/거래처 정보 누락**: `ShipmentsTable.tsx`는 출고번호·현장·상태·배송방식·금액/수금만 노출. 거래처(파트너), 자재별 수량, 선불/착불, 세금계산서/운임 체크 항목이 UI/모델 어디에도 없음 (`DY1017 2.3` 요구).
- **결제/수금 세부 흐름 미구현**: `getMaterialShipments`는 `material_payments(amount)`만 join. 결제 방식/선불·착불/송장 체크박스, 청구 현황 관리 API가 없음.
- **필터/검색 부족**: 요구 문서의 자재/현장/거래처/년월/상태 필터 미구현. 현재 `app/dashboard/admin/materials/page.tsx`는 공용 필터(현장, 상태, 날짜)만 제공하고 자재·거래처 선택 UI가 없음.
- **모바일/프로덕션 앱 연계 없음**: 생산관리자 모바일의 출고등록/수정/삭제 기능, 체크박스 상태 반영 가능 Endpoint가 없어 요구 충족 불가.

### 2.3 생산관리자(모바일) 화면

- **생산 목록/필터는 멀티 자재 인식**: `/mobile/production/production/page.tsx`는 자재, 현장, 거래처 필터를 지원하고 월간 통계를 자재별로 집계.
- **입력 흐름은 단일 자재**: `/mobile/production/production/new/page.tsx`는 한 번에 `material_id` 1건만 선택 가능, 다중 품목 입력/추가 불가. 주문수량, 거래처, 배송/청구 방식 등을 단일 JSON 메모 필드에 저장하고 있어 목록에서 분리해 활용하지 못함.
- **출고/배송/결제 폼도 단일 품목**: `/mobile/production/shipping-payment/new/page.tsx`는 자재 Select 한 개만 있고 `shipment_items`에 1건만 추가. 탁월한 카드 UI 요구(거래처·배지·체크박스) 중 일부만 적용되어 있고, 체크 항목(전자세금계산서 등)은 아직 모델/화면 연결이 없음.
- **상태/수정 흐름 부족**: 카드 목록에서 요구한 상태 토글, 수정/삭제, 첨부/체크 박스 등은 일부만 구현 혹은 미구현. 예: 선불/착불 배지, 운임비 지불 여부, 전자세금계산서 체크박스 UI 없음.

## 3. 개선 방향

### 3.1 데이터 모델/서비스 확장

1. **다중 자재 Production/Shipment 아이템**
   - `material_productions`에 `material_id`, `product_variant`, `order_quantity`, `notes`, `partner_id`, `billing_method`, `delivery_method`, `payment_terms`, `attachments` 컬럼 추가 or `material_production_items` 보조 테이블 신설.
   - `material_shipments`에 `partner_id`, `billing_method`, `payment_method`, `delivery_method`, `is_cod`, `needs_invoice`, `needs_statement`, `freight_paid`, `charge_issued`, `metadata` 등을 저장.
2. **요약 API**
   - `getMaterialProductionSummary(siteId?, month?)` : 자재별 생산량/출고량/재고 추이 반환.
   - `getShipmentStats(filters)` : 월별 출고건수/수량/금액 + 결제진행률 카드 데이터 제공.
3. **필터 파라미터 확장**
   - `getMaterialProductions` & `getMaterialShipments` → `material_id`, `partner_id`, `billing_method`, `delivery_method`, `month`, `keyword` 파라미터 추가 및 인덱스 설계.

### 3.2 Admin UI 개선 (Next.js)

#### 생산정보 탭

1. **요약 섹션**
   - 상단 카드: 생산건수, 총 생산량, 주문연계율, 미승인 건수.
   - 자재별 월간 차트(스택 바 또는 리스트) → `getMaterialProductionSummary` 데이터 바인딩.
2. **필터 패널**
   - 자재/현장/거래처 CustomSelect, 기간(월) 선택, 상태(대기·진행·완료).
   - 저장형 필터 Preset (요구 문서 “자재별 월간 통계” 활용).
3. **리스트 & 상세 Drawer**
   - 다중 컬럼: 자재, 생산량, 주문수량, 현장, 거래처, 생산일, 특이사항, 파일.
   - Row 클릭 시 Drawer/SideSheet로 상세 + 승인/반려 + 메모 UI 제공.
4. **생산 입력/편집 폼**
   - “생산 정보 입력” 섹션을 모달/Drawer로 구현.
   - 항목: 자재 선택, 생산일, 생산량, 주문일, 주문수량, 현장, 거래처, 청구방식, 배송방식, 선불/착불, 영수증 업로드, 메모.
   - 저장 시 `createMaterialProduction` 확장 API 호출 + `useFormStatus`로 optimistic update.

#### 출고배송결제 탭

1. **대시보드**
   - 이번 달 출고건수/출고수량/출고금액/미수금 카드.
   - 결제 진행률 Progress bar (총금액 대비 수금).
2. **필터/검색**
   - 자재 토글 버튼 그룹 (전체 + 자재명), 현장/거래처 검색 입력, 년월 선택, 상태 필터.
3. **리스트 카드/테이블 병행**
   - 카드 컴포넌트: 거래처, 현장, 상태 토글, 선불/착불 Badge, 배송방식 Badge, 금액·수금·미수, 체크박스(전자세금계산서/거래명세서/운임/청구).
   - 수정/삭제 버튼 + Drawer로 상세 편집 폼 (요구 리스트 2.3/2.4 반영).
4. **출고 등록 폼**
   - “출고등록” 버튼 → Drawer/Form. 필드: 거래처, 현장, 자재, 상태, 금액(천단위), 선불/착불, 배송방식, 체크박스 4종, 메모, 첨부.
   - 저장 시 새 API (`createMaterialShipmentExtended`) 호출, 체크 항목은 Boolean 컬럼으로 저장.
5. **결제/수금 관리**
   - Shipment 상세 Drawer에서 결제 스케줄 추가/편집 → `material_payments` 테이블 확장 (금액, 상태, 청구일, 결제일, 메모).
   - UI에 수금 타임라인 표시, 미수금 자동 계산.

### 3.3 생산관리자(모바일) 화면 개선

1. **공통 구조**
   - Admin과 동일 `lib/materials/priorities` / 자재 옵션 훅 사용.
   - `pm` 네임스페이스 UI 컴포넌트를 `ProductionSummaryCards`, `ShipmentCardList` 등으로 분리해 유지보수성 향상.
2. **생산정보 (mobile/production/production)**
   - **월간 통계**: 현행 숫자 합계를 자재별 그래프 + 생산/출고/재고 차트로 교체. Admin summary API 재사용.
   - **필터**: 현행 `ProductionSearchSection` 확장 → 자재/현장/거래처/기간/상태 + 저장 필터.
   - **목록**: 다중 자재 항목 표시(자재명, 수량, 현장, 거래처, 상태). 품질상태 배지와 첨부/메모 아이콘 추가. Row 탭 시 상세 시트에서 라인아이템, 메모, 첨부, 체크리스트 확인/편집.
   - **생산 입력 폼**:
     - 품목 Repeater: 자재 선택 + 수량 필드를 동적으로 추가/삭제 가능하게 (예: `ItemsFieldArray` 컴포넌트).
     - 주문 정보, 거래처, 청구/배송/선불·착불, 영수증 첨부 UI를 Admin 폼과 동일한 스키마로 분리 저장 (`material_production_items`, `production_metadata` JSON).
     - 제출 시 새 API(`createMaterialProductionExtended`) 호출, 성공 후 Revalidate + 토스트.
3. **출고배송결제 (mobile/production/shipping-payment)**
   - **대시보드**: 카드(출고건수/수량/금액/미수), 라디오필터(이번달/지난달), 결제 진행률 Progress 표시.
   - **필터/검색**: Admin과 동일 구조(자재 토글, 현장/거래처 검색, 기간, 상태).
   - **카드 UI**: 거래처 제목, 현장, 상태 토글, 선불/착불·배송방식 Badge, 금액·수금·미수, 체크박스 4종, 수정/삭제 버튼. React hook form으로 상태 업데이트.
   - **출고 등록/편집 폼**:
     - 품목 라인 추가 지원 (자재 선택, 수량, 단가, 메모). `shipment_items` 배열로 저장.
     - 결제/배송/운임 옵션은 Admin “설정” 마스터와 동일한 옵션 소스 사용.
     - 체크박스 상태(전자세금계산서, 거래명세서, 운임비 지불, 금액 청구)를 Boolean 컬럼에 매핑.
     - 첨부 (영수증 등) 업로드 필드 추가.
4. **입고요청 뷰**
   - 요구 문서 3.1~3.3 반영: 대시보드 카드, 기간/자재 필터, 리스트뷰(일자/거래처/현장/수량/요청자/메모). Admin 입고요청 탭과 동일 데이터 사용.
5. **동기화/권한**
   - 생산/출고 폼에서 저장 시 `revalidatePath('/dashboard/admin/materials?tab=productions|shipments')`.
   - 권한: `production_manager` 역할만 접근, 파트너 역할은 이 메뉴 숨김 (Drawer/AppBar/BottomNav 이미 역할 분기 존재).
   - 에러/토스트 처리 표준화 (`useToast`).

### 3.4 API & 권한

- **멀티 자재 CRUD**: `app/actions/admin/materials.ts`에 자재 마스터 CRUD (코드, 단위, 규격, 활성화 여부) 추가. 이 데이터는 생산/출고 입력 select 옵션으로 사용.
- **권한 체크**: 생산/출고 API에서 `ensureSiteAccess` 외에 `ensurePartnerAccess`(거래처 제한) 추가. 파트너/외주 사용자는 본인 거래처 데이터만 열람.
- **감사 로그**: 생산/출고 수정/삭제 시 `activity_logs` 기록 (생산량 변경, 결제 상태 변경 등).

## 4. 구현 단계 제안

1. **데이터/서비스 정비**
   - DB 마이그레이션: production/shipment 확장 컬럼 및 연관 테이블.
   - actions/admin/materials.ts & materials-inventory.ts API 업데이트 + 단위테스트.
2. **UI 구조 정비**
   - 생산/출고 탭 레이아웃을 컴포넌트 단위로 분리 (`components/admin/materials/ProductionSummary.tsx`, `ShipmentsDashboard.tsx`, etc.).
   - Drawer/Form 컴포넌트 설계 (react-hook-form + zod).
3. **모바일 연동 & UI**
   - 생산/출고 모바일 페이지를 새 컴포넌트로 리팩터링, 멀티 자재 입력/카드 UI 구현, Drawer 기반 상세/수정 제공.
   - 공통 훅/컴포넌트 공유해 Admin/모바일 간 스펙 불일치 방지.
4. **QA/롤아웃**
   - 멀티 자재 시나리오 테스트: 자재 3종 이상, 거래처 2종, 선불/착불 혼합.
   - 결제/수금 체크박스, 신고서 첨부 등 엔드 투 엔드 시나리오.

> 본 문서는 개선 방안 설계 문서이며, 실제 개발 시 추가 세부 설계(컴포넌트 트리, API 스펙 문서, 마이그레이션 SQL)가 필요합니다.
