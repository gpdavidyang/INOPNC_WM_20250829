# DY1015 자재관리 개선 구현 계획안

> 문서 목적: DY1015 요구사항(자재관리 변경요구사항 정리)에 근거하여 관리자/모바일 화면과 데이터 모델, 권한 체계, 개발/배포 전략을 정의하고 개발 범위·우선순위를 확정한다.

## 1. 범위(Scope)

- 단일 자재(NPC-1000) 전제 → 여러 자재(품목) 관리로 확장
- 관리자(본사/시스템관리자) 자재관리 메뉴: 4개 탭 구성
  - 현장별 재고현황
  - 입고요청 관리(= 주문현황)
  - 생산정보 관리(품질상태 → 특이사항/메모 중심)
  - 출고·배송·결제 관리(= 출고·배송정보 + 결제/수금 정보)
- 관리자 설정 메뉴(기초 마스터): 품목, 단위, 운송방식, 결제방식/세율, 운임정책, 거래처(+ 생산관리 설정)
- 모바일 역할별 화면
  - 작업자/현장관리자: 재고관리(입고요청) 화면을 다품목 기준으로 개편
  - 생산관리자(신규 역할, 별도 모바일 화면/파일):
    1. 입고요청 조회 2) 생산정보 관리 3) 출고·배송·결제 관리
  - 파트너: 자재관리 관련 화면/데이터 접근 비노출(차단)

## 2. 역할 및 접근 권한

- Admin(본사), System Admin: 모든 자재관리/설정 CRUD, 통합 조회 권한
- Production Manager(신규): 입고요청 조회, 생산등록/수정, 출고·배송 등록, 결제 진행/기록 권한(정책에 따라 제한 가능)
- Site Manager, Worker: 입고요청 생성/조회(본인 현장 범위), 현장 재고 조회, 출고/배송/결제는 조회 제한(정책에 따라 현황 조회는 허용 가능)
- Partner: 자재관리 전 영역 비노출 및 데이터 접근 차단
- 기술적 구현: UI Track 라우팅 + Supabase RLS로 이중 보호

## 3. 정보구조(IA) 및 라우팅

- 관리자 대시보드(App Router)
  - `/app/dashboard/materials` (탭)
    - `/inventory` 현장별 재고현황
    - `/requests` 입고요청 관리
    - `/production` 생산정보 관리
    - `/shipping-payment` 출고·배송·결제 관리
  - `/app/dashboard/materials/settings` (기초마스터)
    - 품목, 단위, 운송방식, 결제방식/세율, 운임정책, 거래처, 생산관리 설정
- 모바일
  - 작업자/현장관리자: `/app/mobile/materials` (입고요청 생성/조회 + 재고조회)
  - 생산관리자(신규): `/app/mobile/production`
    - `/requests` 입고요청 조회
    - `/production` 생산정보 등록/수정
    - `/shipping-payment` 출고·배송·결제 등록/조회
  - 파트너: 자재관리 관련 경로 접근 시 홈 또는 권한없음 처리

## 4. 데이터 모델(Supabase, PostgreSQL)

- 마스터
  - `materials`(id, code, name, spec, unit_id, is_active, created_at)
  - `material_units`(id, name, symbol)
  - `transport_modes`(id, name)
  - `payment_methods`(id, name, tax_rate)
  - `freight_policies`(id, name, policy_type, base_fee, unit_fee, min_fee, description)
  - `partners`(id, name, type, contact, is_active)
  - `sites`(id, name, partner_id, is_active)
- 업무 데이터
  - `site_material_stocks`(id, site_id, material_id, qty, updated_at)
  - `incoming_requests`(id, site_id, material_id, qty, unit_id, requested_by, status, requested_at, memo)
    - status: `pending | approved | rejected | fulfilled | cancelled`
  - `production_records`(id, material_id, qty, unit_id, production_date, notes, created_by, created_at)
    - 변경: `quality_status` 제거 → `notes`(특이사항/메모)
  - `shipments`(id, site_id, material_id, qty, unit_id, ship_date, transport_mode_id, status, tracking_no, memo, created_by)
  - `payments`(id, shipment_id, amount, currency, payment_method_id, tax_rate, paid_at, status, memo, created_by)
    - status: `unpaid | partial | paid`
  - 선택: `shipment_items`(복수 품목/묶음 출고 필요 시)로 확장 가능
- 관계/무결성
  - FK, on update restrict, on delete restrict(또는 정책에 맞게 cascade 최소화)
  - 주요 컬럼 인덱스: `(site_id, material_id)`, `(material_id)`, `(ship_date)`, `(status)` 등
- 마이그레이션
  - 기존 단일 자재 데이터 → `materials`에 시드(NPC-1000) + 현 데이터 이동
  - `production_records`의 `quality_status` → `notes`로 필드 변경 및 데이터 이관

## 5. 권한 및 RLS(요지)

- 공통: `profiles` 또는 역할 메타데이터를 통해 `role, site_id, partner_id`를 보유한다고 가정
- 예시 정책(의사 SQL)

```sql
-- incoming_requests: 현장 사용자 생성, 동일 현장 범위 조회
create policy "requests_insert_self" on incoming_requests
for insert to authenticated
with check (requested_by = auth.uid());

create policy "requests_select_by_site" on incoming_requests
for select to authenticated
using (
  exists (
    select 1 from profiles p
    where p.user_id = auth.uid()
      and p.site_id = incoming_requests.site_id
      and p.role in ('worker','site_manager','production_manager','admin','sysadmin')
  )
);

-- admin/sysadmin는 bypass(별도 role check) 또는 전역 select 정책
```

- Partner는 자재 관련 테이블 전체 `select/insert/update/delete` 불가 정책 명시
- Production Manager는 생산/출고/결제 insert/update 허용(조직 정책에 맞춘 추가 제한 가능)

## 6. 기능 상세

- 현장별 재고현황(관리자)
  - 현장/품목별 보유량, 최근 변동(입고/출고) 로그
  - 필터: 현장, 품목, 기간, 상태
- 입고요청 관리(관리자/생산관리자 조회)
  - 요청 승인/반려, 부분/전체 출고 연계, 상태 변경 이력
- 생산정보 관리(관리자/생산관리자)
  - 품목·수량·일자·메모 등록/수정, 기존 품질상태 필드 제거
- 출고·배송·결제 관리
  - 출고 생성(요청 매핑), 배송정보(방식/일자/송장), 결제(금액/세율/방식/상태)
  - 대시/리스트 + 상세 패널(출고/결제 타임라인)
- 설정(기초마스터)
  - 각 마스터 CRUD + 사용여부 토글, 참조 무결성 검사
- 모바일(작업자/현장관리자)
  - 다품목 검색/선택, 요청 수량·단위 입력, 현장 제한 자동 적용, 진행상태 조회
- 모바일(생산관리자)
  - 요청 목록에서 생산/출고 연계, 메모 중심 입력, 송장·결제 기록

## 7. UI/UX 가이드(요지)

- 탭 구조 유지, 리스트 + 사이드패널/모달 편집 패턴
- 필수 컬럼 최소화, 메모/특이사항 노출 강화
- 상태 배지 색상 체계: 요청/생산/출고/결제 단계 통일
- 모바일은 한 손 조작 우선, 검색/필터 고정 바 제공

## 8. 기술 설계

- Next.js App Router + Server Actions로 Supabase 호출 표준화
- 타입
  - `lib/types/materials.ts`에 핵심 도메인 타입 정의(테이블 타입 매핑)
- 데이터 액세스 계층
  - `lib/supabase/*` 클라이언트 활용, 쿼리/변환 유틸 `lib/repos/materials.ts` 등 분리
- 라우팅/폴더(예시)

```
app/
  dashboard/
    materials/(tabs)/{inventory,requests,production,shipping-payment}/page.tsx
    materials/settings/{materials,units,transport,payment,freight,partners}/page.tsx
  mobile/
    materials/{page.tsx,...}
    production/{requests,page.tsx,production,shipping-payment}/page.tsx
modules/
  mobile/production/* (뷰/서비스 모듈)
```

- 상태관리: Server Components 우선 + 클라이언트 컴포넌트에서 SWR or React Query(필요 시) 경량 사용
- 폼: `react-hook-form` + `zod` 검증

## 9. 마이그레이션/데이터 이전 전략

- 단계 1: 스키마 추가(신규 테이블/마스터)
- 단계 2: 기존 데이터 맵핑/이관(NPC-1000 시드 → 참조 연결)
- 단계 3: `production_records.quality_status` → `notes` 컬럼 전환 및 UI 반영
- 단계 4: 코드 릴리스 후 읽기/쓰기 경로 점진 전환(플래그 가능)
- 롤백: 신규 테이블 비활성화, 구 컬럼 복구 스크립트 준비

## 10. 테스트 계획

- 단위: 자료형/검증 스키마, 서버 액션 실패 케이스
- 통합: 역할별 RLS/권한 테스트(Admin/PM/Worker/Site/Partner)
- E2E(선택): 핵심 플로우 4건
  1. 작업자 입고요청 생성→관리자 승인→출고/결제 기록
  2. 생산관리자 생산 등록→출고 생성→결제 처리
  3. 관리자 마스터 CRUD→현장/모바일 반영 확인
  4. 파트너 접근 차단 확인(페이지/데이터)

## 11. 개발 단계/우선순위(페이즈드 릴리스)

1. 스키마/마스터(품목/단위 등) + 관리자 설정 페이지 최소기능
2. 입고요청(모바일 Worker/Site) ↔ 관리자 요청관리
3. 생산관리자 모바일(요청조회/생산등록)
4. 출고·배송·결제(관리자/생산관리자)
5. 현장별 재고현황 대시(가시화)
6. 성능/사용성 개선, 보고서(선택)

## 12. 리스크/의존성

- 역할/RLS 불일치로 인한 접근 오류 → 통합 테스트 강화
- 기존 데이터 참조 무결성 이슈 → 마이그레이션 스크립트와 백업 필수
- 결제/세율 정책 확정 필요 → 임시 기본값/마스터로 유연성 확보
- 운임정책 계산 로직 복잡도 → 초기 단순 정책부터 적용(Flat/Unit)

## 13. 확인/결정 필요사항(질의)

- 결제 통화/세율 기본값(기본 KRW/10% 가정 가능?)
- 생산관리자 결제 권한 범위(등록까지 vs. 승인 필요?)
- 출고 품목 다중화 필요 여부(단일 출고행 vs. 출고묶음)
- 파트너 계정에 자재 관련 알림/요약 대시 제공 여부(완전 비노출?)
- 현장별 재고 수량 소스(입출고 집계 vs. 별도 재고테이블 기준) 확정

## 14. 배포/운영

- 기능 플래그로 모바일 전환 순차 적용 가능
- 마스터 스키마/데이터 배포 → 관리자 페이지 오픈 → 모바일 점진 업데이트
- 장애 대비: 이전 스키마 백업 및 롤백 스크립트 준비

---

본 계획안 승인 시, 페이즈 1부터 구현을 시작하고 각 페이즈 완료마다 검수/피드백을 반영하겠습니다.
