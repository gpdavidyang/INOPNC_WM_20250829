# DY1026 현장관리 – 기성청구·공유자료 탭 개선안

## 1. 목적 및 배경

- 본사 관리자 현장 상세 화면의 `문서`, `도면` 탭이 사용자의 업무 맥락과 맞지 않아 혼선 발생
- 이미 존재하는 `기성청구 관리` 메뉴와 현장별 문서 탭의 역할이 분리되어 있어 데이터 연계성이 낮음
- 현장 팀과 공유되는 도면/자료와, 협력사와 주고받는 계약·정산 서류의 구분 필요

## 2. 핵심 목표

1. 현장 상세 탭 구조를 **기성청구**(본사 ↔ 협력사)와 **공유자료**(본사 ↔ 현장팀)로 명확히 분리
2. 각 탭에서 업무에 필요한 메타데이터를 제공하여 상태·버전·파트너 정보를 한눈에 확인
3. `기성청구 관리` 전체 메뉴와 현장별 탭 간 데이터 모델·API를 일관화
4. 모바일(협력사/현장) 화면에서도 동일한 분류 체계를 유지하도록 기반 정비

## 3. 범위

- **UI/UX**: 현장 상세 탭, 목록·필터, CTA, 설명 텍스트, 아이콘
- **API/기능**: 현장별 문서 조회/업로드 API, 이동 버튼, 권한 검증
- **데이터 모델**: `unified_document_system`, `site_documents` 보완, 메타데이터 확장
- **연동**: `기성청구 관리` 메뉴, 모바일 현장/파트너 화면과의 데이터 일관성

## 4. 현재 상태 정리

| 항목                | 현황                                                    | 이슈                                               |
| ------------------- | ------------------------------------------------------- | -------------------------------------------------- |
| 문서 탭             | `unified_document_system`에서 `shared` 중심 데이터 표시 | 계약·기성 문서 구분 불명확, 파트너 메타데이터 누락 |
| 도면 탭             | `/api/docs/drawings` → `site_documents`/fallback        | 도면과 일반 공유 문서가 분리되어 있지 않음         |
| 기성청구 관리 메뉴  | 별도 페이지에서 전체 기성 서류 관리                     | 현장 탭과 데이터 연결·네비게이션 부족              |
| 모바일(협력사) 화면 | `unified_document_system` 최근 문서 10건 단순 표시      | 본사 분류 개편과 연계되지 않음                     |

## 5. 개선 방향

### 5.1 탭 구조 및 명칭

- `문서` 탭 → **`기성청구`** 탭
  - 하위 목록: 기성 요청/정산 관련 문서 리스트
  - CTA: `기성청구 관리` 이동 버튼, “새 기성 요청” (권한에 따라 노출)
  - 필터: 기성 단계(작성 중/검토 중/승인/청구 완료), 협력사, 요청 기간, 금액 범위
- `도면` 탭 → **`공유자료`** 탭
  - 상단 토글: `도면`(공도면/작업도면) vs `공유문서`(공지, 점검표 등)
  - 기본 뷰는 최신 도면 그리드(버전/유형/업로드자/다운로드 버튼)
  - 공유문서는 테이블 또는 카드로 목록화, audience=`site_team` 대상 문서만 표시

### 5.2 UI/UX 요소

- 탭 설명 문구 추가
  - 기성청구: “협력사와의 기성·정산 문서를 관리합니다.”
  - 공유자료: “현장 작업자/관리자와 공유하는 도면 및 자료입니다.”
- 기성청구 목록 컬럼
  - 등록일, 문서명, **파트너사**, **기성 단계**, **요청 금액**, 기간, 상태
  - 상태 배지는 단계에 따라 컬러 구분
- 공유도면 카드
  - 도면명, 종류(공도면/작업도면/기타), 업로드 일시, 업로드자
  - “최신 버전” 뱃지 및 다운로드/미리보기
- 공유문서 리스트
  - 분류(안전/공지/점검 등), 버전, 업로드자, 유효 기간
  - 필터: 분류, 업로드자, 업로드일

### 5.3 API·기능 정비

- `/api/admin/sites/:id/integrated`
  - `docs` 기본값을 `category_type='invoice'` 문서로 교체
  - 필요한 메타데이터(파트너, contract_phase, amount, due_date) 포함
- `/api/admin/sites/:id/documents`
  - 기본 `category=invoice`로 변경, `phase`, `partner`, `period` 필터 지원
  - audience 필터 추가 (`site_team`, `partner`)
- `/api/docs/drawings`
  - `document_type` 매핑을 `plan`(공도면)/`progress`(작업도면)/`other` 유지
  - fallback to unified documents 시 audience=`site_team` 조건 부여
- 업로드 흐름
  - 기성 문서 업로드 시 필수 입력: 파트너사, 기성 단계, 요청 기간/금액
  - 공유 도면 업로드 시 종류 선택(공도면/작업도면/기타) 및 버전 관리 옵션

### 5.4 데이터 모델 변경

- `unified_document_system`
  - `audience`(ENUM: `partner`, `site_team`, `all`) 컬럼 추가
  - `category_type='invoice'` 문서에 기성 전용 메타데이터 필수 저장
  - 기존 계약/정산 문서 마이그레이션 (shared → invoice, audience=partner)
- `site_documents`
  - 공유문서 유형 저장을 위해 `document_type` ENUM 확장 검토 (`notice`, `checklist`)
  - `audience` 또는 `visibility` 컬럼 추가하여 현장팀 대상 문서 구분
- 마이그레이션 전략
  1. 기존 공유 문서 중 현장 대상 자료를 `site_documents` 또는 `unified_document_system` audience=`site_team`로 이동
  2. 기성 관련 문서를 invoice 카테고리로 재분류, 누락된 메타데이터 보강

### 5.5 권한 및 연동

- 권한
  - 기성청구 탭은 본사 관리자 기본, 협력사 담당자는 관련 현장에 한해 읽기 가능(정책 필요)
  - 공유자료 탭은 본사/현장 관리자/작업자 접근 허용, partner는 기본 차단
- 연동
  - 기성청구 탭 상단 CTA → `/dashboard/admin/invoice` (필터에 site_id 적용)
  - 기성청구 메뉴에서 특정 현장 선택 시 현장 탭 딥링크 제공
  - 모바일 협력사 화면: `invoice` 카테고리만 노출, 상태/요약 동일 표시
  - 모바일 현장 화면: 공유자료 탭 데이터 재사용

## 6. 단계별 실행 계획

1. **설계 확정** (본 문서 검토/승인)
2. **데이터 모델 업데이트**
   - audience 컬럼 추가, 마이그레이션 스크립트 준비
3. **API 개편**
   - 현장별 문서 API, 통합 API, 도면 API 수정 및 테스트
4. **프론트엔드 업데이트**
   - 탭 구성 변경, UI 개편, CTA 추가, 필터/컬럼 확장
5. **모바일 연동**
   - 파트너/현장 화면에서 새 분류 반영
6. **QA & 배포**
   - 역할별 접근 테스트, 회귀 테스트(기성청구 관리, 도면 열람)
7. **운영 모니터링**
   - 초기 1~2주 동안 문서 업로드/조회 로그 점검 및 피드백 수집

## 7. 리스크 및 대응

- **데이터 재분류 작업**: 기존 문서의 메타데이터가 부족할 수 있음 → 임시 맵핑 규칙 정의 및 수동 보정 가이드 제공
- **권한 정책 충돌**: audience 도입 후 RLS 필요 → 정책 문서화 및 테스트
- **UI 변경 저항**: 사용자 교육/공지 필요 → 릴리즈 노트와 가이드 준비
- **연동 범위 확장**: 기성청구 전체 메뉴와 딥링크 연계 시 상태 동기화 이슈 → 공통 필터 파라미터 규약 정의

## 8. 확인 필요 사항

- 기성 단계 분류 정의(작성/검토/승인/청구완료 등)와 금액·기간 데이터 출처
- 공유자료 중 도면 외 자료의 분류 체계 확정
- audience 컬럼 도입 시 RLS 정책 변경 범위
- 모바일 파트너 사용자에게 제공할 정보 수준(읽기 전용/요약 등)

## 9. 다음 단계

1. 본 개선안 리뷰 및 확정
2. 데이터 스키마 변경 계획 수립 (DBA/백엔드 협업)
3. UX 와이어프레임 검토 후 개발 일정 산출
4. 구현 착수 전 테스트 계획 합의

---

검토 의견을 반영해 문서를 업데이트한 뒤, 확정본 기준으로 구현을 진행합니다.
