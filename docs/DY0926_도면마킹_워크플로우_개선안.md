# DY092 도면마킹 워크플로우 개선안

## 0. 배경/목표

- 현장관리자 앱 홈의 “도면마킹” 섹션은 현재 공도면 1건을 선불러와 로컬 스토리지(selected_drawing, selected_site)에 저장한 후 마킹 도구(/mobile/markup-tool)가 이를 읽어 초기화하는 구조.
- 공도면이 미등록인 현장은 안내와 대체 경로(직접 촬영/사진첩 → 업로드 → 마킹)가 직관적이지 않고, 최근 작업 이어하기가 localStorage 의존이라 기기/브라우저 변경에 취약.
- 작업일지(작성/상세/리스트/캘린더)와 현장 상세, 시스템관리자(현장관리)의 도면/문서 관리와 유기적으로 연동되는 UX 필요.

본 개선안의 목표는 다음과 같다.

- 공도면이 있든 없든 “마킹 시작”까지 자연스럽게 유도하는 분기 UX 제공
- 마킹 산출물(마킹도면, 사진도면)을 서버에 정식 보관하고 최근 작업/대표 도면을 안정적으로 이어가기
- 작업일지와 도면마킹의 연계를 표준화(저장/제출 시 자동 매핑, 상세에서 바로 열람)
- 에러/로딩/오프라인 대비 UX와 캐싱 전략 정립

---

## 1. 현재 워크플로우 요약 (문제점 포함)

- 홈 상단에서 현장 선택 → DrawingQuickAction useEffect가 `/api/partner/sites/{siteId}/documents?type=drawing` 호출
  - `categoryType === 'drawing' || 'blueprint'`만 필터, 첫 1건을 primaryBlueprint 로 선정
  - 실패/미등록 시 UI 상 안내 미흡(토스트/버튼 비활성화만 존재)
- localStorage 저장: selected_drawing, selected_site, recent_markup
- 액션
  - “마킹 시작” → `/mobile/markup-tool` (localStorage 기반 초기화)
  - “도면 관리 →” → `/mobile/markup-tool?mode=browse`
  - “최근 마킹” → localStorage.recent_markup를 selected_drawing에 주입 → `/mobile/markup-tool?mode=continue`
- 이슈
  - 신뢰성: localStorage 의존, 멀티 기기/브라우저에서 이어하기 불가
  - 선택성: 공도면 다건/정렬 기준, 대표 도면 지정 로직 미정
  - UX/오류: 미등록/네트워크 오류 시 대체 경로 가이드 부족, 상태 피드백 단순
  - 연계성: 작업일지와 도면마킹 간 참조가 암묵적(localStorage)이며 서버 기준 식별자/링크가 명확히 남지 않음

---

## 2. 개선 요구사항(확정)

1. 공도면 미등록 현장 분기 UX

- 안내 메시지 + 선택지 제공
  - A) 현장 촬영본(손마킹 도면 사진) 업로드 → 마킹 없이 저장 가능
  - B) 사진첩/카메라로 촬영 → 마킹 도구에서 디지털 마킹 후 저장
- 저장 시 현장/작업일자/작성자와 링크(메타데이터) 보관

2. 대표 도면 선정/선택 UI

- `/documents?type=drawing` 결과에 대해 정렬 기준(최신, 대표 플래그) 적용
- 다건 시 시트/모달에서 선택 가능(썸네일/파일명/업로드일 표시)

3. 최근 마킹/진행중 작업 이어하기(서버 보관)

- 최근 마킹은 서버에 `markup_documents`(또는 `unified_documents`)로 저장, 사용자별 “최근 1~3건” API 제공
- 기기 변경/캐시 삭제에도 이어서 작업 가능

4. 작업일지와의 연계

- 작업일지 작성 화면에서 “도면마킹”으로 진입/복귀 시 현재 선택된 현장/작업일자를 컨텍스트로 유지
- 마킹 저장 시 worklog 링크 방법
  - (권장) `markup_documents.linked_worklog_id` (FK) or 연결 테이블(`worklog_markups`)에 저장
  - 링킹 기준: `site_id + work_date + created_by` 기본값, 상세 저장 때 명시적으로 선택 가능
- 작업일지 상세에서 마킹 탭 노출(진행도면/완료확인서 등과 함께)

5. 에러/로딩/접근성

- 실패 유형별 메시지(권한/네트워크/미등록/서버오류) 표준화 + 재시도 버튼
- 스켈레톤/스피너/오프라인 안내, 키보드 포커스 이동, ARIA 적용

6. 캐싱/상태

- React Query로 공도면/최근마킹 캐싱 + 무효화 정책 정의
- localStorage는 보조 캐시로 축소, 서버가 단일 진실원(SSOT)

---

## 3. 데이터/엔드포인트 설계

### 3.1 엔터티

- markup_documents (또는 unified_documents 확장)
  - id, site_id, title, original_blueprint_url, markup_data(JSON), created_by, updated_at,
  - linked_worklog_id (nullable), source_type('blueprint'|'photo'), is_primary(boolean)
- site_documents (기존) — 대표 도면 여부 플래그 추가 제안: `is_primary_blueprint`
- worklogs (daily_reports) — 기존과 동일, 첨부/링크는 외부 테이블로 관리
- worklog_markups (연결 테이블; 선택)
  - id, worklog_id, markup_document_id, relation('progress'|'completion'|…)

### 3.2 API (신규/확장)

- GET `/api/partner/sites/{siteId}/documents?type=drawing&sort=primary,desc&limit=5`
- GET `/api/markup-documents/recent?siteId=&limit=3` (사용자/현장별 최근)
- POST `/api/markup-documents` { site_id, title, source_type, original_blueprint_url | upload, markup_data, linked_worklog_id? }
- PATCH `/api/markup-documents/{id}` { markup_data, linked_worklog_id }
- PATCH `/api/partner/sites/{siteId}/documents/{docId}` { is_primary_blueprint }

### 3.3 상태/링킹 규칙

- 마킹 저장 시 기본 링크 후보: 현재 작성 중인 worklogId(있으면) 또는 `(site_id, work_date, created_by)` 추론
- 작업일지 제출 후에도 마킹 문서는 독립 문서로 남고, 링크만 업데이트 가능

---

## 4. UX 플로우

### 4.1 홈 > 도면마킹 (DrawingQuickAction)

1. 현장 선택됨 → 공도면/최근마킹 병렬 로드
   - 성공: 대표 도면 카드 + “마킹 시작” 활성
   - 미등록: 안내 + 선택지 버튼(‘촬영본 업로드’ / ‘사진으로 마킹하기’) 노출
2. ‘마킹 시작’
   - context: siteId, optional worklogId, blueprint docId(or url)
   - 이동: `/mobile/markup-tool?mode=start&siteId=...&docId=...`
3. ‘도면 관리 →’
   - `/mobile/markup-tool?mode=browse&siteId=...`
4. ‘최근 마킹’
   - 서버 최근 목록을 카드로 1~3개 표시(없으면 localStorage fallback)

### 4.2 마킹 도구(/mobile/markup-tool)

- 초기화: URL 파라미터 우선 → 서버 조회 → localStorage 보조
- 저장: POST/PATCH `/api/markup-documents` 후 성공 토스트 + “작업일지로 돌아가기” CTA
- 업로드 분기
  - A) 촬영본 업로드(손마킹 사진): source_type='photo', markup 없이 저장 가능
  - B) 사진으로 마킹(디지털): source_type='photo', 저장 시 markup_data 포함

### 4.3 작업일지 작성/상세

- 작성 화면: “도면마킹” 세부 섹션에 현재 연결된 마킹 문서 썸네일/카운트 표시 + “마킹 열기”
- 상세 화면: ‘진행도면’ 탭에서 연결된 markup_documents를 뷰어로 노출(탭/줌 포함)

---

## 5. 컴포넌트/상태 설계

- DrawingQuickAction
  - React Query 도입: `usePrimaryBlueprint(siteId)`, `useRecentMarkups(siteId)`
  - 오류 상태 뷰 + 재시도 핸들러, “대체 경로 CTA” 제공
  - 선택 UI: 대표/최신 도면 리스트 모달(썸네일 3~5개)
- MarkupToolPage
  - URL 파라미터 기반 초기화(siteId, docId, mode)
  - 저장 성공 시 캐시 무효화: `['markup-documents', siteId]`, `['worklogs']`
- WorklogDetail/Viewer
  - 마킹 탭 추가, 첨부문서/마킹문서 분리 표현

---

## 6. 오류/로딩/오프라인 표준

- 오류 유형별 메시지 템플릿: 권한/네트워크/미등록/서버오류
- 재시도/문의(오픈채팅) CTA
- 오프라인 시 localStorage/IndexedDB fallback, 온라인 복귀 시 동기화 안내

---

## 7. 단계별 구현 계획

### Phase A (빠른 UX 보완)

- DrawingQuickAction에 오류/미등록 상태 카드 + CTA 버튼 2종 추가
- 대표 도면 선택 모달 추가(최신 3~5건)
- 최근 마킹 서버 조회 API 연동(임시로 `/api/markup-documents/list?siteId=` 활용 가능)

### Phase B (서버 보관/연계 강화)

- `/api/markup-documents` 저장/수정 연동, 저장 시 worklogId(또는 후보 키) 링크
- Worklogs(작업일지 베타) 상세/탭에 마킹 문서 노출
- HomePage 요약에도 “마킹 문서 n건” 카운트 반영

### Phase C (관리자 연동)

- 시스템관리자 현장관리 화면에 대표 도면 플래그 관리 UI 추가
- 현장 문서 목록에서 “마킹 문서” 필터/미리보기, 작업일지 링크 추적

### Phase D (성능/안정화)

- React Query 캐시/무효화 전략 고도화, prefetch
- IndexedDB 보조 캐시(대용량 markup_data 전송 전 임시 저장)
- Lighthouse/웹 접근성 검증

---

## 8. 영향을 받는 파일(예상)

- `modules/mobile/components/home/DrawingQuickAction.tsx` (상태/CTA/모달)
- `app/mobile/markup-tool/page.tsx` (URL 파라미터/저장 연동)
- `modules/mobile/components/worklogs/*` (상세 탭/리스트 카운트)
- `app/api/markup-documents/*` (신규/확장)
- `components/admin/*` (대표 도면 관리)

---

## 9. 성공 기준(DoD)

- 공도면 미등록 현장에서도 두 가지 대체 경로로 “마킹 저장”까지 완료 가능
- 최근 마킹은 서버 기준으로 이어서 열기 가능(기기 변경 무관)
- 작업일지 상세에서 연결된 마킹 문서가 뷰어로 열리고, 작성/상세/현장관리 간 링크가 일관됨
- 오류/로딩/오프라인 UX가 표준화되어 회복 가능 경로 제공

---

본 설계안은 현재 코드 기반에서 최소 변경으로 단계적 전환이 가능하도록 구성했으며, 관리자 연동/데이터 정규화는 Phase C에서 수행합니다.

---
