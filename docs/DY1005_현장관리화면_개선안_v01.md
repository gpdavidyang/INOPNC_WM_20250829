# INOPNC 현장관리 화면 개선안 v0.1

작성일: 2025-10-05
대상: 관리자(Admin/System Admin) 데스크탑 UI – 현장관리 메뉴 전반

## 1) 목표/비전

- 현장 중심 허브: 현장 기본정보는 물론, 작업일지/문서/사진/자재/사용자/파트너 등 모든 연계 리소스에 즉시 접근 가능한 허브 제공.
- 업무 효율/정합성: 필요한 정보를 2~3클릭 이내로 조회/수정하고, 대표 액션(신규 문서/작업일지 작성, 배정, 상태변경 등)을 어디에서든 노출.
- 성능/안정성: 안정적인 서버 렌더링(SSR) + 지연 로딩/프리패치, 표준화된 권한 검사와 에러/토스트 패턴.

## 2) 사용자 시나리오(핵심 플로우)

- 시나리오 A – 신규 현장 등록 → 바로 담당자/배정/필수문서 연결
  1. 현장 생성 → 상세 페이지 이동
  2. 상단 액션바에서 “사용자 배정”, “PTW 업로드”, “공도면 업로드” 바로가기
  3. 개요 탭에서 최근 문서/작업일지/배정 현황 한눈에 확인

- 시나리오 B – 운영 중 현장 점검/관리
  1. 현장 목록에서 검색/필터/일괄작업(상태변경/삭제)
  2. 상세 개요에서 지표(작업일지 수/총공수/최근 활동) + 바로가기(문서/작업일지/배정/자재)
  3. 문서 탭: PTW/공도면/공유문서 최근 10~50개, 전용 뷰어/다운로드 연결
  4. 작업일지 탭: 최근 10개, 사진/사진대지와 크로스링크
  5. 배정 탭: 사용자/협력사 배정/해제 + 간이 검색/정렬
  6. 자재 탭: 최근 요청/입출고/배송요청 미리보기, 자재관리 화면과 연결

## 3) 정보 구조(IA) 및 화면 설계

- 현장 목록(/dashboard/admin/sites)
  - 헤더: 검색(이름/주소), 상태 필터, “현장 등록”, 새로고침
  - 리스트: 이름/주소/상태/기간/담당자/최근지표(일지수/공수), 액션(상세)
  - 일괄작업: 상태변경(active/inactive/completed), 삭제(확인 모달)
  - 빈/오류/로딩 상태, 선택 유지, 페이지네이션

- 현장 상세(/dashboard/admin/sites/[id])
  - 상단: 제목/주소 + 액션바(정보 수정, 상태변경, 삭제, 단축 링크)
  - 탭 구조
    - 개요: 핵심 필드, 지표(일지 수·총공수), 최근 문서/작업일지/배정/자재 요약 10개
    - 문서: 최근 50개(PTW/공도면/공유문서) + 더보기(문서함 연결) + 전용 뷰어(도면마킹/사진대지/미리보기)
    - 작업일지: 최근 10개 목록 + 사진/사진대지로 이동
    - 배정: 현장-사용자 배정 현황, 배정/해제, 가용 인원 조회
    - 자재: 최근 요청/재고/출고/입출고 요약 + 자재관리 딥링크
    - 설정: 현장 메타데이터 수정/아카이브(선택)/삭제

## 4) 연계 지점(도메인 맵)

- 문서계: PTW, 공도면(blueprint), 공유문서함(unified_document_system)
- 사진계: 작업일지 사진(보수 전·후), 사진대지 문서(photo grid)
- 작업일지: daily_reports, 일지별 사진대지/사진 링크
- 사용자/배정: profiles, site_assignments(역할: worker/site_manager/supervisor)
- 파트너사: partner_companies, site_partners
- 자재: material_requests / shipments / inventory (최근 10개 요약)
  - 엑셀 다운로드: 요청 목록(필터/정렬 반영) CSV 지원

## 5) 컴포넌트/상태 관리

- 상단 셸: SiteHeader, SiteActionBar(정보 수정/상태변경/삭제/단축액션)
- 탭: SiteOverview, SiteDocuments, SiteDailyReports, SiteAssignments, SiteMaterials, SiteSettings
- 공통: Confirm 모달(useConfirm), Toast(useToast), LoadingSkeleton, ErrorAlert
- 데이터 패턴
  - SSR로 1차 페이로드(핵심/최근 데이터) + 클라이언트에서 보강(최신화)
  - 탭별 fetch는 no-store, 필요 시 react-query 캐시 도입(서버 액션과 일관성 유지)
  - 갱신 규칙: 수정/상태변경/삭제 후 탭/목록 자동 새로고침

## 6) API/서버 액션 – 현재/보강

- 사이트 CRUD (완료/보강)
  - GET/POST /api/admin/sites
  - GET/PATCH/DELETE /api/admin/sites/:id
  - PATCH /api/admin/sites/bulk-status, POST /api/admin/sites/bulk-delete
  - [신규] POST /api/admin/sites/bulk-restore (소프트 삭제 복구)
  - [신규] POST /api/admin/sites/bulk-purge (영구 삭제)
- 통합 지표/최근 데이터(보강 제안)
  - GET /api/admin/sites/:id/integrated → 최근 문서/작업일지/배정/요청 요약 묶음
  - GET /api/admin/sites/:id/stats → 일지 수/총공수(현행 유지/최적화)
  - GET /api/admin/sites/:id/documents → unified 문서 최근 N
  - GET /api/admin/sites/:id/daily-reports?q=&sort=&order=&limit=&offset= → 보고서 목록(검색/정렬/페이징)
  - GET /api/admin/sites/:id/assignments?q=&role=&sort=&order=&limit=&offset= → 배정 목록(검색/정렬/페이징)
  - GET /api/admin/sites/:id/materials/summary → 재고/출고 요약
  - GET /api/admin/sites/:id/materials/requests?q=&status=&sort=&order=&limit=&offset= → 요청 목록(검색/정렬/페이징)
  - GET /api/admin/sites/:id/materials/transactions?q=&limit=&offset= → 입출고 목록(검색/페이징, 총건수 q 반영)
  - (신규) GET /api/admin/sites/:id/assignments/export?cols=&preset= → 배정 XLSX 다운로드(열 선택/프리셋)
  - (신규) GET /api/admin/sites/:id/materials/requests/export?cols=&preset= → 자재 요청 XLSX 다운로드(열 선택/프리셋)
  - (선택) POST /api/admin/sites/:id/actions/{archive|restore} – 소프트 삭제/보관

## 7) 데이터베이스/인덱스/뷰 제안

- 인덱스
  - sites(status), sites(organization_id), sites(created_at desc)
  - material_requests(site_id, created_at desc)
  - daily_reports(site_id, work_date desc)
- 뷰(View) 제안
  - site_latest_documents_v: 사이트별 최신 문서 10개
  - site_latest_reports_v: 사이트별 최신 일지 10개
  - site_assignments_v: 배정 + 프로필 이름/조직 조인
  - 필요 시 통합 뷰 site_overview_v (요약 지표/최근 링크)
- 소프트 삭제(결정/완료)
  - sites.is_deleted boolean(default false) + 기본 쿼리 is_deleted=false 적용
  - 복구(bulk-restore)/완전삭제(bulk-purge) API 및 목록 UI 제공

## 8) 권한/보안

- Admin API: 서버액션 내부에서 service role 사용, 앱 레벨 권한으로 제어
- Restricted(파트너사/고객담당) 접근: organization_id 기반 필터링 유지
- RLS: 모바일/일반 사용자 API는 RLS 준수, 관리자 화면은 service role 최소화 사용

## 9) 성능/UX 패턴

- SSR + skeleton, 탭 전환 시 지연 로딩, 데이터 벌크 요청 최소화
- 중요 액션은 Toast + Confirm 표준화, 실패 시 친절한 메시지
- 프리패치: 목록 hover 시 상세 프리패치, 상세에서 탭 데이터 사전 프리패치

## 10) 오류/관측성

- 감사 로그(audit_logs): create/update/delete/bulk-status 기록(이미 구현된 패턴 확장)
- 클라이언트 로그(개발): 콘솔 노이즈 최소화, 운영은 Sentry/Log전송(선택)
- 표준 에러 응답: { success, error, message } 유지

## 11) 테스트 전략

- 단위: 서버액션(createSite/updateSite/deleteSites/updateSiteStatus), 입력 검증
- 통합: 각 API 경로 2xx/4xx/403 케이스
- E2E: 목록→생성→상세→수정→상태변경→삭제(현재 스펙 추가됨) + 문서/일지/배정/자재 탭 이동
- 시드 스크립트: 테스트용 샘플 사이트/문서/일지/배정/요청 생성

## 12) 릴리즈/롤아웃

- 브랜치: feature/admin-sites-crud → develop → main
- 점진적 릴리즈: 목록/상세 개요/액션바 → 탭별 확장(문서/일지/배정/자재)
- 문서화/핸드오프: 운영 가이드/사용자 가이드 간략 정리

## 13) 결정 사항(확정)

- 소프트 삭제(sites.is_deleted) 도입: 복구/영구삭제 포함
- 통합 데이터: 하이브리드(개요는 integrated, 탭은 독립) 전략
- 문서/사진 뷰어 경로 표준화: markup/photo-grid/PTW/generic 라우트 고정, PDF는 브라우저 기본 뷰어 사용

## 14) 마일스톤 진행 현황

1. 기반/정리(완성도 향상)
   - [x] 사이트 CRUD API 정리(DELETE/일괄)
   - [x] 목록 선택/일괄작업 + Confirm/Toast
   - [x] 상세 액션바(상태변경/삭제/수정) + 탭 URL 동기화
   - [x] 문서/일지/배정/자재 탭 로딩 스켈레톤 정교화(기본)
   - [x] 소프트 삭제 도입(목록 필터 포함: 삭제 포함/삭제만 보기, 복구/영구삭제)
2. 통합/연동 강화
   - [x] /api/admin/sites/:id/integrated 엔드포인트(SSR 개요 반영, 폴백 제거)
   - [x] 문서 뷰어: 표준 경로 적용(markup/photo-grid/PTW/generic), 링크 안정화
   - [x] 문서 탭: PTW/공도면/공유문서 필터 토글

- [x] 작업일지 탭: 사진/사진대지 양방향 링크 (Reports ↔ Photos/사진대지)
- [x] 배정 탭: 사용자 배정/제외 빠른 액션(다이얼로그)
- [x] 배정 탭: 검색/정렬/역할 필터/가용 인원/페이지네이션 고도화(+서버 API)
- [x] 자재 탭: 요청 목록(검색/상태/정렬/페이지네이션) + 재고/출고 요약 + 입출고 목록 + 자재관리 딥링크
- [x] 자재 탭: 입출고(Transactions) 총건수 집계에 검색(q) 반영
- [x] 작업일지 탭: 검색/정렬/페이지네이션 추가
- [x] 배정/자재 목록 XLSX 다운로드(열 선택/프리셋, 필터/정렬 반영) 1차 완료

3. 데이터/권한/성능
   - [x] 소프트 삭제 DB/인덱스 반영
   - [ ] 통합 뷰/인덱스 추가 검토(site*latest*\* 뷰)
   - [ ] 캐시/프리패치 전략 적용, 대용량 페이지네이션 최적화
4. 테스트/릴리즈
   - [x] E2E: Admin Sites CRUD 기본 플로우 추가
   - [ ] API/서버액션 유닛/통합 테스트 보강
   - [ ] 문서화/릴리즈 절차 갱신

## 15) 남은 작업(요약)

- 작업일지 탭: 사진/사진대지 양방향 링크 고도화(바로가기 외 연계 강화)
- 배정/자재: 다운로드(엑셀) 옵션 추가 및 열 선택(선택)
- 배정/자재: 다운로드(엑셀) 옵션 추가 및 열 선택(선택) — 1차(배정/요청 CSV) 완료, 열 선택/다중 시트는 선택
- 전역 링크 점검(모바일/레거시 포함): file_url 직접 링크 → 뷰어/서명 URL 경유로 통일
- 테스트 보강: API/액션 유닛/통합 테스트, E2E 확장(배정/자재 페이징/필터, 복구/영구삭제/문서 필터/뷰어)

## 16) 세션 메모(진행 스냅샷)

- 소프트 삭제(삭제 포함/삭제됨만 보기/복구/영구삭제) 구현 및 UI/API 반영 완료
- 개요 SSR 통합(폴백 제거), 문서 뷰어 표준화 및 서명 URL 경유, PDF 네이티브 뷰어 사용
- 문서 탭 필터(PTW/공도면/공유) 추가
- 배정 탭: 사용자 배정 다이얼로그/제외 버튼 + 검색/정렬/역할 필터/가용 인원/페이지네이션 구현(서버 API 확장 포함)
- 자재 탭: 요청 목록(검색/상태/정렬/페이지네이션), 재고 스냅샷, 최근 출고, 최근 입출고(Transactions) 섹션 추가 + 자재관리 딥링크 적용
- 신규/확장 API: /api/admin/sites/:id/assignments(검색/정렬/페이징), /materials/summary, /materials/requests, /materials/transactions
- 다음 세션: 작업일지 탭 사진/사진대지 양방향 링크, 입출고 총건수의 검색 반영(선택), 다운로드(엑셀) 옵션, 전역 링크 점검, 테스트 보강

## 14) 우선순위/의사결정 요청

- 소프트 삭제 도입 여부(sites.is_deleted)
- 통합 뷰/엔드포인트 방식 선택(단일 integrated vs 탭별 독립 호출)
- 문서/사진 전용 뷰어 경로 표준화 범위(도면마킹/사진대지)

---

본 개선안은 현행 구현을 기반으로 한 0.1 초안입니다. 확인 후 우선순위와 범위를 확정하면 바로 마일스톤 1 항목부터 적용을 시작하겠습니다.
