# DY0926 작업일지 화면 개선 계획

## 1. 참고 자료 개요

- **디자인 원본**: `dy_memo/new_image_html_v3.0/inopnc-page/public/raw/task.html`
- **현재 앱 화면**: 현장관리자 > 홈 > 작업일지 작성 (`modules/mobile/components/home/HomePage.tsx`)
- **관련 컴포넌트**: 요약(`modules/mobile/components/home/SummarySection.tsx`), 멀티선택 버튼(`modules/mobile/components/home/MultiSelectButtons.tsx`), 작업일지 서브 컴포넌트(`modules/mobile/components/work-log/*` 등)

## 2. 현행 구현 요약

- 홈 화면은 공지, 작업일지 작성 폼, 사진 업로드, 도면마킹 퀵 액션, 작성 내용 요약 순으로 구성 (`HomePage.tsx:443-775`).
- 작업일지 작성 폼은 소속/현장 선택, 날짜·작성자, 부재명/작업공정/작업유형(멀티선택), 위치, 공수 입력, 추가 인력, 임시저장/저장 기능을 제공.
- 저장 결과는 `SummarySection` 하나로만 요약되며, 작업일지 리스트나 상세보기, 캘린더/검색 UI는 미구현.
- 사진·도면 기능은 별도 카드(`PhotoUploadCard`, `DrawingQuickAction`)로 분리되어 있으며, 작성 흐름과 느슨하게 연결.

## 3. 요구 UI/기능 요약 (task.html 기준)

1. **페이지 레이아웃**
   - 고정 헤더, 빠른 메뉴, 공지, 요약 카드, 작업일지 리스트, 상세보기, 캘린더, 작성 폼이 한 화면에 구성.
2. **검색·필터 영역**
   - 현장 / 기간 드롭다운, 검색창 확대 애니메이션, 초기화 버튼, 다중 상태 배지 표시.
3. **작업일지 리스트**
   - 요약 정보(현장, 공정, 일자, 공수 등) + 상태 뱃지(임시저장/제출 등) + 첨부 문서 카운트.
   - 무한스크롤/더보기, 클릭 시 풀스크린 상세 뷰 호출.
4. **상세 보기 (Fullscreen)**
   - 기본 정보, 첨부 문서 탭(사진대지/진행도면/완료확인서/기타), 줌 컨트롤, 탭 전환, 닫기 버튼.
5. **캘린더 뷰**
   - 월간 캘린더에 작업일지 수/상태 표현, 일자 선택 시 리스트와 연동.
6. **작성 폼**
   - 디자인 시스템 맞춤 여백/순서/타이포, 섹션별 구분선, 칩 선택, 사용자 정의 입력, 서포트 텍스트.
   - 공정/유형 칩 활성화 스타일, 공수 입력 컨트롤, 추가 인력 카드, 기타 정보(특이사항) 섹션.
7. **보조 기능**
   - 작업일지 검색 초기화 로직, 데이터 모킹/정렬/필터 스크립트, 탭/줌 제어 등 풍부한 인터랙션.

## 4. 격차 분석

| 구분          | 요구사항                                   | 현재 구현                        | 격차 및 이슈                                      |
| ------------- | ------------------------------------------ | -------------------------------- | ------------------------------------------------- |
| 레이아웃      | 한 화면에서 리스트·캘린더·폼 통합          | 폼 중심, 나머지 부재             | 전체 레이아웃 재구성 필요 (페이지 분리 여부 결정) |
| 검색/필터     | 현장·기간 필터, 검색 애니메이션, 초기화    | 미구현                           | UI/상태관리 + API 연동 추가 필요                  |
| 리스트        | 상태/첨부/요약 포함 카드 리스트            | 미구현                           | 리스트 데이터 모델/컴포넌트 작성 필요             |
| 상세뷰        | 풀스크린 문서 뷰, 탭/줌                    | 미구현                           | 모달 + 문서 뷰어 컴포넌트 신규 구현 필요          |
| 캘린더        | 월간 뷰 + 리스트 연동                      | 미구현                           | 캘린더 라이브러리/커스텀 구현 및 데이터 집계 필요 |
| 작성 폼       | 디자인 시스템 맞춤, 다중 섹션, 특이사항 등 | 기본 섹션만 존재, 스타일 상이    | UI 리팩터 + 신규 필드/검증 추가                   |
| 사진/도면     | 상세 뷰와 연동, 첨부 미리보기              | 분리 카드, 리스트/상세 연동 없음 | 저장 흐름/데이터 구조 통합 필요                   |
| 상태관리      | 임시저장/제출, 상태 뱃지, 더보기           | 단순 토스트 + localStorage       | 백엔드 상태 필드 정리, 전역 스토어 도입 검토      |
| 접근성/반응형 | 키보드/모션/다크모드 대응                  | 부분 지원                        | 디자인 가이드에 맞춰 재검토 필요                  |

## 5. 구현 계획

### Phase 1. 설계 및 데이터 정비

1. **요구 기능 분해 및 IA 확정**: 리스트/캘린더/폼을 단일 페이지로 묶을지, 서브 페이지 분리 여부 결정.
2. **데이터 모델 정의**: 작업일지 엔티티에 상태, 첨부 요약, 일정 정보(YYYY-MM-DD), 현장 메타, 공정/유형 배열 등을 정규화. API 스펙 문서화.
3. **전역 상태 관리 검토**: React Query/SWR or Zustand로 리스트·캘린더·폼 간 데이터 공유 구조 설계.

### Phase 2. 공통 UI 인프라

1. **테마/타이포 재사용 토큰 정리** (`modules/mobile/styles` 계층) → task.html의 spacing/typography를 토큰화.
2. **공통 컴포넌트 개발**
   - `FilterBar` (현장/기간/검색/초기화)
   - `TaskDiaryList` 카드 + `TaskDiaryItem`
   - `TaskDiaryStatusBadge`, `AttachmentCount`
   - `TaskCalendar` (캘린더 + 데이터 표시)
   - `DiaryDetailViewer` (fullscreen modal)
   - `TaskFormSection` 래퍼 및 `ChipSelector` 등 스타일 요소.

### Phase 3. 데이터 연동 & 화면 통합

1. **리스트 + 필터 구현**
   - API: `/api/mobile/worklogs` (필터 파라미터: siteId, period, query, status)
   - 클라이언트: 필터 상태 → fetch → 리스트 렌더.
2. **상세 뷰어**
   - 리스트 아이템 선택 시 상세 API 호출 or 기존 데이터 활용.
   - 문서 탭: 사진/도면/완료확인서/기타 => Supabase Storage or API 연결.
3. **캘린더 연동**
   - 월간 데이터 사전 로드 (일자별 count/status map).
   - 날짜 클릭 → 필터 상태 업데이트 → 리스트 재검색.
4. **작성 폼 리팩터링**
   - task.html 구조에 맞게 섹션/스타일 조정.
   - 특이사항, 작업 지시, 위험요소 등 누락 필드 추가.
   - 저장/임시저장 흐름을 리스트/상세와 동기화 (성공 시 리스트 갱신).
5. **사진·도면 통합**
   - 첨부 저장 구조 재정의 (사진/도면 → 작업일지 엔티티 참조).
   - 상세보기 탭과 같은 데이터 구조로 반환.

### Phase 4. 마이그레이션 & QA

1. **기존 로컬스토리지 의존 제거**: Supabase 영속 저장 체계 확립, 필요한 경우 IndexedDB 캐시 도입.
2. **상태 전환 플로우**: 임시저장→제출, 제출 후 수정, 삭제 시나리오 설계.
3. **다국어/다크모드/접근성 검증**: 키보드 탭 순서, 스크린리더 라벨, 모션감소 옵션.
4. **End-to-End 테스트 시나리오**: 필터링, 작성→저장→리스트 반영, 상세 뷰 첨부 탭, 캘린더 동기화.
5. **롤아웃 전략**: 기능 토글(ENV 플래그) 또는 베타 사용자로 단계적 배포.

## 6. 기술 고려사항

- **API 확장**: 현재 `HomePage.tsx`는 `/api/admin/daily-reports`만 호출. 리스트/캘린더/상세 위한 신규 API 필요.
- **성능**: 월간 캘린더 + 리스트 동시로드 시 배치 요청, skeleton/placeholder 도입 필요.
- **파일 처리**: 사진/도면 저장 구조를 작업일지와 1:N 관계로 통일, 썸네일/미리보기 URL 캐시 전략 수립.
- **상태 관리**: 저장 후 즉시 리스트 갱신 위해 optimistic update or invalidation 전략 설계.
- **리팩터 우선순위**: 현재 홈 화면이 점차 복잡해지는 문제 → 라우팅 분리 (`/mobile/worklogs`) 검토.

## 7. QA 및 테스트 플랜

- **단위 테스트**: 필터 상태 리듀서, 리스트 포맷터, 칩 선택 컴포넌트.
- **통합 테스트**: 작업일지 생성 → API 응답 → 화면 반영 플로우.
- **시각/UX 검증**: 디자인 스펙 vs 구현 스크린샷 비교 체크리스트 작성.
- **베타 리포트**: 현장 관리자 파일럿 그룹을 통한 실제 데이터 입력 테스트.

## 8. 즉시 수행해야 할 선행 작업

1. 요구사항 추가 확정 (필수/옵션 구분, API 존재 여부 확인).
2. 데이터 스키마/엔드포인트 초안 작성 후 백엔드 팀 협의.
3. UI 토큰/스타일 시스템 정리 (task.html에서 추출).
4. 기능 플래그 설계 및 기존 홈 화면 영향도 문서화.

본 계획안을 기반으로 추가 요구사항이 확정되면 각 Phase별 세부 일정과 티켓을 분할하여 진행합니다.

---

## Phase 1 수행 결과 (2025-09-26)

### 1. 정보 구조(IA) 확정

- **상위 구조**: `/mobile/worklogs` 신규 라우트로 이동하여 세 영역(개요, 작성, 리소스)을 뷰포트 높이 기준 세로 스크롤 구조로 배치.
  - **개요 영역**: 빠른 현황 카드(오늘 공수/임시저장 건수), 필터/검색, 캘린더/리스트 탭 토글.
  - **리스트 뷰**: 필터 바 바로 아래에 고정. 아이템 클릭 시 `DiaryDetailViewer` 풀스크린 진입.
  - **작성 폼**: 페이지 하단 고정 카드(스크롤 anchor)로 이동. 저장/임시저장 완료 시 리스트 invalidate & success banner.
  - **보조 리소스**: 사진 업로드/도면마킹은 작성 폼 내부의 “첨부” 섹션으로 통합, 별도 카드 제거.
- **네비게이션**: 홈 빠른메뉴의 “작업일지” 버튼은 `/mobile/worklogs`를 오픈. 기존 홈 카드에서는 핵심 요약만 유지.
- **반응형 전략**: 모바일 기본(1열) 기준, 768px 이상에서는 좌측 리스트 + 우측 상세 미리보기(슬라이드 패널) 레이아웃 제공.

### 2. 데이터 모델 & API 초안

#### 엔티티 정의 (TypeScript 인터페이스)

```ts
export interface WorklogSummary {
  id: string
  siteId: string
  siteName: string
  workDate: string // YYYY-MM-DD
  memberTypes: string[]
  processes: string[] // 작업공정
  workTypes: string[]
  manpower: number // 총 공수
  status: 'draft' | 'submitted' | 'approved' | 'rejected'
  attachmentCounts: {
    photos: number
    drawings: number
    completionDocs: number
    others: number
  }
  createdBy: {
    id: string
    name: string
  }
  updatedAt: string
}

export interface WorklogDetail extends WorklogSummary {
  location: {
    block: string
    dong: string
    unit: string
  }
  notes: string
  safetyNotes: string
  additionalManpower: Array<{ id: string; name: string; manpower: number }>
  attachments: {
    photos: Attachment[]
    drawings: Attachment[]
    completionDocs: Attachment[]
    others: Attachment[]
  }
}

export interface Attachment {
  id: string
  name: string
  type: 'photo' | 'drawing' | 'document'
  category: 'before' | 'after' | 'markup' | 'completion' | 'other'
  previewUrl: string
  fileUrl: string
}

export interface WorklogCalendarCell {
  date: string // YYYY-MM-DD
  total: number
  submitted: number
  draft: number
}
```

#### REST API 제안

| 메서드 | 경로                            | 설명           | 쿼리/바디                                                |
| ------ | ------------------------------- | -------------- | -------------------------------------------------------- |
| GET    | `/api/mobile/worklogs`          | 리스트 조회    | `siteId`, `from`, `to`, `status`, `query`, `cursor`      |
| GET    | `/api/mobile/worklogs/calendar` | 월간 집계      | `siteId`, `month`(YYYY-MM)                               |
| GET    | `/api/mobile/worklogs/{id}`     | 상세 조회      | -                                                        |
| POST   | `/api/mobile/worklogs`          | 신규 작성      | `WorklogDetail` 생성 payload (임시저장/제출 플래그 포함) |
| PATCH  | `/api/mobile/worklogs/{id}`     | 수정/상태 변경 | 필드별 partial 업데이트, `status` 전환                   |
| DELETE | `/api/mobile/worklogs/{id}`     | 삭제 (옵션)    | -                                                        |

> **연동 요구**: 기존 `/api/admin/daily-reports`를 래핑하거나 신규 엔드포인트 제공 필요. 첨부는 Supabase Storage key를 참조하도록 통일.

### 3. 상태 관리 전략

- **데이터 패칭**: React Query 도입
  - `useWorklogList(queryKey)` → 필터/페이지네이션 대응, 무한스크롤 지원.
  - `useWorklogDetail(id)` → 상세 뷰어에서 lazy load.
  - `useWorklogCalendar(month, siteId)` → 캘린더 데이터 캐시.
- **폼 상태**: React Hook Form + Zod 검증 적용, 저장/임시저장 시 `mutateAsync` 사용.
- **전역 컨텍스트**: `WorklogViewStore` (Zustand)로 필터/선택 항목/모달 상태를 관리.
- **로컬 캐싱**: 네트워크 불안 대비 임시저장은 localStorage fallback 유지하되, React Query `onMutate`/`onError` 훅으로 동기화.

### 4. 협업/의존 메모

- 백엔드: API 스펙 확정 후 DB 스키마 확인, 기존 daily-reports 테이블 매핑 필요.
- 디자인: spacing/컬러 토큰 정의 공유, 캘린더/리스트 상호작용 상세 확인.
- QA: Phase 3 이후 Cypress or Playwright 시나리오 준비.

Phase 1 산출물은 추후 티켓화 시 참고할 수 있도록 본 문서에 지속 업데이트합니다.

## Phase 2 진행 상황 (2025-09-26)

### 1. 스타일 토큰 & 공통 CSS

- `modules/mobile/styles/worklogs.css`: 필터, 리스트, 캘린더, 상세 뷰어를 위한 카드/칠/다크 모드 토큰 정의 및 공통 레이아웃 규칙 추가.

### 2. 공유 UI 컴포넌트 스켈레톤

- `modules/mobile/components/worklogs/FilterBar.tsx`: 현장·기간 셀렉트, 검색, 상태 칩 필터 담당.
- `modules/mobile/components/worklogs/TaskDiaryList.tsx`, `TaskDiaryListItem.tsx`: 상태 배지·첨부 개수 표시가 포함된 리스트 카드 UI.
- `modules/mobile/components/worklogs/WorklogStatusBadge.tsx`: 상태별 스타일 캡슐화를 통해 다른 화면에서도 재사용 가능하도록 분리.
- `modules/mobile/components/worklogs/TaskCalendar.tsx`: 월간 캘린더 뷰/달 이동/일자 선택 이벤트를 제공하는 캘린더 골격.
- `modules/mobile/components/worklogs/DiaryDetailViewer.tsx`: 풀스크린 상세 뷰어, 첨부 미리보기·다운로드 액션 슬롯, 외부 문서 열람 콜백 지원.
- `modules/mobile/components/worklogs/index.ts`: Phase 3 연동 시 단일 import 경로 제공.

### 3. 타입 확장

- `types/worklog.ts`: `WorklogStatus`, `WorklogSummary`, `WorklogDetail`, `WorklogAttachment`, `WorklogCalendarCell` 정의로 Phase 3 데이터 연동 준비.

> Phase 3에서는 상기 컴포넌트를 `/mobile/worklogs` 라우트에 배치하고 React Query + API 연동, 폼 리팩터링을 진행합니다.
