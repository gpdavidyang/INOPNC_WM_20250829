# 인증 시스템 구현 분석 보고서

## 개요 (Overview)

제안된 인증 시스템(DY260129)은 현재의 인증 아키텍처를 **완전히 재설계**하는 것을 의미합니다. 기존의 일반적인 "즉시 가입 및 로그인" 모델에서, 다단계 인증, 엄격한 세션 제어, 명시적인 관리자 승인을 포함하는 "엔터프라이즈급 관리형 접근 제어" 모델로 전환됩니다.

## 난이도 평가: **높음 (High, 8/10)**

### 왜 난이도가 높은가?

1.  **근본적인 흐름 변화**: 현재의 단일 페이지 가입(`app/auth/signup/page.tsx`)을 다단계 상태 머신(회사 검색 -> 정보 입력 -> OTP -> 승인 대기)으로 교체해야 합니다.
2.  **새로운 보안 요소**: TOTP(Time-based One-Time Password)와 독립적인 세션 관리(인증 세션 vs 앱 세션 분리)는 이 코드베이스에 처음 도입되는 개념입니다.
3.  **인프라 의존성**: Vercel Edge Middleware와 Cloudflare WAF 관련 요구사항은 단순 코드가 아니라 인프라/DevOps 구성을 필요로 하며, 배포 시 정상 트래픽 차단 같은 리스크가 있습니다.
4.  **이중 인증 상태 (Dual Auth State)**: "이메일은 인증되었으나 관리자 승인은 받지 못한 부분 인증 상태"를 처리해야 하는데, 이는 Supabase Auth의 기본 동작(인증됨 = 로그인됨)과 충돌합니다.

## 갭 분석 (Gap Analysis)

| 기능         | 현재 구현                    | 제안된 요구사항                            | 차이 / 노력                                          |
| :----------- | :--------------------------- | :----------------------------------------- | :--------------------------------------------------- |
| **회원가입** | 단일 양식 (이메일/비번/이름) | 다단계 위저드 (회사 검색 -> 정보 -> OTP)   | 🔴 **대형**: 새로운 위저드 UI 및 상태 로직 필요      |
| **승인**     | 즉시/느슨함                  | 엄격한 관리자 승인 큐 (`signup_requests`)  | 🔴 **대형**: 신규 DB 테이블 & 관리자 대시보드 필요   |
| **MFA**      | 없음 (또는 이메일만)         | TOTP (Google Auth) + 모바일 자동 OTP       | 🔴 **대형**: 신규 라이브러리(`otplib`) & UI 컴포넌트 |
| **세션**     | 단순 토큰 갱신               | 기기 추적, 엄격한 타임아웃, 동시 세션 제한 | 🟡 **중형**: 로직은 있으나 강화 필요                 |
| **보안**     | 표준 DB 정책                 | 로그인 백오프, IP 속도 제한(Edge), WAF     | 🟡 **중형**: 미들웨어 & 설정 변경                    |

## 주요 리스크 (Key Risks)

### 1. 사용자 경험(UX) 마찰

- **리스크**: 다단계 프로세스와 "승인 대기 시간"으로 인해, 즉시 가입에 비해 신규 사용자 전환율이 급격히 떨어질 수 있습니다.
- **완화책**: 대기 중인 사용자가 당황하지 않도록 명확한 "상태 확인" 화면을 구현해야 합니다.

### 2. 마이그레이션 및 하위 호환성

- **리스크**: 기존 사용자는 `company_members`나 `auth_factors` 데이터가 없을 가능성이 높습니다. 새 규칙을 강제하면 이들의 로그인이 차단될 수 있습니다.
- **완화책**: "마이그레이션 전략" 필요 (예: 기존 사용자 자동 승인 처리, 다음 로그인 시 회사 선택 유도 등).

### 3. "이중 세션" 복잡성

- **리스크**: Supabase Auth는 이메일 인증 즉시 세션을 생성합니다. 요구사항은 관리자 승인 전까지 앱 접근을 막아야 합니다.
- **기술적 과제**: `profile.status === 'approved'`를 확인하는 "Gatekeeper" 미들웨어를 구현하여, `supabase.auth.user()`가 유효하더라도 승인되지 않았다면 강제로 로그아웃시키거나 "대기 중" 페이지로 리다이렉트해야 합니다.

### 4. Edge Function 콜드 스타트 & 지연

- **리스크**: 검증 로직을 Edge Function/Middleware로 옮길 경우, DB 연결 처리가 미흡하면 지연이나 타임아웃이 발생할 수 있습니다.

## 제안하는 구현 전략

리스크를 완화하기 위해 구현을 철저히 격리된 단계로 나누어 진행하는 것을 권장합니다:

1.  **1단계: 관리자 승인 인프라 (백엔드 전용)**
    - 테이블 생성 (`signup_requests`, `company_members`).
    - RLS 정책 업데이트.
    - **UI 변경 없음**.

2.  **2단계: 게이트키퍼(Gatekeeper) 로직**
    - `useUnifiedAuth` 및 미들웨어에서 `approved` 상태 확인 로직 추가.
    - 미승인 시 정적 "관리자 문의" 페이지로 리다이렉트.
    - _리스크_: 상태 값이 없는 기존 사용자를 위해 'approved'로 설정하는 데이터 마이그레이션 선행 필수.

3.  **3단계: 신규 가입 흐름 (프론트엔드)**
    - 위저드 UI 구축.
    - `signup_requests` 테이블 연동.

4.  **4단계: 고급 보안 (TOTP/Edge)**
    - TOTP는 선택 기능으로 먼저 추가.
    - Rate Limiting은 트래픽 헤더 모니터링 후 마지막에 활성화.
