# DY1007 · 가입요청관리 × 사용자관리 × 인증(로그인/아이디·비번 찾기) 연계 개선 계획

작성일: 2025-10-07
담당: 시스템관리(Administrator) / 인증·계정 도메인

## 1. 개요

가입 요청 → 관리자 승인/거절 → 사용자 생성/배정 → 최초 로그인(비밀번호 변경)까지의 전 과정을 하나의 끊김 없는 여정으로 연결한다. 또한 로그인 실패 시나리오에서 적절한 다음 액션(승인 상태 확인, 비밀번호 재설정, 가입요청)을 유도하여 이탈을 줄이고 처리 속도를 높인다.

## 2. 현황 진단(요약)

- 가입요청 화면은 조회 위주이며 승인/거절/배정 UI가 약함. 승인 서버 액션은 있으나 화면 연동·후속 이동이 미흡.
- 로그인 실패 피드백이 단조로워서 “승인 대기/비활성/오비밀번호/미가입”을 구분하여 안내하지 못함.
- 아이디 찾기 화면 부재. 사용자 스스로 다음 액션을 결정하기 어려움.
- 사용자 상세에서 “가입요청으로 생성됨” 등의 출처 추적/역링크가 없어 이력 파악이 불편.

## 3. 개선 목표

- 사용자: 로그인 실패 시도에서 즉시 올바른 분기(승인대기·비활성·재설정·가입요청)로 유도, 가입요청 제출 후 상태확인/재안내/최초 로그인까지 자연스럽게 연결.
- 관리자: 가입요청 승인→환영 메일 발송→사용자 상세 이동 및 배정/권한 확인이 원클릭으로 이어짐. 메뉴에 대기 건수 뱃지 표시.
- 데이터: 승인으로 생성된 사용자와 원요청 간 추적성 제공(중기적으로 created_user_id 도입 권장).

## 4. 사용자/관리자 여정(간단 플로우)

- 사용자 여정
  1. 로그인 실패 → 상태별 메시지 + 다음 액션 버튼(승인상태 확인/비밀번호 재설정/가입요청)
  2. 가입요청 제출 → 대기 안내 + 상태확인/재안내 버튼 → 승인 완료 시 로그인 유도
  3. 아이디 찾기(이름+휴대폰) → “등록된 메일로 안내 발송” 통일 문구
- 관리자 여정
  1. 가입요청 목록에서 승인/거절 → 승인 모달에서 조직/현장 선택 → 승인 완료 토스트 + “사용자 상세로 이동”
  2. 좌측 네비에 대기 건수 뱃지 표시 → 빠른 대응 유도

## 5. 범위(화면/기능)

- 로그인: `app/auth/login/page.tsx`
- 가입요청: `app/auth/signup-request/page.tsx`, `app/api/auth/signup-request/route.ts`
- 아이디 찾기(신규): `app/auth/find-id/page.tsx`, `app/api/auth/find-id/route.ts`
- 상태조회/재안내(신규): `app/api/auth/signup-request/status/route.ts`, `app/api/auth/signup-request/resend/route.ts`
- 관리자 가입요청: `app/dashboard/admin/signup-requests/page.tsx`, `components/admin/SignupRequestsTable.tsx`, `components/admin/ApprovalModal.tsx(신규)`
- 사용자 관리: `app/dashboard/admin/users/[id]/page.tsx`
- 서버 액션/메일: `app/auth/actions.ts:approveSignupRequest`, `app/actions/admin/email-notifications.ts:sendWelcomeEmail`
- 네비 뱃지: `components/admin/AdminDashboardLayout.tsx`

## 6. API 설계(신규/보강)

- GET `/api/auth/signup-request/status?email=`
  - Res: { success, status: 'pending'|'approved'|'rejected'|null, message }
  - 보안: 존재여부 노출 방지 → 메시지는 일관, status는 본인 검증 이후에만 상세 공개(1차는 단순 메시지)
- POST `/api/auth/signup-request/resend`
  - Body: { email }
  - Res: { success } (rate-limit 필요)
- POST `/api/auth/find-id`
  - Body: { full_name, phone }
  - Res: 항상 200 + “메일로 안내했습니다.” (존재여부 비노출). 실제로 존재 시 안내 메일 발송
- 보강: `approveSignupRequest`
  - 환영메일 발송 `sendWelcomeEmail(...)`
  - 반환값에 `created_user_id` 포함

## 7. 화면/UI 변경 요약

- 로그인
  - 실패 사유 분기(승인대기/비활성/오비밀번호/미가입) + CTA(상태확인, 비번재설정, 가입요청)
  - 쿼리 파라미터: `?email=` 프리필, `?reason=reset_success|approved` 배너
- 가입요청 제출 화면
  - “승인 대기 안내” + 상태 확인/재안내/로그인 이동 버튼
- 아이디 찾기(신규)
  - 이름+휴대폰 입력 → 안내 고정 문구
- 관리자 가입요청 목록
  - 액션 컬럼(승인/거절)
  - 승인 모달에서 조직/현장 선택, 역할별 검증(작업자: 최소 1개 현장, 작업자/현장관리자: 파트너사 필수 등)
  - 승인 성공 토스트 + “사용자 상세로 이동” 버튼
- 사용자 상세
  - “가입요청으로 생성됨” 뱃지/문구 + 원요청 링크(초기에는 쿼리스트링 기반, 후속으로 created_user_id 사용)
- 네비게이션
  - “가입 요청 관리” 메뉴에 대기건수 뱃지 표기

## 8. 데이터/메일

- 메일 템플릿: 환영메일(역할/임시비밀번호/접속경로/보안안내), 비번재설정 안내, 아이디찾기 안내(존재 시)
- 선택적 스키마 확장(권장): `signup_requests.created_user_id UUID NULL`

## 9. 단계별 로드맵

### Phase 1 · 관리자 승인 플로우 완성

- [ ] 승인 모달/액션 UI 탑재: `components/admin/ApprovalModal.tsx(신규)`, `SignupRequestsTable`
- [ ] 서버 액션 보강: `approveSignupRequest`(환영메일, created_user_id 반환)
- [ ] 승인 성공 시 “사용자 상세 이동” 링크 + 네비 대기건수 뱃지
- [ ] E2E: 승인→사용자 상세, 거절 사유 반영

### Phase 2 · 사용자 인증 플로우 보강

- [ ] 로그인 실패 분기/안내/CTA: `app/auth/login/page.tsx`
- [ ] 아이디 찾기 신설: 페이지/라우트(POST `/api/auth/find-id`)
- [ ] 가입요청 제출 화면 개선 + 상태조회/재안내 API 연결
- [ ] E2E: 비번 재설정 완료→로그인 배너, 승인대기 이메일 상태 안내

### Phase 3 · 추적성/보강

- [ ] 사용자 상세에 “가입요청에서 생성” 표기 및 원요청 역링크(초기: 쿼리스트링 / 후속: created_user_id)
- [ ] signup_requests.created_user_id 컬럼 도입(마이그레이션) 및 읽기 경로 교체
- [ ] 레이트리밋/로깅/모니터링(재안내/아이디찾기 남용 방지)

## 10. 테스트 계획

- 단위: status/resend/find-id API, approveSignupRequest 반환값(created_user_id)
- 통합: 승인 모달→유저 생성→메일 발송 모킹→리다이렉트 링크 유효성
- E2E
  - 가입요청 제출→승인대기 화면→관리자 승인→로그인(임시비번 교체)→대시보드 진입
  - 로그인 실패 분기 각각의 CTA 동작
  - 아이디 찾기 제출 후 안내 문구, 메일 발송 모킹 확인
  - 네비 대기건수 뱃지 갱신

## 11. 성능/보안/리스크

- 존재여부 노출 방지 원칙(아이디 찾기/상태 조회/재안내): 사용자에게는 항상 동일 응답, 실제 판단은 백엔드에서만 수행
- 재안내 rate-limit 적용(예: IP/이메일별 시간당 3회)
- 에러/메일 실패 시 승인 자체는 성공으로 간주하고 NOC 로깅·재시도 큐 선택

## 12. 완료 기준(Done)

- 가입요청 승인/거절 UI 및 서버 액션이 일관 동작하며 승인 후 1클릭으로 사용자 상세 이동 가능
- 로그인 실패 분기·아이디 찾기·상태 조회·재안내가 연결되어 사용자 이탈 포인트 최소화
- E2E/통합 테스트 통과 및 메뉴 뱃지 동작 확인

## 13. 작업 영향 파일(요약)

- UI: `app/auth/login/page.tsx`, `app/auth/signup-request/page.tsx`, `app/auth/find-id/page.tsx(신규)`, `components/admin/SignupRequestsTable.tsx`, `components/admin/ApprovalModal.tsx(신규)`, `components/admin/AdminDashboardLayout.tsx`
- API: `app/api/auth/signup-request/status/route.ts(신규)`, `.../resend/route.ts(신규)`, `app/api/auth/find-id/route.ts(신규)`
- 액션/메일: `app/auth/actions.ts:approveSignupRequest`, `app/actions/admin/email-notifications.ts`
- 선택적 스키마: `signup_requests.created_user_id`

---

본 문서는 관리자/인증 도메인의 연결 품질을 높이기 위한 실행 계획서이며, Phase 1 완료 후 단계적으로 확장 적용한다.
