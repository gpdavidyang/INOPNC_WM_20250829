# DY1113 – 자재관리 출고배송결제 화면개선 계획

작성일: 2025-11-13  
요청자: Admin(본사) / Production Manager 팀  
작성자: Codex

## 1. 배경

- 생산관리자 모바일 앱의 `출고 정보 입력` 폼에서 입력하는 필드가 본사 관리자 화면(`자재 관리 > 출고배송결제`)에 제대로 반영되지 않아 정보 불일치가 발생.
- 관리자 테이블은 현재 출고번호, 출고품목 요약, 상태, 출고일, 배송/결제(택배/청구방식), 금액/수금/미수만 노출하며 체크박스 옵션, 자재거래처, 선불/착불 등의 핵심 필드는 숨겨져 있음.
- 일부 테넌트에서 DB 스키마가 상이해 FK/컬럼 불일치가 발생하므로, 표시 필드 역시 스키마 의존도를 최소화한 방식으로 재구성해야 함.

## 2. 현재 vs. 목표 필드 정합성

| 구분     | 생산관리자 `출고 정보 입력` 필드                   | 본사 관리자 현재 컬럼               | 비고                                       |
| -------- | -------------------------------------------------- | ----------------------------------- | ------------------------------------------ |
| 품목     | 출고 품목(다중)                                    | 출고품목 요약                       | 요약 로직은 존재하나 상세 수량/단가 미노출 |
| 일정     | 출고일                                             | 출고일                              | 정합                                       |
| 현장     | 현장명 선택                                        | 출고번호 셀 하단에 현장명           | 가독성 낮음, 별도 컬럼 필요                |
| 거래처   | 자재거래처                                         | 없음                                | 신설 필요                                  |
| 금액     | 출고금액(공급가)                                   | 금액/수금/미수                      | 정합, 단위 표기 보완                       |
| 상태     | 상태(대기/완료)                                    | 드롭다운(준비중/출고/배송완료/취소) | 라벨 상이 → 통합 필요                      |
| 청구     | 청구방식                                           | 배송/결제 셀에 텍스트 하나만 노출   | 청구/배송/선불 분리 필요                   |
| 배송     | 배송방식                                           | 배송/결제 셀                        | 셀 재구성 필요                             |
| 운임     | 선불/착불                                          | 배송/결제 셀                        | 셀 재구성 필요                             |
| 체크옵션 | 전자세금계산서, 거래명세서, 운임비 지불, 금액 청구 | 없음                                | 뱃지/아이콘 형태로 노출 필요               |
| 부가정보 | 운송장, 운임/결제 메모 등                          | 없음                                | 2차 개선 범위, 본 계획에서는 제외          |

## 3. 목표 UI 개편 방향

1. **정보 그룹화**
   - `출고번호 / 현장 / 거래처`를 첫 번째 열에 카드 형태로 배치하여 식별성 강화.
   - `품목 요약`은 두 번째 열로 유지하되 수량 합계·주요 자재 표시.
2. **상태 & 일정**
   - 상태 드롭다운을 유지하되, 라벨을 `대기(=preparing) / 출고(=shipped) / 완료(=delivered) / 취소`로 통일.
   - 출고일 컬럼을 상태 오른쪽에 위치시켜 진행상황 확인을 용이하게 함.
3. **금액 & 결제**
   - `청구방식 / 배송방식 / 선불·착불`을 별도 컬럼(아이콘+라벨)로 구분.
   - 금액, 수금, 미수는 3열 카드 그대로 유지.
4. **결제 체크옵션**
   - `전자세금계산서, 거래명세서, 운임비 지불, 금액 청구`는 뱃지 리스트로 요약.
5. **액션 영역**
   - 상세보기/편집 링크는 유지.

## 4. 데이터 매핑 및 백엔드 고려사항

1. **스키마 불일치 대응**
   - `partner_company_id`, `billing_method_id` 등 일부 컬럼이 없는 환경을 고려하여, `notes` 메타데이터 스냅샷(이미 mobile 폼에서 저장)을 파싱해 결제/체크옵션 정보를 재구성.
   - FK가 있는 경우에는 조인, 없는 경우에는 `payment_methods`/`material_partners` 기본 조회 후 매핑.
2. **API 응답 확장**
   - `getMaterialShipments` 결과에 `partner`, `billing_label`, `shipping_label`, `freight_label`, `payment_flags`(etax/statement/freight_paid/bill_amount) 필드 추가.
   - 데이터는 `material_shipments` 테이블 컬럼 → 없으면 metadata snapshot(예: `notes` JSON) → 레거시 텍스트 순으로 결정.
3. **Hydration Helper 재사용**
   - 기존 `hydrateShipmentRelations`에서 파트너/체크옵션 로직을 추가, 단일 반복으로 관계 데이터를 확보.

## 5. 구현 단계

1. **데이터 모델 정의**
   - `MaterialShipment` 타입 확장 (`partner_name`, `billing_label`, `shipping_label`, `freight_label`, `flags` 등).
   - metadata snapshot parser 유틸 추가(기존 `shipping-form` 로직 재사용 가능).
2. **서버 액션 보강**
   - `getMaterialShipments`에서 metadata 파싱 및 레거시 컬럼 매핑.
   - FK 미존재 환경에서도 파트너명/결제옵션이 노출되도록 `hydrateShipmentRelations` 업데이트.
3. **UI 컴포넌트 개편**
   - `ShipmentsTable` 열 재구성: (1) 출고정보 카드, (2) 품목, (3) 결제/배송, (4) 금액요약, (5) 체크옵션 뱃지, (6) 상태/출고일.
   - 표준화된 라벨/아이콘 컴포넌트 정의.
4. **정합 검증**
   - 생산관리자 앱에서 신규 출고 생성 → 관리자 탭에서 동일 정보 확인.
   - FK가 없는 개발 DB에서도 동일 UI가 렌더링되는지 확인.
5. **QA 및 접근성 점검**
   - 반응형 레이아웃, 스크린리더 레이블, 정렬/필터 영향 테스트.

## 6. 테스트 시나리오

1. 출고 등록 → 관리자 탭 목록에 동일 현장/거래처/결제옵션 노출.
2. 체크박스 조합별(예: 전자세금계산서만, 운임비 지불만 등) UI 뱃지 확인.
3. FK 없는 스키마(개발 DB)에서 데이터 조회 오류 없는지 확인.
4. 상태 변경/배송방법 수정 액션이 여전히 작동하는지 확인.
5. 목록 엑셀 다운로드 시 신규 컬럼 포함 여부 확인(추가 범위 협의).

## 7. 오픈 이슈

1. `notes` JSON 스냅샷 스키마가 환경마다 상이할 수 있으므로 파서에 방어 로직 필요.
2. 운임/결제 메모 등 추가 텍스트 필드 노출 여부는 2차 개선에서 검토.
3. 실 데이터에 파트너 정보가 없는 경우 대체 텍스트(예: `직접입력`) 정의 필요.

---

위 계획에 따라 서버 액션/테이블 모두 정비한 후, 디자인 확정 시 상세 와이어를 추가 배포한다.
