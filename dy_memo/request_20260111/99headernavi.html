<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <title>INOPNC - 이식5 (Final Integrated)</title>

  <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" />
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>

  <style>
    /* =========================================================
      INOPNC 이식4 - 100% 이식 (Modified for 4050 Target)
      - ID/함수 네임스페이스: i3_ / INOPNC_I3
      - 가독성 강화: 폰트 17px, 줄간격 1.6
      - 하단 네비게이션 상단 여백 추가
    ========================================================= */

    /* (권장) 이 파일 단독 사용 시 최소 기본값 */
    html, body { margin:0; padding:0; }
    body { background:#0000; }

    /* =================================================================
      [1. 디자인 시스템] (Scoped)
    ================================================================= */
    #inopnc-i3-root{
      /* ✅ 폰트 정의 확인됨: Pretendard 우선 적용 */
      --font-main: "Pretendard Variable", Pretendard, -apple-system, BlinkMacSystemFont, system-ui, Roboto, sans-serif;

      /* =========================
         Typography Design Tokens
         (40~50대 작업자 가독성 최적화)
      ========================= */
      --fs-tiny: 13px;   /* 아주 작은 배지/부가정보 */
      --fs-sm: 15px;     /* 보조 텍스트/날짜 */
      --fs-base: 17px;   /* 본문 기본 텍스트 */
      --fs-lg: 20px;     /* 카드 제목/강조 */
      --fs-xl: 24px;     /* 통계/헤더 타이틀/큰 숫자 */

      --fw-reg: 400;
      --fw-med: 500;
      --fw-bold: 700;
      --fw-black: 800;

      /* 모바일 가독성(줄 간격/자간) */
      --lh-tight: 1.35;
      --lh-base: 1.65;
      --lh-loose: 1.8;
      --ls-base: 0.005em;


      /* [Light Mode] */
      --primary: #31a3fa;
      --primary-bg: #eaf6ff;
      --header-navy: #1a254f;
      --text-main: #111111;
      --text-sub: #475569;
      --text-placeholder: #94a3b8;

      --bg-body: #f2f4f6;
      --bg-surface: #ffffff;
      --bg-input: #ffffff;
      
      /* 기본 검색창 배경색 (헤더) */
      --bg-search-input: #f1f5f9; 
      
      --border: #e2e8f0;

      --danger: #ef4444;
      --del-btn-bg: #fff1f2;
      --btn-logout-bg: #1a254f;
      --btn-clear-bg: #cbd5e1;
      --btn-clear-text: #ffffff;
      --upload-photo-bg: #f8fafc;
      --upload-photo-text: #475569;

      /* [Tone & Manner] 민트 컬러 (확인서 버튼용) */
      --btn-cert-bg: #ecfdf5;
      --btn-cert-text: #059669;
      --btn-cert-border: #6ee7b7;

      /* 레이아웃 규격 */
      --header-height: 60px;
      --nav-height: 75px; /* 네비게이션 패딩 추가로 높이 변수 미세 조정 */
      --h-common: 48px;
      
      /* 그림자 효과 */
      --shadow-soft: 0 4px 20px rgba(0,0,0,0.08); 
      --shadow-input: 0 4px 12px rgba(0,0,0,0.08);

      font-family: var(--font-main);
      font-size: var(--fs-base); 
      color: var(--text-main);
      background-color: var(--bg-body);
      line-height: var(--lh-base);
      letter-spacing: var(--ls-base);

      /* 헤더/하단바 공간 확보 */
      min-height: 100vh;
      padding-top: var(--header-height);
      padding-bottom: calc(var(--nav-height) + 20px);

      -webkit-text-size-adjust: 100%;
      overflow-x: hidden;
      touch-action: manipulation;
      transition: background-color 0.3s, color 0.3s;
      position: relative;
      width:100%;
    }

    /* =======================================================
       Typography Application (scoped)
       - 버튼/입력: 터치 고려하여 fs-base 이상
       - 숫자/통계: 더 굵고 크게
    ======================================================= */
    #inopnc-i3-root button,
    #inopnc-i3-root .btn,
    #inopnc-i3-root .i3-btn,
    #inopnc-i3-root input,
    #inopnc-i3-root select,
    #inopnc-i3-root textarea {
      font-size: var(--fs-base);
      line-height: var(--lh-base);
      letter-spacing: var(--ls-base);
      font-weight: var(--fw-bold);
    }

    #inopnc-i3-root .i3-kpi,
    #inopnc-i3-root .kpi,
    #inopnc-i3-root .stat,
    #inopnc-i3-root .stats,
    #inopnc-i3-root .i3-stat,
    #inopnc-i3-root .i3-stat-value,
    #inopnc-i3-root .i3-kpi-value,
    #inopnc-i3-root .i3-count,
    #inopnc-i3-root .count,
    #inopnc-i3-root .num,
    #inopnc-i3-root .number,
    #inopnc-i3-root .i3-number {
      font-size: var(--fs-xl);
      font-weight: var(--fw-black);
      line-height: var(--lh-tight);
      letter-spacing: 0;
      font-variant-numeric: tabular-nums;
    }

    #inopnc-i3-root .date,
    #inopnc-i3-root .time,
    #inopnc-i3-root .phone,
    #inopnc-i3-root .tel,
    #inopnc-i3-root .i3-date,
    #inopnc-i3-root .i3-time,
    #inopnc-i3-root .i3-tel {
      font-size: var(--fs-sm);
      font-weight: var(--fw-med);
      font-variant-numeric: tabular-nums;
    }



    /* 기본 리셋 */
    #inopnc-i3-root *, 
    #inopnc-i3-root *::before, 
    #inopnc-i3-root *::after { box-sizing: border-box; }
    #inopnc-i3-root a { text-decoration: none; color: inherit; }
    #inopnc-i3-root button,
    #inopnc-i3-root select,
    #inopnc-i3-root input,
    #inopnc-i3-root textarea {
      font-family: var(--font-main);
      outline: none;
      -webkit-tap-highlight-color: transparent;
      box-sizing: border-box;
    }

    /* =================================================================
      [2. 공통 UI 컴포넌트] (Scoped)
    ================================================================= */
    /* Header */
    #inopnc-i3-root .app-header {
      position: fixed; top: 0; left: 0; right: 0;
      height: var(--header-height);
      background-color: var(--bg-surface);
      width: 100%; max-width: 600px;
      margin: 0 auto;
      z-index: 100;
    }
    #inopnc-i3-root .header-inner {
      width: 100%; max-width: 600px; padding: 0 16px;
      display: flex; justify-content: space-between; align-items: center;
    }
    #inopnc-i3-root .brand-logo {
      font-size: var(--fs-xl); font-weight: var(--fw-black);
      color: var(--header-navy);
      letter-spacing: -0.5px; cursor: pointer;
    }
    #inopnc-i3-root .header-actions { display: flex; align-items: center; gap: 8px; }
    #inopnc-i3-root .header-btn {
      background: transparent; border: none; padding: 6px;
      display: flex; flex-direction: column; align-items: center; gap: 2px;
      cursor: pointer; color: var(--header-navy);
      position: relative;
      transition: opacity 0.2s;
      overflow: visible; 
      min-width: 44px;
    }
    #inopnc-i3-root .header-btn:active { opacity: 0.6; }
    #inopnc-i3-root .header-btn i {
      width: 20px; height: 20px;
    }
    #inopnc-i3-root .header-label {
      font-size: 10px;
      font-weight: var(--fw-bold); letter-spacing: -0.3px;
      color: var(--header-navy);
      line-height: 1;
    }

    /* Notification badge */
    #inopnc-i3-root .notification-wrapper {
      position: relative; display: flex;
      align-items: center; justify-content: center;
      overflow: visible;
    }
    #inopnc-i3-root .notification-badge {
      position: absolute; top: -4px; right: -4px;
      background-color: #ef4444; color: white;
      border-radius: 50%;
      width: 18px; height: 18px;
      font-size: var(--fs-tiny); font-weight: var(--fw-black);
      display: flex; align-items: center; justify-content: center;
      border: 2px solid var(--bg-surface);
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      transition: 0.3s;
      transform: scale(1);
      line-height: 1;
    }
    #inopnc-i3-root .notification-badge.hidden { opacity: 0; transform: scale(0); pointer-events:none; }

    /* Bottom Nav (상단 여백 수정됨) */
    #inopnc-i3-root .bottom-nav-wrap {
      position: fixed; bottom: 0; left: 0; right: 0;
      z-index: 100;
      background: var(--bg-surface);
      border-top: 1px solid var(--border);
      padding-top: 12px; 
      padding-bottom: env(safe-area-inset-bottom);
      width: 100%; max-width: 600px;
      margin: 0 auto;
    }
    #inopnc-i3-root .bottom-nav {
      display: flex; justify-content: space-around;
      height: 60px; align-items: center;
      max-width: 600px;
      margin: 0 auto;
      padding: 0 16px;
    }
    #inopnc-i3-root .nav-link {
      display: flex; flex-direction: column; align-items: center;
      color: #94a3b8; gap: 6px;
      transition: 0.2s; flex: 1; justify-content: center; height: 100%;
      min-width: 44px;
      cursor: pointer;
    }
    #inopnc-i3-root .nav-link:hover {
      transform: translateY(-2px);
      color: var(--header-navy);
    }
    #inopnc-i3-root .nav-link.active { 
      color: var(--header-navy); 
      transform: scale(1.05); 
      font-weight: var(--fw-bold); 
    }

    /* [추가] 하단 네비 라벨 가독성(4050) */
    #inopnc-i3-root .nav-label { 
      font-size: 11px; 
      font-weight: var(--fw-bold); 
      letter-spacing: -0.2px; 
      line-height: 1; 
    }

    /* 아이콘 크기 최적화 */
    #inopnc-i3-root .nav-link i {
      width: 22px;
      height: 22px;
      transition: transform 0.2s;
    }
    #inopnc-i3-root .nav-link.active i {
      transform: scale(1.1);
    }
    
    /* =================================================================
      [3. 오버레이 & 패널] (Scoped)
    ================================================================= */
    #inopnc-i3-root .overlay-backdrop {
      position: fixed; inset: 0;
      background-color: rgba(0,0,0,0.4);
      z-index: 1500;
      opacity: 0; pointer-events: none;
      transition: opacity 0.3s;
    }
    #inopnc-i3-root .overlay-backdrop.active { opacity: 1; pointer-events: auto; }

    /* =========================================================
      [추가] 새 현장 등록 모달 (폰트 규칙은 @site.html 메인과 동일 톤)
    ========================================================= */
    #inopnc-i3-root .i3-modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.4);
      z-index: 2600;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.25s;
    }
    #inopnc-i3-root .i3-modal-backdrop.active { opacity: 1; pointer-events: auto; }

    #inopnc-i3-root .i3-modal-panel {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(0.96);
      width: 90%;
      max-width: 420px;
      background: var(--bg-surface);
      border-radius: 16px;
      z-index: 2700;
      padding: 22px;
      box-shadow: var(--shadow-soft);
      opacity: 0;
      pointer-events: none;
      transition: 0.25s;
    }
    #inopnc-i3-root .i3-modal-panel.active {
      transform: translate(-50%, -50%) scale(1);
      opacity: 1;
      pointer-events: auto;
    }
    #inopnc-i3-root .i3-modal-title {
      font-size: var(--fs-lg);
      font-weight: var(--fw-black);
      color: var(--header-navy);
      margin-bottom: 10px;
      letter-spacing: -0.2px;
    }
    #inopnc-i3-root .i3-modal-desc {
      font-size: var(--fs-base);
      font-weight: var(--fw-med);
      color: var(--text-sub);
      line-height: 1.5;
      margin-bottom: 16px;
    }
    #inopnc-i3-root .i3-modal-label {
      display: block;
      font-size: var(--fs-base);
      font-weight: var(--fw-bold);
      color: var(--text-sub);
      margin-bottom: 8px;
    }
    #inopnc-i3-root .i3-modal-input {
      width: 100%;
      height: 54px;
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 0 16px;
      font-size: var(--fs-base);
      font-weight: var(--fw-med);
      color: var(--text-main);
      background: var(--bg-input);
    }
    #inopnc-i3-root .i3-modal-actions {
      display: flex;
      gap: 10px;
      margin-top: 18px;
    }
    #inopnc-i3-root .i3-btn-modal {
      flex: 1;
      height: 54px;
      border-radius: 12px;
      font-size: var(--fs-base);
      font-weight: var(--fw-bold);
      cursor: pointer;
      border: none;
    }
    /* 버튼 컬러는 그대로 유지 */
    #inopnc-i3-root .i3-btn-cancel { background: #f1f5f9; color: var(--text-sub); border: 1px solid var(--border); }
    #inopnc-i3-root .i3-btn-confirm { background: var(--header-navy); color: #fff; }


    /* [PATCH] 카드 내부 삭제 버튼 (추가 버튼과 톤/규격 통일) */
    #inopnc-i3-root .i3-btn-delete {
      height: 40px;
      padding: 0 14px;
      background: var(--del-btn-bg);
      color: var(--danger);
      border: none;
      border-radius: 12px;
      font-size: var(--fs-sm);
      font-weight: var(--fw-bold);
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }

    /* 사이드 패널 및 바텀 오버레이 공통 속성 */
    #inopnc-i3-root .drawer-panel,
    #inopnc-i3-root .menu-panel {
      position: fixed; top: 0; bottom: 0;
      width: 85%; max-width: 320px;
      background-color: var(--bg-surface);
      z-index: 2500;
      transition: transform 0.3s cubic-bezier(0.33, 1, 0.68, 1);
      display: flex; flex-direction: column;
      visibility: hidden; /* 초기 상태 숨김 */
    }
    
    #inopnc-i3-root .menu-panel { left: 0; transform: translateX(-100%); }
    #inopnc-i3-root .drawer-panel { right: 0; transform: translateX(100%); }
    
    #inopnc-i3-root .menu-panel.active,
    #inopnc-i3-root .drawer-panel.active { 
      transform: translateX(0); 
      visibility: visible;
    }

    #inopnc-i3-root .account-overlay,
    #inopnc-i3-root .search-overlay {
      position: fixed; 
      /* [웹 최적화] PC 화면에서도 모바일처럼 중앙에 뜨게 설정 */
      left: 0; right: 0; margin: 0 auto; max-width: 600px;
      top: 0; bottom: 0;
      background-color: var(--bg-body);
      z-index: 2000;
      display: flex; flex-direction: column;
      transform: translateY(100%);
      transition: transform 0.3s cubic-bezier(0.33, 1, 0.68, 1);
      visibility: hidden; /* 초기 상태 숨김 */
      overflow: hidden; /* ✅ 최적화: 오버레이 자체는 오버플로우 숨김 */
    }
    #inopnc-i3-root .account-overlay.active,
    #inopnc-i3-root .search-overlay.active { 
      transform: translateY(0); 
      visibility: visible;
    }

    /* 작업완료확인서 모달 (모바일 최적화 및 웹 중앙 정렬) */
    #inopnc-i3-root .cert-modal-overlay {
      position: fixed; 
      top: 0; left: 0; right: 0; bottom: 0;
      /* [웹 최적화] 중앙 정렬 및 최대 너비 제한 */
      margin: 0 auto; max-width: 600px;
      
      background-color: #000;
      z-index: 3000;
      display: flex; 
      flex-direction: column;
      transform: translateY(100%);
      transition: transform 0.3s cubic-bezier(0.33, 1, 0.68, 1);
      overflow: hidden;
      padding-top: env(safe-area-inset-top);
      padding-bottom: 0;
      visibility: hidden; /* 초기 상태 숨김 */
    }
    #inopnc-i3-root .cert-modal-overlay.active { 
      transform: translateY(0); 
      visibility: visible;
    }
    
    #inopnc-i3-root .cert-modal-header {
      height: 60px;
      min-height: 60px;
      background-color: #000;
      border-bottom: 1px solid #333;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 16px;
      flex-shrink: 0;
      z-index: 10;
      padding-top: max(env(safe-area-inset-top), 0px);
      margin-top: 0;
    }
    #inopnc-i3-root .cert-modal-title {
      font-size: var(--fs-lg);
      font-weight: var(--fw-bold);
      color: #fff;
      flex: 1;
      text-align: center;
    }
    #inopnc-i3-root .cert-modal-header-right {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    #inopnc-i3-root .cert-modal-btn {
      background: none;
      border: none;
      color: #fff;
      cursor: pointer;
      padding: 8px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }
    #inopnc-i3-root .cert-modal-btn:active {
      background: rgba(255, 255, 255, 0.15);
    }
    #inopnc-i3-root .cert-modal-close {
      background: none;
      border: none;
      color: #fff;
      cursor: pointer;
      padding: 8px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }
    #inopnc-i3-root .cert-modal-close:active {
      background: rgba(255, 255, 255, 0.15);
    }
    
    #inopnc-i3-root .cert-modal-body {
      flex: 1;
      position: relative;
      overflow: hidden;
      background: #1e1e1e;
      -webkit-overflow-scrolling: touch;
      overscroll-behavior: contain;
      margin-bottom: 0;
      padding-bottom: 0;
      display: flex;
      flex-direction: column;
    }
    #inopnc-i3-root .cert-modal-iframe {
      width: 100%;
      height: 100%;
      border: none;
      display: block;
      background: #1e1e1e;
      touch-action: pan-x pan-y pinch-zoom;
      margin: 0;
      padding: 0;
      overflow: hidden;
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
    }
    
    /* 모바일 최적화 */
    @media (max-width: 768px) {
      #inopnc-i3-root .cert-modal-overlay {
        transform: translateY(100%);
        padding-bottom: 0;
      }
      #inopnc-i3-root .cert-modal-overlay.active {
        transform: translateY(0);
      }
      #inopnc-i3-root .cert-modal-header {
        height: calc(60px + env(safe-area-inset-top));
        min-height: calc(60px + env(safe-area-inset-top));
        margin-bottom: 0;
      }
      #inopnc-i3-root .cert-modal-body {
        margin-bottom: 0;
        padding-bottom: env(safe-area-inset-bottom);
      }
    }
    
    @media (max-width: 360px) {
      #inopnc-i3-root .cert-modal-title {
        font-size: var(--fs-base);
      }
    }

    /* --- [스마트 검색 스타일] --- */
    #inopnc-i3-root .search-header-global {
      display: flex; align-items: center; gap: 10px;
      height: 70px; 
      padding: 0 16px;
      background-color: var(--bg-surface);
      border-bottom: 1px solid var(--border);
      flex-shrink: 0;
    }
    #inopnc-i3-root .input-wrapper { flex: 1; position: relative; display: flex; align-items: center; }

    #inopnc-i3-root .unified-search-input {
      width: 100%; 
      height: 50px;
      border-radius: 50px;
      background: var(--bg-search-input);
      border: 1px solid var(--border);
      padding: 0 76px 0 20px;
      font-size: var(--fs-base); color: var(--text-main); font-weight: var(--fw-med);
      transition: all 0.2s;
      box-shadow: none;
    }

    
    #inopnc-i3-root .unified-search-input:hover {
        border-color: #cbd5e1;
    }
    
    #inopnc-i3-root .unified-search-input:focus {
      background-color: #ffffff;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(49, 163, 250, 0.15);
      outline: none;
    }

    #inopnc-i3-root .btn-search-icon-group {
      position: absolute; right: 8px; top: 50%;
      transform: translateY(-50%);
      display: flex; align-items: center; gap: 4px;
      overflow: visible;
    }
    #inopnc-i3-root .btn-search-clear {
      background: var(--btn-clear-bg); color: var(--btn-clear-text);
      border-radius: 50%;
      width: 24px; height: 24px;
      display: flex; align-items: center; justify-content: center;
      border: none; cursor: pointer;
      opacity: 0; pointer-events: none; transform: scale(0.5);
      transition: 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
    #inopnc-i3-root .btn-search-clear.show { opacity: 1; pointer-events: auto; transform: scale(1); }

    #inopnc-i3-root .btn-search-submit {
      background: none; border: none; color: var(--primary);
      font-weight: var(--fw-bold); font-size: var(--fs-base);
      width: auto; padding-left: 12px; cursor: pointer; white-space: nowrap;
    }
    #inopnc-i3-root .search-content {
      flex: 1; 
      padding: 16px; 
      overflow-y: auto; /* ✅ 최적화: 유일한 스크롤 영역 */
      -webkit-overflow-scrolling: touch;
      overscroll-behavior: contain; /* ✅ 최적화: 오버스크롤 방지 */
    }
    #inopnc-i3-root .section-title {
      font-size: var(--fs-base); font-weight: var(--fw-bold); color: var(--text-sub);
      margin-bottom: 12px; display: block;
    }

    /* [검색 결과 카드 & 액션 버튼] */
    #inopnc-i3-root .site-result-card {
      background: var(--bg-surface);
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 14px;
      box-shadow: var(--shadow-soft);
      border: none;
      transition: 0.2s;
      cursor: pointer;
    }
    #inopnc-i3-root .site-result-card:active { transform: scale(0.98); }
    
    #inopnc-i3-root .site-card-header {
      display: flex; justify-content: space-between; align-items: flex-start;
      margin-bottom: 16px;
    }
    #inopnc-i3-root .site-name-lg {
      font-size: calc(var(--fs-lg) + 1px);
      font-weight: var(--fw-black); color: var(--text-main);
      line-height: 1.3; margin-bottom: 2px;
    }
    #inopnc-i3-root .site-addr { font-size: calc(var(--fs-sm) + 1px); color: var(--text-sub); font-weight: var(--fw-med); }
    #inopnc-i3-root .site-badge {
      background: var(--primary-bg); color: var(--primary);
      font-size: var(--fs-tiny); font-weight: var(--fw-bold);
      padding: 4px 10px; border-radius: 6px;
      white-space: nowrap;
    }

    #inopnc-i3-root .btn-more-sites {
      width: 100%; height: 50px;
      background: var(--bg-surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      color: var(--text-sub);
      font-size: var(--fs-sm); font-weight: var(--fw-bold);
      display: flex; align-items: center; justify-content: center; gap: 6px;
      cursor: pointer;
      margin-top: 4px;
      margin-bottom: 28px;
      transition: 0.2s;
    }
    #inopnc-i3-root .btn-more-sites:active { background: var(--bg-body); transform: scale(0.98); }

    #inopnc-i3-root .quick-action-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
    #inopnc-i3-root .btn-quick-action {
      background: var(--bg-search-input);
      border: 1px solid var(--border);
      border-radius: 12px;
      height: 50px;
      display: flex; align-items: center; justify-content: center;
      gap: 6px;
      font-size: var(--fs-sm); font-weight: var(--fw-bold);
      color: var(--text-sub);
      cursor: pointer;
      transition: 0.1s;
      overflow: visible;
    }
    #inopnc-i3-root .btn-quick-action:active { background: var(--border); transform: scale(0.98); }
    #inopnc-i3-root .btn-quick-action.highlight { color: var(--primary); border-color: rgba(49, 163, 250, 0.3); background: #f0f9ff; }

    #inopnc-i3-root .btn-quick-action.action-cert {
      color: var(--btn-cert-text);
      background-color: var(--btn-cert-bg);
      border-color: var(--btn-cert-border);
    }
    #inopnc-i3-root .btn-quick-action.action-cert:active { opacity: 0.8; }

    #inopnc-i3-root .tag-container { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 20px; }
    #inopnc-i3-root .search-tag {
      background: var(--bg-surface);
      border: 1px solid var(--border);
      padding: 8px 14px;
      border-radius: 20px;
      font-size: var(--fs-sm);
      color: var(--text-sub);
      font-weight: var(--fw-bold);
      cursor: pointer;
      transition: 0.2s;
      line-height: 1.1;
    }
    #inopnc-i3-root .search-tag:active { background-color: var(--bg-body); }
    #inopnc-i3-root .empty-result { 
      text-align: center; 
      padding: 80px 20px; 
      color: var(--text-placeholder);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    #inopnc-i3-root .empty-result-icon {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 80px;
      height: 80px;
      background: var(--bg-input);
      border-radius: 50%;
      margin-bottom: 20px;
    }
    #inopnc-i3-root .empty-result-text {
      font-size: 16px;
      font-weight: 500;
      margin-bottom: 8px;
    }
    #inopnc-i3-root .btn-load-more {
      width: 100%;
      height: 50px;
      background: var(--bg-surface);
      border: 1px solid var(--border);
      border-radius: 100px;
      color: var(--text-sub);
      font-weight: 600;
      font-size: 15px;
      cursor: pointer;
      margin-top: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      transition: 0.2s;
    }

    /* --- [본문 콘텐츠 & 하이라이트 효과] --- */
    #inopnc-i3-root .app-wrapper { width: 100%; max-width: 600px; margin: 0 auto; padding: 20px; }
    
    #inopnc-i3-root .dummy-content-box {
      margin-bottom: 24px;
      background: var(--bg-surface);
      border-radius: 16px;
      padding: 24px;
      box-shadow: var(--shadow-soft);
      border: none;
      transition: transform 0.3s;
    }
    
    #inopnc-i3-root .dummy-title { font-size: var(--fs-lg); font-weight: var(--fw-bold); color: var(--text-main); margin-bottom: 10px; }
    #inopnc-i3-root .dummy-desc { font-size: var(--fs-base); color: var(--text-sub); line-height: 1.6; }

    @keyframes i3_highlight_flash {
      0% { background-color: rgba(49, 163, 250, 0.3); box-shadow: 0 0 0 4px rgba(49, 163, 250, 0.2); transform: scale(1.02); }
      50% { background-color: rgba(49, 163, 250, 0.1); transform: scale(1.02); }
      100% { background-color: transparent; box-shadow: none; transform: scale(1); }
    }
    #inopnc-i3-root .highlight-target { animation: i3_highlight_flash 2.0s ease-out; border-radius: 16px; }

    /* 패널 내부 기타 */
    #inopnc-i3-root .noti-header,
    #inopnc-i3-root .account-header {
      height: var(--header-height);
      padding: 0 16px;
      display: flex; align-items: center; justify-content: space-between;
      background-color: var(--bg-surface);
      border-bottom: 1px solid var(--border);
      flex-shrink: 0;
    }
    #inopnc-i3-root .noti-title,
    #inopnc-i3-root .account-title { font-size: var(--fs-lg); font-weight: var(--fw-bold); color: var(--text-main); }
    #inopnc-i3-root .noti-list { list-style: none; padding: 0; margin: 0; overflow-y: auto; flex: 1; }
    #inopnc-i3-root .noti-item { padding: 20px; border-bottom: 1px solid var(--border); display: flex; gap: 14px; align-items: flex-start; }
    #inopnc-i3-root .noti-item.unread { background-color: var(--primary-bg); }
    #inopnc-i3-root .noti-icon-box { width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
    #inopnc-i3-root .noti-icon-box.type-alert { background-color: var(--del-btn-bg); color: var(--danger); }
    #inopnc-i3-root .noti-icon-box.type-success { background-color: var(--upload-photo-bg); color: var(--upload-photo-text); }
    #inopnc-i3-root .noti-icon-box.type-info { background-color: var(--primary-bg); color: var(--primary); }
    #inopnc-i3-root .noti-content { flex: 1; display: flex; flex-direction: column; gap: 4px; }
    #inopnc-i3-root .noti-item-title { font-size: var(--fs-base); font-weight: var(--fw-bold); color: var(--text-main); }
    #inopnc-i3-root .noti-item-desc { font-size: var(--fs-sm); color: var(--text-sub); line-height: 1.5; }
    #inopnc-i3-root .noti-time { font-size: var(--fs-tiny); color: var(--text-placeholder); margin-top: 4px; }
    #inopnc-i3-root .btn-read-all { border: 1px solid var(--border); background: none; font-size: var(--fs-sm); color: var(--text-sub); padding: 6px 12px; border-radius: 8px; cursor: pointer; }
    #inopnc-i3-root .menu-nav-list { list-style: none; padding: 24px; margin: 0; flex: 1; overflow-y: auto; }
    #inopnc-i3-root .menu-nav-list li { margin-bottom: 24px; }
    #inopnc-i3-root .menu-link { font-size: var(--fs-lg); font-weight: var(--fw-bold); color: var(--text-main); cursor: pointer; }
    #inopnc-i3-root .btn-acct-mgmt { font-size: var(--fs-sm); font-weight: var(--fw-bold); color: var(--primary); background-color: var(--bg-surface); border: 1px solid var(--primary); padding: 8px 14px; border-radius: 8px; cursor: pointer; }
    #inopnc-i3-root .btn-logout { width: 100%; height: 56px; background: var(--btn-logout-bg); color: #fff; border: none; border-radius: 12px; font-size: var(--fs-base); font-weight: var(--fw-bold); cursor: pointer; }

    #inopnc-i3-root .profile-edit-wrap { display: flex; flex-direction: column; align-items: center; margin-bottom: 32px; }
    #inopnc-i3-root .profile-img-box {
      width: 100px; height: 100px; border-radius: 50%;
      background-color: #e2e8f0;
      position: relative;
      display: flex; align-items: center; justify-content: center;
      font-size: calc(var(--fs-xl) * 1.5); font-weight: var(--fw-bold); color: #94a3b8;
      border: 4px solid var(--bg-surface);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      background-size: cover; background-position: center;
      overflow: visible;
    }
    #inopnc-i3-root .btn-edit-photo {
      position: absolute; bottom: 0; right: 0;
      width: 34px; height: 34px; border-radius: 50%;
      background-color: var(--header-navy); color: #fff;
      border: 3px solid var(--bg-surface);
      display: flex; align-items: center; justify-content: center;
      cursor: pointer; z-index: 10;
      box-shadow: 0 2px 5px rgba(0,0,0,0.15);
    }

    #inopnc-i3-root .acct-section { margin-bottom: 32px; }
    #inopnc-i3-root .acct-sec-title { font-size: var(--fs-sm); font-weight: var(--fw-bold); color: var(--text-sub); margin-bottom: 12px; display: block; }
    #inopnc-i3-root .setting-row { display: flex; justify-content: space-between; align-items: center; padding: 16px 0; border-bottom: 1px solid var(--border); }
    #inopnc-i3-root .switch { position: relative; display: inline-block; width: 48px; height: 26px; }
    #inopnc-i3-root .switch input { opacity: 0; width: 0; height: 0; }
    #inopnc-i3-root .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #cbd5e1; transition: .4s; border-radius: 34px; }
    #inopnc-i3-root .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
    #inopnc-i3-root input:checked + .slider { background-color: var(--primary); }
    #inopnc-i3-root input:checked + .slider:before { transform: translateX(22px); }
    #inopnc-i3-root .form-group { margin-bottom: 16px; }
    #inopnc-i3-root .form-label { display: block; font-size: var(--fs-base); color: var(--text-sub); margin-bottom: 6px; font-weight: var(--fw-bold); }
    #inopnc-i3-root .form-input {
      width: 100%; height: var(--h-common);
      padding: 0 14px;
      border: 1px solid var(--border);
      border-radius: 12px;
      font-size: var(--fs-base); color: var(--text-main);
      background: var(--bg-input);
      font-weight: var(--fw-med);
      transition: all 0.2s;
    }
    #inopnc-i3-root .btn-acct-save { font-size: var(--fs-base); font-weight: var(--fw-bold); color: var(--primary); background: none; border: none; cursor: pointer; }
    #inopnc-i3-root .btn-text-danger { color: var(--danger); font-size: var(--fs-sm); font-weight: var(--fw-bold); background: none; border: none; padding: 0; cursor: pointer; margin-top: 8px; text-decoration: underline; }

    #inopnc-i3-root .form-select-group {
      margin-bottom: 24px;
    }
    #inopnc-i3-root .form-select {
        appearance: none; -webkit-appearance: none;
        width: 100%; height: 54px;
        border-radius: 12px;
        border: 1px solid var(--border);
        background: var(--bg-surface);
        box-shadow: var(--shadow-soft);
        padding: 0 44px 0 14px;
        font-family: var(--font-main); font-size: var(--fs-base); font-weight: var(--fw-bold); color: var(--text-main);
        cursor: pointer; transition: all 0.2s;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='20' height='20' viewBox='0 0 24 24' fill='none' stroke='%2394a3b8' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'/%3E%3C/svg%3E");
        background-repeat: no-repeat; background-position: right 14px center; background-size: 20px;
    }
    #inopnc-i3-root .form-select:hover { border-color: #cbd5e1; }
    #inopnc-i3-root .form-select:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(49, 163, 250, 0.15), var(--shadow-soft); outline: none; }


    
    @media (max-width: 420px) {
      #inopnc-i3-root .header-actions { gap: 6px; }
      #inopnc-i3-root .header-btn { 
        padding: 4px; 
        min-width: 40px;
      }
      #inopnc-i3-root .header-btn i {
        width: 18px; height: 18px;
      }
      #inopnc-i3-root .header-label { 
        font-size: 9px; 
        display: none;
      }
      #inopnc-i3-root .bottom-nav {
        padding: 0 12px;
      }
      #inopnc-i3-root .nav-link {
        min-width: 40px;
        gap: 4px;
      }
      #inopnc-i3-root .nav-label {
        font-size: 10px;
      }
      #inopnc-i3-root .nav-link i {
        width: 20px;
        height: 20px;
      }
    }

    /* [웹 최적화] PC 화면에서도 모바일 레이아웃처럼 중앙 정렬 및 패널 퍼짐 방지 */
    @media (min-width: 768px) {
      #inopnc-i3-root {
        max-width: 600px;
        margin: 0 auto;
        box-shadow: 0 0 20px rgba(0,0,0,0.1);
        border-left: 1px solid var(--border);
        border-right: 1px solid var(--border);
      }
      #inopnc-i3-root .app-header {
        border-left: 1px solid var(--border);
        border-right: 1px solid var(--border);
      }
      #inopnc-i3-root .bottom-nav-wrap {
        border-left: 1px solid var(--border);
        border-right: 1px solid var(--border);
        border-bottom: 1px solid var(--border);
      }
      
      /* 사이드 메뉴 (내정보) */
      #inopnc-i3-root .menu-panel { left: 50%; margin-left: -300px; transform: translateX(-100%); }
      #inopnc-i3-root .menu-panel.active { transform: translateX(0); }
      
      /* 알림 센터 */
      #inopnc-i3-root .drawer-panel { right: 50%; margin-right: -300px; transform: translateX(100%); }
      #inopnc-i3-root .drawer-panel.active { transform: translateX(0); }
      
      /* 통합 검색창 및 계정 설정 (바텀 시트 형태) - 중앙 정렬 보장 */
      #inopnc-i3-root .search-overlay,
      #inopnc-i3-root .account-overlay {
          left: 50%; 
          margin-left: -300px; /* 600px의 절반만큼 왼쪽으로 이동 */
          width: 600px;
          right: auto;
          transform: translateY(100%);
      }
      #inopnc-i3-root .search-overlay.active,
      #inopnc-i3-root .account-overlay.active {
          transform: translateY(0);
      }
      
      /* 작업완료확인서 모달 */
      #inopnc-i3-root .cert-modal-overlay {
         left: 50%; 
         margin-left: -300px;
         width: 600px;
         right: auto;
         transform: translateY(100%);
      }
      #inopnc-i3-root .cert-modal-overlay.active {
         transform: translateY(0);
      }
    }

</style>
</head>

<body>
  <div id="inopnc-i3-root">

    <div class="search-overlay" id="i3_unifiedSearchOverlay">
      <div class="search-header-global">
        <button style="background:none; border:none; padding:4px;" onclick="INOPNC_I3.closeUnifiedSearch()">
          <i data-lucide="arrow-left" style="color:var(--text-main);"></i>
        </button>

        <div class="input-wrapper">
          <input
            type="text"
            class="search-input-global unified-search-input"
            id="i3_unifiedSearchInput"
            placeholder="검색어를 입력하세요."
            oninput="INOPNC_I3.handleUnifiedTyping(this)"
          />
          <div class="btn-search-icon-group">
            <button class="btn-search-clear" id="i3_btnUnifiedClear" onclick="INOPNC_I3.clearUnifiedSearchInput()">
              <i data-lucide="x" style="width:14px;"></i>
            </button>
</div>
        </div>

        <button class="btn-search-submit" onclick="INOPNC_I3.performUnifiedSearch()">검색</button>
      </div>

      <div class="search-content" id="i3_searchContentArea">
        <div id="i3_defaultView">
          <div>
            <span class="section-title">최근 검색어</span>
            <div class="tag-container" id="i3_recentSearchTags"></div>
          </div>
        </div>

        <div id="i3_resultView" style="display:none;">
          <span class="section-title" id="i3_resultCount">검색 결과 0건</span>
          <div id="i3_dynamicResultList"></div>
          <div id="i3_noResultMsg" class="empty-result" style="display:none;">
            <div class="empty-result-icon">
              <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="var(--text-sub)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="opacity:0.6;">
                <circle cx="11" cy="11" r="8"></circle>
                <path d="m21 21-4.35-4.35"></path>
                <line x1="8" y1="11" x2="14" y2="11"></line>
              </svg>
            </div>
            <p class="empty-result-text">검색 결과가 없습니다</p>
          </div>
          <button id="i3_loadMoreBtn" class="btn-load-more" style="display:none;" onclick="INOPNC_I3.handleSearchLoadMore()">
            <span id="i3_loadMoreText">더 보기</span>
            <i data-lucide="chevron-down" id="i3_loadMoreIcon" style="width:16px;"></i>
          </button>
        </div>
      </div>
    </div>

    <div class="overlay-backdrop" id="i3_notiBackdrop" onclick="INOPNC_I3.closeNotification()"></div>
    <div class="drawer-panel" id="i3_notiPanel">
      <div class="noti-header">
        <span class="noti-title">알림 센터</span>
        <div style="display:flex; gap:8px; align-items:center;">
          <button class="btn-read-all" onclick="INOPNC_I3.markAllRead()">모두 읽음</button>
          <button onclick="INOPNC_I3.closeNotification()" style="background:none; border:none; color:var(--text-main);">
            <i data-lucide="x"></i>
          </button>
        </div>
      </div>
      <ul class="noti-list" id="i3_notificationList"></ul>
    </div>

    <div class="overlay-backdrop" id="i3_menuBackdrop" onclick="INOPNC_I3.closeMenu()"></div>
    <div class="menu-panel" id="i3_menuPanel">
      <div style="padding:34px 24px; border-bottom:1px solid var(--border);">
        <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
          <div>
            <span style="font-size:24px; font-weight:800; color:var(--text-main);">이현수</span>
            <span style="font-size:12px; font-weight:700; color:var(--primary); background:var(--primary-bg); padding:4px 8px; border-radius:4px;">작업자</span>
          </div>
          <button onclick="INOPNC_I3.closeMenu()" style="border:1px solid var(--border); background:none; border-radius:8px; padding:6px 14px; font-size:14px; color:var(--text-sub);">닫기</button>
        </div>
        <div style="font-size:15px; color:var(--text-sub);">manager@inopnc.com</div>
      </div>

      <ul class="menu-nav-list">
        <li><a class="menu-link" onclick="INOPNC_I3.closeMenu()">홈</a></li>
        <li><a class="menu-link" onclick="location.href='#'">출력현황</a></li>
        <li><a class="menu-link" onclick="location.href='#'">작업일지</a></li>
        <li><a class="menu-link" onclick="location.href='#'">현장정보</a></li>
        <li><a class="menu-link" onclick="INOPNC_I3.closeMenu()">문서함</a></li>
        <li style="display:flex; justify-content:space-between; align-items:center;">
          <span class="menu-link">내정보</span>
          <button class="btn-acct-mgmt" onclick="INOPNC_I3.openAccount()">계정관리</button>
        </li>
      </ul>

      <div style="padding:24px; border-top:1px solid var(--border);">
        <button class="btn-logout" onclick="alert('로그아웃')">로그아웃</button>
      </div>
    </div>

    <input type="file" id="i3_profileUploadInput" style="display:none;" accept="image/*" onchange="INOPNC_I3.handleProfilePreview(this)" />
    
    <div class="cert-modal-overlay" id="i3_certModal">
      <div class="cert-modal-header">
        <span class="cert-modal-title">작업완료확인서</span>
        <div class="cert-modal-header-right">
          <button class="cert-modal-btn" id="i3_certBtnReset" title="입력 초기화">
            <i data-lucide="rotate-ccw" width="20"></i>
          </button>
          <button class="cert-modal-btn" id="i3_certBtnDownload" title="PDF 저장">
            <i data-lucide="download" width="20"></i>
          </button>
          <button class="cert-modal-close" onclick="INOPNC_I3.closeCertModal()">
            <i data-lucide="x" width="24"></i>
          </button>
        </div>
      </div>
      <div class="cert-modal-body">
        <iframe class="cert-modal-iframe" id="i3_certIframe" src=""></iframe>
      </div>
    </div>
    
    <div class="account-overlay" id="i3_accountOverlay">
      <div class="account-header">
        <button style="background:none; border:none; padding:4px;" onclick="INOPNC_I3.closeAccount()">
          <i data-lucide="arrow-left" style="color:var(--text-main);"></i>
        </button>
        <span class="account-title">계정 관리</span>
        <button class="btn-acct-save" onclick="INOPNC_I3.saveAccount()">저장</button>
      </div>

      <div style="flex:1; padding:24px 20px; overflow-y:auto;">
        <div class="profile-edit-wrap">
          <div class="profile-img-box" id="i3_profileImgPreview">
            <span>이</span>
            <button class="btn-edit-photo" onclick="INOPNC_I3.triggerProfileUpload()">
              <i data-lucide="camera" style="width:16px;"></i>
            </button>
          </div>
        </div>

        <div class="acct-section">
          <span class="acct-sec-title">기본 정보</span>
          <div class="form-group"><label class="form-label">이름</label><input type="text" class="form-input" value="이현수" /></div>
          <div class="form-group"><label class="form-label">이메일</label><input type="email" class="form-input" value="manager@inopnc.com" disabled style="opacity:0.7;" /></div>
          <div class="form-group"><label class="form-label">전화번호</label><input type="tel" class="form-input" value="010-1234-5678" /></div>
        </div>

        <div class="acct-section">
          <span class="acct-sec-title">보안 설정</span>
          <div class="form-group">
            <label class="form-label">비밀번호 변경</label>
            <input type="password" class="form-input" placeholder="새 비밀번호 입력" />
          </div>
        </div>

        <div class="acct-section">
          <span class="acct-sec-title">알림 설정</span>
          <div class="setting-row">
            <span class="setting-label">푸시 알림</span>
            <label class="switch">
              <input type="checkbox" checked />
              <span class="slider"></span>
            </label>
          </div>
          <div class="setting-row" style="border-bottom:none;">
            <span class="setting-label">이메일 수신</span>
            <label class="switch">
              <input type="checkbox" />
              <span class="slider"></span>
            </label>
          </div>
        </div>

        <div class="acct-section">
          <span class="acct-sec-title">기타</span>
          <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
            <span style="font-size:14px; color:var(--text-sub);">앱 버전</span>
            <span style="font-size:14px; color:var(--text-main); font-weight:600;">v1.2.0</span>
          </div>
          <button class="btn-text-danger" onclick="alert('회원 탈퇴')">회원 탈퇴</button>
        </div>
      </div>
    </div>

    <header class="app-header">
      <div class="header-inner">
        <div class="brand-logo" onclick="INOPNC_I3.reload()">INOPNC</div>
        <div class="header-actions">
          <button class="header-btn" onclick="INOPNC_I3.openUnifiedSearch()">
            <i data-lucide="search"></i><span class="header-label">통합검색</span>
          </button>


          <button class="header-btn" onclick="INOPNC_I3.openCertModal()">
            <i data-lucide="file-check"></i><span class="header-label">확인서</span>
          </button>

          <button class="header-btn" onclick="INOPNC_I3.openNotification()">
            <div class="notification-wrapper">
              <i data-lucide="bell" id="i3_bellIcon"></i>
              <span class="notification-badge hidden" id="i3_notificationBadge">0</span>
            </div>
            <span class="header-label">알림</span>
          </button>

          <button class="header-btn" onclick="INOPNC_I3.openMenu()">
            <i data-lucide="menu"></i><span class="header-label">내정보</span>
          </button>
        </div>
      </div>
    </header>

    <div class="app-wrapper" id="i3_mainContent">
      <div style="text-align: center; margin-bottom: 24px;">
        <i data-lucide="layout-template" style="width: 40px; height: 40px; opacity: 0.3;"></i>
        <p style="color:var(--text-placeholder); font-size:14px; margin-top:8px;">검색으로 쉽게 이동할 수 있습니다.</p>
      </div>
    </div>


    <nav class="bottom-nav-wrap">
      <div class="bottom-nav">
        <a class="nav-link active" href="#" onclick="selectNav(this, '홈')"><i data-lucide="home"></i><span class="nav-label">홈</span></a>
        <a class="nav-link" href="#" onclick="selectNav(this, '출력현황')"><i data-lucide="calculator"></i><span class="nav-label">출력현황</span></a>
        <a class="nav-link" href="#" onclick="selectNav(this, '현장기록')"><i data-lucide="clipboard-list"></i><span class="nav-label">현장기록</span></a>
        <a class="nav-link" href="#" onclick="selectNav(this, '현장정보')"><i data-lucide="map"></i><span class="nav-label">현장정보</span></a>
        <a class="nav-link" href="#" onclick="selectNav(this, '문서함')"><i data-lucide="folder"></i><span class="nav-label">문서함</span></a>
      </div>
    </nav>

  </div>

  <script>
    /* =========================================================
      INOPNC_I3 : 전역 네임스페이스(충돌 방지)
    ========================================================= */
    (function () {
      const ROOT_ID = "inopnc-i3-root";
      const root = document.getElementById(ROOT_ID);

      function $(id) { return document.getElementById(id); }

      const state = {
      };

      const INOPNC_Search = {
        index: [],
        isIndexed: false,

        _isPMode: function () {
          const currentPage = (window.location.pathname.split('/').pop() || '').toLowerCase();
          return currentPage.startsWith('@p');
        },

        _resolveLinks: function () {
          const isP = this._isPMode();
          return {
            main: isP ? '@pmain.html' : '@main.html',
            money: isP ? '@pmoney.html' : '@money.html',
            doc: '@doc.html',
            site: isP ? '@psite.html' : '@site.html',
            worklog: isP ? '@pworklog.html' : '@worklog.html'
          };
        },

        buildIndex: function () {
          if (this.isIndexed) return;
          console.time("SearchIndexing");
          this.index = [];

          try {
            const links = this._resolveLinks();

            this.index.push({ id: 'page_main', title: '홈', desc: '메인', category: '페이지', link: links.main, keywords: '메인 홈 pmain main' });
            this.index.push({ id: 'page_money', title: '출력현황', desc: '급여/출력', category: '페이지', link: links.money, keywords: '급여 출력 money pmoney' });
            this.index.push({ id: 'page_worklog', title: '현장기록', desc: '작업일지', category: '페이지', link: links.worklog, keywords: '작업일지 현장기록 worklog pworklog' });
            this.index.push({ id: 'page_site', title: '현장정보', desc: '현장 정보', category: '페이지', link: links.site, keywords: '현장정보 site psite' });
            this.index.push({ id: 'page_doc', title: '문서함', desc: '내문서/회사서류/사진/도면/펀치', category: '페이지', link: links.doc, keywords: '문서 문서함 doc' });

            let siteMeta = {};
            let customSites = [];
            let worklogs = {};
            let siteWorklogs = {};
            let docsV1 = null;

            try {
              siteMeta = JSON.parse(localStorage.getItem('INOPNC_SITE_META_v1') || '{}');
            } catch (e) {
              siteMeta = {};
            }

            try {
              customSites = JSON.parse(localStorage.getItem('INOPNC_CUSTOM_SITES_v1') || '[]');
            } catch (e) {
              customSites = [];
            }

            try {
              worklogs = JSON.parse(localStorage.getItem('inopnc_worklogs_v4_site_based') || '{}');
            } catch (e) {
              worklogs = {};
            }

            try {
              siteWorklogs = JSON.parse(localStorage.getItem('siteWorklogs') || '{}');
            } catch (e) {
              siteWorklogs = {};
            }

            try {
              docsV1 = JSON.parse(localStorage.getItem('inopnc_docs_v1') || 'null');
            } catch (e) {
              docsV1 = null;
            }

            Object.keys(siteMeta || {}).forEach(id => {
              const m = siteMeta[id] || {};
              this.index.push({
                id: id,
                title: `현장: ${(m.addr || '주소 미정')}`,
                desc: '현장 정보',
                category: '현장',
                link: links.site,
                targetId: id,
                keywords: String((m.manager || '') + ' ' + (m.addr || '') + ' ' + (m.lodge || '')).trim()
              });
            });

            (customSites || []).forEach(site => {
              if (!site) return;
              this.index.push({
                id: String(site.id || ''),
                title: site.name || '',
                desc: `${site.addr || ''} | ${site.affil || ''}`.trim(),
                category: '현장',
                link: links.site,
                targetId: String(site.id || ''),
                keywords: String(site.manager || '').trim()
              });
            });

            Object.keys(worklogs || {}).forEach(siteKey => {
              const siteData = worklogs[siteKey] || {};
              const siteName = siteData.baseInfo?.siteName || '알 수 없는 현장';

              Object.keys(siteData.dailyData || {}).forEach(dateKey => {
                const daily = (siteData.dailyData || {})[dateKey] || {};
                const workSummary = (daily.workSets || []).map(w => `${w?.member || ''} ${w?.process || ''}`.trim()).filter(Boolean).join(', ');

                this.index.push({
                  id: `${siteKey}_${dateKey}`,
                  title: `${siteName} (${dateKey})`,
                  desc: `작업일지 | ${workSummary}`.trim(),
                  category: '일지',
                  link: links.worklog,
                  targetId: siteKey,
                  keywords: workSummary
                });
              });
            });

            Object.keys(siteWorklogs || {}).forEach(siteValue => {
              const byDate = siteWorklogs[siteValue] || {};
              Object.keys(byDate || {}).forEach(dateKey => {
                const entry = byDate[dateKey] || {};
                const bi = entry.baseInfo || {};
                const siteName = bi.siteName || '알 수 없는 현장';

                let workSummary = '';
                try {
                  const latest = (entry.versions && entry.versions.length) ? entry.versions[entry.versions.length - 1] : null;
                  const ws = (latest && Array.isArray(latest.workSets)) ? latest.workSets : [];
                  workSummary = ws.map(w => `${w?.member || ''} ${w?.process || ''}`.trim()).filter(Boolean).join(', ');
                } catch (e) {}

                this.index.push({
                  id: `mainlog_${siteValue}_${dateKey}`,
                  title: `${siteName} (${dateKey})`,
                  desc: `작업일지 | ${workSummary}`.trim(),
                  category: '일지',
                  link: links.worklog,
                  targetId: siteValue,
                  keywords: workSummary
                });
              });
            });

            try {
              const docs = docsV1 && typeof docsV1 === 'object' ? (docsV1.documents || null) : null;
              if (docs && typeof docs === 'object') {
                Object.keys(docs).forEach(tab => {
                  const groups = docs[tab];
                  if (!Array.isArray(groups)) return;
                  groups.forEach(g => {
                    if (!g) return;
                    const files = Array.isArray(g.files) ? g.files : [];
                    const fileNames = files.map(f => (f && f.name) ? String(f.name) : '').filter(Boolean).join(' ');
                    const fileExts = files.map(f => (f && f.ext) ? String(f.ext) : '').filter(Boolean).join(' ');
                    const extra = tab === 'punch'
                      ? `${g.punchData?.location || ''} ${g.punchData?.issue || ''} ${g.punchData?.priority || ''} ${g.punchData?.status || ''}`
                      : '';
                    const keywords = `${g.title || ''} ${g.author || ''} ${g.date || ''} ${g.time || ''} ${fileNames} ${fileExts} ${extra}`.trim();

                    this.index.push({
                      id: `doc_${tab}_${g.id || ''}`,
                      title: `${g.title || ''}`,
                      desc: `문서함 | ${tab} | ${g.date || ''} ${g.time || ''}`.trim(),
                      category: '문서',
                      link: links.doc,
                      targetId: String(g.id || ''),
                      tab: tab,
                      keywords: keywords
                    });
                  });
                });
              }
            } catch (e) {
              console.error(e);
            }
          } catch (e) {
            console.error("인덱싱 중 오류 발생:", e);
          }

          this.isIndexed = true;
          console.timeEnd("SearchIndexing");
          console.log(`총 ${this.index.length}건 인덱싱 완료`);
        },

        search: function (query) {
          if (!query || query.length < 2) return [];
          const lowerQ = String(query).toLowerCase();
          return (this.index || []).filter(item => {
            return (item.title && item.title.toLowerCase().includes(lowerQ)) ||
              (item.desc && item.desc.toLowerCase().includes(lowerQ)) ||
              (item.keywords && item.keywords.toLowerCase().includes(lowerQ));
          }).slice(0, 30);
        },

        navigate: function (item) {
          // ✅ UX_POLICY: recent click auto-navigate - return success status
          if (!item) return false;
          const currentPage = (window.location.pathname.split('/').pop() || '@main.html');

          if (String(item.link || '').includes(currentPage)) {
            if (item.targetId && window.INOPNC_I3 && typeof window.INOPNC_I3.goToElement === 'function') {
              window.INOPNC_I3.goToElement(item.targetId);
              return true;
            }
            alert(`현재 페이지의 [${item.title}] 항목으로 이동합니다.`);
            return false;
          }

          let url = item.link;
          const params = [];
          if (item.targetId) params.push(`focus=${encodeURIComponent(item.targetId)}`);
          if (item.tab) params.push(`tab=${encodeURIComponent(item.tab)}`);
          if (params.length) url += `?${params.join('&')}`;
          
          // ✅ UX_POLICY: Close overlay before navigation
          closeUnifiedSearch();
          window.location.href = url;
          return true;
        },

        _lastResults: []
      };

      window.INOPNC_Search = INOPNC_Search;

      let searchDebounceTimer;

      function renderSearchResults(results) {
        const container = $("i3_dynamicResultList");
        const countSpan = $("i3_resultCount");
        const noResult = $("i3_noResultMsg");
        const loadMoreBtn = $("i3_loadMoreBtn");
        if (!container || !countSpan || !noResult || !loadMoreBtn) return;

        const safeResults = Array.isArray(results) ? results : [];
        searchCurrentResults = safeResults;
        INOPNC_Search._lastResults = safeResults;

        container.innerHTML = "";
        countSpan.innerText = `검색 결과 ${safeResults.length}건`;

        if (safeResults.length === 0) {
          noResult.style.display = "block";
          loadMoreBtn.style.display = "none";
          // Refresh icons for empty state
          setTimeout(() => {
            lucide.createIcons();
          }, 0);
          return;
        }

        noResult.style.display = "none";

        // ✅ UX_POLICY: Load more functionality - Show only visibleCount results
        const resultsToShow = safeResults.slice(0, searchVisibleCount);
        
        const html = resultsToShow.map((item, idx) => {
          const title = (item && item.title) ? String(item.title) : '';
          const desc = (item && item.desc) ? String(item.desc) : '';
          const category = (item && item.category) ? String(item.category) : '';
          return `
            <div class="site-result-card" data-i3-idx="${idx}">
              <div class="site-card-header">
                <div style="flex:1; min-width:0;">
                  <div class="site-name-lg">${title}</div>
                  <div class="site-addr">${desc}</div>
                </div>
                <span class="site-badge">${category}</span>
              </div>
            </div>
          `;
        }).join('');

        container.innerHTML = html;

        // ✅ UX_POLICY: Load more button logic
        if (safeResults.length <= searchInitialCount) {
          loadMoreBtn.style.display = "none";
        } else {
          loadMoreBtn.style.display = "flex";
          document.getElementById("i3_loadMoreText").innerText = searchVisibleCount >= safeResults.length ? "접기" : "더 보기";
          document.getElementById("i3_loadMoreIcon").setAttribute('data-lucide', searchVisibleCount >= safeResults.length ? 'chevron-up' : 'chevron-down');
          // Refresh icon for load more button
          setTimeout(() => {
            lucide.createIcons();
          }, 0);
        }

        container.onclick = function (e) {
          const card = e.target && e.target.closest ? e.target.closest('.site-result-card') : null;
          if (!card) return;
          const idxStr = card.getAttribute('data-i3-idx');
          const idx = Number(idxStr);
          if (!Number.isFinite(idx)) return;
          const item = (INOPNC_Search._lastResults || [])[idx];
          INOPNC_Search.navigate(item);
        };
      }

      // 검색 대상(데모)
      const APP_DATA = [
        { id: "i3_section_photos", type: "site", title: "사진대지 관리", desc: "현장 사진 업로드 및 분류", status: "필수" },
        { id: "i3_section_drawings", type: "site", title: "도면 마킹", desc: "실시간 도면 수정 사항 체크", status: "진행중" },
        { id: "i3_section_cert", type: "site", title: "작업완료확인서", desc: "관리자 승인 요청", status: "대기" }
      ];

      // 알림 데이터(데모)
      const notificationData = [
        { id: 1, type: "alert", title: "현장 안전 점검 요망", desc: "A구역 비계 설치 상태 확인", time: "방금 전", icon: "alert-triangle", unread: true },
        { id: 2, type: "info", title: "시스템 점검 안내", desc: "12월 10일 오전 2시~4시 점검", time: "2시간 전", icon: "info", unread: true }
      ];

      /* ========== 아이콘 초기화 ========== */
      function refreshIcons() {
        if (window.lucide && typeof window.lucide.createIcons === "function") {
          window.lucide.createIcons();
        }
      }

      /* ========== 배지(알림) 업데이트 ========== */
      function updateBadge() {
        const badge = $("i3_notificationBadge");
        if (!badge) return;

        const unreadCount = notificationData.filter(n => n.unread).length;
        badge.textContent = String(unreadCount);

        if (unreadCount > 0) badge.classList.remove("hidden");
        else badge.classList.add("hidden");
      }

      /* ================= Logic 1. 공통 기능 ================= */

      function reload() {
        window.scrollTo({ top: 0, behavior: "smooth" });
      }

      /* ================= Logic 2. 스마트 검색 (Global) ================= */
      function openUnifiedSearch() {
        $("i3_unifiedSearchOverlay")?.classList.add("active");
        // ✅ 최적화: 검색 오버레이 열 때 body 스크롤 방지
        document.body.style.overflow = "hidden";
        setTimeout(() => $("i3_unifiedSearchInput")?.focus(), 250);

        const runIndex = () => {
          try {
            INOPNC_Search.buildIndex();
          } catch (e) {
            console.error(e);
          }
        };

        if (typeof window.requestIdleCallback === 'function') {
          window.requestIdleCallback(runIndex);
        } else {
          setTimeout(runIndex, 0);
        }
      }

      function closeUnifiedSearch() {
        $("i3_unifiedSearchOverlay")?.classList.remove("active");
        // ✅ 최적화: 검색 오버레이 닫을 때 body 스크롤 복원
        document.body.style.overflow = "";
        clearUnifiedSearchInput(true);
        toggleView(false);
      }

      function handleUnifiedTyping(input) {
        const query = (input?.value || "").trim();
        const hasText = query.length > 0;

        const clearBtn = $("i3_btnUnifiedClear");
        if (clearBtn) {
          if (hasText) clearBtn.classList.add("show");
          else clearBtn.classList.remove("show");
        }

        toggleView(hasText);

        if (!hasText) return;

        clearTimeout(searchDebounceTimer);
        searchDebounceTimer = setTimeout(() => {
          try {
            if (!INOPNC_Search.isIndexed) INOPNC_Search.buildIndex();
          } catch (e) {
            console.error(e);
          }

          const results = INOPNC_Search.search(query);
          if (results.length === 0) {
            filterAndRender(query.toLowerCase());
            return;
          }
          renderSearchResults(results);
        }, 300);
      }

      function clearUnifiedSearchInput(silent = false) {
        const input = $("i3_unifiedSearchInput");
        if (!input) return;
        input.value = "";
        if (!silent) input.focus();
        handleUnifiedTyping(input);
      }

      function toggleView(showResult) {
        const defaultView = $("i3_defaultView");
        const resultView = $("i3_resultView");
        if (!defaultView || !resultView) return;

        if (showResult) {
          defaultView.style.display = "none";
          resultView.style.display = "block";
        } else {
          defaultView.style.display = "block";
          resultView.style.display = "none";
        }
      }

      function filterAndRender(query) {
        const resultList = APP_DATA.filter(item => {
          const t = (item.title || "").toLowerCase();
          const d = (item.desc || "").toLowerCase();
          return t.includes(query) || d.includes(query);
        });

        const container = $("i3_dynamicResultList");
        const countSpan = $("i3_resultCount");
        const noResult = $("i3_noResultMsg");
        if (!container || !countSpan || !noResult) return;

        countSpan.innerText = `검색 결과 ${resultList.length}건`;
        container.innerHTML = "";

        if (resultList.length === 0) {
          noResult.style.display = "block";
          // Refresh icons for empty state
          setTimeout(() => {
            lucide.createIcons();
          }, 0);
        } else {
          noResult.style.display = "none";
          resultList.forEach(item => {
            const highlight = (text) =>
              (text || "").replace(new RegExp(query, "gi"), match => `<span style="color:var(--primary); font-weight:800;">${match}</span>`);

            const html = `
              <div class="site-result-card" onclick="INOPNC_I3.goToElement('${item.id}')">
                <div class="site-card-header">
                  <div>
                    <div class="site-name-lg">${highlight(item.title)}</div>
                    <div class="site-addr">${highlight(item.desc)}</div>
                  </div>
                  <span class="site-badge">${item.status}</span>
                </div>
              </div>
            `;
            container.insertAdjacentHTML("beforeend", html);
          });
          refreshIcons();
        }
      }

      // ✅ UX_POLICY: recent click auto-navigate - Search load more variables
      let searchVisibleCount = 5;
      let searchInitialCount = 5;
      let searchCurrentResults = [];

      function saveRecentSearch(query) {
        if (!query || query.trim().length < 2) return;
        
        try {
          let recent = JSON.parse(localStorage.getItem('INOPNC_RECENT_SEARCHES_v1') || '[]');
          
          // Remove duplicates and add to front
          recent = recent.filter(item => item !== query);
          recent.unshift(query);
          
          // Keep only 5 most recent
          recent = recent.slice(0, 5);
          
          localStorage.setItem('INOPNC_RECENT_SEARCHES_v1', JSON.stringify(recent));
          renderRecentSearches();
        } catch (e) {
          console.error('Failed to save recent search:', e);
        }
      }
      
      function removeRecentSearch(term) {
        try {
          let recent = JSON.parse(localStorage.getItem('INOPNC_RECENT_SEARCHES_v1') || '[]');
          recent = recent.filter(item => item !== term);
          localStorage.setItem('INOPNC_RECENT_SEARCHES_v1', JSON.stringify(recent));
          renderRecentSearches();
        } catch (e) {
          console.error('Failed to remove recent search:', e);
        }
      }
      
      function renderRecentSearches() {
        const container = $('i3_recentSearchTags');
        if (!container) return;
        
        try {
          const recent = JSON.parse(localStorage.getItem('INOPNC_RECENT_SEARCHES_v1') || '[]');
          
          if (recent.length === 0) {
            container.innerHTML = '<div style="color: var(--text-placeholder); font-size: var(--fs-sm);">최근 검색어가 없습니다.</div>';
            return;
          }
          
          container.innerHTML = recent.map(term => 
            `<div class="recent-search-item" style="display: inline-flex; align-items: center; gap: 4px; margin: 2px;">
              <button class="search-tag" onclick="INOPNC_I3.setSearch('${term.replace(/'/g, "\\'")}')" style="flex: 1;">${term}</button>
              <button class="search-tag remove-btn" onclick="INOPNC_I3.removeRecentSearch('${term.replace(/'/g, "\\'")}')" style="background: var(--text-placeholder); color: white; border-color: var(--text-placeholder); padding: 4px 8px; font-size: 12px; min-width: auto;">
                <i data-lucide="x" style="width: 14px; height: 14px;"></i>
              </button>
            </div>`
          ).join('');
          
          // Refresh icons for X buttons and empty state
          setTimeout(() => {
            lucide.createIcons();
          }, 0);
        } catch (e) {
          console.error('Failed to render recent searches:', e);
        }
      }
      
      function handleSearchLoadMore() {
        // ✅ UX_POLICY: Load more functionality based on site.html pattern
        if (searchVisibleCount >= searchCurrentResults.length) {
          searchVisibleCount = searchInitialCount;
          // Scroll to top of search results
          const container = $("i3_dynamicResultList");
          if (container) {
            container.scrollTop = 0;
          }
        } else {
          searchVisibleCount += 5;
        }
        renderSearchResults(searchCurrentResults);
      }
      
      function setSearch(keyword) {
        // ✅ UX_POLICY: recent click auto-navigate - use unified flow
        const input = $("i3_unifiedSearchInput");
        if (!input) return;
        input.value = keyword;
        handleUnifiedTyping(input);
        // Remove direct findInPageAndScroll - let performUnifiedSearch handle it
        performUnifiedSearch();
      }

      function performUnifiedSearch() {
        // ✅ UX_POLICY: recent click auto-navigate
        const q = ($("i3_unifiedSearchInput")?.value || "").trim();
        if (!q) return;
        
        // ✅ UX_POLICY: Reset visible count for new search
        searchVisibleCount = searchInitialCount;
        
        // Save to recent searches
        saveRecentSearch(q);
        
        // 1) INOPNC_Search.search(q) → 2) APP_DATA fallback → 3) findInPageAndScroll(q)
        const results = INOPNC_Search.search(q);
        
        if (results.length === 1) {
          // ✅ UX_POLICY: Single result - auto navigate
          const success = INOPNC_Search.navigate(results[0]);
          if (success !== false) {
            // Navigation succeeded, close overlay
            closeUnifiedSearch();
            const input = $("i3_unifiedSearchInput");
            if (input) input.blur();
            return;
          } else {
            // Navigation failed, show results for manual click
            renderSearchResults([results[0]]);
          }
        } else if (results.length > 1) {
          // ✅ UX_POLICY: Multiple results - show list
          renderSearchResults(results);
        } else {
          // ✅ UX_POLICY: No results - try APP_DATA fallback
          const fallbackResults = [];
          // Add APP_DATA fallback logic here if needed
          
          if (fallbackResults.length === 1) {
            const success = INOPNC_Search.navigate(fallbackResults[0]);
            if (success !== false) {
              closeUnifiedSearch();
              const input = $("i3_unifiedSearchInput");
              if (input) input.blur();
              return;
            } else {
              renderSearchResults([fallbackResults[0]]);
            }
          } else if (fallbackResults.length > 1) {
            renderSearchResults(fallbackResults);
          } else {
            // ✅ UX_POLICY: Final fallback to findInPageAndScroll
            const pageScrollSuccess = findInPageAndScroll(q);
            if (!pageScrollSuccess) {
              renderSearchResults([]);
            }
          }
        }
      }

      function findInPageAndScroll(keyword) {
        const container = $("i3_mainContent");
        if (!container) return false;

        const items = container.querySelectorAll(".dummy-content-box");
        const kw = String(keyword || "").toLowerCase();

        let matchedElement = null;
        for (const item of items) {
          const textContent = (item.innerText || "").toLowerCase();
          if (textContent.includes(kw)) {
            matchedElement = item;
            break;
          }
        }

        if (matchedElement) {
          closeUnifiedSearch();
          setTimeout(() => {
            matchedElement.scrollIntoView({ behavior: "smooth", block: "center" });
            matchedElement.classList.remove("highlight-target");
            void matchedElement.offsetWidth;
            matchedElement.classList.add("highlight-target");
          }, 250);
          return true;
        }
        return false;
      }

      

            function goToElement(id) {
        closeUnifiedSearch();
        const el = $(id);
        if (!el) {
          alert("상세 페이지로 이동합니다.");
          return;
        }
        setTimeout(() => {
          el.scrollIntoView({ behavior: "smooth", block: "center" });
          el.classList.remove("highlight-target");
          void el.offsetWidth;
          el.classList.add("highlight-target");
        }, 250);
      }

      function goAction(action, id) {
        alert(`[${action}] 이동 (ID: ${id})`);
        closeUnifiedSearch();
      }

      /* ================= Logic 3. 알림/메뉴/계정 ================= */
      function openNotification() {
        $("i3_notiBackdrop")?.classList.add("active");
        $("i3_notiPanel")?.classList.add("active");
        renderNotifications();
      }

      function closeNotification() {
        $("i3_notiBackdrop")?.classList.remove("active");
        $("i3_notiPanel")?.classList.remove("active");
      }

      function renderNotifications() {
        const listContainer = $("i3_notificationList");
        if (!listContainer) return;

        listContainer.innerHTML = "";
        if (notificationData.length === 0) {
          listContainer.innerHTML = '<li style="padding:20px; text-align:center; color:var(--text-placeholder);">알림이 없습니다.</li>';
          return;
        }

        notificationData.forEach(noti => {
          const li = document.createElement("li");
          li.className = "noti-item" + (noti.unread ? " unread" : "");
          li.innerHTML =
            `<div class="noti-icon-box type-${noti.type}"><i data-lucide="${noti.icon}" style="width:20px;"></i></div>` +
            `<div class="noti-content">` +
            `<span class="noti-item-title">${noti.title}</span>` +
            `<span class="noti-item-desc">${noti.desc}</span>` +
            `<span class="noti-time">${noti.time}</span>` +
            `</div>`;
          listContainer.appendChild(li);
        });

        refreshIcons();
      }

      function markAllRead() {
        notificationData.forEach(n => (n.unread = false));
        root.querySelectorAll(".noti-item").forEach(i => i.classList.remove("unread"));
        updateBadge();
      }

      function openMenu() {
        $("i3_menuBackdrop")?.classList.add("active");
        $("i3_menuPanel")?.classList.add("active");
      }

      function closeMenu() {
        $("i3_menuBackdrop")?.classList.remove("active");
        $("i3_menuPanel")?.classList.remove("active");
      }

      function openAccount() {
        $("i3_accountOverlay")?.classList.add("active");
        closeMenu();
      }

      function closeAccount() {
        $("i3_accountOverlay")?.classList.remove("active");
      }

      function saveAccount() {
        alert("저장되었습니다.");
        closeAccount();
      }

      function triggerProfileUpload() {
        $("i3_profileUploadInput")?.click();
      }

      function handleProfilePreview(input) {
        if (!input?.files?.[0]) return;
        const r = new FileReader();
        r.onload = e => {
          const box = $("i3_profileImgPreview");
          const letter = box?.querySelector("span");
          if (box) box.style.backgroundImage = `url(${e.target.result})`;
          if (letter) letter.style.display = "none";
        };
        r.readAsDataURL(input.files[0]);
      }
      

      /* ================= Logic 5. 작업완료확인서 모달 ================= */
      const I3_CONFIRM3_HTML = "<!DOCTYPE html>\n<html lang=\"ko\">\n<head>\n  <meta charset=\"UTF-8\">\n  <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover\">\n  <title>\uc791\uc5c5\uc644\ub8cc\ud655\uc778\uc11c - \ucd5c\uc885 \uc218\uc815\ubcf8</title> \n\n  <link rel=\"stylesheet\" as=\"style\" crossorigin href=\"https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css\" />\n  <script src=\"https://unpkg.com/lucide@latest/dist/umd/lucide.js\"><\/script>\n  <script src=\"https://cdn.jsdelivr.net/npm/signature_pad@4.1.7/dist/signature_pad.umd.min.js\"><\/script>\n  <script src=\"https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js\"><\/script>\n  <script src=\"https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js\"><\/script>\n\n  <style>\n    /* =========================================\n       MODULE: CORE STYLES\n       ========================================= */\n    :root {\n        --font-main: \"Pretendard Variable\", Pretendard, sans-serif;\n        --bg-viewer: #1e1e1e; \n        --bg-paper: #ffffff;\n        --border-color: #1e293b;\n        --primary-color: #2563eb;\n        \n        /* User Provided Colors */\n        --header-navy: #1a254f;\n        --primary: #31a3fa;\n        --primary-bg: #eaf6ff;\n    }\n    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }\n    \n    body { \n        margin: 0; padding: 0; \n        font-family: var(--font-main); \n        background: var(--bg-viewer); \n        color: #fff;\n        height: 100vh; width: 100vw; overflow: hidden;\n        display: flex; flex-direction: column;\n        overscroll-behavior: none; \n    }\n    \n    /* iframe \ubaa8\ub4dc\uc77c \ub54c \ud5e4\ub354 \uc228\uae30\uae30 */\n    body.iframe-mode .header-bar { display: none !important; }\n    body.iframe-mode .viewport { height: 100vh; padding-top: 0; }\n\n    /* =========================================\n       MODULE: HEADER\n       ========================================= */\n    .header-bar {\n        height: 60px; background: #000; \n        display: flex; align-items: center; justify-content: space-between;\n        padding: 0 16px; flex-shrink: 0; z-index: 100; border-bottom: 1px solid #333;\n    }\n    .header-title { font-size: 18px; font-weight: 700; color: #fff; }\n    .header-right { display: flex; align-items: center; gap: 8px; }\n\n    .icon-btn {\n        background: none; border: none; color: #fff; cursor: pointer;\n        padding: 8px; border-radius: 50%; display: flex; align-items: center; justify-content: center;\n    }\n    .icon-btn:hover { background: rgba(255,255,255,0.15); }\n\n    /* =========================================\n       MODULE: VIEWER (Layout Fixed)\n       ========================================= */\n    .viewport {\n        flex: 1; position: relative; overflow: hidden;\n        background: var(--bg-viewer);\n        display: flex; \n        justify-content: center; \n        align-items: center;     \n        touch-action: none; \n        cursor: default;\n    }\n    .viewport.panning { cursor: grab !important; }\n    .viewport.panning:active { cursor: grabbing !important; }\n    \n    .paper-wrapper {\n        transform-origin: center center; \n        transition: transform 0.05s linear; \n        will-change: transform; \n        padding: 0;\n        box-shadow: 0 4px 30px rgba(0,0,0,0.5);\n    }\n\n    .a4-paper {\n        width: 210mm; min-height: 297mm;\n        background: var(--bg-paper); color: #000;\n        padding: 15mm; \n        display: flex; flex-direction: column;\n        justify-content: center; \n    }\n\n    /* \ubb38\uc11c \ub0b4\ubd80 \uc2a4\ud0c0\uc77c */\n    .doc-header { text-align: center; margin-bottom: 30px; border-bottom: 3px double #000; padding-bottom: 15px; }\n    .doc-title { font-size: 36px; font-weight: 900; letter-spacing: 5px; color: #111; margin: 0; }\n\n    .info-table { width: 100%; border-collapse: collapse; border: 2px solid var(--border-color); margin-bottom: 20px; table-layout: fixed; }\n    .info-table th, .info-table td { border: 1px solid var(--border-color); padding: 8px; vertical-align: middle; }\n    .info-table th { background: #f8fafc; font-weight: 800; text-align: center; font-size: 16px; color: #334155; word-break: keep-all; }\n\n    /* Table \ub0b4\ubd80 \uc785\ub825\ucc3d \uc2a4\ud0c0\uc77c (Textarea) */\n    .table-input {\n        width: 100%; border: none; background: transparent;\n        font-family: inherit; font-size: 16px; color: #000; outline: none;\n        padding: 2px; font-weight: 600; resize: none; overflow: hidden;\n        min-height: 24px; line-height: 1.4; vertical-align: middle;\n        display: block;\n    }\n\n    /* [\uc911\uc694] font-family inherit \ucd94\uac00: \uc2dc\uc2a4\ud15c \ud3f0\ud2b8\ub85c \ub80c\ub354\ub9c1\ub418\uc5b4 \ub192\uc774\uac00 \ub2ec\ub77c\uc9c0\ub294 \ubb38\uc81c \ubc29\uc9c0 */\n    input, textarea { \n        width: 100%; border: none; background: transparent; \n        font-family: inherit; font-size: 16px; color: #000; outline: none; \n        padding: 4px; font-weight: 600; resize: none;\n    }\n    input::placeholder, textarea::placeholder { color: #cbd5e1; font-weight: 400; }\n    input:focus, textarea:focus { background: rgba(37, 99, 235, 0.05); }\n\n    /* PDF \uc800\uc7a5 \ubaa8\ub4dc */\n    body.clean-mode input, body.clean-mode textarea { \n        border: none !important; background: transparent !important; \n        outline: none !important; box-shadow: none !important; \n    }\n\n    .section-block { padding: 15px; display: flex; flex-direction: column; border: 2px solid var(--border-color); margin-bottom: 20px; }\n    .section-block.note { height: 150px; }\n    .sec-header { font-size: 18px; font-weight: 800; color: #1e293b; margin-bottom: 12px; padding-left: 12px; border-left: 5px solid #475569; }\n\n    .footer-area { margin-top: 10px; text-align: center; }\n    .confirm-msg { font-size: 20px; font-weight: 800; margin-bottom: 25px; }\n    .date-input { font-size: 20px; font-weight: 800; text-align: center; margin-bottom: 30px; }\n\n    /* [\uc218\uc815] \ud68c\uc0ac\uba85 \ubc0f \uadc0\uc911 \uc815\ub82c CSS - \uc717\ubd80\ubd84 \uc9e4\ub9bc \uc644\ubcbd \ud574\uacb0 */\n    .recipient-row {\n        margin-top: 40px;\n        display: flex;\n        justify-content: center;\n        align-items: flex-end; /* \uc785\ub825\ucc3d\uc758 \ubc11\ubcc0\uc744 \uae30\uc900\uc73c\ub85c \uc815\ub82c */\n        gap: 8px;\n        font-weight: 700;\n        /* \ud589 \uc804\uccb4 \ub192\uc774\ub97c \ub109\ub109\ud788 \uc8fc\uc5b4 \ub808\uc774\uc544\uc6c3 \ud655\ubcf4 */\n        height: 80px; \n    }\n    \n    .recipient-input {\n        text-align: center; \n        font-size: 24px; \n        font-weight: 800; \n        width: 300px; \n        border-bottom: 2px solid #000;\n        \n        /* [\ud575\uc2ec \uc218\uc815] \ub192\uc774\ub97c 60px\ub85c \ud06c\uac8c \ub298\ub9ac\uace0, \uc0c1\ub2e8 \ud328\ub529\uc744 \uc8fc\uc5b4 \uae00\uc790\ub97c \uc544\ub798\ub85c \ubc00\uc5b4\ub0c4 */\n        /* \uc774\ub807\uac8c \ud558\uba74 \uae00\uc790 \uc704\uc5d0 15px \uc774\uc0c1\uc758 \ube48 \uacf5\uac04\uc774 \uc0dd\uaca8 \uc808\ub300 \uc9e4\ub9ac\uc9c0 \uc54a\uc74c */\n        height: 60px;       \n        padding-top: 20px;  \n        padding-bottom: 0;  \n        box-sizing: border-box; /* \ud328\ub529\uc774 \ub192\uc774\uc5d0 \ud3ec\ud568\ub418\ub3c4\ub85d \uc124\uc815 */\n        \n        line-height: 1.4;   \n        margin-bottom: 3px; /* \ubbf8\uc138 \uc704\uce58 \uc870\uc815 */\n        background: transparent;\n        border-radius: 0;\n    }\n    \n    .recipient-suffix {\n        width: 60px; text-align: left; font-size: 20px; font-weight: 700;\n        border: none; background: transparent; cursor: text;\n        margin-bottom: 10px; /* \ud68c\uc0ac\uba85 \ubc11\uc904\uacfc '\uadc0\uc911' \ud14d\uc2a4\ud2b8 \ub192\uc774 \ub9de\ucda4 */\n    }\n\n    /* =========================================\n       MODULE: SIGNATURE SYSTEM\n       ========================================= */\n    .sign-grid { \n        display: grid; grid-template-columns: 33% 27% 40%; \n        border: 2px solid var(--border-color); margin-bottom: 20px; \n    }\n    .sign-cell-text { \n        background: #f8fafc; border-right: 1px solid var(--border-color);\n        display: flex; flex-direction: column; justify-content: center; align-items: center;\n        padding: 10px; gap: 8px;\n    }\n    .sign-label-text { font-weight: 800; font-size: 18px; color: #334155; }\n    .sign-input-text { text-align: center; font-size: 18px; font-weight: 700; width: 100%; border-bottom: 1px dashed #cbd5e1; }\n\n    .sign-cell-canvas { \n        position: relative; background: #fff; height: 180px; \n        display: flex; flex-direction: column; overflow: hidden; \n        cursor: pointer;\n    }\n    .sign-cell-canvas:hover { background: #f0f9ff; }\n    \n    .sign-label-canvas {\n        padding: 8px 12px; font-weight: 700; font-size: 14px; color: #64748b;\n        border-bottom: 1px dashed #e2e8f0; pointer-events: none; text-align: left;\n    }\n    \n    .display-canvas-wrapper {\n        flex: 1; width: 100%; height: 100%; position: relative;\n        display: flex; align-items: center; justify-content: center;\n    }\n    #paperSignCanvas { width: 100%; height: 100%; pointer-events: none; display: block; }\n    \n    .click-guide {\n        position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);\n        color: #94a3b8; font-weight: 700; font-size: 14px; pointer-events: none;\n        background: rgba(255,255,255,0.8); padding: 4px 8px; border-radius: 4px;\n    }\n\n    /* =========================================\n       MODULE: SIGNATURE MODAL\n       ========================================= */\n    .sign-modal {\n        display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;\n        background: rgba(0,0,0,0.8); z-index: 9999;\n        flex-direction: column; justify-content: center; align-items: center;\n        backdrop-filter: blur(5px); opacity: 0; transition: opacity 0.3s;\n    }\n    .sign-modal.open { display: flex; opacity: 1; }\n\n    .modal-content {\n        width: 95%; max-width: 600px; height: 80vh; max-height: 800px;\n        background: #fff; border-radius: 12px; display: flex; flex-direction: column;\n        overflow: hidden; box-shadow: 0 20px 50px rgba(0,0,0,0.5);\n    }\n    \n    .modal-header {\n        padding: 12px 16px; background: #f1f5f9; border-bottom: 1px solid #e2e8f0;\n        display: flex; justify-content: space-between; align-items: center;\n    }\n    .modal-title { font-weight: 800; font-size: 16px; color: #1e293b; }\n    .close-btn { background: none; border: none; cursor: pointer; color: #64748b; }\n\n    .modal-body {\n        flex: 1; position: relative; background: #fff; overflow: hidden; touch-action: none;\n        background-image: radial-gradient(#e2e8f0 1px, transparent 1px);\n        background-size: 20px 20px;\n    }\n    \n    #modalCanvas { width: 100%; height: 100%; touch-action: none; display: block; }\n\n    .sign-tools-bar {\n        padding: 10px; background: #fff; border-top: 1px solid #e2e8f0;\n        display: flex; gap: 8px; overflow-x: auto; flex-shrink: 0;\n        align-items: center;\n    }\n    \n    .modal-footer {\n        padding: 12px 16px; background: #fff; border-top: 1px solid #e2e8f0;\n        display: flex; gap: 10px;\n    }\n    \n    .uu-btn {\n        flex: 1; height: 48px; border-radius: 10px; font-size: 15px; font-weight: 700; \n        display: flex; align-items: center; justify-content: center; gap: 8px; cursor: pointer; transition: 0.1s;\n        min-width: fit-content; padding: 0 16px;\n    }\n    .uu-btn.dashed.type-gray-secondary, .uu-btn.solid.type-gray-secondary {\n        background-color: #f1f5f9; border: 1px solid #cbd5e1; color: #475569; border-style: solid !important;\n    }\n    .uu-btn.dashed.type-gray-secondary:hover, .uu-btn.solid.type-gray-secondary:hover { background-color: #e2e8f0; }\n    .uu-btn.dashed.type-blue, .uu-btn.solid.type-blue {\n        background-color: var(--header-navy); border: none; color: #ffffff; border-style: solid !important;\n    }\n\n    .mini-btn {\n        font-size: 12px; padding: 6px 12px; border: 1px solid #cbd5e1; \n        background: #fff; border-radius: 6px; cursor: pointer; color: #475569; font-weight: 700;\n        display: flex; align-items: center; gap: 4px; white-space: nowrap;\n        height: 40px; justify-content: center;\n    }\n    .mini-btn.active { background: #eff6ff; color: #2563eb; border-color: #2563eb; }\n    \n    #modalEditLayer {\n        display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%;\n        background: rgba(0,0,0,0.8); z-index: 10;\n        flex-direction: column; justify-content: center; align-items: center;\n    }\n    #modalEditContainer {\n        position: relative; width: 100%; height: 100%; border: 2px dashed #31a3fa; overflow: hidden;\n    }\n    #modalEditingImage {\n        position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); \n        cursor: grab; touch-action: none; max-width: none;\n    }\n    .modal-edit-controls {\n        position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);\n        background: #222; border-radius: 30px; padding: 10px 20px;\n        display: flex; gap: 15px; align-items: center; width: 90%; max-width: 400px;\n    }\n\n    /* =========================================\n       MODULE: CONTROLS\n       ========================================= */\n    .controls-pill {\n        position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);\n        background: #222; padding: 10px 25px; border-radius: 50px;\n        display: flex; gap: 25px; z-index: 200; backdrop-filter: blur(8px);\n        box-shadow: 0 10px 30px rgba(0,0,0,0.5); border: 1px solid #333;\n    }\n    .ctrl-btn {\n        background: none; border: none; color: #fff;\n        display: flex; flex-direction: column; align-items: center; gap: 4px;\n        font-size: 10px; cursor: pointer; min-width: 35px; opacity: 0.7; transition: 0.2s;\n    }\n    .ctrl-btn.active { color: #31a3fa; opacity: 1; font-weight: 700; }\n\n    .toast {\n        position: fixed; top: 80px; left: 50%; transform: translateX(-50%);\n        background: rgba(30, 41, 59, 0.95); color: #fff; padding: 12px 24px;\n        border-radius: 50px; opacity: 0; transition: 0.3s; pointer-events: none; z-index: 99999;\n        display: flex; align-items: center; gap: 8px; font-weight: 600; font-size: 14px;\n    }\n    .toast.show { opacity: 1; top: 90px; }\n    \n    #signImageInput { display: none; }\n  </style>\n</head>\n<body>\n\n  <header class=\"header-bar\">\n    <button class=\"icon-btn\" id=\"btnBack\"><i data-lucide=\"chevron-left\" width=\"28\"></i></button>\n    <div class=\"header-title\">\uc791\uc5c5\uc644\ub8cc\ud655\uc778\uc11c</div>\n    <div class=\"header-right\">\n        <button class=\"icon-btn\" id=\"btnReset\"><i data-lucide=\"rotate-ccw\"></i></button>\n        <button class=\"icon-btn\" id=\"btnDownload\"><i data-lucide=\"download\"></i></button>\n    </div>\n  </header>\n\n  <div class=\"viewport\" id=\"viewport\">\n    <div class=\"paper-wrapper\" id=\"paperWrapper\">\n      <div class=\"a4-paper\" id=\"documentArea\">\n        <header class=\"doc-header\"><h1 class=\"doc-title\">\uc791 \uc5c5 \uc644 \ub8cc \ud655 \uc778 \uc11c</h1></header>\n\n        <table class=\"info-table\">\n            <colgroup>\n                <col style=\"width: 12%;\">\n                <col style=\"width: 48%;\">\n                <col style=\"width: 10%;\">\n                <col style=\"width: 30%;\">\n            </colgroup>\n            \n            <tr>\n                <th>\ud604 \uc7a5 \uba85</th>\n                <td><textarea class=\"table-input\" rows=\"1\" placeholder=\"\ub0b4\uc6a9 \uc785\ub825\">\uc790\uc774 \uc544\ud30c\ud2b8 101\ub3d9</textarea></td>\n                <th>\uc5c5 \uccb4</th>\n                <td><textarea class=\"table-input\" rows=\"1\" placeholder=\"\uc5c5\uccb4\uba85 \uc785\ub825\"></textarea></td>\n            </tr>\n            <tr>\n                <th>\uacf5 \uc0ac \uba85</th>\n                <td><textarea class=\"table-input\" rows=\"1\" placeholder=\"\uacf5\uc0ac\uba85 \uc785\ub825\"></textarea></td>\n                <th>\uacf5\uc0ac\uae30\uac04</th>\n                <td><textarea class=\"table-input\" rows=\"1\" placeholder=\"\uae30\uac04 \uc785\ub825\"></textarea></td>\n            </tr>\n            </table>\n\n        <div class=\"section-block\">\n            <div class=\"sec-header\">\uc791\uc5c5\ub0b4\uc6a9</div>\n            <textarea style=\"flex:1; line-height:1.6;\" placeholder=\"\uc0c1\uc138 \ub0b4\uc6a9\">* \uc9c0\ud558\uc8fc\ucc28\uc7a5 PC\ubd80\uc7ac \uade0\uc5f4\ubcf4\uc218 \uc644\ub8cc\n* </textarea>\n        </div>\n\n        <div class=\"section-block note\">\n            <div class=\"sec-header\">\ud2b9\uae30\uc0ac\ud56d</div>\n            <textarea style=\"flex:1;\" placeholder=\"\ud2b9\uc774\uc0ac\ud56d\"></textarea>\n        </div>\n\n        <div class=\"footer-area\">\n            <div class=\"confirm-msg\">\uc0c1\uae30 \uc0ac\ud56d\uacfc \uac19\uc774 \uc791\uc5c5\uc744 \uc644\ub8cc\ud558\uc600\uc74c\uc744 \ud655\uc778\ud569\ub2c8\ub2e4.</div>\n            <input type=\"text\" id=\"dateField\" class=\"date-input\" value=\"\" style=\"cursor: pointer;\" readonly onfocus=\"this.removeAttribute('readonly');\" onblur=\"if(this.value.trim() === '') { const d = new Date(); this.value = `${d.getFullYear()}\ub144 ${d.getMonth()+1}\uc6d4 ${d.getDate()}\uc77c`; } this.setAttribute('readonly', 'readonly');\">\n\n            <div class=\"sign-grid\">\n                <div class=\"sign-cell-text\">\n                    <span class=\"sign-label-text\">\uc18c \uc18d :</span>\n                    <input type=\"text\" class=\"sign-input-text\" value=\"(\uc8fc)\uc774\ub178\ud53c\uc564\uc528\" placeholder=\"\uc18c\uc18d \uc785\ub825\">\n                </div>\n                <div class=\"sign-cell-text\">\n                    <span class=\"sign-label-text\">\uc131 \uba85 :</span>\n                    <input type=\"text\" class=\"sign-input-text\" placeholder=\"\uc774\ub984 \uc785\ub825\">\n                </div>\n                \n                <div class=\"sign-cell-canvas\" id=\"triggerSignModal\">\n                    <div class=\"sign-label-canvas\">\ud655\uc778\uc790 (\uc11c\uba85)</div>\n                    <div class=\"display-canvas-wrapper\">\n                        <canvas id=\"paperSignCanvas\"></canvas>\n                        <div class=\"click-guide\" id=\"clickGuideText\">\uc11c\uba85\ud558\ub824\uba74 \ud130\uce58</div>\n                    </div>\n                </div>\n            </div>\n            \n            <div class=\"recipient-row\">\n                <input type=\"text\" class=\"recipient-input\" placeholder=\"\ud68c\uc0ac\uba85\"> \n                <input type=\"text\" class=\"recipient-suffix\" value=\"\uadc0\uc911\" placeholder=\"\">\n            </div>\n        </div>\n      </div> \n    </div>\n  </div>\n\n  <div class=\"controls-pill\">\n    <button class=\"ctrl-btn\" id=\"btnZoomOut\"><i data-lucide=\"minus\"></i>\ucd95\uc18c</button>\n    <button class=\"ctrl-btn\" id=\"btnPanToggle\"><i data-lucide=\"hand\"></i>\uc774\ub3d9</button>\n    <button class=\"ctrl-btn\" id=\"btnZoomIn\"><i data-lucide=\"plus\"></i>\ud655\ub300</button>\n    <button class=\"ctrl-btn\" id=\"btnShare\"><i data-lucide=\"share-2\"></i>\uacf5\uc720</button>\n  </div>\n\n  <div class=\"toast\" id=\"toast\"><i data-lucide=\"check\" size=\"18\"></i> <span id=\"toastMsg\">\uc644\ub8cc</span></div>\n\n  <div class=\"sign-modal\" id=\"signModal\">\n      <div class=\"modal-content\">\n          <div class=\"modal-header\">\n              <span class=\"modal-title\">\uc11c\uba85 \ub610\ub294 \ub3c4\uc7a5 \uc785\ub825</span>\n              <button class=\"close-btn\" id=\"btnCloseModalX\"><i data-lucide=\"x\"></i></button>\n          </div>\n          <div class=\"modal-body\">\n              <canvas id=\"modalCanvas\"></canvas>\n              <div id=\"modalEditLayer\">\n                  <div id=\"modalEditContainer\">\n                      <img id=\"modalEditingImage\" src=\"\" alt=\"Stamp\" draggable=\"false\">\n                  </div>\n                  <div class=\"modal-edit-controls\">\n                      <span style=\"color:#fff; font-size:12px; white-space:nowrap;\">\ud06c\uae30</span>\n                      <input type=\"range\" id=\"modalScaleSlider\" min=\"0.1\" max=\"2.0\" step=\"0.05\" value=\"0.5\" style=\"flex:1;\">\n                      <button class=\"mini-btn\" id=\"btnEditCancel\">\ucde8\uc18c</button>\n                      <button class=\"mini-btn active\" id=\"btnEditApply\">\uc801\uc6a9</button>\n                  </div>\n              </div>\n          </div>\n          <div class=\"sign-tools-bar\" id=\"signToolsBar\">\n              <button class=\"mini-btn active\" id=\"btnPen\" style=\"margin-right:4px;\"><i data-lucide=\"pen-tool\" width=\"14\"></i> \ud39c</button>\n              <button class=\"mini-btn\" id=\"btnEraser\" style=\"margin-right:10px;\"><i data-lucide=\"eraser\" width=\"14\"></i> \uc9c0\uc6b0\uac1c</button>\n              <button class=\"uu-btn dashed type-gray-secondary\" id=\"btnImport\" style=\"height:40px; font-size:13px; padding:0 12px; margin-right:4px;\">\n                  <i data-lucide=\"image-plus\" width=\"16\"></i> \ub3c4\uc7a5/\uc0ac\uc9c4\n              </button>\n              <button class=\"mini-btn\" id=\"btnUndo\"><i data-lucide=\"undo-2\" width=\"14\"></i></button>\n              <button class=\"mini-btn\" id=\"btnClear\"><i data-lucide=\"trash-2\" width=\"14\"></i></button>\n              <input type=\"file\" id=\"signImageInput\" accept=\"image/*\">\n          </div>\n          <div class=\"modal-footer\">\n              <button class=\"uu-btn dashed type-gray-secondary\" id=\"btnCancelModal\">\ucde8\uc18c</button>\n              <button class=\"uu-btn solid type-blue\" id=\"btnConfirmModal\">\uc11c\uba85 \uc644\ub8cc</button>\n          </div>\n      </div>\n  </div>\n\n<script>\n    /* UI \uc720\ud2f8\ub9ac\ud2f0 */\n    class UiUtils {\n        constructor() {\n            this.toastEl = document.getElementById('toast');\n            this.toastMsgEl = document.getElementById('toastMsg');\n            this.timer = null;\n        }\n        showToast(msg) {\n            this.toastMsgEl.innerText = msg;\n            this.toastEl.classList.add('show');\n            clearTimeout(this.timer);\n            this.timer = setTimeout(() => this.toastEl.classList.remove('show'), 2000);\n        }\n    }\n\n    /* \ubdf0\uc5b4 \ub9e4\ub2c8\uc800 */\n    class ViewerManager {\n        constructor(uiUtils) {\n            this.ui = uiUtils;\n            this.viewport = document.getElementById('viewport');\n            this.paperWrapper = document.getElementById('paperWrapper');\n            this.btnPan = document.getElementById('btnPanToggle');\n            this.zoomLevel = 1.0;\n            this.isPanning = false; \n            this.startX = 0; this.startY = 0;\n            this.pointX = 0; this.pointY = 0;\n            this.bindEvents();\n        }\n        bindEvents() {\n            document.getElementById('btnZoomIn').addEventListener('click', () => this.adjustZoom(0.1));\n            document.getElementById('btnZoomOut').addEventListener('click', () => this.adjustZoom(-0.1));\n            this.btnPan.addEventListener('click', () => this.togglePan());\n            \n            const startPan = (e) => {\n                if(!this.isPanning) return;\n                if(['INPUT','TEXTAREA','BUTTON'].includes(e.target.tagName)) return;\n                if (e.target.id === 'paperSignCanvas' || (e.target.closest && e.target.closest('.sign-cell-canvas'))) return;\n                \n                e.preventDefault();\n                const cx = e.touches ? e.touches[0].clientX : e.clientX;\n                const cy = e.touches ? e.touches[0].clientY : e.clientY;\n                this.startX = cx - this.pointX;\n                this.startY = cy - this.pointY;\n\n                const moveHandler = (ev) => {\n                    ev.preventDefault();\n                    const mx = ev.touches ? ev.touches[0].clientX : ev.clientX;\n                    const my = ev.touches ? ev.touches[0].clientY : ev.clientY;\n                    this.pointX = mx - this.startX;\n                    this.pointY = my - this.startY;\n                    this.updateTransform();\n                };\n                const upHandler = () => {\n                    document.removeEventListener('mousemove', moveHandler);\n                    document.removeEventListener('mouseup', upHandler);\n                    document.removeEventListener('touchmove', moveHandler);\n                    document.removeEventListener('touchend', upHandler);\n                };\n                document.addEventListener('mousemove', moveHandler);\n                document.addEventListener('mouseup', upHandler);\n                document.addEventListener('touchmove', moveHandler, {passive: false});\n                document.addEventListener('touchend', upHandler);\n            };\n\n            this.viewport.addEventListener('mousedown', startPan);\n            this.viewport.addEventListener('touchstart', startPan, {passive:false});\n\n            window.addEventListener('resize', () => {\n                clearTimeout(this.resizeTimer);\n                this.resizeTimer = setTimeout(() => this.fitToWidth(), 200);\n            });\n            setTimeout(() => this.fitToWidth(), 100);\n        }\n        fitToWidth() {\n            const viewportW = this.viewport.clientWidth;\n            const contentW = 854; \n            let scale = viewportW / contentW;\n            if(scale > 1.1) scale = 1.0; \n            this.zoomLevel = scale;\n            this.pointX = 0;\n            this.pointY = 0;\n            this.updateTransform();\n        }\n        adjustZoom(delta) {\n            this.zoomLevel = Math.max(0.3, this.zoomLevel + delta);\n            this.updateTransform();\n        }\n        togglePan() {\n            this.isPanning = !this.isPanning;\n            this.btnPan.classList.toggle('active', this.isPanning);\n            this.viewport.classList.toggle('panning', this.isPanning);\n            this.ui.showToast(this.isPanning ? \"\uc774\ub3d9 \ubaa8\ub4dc\" : \"\uc785\ub825 \ubaa8\ub4dc\");\n        }\n        updateTransform() {\n            this.paperWrapper.style.transform = `translate(${this.pointX}px, ${this.pointY}px) scale(${this.zoomLevel})`;\n        }\n    }\n\n    /* \uc11c\uba85 \ub9e4\ub2c8\uc800 */\n    class SignatureManager {\n        constructor(uiUtils, viewerManager) {\n            this.ui = uiUtils;\n            this.viewer = viewerManager; \n            \n            this.triggerBtn = document.getElementById('triggerSignModal');\n            this.paperCanvas = document.getElementById('paperSignCanvas');\n            this.guideText = document.getElementById('clickGuideText');\n            \n            this.modal = document.getElementById('signModal');\n            this.modalCanvas = document.getElementById('modalCanvas');\n            this.fileInput = document.getElementById('signImageInput');\n            \n            this.editLayer = document.getElementById('modalEditLayer');\n            this.editImg = document.getElementById('modalEditingImage');\n            this.editContainer = document.getElementById('modalEditContainer');\n            this.scaleSlider = document.getElementById('modalScaleSlider');\n            \n            this.backgroundImages = []; \n            this.pad = null;\n            this.isOpen = false;\n            \n            this.imgState = { x: 0, y: 0, scale: 0.5 };\n            this.isDraggingImg = false;\n            this.dragStart = { x: 0, y: 0 };\n\n            this.paperSignature = null; \n            this.paperDrag = { isDragging: false, startX: 0, startY: 0, baseX: 0, baseY: 0 };\n\n            this.init();\n        }\n\n        init() {\n            this.pad = new SignaturePad(this.modalCanvas, {\n                minWidth: 1.0, maxWidth: 3.0, penColor: '#000', throttle: 8\n            });\n\n            this.triggerBtn.addEventListener('click', () => this.openModal());\n            document.getElementById('btnCloseModalX').addEventListener('click', () => this.closeModal());\n            document.getElementById('btnCancelModal').addEventListener('click', () => this.closeModal());\n            document.getElementById('btnConfirmModal').addEventListener('click', () => this.applySignature());\n\n            document.getElementById('btnPen').addEventListener('click', (e) => this.setTool('pen', e.target));\n            document.getElementById('btnEraser').addEventListener('click', (e) => this.setTool('eraser', e.target));\n            document.getElementById('btnUndo').addEventListener('click', () => this.undo());\n            document.getElementById('btnClear').addEventListener('click', () => this.clearAll());\n            \n            document.getElementById('btnImport').addEventListener('click', () => this.fileInput.click());\n            this.fileInput.addEventListener('change', (e) => this.handleFile(e));\n\n            document.getElementById('btnEditCancel').addEventListener('click', () => this.closeEditor());\n            document.getElementById('btnEditApply').addEventListener('click', () => this.applyEditorImage());\n            \n            this.scaleSlider.addEventListener('input', (e) => {\n                this.imgState.scale = parseFloat(e.target.value);\n                this.updateImgTransform();\n            });\n            \n            this.editImg.addEventListener('mousedown', (e) => this.startDrag(e));\n            this.editImg.addEventListener('touchstart', (e) => this.startDrag(e), {passive:false});\n            \n            new ResizeObserver(() => this.resizePaperCanvas()).observe(this.paperCanvas.parentElement);\n\n            this.paperCanvas.addEventListener('mousedown', (e) => this.startPaperDrag(e));\n            this.paperCanvas.addEventListener('touchstart', (e) => this.startPaperDrag(e), { passive: false });\n        }\n\n        openModal() {\n            this.isOpen = true;\n            this.modal.classList.add('open');\n            setTimeout(() => { this.resizeModalCanvas(); }, 100);\n        }\n\n        closeModal() {\n            this.isOpen = false;\n            this.modal.classList.remove('open');\n            this.closeEditor();\n        }\n\n        resizeModalCanvas() {\n            const container = this.modalCanvas.parentElement;\n            const ratio = Math.max(window.devicePixelRatio || 1, 1);\n            const w = container.clientWidth;\n            const h = container.clientHeight;\n            \n            if (this.modalCanvas.width !== w * ratio) {\n                const data = this.pad.toData(); \n                this.modalCanvas.width = w * ratio;\n                this.modalCanvas.height = h * ratio;\n                this.modalCanvas.getContext('2d').scale(ratio, ratio);\n                this.pad.clear();\n                this.redrawBackgrounds(); \n                this.pad.fromData(data); \n            }\n        }\n        \n        setTool(type, btn) {\n            const allBtns = document.querySelectorAll('.sign-tools-bar button');\n            allBtns.forEach(b => b.classList.remove('active'));\n            (btn.closest('button') || btn).classList.add('active');\n            \n            if(type === 'eraser') {\n                this.pad.compositeOperation = 'destination-out';\n                this.pad.minWidth = 10; this.pad.maxWidth = 20;\n            } else {\n                this.pad.compositeOperation = 'source-over';\n                this.pad.minWidth = 1; this.pad.maxWidth = 3;\n            }\n        }\n\n        undo() {\n            const data = this.pad.toData();\n            if (data && data.length > 0) {\n                data.pop();\n                this.pad.fromData(data);\n            } else if (this.backgroundImages.length > 0) {\n                this.backgroundImages.pop();\n                this.resizeModalCanvas(); \n                this.ui.showToast(\"\uc774\ubbf8\uc9c0 \uc0ad\uc81c\ub428\");\n            }\n        }\n\n        clearAll() {\n            if(confirm(\"\ubaa8\ub450 \uc9c0\uc6b0\uc2dc\uaca0\uc2b5\ub2c8\uae4c?\")) {\n                this.pad.clear();\n                this.backgroundImages = [];\n                this.resizeModalCanvas();\n            }\n        }\n\n        handleFile(e) {\n            const file = e.target.files[0];\n            if(!file) return;\n            const reader = new FileReader();\n            reader.onload = (ev) => {\n                const img = new Image();\n                img.onload = () => {\n                    const processedUrl = this.processImage(img);\n                    this.openEditor(processedUrl);\n                };\n                img.src = ev.target.result;\n            };\n            reader.readAsDataURL(file);\n            e.target.value = '';\n        }\n\n        processImage(img) {\n            const c = document.createElement('canvas');\n            const w = img.width, h = img.height;\n            const max = 800;\n            let scale = 1;\n            if(w > max || h > max) scale = max / Math.max(w,h);\n            c.width = w * scale; c.height = h * scale;\n            const ctx = c.getContext('2d');\n            ctx.drawImage(img, 0, 0, c.width, c.height);\n            const idata = ctx.getImageData(0,0,c.width,c.height);\n            const data = idata.data;\n            for(let i=0; i<data.length; i+=4) {\n                const avg = (data[i]+data[i+1]+data[i+2])/3;\n                if(avg > 200) data[i+3] = 0; \n                else { data[i] = data[i+1] = data[i+2] = 0; }\n            }\n            ctx.putImageData(idata, 0,0);\n            return c.toDataURL();\n        }\n\n        openEditor(src) {\n            this.editImg.src = src;\n            this.editLayer.style.display = 'flex';\n            this.imgState = { x: 0, y: 0, scale: 0.5 };\n            this.scaleSlider.value = 0.5;\n            this.updateImgTransform();\n        }\n        \n        closeEditor() { this.editLayer.style.display = 'none'; }\n\n        updateImgTransform() {\n            this.editImg.style.transform = `translate(-50%, -50%) translate(${this.imgState.x}px, ${this.imgState.y}px) scale(${this.imgState.scale})`;\n        }\n\n        startDrag(e) {\n            e.preventDefault();\n            this.isDraggingImg = true;\n            const cx = e.touches ? e.touches[0].clientX : e.clientX;\n            const cy = e.touches ? e.touches[0].clientY : e.clientY;\n            this.dragStart = { x: cx - this.imgState.x, y: cy - this.imgState.y };\n            \n            const move = (ev) => {\n                if(!this.isDraggingImg) return;\n                ev.preventDefault();\n                const mx = ev.touches ? ev.touches[0].clientX : ev.clientX;\n                const my = ev.touches ? ev.touches[0].clientY : ev.clientY;\n                this.imgState.x = mx - this.dragStart.x;\n                this.imgState.y = my - this.dragStart.y;\n                this.updateImgTransform();\n            };\n            const end = () => {\n                this.isDraggingImg = false;\n                document.removeEventListener('mousemove', move);\n                document.removeEventListener('mouseup', end);\n                document.removeEventListener('touchmove', move);\n                document.removeEventListener('touchend', end);\n            };\n            document.addEventListener('mousemove', move);\n            document.addEventListener('mouseup', end);\n            document.addEventListener('touchmove', move, {passive:false});\n            document.addEventListener('touchend', end);\n        }\n\n        applyEditorImage() {\n            const imgRect = this.editImg.getBoundingClientRect();\n            const containerRect = this.editContainer.getBoundingClientRect();\n            \n            const imgCenterX = imgRect.left + imgRect.width / 2;\n            const imgCenterY = imgRect.top + imgRect.height / 2;\n            const contCenterX = containerRect.left + containerRect.width / 2;\n            const contCenterY = containerRect.top + containerRect.height / 2;\n\n            const relX = (imgCenterX - contCenterX) / containerRect.width;\n            const relY = (imgCenterY - contCenterY) / containerRect.height;\n\n            const ratioX = this.modalCanvas.width / containerRect.width;\n            const ratioY = this.modalCanvas.height / containerRect.height;\n\n            const w = imgRect.width * ratioX;\n            const h = imgRect.height * ratioY;\n\n            const canvasCenterX = this.modalCanvas.width / 2;\n            const canvasCenterY = this.modalCanvas.height / 2;\n\n            const drawCenterX = canvasCenterX + relX * this.modalCanvas.width;\n            const drawCenterY = canvasCenterY + relY * this.modalCanvas.height;\n\n            const x = drawCenterX - w / 2;\n            const y = drawCenterY - h / 2;\n            \n            const imgObj = new Image();\n            imgObj.onload = () => {\n                this.backgroundImages.push({ img: imgObj, x, y, w, h });\n                this.redrawBackgrounds();\n                this.closeEditor();\n            };\n            imgObj.src = this.editImg.src; \n        }\n\n        redrawBackgrounds() {\n            const ctx = this.modalCanvas.getContext('2d');\n            const prevComp = ctx.globalCompositeOperation;\n            ctx.globalCompositeOperation = 'destination-over'; \n            this.backgroundImages.forEach(item => {\n                ctx.drawImage(item.img, item.x, item.y, item.w, item.h);\n            });\n            ctx.globalCompositeOperation = prevComp;\n        }\n\n        resizePaperCanvas() {\n            const w = this.paperCanvas.parentElement.clientWidth;\n            const h = this.paperCanvas.parentElement.clientHeight;\n            if(!w || !h) return;\n            const ratio = 2; \n            this.paperCanvas.width = w * ratio;\n            this.paperCanvas.height = h * ratio;\n            if (this.paperSignature) { this.renderPaperSignature(); }\n        }\n\n        applySignature() {\n            if (this.pad.isEmpty() && this.backgroundImages.length === 0) {\n                this.ui.showToast(\"\uc11c\uba85 \ub0b4\uc6a9\uc774 \uc5c6\uc2b5\ub2c8\ub2e4.\");\n                return;\n            }\n\n            const dataURL = this.modalCanvas.toDataURL(\"image/png\");\n            \n            const img = new Image();\n            img.onload = () => {\n                const ctx = this.paperCanvas.getContext('2d');\n                const pw = this.paperCanvas.width;\n                const ph = this.paperCanvas.height;\n                const iw = img.width;\n                const ih = img.height;\n\n                const canvasRatio = pw / ph;\n                const imgRatio = iw / ih;\n\n                let drawW, drawH, offsetX, offsetY;\n                const marginScale = 0.9; \n\n                if (imgRatio > canvasRatio) {\n                    drawW = pw * marginScale;\n                    drawH = drawW / imgRatio;\n                } else {\n                    drawH = ph * marginScale;\n                    drawW = drawH * imgRatio;\n                }\n\n                offsetX = (pw - drawW) / 2;\n                offsetY = (ph - drawH) / 2;\n\n                this.paperSignature = { img, w: drawW, h: drawH, x: offsetX, y: offsetY };\n                this.renderPaperSignature();\n                \n                this.guideText.style.display = 'none';\n                this.closeModal();\n                this.ui.showToast(\"\uc11c\uba85\uc774 \uc801\uc6a9\ub418\uc5c8\uc2b5\ub2c8\ub2e4\");\n            };\n            img.src = dataURL;\n        }\n        \n        clearPaper() {\n            const ctx = this.paperCanvas.getContext('2d');\n            ctx.clearRect(0, 0, this.paperCanvas.width, this.paperCanvas.height);\n            this.guideText.style.display = 'block';\n            this.clearAll(); \n            this.paperSignature = null;\n        }\n\n        renderPaperSignature() {\n            const ctx = this.paperCanvas.getContext('2d');\n            ctx.clearRect(0, 0, this.paperCanvas.width, this.paperCanvas.height);\n            if (!this.paperSignature) return;\n            const s = this.paperSignature;\n            ctx.drawImage(s.img, s.x, s.y, s.w, s.h);\n        }\n\n        startPaperDrag(e) {\n            if (!this.paperSignature) return; \n            if (!this.viewer || !this.viewer.isPanning) return; \n            e.preventDefault();\n\n            const rect = this.paperCanvas.getBoundingClientRect();\n            const isTouch = !!e.touches;\n            const cx = isTouch ? e.touches[0].clientX : e.clientX;\n            const cy = isTouch ? e.touches[0].clientY : e.clientY;\n\n            this.paperDrag.isDragging = true;\n            this.paperDrag.startX = cx;\n            this.paperDrag.startY = cy;\n            this.paperDrag.baseX = this.paperSignature.x;\n            this.paperDrag.baseY = this.paperSignature.y;\n\n            const move = (ev) => {\n                if (!this.paperDrag.isDragging) return;\n                ev.preventDefault();\n                const mx = ev.touches ? ev.touches[0].clientX : ev.clientX;\n                const my = ev.touches ? ev.touches[0].clientY : ev.clientY;\n                const ratioX = this.paperCanvas.width / rect.width;\n                const ratioY = this.paperCanvas.height / rect.height;\n                const dx = (mx - this.paperDrag.startX) * ratioX;\n                const dy = (my - this.paperDrag.startY) * ratioY;\n                this.paperSignature.x = this.paperDrag.baseX + dx;\n                this.paperSignature.y = this.paperDrag.baseY + dy;\n                this.renderPaperSignature();\n            };\n            const end = () => {\n                this.paperDrag.isDragging = false;\n                document.removeEventListener('mousemove', move);\n                document.removeEventListener('mouseup', end);\n                document.removeEventListener('touchmove', move);\n                document.removeEventListener('touchend', end);\n            };\n            document.addEventListener('mousemove', move);\n            document.addEventListener('mouseup', end);\n            document.addEventListener('touchmove', move, { passive: false });\n            document.addEventListener('touchend', end);\n        }\n    }\n\n    /* \ub0b4\ubcf4\ub0b4\uae30 (PDF/\uacf5\uc720) */\n    class Exporter {\n        constructor(uiUtils) {\n            this.ui = uiUtils;\n            this.paperWrapper = document.getElementById('paperWrapper');\n            this.documentArea = document.getElementById('documentArea');\n            document.getElementById('btnDownload').addEventListener('click', () => this.savePDF());\n            document.getElementById('btnShare').addEventListener('click', () => this.shareContent());\n        }\n\n        // \u2705 [\ucd94\uac00] html2canvas\uac00 input \ud14d\uc2a4\ud2b8\ub97c \uc704\uc5d0\uc11c \uc790\ub974\ub294 \ubb38\uc81c\ub97c \ud53c\ud558\uae30 \uc704\ud574\n        // \ucea1\ucc98\uc6a9 clone DOM\uc5d0\uc11c\ub9cc recipient \uc785\ub825\uc744 div\ub85c \uce58\ud658 (\ub808\uc774\uc544\uc6c3\uc740 \ub3d9\uc77c)\n        _fixRecipientForCapture(clonedDoc) {\n            try {\n                const docArea = clonedDoc.getElementById('documentArea');\n                if (!docArea) return;\n\n                const row = docArea.querySelector('.recipient-row');\n                if (!row) return;\n\n                const companyInput = row.querySelector('input.recipient-input');\n                const suffixInput  = row.querySelector('input.recipient-suffix');\n\n                const replaceWithDiv = (inputEl, cssText, fallbackText = \"\") => {\n                    if (!inputEl || !inputEl.parentNode) return;\n                    const div = clonedDoc.createElement('div');\n                    const val = (inputEl.value || \"\").trim();\n                    div.textContent = val || fallbackText; // placeholder\ub294 prepareCapture\uc5d0\uc11c \uc774\ubbf8 \uc81c\uac70\ub428\n                    div.setAttribute('style', cssText);\n                    inputEl.parentNode.replaceChild(div, inputEl);\n                };\n\n                // \ud68c\uc0ac\uba85 \uce78 (\ubc11\uc904 \ud3ec\ud568, \ub192\uc774/\ud3ed \ub3d9\uc77c + line-height\ub85c \uc218\uc9c1\uc911\uc559 \u2192 \uc0c1\ub2e8 \uc798\ub9bc \ubc29\uc9c0)\n                if (companyInput) {\n                    replaceWithDiv(\n                        companyInput,\n                        [\n                          \"text-align:center\",\n                          \"font-size:24px\",\n                          \"font-weight:800\",\n                          \"width:300px\",\n                          \"height:60px\",\n                          \"line-height:60px\",\n                          \"box-sizing:border-box\",\n                          \"border-bottom:2px solid #000\",\n                          \"background:transparent\",\n                          \"border-radius:0\",\n                          \"padding:0\",\n                          \"margin-bottom:3px\",\n                          \"color:#000\",\n                          \"font-family:inherit\"\n                        ].join(\";\"),\n                        \"\" // \ube48 \uac12\uc774\uba74 \uadf8\ub0e5 \uacf5\ub780\n                    );\n                }\n\n                // \uadc0\uc911 \uce78\n                if (suffixInput) {\n                    replaceWithDiv(\n                        suffixInput,\n                        [\n                          \"width:60px\",\n                          \"text-align:left\",\n                          \"font-size:20px\",\n                          \"font-weight:700\",\n                          \"height:auto\",\n                          \"line-height:1.4\",\n                          \"box-sizing:border-box\",\n                          \"border:none\",\n                          \"background:transparent\",\n                          \"padding:0\",\n                          \"margin-bottom:10px\",\n                          \"color:#000\",\n                          \"font-family:inherit\"\n                        ].join(\";\"),\n                        \"\uadc0\uc911\"\n                    );\n                }\n            } catch (e) {\n                // \ucea1\ucc98\ub294 \uacc4\uc18d \uc9c4\ud589\n                console.warn(\"Recipient capture fix skipped:\", e);\n            }\n        }\n\n        async prepareCapture() {\n            const originalTransform = this.paperWrapper.style.transform;\n            const originalMargin = this.paperWrapper.style.margin;\n            \n            const inputs = document.querySelectorAll('input, textarea');\n            const placeholders = [];\n            inputs.forEach(el => {\n                placeholders.push({el, val: el.placeholder});\n                el.placeholder = \"\";\n            });\n            \n            const guideText = document.getElementById('clickGuideText');\n            const guideTextDisplay = guideText ? guideText.style.display : null;\n            if (guideText) { guideText.style.display = 'none'; }\n\n            this.paperWrapper.style.transform = 'scale(1)';\n            this.paperWrapper.style.margin = '0';\n            document.body.classList.add('clean-mode');\n            \n            await new Promise(r => setTimeout(r, 100));\n\n            return () => {\n                this.paperWrapper.style.transform = originalTransform;\n                this.paperWrapper.style.margin = originalMargin;\n                document.body.classList.remove('clean-mode');\n                placeholders.forEach(item => item.el.placeholder = item.val);\n                if (guideText) { guideText.style.display = guideTextDisplay || ''; }\n            };\n        }\n\n        async savePDF() {\n            this.ui.showToast(\"PDF \uc0dd\uc131 \uc911...\");\n            const restore = await this.prepareCapture();\n            try {\n                const canvas = await html2canvas(this.documentArea, {\n                    scale: 2, useCORS: true, backgroundColor: \"#ffffff\",\n                    // \u2705 [\ucd94\uac00] clone DOM\uc5d0\uc11c\ub9cc input \u2192 div \uce58\ud658\n                    onclone: (clonedDoc) => this._fixRecipientForCapture(clonedDoc)\n                });\n                \n                const imgData = canvas.toDataURL('image/jpeg', 0.95);\n                const { jsPDF } = window.jspdf;\n                const pdf = new jsPDF('p', 'mm', 'a4');\n                const pW = pdf.internal.pageSize.getWidth();\n                const pH = pdf.internal.pageSize.getHeight();\n                const imgH = canvas.height * pW / canvas.width;\n                \n                if (imgH <= pH) {\n                    const totalMargin = pH - imgH;\n                    const topMargin = totalMargin / 2; \n                    pdf.addImage(imgData, 'JPEG', 0, topMargin, pW, imgH);\n                } else {\n                    const ratio = pH / imgH;\n                    pdf.addImage(imgData, 'JPEG', 0, 0, pW * ratio, imgH * ratio);\n                }\n                \n                pdf.save(`\uc791\uc5c5\uc644\ub8cc\ud655\uc778\uc11c_${this.getDateStr()}.pdf`);\n                this.ui.showToast(\"\uc800\uc7a5\ub418\uc5c8\uc2b5\ub2c8\ub2e4!\");\n            } catch(e) {\n                console.error(e);\n                this.ui.showToast(\"\uc800\uc7a5 \uc2e4\ud328\");\n            } finally {\n                restore();\n            }\n        }\n\n        async shareContent() {\n            if(!navigator.share) { alert(\"\uacf5\uc720 \uae30\ub2a5\uc744 \uc9c0\uc6d0\ud558\uc9c0 \uc54a\ub294 \ube0c\ub77c\uc6b0\uc800\uc785\ub2c8\ub2e4.\"); return; }\n            this.ui.showToast(\"\uc774\ubbf8\uc9c0 \uc0dd\uc131 \uc911...\");\n            const restore = await this.prepareCapture();\n            try {\n                const canvas = await html2canvas(this.documentArea, { \n                    scale: 2, useCORS: true,\n                    // \u2705 [\ucd94\uac00] \uacf5\uc720 \ucea1\ucc98\ub3c4 \ub3d9\uc77c \uc801\uc6a9\n                    onclone: (clonedDoc) => this._fixRecipientForCapture(clonedDoc)\n                });\n                canvas.toBlob(async (blob) => {\n                    const file = new File([blob], \"confirmation.jpg\", { type: \"image/jpeg\" });\n                    await navigator.share({ title: '\uc791\uc5c5\ud655\uc778\uc11c', files: [file] });\n                }, 'image/jpeg', 0.9);\n            } catch(e) {\n                this.ui.showToast(\"\uacf5\uc720 \uc2e4\ud328\");\n            } finally {\n                restore();\n            }\n        }\n        \n        getDateStr() {\n            const d = new Date();\n            return `${d.getFullYear()}${String(d.getMonth()+1).padStart(2,'0')}${String(d.getDate()).padStart(2,'0')}`;\n        }\n    }\n\n    /* \uba54\uc778 \uc571 \ucd08\uae30\ud654 */\n    class App {\n        constructor() {\n            const isIframe = window.self !== window.top;\n            if (isIframe) { document.body.classList.add('iframe-mode'); }\n            \n            this.ui = new UiUtils();\n            this.viewer = new ViewerManager(this.ui);\n            this.signer = new SignatureManager(this.ui, this.viewer);\n            this.exporter = new Exporter(this.ui);\n            \n            document.getElementById('btnBack').addEventListener('click', () => { if(confirm(\"\uc885\ub8cc\ud558\uc2dc\uaca0\uc2b5\ub2c8\uae4c?\")) history.back(); });\n            document.getElementById('btnReset').addEventListener('click', () => {\n                if(confirm(\"\ubaa8\ub4e0 \uc785\ub825\uc744 \ucd08\uae30\ud654\ud558\uc2dc\uaca0\uc2b5\ub2c8\uae4c?\")) {\n                    document.querySelectorAll('input, textarea').forEach(el => {\n                        // \ub0a0\uc9dc\uc640 \uadc0\uc911, \uc18c\uc18d \uae30\ubcf8\uac12\uc740 \uc720\uc9c0\ud558\uace0 \uc2f6\ub2e4\uba74 \uc81c\uc678 \uc870\uac74 \ucd94\uac00 \uac00\ub2a5\ud558\uc9c0\ub9cc\n                        // \uc694\uccad\ud558\uc2e0 \ub9ac\uc14b \uae30\ub2a5\uc740 \uc804\uccb4 \ucd08\uae30\ud654\uac00 \uc77c\ubc18\uc801\uc774\ubbc0\ub85c \ub2e4 \ube44\uc6c0 (\ub2e8, \uadc0\uc911\uc740 '\uadc0\uc911'\uc73c\ub85c \ubcf5\uc6d0\ud558\ub294\uac8c \uc88b\uc74c)\n                        if(el.classList.contains('recipient-suffix')) {\n                             el.value = '\uadc0\uc911';\n                        } else {\n                             el.value = '';\n                        }\n                    });\n                    this.signer.clearPaper();\n                    this.ui.showToast(\"\ucd08\uae30\ud654 \uc644\ub8cc\");\n                }\n            });\n            \n            const d = new Date();\n            document.getElementById('dateField').value = `${d.getFullYear()}\ub144 ${d.getMonth()+1}\uc6d4 ${d.getDate()}\uc77c`;\n            \n            if (window.lucide && typeof window.lucide.createIcons === 'function') {\n                window.lucide.createIcons();\n            }\n\n            // [\ucd94\uac00] Table Textarea \uc790\ub3d9 \ub192\uc774 \uc870\uc808\n            this.initAutoResize();\n        }\n\n        initAutoResize() {\n            const textareas = document.querySelectorAll('.table-input');\n            const resize = (el) => {\n                el.style.height = 'auto'; \n                el.style.height = el.scrollHeight + 'px';\n            };\n            textareas.forEach(el => {\n                el.addEventListener('input', () => resize(el));\n                // \ucd08\uae30\uac12 \uc788\uc73c\uba74 \ub9ac\uc0ac\uc774\uc988\n                if(el.value) resize(el);\n            });\n        }\n    }\n\n    document.addEventListener('DOMContentLoaded', () => { new App(); });\n<\/script>\n</body>\n</html>\n";

      // [V4] 첨부된 작업완료확인서V4.html을 그대로 실행하기 위한 내장 HTML (Base64)
      const I3_CONFIRM_V4_B64 = "PCFET0NUWVBFIGh0bWw+CjxodG1sIGxhbmc9ImtvIj4KPGhlYWQ+CiAgPG1ldGEgY2hhcnNldD0iVVRGLTgiPgogIDxtZXRhIG5hbWU9InZpZXdwb3J0IiBjb250ZW50PSJ3aWR0aD1kZXZpY2Utd2lkdGgsIGluaXRpYWwtc2NhbGU9MS4wLCBtYXhpbXVtLXNjYWxlPTEuMCwgdXNlci1zY2FsYWJsZT1ubywgdmlld3BvcnQtZml0PWNvdmVyIj4KICA8dGl0bGU+7J6R7JeF7JmE66OM7ZmV7J247IScIC0g7LWc7KKFIOyImOygleuzuDwvdGl0bGU+IAoKICA8bGluayByZWw9InN0eWxlc2hlZXQiIGFzPSJzdHlsZSIgY3Jvc3NvcmlnaW4gaHJlZj0iaHR0cHM6Ly9jZG4uanNkZWxpdnIubmV0L2doL29yaW9uY2FjdHVzL3ByZXRlbmRhcmRAdjEuMy45L2Rpc3Qvd2ViL3N0YXRpYy9wcmV0ZW5kYXJkLm1pbi5jc3MiIC8+CiAgPHNjcmlwdCBzcmM9Imh0dHBzOi8vdW5wa2cuY29tL2x1Y2lkZUBsYXRlc3QvZGlzdC91bWQvbHVjaWRlLmpzIj48L3NjcmlwdD4KICA8c2NyaXB0IHNyYz0iaHR0cHM6Ly9jZG4uanNkZWxpdnIubmV0L25wbS9zaWduYXR1cmVfcGFkQDQuMS43L2Rpc3Qvc2lnbmF0dXJlX3BhZC51bWQubWluLmpzIj48L3NjcmlwdD4KICA8c2NyaXB0IHNyYz0iaHR0cHM6Ly9jZG5qcy5jbG91ZGZsYXJlLmNvbS9hamF4L2xpYnMvaHRtbDJjYW52YXMvMS40LjEvaHRtbDJjYW52YXMubWluLmpzIj48L3NjcmlwdD4KICA8c2NyaXB0IHNyYz0iaHR0cHM6Ly9jZG5qcy5jbG91ZGZsYXJlLmNvbS9hamF4L2xpYnMvanNwZGYvMi41LjEvanNwZGYudW1kLm1pbi5qcyI+PC9zY3JpcHQ+CgogIDxzdHlsZT4KICAgIC8qID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09CiAgICAgICBNT0RVTEU6IENPUkUgU1RZTEVTCiAgICAgICA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PSAqLwogICAgOnJvb3QgewogICAgICAgIC0tZm9udC1tYWluOiAiUHJldGVuZGFyZCBWYXJpYWJsZSIsIFByZXRlbmRhcmQsIHNhbnMtc2VyaWY7CiAgICAgICAgLS1iZy12aWV3ZXI6ICMxZTFlMWU7IAogICAgICAgIC0tYmctcGFwZXI6ICNmZmZmZmY7CiAgICAgICAgLS1ib3JkZXItY29sb3I6ICMxZTI5M2I7CiAgICAgICAgLS1wcmltYXJ5LWNvbG9yOiAjMjU2M2ViOwogICAgICAgIAogICAgICAgIC8qIFVzZXIgUHJvdmlkZWQgQ29sb3JzICovCiAgICAgICAgLS1oZWFkZXItbmF2eTogIzFhMjU0ZjsKICAgICAgICAtLXByaW1hcnk6ICMzMWEzZmE7CiAgICAgICAgLS1wcmltYXJ5LWJnOiAjZWFmNmZmOwogICAgfQogICAgKiB7IGJveC1zaXppbmc6IGJvcmRlci1ib3g7IC13ZWJraXQtdGFwLWhpZ2hsaWdodC1jb2xvcjogdHJhbnNwYXJlbnQ7IH0KICAgIAogICAgYm9keSB7IAogICAgICAgIG1hcmdpbjogMDsgcGFkZGluZzogMDsgCiAgICAgICAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtbWFpbik7IAogICAgICAgIGJhY2tncm91bmQ6IHZhcigtLWJnLXZpZXdlcik7IAogICAgICAgIGNvbG9yOiAjZmZmOwogICAgICAgIGhlaWdodDogMTAwdmg7IHdpZHRoOiAxMDB2dzsgb3ZlcmZsb3c6IGhpZGRlbjsKICAgICAgICBkaXNwbGF5OiBmbGV4OyBmbGV4LWRpcmVjdGlvbjogY29sdW1uOwogICAgICAgIG92ZXJzY3JvbGwtYmVoYXZpb3I6IG5vbmU7IAogICAgfQogICAgCiAgICAvKiBpZnJhbWUg66qo65Oc7J28IOuVjCDtl6TrjZQg7Iio6riw6riwICovCiAgICBib2R5LmlmcmFtZS1tb2RlIC5oZWFkZXItYmFyIHsgZGlzcGxheTogbm9uZSAhaW1wb3J0YW50OyB9CiAgICBib2R5LmlmcmFtZS1tb2RlIC52aWV3cG9ydCB7IGhlaWdodDogMTAwdmg7IHBhZGRpbmctdG9wOiAwOyB9CgogICAgLyogPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0KICAgICAgIE1PRFVMRTogSEVBREVSCiAgICAgICA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PSAqLwogICAgLmhlYWRlci1iYXIgewogICAgICAgIGhlaWdodDogNjBweDsgYmFja2dyb3VuZDogIzAwMDsgCiAgICAgICAgZGlzcGxheTogZmxleDsgYWxpZ24taXRlbXM6IGNlbnRlcjsganVzdGlmeS1jb250ZW50OiBzcGFjZS1iZXR3ZWVuOwogICAgICAgIHBhZGRpbmc6IDAgMTZweDsgZmxleC1zaHJpbms6IDA7IHotaW5kZXg6IDEwMDsgYm9yZGVyLWJvdHRvbTogMXB4IHNvbGlkICMzMzM7CiAgICB9CiAgICAuaGVhZGVyLXRpdGxlIHsgZm9udC1zaXplOiAxOHB4OyBmb250LXdlaWdodDogNzAwOyBjb2xvcjogI2ZmZjsgfQogICAgLmhlYWRlci1yaWdodCB7IGRpc3BsYXk6IGZsZXg7IGFsaWduLWl0ZW1zOiBjZW50ZXI7IGdhcDogOHB4OyB9CgogICAgLmljb24tYnRuIHsKICAgICAgICBiYWNrZ3JvdW5kOiBub25lOyBib3JkZXI6IG5vbmU7IGNvbG9yOiAjZmZmOyBjdXJzb3I6IHBvaW50ZXI7CiAgICAgICAgcGFkZGluZzogOHB4OyBib3JkZXItcmFkaXVzOiA1MCU7IGRpc3BsYXk6IGZsZXg7IGFsaWduLWl0ZW1zOiBjZW50ZXI7IGp1c3RpZnktY29udGVudDogY2VudGVyOwogICAgfQogICAgLmljb24tYnRuOmhvdmVyIHsgYmFja2dyb3VuZDogcmdiYSgyNTUsMjU1LDI1NSwwLjE1KTsgfQoKICAgIC8qID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09CiAgICAgICBNT0RVTEU6IFZJRVdFUiAoTGF5b3V0IEZpeGVkKQogICAgICAgPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0gKi8KICAgIC52aWV3cG9ydCB7CiAgICAgICAgZmxleDogMTsgcG9zaXRpb246IHJlbGF0aXZlOyBvdmVyZmxvdzogaGlkZGVuOwogICAgICAgIGJhY2tncm91bmQ6IHZhcigtLWJnLXZpZXdlcik7CiAgICAgICAgZGlzcGxheTogZmxleDsgCiAgICAgICAganVzdGlmeS1jb250ZW50OiBjZW50ZXI7IAogICAgICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7ICAgICAKICAgICAgICB0b3VjaC1hY3Rpb246IG5vbmU7IAogICAgICAgIGN1cnNvcjogZGVmYXVsdDsKICAgIH0KICAgIC52aWV3cG9ydC5wYW5uaW5nIHsgY3Vyc29yOiBncmFiICFpbXBvcnRhbnQ7IH0KICAgIC52aWV3cG9ydC5wYW5uaW5nOmFjdGl2ZSB7IGN1cnNvcjogZ3JhYmJpbmcgIWltcG9ydGFudDsgfQogICAgCiAgICAucGFwZXItd3JhcHBlciB7CiAgICAgICAgdHJhbnNmb3JtLW9yaWdpbjogY2VudGVyIGNlbnRlcjsgCiAgICAgICAgdHJhbnNpdGlvbjogdHJhbnNmb3JtIDAuMDVzIGxpbmVhcjsgCiAgICAgICAgd2lsbC1jaGFuZ2U6IHRyYW5zZm9ybTsgCiAgICAgICAgcGFkZGluZzogMDsKICAgICAgICBib3gtc2hhZG93OiAwIDRweCAzMHB4IHJnYmEoMCwwLDAsMC41KTsKICAgIH0KCiAgICAuYTQtcGFwZXIgewogICAgICAgIHdpZHRoOiAyMTBtbTsgbWluLWhlaWdodDogMjk3bW07CiAgICAgICAgYmFja2dyb3VuZDogdmFyKC0tYmctcGFwZXIpOyBjb2xvcjogIzAwMDsKICAgICAgICBwYWRkaW5nOiAxNW1tOyAKICAgICAgICBkaXNwbGF5OiBmbGV4OyBmbGV4LWRpcmVjdGlvbjogY29sdW1uOwogICAgICAgIGp1c3RpZnktY29udGVudDogY2VudGVyOyAKICAgIH0KCiAgICAvKiDrrLjshJwg64K067aAIOyKpO2DgOydvCAqLwogICAgLmRvYy1oZWFkZXIgeyB0ZXh0LWFsaWduOiBjZW50ZXI7IG1hcmdpbi1ib3R0b206IDMwcHg7IGJvcmRlci1ib3R0b206IDNweCBkb3VibGUgIzAwMDsgcGFkZGluZy1ib3R0b206IDE1cHg7IH0KICAgIC5kb2MtdGl0bGUgeyBmb250LXNpemU6IDM2cHg7IGZvbnQtd2VpZ2h0OiA5MDA7IGxldHRlci1zcGFjaW5nOiA1cHg7IGNvbG9yOiAjMTExOyBtYXJnaW46IDA7IH0KCiAgICAuaW5mby10YWJsZSB7IHdpZHRoOiAxMDAlOyBib3JkZXItY29sbGFwc2U6IGNvbGxhcHNlOyBib3JkZXI6IDJweCBzb2xpZCB2YXIoLS1ib3JkZXItY29sb3IpOyBtYXJnaW4tYm90dG9tOiAyMHB4OyB0YWJsZS1sYXlvdXQ6IGZpeGVkOyB9CiAgICAuaW5mby10YWJsZSB0aCwgLmluZm8tdGFibGUgdGQgeyBib3JkZXI6IDFweCBzb2xpZCB2YXIoLS1ib3JkZXItY29sb3IpOyBwYWRkaW5nOiA4cHg7IHZlcnRpY2FsLWFsaWduOiBtaWRkbGU7IH0KICAgIC5pbmZvLXRhYmxlIHRoIHsgYmFja2dyb3VuZDogI2Y4ZmFmYzsgZm9udC13ZWlnaHQ6IDgwMDsgdGV4dC1hbGlnbjogY2VudGVyOyBmb250LXNpemU6IDE2cHg7IGNvbG9yOiAjMzM0MTU1OyB3b3JkLWJyZWFrOiBrZWVwLWFsbDsgfQoKICAgIC8qIFRhYmxlIOuCtOu2gCDsnoXroKXssL0g7Iqk7YOA7J28IChUZXh0YXJlYSkgKi8KICAgIC50YWJsZS1pbnB1dCB7CiAgICAgICAgd2lkdGg6IDEwMCU7IGJvcmRlcjogbm9uZTsgYmFja2dyb3VuZDogdHJhbnNwYXJlbnQ7CiAgICAgICAgZm9udC1mYW1pbHk6IGluaGVyaXQ7IGZvbnQtc2l6ZTogMTZweDsgY29sb3I6ICMwMDA7IG91dGxpbmU6IG5vbmU7CiAgICAgICAgcGFkZGluZzogMnB4OyBmb250LXdlaWdodDogNjAwOyByZXNpemU6IG5vbmU7IG92ZXJmbG93OiBoaWRkZW47CiAgICAgICAgbWluLWhlaWdodDogMjRweDsgbGluZS1oZWlnaHQ6IDEuNDsgdmVydGljYWwtYWxpZ246IG1pZGRsZTsKICAgICAgICBkaXNwbGF5OiBibG9jazsKICAgIH0KCiAgICAvKiBb7KSR7JqUXSBmb250LWZhbWlseSBpbmhlcml0IOy2lOqwgDog7Iuc7Iqk7YWcIO2PsO2KuOuhnCDroIzrjZTrp4HrkJjslrQg64aS7J206rCAIOuLrOudvOyngOuKlCDrrLjsoJwg67Cp7KeAICovCiAgICBpbnB1dCwgdGV4dGFyZWEgeyAKICAgICAgICB3aWR0aDogMTAwJTsgYm9yZGVyOiBub25lOyBiYWNrZ3JvdW5kOiB0cmFuc3BhcmVudDsgCiAgICAgICAgZm9udC1mYW1pbHk6IGluaGVyaXQ7IGZvbnQtc2l6ZTogMTZweDsgY29sb3I6ICMwMDA7IG91dGxpbmU6IG5vbmU7IAogICAgICAgIHBhZGRpbmc6IDRweDsgZm9udC13ZWlnaHQ6IDYwMDsgcmVzaXplOiBub25lOwogICAgfQogICAgaW5wdXQ6OnBsYWNlaG9sZGVyLCB0ZXh0YXJlYTo6cGxhY2Vob2xkZXIgeyBjb2xvcjogI2NiZDVlMTsgZm9udC13ZWlnaHQ6IDQwMDsgfQogICAgaW5wdXQ6Zm9jdXMsIHRleHRhcmVhOmZvY3VzIHsgYmFja2dyb3VuZDogcmdiYSgzNywgOTksIDIzNSwgMC4wNSk7IH0KCiAgICAvKiBQREYg7KCA7J6lIOuqqOuTnCAqLwogICAgYm9keS5jbGVhbi1tb2RlIGlucHV0LCBib2R5LmNsZWFuLW1vZGUgdGV4dGFyZWEgeyAKICAgICAgICBib3JkZXI6IG5vbmUgIWltcG9ydGFudDsgYmFja2dyb3VuZDogdHJhbnNwYXJlbnQgIWltcG9ydGFudDsgCiAgICAgICAgb3V0bGluZTogbm9uZSAhaW1wb3J0YW50OyBib3gtc2hhZG93OiBub25lICFpbXBvcnRhbnQ7IAogICAgfQoKICAgIC5zZWN0aW9uLWJsb2NrIHsgcGFkZGluZzogMTVweDsgZGlzcGxheTogZmxleDsgZmxleC1kaXJlY3Rpb246IGNvbHVtbjsgYm9yZGVyOiAycHggc29saWQgdmFyKC0tYm9yZGVyLWNvbG9yKTsgbWFyZ2luLWJvdHRvbTogMjBweDsgfQogICAgLnNlY3Rpb24tYmxvY2subm90ZSB7IGhlaWdodDogMTUwcHg7IH0KICAgIC5zZWMtaGVhZGVyIHsgZm9udC1zaXplOiAxOHB4OyBmb250LXdlaWdodDogODAwOyBjb2xvcjogIzFlMjkzYjsgbWFyZ2luLWJvdHRvbTogMTJweDsgcGFkZGluZy1sZWZ0OiAxMnB4OyBib3JkZXItbGVmdDogNXB4IHNvbGlkICM0NzU1Njk7IH0KCiAgICAuZm9vdGVyLWFyZWEgeyBtYXJnaW4tdG9wOiAxMHB4OyB0ZXh0LWFsaWduOiBjZW50ZXI7IH0KICAgIC5jb25maXJtLW1zZyB7IGZvbnQtc2l6ZTogMjBweDsgZm9udC13ZWlnaHQ6IDgwMDsgbWFyZ2luLWJvdHRvbTogMjVweDsgfQogICAgLmRhdGUtaW5wdXQgeyBmb250LXNpemU6IDIwcHg7IGZvbnQtd2VpZ2h0OiA4MDA7IHRleHQtYWxpZ246IGNlbnRlcjsgbWFyZ2luLWJvdHRvbTogMzBweDsgfQoKICAgIC8qIFvsiJjsoJVdIO2ajOyCrOuqhSDrsI8g6reA7KSRIOygleugrCBDU1MgLSDsnJfrtoDrtoQg7Kek66a8IOyZhOuyvSDtlbTqsrAgKi8KICAgIC5yZWNpcGllbnQtcm93IHsKICAgICAgICBtYXJnaW4tdG9wOiA0MHB4OwogICAgICAgIGRpc3BsYXk6IGZsZXg7CiAgICAgICAganVzdGlmeS1jb250ZW50OiBjZW50ZXI7CiAgICAgICAgYWxpZ24taXRlbXM6IGZsZXgtZW5kOyAvKiDsnoXroKXssL3snZgg67CR67OA7J2EIOq4sOykgOycvOuhnCDsoJXroKwgKi8KICAgICAgICBnYXA6IDhweDsKICAgICAgICBmb250LXdlaWdodDogNzAwOwogICAgICAgIC8qIO2WiSDsoITssrQg64aS7J2066W8IOuEieuEie2eiCDso7zslrQg66CI7J207JWE7JuDIO2ZleuztCAqLwogICAgICAgIGhlaWdodDogODBweDsgCiAgICB9CiAgICAKICAgIC5yZWNpcGllbnQtaW5wdXQgewogICAgICAgIHRleHQtYWxpZ246IGNlbnRlcjsgCiAgICAgICAgZm9udC1zaXplOiAyNHB4OyAKICAgICAgICBmb250LXdlaWdodDogODAwOyAKICAgICAgICB3aWR0aDogMzAwcHg7IAogICAgICAgIGJvcmRlci1ib3R0b206IDJweCBzb2xpZCAjMDAwOwogICAgICAgIAogICAgICAgIC8qIFvtlbXsi6wg7IiY7KCVXSDrhpLsnbTrpbwgNjBweOuhnCDtgazqsowg64qY66as6rOgLCDsg4Hri6gg7Yyo65Sp7J2EIOyjvOyWtCDquIDsnpDrpbwg7JWE656Y66GcIOuwgOyWtOuDhCAqLwogICAgICAgIC8qIOydtOugh+qyjCDtlZjrqbQg6riA7J6QIOychOyXkCAxNXB4IOydtOyDgeydmCDruYgg6rO16rCE7J20IOyDneqyqCDsoIjrjIAg7Kek66as7KeAIOyViuydjCAqLwogICAgICAgIGhlaWdodDogNjBweDsgICAgICAgCiAgICAgICAgcGFkZGluZy10b3A6IDIwcHg7ICAKICAgICAgICBwYWRkaW5nLWJvdHRvbTogMDsgIAogICAgICAgIGJveC1zaXppbmc6IGJvcmRlci1ib3g7IC8qIO2MqOuUqeydtCDrhpLsnbTsl5Ag7Y+s7ZWo65CY64+E66GdIOyEpOyglSAqLwogICAgICAgIAogICAgICAgIGxpbmUtaGVpZ2h0OiAxLjQ7ICAgCiAgICAgICAgbWFyZ2luLWJvdHRvbTogM3B4OyAvKiDrr7jshLgg7JyE7LmYIOyhsOyglSAqLwogICAgICAgIGJhY2tncm91bmQ6IHRyYW5zcGFyZW50OwogICAgICAgIGJvcmRlci1yYWRpdXM6IDA7CiAgICB9CiAgICAKICAgIC5yZWNpcGllbnQtc3VmZml4IHsKICAgICAgICB3aWR0aDogNjBweDsgdGV4dC1hbGlnbjogbGVmdDsgZm9udC1zaXplOiAyMHB4OyBmb250LXdlaWdodDogNzAwOwogICAgICAgIGJvcmRlcjogbm9uZTsgYmFja2dyb3VuZDogdHJhbnNwYXJlbnQ7IGN1cnNvcjogdGV4dDsKICAgICAgICBtYXJnaW4tYm90dG9tOiAxMHB4OyAvKiDtmozsgqzrqoUg67CR7KSE6rO8ICfqt4DspJEnIO2FjeyKpO2KuCDrhpLsnbQg66ee7LakICovCiAgICB9CgogICAgLyogPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0KICAgICAgIE1PRFVMRTogU0lHTkFUVVJFIFNZU1RFTQogICAgICAgPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0gKi8KICAgIC5zaWduLWdyaWQgeyAKICAgICAgICBkaXNwbGF5OiBncmlkOyBncmlkLXRlbXBsYXRlLWNvbHVtbnM6IDMzJSAyNyUgNDAlOyAKICAgICAgICBib3JkZXI6IDJweCBzb2xpZCB2YXIoLS1ib3JkZXItY29sb3IpOyBtYXJnaW4tYm90dG9tOiAyMHB4OyAKICAgIH0KICAgIC5zaWduLWNlbGwtdGV4dCB7IAogICAgICAgIGJhY2tncm91bmQ6ICNmOGZhZmM7IGJvcmRlci1yaWdodDogMXB4IHNvbGlkIHZhcigtLWJvcmRlci1jb2xvcik7CiAgICAgICAgZGlzcGxheTogZmxleDsgZmxleC1kaXJlY3Rpb246IGNvbHVtbjsganVzdGlmeS1jb250ZW50OiBjZW50ZXI7IGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgICAgICAgcGFkZGluZzogMTBweDsgZ2FwOiA4cHg7CiAgICB9CiAgICAuc2lnbi1sYWJlbC10ZXh0IHsgZm9udC13ZWlnaHQ6IDgwMDsgZm9udC1zaXplOiAxOHB4OyBjb2xvcjogIzMzNDE1NTsgfQogICAgLnNpZ24taW5wdXQtdGV4dCB7IHRleHQtYWxpZ246IGNlbnRlcjsgZm9udC1zaXplOiAxOHB4OyBmb250LXdlaWdodDogNzAwOyB3aWR0aDogMTAwJTsgYm9yZGVyLWJvdHRvbTogMXB4IGRhc2hlZCAjY2JkNWUxOyB9CgogICAgLnNpZ24tY2VsbC1jYW52YXMgeyAKICAgICAgICBwb3NpdGlvbjogcmVsYXRpdmU7IGJhY2tncm91bmQ6ICNmZmY7IGhlaWdodDogMTgwcHg7IAogICAgICAgIGRpc3BsYXk6IGZsZXg7IGZsZXgtZGlyZWN0aW9uOiBjb2x1bW47IG92ZXJmbG93OiBoaWRkZW47IAogICAgICAgIGN1cnNvcjogcG9pbnRlcjsKICAgIH0KICAgIC5zaWduLWNlbGwtY2FudmFzOmhvdmVyIHsgYmFja2dyb3VuZDogI2YwZjlmZjsgfQogICAgCiAgICAuc2lnbi1sYWJlbC1jYW52YXMgewogICAgICAgIHBhZGRpbmc6IDhweCAxMnB4OyBmb250LXdlaWdodDogNzAwOyBmb250LXNpemU6IDE0cHg7IGNvbG9yOiAjNjQ3NDhiOwogICAgICAgIGJvcmRlci1ib3R0b206IDFweCBkYXNoZWQgI2UyZThmMDsgcG9pbnRlci1ldmVudHM6IG5vbmU7IHRleHQtYWxpZ246IGxlZnQ7CiAgICB9CiAgICAKICAgIC5kaXNwbGF5LWNhbnZhcy13cmFwcGVyIHsKICAgICAgICBmbGV4OiAxOyB3aWR0aDogMTAwJTsgaGVpZ2h0OiAxMDAlOyBwb3NpdGlvbjogcmVsYXRpdmU7CiAgICAgICAgZGlzcGxheTogZmxleDsgYWxpZ24taXRlbXM6IGNlbnRlcjsganVzdGlmeS1jb250ZW50OiBjZW50ZXI7CiAgICB9CiAgICAjcGFwZXJTaWduQ2FudmFzIHsgd2lkdGg6IDEwMCU7IGhlaWdodDogMTAwJTsgcG9pbnRlci1ldmVudHM6IG5vbmU7IGRpc3BsYXk6IGJsb2NrOyB9CiAgICAKICAgIC5jbGljay1ndWlkZSB7CiAgICAgICAgcG9zaXRpb246IGFic29sdXRlOyB0b3A6IDUwJTsgbGVmdDogNTAlOyB0cmFuc2Zvcm06IHRyYW5zbGF0ZSgtNTAlLCAtNTAlKTsKICAgICAgICBjb2xvcjogIzk0YTNiODsgZm9udC13ZWlnaHQ6IDcwMDsgZm9udC1zaXplOiAxNHB4OyBwb2ludGVyLWV2ZW50czogbm9uZTsKICAgICAgICBiYWNrZ3JvdW5kOiByZ2JhKDI1NSwyNTUsMjU1LDAuOCk7IHBhZGRpbmc6IDRweCA4cHg7IGJvcmRlci1yYWRpdXM6IDRweDsKICAgIH0KCiAgICAvKiA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQogICAgICAgTU9EVUxFOiBTSUdOQVRVUkUgTU9EQUwKICAgICAgID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09ICovCiAgICAuc2lnbi1tb2RhbCB7CiAgICAgICAgZGlzcGxheTogbm9uZTsgcG9zaXRpb246IGZpeGVkOyB0b3A6IDA7IGxlZnQ6IDA7IHdpZHRoOiAxMDAlOyBoZWlnaHQ6IDEwMCU7CiAgICAgICAgYmFja2dyb3VuZDogcmdiYSgwLDAsMCwwLjgpOyB6LWluZGV4OiA5OTk5OwogICAgICAgIGZsZXgtZGlyZWN0aW9uOiBjb2x1bW47IGp1c3RpZnktY29udGVudDogY2VudGVyOyBhbGlnbi1pdGVtczogY2VudGVyOwogICAgICAgIGJhY2tkcm9wLWZpbHRlcjogYmx1cig1cHgpOyBvcGFjaXR5OiAwOyB0cmFuc2l0aW9uOiBvcGFjaXR5IDAuM3M7CiAgICB9CiAgICAuc2lnbi1tb2RhbC5vcGVuIHsgZGlzcGxheTogZmxleDsgb3BhY2l0eTogMTsgfQoKICAgIC5tb2RhbC1jb250ZW50IHsKICAgICAgICB3aWR0aDogOTUlOyBtYXgtd2lkdGg6IDYwMHB4OyBoZWlnaHQ6IDgwdmg7IG1heC1oZWlnaHQ6IDgwMHB4OwogICAgICAgIGJhY2tncm91bmQ6ICNmZmY7IGJvcmRlci1yYWRpdXM6IDEycHg7IGRpc3BsYXk6IGZsZXg7IGZsZXgtZGlyZWN0aW9uOiBjb2x1bW47CiAgICAgICAgb3ZlcmZsb3c6IGhpZGRlbjsgYm94LXNoYWRvdzogMCAyMHB4IDUwcHggcmdiYSgwLDAsMCwwLjUpOwogICAgfQogICAgCiAgICAubW9kYWwtaGVhZGVyIHsKICAgICAgICBwYWRkaW5nOiAxMnB4IDE2cHg7IGJhY2tncm91bmQ6ICNmMWY1Zjk7IGJvcmRlci1ib3R0b206IDFweCBzb2xpZCAjZTJlOGYwOwogICAgICAgIGRpc3BsYXk6IGZsZXg7IGp1c3RpZnktY29udGVudDogc3BhY2UtYmV0d2VlbjsgYWxpZ24taXRlbXM6IGNlbnRlcjsKICAgIH0KICAgIC5tb2RhbC10aXRsZSB7IGZvbnQtd2VpZ2h0OiA4MDA7IGZvbnQtc2l6ZTogMTZweDsgY29sb3I6ICMxZTI5M2I7IH0KICAgIC5jbG9zZS1idG4geyBiYWNrZ3JvdW5kOiBub25lOyBib3JkZXI6IG5vbmU7IGN1cnNvcjogcG9pbnRlcjsgY29sb3I6ICM2NDc0OGI7IH0KCiAgICAubW9kYWwtYm9keSB7CiAgICAgICAgZmxleDogMTsgcG9zaXRpb246IHJlbGF0aXZlOyBiYWNrZ3JvdW5kOiAjZmZmOyBvdmVyZmxvdzogaGlkZGVuOyB0b3VjaC1hY3Rpb246IG5vbmU7CiAgICAgICAgYmFja2dyb3VuZC1pbWFnZTogcmFkaWFsLWdyYWRpZW50KCNlMmU4ZjAgMXB4LCB0cmFuc3BhcmVudCAxcHgpOwogICAgICAgIGJhY2tncm91bmQtc2l6ZTogMjBweCAyMHB4OwogICAgfQogICAgCiAgICAjbW9kYWxDYW52YXMgeyB3aWR0aDogMTAwJTsgaGVpZ2h0OiAxMDAlOyB0b3VjaC1hY3Rpb246IG5vbmU7IGRpc3BsYXk6IGJsb2NrOyB9CgogICAgLnNpZ24tdG9vbHMtYmFyIHsKICAgICAgICBwYWRkaW5nOiAxMHB4OyBiYWNrZ3JvdW5kOiAjZmZmOyBib3JkZXItdG9wOiAxcHggc29saWQgI2UyZThmMDsKICAgICAgICBkaXNwbGF5OiBmbGV4OyBnYXA6IDhweDsgb3ZlcmZsb3cteDogYXV0bzsgZmxleC1zaHJpbms6IDA7CiAgICAgICAgYWxpZ24taXRlbXM6IGNlbnRlcjsKICAgIH0KICAgIAogICAgLm1vZGFsLWZvb3RlciB7CiAgICAgICAgcGFkZGluZzogMTJweCAxNnB4OyBiYWNrZ3JvdW5kOiAjZmZmOyBib3JkZXItdG9wOiAxcHggc29saWQgI2UyZThmMDsKICAgICAgICBkaXNwbGF5OiBmbGV4OyBnYXA6IDEwcHg7CiAgICB9CiAgICAKICAgIC51dS1idG4gewogICAgICAgIGZsZXg6IDE7IGhlaWdodDogNDhweDsgYm9yZGVyLXJhZGl1czogMTBweDsgZm9udC1zaXplOiAxNXB4OyBmb250LXdlaWdodDogNzAwOyAKICAgICAgICBkaXNwbGF5OiBmbGV4OyBhbGlnbi1pdGVtczogY2VudGVyOyBqdXN0aWZ5LWNvbnRlbnQ6IGNlbnRlcjsgZ2FwOiA4cHg7IGN1cnNvcjogcG9pbnRlcjsgdHJhbnNpdGlvbjogMC4xczsKICAgICAgICBtaW4td2lkdGg6IGZpdC1jb250ZW50OyBwYWRkaW5nOiAwIDE2cHg7CiAgICB9CiAgICAudXUtYnRuLmRhc2hlZC50eXBlLWdyYXktc2Vjb25kYXJ5LCAudXUtYnRuLnNvbGlkLnR5cGUtZ3JheS1zZWNvbmRhcnkgewogICAgICAgIGJhY2tncm91bmQtY29sb3I6ICNmMWY1Zjk7IGJvcmRlcjogMXB4IHNvbGlkICNjYmQ1ZTE7IGNvbG9yOiAjNDc1NTY5OyBib3JkZXItc3R5bGU6IHNvbGlkICFpbXBvcnRhbnQ7CiAgICB9CiAgICAudXUtYnRuLmRhc2hlZC50eXBlLWdyYXktc2Vjb25kYXJ5OmhvdmVyLCAudXUtYnRuLnNvbGlkLnR5cGUtZ3JheS1zZWNvbmRhcnk6aG92ZXIgeyBiYWNrZ3JvdW5kLWNvbG9yOiAjZTJlOGYwOyB9CiAgICAudXUtYnRuLmRhc2hlZC50eXBlLWJsdWUsIC51dS1idG4uc29saWQudHlwZS1ibHVlIHsKICAgICAgICBiYWNrZ3JvdW5kLWNvbG9yOiB2YXIoLS1oZWFkZXItbmF2eSk7IGJvcmRlcjogbm9uZTsgY29sb3I6ICNmZmZmZmY7IGJvcmRlci1zdHlsZTogc29saWQgIWltcG9ydGFudDsKICAgIH0KCiAgICAubWluaS1idG4gewogICAgICAgIGZvbnQtc2l6ZTogMTJweDsgcGFkZGluZzogNnB4IDEycHg7IGJvcmRlcjogMXB4IHNvbGlkICNjYmQ1ZTE7IAogICAgICAgIGJhY2tncm91bmQ6ICNmZmY7IGJvcmRlci1yYWRpdXM6IDZweDsgY3Vyc29yOiBwb2ludGVyOyBjb2xvcjogIzQ3NTU2OTsgZm9udC13ZWlnaHQ6IDcwMDsKICAgICAgICBkaXNwbGF5OiBmbGV4OyBhbGlnbi1pdGVtczogY2VudGVyOyBnYXA6IDRweDsgd2hpdGUtc3BhY2U6IG5vd3JhcDsKICAgICAgICBoZWlnaHQ6IDQwcHg7IGp1c3RpZnktY29udGVudDogY2VudGVyOwogICAgfQogICAgLm1pbmktYnRuLmFjdGl2ZSB7IGJhY2tncm91bmQ6ICNlZmY2ZmY7IGNvbG9yOiAjMjU2M2ViOyBib3JkZXItY29sb3I6ICMyNTYzZWI7IH0KICAgIAogICAgI21vZGFsRWRpdExheWVyIHsKICAgICAgICBkaXNwbGF5OiBub25lOyBwb3NpdGlvbjogYWJzb2x1dGU7IHRvcDogMDsgbGVmdDogMDsgd2lkdGg6IDEwMCU7IGhlaWdodDogMTAwJTsKICAgICAgICBiYWNrZ3JvdW5kOiByZ2JhKDAsMCwwLDAuOCk7IHotaW5kZXg6IDEwOwogICAgICAgIGZsZXgtZGlyZWN0aW9uOiBjb2x1bW47IGp1c3RpZnktY29udGVudDogY2VudGVyOyBhbGlnbi1pdGVtczogY2VudGVyOwogICAgfQogICAgI21vZGFsRWRpdENvbnRhaW5lciB7CiAgICAgICAgcG9zaXRpb246IHJlbGF0aXZlOyB3aWR0aDogMTAwJTsgaGVpZ2h0OiAxMDAlOyBib3JkZXI6IDJweCBkYXNoZWQgIzMxYTNmYTsgb3ZlcmZsb3c6IGhpZGRlbjsKICAgIH0KICAgICNtb2RhbEVkaXRpbmdJbWFnZSB7CiAgICAgICAgcG9zaXRpb246IGFic29sdXRlOyB0b3A6IDUwJTsgbGVmdDogNTAlOyB0cmFuc2Zvcm06IHRyYW5zbGF0ZSgtNTAlLCAtNTAlKTsgCiAgICAgICAgY3Vyc29yOiBncmFiOyB0b3VjaC1hY3Rpb246IG5vbmU7IG1heC13aWR0aDogbm9uZTsKICAgIH0KICAgIC5tb2RhbC1lZGl0LWNvbnRyb2xzIHsKICAgICAgICBwb3NpdGlvbjogYWJzb2x1dGU7IGJvdHRvbTogMjBweDsgbGVmdDogNTAlOyB0cmFuc2Zvcm06IHRyYW5zbGF0ZVgoLTUwJSk7CiAgICAgICAgYmFja2dyb3VuZDogIzIyMjsgYm9yZGVyLXJhZGl1czogMzBweDsgcGFkZGluZzogMTBweCAyMHB4OwogICAgICAgIGRpc3BsYXk6IGZsZXg7IGdhcDogMTVweDsgYWxpZ24taXRlbXM6IGNlbnRlcjsgd2lkdGg6IDkwJTsgbWF4LXdpZHRoOiA0MDBweDsKICAgIH0KCiAgICAvKiA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQogICAgICAgTU9EVUxFOiBDT05UUk9MUwogICAgICAgPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0gKi8KICAgIC5jb250cm9scy1waWxsIHsKICAgICAgICBwb3NpdGlvbjogZml4ZWQ7IGJvdHRvbTogMzBweDsgbGVmdDogNTAlOyB0cmFuc2Zvcm06IHRyYW5zbGF0ZVgoLTUwJSk7CiAgICAgICAgYmFja2dyb3VuZDogIzIyMjsgcGFkZGluZzogMTBweCAyNXB4OyBib3JkZXItcmFkaXVzOiA1MHB4OwogICAgICAgIGRpc3BsYXk6IGZsZXg7IGdhcDogMjVweDsgei1pbmRleDogMjAwOyBiYWNrZHJvcC1maWx0ZXI6IGJsdXIoOHB4KTsKICAgICAgICBib3gtc2hhZG93OiAwIDEwcHggMzBweCByZ2JhKDAsMCwwLDAuNSk7IGJvcmRlcjogMXB4IHNvbGlkICMzMzM7CiAgICB9CiAgICAuY3RybC1idG4gewogICAgICAgIGJhY2tncm91bmQ6IG5vbmU7IGJvcmRlcjogbm9uZTsgY29sb3I6ICNmZmY7CiAgICAgICAgZGlzcGxheTogZmxleDsgZmxleC1kaXJlY3Rpb246IGNvbHVtbjsgYWxpZ24taXRlbXM6IGNlbnRlcjsgZ2FwOiA0cHg7CiAgICAgICAgZm9udC1zaXplOiAxMHB4OyBjdXJzb3I6IHBvaW50ZXI7IG1pbi13aWR0aDogMzVweDsgb3BhY2l0eTogMC43OyB0cmFuc2l0aW9uOiAwLjJzOwogICAgfQogICAgLmN0cmwtYnRuLmFjdGl2ZSB7IGNvbG9yOiAjMzFhM2ZhOyBvcGFjaXR5OiAxOyBmb250LXdlaWdodDogNzAwOyB9CgogICAgLnRvYXN0IHsKICAgICAgICBwb3NpdGlvbjogZml4ZWQ7IHRvcDogODBweDsgbGVmdDogNTAlOyB0cmFuc2Zvcm06IHRyYW5zbGF0ZVgoLTUwJSk7CiAgICAgICAgYmFja2dyb3VuZDogcmdiYSgzMCwgNDEsIDU5LCAwLjk1KTsgY29sb3I6ICNmZmY7IHBhZGRpbmc6IDEycHggMjRweDsKICAgICAgICBib3JkZXItcmFkaXVzOiA1MHB4OyBvcGFjaXR5OiAwOyB0cmFuc2l0aW9uOiAwLjNzOyBwb2ludGVyLWV2ZW50czogbm9uZTsgei1pbmRleDogOTk5OTk7CiAgICAgICAgZGlzcGxheTogZmxleDsgYWxpZ24taXRlbXM6IGNlbnRlcjsgZ2FwOiA4cHg7IGZvbnQtd2VpZ2h0OiA2MDA7IGZvbnQtc2l6ZTogMTRweDsKICAgIH0KICAgIC50b2FzdC5zaG93IHsgb3BhY2l0eTogMTsgdG9wOiA5MHB4OyB9CiAgICAKICAgICNzaWduSW1hZ2VJbnB1dCB7IGRpc3BsYXk6IG5vbmU7IH0KICA8L3N0eWxlPgo8L2hlYWQ+Cjxib2R5PgoKICA8aGVhZGVyIGNsYXNzPSJoZWFkZXItYmFyIj4KICAgIDxidXR0b24gY2xhc3M9Imljb24tYnRuIiBpZD0iYnRuQmFjayI+PGkgZGF0YS1sdWNpZGU9ImNoZXZyb24tbGVmdCIgd2lkdGg9IjI4Ij48L2k+PC9idXR0b24+CiAgICA8ZGl2IGNsYXNzPSJoZWFkZXItdGl0bGUiPuyekeyXheyZhOujjO2ZleyduOyEnDwvZGl2PgogICAgPGRpdiBjbGFzcz0iaGVhZGVyLXJpZ2h0Ij4KICAgICAgICA8YnV0dG9uIGNsYXNzPSJpY29uLWJ0biIgaWQ9ImJ0blJlc2V0Ij48aSBkYXRhLWx1Y2lkZT0icm90YXRlLWNjdyI+PC9pPjwvYnV0dG9uPgogICAgICAgIDxidXR0b24gY2xhc3M9Imljb24tYnRuIiBpZD0iYnRuRG93bmxvYWQiPjxpIGRhdGEtbHVjaWRlPSJkb3dubG9hZCI+PC9pPjwvYnV0dG9uPgogICAgPC9kaXY+CiAgPC9oZWFkZXI+CgogIDxkaXYgY2xhc3M9InZpZXdwb3J0IiBpZD0idmlld3BvcnQiPgogICAgPGRpdiBjbGFzcz0icGFwZXItd3JhcHBlciIgaWQ9InBhcGVyV3JhcHBlciI+CiAgICAgIDxkaXYgY2xhc3M9ImE0LXBhcGVyIiBpZD0iZG9jdW1lbnRBcmVhIj4KICAgICAgICA8aGVhZGVyIGNsYXNzPSJkb2MtaGVhZGVyIj48aDEgY2xhc3M9ImRvYy10aXRsZSI+7J6RIOyXhSDsmYQg66OMIO2ZlSDsnbgg7IScPC9oMT48L2hlYWRlcj4KCiAgICAgICAgPHRhYmxlIGNsYXNzPSJpbmZvLXRhYmxlIj4KICAgICAgICAgICAgPGNvbGdyb3VwPgogICAgICAgICAgICAgICAgPGNvbCBzdHlsZT0id2lkdGg6IDEyJTsiPgogICAgICAgICAgICAgICAgPGNvbCBzdHlsZT0id2lkdGg6IDQ4JTsiPgogICAgICAgICAgICAgICAgPGNvbCBzdHlsZT0id2lkdGg6IDEwJTsiPgogICAgICAgICAgICAgICAgPGNvbCBzdHlsZT0id2lkdGg6IDMwJTsiPgogICAgICAgICAgICA8L2NvbGdyb3VwPgogICAgICAgICAgICAKICAgICAgICAgICAgPHRyPgogICAgICAgICAgICAgICAgPHRoPu2YhCDsnqUg66qFPC90aD4KICAgICAgICAgICAgICAgIDx0ZD48dGV4dGFyZWEgY2xhc3M9InRhYmxlLWlucHV0IiByb3dzPSIxIiBwbGFjZWhvbGRlcj0i64K07JqpIOyeheugpSI+7J6Q7J20IOyVhO2MjO2KuCAxMDHrj5k8L3RleHRhcmVhPjwvdGQ+CiAgICAgICAgICAgICAgICA8dGg+7JeFIOyytDwvdGg+CiAgICAgICAgICAgICAgICA8dGQ+PHRleHRhcmVhIGNsYXNzPSJ0YWJsZS1pbnB1dCIgcm93cz0iMSIgcGxhY2Vob2xkZXI9IuyXheyytOuqhSDsnoXroKUiPjwvdGV4dGFyZWE+PC90ZD4KICAgICAgICAgICAgPC90cj4KICAgICAgICAgICAgPHRyPgogICAgICAgICAgICAgICAgPHRoPuqztSDsgqwg66qFPC90aD4KICAgICAgICAgICAgICAgIDx0ZD48dGV4dGFyZWEgY2xhc3M9InRhYmxlLWlucHV0IiByb3dzPSIxIiBwbGFjZWhvbGRlcj0i6rO17IKs66qFIOyeheugpSI+PC90ZXh0YXJlYT48L3RkPgogICAgICAgICAgICAgICAgPHRoPuqzteyCrOq4sOqwhDwvdGg+CiAgICAgICAgICAgICAgICA8dGQ+PHRleHRhcmVhIGNsYXNzPSJ0YWJsZS1pbnB1dCIgcm93cz0iMSIgcGxhY2Vob2xkZXI9Iuq4sOqwhCDsnoXroKUiPjwvdGV4dGFyZWE+PC90ZD4KICAgICAgICAgICAgPC90cj4KICAgICAgICAgICAgPC90YWJsZT4KCiAgICAgICAgPGRpdiBjbGFzcz0ic2VjdGlvbi1ibG9jayI+CiAgICAgICAgICAgIDxkaXYgY2xhc3M9InNlYy1oZWFkZXIiPuyekeyXheuCtOyaqTwvZGl2PgogICAgICAgICAgICA8dGV4dGFyZWEgc3R5bGU9ImZsZXg6MTsgbGluZS1oZWlnaHQ6MS42OyIgcGxhY2Vob2xkZXI9IuyDgeyEuCDrgrTsmqkiPiog7KeA7ZWY7KO87LCo7J6lIFBD67aA7J6sIOq3oOyXtOuztOyImCDsmYTro4wKKiA8L3RleHRhcmVhPgogICAgICAgIDwvZGl2PgoKICAgICAgICA8ZGl2IGNsYXNzPSJzZWN0aW9uLWJsb2NrIG5vdGUiPgogICAgICAgICAgICA8ZGl2IGNsYXNzPSJzZWMtaGVhZGVyIj7tirnquLDsgqztla08L2Rpdj4KICAgICAgICAgICAgPHRleHRhcmVhIHN0eWxlPSJmbGV4OjE7IiBwbGFjZWhvbGRlcj0i7Yq57J207IKs7ZWtIj48L3RleHRhcmVhPgogICAgICAgIDwvZGl2PgoKICAgICAgICA8ZGl2IGNsYXNzPSJmb290ZXItYXJlYSI+CiAgICAgICAgICAgIDxkaXYgY2xhc3M9ImNvbmZpcm0tbXNnIj7sg4HquLAg7IKs7ZWt6rO8IOqwmeydtCDsnpHsl4XsnYQg7JmE66OM7ZWY7JiA7J2M7J2EIO2ZleyduO2VqeuLiOuLpC48L2Rpdj4KICAgICAgICAgICAgPGlucHV0IHR5cGU9InRleHQiIGlkPSJkYXRlRmllbGQiIGNsYXNzPSJkYXRlLWlucHV0IiB2YWx1ZT0iIiBzdHlsZT0iY3Vyc29yOiBwb2ludGVyOyIgcmVhZG9ubHkgb25mb2N1cz0idGhpcy5yZW1vdmVBdHRyaWJ1dGUoJ3JlYWRvbmx5Jyk7IiBvbmJsdXI9ImlmKHRoaXMudmFsdWUudHJpbSgpID09PSAnJykgeyBjb25zdCBkID0gbmV3IERhdGUoKTsgdGhpcy52YWx1ZSA9IGAke2QuZ2V0RnVsbFllYXIoKX3rhYQgJHtkLmdldE1vbnRoKCkrMX3sm5QgJHtkLmdldERhdGUoKX3snbxgOyB9IHRoaXMuc2V0QXR0cmlidXRlKCdyZWFkb25seScsICdyZWFkb25seScpOyI+CgogICAgICAgICAgICA8ZGl2IGNsYXNzPSJzaWduLWdyaWQiPgogICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0ic2lnbi1jZWxsLXRleHQiPgogICAgICAgICAgICAgICAgICAgIDxzcGFuIGNsYXNzPSJzaWduLWxhYmVsLXRleHQiPuyGjCDsho0gOjwvc3Bhbj4KICAgICAgICAgICAgICAgICAgICA8aW5wdXQgdHlwZT0idGV4dCIgY2xhc3M9InNpZ24taW5wdXQtdGV4dCIgdmFsdWU9Iijso7wp7J2064W47ZS87JWk7JSoIiBwbGFjZWhvbGRlcj0i7IaM7IaNIOyeheugpSI+CiAgICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9InNpZ24tY2VsbC10ZXh0Ij4KICAgICAgICAgICAgICAgICAgICA8c3BhbiBjbGFzcz0ic2lnbi1sYWJlbC10ZXh0Ij7shLEg66qFIDo8L3NwYW4+CiAgICAgICAgICAgICAgICAgICAgPGlucHV0IHR5cGU9InRleHQiIGNsYXNzPSJzaWduLWlucHV0LXRleHQiIHBsYWNlaG9sZGVyPSLsnbTrpoQg7J6F66ClIj4KICAgICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJzaWduLWNlbGwtY2FudmFzIiBpZD0idHJpZ2dlclNpZ25Nb2RhbCI+CiAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0ic2lnbi1sYWJlbC1jYW52YXMiPu2ZleyduOyekCAo7ISc66qFKTwvZGl2PgogICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9ImRpc3BsYXktY2FudmFzLXdyYXBwZXIiPgogICAgICAgICAgICAgICAgICAgICAgICA8Y2FudmFzIGlkPSJwYXBlclNpZ25DYW52YXMiPjwvY2FudmFzPgogICAgICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJjbGljay1ndWlkZSIgaWQ9ImNsaWNrR3VpZGVUZXh0Ij7shJzrqoXtlZjroKTrqbQg7YSw7LmYPC9kaXY+CiAgICAgICAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgIAogICAgICAgICAgICA8ZGl2IGNsYXNzPSJyZWNpcGllbnQtcm93Ij4KICAgICAgICAgICAgICAgIDxpbnB1dCB0eXBlPSJ0ZXh0IiBjbGFzcz0icmVjaXBpZW50LWlucHV0IiBwbGFjZWhvbGRlcj0i7ZqM7IKs66qFIj4gCiAgICAgICAgICAgICAgICA8aW5wdXQgdHlwZT0idGV4dCIgY2xhc3M9InJlY2lwaWVudC1zdWZmaXgiIHZhbHVlPSLqt4DspJEiIHBsYWNlaG9sZGVyPSIiPgogICAgICAgICAgICA8L2Rpdj4KICAgICAgICA8L2Rpdj4KICAgICAgPC9kaXY+IAogICAgPC9kaXY+CiAgPC9kaXY+CgogIDxkaXYgY2xhc3M9ImNvbnRyb2xzLXBpbGwiPgogICAgPGJ1dHRvbiBjbGFzcz0iY3RybC1idG4iIGlkPSJidG5ab29tT3V0Ij48aSBkYXRhLWx1Y2lkZT0ibWludXMiPjwvaT7stpXshow8L2J1dHRvbj4KICAgIDxidXR0b24gY2xhc3M9ImN0cmwtYnRuIiBpZD0iYnRuUGFuVG9nZ2xlIj48aSBkYXRhLWx1Y2lkZT0iaGFuZCI+PC9pPuydtOuPmTwvYnV0dG9uPgogICAgPGJ1dHRvbiBjbGFzcz0iY3RybC1idG4iIGlkPSJidG5ab29tSW4iPjxpIGRhdGEtbHVjaWRlPSJwbHVzIj48L2k+7ZmV64yAPC9idXR0b24+CiAgICA8YnV0dG9uIGNsYXNzPSJjdHJsLWJ0biIgaWQ9ImJ0blNoYXJlIj48aSBkYXRhLWx1Y2lkZT0ic2hhcmUtMiI+PC9pPuqzteycoDwvYnV0dG9uPgogIDwvZGl2PgoKICA8ZGl2IGNsYXNzPSJ0b2FzdCIgaWQ9InRvYXN0Ij48aSBkYXRhLWx1Y2lkZT0iY2hlY2siIHNpemU9IjE4Ij48L2k+IDxzcGFuIGlkPSJ0b2FzdE1zZyI+7JmE66OMPC9zcGFuPjwvZGl2PgoKICA8ZGl2IGNsYXNzPSJzaWduLW1vZGFsIiBpZD0ic2lnbk1vZGFsIj4KICAgICAgPGRpdiBjbGFzcz0ibW9kYWwtY29udGVudCI+CiAgICAgICAgICA8ZGl2IGNsYXNzPSJtb2RhbC1oZWFkZXIiPgogICAgICAgICAgICAgIDxzcGFuIGNsYXNzPSJtb2RhbC10aXRsZSI+7ISc66qFIOuYkOuKlCDrj4TsnqUg7J6F66ClPC9zcGFuPgogICAgICAgICAgICAgIDxidXR0b24gY2xhc3M9ImNsb3NlLWJ0biIgaWQ9ImJ0bkNsb3NlTW9kYWxYIj48aSBkYXRhLWx1Y2lkZT0ieCI+PC9pPjwvYnV0dG9uPgogICAgICAgICAgPC9kaXY+CiAgICAgICAgICA8ZGl2IGNsYXNzPSJtb2RhbC1ib2R5Ij4KICAgICAgICAgICAgICA8Y2FudmFzIGlkPSJtb2RhbENhbnZhcyI+PC9jYW52YXM+CiAgICAgICAgICAgICAgPGRpdiBpZD0ibW9kYWxFZGl0TGF5ZXIiPgogICAgICAgICAgICAgICAgICA8ZGl2IGlkPSJtb2RhbEVkaXRDb250YWluZXIiPgogICAgICAgICAgICAgICAgICAgICAgPGltZyBpZD0ibW9kYWxFZGl0aW5nSW1hZ2UiIHNyYz0iIiBhbHQ9IlN0YW1wIiBkcmFnZ2FibGU9ImZhbHNlIj4KICAgICAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9Im1vZGFsLWVkaXQtY29udHJvbHMiPgogICAgICAgICAgICAgICAgICAgICAgPHNwYW4gc3R5bGU9ImNvbG9yOiNmZmY7IGZvbnQtc2l6ZToxMnB4OyB3aGl0ZS1zcGFjZTpub3dyYXA7Ij7tgazquLA8L3NwYW4+CiAgICAgICAgICAgICAgICAgICAgICA8aW5wdXQgdHlwZT0icmFuZ2UiIGlkPSJtb2RhbFNjYWxlU2xpZGVyIiBtaW49IjAuMSIgbWF4PSIyLjAiIHN0ZXA9IjAuMDUiIHZhbHVlPSIwLjUiIHN0eWxlPSJmbGV4OjE7Ij4KICAgICAgICAgICAgICAgICAgICAgIDxidXR0b24gY2xhc3M9Im1pbmktYnRuIiBpZD0iYnRuRWRpdENhbmNlbCI+7Leo7IaMPC9idXR0b24+CiAgICAgICAgICAgICAgICAgICAgICA8YnV0dG9uIGNsYXNzPSJtaW5pLWJ0biBhY3RpdmUiIGlkPSJidG5FZGl0QXBwbHkiPuyggeyaqTwvYnV0dG9uPgogICAgICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgIDwvZGl2PgogICAgICAgICAgPGRpdiBjbGFzcz0ic2lnbi10b29scy1iYXIiIGlkPSJzaWduVG9vbHNCYXIiPgogICAgICAgICAgICAgIDxidXR0b24gY2xhc3M9Im1pbmktYnRuIGFjdGl2ZSIgaWQ9ImJ0blBlbiIgc3R5bGU9Im1hcmdpbi1yaWdodDo0cHg7Ij48aSBkYXRhLWx1Y2lkZT0icGVuLXRvb2wiIHdpZHRoPSIxNCI+PC9pPiDtjpw8L2J1dHRvbj4KICAgICAgICAgICAgICA8YnV0dG9uIGNsYXNzPSJtaW5pLWJ0biIgaWQ9ImJ0bkVyYXNlciIgc3R5bGU9Im1hcmdpbi1yaWdodDoxMHB4OyI+PGkgZGF0YS1sdWNpZGU9ImVyYXNlciIgd2lkdGg9IjE0Ij48L2k+IOyngOyasOqwnDwvYnV0dG9uPgogICAgICAgICAgICAgIDxidXR0b24gY2xhc3M9InV1LWJ0biBkYXNoZWQgdHlwZS1ncmF5LXNlY29uZGFyeSIgaWQ9ImJ0bkltcG9ydCIgc3R5bGU9ImhlaWdodDo0MHB4OyBmb250LXNpemU6MTNweDsgcGFkZGluZzowIDEycHg7IG1hcmdpbi1yaWdodDo0cHg7Ij4KICAgICAgICAgICAgICAgICAgPGkgZGF0YS1sdWNpZGU9ImltYWdlLXBsdXMiIHdpZHRoPSIxNiI+PC9pPiDrj4TsnqUv7IKs7KeECiAgICAgICAgICAgICAgPC9idXR0b24+CiAgICAgICAgICAgICAgPGJ1dHRvbiBjbGFzcz0ibWluaS1idG4iIGlkPSJidG5VbmRvIj48aSBkYXRhLWx1Y2lkZT0idW5kby0yIiB3aWR0aD0iMTQiPjwvaT48L2J1dHRvbj4KICAgICAgICAgICAgICA8YnV0dG9uIGNsYXNzPSJtaW5pLWJ0biIgaWQ9ImJ0bkNsZWFyIj48aSBkYXRhLWx1Y2lkZT0idHJhc2gtMiIgd2lkdGg9IjE0Ij48L2k+PC9idXR0b24+CiAgICAgICAgICAgICAgPGlucHV0IHR5cGU9ImZpbGUiIGlkPSJzaWduSW1hZ2VJbnB1dCIgYWNjZXB0PSJpbWFnZS8qIj4KICAgICAgICAgIDwvZGl2PgogICAgICAgICAgPGRpdiBjbGFzcz0ibW9kYWwtZm9vdGVyIj4KICAgICAgICAgICAgICA8YnV0dG9uIGNsYXNzPSJ1dS1idG4gZGFzaGVkIHR5cGUtZ3JheS1zZWNvbmRhcnkiIGlkPSJidG5DYW5jZWxNb2RhbCI+7Leo7IaMPC9idXR0b24+CiAgICAgICAgICAgICAgPGJ1dHRvbiBjbGFzcz0idXUtYnRuIHNvbGlkIHR5cGUtYmx1ZSIgaWQ9ImJ0bkNvbmZpcm1Nb2RhbCI+7ISc66qFIOyZhOujjDwvYnV0dG9uPgogICAgICAgICAgPC9kaXY+CiAgICAgIDwvZGl2PgogIDwvZGl2PgoKPHNjcmlwdD4KICAgIC8qIFVJIOycoO2LuOumrO2LsCAqLwogICAgY2xhc3MgVWlVdGlscyB7CiAgICAgICAgY29uc3RydWN0b3IoKSB7CiAgICAgICAgICAgIHRoaXMudG9hc3RFbCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCd0b2FzdCcpOwogICAgICAgICAgICB0aGlzLnRvYXN0TXNnRWwgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgndG9hc3RNc2cnKTsKICAgICAgICAgICAgdGhpcy50aW1lciA9IG51bGw7CiAgICAgICAgfQogICAgICAgIHNob3dUb2FzdChtc2cpIHsKICAgICAgICAgICAgdGhpcy50b2FzdE1zZ0VsLmlubmVyVGV4dCA9IG1zZzsKICAgICAgICAgICAgdGhpcy50b2FzdEVsLmNsYXNzTGlzdC5hZGQoJ3Nob3cnKTsKICAgICAgICAgICAgY2xlYXJUaW1lb3V0KHRoaXMudGltZXIpOwogICAgICAgICAgICB0aGlzLnRpbWVyID0gc2V0VGltZW91dCgoKSA9PiB0aGlzLnRvYXN0RWwuY2xhc3NMaXN0LnJlbW92ZSgnc2hvdycpLCAyMDAwKTsKICAgICAgICB9CiAgICB9CgogICAgLyog67ew7Ja0IOunpOuLiOyggCAqLwogICAgY2xhc3MgVmlld2VyTWFuYWdlciB7CiAgICAgICAgY29uc3RydWN0b3IodWlVdGlscykgewogICAgICAgICAgICB0aGlzLnVpID0gdWlVdGlsczsKICAgICAgICAgICAgdGhpcy52aWV3cG9ydCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCd2aWV3cG9ydCcpOwogICAgICAgICAgICB0aGlzLnBhcGVyV3JhcHBlciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdwYXBlcldyYXBwZXInKTsKICAgICAgICAgICAgdGhpcy5idG5QYW4gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnYnRuUGFuVG9nZ2xlJyk7CiAgICAgICAgICAgIHRoaXMuem9vbUxldmVsID0gMS4wOwogICAgICAgICAgICB0aGlzLmlzUGFubmluZyA9IGZhbHNlOyAKICAgICAgICAgICAgdGhpcy5zdGFydFggPSAwOyB0aGlzLnN0YXJ0WSA9IDA7CiAgICAgICAgICAgIHRoaXMucG9pbnRYID0gMDsgdGhpcy5wb2ludFkgPSAwOwogICAgICAgICAgICB0aGlzLmJpbmRFdmVudHMoKTsKICAgICAgICB9CiAgICAgICAgYmluZEV2ZW50cygpIHsKICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2J0blpvb21JbicpLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKCkgPT4gdGhpcy5hZGp1c3Rab29tKDAuMSkpOwogICAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnYnRuWm9vbU91dCcpLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKCkgPT4gdGhpcy5hZGp1c3Rab29tKC0wLjEpKTsKICAgICAgICAgICAgdGhpcy5idG5QYW4uYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoKSA9PiB0aGlzLnRvZ2dsZVBhbigpKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGNvbnN0IHN0YXJ0UGFuID0gKGUpID0+IHsKICAgICAgICAgICAgICAgIGlmKCF0aGlzLmlzUGFubmluZykgcmV0dXJuOwogICAgICAgICAgICAgICAgaWYoWydJTlBVVCcsJ1RFWFRBUkVBJywnQlVUVE9OJ10uaW5jbHVkZXMoZS50YXJnZXQudGFnTmFtZSkpIHJldHVybjsKICAgICAgICAgICAgICAgIGlmIChlLnRhcmdldC5pZCA9PT0gJ3BhcGVyU2lnbkNhbnZhcycgfHwgKGUudGFyZ2V0LmNsb3Nlc3QgJiYgZS50YXJnZXQuY2xvc2VzdCgnLnNpZ24tY2VsbC1jYW52YXMnKSkpIHJldHVybjsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgICAgICAgY29uc3QgY3ggPSBlLnRvdWNoZXMgPyBlLnRvdWNoZXNbMF0uY2xpZW50WCA6IGUuY2xpZW50WDsKICAgICAgICAgICAgICAgIGNvbnN0IGN5ID0gZS50b3VjaGVzID8gZS50b3VjaGVzWzBdLmNsaWVudFkgOiBlLmNsaWVudFk7CiAgICAgICAgICAgICAgICB0aGlzLnN0YXJ0WCA9IGN4IC0gdGhpcy5wb2ludFg7CiAgICAgICAgICAgICAgICB0aGlzLnN0YXJ0WSA9IGN5IC0gdGhpcy5wb2ludFk7CgogICAgICAgICAgICAgICAgY29uc3QgbW92ZUhhbmRsZXIgPSAoZXYpID0+IHsKICAgICAgICAgICAgICAgICAgICBldi5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IG14ID0gZXYudG91Y2hlcyA/IGV2LnRvdWNoZXNbMF0uY2xpZW50WCA6IGV2LmNsaWVudFg7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgbXkgPSBldi50b3VjaGVzID8gZXYudG91Y2hlc1swXS5jbGllbnRZIDogZXYuY2xpZW50WTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnBvaW50WCA9IG14IC0gdGhpcy5zdGFydFg7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5wb2ludFkgPSBteSAtIHRoaXMuc3RhcnRZOwogICAgICAgICAgICAgICAgICAgIHRoaXMudXBkYXRlVHJhbnNmb3JtKCk7CiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgY29uc3QgdXBIYW5kbGVyID0gKCkgPT4gewogICAgICAgICAgICAgICAgICAgIGRvY3VtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ21vdXNlbW92ZScsIG1vdmVIYW5kbGVyKTsKICAgICAgICAgICAgICAgICAgICBkb2N1bWVudC5yZW1vdmVFdmVudExpc3RlbmVyKCdtb3VzZXVwJywgdXBIYW5kbGVyKTsKICAgICAgICAgICAgICAgICAgICBkb2N1bWVudC5yZW1vdmVFdmVudExpc3RlbmVyKCd0b3VjaG1vdmUnLCBtb3ZlSGFuZGxlcik7CiAgICAgICAgICAgICAgICAgICAgZG9jdW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcigndG91Y2hlbmQnLCB1cEhhbmRsZXIpOwogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNlbW92ZScsIG1vdmVIYW5kbGVyKTsKICAgICAgICAgICAgICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNldXAnLCB1cEhhbmRsZXIpOwogICAgICAgICAgICAgICAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigndG91Y2htb3ZlJywgbW92ZUhhbmRsZXIsIHtwYXNzaXZlOiBmYWxzZX0pOwogICAgICAgICAgICAgICAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigndG91Y2hlbmQnLCB1cEhhbmRsZXIpOwogICAgICAgICAgICB9OwoKICAgICAgICAgICAgdGhpcy52aWV3cG9ydC5hZGRFdmVudExpc3RlbmVyKCdtb3VzZWRvd24nLCBzdGFydFBhbik7CiAgICAgICAgICAgIHRoaXMudmlld3BvcnQuYWRkRXZlbnRMaXN0ZW5lcigndG91Y2hzdGFydCcsIHN0YXJ0UGFuLCB7cGFzc2l2ZTpmYWxzZX0pOwoKICAgICAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ3Jlc2l6ZScsICgpID0+IHsKICAgICAgICAgICAgICAgIGNsZWFyVGltZW91dCh0aGlzLnJlc2l6ZVRpbWVyKTsKICAgICAgICAgICAgICAgIHRoaXMucmVzaXplVGltZXIgPSBzZXRUaW1lb3V0KCgpID0+IHRoaXMuZml0VG9XaWR0aCgpLCAyMDApOwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB0aGlzLmZpdFRvV2lkdGgoKSwgMTAwKTsKICAgICAgICB9CiAgICAgICAgZml0VG9XaWR0aCgpIHsKICAgICAgICAgICAgY29uc3Qgdmlld3BvcnRXID0gdGhpcy52aWV3cG9ydC5jbGllbnRXaWR0aDsKICAgICAgICAgICAgY29uc3QgY29udGVudFcgPSA4NTQ7IAogICAgICAgICAgICBsZXQgc2NhbGUgPSB2aWV3cG9ydFcgLyBjb250ZW50VzsKICAgICAgICAgICAgaWYoc2NhbGUgPiAxLjEpIHNjYWxlID0gMS4wOyAKICAgICAgICAgICAgdGhpcy56b29tTGV2ZWwgPSBzY2FsZTsKICAgICAgICAgICAgdGhpcy5wb2ludFggPSAwOwogICAgICAgICAgICB0aGlzLnBvaW50WSA9IDA7CiAgICAgICAgICAgIHRoaXMudXBkYXRlVHJhbnNmb3JtKCk7CiAgICAgICAgfQogICAgICAgIGFkanVzdFpvb20oZGVsdGEpIHsKICAgICAgICAgICAgdGhpcy56b29tTGV2ZWwgPSBNYXRoLm1heCgwLjMsIHRoaXMuem9vbUxldmVsICsgZGVsdGEpOwogICAgICAgICAgICB0aGlzLnVwZGF0ZVRyYW5zZm9ybSgpOwogICAgICAgIH0KICAgICAgICB0b2dnbGVQYW4oKSB7CiAgICAgICAgICAgIHRoaXMuaXNQYW5uaW5nID0gIXRoaXMuaXNQYW5uaW5nOwogICAgICAgICAgICB0aGlzLmJ0blBhbi5jbGFzc0xpc3QudG9nZ2xlKCdhY3RpdmUnLCB0aGlzLmlzUGFubmluZyk7CiAgICAgICAgICAgIHRoaXMudmlld3BvcnQuY2xhc3NMaXN0LnRvZ2dsZSgncGFubmluZycsIHRoaXMuaXNQYW5uaW5nKTsKICAgICAgICAgICAgdGhpcy51aS5zaG93VG9hc3QodGhpcy5pc1Bhbm5pbmcgPyAi7J2064+ZIOuqqOuTnCIgOiAi7J6F66ClIOuqqOuTnCIpOwogICAgICAgIH0KICAgICAgICB1cGRhdGVUcmFuc2Zvcm0oKSB7CiAgICAgICAgICAgIHRoaXMucGFwZXJXcmFwcGVyLnN0eWxlLnRyYW5zZm9ybSA9IGB0cmFuc2xhdGUoJHt0aGlzLnBvaW50WH1weCwgJHt0aGlzLnBvaW50WX1weCkgc2NhbGUoJHt0aGlzLnpvb21MZXZlbH0pYDsKICAgICAgICB9CiAgICB9CgogICAgLyog7ISc66qFIOunpOuLiOyggCAqLwogICAgY2xhc3MgU2lnbmF0dXJlTWFuYWdlciB7CiAgICAgICAgY29uc3RydWN0b3IodWlVdGlscywgdmlld2VyTWFuYWdlcikgewogICAgICAgICAgICB0aGlzLnVpID0gdWlVdGlsczsKICAgICAgICAgICAgdGhpcy52aWV3ZXIgPSB2aWV3ZXJNYW5hZ2VyOyAKICAgICAgICAgICAgCiAgICAgICAgICAgIHRoaXMudHJpZ2dlckJ0biA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCd0cmlnZ2VyU2lnbk1vZGFsJyk7CiAgICAgICAgICAgIHRoaXMucGFwZXJDYW52YXMgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncGFwZXJTaWduQ2FudmFzJyk7CiAgICAgICAgICAgIHRoaXMuZ3VpZGVUZXh0ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2NsaWNrR3VpZGVUZXh0Jyk7CiAgICAgICAgICAgIAogICAgICAgICAgICB0aGlzLm1vZGFsID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3NpZ25Nb2RhbCcpOwogICAgICAgICAgICB0aGlzLm1vZGFsQ2FudmFzID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ21vZGFsQ2FudmFzJyk7CiAgICAgICAgICAgIHRoaXMuZmlsZUlucHV0ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3NpZ25JbWFnZUlucHV0Jyk7CiAgICAgICAgICAgIAogICAgICAgICAgICB0aGlzLmVkaXRMYXllciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdtb2RhbEVkaXRMYXllcicpOwogICAgICAgICAgICB0aGlzLmVkaXRJbWcgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnbW9kYWxFZGl0aW5nSW1hZ2UnKTsKICAgICAgICAgICAgdGhpcy5lZGl0Q29udGFpbmVyID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ21vZGFsRWRpdENvbnRhaW5lcicpOwogICAgICAgICAgICB0aGlzLnNjYWxlU2xpZGVyID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ21vZGFsU2NhbGVTbGlkZXInKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIHRoaXMuYmFja2dyb3VuZEltYWdlcyA9IFtdOyAKICAgICAgICAgICAgdGhpcy5wYWQgPSBudWxsOwogICAgICAgICAgICB0aGlzLmlzT3BlbiA9IGZhbHNlOwogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5pbWdTdGF0ZSA9IHsgeDogMCwgeTogMCwgc2NhbGU6IDAuNSB9OwogICAgICAgICAgICB0aGlzLmlzRHJhZ2dpbmdJbWcgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5kcmFnU3RhcnQgPSB7IHg6IDAsIHk6IDAgfTsKCiAgICAgICAgICAgIHRoaXMucGFwZXJTaWduYXR1cmUgPSBudWxsOyAKICAgICAgICAgICAgdGhpcy5wYXBlckRyYWcgPSB7IGlzRHJhZ2dpbmc6IGZhbHNlLCBzdGFydFg6IDAsIHN0YXJ0WTogMCwgYmFzZVg6IDAsIGJhc2VZOiAwIH07CgogICAgICAgICAgICB0aGlzLmluaXQoKTsKICAgICAgICB9CgogICAgICAgIGluaXQoKSB7CiAgICAgICAgICAgIHRoaXMucGFkID0gbmV3IFNpZ25hdHVyZVBhZCh0aGlzLm1vZGFsQ2FudmFzLCB7CiAgICAgICAgICAgICAgICBtaW5XaWR0aDogMS4wLCBtYXhXaWR0aDogMy4wLCBwZW5Db2xvcjogJyMwMDAnLCB0aHJvdHRsZTogOAogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIHRoaXMudHJpZ2dlckJ0bi5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsICgpID0+IHRoaXMub3Blbk1vZGFsKCkpOwogICAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnYnRuQ2xvc2VNb2RhbFgnKS5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsICgpID0+IHRoaXMuY2xvc2VNb2RhbCgpKTsKICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2J0bkNhbmNlbE1vZGFsJykuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoKSA9PiB0aGlzLmNsb3NlTW9kYWwoKSk7CiAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdidG5Db25maXJtTW9kYWwnKS5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsICgpID0+IHRoaXMuYXBwbHlTaWduYXR1cmUoKSk7CgogICAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnYnRuUGVuJykuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoZSkgPT4gdGhpcy5zZXRUb29sKCdwZW4nLCBlLnRhcmdldCkpOwogICAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnYnRuRXJhc2VyJykuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoZSkgPT4gdGhpcy5zZXRUb29sKCdlcmFzZXInLCBlLnRhcmdldCkpOwogICAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnYnRuVW5kbycpLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKCkgPT4gdGhpcy51bmRvKCkpOwogICAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnYnRuQ2xlYXInKS5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsICgpID0+IHRoaXMuY2xlYXJBbGwoKSk7CiAgICAgICAgICAgIAogICAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnYnRuSW1wb3J0JykuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoKSA9PiB0aGlzLmZpbGVJbnB1dC5jbGljaygpKTsKICAgICAgICAgICAgdGhpcy5maWxlSW5wdXQuYWRkRXZlbnRMaXN0ZW5lcignY2hhbmdlJywgKGUpID0+IHRoaXMuaGFuZGxlRmlsZShlKSk7CgogICAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnYnRuRWRpdENhbmNlbCcpLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKCkgPT4gdGhpcy5jbG9zZUVkaXRvcigpKTsKICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2J0bkVkaXRBcHBseScpLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKCkgPT4gdGhpcy5hcHBseUVkaXRvckltYWdlKCkpOwogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5zY2FsZVNsaWRlci5hZGRFdmVudExpc3RlbmVyKCdpbnB1dCcsIChlKSA9PiB7CiAgICAgICAgICAgICAgICB0aGlzLmltZ1N0YXRlLnNjYWxlID0gcGFyc2VGbG9hdChlLnRhcmdldC52YWx1ZSk7CiAgICAgICAgICAgICAgICB0aGlzLnVwZGF0ZUltZ1RyYW5zZm9ybSgpOwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgCiAgICAgICAgICAgIHRoaXMuZWRpdEltZy5hZGRFdmVudExpc3RlbmVyKCdtb3VzZWRvd24nLCAoZSkgPT4gdGhpcy5zdGFydERyYWcoZSkpOwogICAgICAgICAgICB0aGlzLmVkaXRJbWcuYWRkRXZlbnRMaXN0ZW5lcigndG91Y2hzdGFydCcsIChlKSA9PiB0aGlzLnN0YXJ0RHJhZyhlKSwge3Bhc3NpdmU6ZmFsc2V9KTsKICAgICAgICAgICAgCiAgICAgICAgICAgIG5ldyBSZXNpemVPYnNlcnZlcigoKSA9PiB0aGlzLnJlc2l6ZVBhcGVyQ2FudmFzKCkpLm9ic2VydmUodGhpcy5wYXBlckNhbnZhcy5wYXJlbnRFbGVtZW50KTsKCiAgICAgICAgICAgIHRoaXMucGFwZXJDYW52YXMuYWRkRXZlbnRMaXN0ZW5lcignbW91c2Vkb3duJywgKGUpID0+IHRoaXMuc3RhcnRQYXBlckRyYWcoZSkpOwogICAgICAgICAgICB0aGlzLnBhcGVyQ2FudmFzLmFkZEV2ZW50TGlzdGVuZXIoJ3RvdWNoc3RhcnQnLCAoZSkgPT4gdGhpcy5zdGFydFBhcGVyRHJhZyhlKSwgeyBwYXNzaXZlOiBmYWxzZSB9KTsKICAgICAgICB9CgogICAgICAgIG9wZW5Nb2RhbCgpIHsKICAgICAgICAgICAgdGhpcy5pc09wZW4gPSB0cnVlOwogICAgICAgICAgICB0aGlzLm1vZGFsLmNsYXNzTGlzdC5hZGQoJ29wZW4nKTsKICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7IHRoaXMucmVzaXplTW9kYWxDYW52YXMoKTsgfSwgMTAwKTsKICAgICAgICB9CgogICAgICAgIGNsb3NlTW9kYWwoKSB7CiAgICAgICAgICAgIHRoaXMuaXNPcGVuID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMubW9kYWwuY2xhc3NMaXN0LnJlbW92ZSgnb3BlbicpOwogICAgICAgICAgICB0aGlzLmNsb3NlRWRpdG9yKCk7CiAgICAgICAgfQoKICAgICAgICByZXNpemVNb2RhbENhbnZhcygpIHsKICAgICAgICAgICAgY29uc3QgY29udGFpbmVyID0gdGhpcy5tb2RhbENhbnZhcy5wYXJlbnRFbGVtZW50OwogICAgICAgICAgICBjb25zdCByYXRpbyA9IE1hdGgubWF4KHdpbmRvdy5kZXZpY2VQaXhlbFJhdGlvIHx8IDEsIDEpOwogICAgICAgICAgICBjb25zdCB3ID0gY29udGFpbmVyLmNsaWVudFdpZHRoOwogICAgICAgICAgICBjb25zdCBoID0gY29udGFpbmVyLmNsaWVudEhlaWdodDsKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmICh0aGlzLm1vZGFsQ2FudmFzLndpZHRoICE9PSB3ICogcmF0aW8pIHsKICAgICAgICAgICAgICAgIGNvbnN0IGRhdGEgPSB0aGlzLnBhZC50b0RhdGEoKTsgCiAgICAgICAgICAgICAgICB0aGlzLm1vZGFsQ2FudmFzLndpZHRoID0gdyAqIHJhdGlvOwogICAgICAgICAgICAgICAgdGhpcy5tb2RhbENhbnZhcy5oZWlnaHQgPSBoICogcmF0aW87CiAgICAgICAgICAgICAgICB0aGlzLm1vZGFsQ2FudmFzLmdldENvbnRleHQoJzJkJykuc2NhbGUocmF0aW8sIHJhdGlvKTsKICAgICAgICAgICAgICAgIHRoaXMucGFkLmNsZWFyKCk7CiAgICAgICAgICAgICAgICB0aGlzLnJlZHJhd0JhY2tncm91bmRzKCk7IAogICAgICAgICAgICAgICAgdGhpcy5wYWQuZnJvbURhdGEoZGF0YSk7IAogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIAogICAgICAgIHNldFRvb2wodHlwZSwgYnRuKSB7CiAgICAgICAgICAgIGNvbnN0IGFsbEJ0bnMgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKCcuc2lnbi10b29scy1iYXIgYnV0dG9uJyk7CiAgICAgICAgICAgIGFsbEJ0bnMuZm9yRWFjaChiID0+IGIuY2xhc3NMaXN0LnJlbW92ZSgnYWN0aXZlJykpOwogICAgICAgICAgICAoYnRuLmNsb3Nlc3QoJ2J1dHRvbicpIHx8IGJ0bikuY2xhc3NMaXN0LmFkZCgnYWN0aXZlJyk7CiAgICAgICAgICAgIAogICAgICAgICAgICBpZih0eXBlID09PSAnZXJhc2VyJykgewogICAgICAgICAgICAgICAgdGhpcy5wYWQuY29tcG9zaXRlT3BlcmF0aW9uID0gJ2Rlc3RpbmF0aW9uLW91dCc7CiAgICAgICAgICAgICAgICB0aGlzLnBhZC5taW5XaWR0aCA9IDEwOyB0aGlzLnBhZC5tYXhXaWR0aCA9IDIwOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGhpcy5wYWQuY29tcG9zaXRlT3BlcmF0aW9uID0gJ3NvdXJjZS1vdmVyJzsKICAgICAgICAgICAgICAgIHRoaXMucGFkLm1pbldpZHRoID0gMTsgdGhpcy5wYWQubWF4V2lkdGggPSAzOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICB1bmRvKCkgewogICAgICAgICAgICBjb25zdCBkYXRhID0gdGhpcy5wYWQudG9EYXRhKCk7CiAgICAgICAgICAgIGlmIChkYXRhICYmIGRhdGEubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgICAgZGF0YS5wb3AoKTsKICAgICAgICAgICAgICAgIHRoaXMucGFkLmZyb21EYXRhKGRhdGEpOwogICAgICAgICAgICB9IGVsc2UgaWYgKHRoaXMuYmFja2dyb3VuZEltYWdlcy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgICB0aGlzLmJhY2tncm91bmRJbWFnZXMucG9wKCk7CiAgICAgICAgICAgICAgICB0aGlzLnJlc2l6ZU1vZGFsQ2FudmFzKCk7IAogICAgICAgICAgICAgICAgdGhpcy51aS5zaG93VG9hc3QoIuydtOuvuOyngCDsgq3soJzrkKgiKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgY2xlYXJBbGwoKSB7CiAgICAgICAgICAgIGlmKGNvbmZpcm0oIuuqqOuRkCDsp4DsmrDsi5zqsqDsirXri4jquYw/IikpIHsKICAgICAgICAgICAgICAgIHRoaXMucGFkLmNsZWFyKCk7CiAgICAgICAgICAgICAgICB0aGlzLmJhY2tncm91bmRJbWFnZXMgPSBbXTsKICAgICAgICAgICAgICAgIHRoaXMucmVzaXplTW9kYWxDYW52YXMoKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgaGFuZGxlRmlsZShlKSB7CiAgICAgICAgICAgIGNvbnN0IGZpbGUgPSBlLnRhcmdldC5maWxlc1swXTsKICAgICAgICAgICAgaWYoIWZpbGUpIHJldHVybjsKICAgICAgICAgICAgY29uc3QgcmVhZGVyID0gbmV3IEZpbGVSZWFkZXIoKTsKICAgICAgICAgICAgcmVhZGVyLm9ubG9hZCA9IChldikgPT4gewogICAgICAgICAgICAgICAgY29uc3QgaW1nID0gbmV3IEltYWdlKCk7CiAgICAgICAgICAgICAgICBpbWcub25sb2FkID0gKCkgPT4gewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHByb2Nlc3NlZFVybCA9IHRoaXMucHJvY2Vzc0ltYWdlKGltZyk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5vcGVuRWRpdG9yKHByb2Nlc3NlZFVybCk7CiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgaW1nLnNyYyA9IGV2LnRhcmdldC5yZXN1bHQ7CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHJlYWRlci5yZWFkQXNEYXRhVVJMKGZpbGUpOwogICAgICAgICAgICBlLnRhcmdldC52YWx1ZSA9ICcnOwogICAgICAgIH0KCiAgICAgICAgcHJvY2Vzc0ltYWdlKGltZykgewogICAgICAgICAgICBjb25zdCBjID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnY2FudmFzJyk7CiAgICAgICAgICAgIGNvbnN0IHcgPSBpbWcud2lkdGgsIGggPSBpbWcuaGVpZ2h0OwogICAgICAgICAgICBjb25zdCBtYXggPSA4MDA7CiAgICAgICAgICAgIGxldCBzY2FsZSA9IDE7CiAgICAgICAgICAgIGlmKHcgPiBtYXggfHwgaCA+IG1heCkgc2NhbGUgPSBtYXggLyBNYXRoLm1heCh3LGgpOwogICAgICAgICAgICBjLndpZHRoID0gdyAqIHNjYWxlOyBjLmhlaWdodCA9IGggKiBzY2FsZTsKICAgICAgICAgICAgY29uc3QgY3R4ID0gYy5nZXRDb250ZXh0KCcyZCcpOwogICAgICAgICAgICBjdHguZHJhd0ltYWdlKGltZywgMCwgMCwgYy53aWR0aCwgYy5oZWlnaHQpOwogICAgICAgICAgICBjb25zdCBpZGF0YSA9IGN0eC5nZXRJbWFnZURhdGEoMCwwLGMud2lkdGgsYy5oZWlnaHQpOwogICAgICAgICAgICBjb25zdCBkYXRhID0gaWRhdGEuZGF0YTsKICAgICAgICAgICAgZm9yKGxldCBpPTA7IGk8ZGF0YS5sZW5ndGg7IGkrPTQpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGF2ZyA9IChkYXRhW2ldK2RhdGFbaSsxXStkYXRhW2krMl0pLzM7CiAgICAgICAgICAgICAgICBpZihhdmcgPiAyMDApIGRhdGFbaSszXSA9IDA7IAogICAgICAgICAgICAgICAgZWxzZSB7IGRhdGFbaV0gPSBkYXRhW2krMV0gPSBkYXRhW2krMl0gPSAwOyB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY3R4LnB1dEltYWdlRGF0YShpZGF0YSwgMCwwKTsKICAgICAgICAgICAgcmV0dXJuIGMudG9EYXRhVVJMKCk7CiAgICAgICAgfQoKICAgICAgICBvcGVuRWRpdG9yKHNyYykgewogICAgICAgICAgICB0aGlzLmVkaXRJbWcuc3JjID0gc3JjOwogICAgICAgICAgICB0aGlzLmVkaXRMYXllci5zdHlsZS5kaXNwbGF5ID0gJ2ZsZXgnOwogICAgICAgICAgICB0aGlzLmltZ1N0YXRlID0geyB4OiAwLCB5OiAwLCBzY2FsZTogMC41IH07CiAgICAgICAgICAgIHRoaXMuc2NhbGVTbGlkZXIudmFsdWUgPSAwLjU7CiAgICAgICAgICAgIHRoaXMudXBkYXRlSW1nVHJhbnNmb3JtKCk7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIGNsb3NlRWRpdG9yKCkgeyB0aGlzLmVkaXRMYXllci5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOyB9CgogICAgICAgIHVwZGF0ZUltZ1RyYW5zZm9ybSgpIHsKICAgICAgICAgICAgdGhpcy5lZGl0SW1nLnN0eWxlLnRyYW5zZm9ybSA9IGB0cmFuc2xhdGUoLTUwJSwgLTUwJSkgdHJhbnNsYXRlKCR7dGhpcy5pbWdTdGF0ZS54fXB4LCAke3RoaXMuaW1nU3RhdGUueX1weCkgc2NhbGUoJHt0aGlzLmltZ1N0YXRlLnNjYWxlfSlgOwogICAgICAgIH0KCiAgICAgICAgc3RhcnREcmFnKGUpIHsKICAgICAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgICB0aGlzLmlzRHJhZ2dpbmdJbWcgPSB0cnVlOwogICAgICAgICAgICBjb25zdCBjeCA9IGUudG91Y2hlcyA/IGUudG91Y2hlc1swXS5jbGllbnRYIDogZS5jbGllbnRYOwogICAgICAgICAgICBjb25zdCBjeSA9IGUudG91Y2hlcyA/IGUudG91Y2hlc1swXS5jbGllbnRZIDogZS5jbGllbnRZOwogICAgICAgICAgICB0aGlzLmRyYWdTdGFydCA9IHsgeDogY3ggLSB0aGlzLmltZ1N0YXRlLngsIHk6IGN5IC0gdGhpcy5pbWdTdGF0ZS55IH07CiAgICAgICAgICAgIAogICAgICAgICAgICBjb25zdCBtb3ZlID0gKGV2KSA9PiB7CiAgICAgICAgICAgICAgICBpZighdGhpcy5pc0RyYWdnaW5nSW1nKSByZXR1cm47CiAgICAgICAgICAgICAgICBldi5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgICAgICAgY29uc3QgbXggPSBldi50b3VjaGVzID8gZXYudG91Y2hlc1swXS5jbGllbnRYIDogZXYuY2xpZW50WDsKICAgICAgICAgICAgICAgIGNvbnN0IG15ID0gZXYudG91Y2hlcyA/IGV2LnRvdWNoZXNbMF0uY2xpZW50WSA6IGV2LmNsaWVudFk7CiAgICAgICAgICAgICAgICB0aGlzLmltZ1N0YXRlLnggPSBteCAtIHRoaXMuZHJhZ1N0YXJ0Lng7CiAgICAgICAgICAgICAgICB0aGlzLmltZ1N0YXRlLnkgPSBteSAtIHRoaXMuZHJhZ1N0YXJ0Lnk7CiAgICAgICAgICAgICAgICB0aGlzLnVwZGF0ZUltZ1RyYW5zZm9ybSgpOwogICAgICAgICAgICB9OwogICAgICAgICAgICBjb25zdCBlbmQgPSAoKSA9PiB7CiAgICAgICAgICAgICAgICB0aGlzLmlzRHJhZ2dpbmdJbWcgPSBmYWxzZTsKICAgICAgICAgICAgICAgIGRvY3VtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ21vdXNlbW92ZScsIG1vdmUpOwogICAgICAgICAgICAgICAgZG9jdW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcignbW91c2V1cCcsIGVuZCk7CiAgICAgICAgICAgICAgICBkb2N1bWVudC5yZW1vdmVFdmVudExpc3RlbmVyKCd0b3VjaG1vdmUnLCBtb3ZlKTsKICAgICAgICAgICAgICAgIGRvY3VtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ3RvdWNoZW5kJywgZW5kKTsKICAgICAgICAgICAgfTsKICAgICAgICAgICAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignbW91c2Vtb3ZlJywgbW92ZSk7CiAgICAgICAgICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNldXAnLCBlbmQpOwogICAgICAgICAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCd0b3VjaG1vdmUnLCBtb3ZlLCB7cGFzc2l2ZTpmYWxzZX0pOwogICAgICAgICAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCd0b3VjaGVuZCcsIGVuZCk7CiAgICAgICAgfQoKICAgICAgICBhcHBseUVkaXRvckltYWdlKCkgewogICAgICAgICAgICBjb25zdCBpbWdSZWN0ID0gdGhpcy5lZGl0SW1nLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpOwogICAgICAgICAgICBjb25zdCBjb250YWluZXJSZWN0ID0gdGhpcy5lZGl0Q29udGFpbmVyLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpOwogICAgICAgICAgICAKICAgICAgICAgICAgY29uc3QgaW1nQ2VudGVyWCA9IGltZ1JlY3QubGVmdCArIGltZ1JlY3Qud2lkdGggLyAyOwogICAgICAgICAgICBjb25zdCBpbWdDZW50ZXJZID0gaW1nUmVjdC50b3AgKyBpbWdSZWN0LmhlaWdodCAvIDI7CiAgICAgICAgICAgIGNvbnN0IGNvbnRDZW50ZXJYID0gY29udGFpbmVyUmVjdC5sZWZ0ICsgY29udGFpbmVyUmVjdC53aWR0aCAvIDI7CiAgICAgICAgICAgIGNvbnN0IGNvbnRDZW50ZXJZID0gY29udGFpbmVyUmVjdC50b3AgKyBjb250YWluZXJSZWN0LmhlaWdodCAvIDI7CgogICAgICAgICAgICBjb25zdCByZWxYID0gKGltZ0NlbnRlclggLSBjb250Q2VudGVyWCkgLyBjb250YWluZXJSZWN0LndpZHRoOwogICAgICAgICAgICBjb25zdCByZWxZID0gKGltZ0NlbnRlclkgLSBjb250Q2VudGVyWSkgLyBjb250YWluZXJSZWN0LmhlaWdodDsKCiAgICAgICAgICAgIGNvbnN0IHJhdGlvWCA9IHRoaXMubW9kYWxDYW52YXMud2lkdGggLyBjb250YWluZXJSZWN0LndpZHRoOwogICAgICAgICAgICBjb25zdCByYXRpb1kgPSB0aGlzLm1vZGFsQ2FudmFzLmhlaWdodCAvIGNvbnRhaW5lclJlY3QuaGVpZ2h0OwoKICAgICAgICAgICAgY29uc3QgdyA9IGltZ1JlY3Qud2lkdGggKiByYXRpb1g7CiAgICAgICAgICAgIGNvbnN0IGggPSBpbWdSZWN0LmhlaWdodCAqIHJhdGlvWTsKCiAgICAgICAgICAgIGNvbnN0IGNhbnZhc0NlbnRlclggPSB0aGlzLm1vZGFsQ2FudmFzLndpZHRoIC8gMjsKICAgICAgICAgICAgY29uc3QgY2FudmFzQ2VudGVyWSA9IHRoaXMubW9kYWxDYW52YXMuaGVpZ2h0IC8gMjsKCiAgICAgICAgICAgIGNvbnN0IGRyYXdDZW50ZXJYID0gY2FudmFzQ2VudGVyWCArIHJlbFggKiB0aGlzLm1vZGFsQ2FudmFzLndpZHRoOwogICAgICAgICAgICBjb25zdCBkcmF3Q2VudGVyWSA9IGNhbnZhc0NlbnRlclkgKyByZWxZICogdGhpcy5tb2RhbENhbnZhcy5oZWlnaHQ7CgogICAgICAgICAgICBjb25zdCB4ID0gZHJhd0NlbnRlclggLSB3IC8gMjsKICAgICAgICAgICAgY29uc3QgeSA9IGRyYXdDZW50ZXJZIC0gaCAvIDI7CiAgICAgICAgICAgIAogICAgICAgICAgICBjb25zdCBpbWdPYmogPSBuZXcgSW1hZ2UoKTsKICAgICAgICAgICAgaW1nT2JqLm9ubG9hZCA9ICgpID0+IHsKICAgICAgICAgICAgICAgIHRoaXMuYmFja2dyb3VuZEltYWdlcy5wdXNoKHsgaW1nOiBpbWdPYmosIHgsIHksIHcsIGggfSk7CiAgICAgICAgICAgICAgICB0aGlzLnJlZHJhd0JhY2tncm91bmRzKCk7CiAgICAgICAgICAgICAgICB0aGlzLmNsb3NlRWRpdG9yKCk7CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIGltZ09iai5zcmMgPSB0aGlzLmVkaXRJbWcuc3JjOyAKICAgICAgICB9CgogICAgICAgIHJlZHJhd0JhY2tncm91bmRzKCkgewogICAgICAgICAgICBjb25zdCBjdHggPSB0aGlzLm1vZGFsQ2FudmFzLmdldENvbnRleHQoJzJkJyk7CiAgICAgICAgICAgIGNvbnN0IHByZXZDb21wID0gY3R4Lmdsb2JhbENvbXBvc2l0ZU9wZXJhdGlvbjsKICAgICAgICAgICAgY3R4Lmdsb2JhbENvbXBvc2l0ZU9wZXJhdGlvbiA9ICdkZXN0aW5hdGlvbi1vdmVyJzsgCiAgICAgICAgICAgIHRoaXMuYmFja2dyb3VuZEltYWdlcy5mb3JFYWNoKGl0ZW0gPT4gewogICAgICAgICAgICAgICAgY3R4LmRyYXdJbWFnZShpdGVtLmltZywgaXRlbS54LCBpdGVtLnksIGl0ZW0udywgaXRlbS5oKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGN0eC5nbG9iYWxDb21wb3NpdGVPcGVyYXRpb24gPSBwcmV2Q29tcDsKICAgICAgICB9CgogICAgICAgIHJlc2l6ZVBhcGVyQ2FudmFzKCkgewogICAgICAgICAgICBjb25zdCB3ID0gdGhpcy5wYXBlckNhbnZhcy5wYXJlbnRFbGVtZW50LmNsaWVudFdpZHRoOwogICAgICAgICAgICBjb25zdCBoID0gdGhpcy5wYXBlckNhbnZhcy5wYXJlbnRFbGVtZW50LmNsaWVudEhlaWdodDsKICAgICAgICAgICAgaWYoIXcgfHwgIWgpIHJldHVybjsKICAgICAgICAgICAgY29uc3QgcmF0aW8gPSAyOyAKICAgICAgICAgICAgdGhpcy5wYXBlckNhbnZhcy53aWR0aCA9IHcgKiByYXRpbzsKICAgICAgICAgICAgdGhpcy5wYXBlckNhbnZhcy5oZWlnaHQgPSBoICogcmF0aW87CiAgICAgICAgICAgIGlmICh0aGlzLnBhcGVyU2lnbmF0dXJlKSB7IHRoaXMucmVuZGVyUGFwZXJTaWduYXR1cmUoKTsgfQogICAgICAgIH0KCiAgICAgICAgYXBwbHlTaWduYXR1cmUoKSB7CiAgICAgICAgICAgIGlmICh0aGlzLnBhZC5pc0VtcHR5KCkgJiYgdGhpcy5iYWNrZ3JvdW5kSW1hZ2VzLmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgICAgICAgdGhpcy51aS5zaG93VG9hc3QoIuyEnOuqhSDrgrTsmqnsnbQg7JeG7Iq164uI64ukLiIpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICBjb25zdCBkYXRhVVJMID0gdGhpcy5tb2RhbENhbnZhcy50b0RhdGFVUkwoImltYWdlL3BuZyIpOwogICAgICAgICAgICAKICAgICAgICAgICAgY29uc3QgaW1nID0gbmV3IEltYWdlKCk7CiAgICAgICAgICAgIGltZy5vbmxvYWQgPSAoKSA9PiB7CiAgICAgICAgICAgICAgICBjb25zdCBjdHggPSB0aGlzLnBhcGVyQ2FudmFzLmdldENvbnRleHQoJzJkJyk7CiAgICAgICAgICAgICAgICBjb25zdCBwdyA9IHRoaXMucGFwZXJDYW52YXMud2lkdGg7CiAgICAgICAgICAgICAgICBjb25zdCBwaCA9IHRoaXMucGFwZXJDYW52YXMuaGVpZ2h0OwogICAgICAgICAgICAgICAgY29uc3QgaXcgPSBpbWcud2lkdGg7CiAgICAgICAgICAgICAgICBjb25zdCBpaCA9IGltZy5oZWlnaHQ7CgogICAgICAgICAgICAgICAgY29uc3QgY2FudmFzUmF0aW8gPSBwdyAvIHBoOwogICAgICAgICAgICAgICAgY29uc3QgaW1nUmF0aW8gPSBpdyAvIGloOwoKICAgICAgICAgICAgICAgIGxldCBkcmF3VywgZHJhd0gsIG9mZnNldFgsIG9mZnNldFk7CiAgICAgICAgICAgICAgICBjb25zdCBtYXJnaW5TY2FsZSA9IDAuOTsgCgogICAgICAgICAgICAgICAgaWYgKGltZ1JhdGlvID4gY2FudmFzUmF0aW8pIHsKICAgICAgICAgICAgICAgICAgICBkcmF3VyA9IHB3ICogbWFyZ2luU2NhbGU7CiAgICAgICAgICAgICAgICAgICAgZHJhd0ggPSBkcmF3VyAvIGltZ1JhdGlvOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBkcmF3SCA9IHBoICogbWFyZ2luU2NhbGU7CiAgICAgICAgICAgICAgICAgICAgZHJhd1cgPSBkcmF3SCAqIGltZ1JhdGlvOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIG9mZnNldFggPSAocHcgLSBkcmF3VykgLyAyOwogICAgICAgICAgICAgICAgb2Zmc2V0WSA9IChwaCAtIGRyYXdIKSAvIDI7CgogICAgICAgICAgICAgICAgdGhpcy5wYXBlclNpZ25hdHVyZSA9IHsgaW1nLCB3OiBkcmF3VywgaDogZHJhd0gsIHg6IG9mZnNldFgsIHk6IG9mZnNldFkgfTsKICAgICAgICAgICAgICAgIHRoaXMucmVuZGVyUGFwZXJTaWduYXR1cmUoKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgdGhpcy5ndWlkZVRleHQuc3R5bGUuZGlzcGxheSA9ICdub25lJzsKICAgICAgICAgICAgICAgIHRoaXMuY2xvc2VNb2RhbCgpOwogICAgICAgICAgICAgICAgdGhpcy51aS5zaG93VG9hc3QoIuyEnOuqheydtCDsoIHsmqnrkJjsl4jsirXri4jri6QiKTsKICAgICAgICAgICAgfTsKICAgICAgICAgICAgaW1nLnNyYyA9IGRhdGFVUkw7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIGNsZWFyUGFwZXIoKSB7CiAgICAgICAgICAgIGNvbnN0IGN0eCA9IHRoaXMucGFwZXJDYW52YXMuZ2V0Q29udGV4dCgnMmQnKTsKICAgICAgICAgICAgY3R4LmNsZWFyUmVjdCgwLCAwLCB0aGlzLnBhcGVyQ2FudmFzLndpZHRoLCB0aGlzLnBhcGVyQ2FudmFzLmhlaWdodCk7CiAgICAgICAgICAgIHRoaXMuZ3VpZGVUZXh0LnN0eWxlLmRpc3BsYXkgPSAnYmxvY2snOwogICAgICAgICAgICB0aGlzLmNsZWFyQWxsKCk7IAogICAgICAgICAgICB0aGlzLnBhcGVyU2lnbmF0dXJlID0gbnVsbDsKICAgICAgICB9CgogICAgICAgIHJlbmRlclBhcGVyU2lnbmF0dXJlKCkgewogICAgICAgICAgICBjb25zdCBjdHggPSB0aGlzLnBhcGVyQ2FudmFzLmdldENvbnRleHQoJzJkJyk7CiAgICAgICAgICAgIGN0eC5jbGVhclJlY3QoMCwgMCwgdGhpcy5wYXBlckNhbnZhcy53aWR0aCwgdGhpcy5wYXBlckNhbnZhcy5oZWlnaHQpOwogICAgICAgICAgICBpZiAoIXRoaXMucGFwZXJTaWduYXR1cmUpIHJldHVybjsKICAgICAgICAgICAgY29uc3QgcyA9IHRoaXMucGFwZXJTaWduYXR1cmU7CiAgICAgICAgICAgIGN0eC5kcmF3SW1hZ2Uocy5pbWcsIHMueCwgcy55LCBzLncsIHMuaCk7CiAgICAgICAgfQoKICAgICAgICBzdGFydFBhcGVyRHJhZyhlKSB7CiAgICAgICAgICAgIGlmICghdGhpcy5wYXBlclNpZ25hdHVyZSkgcmV0dXJuOyAKICAgICAgICAgICAgaWYgKCF0aGlzLnZpZXdlciB8fCAhdGhpcy52aWV3ZXIuaXNQYW5uaW5nKSByZXR1cm47IAogICAgICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7CgogICAgICAgICAgICBjb25zdCByZWN0ID0gdGhpcy5wYXBlckNhbnZhcy5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTsKICAgICAgICAgICAgY29uc3QgaXNUb3VjaCA9ICEhZS50b3VjaGVzOwogICAgICAgICAgICBjb25zdCBjeCA9IGlzVG91Y2ggPyBlLnRvdWNoZXNbMF0uY2xpZW50WCA6IGUuY2xpZW50WDsKICAgICAgICAgICAgY29uc3QgY3kgPSBpc1RvdWNoID8gZS50b3VjaGVzWzBdLmNsaWVudFkgOiBlLmNsaWVudFk7CgogICAgICAgICAgICB0aGlzLnBhcGVyRHJhZy5pc0RyYWdnaW5nID0gdHJ1ZTsKICAgICAgICAgICAgdGhpcy5wYXBlckRyYWcuc3RhcnRYID0gY3g7CiAgICAgICAgICAgIHRoaXMucGFwZXJEcmFnLnN0YXJ0WSA9IGN5OwogICAgICAgICAgICB0aGlzLnBhcGVyRHJhZy5iYXNlWCA9IHRoaXMucGFwZXJTaWduYXR1cmUueDsKICAgICAgICAgICAgdGhpcy5wYXBlckRyYWcuYmFzZVkgPSB0aGlzLnBhcGVyU2lnbmF0dXJlLnk7CgogICAgICAgICAgICBjb25zdCBtb3ZlID0gKGV2KSA9PiB7CiAgICAgICAgICAgICAgICBpZiAoIXRoaXMucGFwZXJEcmFnLmlzRHJhZ2dpbmcpIHJldHVybjsKICAgICAgICAgICAgICAgIGV2LnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICAgICAgICBjb25zdCBteCA9IGV2LnRvdWNoZXMgPyBldi50b3VjaGVzWzBdLmNsaWVudFggOiBldi5jbGllbnRYOwogICAgICAgICAgICAgICAgY29uc3QgbXkgPSBldi50b3VjaGVzID8gZXYudG91Y2hlc1swXS5jbGllbnRZIDogZXYuY2xpZW50WTsKICAgICAgICAgICAgICAgIGNvbnN0IHJhdGlvWCA9IHRoaXMucGFwZXJDYW52YXMud2lkdGggLyByZWN0LndpZHRoOwogICAgICAgICAgICAgICAgY29uc3QgcmF0aW9ZID0gdGhpcy5wYXBlckNhbnZhcy5oZWlnaHQgLyByZWN0LmhlaWdodDsKICAgICAgICAgICAgICAgIGNvbnN0IGR4ID0gKG14IC0gdGhpcy5wYXBlckRyYWcuc3RhcnRYKSAqIHJhdGlvWDsKICAgICAgICAgICAgICAgIGNvbnN0IGR5ID0gKG15IC0gdGhpcy5wYXBlckRyYWcuc3RhcnRZKSAqIHJhdGlvWTsKICAgICAgICAgICAgICAgIHRoaXMucGFwZXJTaWduYXR1cmUueCA9IHRoaXMucGFwZXJEcmFnLmJhc2VYICsgZHg7CiAgICAgICAgICAgICAgICB0aGlzLnBhcGVyU2lnbmF0dXJlLnkgPSB0aGlzLnBhcGVyRHJhZy5iYXNlWSArIGR5OwogICAgICAgICAgICAgICAgdGhpcy5yZW5kZXJQYXBlclNpZ25hdHVyZSgpOwogICAgICAgICAgICB9OwogICAgICAgICAgICBjb25zdCBlbmQgPSAoKSA9PiB7CiAgICAgICAgICAgICAgICB0aGlzLnBhcGVyRHJhZy5pc0RyYWdnaW5nID0gZmFsc2U7CiAgICAgICAgICAgICAgICBkb2N1bWVudC5yZW1vdmVFdmVudExpc3RlbmVyKCdtb3VzZW1vdmUnLCBtb3ZlKTsKICAgICAgICAgICAgICAgIGRvY3VtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ21vdXNldXAnLCBlbmQpOwogICAgICAgICAgICAgICAgZG9jdW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcigndG91Y2htb3ZlJywgbW92ZSk7CiAgICAgICAgICAgICAgICBkb2N1bWVudC5yZW1vdmVFdmVudExpc3RlbmVyKCd0b3VjaGVuZCcsIGVuZCk7CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNlbW92ZScsIG1vdmUpOwogICAgICAgICAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCdtb3VzZXVwJywgZW5kKTsKICAgICAgICAgICAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigndG91Y2htb3ZlJywgbW92ZSwgeyBwYXNzaXZlOiBmYWxzZSB9KTsKICAgICAgICAgICAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigndG91Y2hlbmQnLCBlbmQpOwogICAgICAgIH0KICAgIH0KCiAgICAvKiDrgrTrs7TrgrTquLAgKFBERi/qs7XsnKApICovCiAgICBjbGFzcyBFeHBvcnRlciB7CiAgICAgICAgY29uc3RydWN0b3IodWlVdGlscykgewogICAgICAgICAgICB0aGlzLnVpID0gdWlVdGlsczsKICAgICAgICAgICAgdGhpcy5wYXBlcldyYXBwZXIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncGFwZXJXcmFwcGVyJyk7CiAgICAgICAgICAgIHRoaXMuZG9jdW1lbnRBcmVhID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2RvY3VtZW50QXJlYScpOwogICAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnYnRuRG93bmxvYWQnKS5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsICgpID0+IHRoaXMuc2F2ZVBERigpKTsKICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2J0blNoYXJlJykuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoKSA9PiB0aGlzLnNoYXJlQ29udGVudCgpKTsKICAgICAgICB9CgogICAgICAgIC8vIOKchSBb7LaU6rCAXSBodG1sMmNhbnZhc+qwgCBpbnB1dCDthY3siqTtirjrpbwg7JyE7JeQ7IScIOyekOultOuKlCDrrLjsoJzrpbwg7ZS87ZWY6riwIOychO2VtAogICAgICAgIC8vIOy6oeyymOyaqSBjbG9uZSBET03sl5DshJzrp4wgcmVjaXBpZW50IOyeheugpeydhCBkaXbroZwg7LmY7ZmYICjroIjsnbTslYTsm4PsnYAg64+Z7J28KQogICAgICAgIF9maXhSZWNpcGllbnRGb3JDYXB0dXJlKGNsb25lZERvYykgewogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgY29uc3QgZG9jQXJlYSA9IGNsb25lZERvYy5nZXRFbGVtZW50QnlJZCgnZG9jdW1lbnRBcmVhJyk7CiAgICAgICAgICAgICAgICBpZiAoIWRvY0FyZWEpIHJldHVybjsKCiAgICAgICAgICAgICAgICBjb25zdCByb3cgPSBkb2NBcmVhLnF1ZXJ5U2VsZWN0b3IoJy5yZWNpcGllbnQtcm93Jyk7CiAgICAgICAgICAgICAgICBpZiAoIXJvdykgcmV0dXJuOwoKICAgICAgICAgICAgICAgIGNvbnN0IGNvbXBhbnlJbnB1dCA9IHJvdy5xdWVyeVNlbGVjdG9yKCdpbnB1dC5yZWNpcGllbnQtaW5wdXQnKTsKICAgICAgICAgICAgICAgIGNvbnN0IHN1ZmZpeElucHV0ICA9IHJvdy5xdWVyeVNlbGVjdG9yKCdpbnB1dC5yZWNpcGllbnQtc3VmZml4Jyk7CgogICAgICAgICAgICAgICAgY29uc3QgcmVwbGFjZVdpdGhEaXYgPSAoaW5wdXRFbCwgY3NzVGV4dCwgZmFsbGJhY2tUZXh0ID0gIiIpID0+IHsKICAgICAgICAgICAgICAgICAgICBpZiAoIWlucHV0RWwgfHwgIWlucHV0RWwucGFyZW50Tm9kZSkgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IGRpdiA9IGNsb25lZERvYy5jcmVhdGVFbGVtZW50KCdkaXYnKTsKICAgICAgICAgICAgICAgICAgICBjb25zdCB2YWwgPSAoaW5wdXRFbC52YWx1ZSB8fCAiIikudHJpbSgpOwogICAgICAgICAgICAgICAgICAgIGRpdi50ZXh0Q29udGVudCA9IHZhbCB8fCBmYWxsYmFja1RleHQ7IC8vIHBsYWNlaG9sZGVy64qUIHByZXBhcmVDYXB0dXJl7JeQ7IScIOydtOuvuCDsoJzqsbDrkKgKICAgICAgICAgICAgICAgICAgICBkaXYuc2V0QXR0cmlidXRlKCdzdHlsZScsIGNzc1RleHQpOwogICAgICAgICAgICAgICAgICAgIGlucHV0RWwucGFyZW50Tm9kZS5yZXBsYWNlQ2hpbGQoZGl2LCBpbnB1dEVsKTsKICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgLy8g7ZqM7IKs66qFIOy5uCAo67CR7KSEIO2PrO2VqCwg64aS7J20L+2PrSDrj5nsnbwgKyBsaW5lLWhlaWdodOuhnCDsiJjsp4HspJHslZkg4oaSIOyDgeuLqCDsnpjrprwg67Cp7KeAKQogICAgICAgICAgICAgICAgaWYgKGNvbXBhbnlJbnB1dCkgewogICAgICAgICAgICAgICAgICAgIHJlcGxhY2VXaXRoRGl2KAogICAgICAgICAgICAgICAgICAgICAgICBjb21wYW55SW5wdXQsCiAgICAgICAgICAgICAgICAgICAgICAgIFsKICAgICAgICAgICAgICAgICAgICAgICAgICAidGV4dC1hbGlnbjpjZW50ZXIiLAogICAgICAgICAgICAgICAgICAgICAgICAgICJmb250LXNpemU6MjRweCIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgImZvbnQtd2VpZ2h0OjgwMCIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgIndpZHRoOjMwMHB4IiwKICAgICAgICAgICAgICAgICAgICAgICAgICAiaGVpZ2h0OjYwcHgiLAogICAgICAgICAgICAgICAgICAgICAgICAgICJsaW5lLWhlaWdodDo2MHB4IiwKICAgICAgICAgICAgICAgICAgICAgICAgICAiYm94LXNpemluZzpib3JkZXItYm94IiwKICAgICAgICAgICAgICAgICAgICAgICAgICAiYm9yZGVyLWJvdHRvbToycHggc29saWQgIzAwMCIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgImJhY2tncm91bmQ6dHJhbnNwYXJlbnQiLAogICAgICAgICAgICAgICAgICAgICAgICAgICJib3JkZXItcmFkaXVzOjAiLAogICAgICAgICAgICAgICAgICAgICAgICAgICJwYWRkaW5nOjAiLAogICAgICAgICAgICAgICAgICAgICAgICAgICJtYXJnaW4tYm90dG9tOjNweCIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgImNvbG9yOiMwMDAiLAogICAgICAgICAgICAgICAgICAgICAgICAgICJmb250LWZhbWlseTppbmhlcml0IgogICAgICAgICAgICAgICAgICAgICAgICBdLmpvaW4oIjsiKSwKICAgICAgICAgICAgICAgICAgICAgICAgIiIgLy8g67mIIOqwkuydtOuptCDqt7jrg6Ug6rO1656ACiAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyDqt4DspJEg7Lm4CiAgICAgICAgICAgICAgICBpZiAoc3VmZml4SW5wdXQpIHsKICAgICAgICAgICAgICAgICAgICByZXBsYWNlV2l0aERpdigKICAgICAgICAgICAgICAgICAgICAgICAgc3VmZml4SW5wdXQsCiAgICAgICAgICAgICAgICAgICAgICAgIFsKICAgICAgICAgICAgICAgICAgICAgICAgICAid2lkdGg6NjBweCIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgInRleHQtYWxpZ246bGVmdCIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgImZvbnQtc2l6ZToyMHB4IiwKICAgICAgICAgICAgICAgICAgICAgICAgICAiZm9udC13ZWlnaHQ6NzAwIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAiaGVpZ2h0OmF1dG8iLAogICAgICAgICAgICAgICAgICAgICAgICAgICJsaW5lLWhlaWdodDoxLjQiLAogICAgICAgICAgICAgICAgICAgICAgICAgICJib3gtc2l6aW5nOmJvcmRlci1ib3giLAogICAgICAgICAgICAgICAgICAgICAgICAgICJib3JkZXI6bm9uZSIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgImJhY2tncm91bmQ6dHJhbnNwYXJlbnQiLAogICAgICAgICAgICAgICAgICAgICAgICAgICJwYWRkaW5nOjAiLAogICAgICAgICAgICAgICAgICAgICAgICAgICJtYXJnaW4tYm90dG9tOjEwcHgiLAogICAgICAgICAgICAgICAgICAgICAgICAgICJjb2xvcjojMDAwIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAiZm9udC1mYW1pbHk6aW5oZXJpdCIKICAgICAgICAgICAgICAgICAgICAgICAgXS5qb2luKCI7IiksCiAgICAgICAgICAgICAgICAgICAgICAgICLqt4DspJEiCiAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAgLy8g7Lqh7LKY64qUIOqzhOyGjSDsp4TtlokKICAgICAgICAgICAgICAgIGNvbnNvbGUud2FybigiUmVjaXBpZW50IGNhcHR1cmUgZml4IHNraXBwZWQ6IiwgZSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgoKCiAgICAgICAgLy8g4pyFIFvstpTqsIBdIOqzteyCrOuqhSDrk7EgdGFibGUgdGV4dGFyZWEg7KSE67CU6r+IIOyeheugpSDsi5wgUERGIOy6oeyymOyXkOyEnCAx7ZaJ7Jy866GcIOyemOumrOuKlCDrrLjsoJwg67Cp7KeACiAgICAgICAgLy8g7Lqh7LKY7JqpIGNsb25lIERPTeyXkOyEnOunjCB0YWJsZS1pbnB1dCB0ZXh0YXJlYeulvCBkaXbroZwg7LmY7ZmYICjroIjsnbTslYTsm4Mg7Jyg7KeAICsg7KSE67CU6r+IIOuztOyhtCkKICAgICAgICBfZml4VGFibGVJbnB1dHNGb3JDYXB0dXJlKGNsb25lZERvYykgewogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgY29uc3QgZG9jQXJlYSA9IGNsb25lZERvYy5nZXRFbGVtZW50QnlJZCgnZG9jdW1lbnRBcmVhJyk7CiAgICAgICAgICAgICAgICBpZiAoIWRvY0FyZWEpIHJldHVybjsKCiAgICAgICAgICAgICAgICBjb25zdCB0YXJnZXRzID0gZG9jQXJlYS5xdWVyeVNlbGVjdG9yQWxsKCd0ZXh0YXJlYS50YWJsZS1pbnB1dCcpOwogICAgICAgICAgICAgICAgaWYgKCF0YXJnZXRzIHx8IHRhcmdldHMubGVuZ3RoID09PSAwKSByZXR1cm47CgogICAgICAgICAgICAgICAgdGFyZ2V0cy5mb3JFYWNoKCh0YSkgPT4gewogICAgICAgICAgICAgICAgICAgIGlmICghdGEgfHwgIXRhLnBhcmVudE5vZGUpIHJldHVybjsKICAgICAgICAgICAgICAgICAgICBjb25zdCBkaXYgPSBjbG9uZWREb2MuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CiAgICAgICAgICAgICAgICAgICAgZGl2LnRleHRDb250ZW50ID0gKHRhLnZhbHVlIHx8ICIiKTsKICAgICAgICAgICAgICAgICAgICBkaXYuc2V0QXR0cmlidXRlKCdzdHlsZScsIFsKICAgICAgICAgICAgICAgICAgICAgICAgIndpZHRoOjEwMCUiLAogICAgICAgICAgICAgICAgICAgICAgICAiYm9yZGVyOm5vbmUiLAogICAgICAgICAgICAgICAgICAgICAgICAiYmFja2dyb3VuZDp0cmFuc3BhcmVudCIsCiAgICAgICAgICAgICAgICAgICAgICAgICJmb250LWZhbWlseTppbmhlcml0IiwKICAgICAgICAgICAgICAgICAgICAgICAgImZvbnQtc2l6ZToxNnB4IiwKICAgICAgICAgICAgICAgICAgICAgICAgImNvbG9yOiMwMDAiLAogICAgICAgICAgICAgICAgICAgICAgICAib3V0bGluZTpub25lIiwKICAgICAgICAgICAgICAgICAgICAgICAgInBhZGRpbmc6MnB4IiwKICAgICAgICAgICAgICAgICAgICAgICAgImZvbnQtd2VpZ2h0OjYwMCIsCiAgICAgICAgICAgICAgICAgICAgICAgICJ3aGl0ZS1zcGFjZTpwcmUtd3JhcCIsCiAgICAgICAgICAgICAgICAgICAgICAgICJ3b3JkLWJyZWFrOmJyZWFrLXdvcmQiLAogICAgICAgICAgICAgICAgICAgICAgICAibGluZS1oZWlnaHQ6MS40IiwKICAgICAgICAgICAgICAgICAgICAgICAgIm1pbi1oZWlnaHQ6MjRweCIsCiAgICAgICAgICAgICAgICAgICAgICAgICJkaXNwbGF5OmJsb2NrIgogICAgICAgICAgICAgICAgICAgIF0uam9pbigiOyIpKTsKICAgICAgICAgICAgICAgICAgICB0YS5wYXJlbnROb2RlLnJlcGxhY2VDaGlsZChkaXYsIHRhKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICAvLyDsuqHsspjripQg6rOE7IaNIOynhO2WiQogICAgICAgICAgICAgICAgY29uc29sZS53YXJuKCJUYWJsZSBjYXB0dXJlIGZpeCBza2lwcGVkOiIsIGUpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGFzeW5jIHByZXBhcmVDYXB0dXJlKCkgewogICAgICAgICAgICBjb25zdCBvcmlnaW5hbFRyYW5zZm9ybSA9IHRoaXMucGFwZXJXcmFwcGVyLnN0eWxlLnRyYW5zZm9ybTsKICAgICAgICAgICAgY29uc3Qgb3JpZ2luYWxNYXJnaW4gPSB0aGlzLnBhcGVyV3JhcHBlci5zdHlsZS5tYXJnaW47CiAgICAgICAgICAgIAogICAgICAgICAgICBjb25zdCBpbnB1dHMgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKCdpbnB1dCwgdGV4dGFyZWEnKTsKICAgICAgICAgICAgY29uc3QgcGxhY2Vob2xkZXJzID0gW107CiAgICAgICAgICAgIGlucHV0cy5mb3JFYWNoKGVsID0+IHsKICAgICAgICAgICAgICAgIHBsYWNlaG9sZGVycy5wdXNoKHtlbCwgdmFsOiBlbC5wbGFjZWhvbGRlcn0pOwogICAgICAgICAgICAgICAgZWwucGxhY2Vob2xkZXIgPSAiIjsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIAogICAgICAgICAgICBjb25zdCBndWlkZVRleHQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnY2xpY2tHdWlkZVRleHQnKTsKICAgICAgICAgICAgY29uc3QgZ3VpZGVUZXh0RGlzcGxheSA9IGd1aWRlVGV4dCA/IGd1aWRlVGV4dC5zdHlsZS5kaXNwbGF5IDogbnVsbDsKICAgICAgICAgICAgaWYgKGd1aWRlVGV4dCkgeyBndWlkZVRleHQuc3R5bGUuZGlzcGxheSA9ICdub25lJzsgfQoKICAgICAgICAgICAgdGhpcy5wYXBlcldyYXBwZXIuc3R5bGUudHJhbnNmb3JtID0gJ3NjYWxlKDEpJzsKICAgICAgICAgICAgdGhpcy5wYXBlcldyYXBwZXIuc3R5bGUubWFyZ2luID0gJzAnOwogICAgICAgICAgICBkb2N1bWVudC5ib2R5LmNsYXNzTGlzdC5hZGQoJ2NsZWFuLW1vZGUnKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGF3YWl0IG5ldyBQcm9taXNlKHIgPT4gc2V0VGltZW91dChyLCAxMDApKTsKCiAgICAgICAgICAgIHJldHVybiAoKSA9PiB7CiAgICAgICAgICAgICAgICB0aGlzLnBhcGVyV3JhcHBlci5zdHlsZS50cmFuc2Zvcm0gPSBvcmlnaW5hbFRyYW5zZm9ybTsKICAgICAgICAgICAgICAgIHRoaXMucGFwZXJXcmFwcGVyLnN0eWxlLm1hcmdpbiA9IG9yaWdpbmFsTWFyZ2luOwogICAgICAgICAgICAgICAgZG9jdW1lbnQuYm9keS5jbGFzc0xpc3QucmVtb3ZlKCdjbGVhbi1tb2RlJyk7CiAgICAgICAgICAgICAgICBwbGFjZWhvbGRlcnMuZm9yRWFjaChpdGVtID0+IGl0ZW0uZWwucGxhY2Vob2xkZXIgPSBpdGVtLnZhbCk7CiAgICAgICAgICAgICAgICBpZiAoZ3VpZGVUZXh0KSB7IGd1aWRlVGV4dC5zdHlsZS5kaXNwbGF5ID0gZ3VpZGVUZXh0RGlzcGxheSB8fCAnJzsgfQogICAgICAgICAgICB9OwogICAgICAgIH0KCiAgICAgICAgYXN5bmMgc2F2ZVBERigpIHsKICAgICAgICAgICAgdGhpcy51aS5zaG93VG9hc3QoIlBERiDsg53shLEg7KSRLi4uIik7CiAgICAgICAgICAgIGNvbnN0IHJlc3RvcmUgPSBhd2FpdCB0aGlzLnByZXBhcmVDYXB0dXJlKCk7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICBjb25zdCBjYW52YXMgPSBhd2FpdCBodG1sMmNhbnZhcyh0aGlzLmRvY3VtZW50QXJlYSwgewogICAgICAgICAgICAgICAgICAgIHNjYWxlOiAyLCB1c2VDT1JTOiB0cnVlLCBiYWNrZ3JvdW5kQ29sb3I6ICIjZmZmZmZmIiwKICAgICAgICAgICAgICAgICAgICAvLyDinIUgW+y2lOqwgF0gY2xvbmUgRE9N7JeQ7ISc66eMIGlucHV0IOKGkiBkaXYg7LmY7ZmYCiAgICAgICAgICAgICAgICAgICAgb25jbG9uZTogKGNsb25lZERvYykgPT4geyB0aGlzLl9maXhSZWNpcGllbnRGb3JDYXB0dXJlKGNsb25lZERvYyk7IHRoaXMuX2ZpeFRhYmxlSW5wdXRzRm9yQ2FwdHVyZShjbG9uZWREb2MpOyB9CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgY29uc3QgaW1nRGF0YSA9IGNhbnZhcy50b0RhdGFVUkwoJ2ltYWdlL2pwZWcnLCAwLjk1KTsKICAgICAgICAgICAgICAgIGNvbnN0IHsganNQREYgfSA9IHdpbmRvdy5qc3BkZjsKICAgICAgICAgICAgICAgIGNvbnN0IHBkZiA9IG5ldyBqc1BERigncCcsICdtbScsICdhNCcpOwogICAgICAgICAgICAgICAgY29uc3QgcFcgPSBwZGYuaW50ZXJuYWwucGFnZVNpemUuZ2V0V2lkdGgoKTsKICAgICAgICAgICAgICAgIGNvbnN0IHBIID0gcGRmLmludGVybmFsLnBhZ2VTaXplLmdldEhlaWdodCgpOwogICAgICAgICAgICAgICAgY29uc3QgaW1nSCA9IGNhbnZhcy5oZWlnaHQgKiBwVyAvIGNhbnZhcy53aWR0aDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgKGltZ0ggPD0gcEgpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCB0b3RhbE1hcmdpbiA9IHBIIC0gaW1nSDsKICAgICAgICAgICAgICAgICAgICBjb25zdCB0b3BNYXJnaW4gPSB0b3RhbE1hcmdpbiAvIDI7IAogICAgICAgICAgICAgICAgICAgIHBkZi5hZGRJbWFnZShpbWdEYXRhLCAnSlBFRycsIDAsIHRvcE1hcmdpbiwgcFcsIGltZ0gpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCByYXRpbyA9IHBIIC8gaW1nSDsKICAgICAgICAgICAgICAgICAgICBwZGYuYWRkSW1hZ2UoaW1nRGF0YSwgJ0pQRUcnLCAwLCAwLCBwVyAqIHJhdGlvLCBpbWdIICogcmF0aW8pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBwZGYuc2F2ZShg7J6R7JeF7JmE66OM7ZmV7J247IScXyR7dGhpcy5nZXREYXRlU3RyKCl9LnBkZmApOwogICAgICAgICAgICAgICAgdGhpcy51aS5zaG93VG9hc3QoIuyggOyepeuQmOyXiOyKteuLiOuLpCEiKTsKICAgICAgICAgICAgfSBjYXRjaChlKSB7CiAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKGUpOwogICAgICAgICAgICAgICAgdGhpcy51aS5zaG93VG9hc3QoIuyggOyepSDsi6TtjKgiKTsKICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgIHJlc3RvcmUoKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgYXN5bmMgc2hhcmVDb250ZW50KCkgewogICAgICAgICAgICBpZighbmF2aWdhdG9yLnNoYXJlKSB7IGFsZXJ0KCLqs7XsnKAg6riw64ql7J2EIOyngOybkO2VmOyngCDslYrripQg67iM65287Jqw7KCA7J6F64uI64ukLiIpOyByZXR1cm47IH0KICAgICAgICAgICAgdGhpcy51aS5zaG93VG9hc3QoIuydtOuvuOyngCDsg53shLEg7KSRLi4uIik7CiAgICAgICAgICAgIGNvbnN0IHJlc3RvcmUgPSBhd2FpdCB0aGlzLnByZXBhcmVDYXB0dXJlKCk7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICBjb25zdCBjYW52YXMgPSBhd2FpdCBodG1sMmNhbnZhcyh0aGlzLmRvY3VtZW50QXJlYSwgeyAKICAgICAgICAgICAgICAgICAgICBzY2FsZTogMiwgdXNlQ09SUzogdHJ1ZSwKICAgICAgICAgICAgICAgICAgICAvLyDinIUgW+y2lOqwgF0g6rO17JygIOy6oeyymOuPhCDrj5nsnbwg7KCB7JqpCiAgICAgICAgICAgICAgICAgICAgb25jbG9uZTogKGNsb25lZERvYykgPT4geyB0aGlzLl9maXhSZWNpcGllbnRGb3JDYXB0dXJlKGNsb25lZERvYyk7IHRoaXMuX2ZpeFRhYmxlSW5wdXRzRm9yQ2FwdHVyZShjbG9uZWREb2MpOyB9CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIGNhbnZhcy50b0Jsb2IoYXN5bmMgKGJsb2IpID0+IHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBmaWxlID0gbmV3IEZpbGUoW2Jsb2JdLCAiY29uZmlybWF0aW9uLmpwZyIsIHsgdHlwZTogImltYWdlL2pwZWciIH0pOwogICAgICAgICAgICAgICAgICAgIGF3YWl0IG5hdmlnYXRvci5zaGFyZSh7IHRpdGxlOiAn7J6R7JeF7ZmV7J247IScJywgZmlsZXM6IFtmaWxlXSB9KTsKICAgICAgICAgICAgICAgIH0sICdpbWFnZS9qcGVnJywgMC45KTsKICAgICAgICAgICAgfSBjYXRjaChlKSB7CiAgICAgICAgICAgICAgICB0aGlzLnVpLnNob3dUb2FzdCgi6rO17JygIOyLpO2MqCIpOwogICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgcmVzdG9yZSgpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIAogICAgICAgIGdldERhdGVTdHIoKSB7CiAgICAgICAgICAgIGNvbnN0IGQgPSBuZXcgRGF0ZSgpOwogICAgICAgICAgICByZXR1cm4gYCR7ZC5nZXRGdWxsWWVhcigpfSR7U3RyaW5nKGQuZ2V0TW9udGgoKSsxKS5wYWRTdGFydCgyLCcwJyl9JHtTdHJpbmcoZC5nZXREYXRlKCkpLnBhZFN0YXJ0KDIsJzAnKX1gOwogICAgICAgIH0KICAgIH0KCiAgICAvKiDrqZTsnbgg7JWxIOy0iOq4sO2ZlCAqLwogICAgY2xhc3MgQXBwIHsKICAgICAgICBjb25zdHJ1Y3RvcigpIHsKICAgICAgICAgICAgY29uc3QgaXNJZnJhbWUgPSB3aW5kb3cuc2VsZiAhPT0gd2luZG93LnRvcDsKICAgICAgICAgICAgaWYgKGlzSWZyYW1lKSB7IGRvY3VtZW50LmJvZHkuY2xhc3NMaXN0LmFkZCgnaWZyYW1lLW1vZGUnKTsgfQogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy51aSA9IG5ldyBVaVV0aWxzKCk7CiAgICAgICAgICAgIHRoaXMudmlld2VyID0gbmV3IFZpZXdlck1hbmFnZXIodGhpcy51aSk7CiAgICAgICAgICAgIHRoaXMuc2lnbmVyID0gbmV3IFNpZ25hdHVyZU1hbmFnZXIodGhpcy51aSwgdGhpcy52aWV3ZXIpOwogICAgICAgICAgICB0aGlzLmV4cG9ydGVyID0gbmV3IEV4cG9ydGVyKHRoaXMudWkpOwogICAgICAgICAgICAKICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2J0bkJhY2snKS5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsICgpID0+IHsgaWYoY29uZmlybSgi7KKF66OM7ZWY7Iuc6rKg7Iq164uI6rmMPyIpKSBoaXN0b3J5LmJhY2soKTsgfSk7CiAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdidG5SZXNldCcpLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKCkgPT4gewogICAgICAgICAgICAgICAgaWYoY29uZmlybSgi66qo65OgIOyeheugpeydhCDstIjquLDtmZTtlZjsi5zqsqDsirXri4jquYw/IikpIHsKICAgICAgICAgICAgICAgICAgICBkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKCdpbnB1dCwgdGV4dGFyZWEnKS5mb3JFYWNoKGVsID0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8g64Kg7Kec7JmAIOq3gOykkSwg7IaM7IaNIOq4sOuzuOqwkuydgCDsnKDsp4DtlZjqs6Ag7Iu264uk66m0IOygnOyZuCDsobDqsbQg7LaU6rCAIOqwgOuKpe2VmOyngOunjAogICAgICAgICAgICAgICAgICAgICAgICAvLyDsmpTssq3tlZjsi6Ag66as7IWLIOq4sOuKpeydgCDsoITssrQg7LSI6riw7ZmU6rCAIOydvOuwmOyggeydtOuvgOuhnCDri6Qg67mE7JuAICjri6gsIOq3gOykkeydgCAn6reA7KSRJ+ycvOuhnCDrs7Xsm5DtlZjripTqsowg7KKL7J2MKQogICAgICAgICAgICAgICAgICAgICAgICBpZihlbC5jbGFzc0xpc3QuY29udGFpbnMoJ3JlY2lwaWVudC1zdWZmaXgnKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsLnZhbHVlID0gJ+q3gOykkSc7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZWwudmFsdWUgPSAnJzsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIHRoaXMuc2lnbmVyLmNsZWFyUGFwZXIoKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnVpLnNob3dUb2FzdCgi7LSI6riw7ZmUIOyZhOujjCIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGNvbnN0IGQgPSBuZXcgRGF0ZSgpOwogICAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZGF0ZUZpZWxkJykudmFsdWUgPSBgJHtkLmdldEZ1bGxZZWFyKCl964WEICR7ZC5nZXRNb250aCgpKzF97JuUICR7ZC5nZXREYXRlKCl97J28YDsKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmICh3aW5kb3cubHVjaWRlICYmIHR5cGVvZiB3aW5kb3cubHVjaWRlLmNyZWF0ZUljb25zID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgICAgICAgICB3aW5kb3cubHVjaWRlLmNyZWF0ZUljb25zKCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIFvstpTqsIBdIFRhYmxlIFRleHRhcmVhIOyekOuPmSDrhpLsnbQg7KGw7KCICiAgICAgICAgICAgIHRoaXMuaW5pdEF1dG9SZXNpemUoKTsKICAgICAgICB9CgogICAgICAgIGluaXRBdXRvUmVzaXplKCkgewogICAgICAgICAgICBjb25zdCB0ZXh0YXJlYXMgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKCcudGFibGUtaW5wdXQnKTsKICAgICAgICAgICAgY29uc3QgcmVzaXplID0gKGVsKSA9PiB7CiAgICAgICAgICAgICAgICBlbC5zdHlsZS5oZWlnaHQgPSAnYXV0byc7IAogICAgICAgICAgICAgICAgZWwuc3R5bGUuaGVpZ2h0ID0gZWwuc2Nyb2xsSGVpZ2h0ICsgJ3B4JzsKICAgICAgICAgICAgfTsKICAgICAgICAgICAgdGV4dGFyZWFzLmZvckVhY2goZWwgPT4gewogICAgICAgICAgICAgICAgZWwuYWRkRXZlbnRMaXN0ZW5lcignaW5wdXQnLCAoKSA9PiByZXNpemUoZWwpKTsKICAgICAgICAgICAgICAgIC8vIOy0iOq4sOqwkiDsnojsnLzrqbQg66as7IKs7J207KaICiAgICAgICAgICAgICAgICBpZihlbC52YWx1ZSkgcmVzaXplKGVsKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfQogICAgfQoKICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ0RPTUNvbnRlbnRMb2FkZWQnLCAoKSA9PiB7IG5ldyBBcHAoKTsgfSk7Cjwvc2NyaXB0Pgo8L2JvZHk+CjwvaHRtbD4K";

      function i3_b64ToUtf8(b64) {
        try {
          const bytes = Uint8Array.from(atob(b64), c => c.charCodeAt(0));
          if (typeof TextDecoder !== "undefined") {
            return new TextDecoder("utf-8").decode(bytes);
          }
          // Fallback (구형 브라우저)
          let s = "";
          for (let i = 0; i < bytes.length; i++) s += String.fromCharCode(bytes[i]);
          return decodeURIComponent(escape(s));
        } catch (e) {
          console.error(e);
          return "";
        }
      }


      function openCertModal() {
        try {
          const html = i3_b64ToUtf8(I3_CONFIRM_V4_B64);
          if (!html) throw new Error("V4 HTML is empty");
          const blob = new Blob([html], { type: "text/html;charset=utf-8" });
          const url = URL.createObjectURL(blob);
          // 팝업 차단을 피하기 위해 동일 탭에서 열기 (뒤로 가기 = 원래 화면 복귀)
          window.location.href = url;
        } catch (e) {
          console.error(e);
          alert("확인서 열기에 실패했습니다.");
        }
      }


function setupCertModalButtons() {
        const resetBtn = document.getElementById("i3_certBtnReset");
        const downloadBtn = document.getElementById("i3_certBtnDownload");
        const iframe = document.getElementById("i3_certIframe");
        
        if (resetBtn) {
          resetBtn.onclick = function() {
            if (iframe && iframe.contentWindow) {
              const iframeResetBtn = iframe.contentWindow.document.getElementById("btnReset");
              if (iframeResetBtn) {
                iframeResetBtn.click();
              }
            }
          };
        }
        
        if (downloadBtn) {
          downloadBtn.onclick = function() {
            if (iframe && iframe.contentWindow) {
              const iframeDownloadBtn = iframe.contentWindow.document.getElementById("btnDownload");
              if (iframeDownloadBtn) {
                iframeDownloadBtn.click();
              }
            }
          };
        }
      }

      function closeCertModal() {
        const modal = $("i3_certModal");
        const iframe = $("i3_certIframe");
        if (!modal) return;
        
        // 모달 닫기
        modal.classList.remove("active");
        
        // body 스크롤 복원
        document.body.style.overflow = "";
        
        // iframe 내용 초기화 (선택사항)
        setTimeout(() => {
          if (iframe) { iframe.src = ""; iframe.srcdoc = ""; }
        }, 300);
      }



      /* ================= (추가) 네비게이션 선택 함수 ================= */
      function selectNav(element, menuName) {
        event.preventDefault();
        document.querySelectorAll('.nav-link').forEach(link => {
          link.classList.remove('active');
        });
        element.classList.add('active');
        
        // 토스트 메시지 표시
        if (typeof showToast === 'function') {
          showToast(menuName + ' 메뉴 선택됨');
        } else {
          // 간단한 알림으로 대체
          console.log(menuName + ' 메뉴 선택됨');
        }
        
        // 아이콘 새로고침
        refreshIcons();
      }

      /* ========== 초기화 ========== */
      function init() {
        // renderBookmarkedSites(); // 이 함수는 정의되어 있지만, 데이터가 없으므로 주석 처리
        updateBadge();
        refreshIcons();
      }

      window.INOPNC_I3 = {
        reload,

        openUnifiedSearch,
        closeUnifiedSearch,
        handleUnifiedTyping,
        clearUnifiedSearchInput,
        setSearch,
        performUnifiedSearch,
        findInPageAndScroll,
        goToElement,
        goAction,
        // ✅ UX_POLICY: recent click auto-navigate - Add remove recent search
        removeRecentSearch,
        handleSearchLoadMore,

        openNotification,
        closeNotification,
        markAllRead,

        openMenu,
        closeMenu,

        openAccount,
        closeAccount,
        saveAccount,
        triggerProfileUpload,
        handleProfilePreview,

        updateBadge,


        /* 네비게이션 선택 함수 */
        selectNav,

        /* 작업완료확인서 모달 */
        openCertModal,
        closeCertModal,

      };

      // ✅ UX_POLICY: recent click auto-navigate - Initialize recent searches after INOPNC_I3 is ready
      renderRecentSearches();

      if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", init);
      } else {
        init();
      }

      // 전역 함수로도 노출
      window.selectNav = selectNav;
    })();
  </script>
</body>
</html>