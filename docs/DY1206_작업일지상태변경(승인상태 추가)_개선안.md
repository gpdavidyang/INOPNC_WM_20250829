# DY1206 작업일지 상태 변경(승인 상태 추가) 개선안

## 1. 배경 및 목적

- 현재 작업일지는 `draft(임시저장)`와 `submitted(작성완료)` 두 단계만 제공되어 승인·정산 체계와 분리되어 있음.
- 본사 관리자 승인 여부와 관계없이 파트너에게 동일한 데이터가 노출되어 검토 완료되지 않은 일지가 외부로 공유될 수 있음.
- 사용자(작업자, 현장관리자, 본사/파트너)별로 원하는 정보와 권한이 다르므로 **상태 체계 고도화 + 권한 기반 필터링**이 필요.

## 2. 요구사항 정리

1. **상태 정의**
   - `draft`: 작성자 임시 저장, 모든 내부 역할 접근 가능 (파트너 제외).
   - `submitted`: 작성자가 “저장하기” 실행 시 자동 전환, 모든 내부 역할 접근 가능.
   - `approved`: 본사 관리자가 승인 시 전환, 파트너는 승인 상태만 볼 수 있음.
2. **명칭 변경**
   - UI/문구에서 `작성완료` → `제출`로 통일.
3. **권한/노출**
   - 작업자/현장관리자/본사관리자: 세 상태 모두 조회 가능.
   - 파트너(소속사): 연동 현장의 `approved` 상태만 조회 가능.
4. **본사 관리자 기능**
   - 작업일지 목록/상세에서 승인 상태로 변경(및 필요 시 승인 취소) 기능.
   - 승인자/승인일 메타데이터 저장.
5. **UI 제약**
   - 모바일 화면(작업자, 현장관리자, 소속사)의 레이아웃 변경은 최소화. 상태 배지와 라벨 교체 수준으로 처리.

## 3. 현황 및 Pain Point

| 항목         | 현행                                      | 문제점                                                  |
| ------------ | ----------------------------------------- | ------------------------------------------------------- |
| 상태 값      | `draft`, `submitted`                      | 승인 개념 부재, 두 번째 상태의 명칭이 “작성완료”로 고정 |
| 권한 제어    | 단순 RLS: 본사/현장/파트너 모두 동일 필터 | 파트너도 미승인 일지 열람 가능                          |
| 본사 승인 UX | 미구현 (별도 승인 버튼 없음)              | 검토/정산 절차가 문서 외부에서 진행돼 추적 불가         |
| UI 라벨      | “작성완료”                                | 실제 플로우는 ‘제출’ → ‘승인’ 구조가 되어야 함          |

## 4. 개선 방향

### 4.1 상태 정의 및 전이

| 이벤트                  | 상태 전이                                           | 비고                         |
| ----------------------- | --------------------------------------------------- | ---------------------------- |
| 작성자가 임시저장       | `- → draft`                                         | 기존 동작 유지               |
| 작성자가 저장하기(제출) | `draft → submitted` (또는 신규 생성 직후 submitted) | UI 문구는 “제출 완료”로 변경 |
| 본사 관리자 승인        | `submitted → approved`                              | 승인자/승인일 기록           |
| 승인 취소 (옵션)        | `approved → submitted`                              | 필요 시만 제공, 권한 제한    |

### 4.2 데이터 모델

1. `daily_reports.status` ENUM/텍스트 값에 `approved` 추가.
2. 메타데이터 컬럼 추가:
   - `approved_at` (timestamp with time zone)
   - `approved_by` (uuid, FK → profiles.id)
3. 기존 `submitted` 데이터를 그대로 사용하되, UI 레이어에서 “제출”로 표기.
4. 마이그레이션: `ALTER TYPE` 또는 체크 제약 업데이트 후, 기존 데이터는 그대로 유지.

### 4.3 API/서비스 변경

| API                                                | 변경 내용                                                            |
| -------------------------------------------------- | -------------------------------------------------------------------- |
| `POST /api/mobile/daily-reports`                   | 상태 값 `draft`/`submitted` 동작 동일, 응답에 새 상태 라벨 필드 추가 |
| `PATCH /api/admin/daily-reports/:id/status` (신규) | 본사 승인/승인 취소 전용 엔드포인트, 승인 메타데이터 기록            |
| 리스트/상세 조회 API (모바일/웹)                   | 역할 기반 필터 적용, 상태 라벨을 “임시저장/제출/승인”으로 돌려줌     |
| Export/검색 API                                    | 상태 문자열 업데이트, 승인 일자 필터 제공                            |

### 4.4 권한 및 노출 정책

1. **본사/작업자/현장관리자**
   - 기존 RLS 유지, 단 상태 필터에서 `approved` 옵션 추가.
   - 목록/상세에서 배지 3종 표시(색상만 추가, 레이아웃 유지).
2. **파트너(소속사)**
   - RLS 또는 API 레벨 필터에서 `status = 'approved'` 조건 강제.
   - 상태 배지는 항상 “승인”.
3. **알림/감사 로그**
   - 승인 시 `notifications/approval` 트리거(선택).
   - `audit_logs`에 승인자, 일시 기록.

### 4.5 UI 개선 (레이아웃 영향 최소화)

1. **모바일 작업자/현장관리자**
   - 기존 상태 배지 컴포넌트에 `approved` 스타일 추가 (예: 짙은 파랑/초록).
   - “작성완료” 텍스트를 “제출”로 교체 (탭, 필터, 토스트, 버튼 문구 포함).
2. **본사 관리자 (웹)**
   - 작업일지 목록/상세 카드 상단에 상태 배지를 3색으로 노출.
   - 리스트 테이블에서 행 액션으로 “승인” CTA를 제공하고, 동일 화면에서 즉시 확인 후 상태 업데이트(토스트/인라인 알림).
3. **파트너 웹/모바일**
   - 필터/배지 변경 없이 `approved` 데이터만 내려받도록 서버에서 필터링.

### 4.6 추가 고려 사항

- 승인 상태에서도 수정이 필요하면 상태를 `submitted`로 되돌리는 정책 정의(권한: 본사 관리자만 가능).
- 승인 전/후에 사진·도면 연동 상태 변경이 필요한 경우, 승인 취소 후 수정하도록 안내.

## 5. 마이그레이션 및 배포 전략

1. DB 타입/체크 제약 업데이트 및 `approved_*` 컬럼 추가.
2. 코드 업데이트 순서
   1. 백엔드: 상태 enum, DTO, API, 권한 필터.
   2. 프론트: 상태 라벨/배지 업데이트, 관리자 승인 버튼.
   3. 파트너 뷰: 승인 조건 필터 적용 확인.
3. 배포 전후 데이터 검증
   - 승인 상태 생성 전에는 UI에서 승인 버튼을 숨겨 두고 배포 이후 순차 활성화 가능.
4. 기존 데이터에 대한 영향
   - 모든 `submitted` 데이터는 그대로 “제출”로 표시되며, 추가 조치 불필요.

## 6. 테스트 시나리오

1. **상태 전환**
   - 임시저장 → 제출 → 승인 전환 플로우.
   - 승인 취소(선택 적용 시) 경로.
2. **권한/노출**
   - 각 역할 계정으로 로그인하여 상태별 노출 확인.
   - 파트너 계정에서 승인 전 일지가 보이지 않는지 확인.
3. **UI 텍스트/배지**
   - 모든 화면(모바일/웹)의 `작성완료` 라벨이 `제출`로 변경되었는지 확인.
   - 배지 색상 및 ToolTip.
4. **API/RLS**
   - API 단위 테스트: 상태 필터, 승인 엔드포인트 권한.
   - RLS 테스트: 파트너가 승인되지 않은 ID 직접 접근 시 403/빈 결과.
5. **회귀**
   - 사진/도면 연계, 문서 다운로드 등 기존 작업일지 연동 기능이 상태 변경 후 정상 동작하는지.

---

위 개선안에 따라 상태 체계를 3단계로 확장하면서도 UI 변경은 최소화하고, 역할별로 필요한 뷰와 권한을 명확히 구분하여 작업일지 승인 흐름을 정식 프로세스로 정착시킬 수 있다.
