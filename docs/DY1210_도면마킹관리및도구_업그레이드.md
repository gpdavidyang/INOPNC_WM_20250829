# DY1210 · 도면마킹 관리 & 도구 연동 업그레이드 계획

## 1. 요구사항 정리

- 작업관리자 > 사진·도면 관리 > **도면 탭**을 사진 탭과 동일한 UX 흐름으로 개선.
- 검색/필터 조건에 따라 **작업일지 카드**를 보여주고, 각 카드에 도면 수 배지를 표기.
- “도면 업로드 열기”를 누르면 해당 작업일지용 업로드/관리 패널이 펼쳐져야 함.
- 도면 업로드 경로는 두 가지를 모두 지원:
  1. 로컬 파일 업로드 (마킹된 이미지 직접 업로드)
  2. **도면마킹도구**에서 생성된 항목을 선택해 연결
- 도면마킹도구와 도면 관리 화면을 자연스럽게 연동하고, 작업일지·현장 매핑이 누락되지 않도록 한다.

## 2. UX 개편 방향

### 2.1 작업일지 리스트

- 사진 탭과 동일한 검색/필터 UI 재사용(기간, 현장, 상태 등).
- 각 작업일지 카드에 `도면 n개` 배지를 표기하고, 카드 내부에 “도면 업로드 열기” 버튼 배치.
- 버튼 클릭 시 카드 아래에 **도면 관리 패널**이 슬라이드/확장되어 해당 작업일지의 업로드 UI + 기존 도면 리스트를 표시.

### 2.2 도면 관리 패널 구조

```
┌ 요약 영역 (현장·일자·작성자 등)
├ 업로드 방식 탭
│   ├ 로컬 업로드
│   └ 도면마킹도구 결과
├ 업로드 폼 (선택된 탭에 따라 입력 UI 변경)
└ 업로드 내역 리스트 (타입, 업로더, 업로드일, 연결상태, 액션)
```

### 2.3 업로드 방식 UX

- **로컬 업로드 탭**
  - 기존 파일 업로드 폼을 재사용.
  - 작업일지와 현장이 이미 선택되어 있으므로 별도 매핑 입력 없이 업로드하면 자동 연결.
- **도면마킹도구 결과 탭**
  - 도구에서 “저장”한 항목 중 `worklogId`가 비어 있는 것들을 `연동 대기` 리스트로 보여줌.
  - 각 항목: 썸네일, 원본 도면 제목, 생성일, 마킹 상태 등.
  - “작업일지 연결” 버튼을 누르면 현재 패널의 작업일지와 연결 처리 후 리스트에서 제거.

### 2.4 업로드 내역 관리

- 업로드 내역은 두 경로에서 들어온 항목을 한 리스트로 보여주고, `업로드 타입`(파일/도구)을 아이콘/배지로 구분.
- 액션: 다운로드, 삭제, 연결해제(필요 시), 세부 정보 보기.
- 필터/정렬: 최근 업로드 순, 타입별 필터 등 사진 탭과 동일한 패턴 적용.

## 3. 데이터/API 고려사항

1. **마킹도구 결과 저장 스키마 확장**
   - `drawing_markups` (예시) 테이블에 `worklog_id`, `site_id`, `status`(pending/linked) 필드를 추가/활용.
   - 도구에서 저장할 때 `worklog_id` 없이 저장 → 상태 `pending`.
2. **API 추가/확장**
   - `GET /api/drawings/pending` : 로그인 사용자의 권한 범위 내에서 `pending` 상태 도면 리스트 반환.
   - `POST /api/drawings/link` : pending 항목을 특정 worklog/site와 매핑, 상태 `linked`로 업데이트.
   - 기존 도면 리스트 API는 `type`/`status` 필터를 수용해 로컬/도구 업로드를 함께 조회.
3. **권한/검증**
   - 사용자가 접근 가능한 현장/작업일지 여부를 백엔드에서 재확인.
   - 마킹도구에서 저장할 때도 작업자 역할/현장 권한을 체크.

## 4. 구현 단계

### 4.1 공통 데이터 준비

- [ ] Supabase 스키마 점검: 도면 저장/마킹 테이블에 `status`, `worklog_id` 컬럼이 있는지 확인하고 없으면 migration.
- [ ] API 계약 정의 (`pending`, `link`, `list` 등) 및 타입 정의 추가.

### 4.2 프론트엔드 – 작업일지 리스트

- [ ] 사진 탭의 리스트 컴포넌트를 `DrawingsWorklogList`로 추출해 재사용.
- [ ] 각 카드에 도면 개수 배지 표기 (API에서 count 제공 or 클라이언트 계산).
- [ ] “도면 업로드 열기” 클릭 시 해당 worklogId를 state로 저장하고 패널 표시.

### 4.3 프론트엔드 – 도면 관리 패널

- [ ] `DrawingUploadPanel` 컴포넌트 생성: worklogId, siteId를 props로 전달.
- [ ] 탭 UI 구현 (Radix Tabs 등) → 로컬 업로드 / 마킹도구 결과.
- [ ] 로컬 업로드 폼: 기존 업로드 폼 로직을 컴포넌트화하여 재사용, 성공 시 리스트 갱신.
- [ ] 마킹도구 결과 탭:
  - `usePendingMarkups(worklogId, siteId)` 훅으로 대기 목록 fetch.
  - 항목 카드 + “연결” 버튼 → `POST /api/drawings/link`.
  - 연결 성공 시 토스트, 리스트 갱신.
- [ ] 업로드 내역 리스트: 사진 탭의 `UploadHistory` 컴포넌트를 확장해 도면 필드 맞춤화.

### 4.4 도면마킹도구 ↔ 관리 화면 연동

- [ ] 마킹도구에서 저장 시 `pending` 상태로 저장하도록 수정.
- [ ] 저장 직후 사용자에게 “사진·도면 관리 > 도면 탭에서 작업일지와 연결하세요” 안내 토스트.
- [ ] 도면 탭에서 연동 완료하면 마킹도구 측에서도 상태를 “연동 완료”로 표시할 수 있도록 API 응답을 공유.

### 4.5 QA/테스트 플로우

- [ ] 로컬 업로드 → 즉시 도면 리스트 반영 여부.
- [ ] 마킹도구 저장 → 도면 탭의 pending 리스트 등장 → 작업일지 연결 → 리스트에서 제거/연결 내역 반영.
- [ ] 필터/검색/작업일지 전환 시 상태 유지 확인.
- [ ] 권한 없는 작업일지/현장에 접근 시 UI/API에서 차단.

## 5. 마이그레이션/릴리즈 고려

- 기능 릴리즈 전 `drawing_markups`(가칭) 테이블의 기존 데이터에 `status='linked'` 업데이트.
- 도면마킹도구와 도면 탭이 동시에 배포되어야 하므로 feature flag를 두어 점진적 롤아웃 가능하게 한다.
- 사용자 가이드 업데이트: “도면마킹도구에서 저장한 후 작업일지에 연결하는 절차” 안내.

---

위 계획을 기반으로 구현하면, 사용자가 동일한 화면에서 작업일지별 도면을 관리하면서 도면마킹도구 결과까지 자연스럽게 연동할 수 있다. 사진 탭과 일관된 UX로 작업자/관리자의 학습 부담도 낮아진다.
