# DY1008 · 도면마킹 도구 구현 계획안

작성일: 2025-10-08

## 1) 개요

- 목표: 시스템관리자 화면 > 도면마킹 도구 구현 마무리(스탬프 포함), 기존 소스 최대 재사용, 관리자 UI 톤앤매너 일관성 유지.
- 범위: 공용 에디터(모바일/관리자 공유), 저장/불러오기 API 연동, 기본 도구(선택/스탬프/박스/텍스트/펜/팬/줌), Undo/Redo, 관리자 진입 동선.

## 2) 현재 상태 요약

- 데이터/API는 준비됨
  - 목록/조회/저장/업데이트/삭제 엔드포인트:
    - `app/api/markup-documents/route.ts:1`
    - `app/api/markup-documents/[id]/route.ts:1`
  - Admin 액션/페이지로 목록·상세 관리 가능:
    - `app/actions/admin/markup.ts:1`
    - `app/dashboard/admin/documents/markup/page.tsx:1`
    - `app/dashboard/admin/documents/markup/[id]/page.tsx:1`

- 에디터 UI는 뼈대(placeholder)
  - 공용 에디터/캔버스/툴바/다이얼로그:
    - `components/markup/SharedMarkupEditor.tsx:1`
    - `components/markup/markup-editor.tsx:1`
    - `components/markup/canvas/markup-canvas.tsx:1`
    - `components/markup/toolbar/top-toolbar.tsx:1`
    - `components/markup/toolbar/tool-palette.tsx:1`
    - `components/markup/toolbar/bottom-statusbar.tsx:1`
    - `components/markup/dialogs/*.tsx:1`
  - 모바일 마킹 페이지는 에디터를 포함하도록 되어 있으나, 현 시점엔 실제 마킹 불가:
    - `app/mobile/markup-tool/page.tsx:1`

- 타입/훅 기반은 마련됨
  - 객체/도구/스탬프 타입 및 전역 상태: `types/markup.ts:1`
  - 편집/뷰어/저장 훅:
    - `components/markup/hooks/use-markup-tools.ts:1` (undo/redo/복붙/삭제)
    - `components/markup/hooks/use-canvas-state.ts:1` (zoom/pan)
    - `components/markup/hooks/use-file-manager.ts:1` (저장/열기)

- 관리자 화면 톤앤매너 가이드 존재
  - PageHeader/Card/Table/Badge 등(shadcn 기반):
    - `components/ui/page-header.tsx:1`, `components/page-header.tsx:1`
    - `components/admin/MarkupDocumentsTable.tsx:1`
  - 도구 > 마크업 도구는 안내용 페이지: `app/dashboard/admin/tools/markup/page.tsx:1`

## 3) 재사용할 기존 소스 (핵심)

- 타입/도구 설계(스탬프 포함): `types/markup.ts:1`
  - 스탬프 속성(shape: circle/triangle/square/star, size: small/medium/large, color)
  - 박스 색·라벨 프리셋(자재구간/작업진행/작업완료)
  - 도구 집합(select/box/text/pen/stamp/pan/zoom in/out)
- 편집·뷰어·저장 훅 재사용:
  - `use-markup-tools`, `use-canvas-state`, `use-file-manager`
- 모바일 도면 선택 브라우저(초기 데이터 구성):
  - `modules/mobile/components/markup/DrawingBrowser.tsx:1`
- 관리 동선/허브 연계:
  - 목록/상세: `app/dashboard/admin/documents/markup/*`
  - 허브 → 마킹 도구 이동 브리지: `app/documents/hub/page.tsx:840`

## 4) 부족/미구현 항목

- 에디터 본체(이벤트/히트테스트/렌더링) 미구현
- 도구 팔레트/상단 툴바/상태바 동작 미연결
- 스탬프/박스/펜/텍스트의 배치·수정 UX 부재
- 관리자에서 “에디터로 열기/편집” 진입 동선 미비(상세에 버튼 필요)
- 프리뷰 생성·업로드 로직 공용화 미적용(모바일 페이지에만 보유)

## 5) 설계/적용 방안

### 5.1 렌더링/이벤트 아키텍처

- 1차: DOM+SVG 오버레이(의존성 추가 없이 빠르게 구축)
  - 배경: 도면 `<img>`
  - 오버레이: `<svg>`에 스탬프/박스/펜 path/텍스트 절대좌표 렌더
  - Pan/Zoom: 컨테이너 CSS transform(scale/translate), 좌표 역변환 유틸 통일
- 2차(선택): `react-konva`로 전환하여 성능/히트테스트 고도화

### 5.2 공용 에디터 구현(모바일/관리자 공유)

- `components/markup/SharedMarkupEditor.tsx`에 에디터 컨테이너 및 상태 연동 구현
- 하위 구성요소 연결
  - 상단 툴바: 저장/되돌리기/다시하기/줌/공유 등 → `toolbar/top-toolbar.tsx`
  - 도구 팔레트: select/stamp/box/text/pen/pan/zoom-in/out → `toolbar/tool-palette.tsx`
  - 캔버스: 배경+SVG 오버레이 → `canvas/markup-canvas.tsx`
  - 상태바: 좌표/줌/선택수 → `toolbar/bottom-statusbar.tsx`
- 상태/로직
  - 전역 상태: `types/markup.ts:1`
  - 도구 동작: `use-markup-tools`, 뷰어 동작: `use-canvas-state`
  - 저장/열기: `use-file-manager`(REST API 연동)

### 5.3 스탬프 구현

- 팔레트에서 shape/size/color 설정 → `toolState.stampSettings`
- 캔버스 클릭 시 뷰어 transform을 역적용하여 월드 좌표 산출 → `StampMarkup` 생성 후 push
- UndoStack/RedoStack 정상 갱신, 선택 상태 동기화

### 5.4 박스/텍스트/펜

- 박스: 드래그로 width/height 산출, 색/라벨 프리셋 적용
- 텍스트: 클릭 → 인라인 입력 → 완료 시 객체 추가, 폰트/색 간단 옵션
- 펜: pointerdown/move/up으로 path 기록, strokeColor/Width 옵션 제공

### 5.5 선택/변환

- 선택: bbox 기반 히트테스트, Shift 멀티 선택
- 이동: 드래그 변환, 삭제/복사/붙여넣기 `use-markup-tools` 재사용
- (2차) 리사이즈/회전 핸들, 스냅/그리드

### 5.6 저장/불러오기/동선

- 신규 저장: `POST /api/markup-documents` → `use-file-manager`
- 기존 문서 열기/수정: `GET/PUT /api/markup-documents/[id]`
- 관리자 상세에 “에디터로 열기” 버튼 추가(새 탭/뷰·편집 모드)
- (선택) 프리뷰 생성·업로드 공용화(모바일의 `generatePreviewAndUpload` 로직 이식)

### 5.7 관리자 화면 톤앤매너

- 상단 `PageHeader` + 우측 액션([저장][게시][목록])
- 본문 Card/Border/Muted-foreground 색상 준수(shadcn 스타일)

## 6) 1차 구현 범위(Deliverables)

- 공용 에디터(
  - 도구: 선택/스탬프/박스/텍스트/펜/팬/줌
  - 상태: Undo/Redo/선택/Clipboard
  - 캔버스: 배경 이미지 + SVG 오버레이, Pan/Zoom with transform
    )
- 저장/불러오기 API 연동(신규/기존) 및 마킹 개수 업데이트 연동
- 관리자 상세 페이지에 “에디터로 열기” 버튼 추가
- 모바일 `/mobile/markup-tool`에서 공용 에디터를 사용하도록 연결(동일 UX)

## 7) 2차 개선 항목

- 객체 변환 핸들(리사이즈/회전), 스냅/그리드/가이드라인
- 프리뷰 자동 생성/업로드(게시 시 필수화)
- 다이얼로그(저장/열기/공유) 실제 동작 연결
- 협업/공유(권한/이력/버전) 연계 고도화

## 8) 리스크/주의사항

- 좌표 변환 정확도: Pan/Zoom과 월드 좌표 역변환 일관성 보장 필요
- 성능: SVG 대량 객체에서 성능 저하 시 Konva 전환 고려
- 터치 제스처: 모바일에서 펜/팬 충돌 방지(두 손가락 팬/줌 정책 등)
- DB/RLS: location 제거 후 통합 정책 반영됨(MARKUP_DOCUMENTS_FIX 요약 참조), API 스키마 준수

## 9) 일정/공수(예상)

- 1차(기능 완성 + 톤앤매너 적용): 3–5일
  - 에디터 코어/도구/이벤트: 2–3일
  - 저장/열기/버튼/상태바: 0.5–1일
  - 관리자 동선/QA: 0.5–1일
- 2차(프리뷰/변환 핸들/고급 UX): 2–4일

## 10) 테스트 계획

- 단위 검증
  - 도구별 배치/수정/삭제/Undo/Redo 동작
  - Pan/Zoom 상태에서의 좌표 정확도
  - 저장 후 API 응답(markup_count) 일치
- 통합 시나리오
  - 모바일: 도면 선택 → 마킹 → 저장/게시 → 최근 마킹 확인
  - 관리자: 목록 → 상세 → 에디터로 열기 → 수정/저장 → 목록 갱신

## 11) 다음 단계

- 공용 에디터(`components/markup/SharedMarkupEditor.tsx`) 구현 착수
- 관리자 상세에 “에디터로 열기” 액션 추가
- 스탬프 기본 프리셋 확정 요청: 색상/사이즈/모양(예: red/medium/circle)
