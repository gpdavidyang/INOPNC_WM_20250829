# DY1008 기성청구 관리 구현 계획안

## 1) 목적 / 배경

- 현장 단위로 기성(착수→진행→완료) 과정에서 필요한 문서를 누락 없이 준비·관리.
- 본사관리자·시스템관리자 전용 데스크탑 화면에서 CRUD/버전관리/요약을 일관되게 제공.
- 소속사(시공사)별로 현장과 문서 현황을 가로단위로 조회 가능하도록 제공.
- 기존 문서 인프라(unified_document_system, 서명 URL, 스토리지 경로)를 재사용해 영향 최소화.

## 2) 범위 / 비범위

- 범위
  - 관리자 전용: admin, system_admin만 접근
  - 문서 업로드/다운로드/보기, 버전관리(Set current/Archive), 삭제(관리자 권한)
  - 현장별 체크리스트, 전체 요약 보드, 문서 목록, 소속사(시공사) 필터
  - 내보내기(현장 패키지 ZIP)
- 비범위(이번 단계 제외)
  - 승인/반려 워크플로우 및 UI
  - partner/site_manager 전용 접근/권한 처리(내부 화면만 고려)

## 3) 용어 / 분류 체계

- 문서 타입(doc_type)
  - estimate(견적서), construction_plan(시공계획서), e_tax_invoice(전자세금계산서),
    photo_grid(사진대지), contract(계약서), completion_certificate(작업완료확인서),
    progress_drawing(진행도면), other(기타)
- 단계(stage): start(착수), progress(진행), completion(완료)
- 상태(status): uploaded, archived(구버전/숨김) — 승인/반려 없음
- 버전: parent_id, version, is_current로 최신 활성 버전 지정

### 단계별 필수 문서(기본 템플릿)

- 착수: estimate, construction_plan, contract
- 진행: progress_drawing, photo_grid(선택), other(선택)
- 완료: completion_certificate, e_tax_invoice, photo_grid

> 템플릿은 화면 ‘설정’에서 프로젝트 정책에 맞게 on/off 가능(선택사항).

## 4) 데이터 모델 / 저장소

- 문서유형 레지스트리(설정 CRUD)
  - 테이블: `invoice_document_types`
    - `id uuid pk`, `code text unique not null`(내부 식별자, 고정), `label text not null`, `description text`,
      `is_required_start bool default false`, `is_required_progress bool default false`, `is_required_completion bool default false`,
      `allow_multiple_versions bool default true`, `allowed_mime_types text[] null`, `sort_order int default 0`,
      `is_active bool default true`, `scope text default 'global'`, `organization_id uuid null`
    - 운영 정책: code는 생성 후 변경 금지(라벨은 변경 가능), 삭제 대신 `is_active=false` 소프트 비활성화
  - 기본 시드: estimate, construction_plan, e_tax_invoice, photo_grid, contract, completion_certificate, progress_drawing, other
- 문서 저장: unified_document_system 재사용 (category_type='invoice')
  - 핵심 필드: id, site_id, category_type, title, file_url, file_name,
    metadata(jsonb), created_by, created_at, updated_at, is_archived
  - metadata 확장(스키마 예):
    ```json
    {
      "doc_type": "construction_plan",
      "stage": "start",
      "version": 3,
      "parent_id": "uuid-of-family",
      "is_current": true,
      "notes": "비고",
      "organization_id": "uuid-of-contractor" // 시공사 필터링 지원
    }
    ```
- 스토리지 경로 권장: `invoice/{siteId}/{doc_type}/v{n}/{filename}`
- 인덱스 권장: (category_type, site_id), (metadata->>'doc_type'), (metadata->>'stage'), (metadata->>'organization_id'), (metadata->>'is_current')

## 5) API 설계 (관리자 전용)

- 공통: 관리자 보호 미들웨어 적용(requireAdminProfile)
- 문서 CRUD/버전
  - POST `/api/invoice`
    - form-data: file, site_id, doc_type, stage, organization_id(optional)
    - 동작: family(parent_id) 자동 결합, version+1, is_current=true, 이전 is_current=false
  - PATCH `/api/invoice/:id`
    - body: { is_current?, title?, notes?, is_archived? }
  - DELETE `/api/invoice/:id`
- 조회/요약
  - GET `/api/invoice/summary?stage?&site_id?&organization_id?&from?&to?`
    - 응답: 현장×문서타입 매트릭스 + 현장별 진행률(필수 충족도)
  - GET `/api/invoice/site/:siteId?stage?` → 해당 현장 문서 + 버전 목록
  - GET `/api/invoice/list?site_id?&organization_id?&doc_type?&stage?&q?&page?&limit?`
- 내보내기
  - GET `/api/invoice/export?site_id=...` → 최신 활성 버전만 ZIP 패키지

- 문서유형(설정) CRUD
  - GET `/api/invoice/types` → 활성/비활성 포함 목록, 정렬 포함
  - POST `/api/invoice/types` → { code, label, stageRequired: {start,progress,completion}, allowMultipleVersions?, allowedMimeTypes?, sortOrder?, isActive? }
  - PATCH `/api/invoice/types/:id` → 라벨/필수단계/버전정책/정렬/활성화 토글 등 수정(code 변경 불가)
  - DELETE `/api/invoice/types/:id` → 소프트 삭제 처리(is_active=false)

> 기존 `/api/unified-documents/v2`를 확장해도 무방. 단, `category_type=invoice` 고정 및 `doc_type, stage, organization_id` 필터를 공식 지원.

## 6) 화면 설계 (App Router)

경로: `/dashboard/admin/documents/invoice`

- 상단 PillTabs(공용): 요약 | 현장별 | 문서목록 | 설정(선택)

### A. 요약(대시보드)

- KPI 카드: 진행 중 현장수, 100% 충족 현장수, 부족 서류 현장수, 총 업로드 수
- 필터: 기간, 소속사(organization), 단계(stage)
- 매트릭스: [현장] × [문서타입]
  - 셀 상태: 없음(회색) / 업로드됨(파랑) / 구버전(노랑)
  - 셀 클릭 → 오른 패널 Drawer: 해당 타입의 버전 리스트(미리보기/다운로드/버전 지정)
- 빠른 액션: 현장 패키지 내보내기, 템플릿 안내

### B. 현장별

- 헤더: 현장 정보 + 진행률(필수 충족도), 단계 필터(PillTabs)
- 체크리스트 카드: 문서타입별 1장씩
  - 표시: 최신 버전명/업로더/업로드일, 상태 뱃지, 주석
  - 버튼: 업로드, 미리보기, 다운로드, 버전(히스토리)
- 버전 히스토리: is_current 지정, 메모, 파일 이동/삭제(관리자)

### C. 문서목록(테이블)

- 컬럼: 등록일, 현장, 소속사, 문서타입, 단계, 버전, 업로더, 동작
- 필터: 현장, 소속사, 문서타입, 단계, 기간, 검색어
- 일괄 다운로드 지원

### D. 설정(문서유형 관리 + 템플릿)

- 문서유형 레지스트리 CRUD 테이블(정렬/활성화/필수단계 토글/버전 정책)
- 단계별 필수 문서 템플릿 on/off (레지스트리 기반으로 체크박스 구성)

## 7) 권한 / 접근 제어

- admin, system_admin만 접근(SSR 단계에서 차단)
- 파트너/현장관리자 고려하지 않음(요구사항 제외)

## 8) 소속사(시공사)별 조회

- 방법 1(권장): 문서 metadata.organization_id 저장 → 필터/요약에서 바로 사용
- 방법 2: site_partners(현장-시공사 매핑) 조인으로 추론
- 화면 필터에 소속사 선택(Autocomplete)

## 9) 구현 단계(마일스톤)

1. 라우팅/스켈레톤
   - 페이지 골격 + PillTabs 적용(요약/현장별/목록/설정)
   - 접근 제어(requireAdminProfile) 적용
2. 도메인 상수/유틸
   - doc_type, stage 상수, 단계별 필수 문서 맵
   - 진행률 계산 유틸(필수 충족도)
3. 데이터/메타 저장
   - metadata에 {doc_type, stage, version, parent_id, is_current, organization_id} 표준화
   - 업로드 시 family 결합 + 버전 자동 증가
4. 설정(문서유형 레지스트리)
   - 테이블 `invoice_document_types` 마이그레이션 + 기본 시드
   - API: GET/POST/PATCH/DELETE `/api/invoice/types`
   - UI: 설정 탭에서 문서유형 목록/생성/수정/비활성화/정렬
5. API
   - GET /api/invoice/summary (매트릭스 + 진행률)
   - GET /api/invoice/site/:siteId, GET /api/invoice/list
   - POST /api/invoice, PATCH /api/invoice/:id, DELETE /api/invoice/:id
   - 서명 URL/파일 체크 기존 라우트 재사용
6. UI – 요약
   - KPI 카드 + 매트릭스 + Drawer(문서 패널)
   - 소속사/단계/기간 필터 동작
7. UI – 현장별 체크리스트
   - 카드형 리스트 + 업로드/버전/다운로드
   - 진행률 뱃지
8. UI – 문서목록
   - 테이블 + 필터 + 일괄 다운로드
9. 내보내기
   - 현장 패키지 ZIP(최신 is_current만)
10. QA/테스트

- 가짜 데이터로 E2E 시나리오: 업로드→버전→요약 진행률 확인→ZIP 내보내기

## 10) 성공 기준(운영 지표)

- 현장 필수 문서 충족률(전달 대비↑)
- 부족 문서 현장수(전달 대비↓)
- 문서 업로드/버전 변경 평균 시간(↓)
- 소속사 필터 사용 빈도/조회 속도(응답 < 500ms @ 1만건 규모 인덱스 적용 시)

## 11) 리스크 / 대응

- 문서타입 정의 변경 → 설정 탭에서 온오프 지원(기본 템플릿 유지)
- 대용량 버전 히스토리 → is_current 중심 조회 + 페이지네이션
- 파일 보관/이관 → storage prefix 기준으로 정리, 서버 내보내기시 signed URL/stream 사용

---

본 계획안은 승인/반려 워크플로우를 제외하고, 관리자 중심의 기성 문서 준비·확인·집계에 초점을 둡니다. 1~3단계까지 완료 후, 실사용 피드백을 반영해 설정 탭/내보내기 고도화를 차례로 진행합니다.
