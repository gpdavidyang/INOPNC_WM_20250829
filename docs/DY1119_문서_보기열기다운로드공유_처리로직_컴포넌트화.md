# DY1119 문서 보기/열기/다운로드/공유 처리 로직 컴포넌트화 제안

## 1. 배경과 문제점

- **다수 화면에서 중복 구현**: 모바일/데스크톱/관리자 화면마다 “보기/다운로드” 버튼 로직이 따로 존재해 유지보수가 어렵고, 한 곳의 버그가 다른 화면에도 반복 발생.
- **저장 경로 파싱 오류**: 문서 레코드에 `storage_bucket`·`storage_path`가 빠지거나 URL에 쿼리 파라미터가 붙어 있을 때 각 화면별 파싱 로직이 실패해 `404 Object not found` 발생.
- **서명 URL 호출 방식 불일치**: 어떤 화면은 기존 공개 URL을 사용하고, 다른 화면은 새로운 API를 호출하는 등 방식이 통일되지 않아 디버깅 시 원인 추적이 어렵다.
- **에러 처리 일관성 부재**: 실패 시 사용자에게 주는 안내 메시지와 재시도 로직이 화면마다 달라 UX가 불균형.

## 2. 개선 목표

1. **파일 접근 메타데이터 일원화**: 모든 문서 레코드에서 `storage_bucket`과 `storage_path`를 보장해 클라이언트가 추가 파싱 없이 사용.
2. **미리보기/다운로드 로직 단일화**: 하나의 헬퍼와 컴포넌트를 통해 서명 URL 생성, 열기/공유/다운로드, 에러 처리를 공통으로 수행.
3. **데이터 신뢰도 향상**: 업로드 과정과 DB 제약으로 메타데이터 누락을 방지하고, 기존 누락분은 백필.
4. **유지보수 비용 절감**: 프리뷰 로직을 공용 컴포넌트에서 관리해 새로운 화면 추가나 정책 변경 시 수정 지점을 최소화.

## 3. 제안 아키텍처

### 3.1 데이터 계층

- **업로드 API 개선**
  - `app/api/documents/route.ts` 등 모든 업로드 경로에서 `storage_bucket`=`documents`, `storage_path`=`documents/{user}/{safeName}`을 DB에 함께 저장.
  - Required 문서, Unified Document System 삽입 시에도 동일 소스에서 값을 받아 재사용.
- **DB 제약/트리거**
  - `documents`·`unified_document_system`·`user_document_submissions` 테이블에 `storage_bucket`/`storage_path` NOT NULL 제약(단, 레거시는 대응 후 적용).
  - 혹은 Supabase trigger로 삽입 시 비어 있으면 거부하거나 자동 보정.
- **백필 스크립트 운영**
  - `scripts/backfill-required-docs-storage.ts`를 확장해 모든 테이블에 대해 누락된 버킷/경로를 URL 기반으로 채움.
  - 실행 로그와 재실행 가능성을 문서화.

### 3.2 서버 API

- **단일 Signed URL 엔드포인트** (`/api/files/signed-url`)
  - 입력: `bucket`, `path`, `downloadName?`.
  - 출력: 일정 시간 유효한 signed URL.
  - 기존처럼 URL/쿼리 파싱 fallback은 유지하되, 정석은 bucket/path 직접 전달.
  - 서버는 service role 클라이언트를 이용해 404/403을 명확히 로깅하고, 실패 시 사용자에게 의미 있는 메시지 전송.
- **보조 헬퍼** (`lib/files/preview.ts`)
  - `buildFileRequest(documentRow)` → `{ bucket, path, downloadName }`
  - `fetchSignedUrl(request)` → `Promise<string>`
  - 위 함수를 모든 UI가 재사용.

### 3.3 클라이언트 컴포넌트

- **FilePreviewButton (예시)**
  - Props: `document`, `variant`(버튼 스타일), `mode`(open/download/share).
  - 내부에서 `useFilePreview` 훅을 사용: 상태 관리, 서명 URL fetch, 새 창 열기, 에러 토스트, 로딩 표시.
  - 모바일/데스크톱 모두 동일 컴포넌트를 import. 필요 시 디자인만 wrapping.
- **공유/다운로드 헬퍼**
  - Web Share API 지원 여부, multiple file fallback, 파일 저장 헬퍼(`saveBlobToDevice`) 등을 헬퍼에 통합.
  - 오류 시 `toast` 혹은 모달로 안내 메시지를 통일.

### 3.4 에러 처리 전략

- **404/403 구분**: Supabase 응답 코드를 기반으로 사용자 메시지를 세분화 (예: “파일이 삭제되었습니다”, “권한이 없습니다”).
- **재시도**: 서명 URL 실패 시 1회 재시도 후 fallback(원본 URL 또는 안내 메시지).
- **로깅**: `console.error` 외에 Sentry/LogRocket 등으로 중앙화해 어느 화면에서 실패했는지 추적.

## 4. 구현 계획

| 단계 | 작업               | 세부 내용                                                                                       |
| ---- | ------------------ | ----------------------------------------------------------------------------------------------- |
| 1    | 데이터 보강        | 백필 스크립트 실행 → 누락 버킷/경로 채우기. 업로드 API 수정 및 배포.                            |
| 2    | API 정비           | `/api/files/signed-url` 파라미터 검증 강화, 상세 로그 추가. `lib/storage/paths.ts` 정비.        |
| 3    | 헬퍼/컴포넌트 제작 | `useFilePreview`, `FilePreviewButton`, `FileShareButton` 등 컴포넌트 추가. Storybook/문서 포함. |
| 4    | 화면 적용          | 우선순위 화면(문서함, 관리자 필수서류, 모바일 문서함 등)부터 교체. 이후 전 화면 점진 적용.      |
| 5    | 문서화 & 교육      | 개발 가이드 작성: “문서 프리뷰는 반드시 공용 컴포넌트 사용”. 코드 리뷰 체크리스트 반영.         |

### 4.1 적용 대상 화면/컴포넌트 체크리스트

| 구분                    | 경로/컴포넌트                                                                                                                                                                                                                     | 역할 비고                  | 적용 상태                                                                                                                                                                   |
| ----------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | -------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 모바일 문서함           | `app/documents/hub/page.tsx` (내문서함/회사서류/현장공유/사진함 탭 전반)                                                                                                                                                          | 현장관리자·파트너 공용     | ✅ 내문서함/회사서류 탭 공용 프리뷰 완성                                                                                                                                    |
| 모바일 신규 UI          | `modules/mobile/pages/documents-page-v2.tsx`                                                                                                                                                                                      | 모바일 리뉴얼              | ✅ 공용 `FilePreviewButton`/미리보기 헬퍼 적용 완료                                                                                                                         |
| 모바일 사이트 정보      | `modules/mobile/components/site/SiteInfoPage.tsx` (공사장 문서/도면/사진)                                                                                                                                                         | 현장 문서/도면/사진 프리뷰 | ✅ 첨부 미리보기/다운로드 모두 `openFileRecordInNewTab`/`fetchSignedUrlForRecord` 사용                                                                                      |
| 모바일 작업일지/급여    | `modules/mobile/pages/attendance-page.tsx`, `modules/mobile/pages/salary-history-page.tsx`, `modules/mobile/worklog/...`, `components/attendance/salary-view.tsx`                                                                 | 현장 사진, 급여 전표 등    | ⚙️ 급여명세서 + 작업일지 상세 첨부 공용화 완료 · 편집 모달(FileUploadSection)과 `components/attendance/salary-view.tsx`는 파일 프리뷰 버튼이 존재하지 않아 추가 조치 불필요 |
| 문서 뷰어 모듈          | `components/documents/UnifiedDocumentViewer/*` (DetailModal, AdminView, GeneralView)                                                                                                                                              | 관리자/현장 문서           | ✅ DetailModal 공용화 완료 · AdminView/GeneralView/PartnerView 모두 DocumentDetailModal → `FilePreviewButton` 경유                                                          |
| 나의 문서함             | `components/documents/my-documents.tsx`                                                                                                                                                                                           | 개인 문서 업로드/보기      | ✅ 공용 미리보기/다운로드 헬퍼 적용 완료                                                                                                                                    |
| 관리자 문서 탭          | `components/admin/RequiredDocumentsTable.tsx`, `components/admin/required/RequiredManagerClient.tsx`, `components/admin/DocumentRequirementsTable.tsx`, `app/dashboard/admin/documents/company/page.tsx`                          | 필수서류/회사서류 관리     | ✅ RequiredDocumentsTable, RequiredManagerClient, 회사서류 페이지 모두 `openFileRecordInNewTab`/`fetchSignedUrlForRecord` 사용                                              |
| 관리자 계약/송장        | `components/admin/invoice/*` (InvoiceDocumentsManager, DocumentVersionsDialog 등)                                                                                                                                                 | 기성/송장 증빙             | ✅ InvoiceDocumentsManager & VersionsDialog + `InvoiceTabsClient` 모두 공용 헬퍼 사용                                                                                       |
| 관리자 일일보고         | `components/admin/daily-reports/DailyReportDetailClient.tsx`, `components/daily-reports/daily-report-detail.tsx`                                                                                                                  | 일일보고 첨부              | ⚙️ Admin/일반 상세뷰 공용 로직 적용                                                                                                                                         |
| 관리자 현장             | `components/admin/sites/SiteDetailTabs.tsx`, `components/admin/sites/SiteForm.tsx`                                                                                                                                                | 현장 문서/도면             | ✅ SiteDetailTabs + SiteForm 공유자료 보기 모두 공용 헬퍼 적용                                                                                                              |
| 관리자 급여             | `app/dashboard/admin/salary/*` (preview/page.tsx, SnapshotList 등)                                                                                                                                                                | 급여 전표 뷰어             | ⚙️ HTML 보기 버튼 공용 로직 적용 (payroll records 등 잔여 검토)                                                                                                             |
| 관리자 문서 관리 레거시 | `components/admin/legacy/documents/*` (DocumentManagement, MyDocumentsManagement, SharedDocumentsManagement, SharedDocumentsManagementUnified, EnhancedDocumentsView, PhotoGridDocumentsManagement, MarkupDocumentsManagement 등) | 레거시 영역 다수           | ⚙️ 주요 문서함 + 기성 서류 관리(`InvoiceDocumentsManagement`)까지 공용화 완료 · 사용자/도구 탭 등 잔여 페이지 검토 중                                                       |
| 기타 툴/기능            | `components/admin/DownloadLinkButton.tsx`, `components/admin/legacy/tools/*`, `components/admin/legacy/users/*` 등                                                                                                                | 툴킷/사용자 관리           | ⚙️ DownloadLinkButton 공용 헬퍼 적용 · 레거시 tools/users 검토 진행 중                                                                                                      |
| 전사 문서 시스템        | `components/documents/share-dialog.tsx`, `components/documents/documents-list.tsx`                                                                                                                                                | 공유 다이얼로그            | ✅ DocumentsList/ShareDialog 공용 로직 완료                                                                                                                                 |

## 5. 유지보수 지침

- 새 문서 관련 기능 개발 시 반드시 공용 헬퍼/컴포넌트를 사용하고, 임의로 `fetch` + `window.open`을 직접 구현하지 않는다.
- Supabase 버킷 구조 변경, 만료 시간 수정 등 정책 변경이 필요하면 `/api/files/signed-url`와 공용 헬퍼만 수정하면 전 화면이 자동 반영되는 구조를 유지.
- 주기적으로 백필 스크립트를 실행하거나 메타데이터 누락 여부를 모니터링하는 배치/대시보드를 설치해 즉시 대응한다.

---

이 문서는 “문서 파일 프리뷰/다운로드/공유” 기능이 여러 화면에서 동일하게 동작하도록 하기 위한 기준을 정리한다. 새로운 화면을 개발하거나 문제가 재발할 경우 본 문서를 참조해 공용 계층과 컴포넌트를 우선 검토한다. 필요한 스크립트나 코드 예제는 추후 추가 문서에 첨부할 예정이다.

## 6. 최근 구현 사항 및 다음 작업

### 6.1 요약된 구현 내역

- **모바일 문서함 – 회사서류 탭**: `CompanyTab`에 내려오는 목록을 `CompanyDoc` 타입으로 정의하고 `storage_bucket`/`storage_path`까지 함께 보관하도록 수정. `handlePreview`는 `openFileRecordInNewTab`을 호출하므로 동일한 버킷/경로 정규화와 `/api/files/signed-url` 호출 플로우를 재사용함.
- **DocumentsList 컴포넌트**: 검색·필터 로직을 `useMemo`로 정리하고 `DocumentListItem` 타입을 명문화. “다운로드” 버튼은 `openFileRecordInNewTab`을 통해 서명 URL을 가져온 뒤 열도록 변경되어 어느 경로에서 호출해도 동일한 프리뷰 경로를 보장.
- **체크리스트 업데이트**: 모바일 문서함 항목에 회사서류 탭까지 공용화 완료 사실을 기록했고, "전사 문서 시스템" 행은 DocumentsList와 ShareDialog가 모두 ✅로 승급됨.
- **ShareDialog**: 공유 다이얼로그가 `fetchSignedUrlForRecord`를 통해 안전한 링크를 선호적으로 확보하고, 복사/Kakao/SMS/이메일/네이티브 공유 모두 동일 URL을 사용하도록 개선됨. 링크 로딩/에러 상태도 UI에 표시.
- **SharedDocumentsManagement (레거시)**: 관리자 공유문서 테이블의 “다운로드” 버튼이 공용 프리뷰 헬퍼를 사용하도록 교체되어 `openFileRecordInNewTab` 경로로 정규화됨. 스토리지 메타데이터를 받아 fallback 없이 동일한 로직을 재사용할 수 있음.
- **EnhancedDocumentsView (레거시 통합 뷰)**: 그리드/테이블에서의 “보기/다운로드” 동작을 공용 헬퍼 기반으로 교체해, 사진대지를 제외한 모든 문서가 통일된 signed-url 플로우를 사용한다. 다운로드 버튼은 `fetchSignedUrlForRecord`를 통해 실제 저장 이름으로 내려받도록 개선됨.
- **SharedDocumentsManagementUnified**: 통합 공유문서 관리자 모달의 “다운로드/공유” 버튼이 공용 헬퍼를 사용해 signed URL을 생성하고, 링크 복사 역시 동일 경로를 재사용하도록 업데이트됨.
- **MyDocumentsManagement**: 개인 문서 목록의 다운로드 경로가 `fetchSignedUrlForRecord`를 사용해 안전한 링크로 교체되어, 파일 경로 필드가 달라도 일관된 미리보기·다운로드 플로우를 유지.
- **PhotoGridDocumentsManagement**: 사진대지 문서의 미리보기/다운로드 버튼이 사진대지 메타데이터가 없을 때 공용 헬퍼를 통해 Supabase 저장 파일을 열도록 fallback을 제공.
- **MarkupDocumentsManagement**: 마킹 문서 다운로드가 공용 서명 URL 헬퍼를 사용하게 되어, 관리자 레거시 UI에서도 동일한 서명 URL 정책을 따름.
- **MarkupToolManagement/사용자 문서 탭**: 마킹 도구 관리 화면은 원본 도면 다운로드가 서명 URL을 따르도록 조정했고, `UserDocumentsTab`은 가짜 PDF 대신 실제 저장 파일을 `openFileRecordInNewTab`/`fetchSignedUrlForRecord`로 열 수 있게 수정됨.
- **기타 관리자 도구 탭**: PhotoGrid·Markup Tool 등 나머지 관리자 도구에서도 공용 헬퍼를 사용하도록 이동 중이며, Admin 사용자 탭(UserDocumentsTab 등) 역시 동일 정책을 적용했다.
- **모바일 급여명세서 열람**: `attendance-page.tsx`와 `salary-history-page.tsx`의 “급여명세서 보기” 버튼이 공용 미리보기 헬퍼를 사용해 `/payslip/:user/:year/:month` 경로를 안전하게 연다.
- **모바일 작업일지 상세 첨부**: `WorkLogDetailModal`에서 사진/도면/확인서 첨부를 `openFileRecordInNewTab`으로 열 수 있어, 사용자와 관리자 모두 동일한 파일 접근 로직을 사용한다.
- **모바일 작업일지 편집 / 급여 상세 검토**: `WorkLogModal`·`FileUploadSection`·`components/attendance/salary-view.tsx`를 재점검해 파일 프리뷰 버튼이 없는 화면임을 확인, 별도 헬퍼 적용이 불필요함을 문서화.
- **관리자 계약/송장 탭**: `components/admin/invoice/InvoiceTabsClient.tsx`가 `openFileRecordInNewTab`과 `fetchSignedUrlForRecord`를 직접 사용하도록 리팩터링되어 요약/서류/설정 탭 모두 동일한 프리뷰 경로를 따른다.
- **관리자 현장 정보**: `components/admin/sites/SiteForm.tsx`의 공유자료 “보기” 버튼이 공용 미리보기 헬퍼를 통해 서명 URL을 생성하고, 실패 시에만 원본 URL로 폴백하도록 개선됐다.
- **레거시 기성청구 서류 관리**: `components/admin/legacy/documents/InvoiceDocumentsManagement.tsx` 목록의 “다운로드” 버튼이 공용 서명 URL 헬퍼를 사용해 레거시 관리자 화면에서도 동일한 안전 경로를 활용한다.
- **DownloadLinkButton 개선**: `components/admin/DownloadLinkButton.tsx`가 `fetchSignedUrlForRecord`를 사용해 파일을 내려받고, `/dashboard/admin/documents/*` 상세 페이지가 해당 버튼에 문서 메타데이터를 전달하도록 수정됐다.

### 6.2 남은 점검 항목

- **모바일 작업일지/급여**: 편집 모달(`WorkLogModal`/`FileUploadSection`)과 관리자 급여 상세(`components/attendance/salary-view.tsx`)는 프리뷰 버튼이 없어 조치 제외했으나, 추후 UI 변경 시 헬퍼 도입 필요 여부를 재검토한다.
- **관리자 일일보고**: `DailyReportDetailClient` 외에 일일보고 목록/작성 화면 등 다른 컴포넌트에서도 여전히 개별 `window.open` 사용이 있는지 확인 필요.
- **관리자 급여**: `app/dashboard/admin/salary/*` 중 급여 기록/리스트 화면에 공용 미리보기/다운로드 로직이 남아 있는지 점검해야 한다.
- **관리자 문서 관리 레거시**: 사용자/도구 탭 등 아직 리뷰하지 않은 레거시 UI(`components/admin/legacy/tools/*`, `components/admin/legacy/users/*`)를 차례로 확인한다.
- **기타 툴/기능**: DownloadLinkButton을 제외한 공용 버튼/모달(예: 공유/다운로드 전용 컴포넌트) 표준화는 향후 진행 과제로 남아 있으며, 다중 문서 공유 흐름 또한 동일 헬퍼를 사용하도록 정비해야 한다.

### 6.2 다음 단계 제안

1. **레거시 관리자 화면 교체**
   - `components/admin/legacy/documents/*`, `EnhancedDocumentsView`, `SharedDocumentsManagementUnified` 등 아직 `window.open(document.file_url)`을 직접 사용하는 화면에 공용 헬퍼를 적용.
   - 우선순위: 공유 문서함, 마킹 문서, 사진대지처럼 실제 사용 빈도가 높은 테이블부터 진행.
2. **다운로드/공유 버튼 표준화**
   - `FilePreviewButton` 외에 다운로드/공유 전용 컴포넌트(`FileDownloadButton`, `FileShareButton`)를 제작해 버튼 디자인만 맞추면 되도록 추상화.
   - 관리자/모바일 UI에서 해당 컴포넌트를 차례로 치환해 UX 및 코드 일관성을 확보.
3. **다중 문서 공유 흐름 정비**
   - `modules/mobile/components/documents/DocumentShareModal.tsx`, `modules/mobile/components/home/DrawingShareModal.tsx` 등 자체적으로 토스트/링크 생성을 처리하는 모달을 공용 share 헬퍼와 동일한 방식으로 리팩터링.
   - 공유 링크 생성 API/토스트 메시지도 문서화하여 사용자 경험을 통일.
