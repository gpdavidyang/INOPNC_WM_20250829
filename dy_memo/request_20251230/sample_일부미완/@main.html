<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>INOPNC - 통합 시스템 (Final Version)</title>
   
  <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" />
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.7.76/pdf.min.js"></script>

  <style>
    /* =================================================================
       [1. 메인 디자인 시스템 (기존 유지)]
       ================================================================= */
    :root {
      --font-main: "Pretendard Variable", Pretendard, -apple-system, BlinkMacSystemFont, system-ui, Roboto, sans-serif;
      --primary: #31a3fa; --primary-bg: #eaf6ff;        
      --header-navy: #1a254f; --navy-dark: #1a254f; --navy-btn: #1a254f; --btn-logout-bg: #1a254f;
      --text-main: #111111; --text-sub: #475569; --text-placeholder: #94a3b8;
      --border: #e2e8f0; --bg-body: #f2f4f6; --bg-surface: #ffffff; --bg-input: #ffffff; --bg-search-input: #f1f5f9; 
      --danger: #ef4444; --del-btn-bg: #fff1f2; --del-btn-text: #ef4444;
      --dotted-gray-bg: #f8fafc; --dotted-gray-border: #cbd5e1; --dotted-gray-text: #475569;
      --dotted-blue-bg: #eaf6ff; --dotted-blue-border: #31a3fa; --dotted-blue-text: #31a3fa;
      --dotted-mint-bg: #f0fdfa; --dotted-mint-border: #2dd4bf; --dotted-mint-text: #0f766e;
      --badge-alert-bg: #ef4444; --badge-update-bg: #31a3fa; --badge-info-bg: #1a254f;
      --header-height: 0px; /* 헤더 삭제로 0 처리 */
      --nav-height: 0px; /* 하단 네비 삭제로 0 처리 */
      --radius-card: 16px; --radius-input: 12px; --btn-clear-bg: #cbd5e1; --btn-clear-text: #ffffff;
      --shadow-soft: 0 4px 20px rgba(0,0,0,0.05); --h-common: 48px;
    }
    body.dark-mode {
      --primary: #31a3fa; --primary-bg: #1e293b;
      --header-navy: #f1f5f9; --navy-dark: #f1f5f9; --navy-btn: #3b82f6; --btn-logout-bg: #3b82f6; 
      --text-main: #f1f5f9; --text-sub: #94a3b8; --text-placeholder: #64748b;
      --border: #334155; --bg-body: #0f172a; --bg-surface: #1e293b; --bg-input: #0f172a; --bg-search-input: #1e293b;
      --danger: #ef4444; --del-btn-bg: #450a0a; --del-btn-text: #f87171;
      --dotted-gray-bg: #1e293b; --dotted-gray-border: #475569; --dotted-gray-text: #94a3b8;
      --dotted-blue-bg: #172554; --dotted-blue-border: #1e40af; --dotted-blue-text: #60a5fa;
      --dotted-mint-bg: #042f2e; --dotted-mint-border: #115e59; --dotted-mint-text: #2dd4bf;
      --shadow-soft: none;
    }
    html, body { margin: 0; padding: 0; width: 100%; height: 100%; -webkit-text-size-adjust: 100%; overflow-x: hidden; }
    /* padding-top, padding-bottom 제거 (헤더/네비 삭제 반영) */
    body { font-family: var(--font-main); font-size: 17px; color: var(--text-main); background-color: var(--bg-body); line-height: 1.6; padding-top: 20px; padding-bottom: 20px; transition: background-color 0.3s, color 0.3s; }
    button, select, input, textarea { font-family: var(--font-main); outline: none; -webkit-tap-highlight-color: transparent; }
    * { box-sizing: border-box; } a { text-decoration: none; color: inherit; }
    .app-wrapper { width: 100%; max-width: 600px; margin: 0 auto; padding: 0 16px; transition: opacity 0.3s; }
    .app-wrapper.hidden { display: none; }

    /* Header & Nav Removed */
    
    /* Quick Menu & Notice */
    .quick-menu-section { padding: 10px 0 20px 0; background-color: transparent; }
    .qm-header { display: flex; align-items: center; justify-content: space-between; gap: 6px; margin-bottom: 16px; padding-left: 4px; }
    .qm-title-icon-img { width: 20px; height: 20px; object-fit: contain; }
    .qm-title { font-size: 20px; font-weight: 700; color: var(--header-navy); letter-spacing: -0.5px; }
    body.dark-mode .qm-title { color: var(--text-main); }
    .qm-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 2px; width: 100%; }
    .qm-item { display: flex; flex-direction: column; align-items: center; gap: 6px; cursor: pointer; padding: 4px 0; width: 100%; transition: transform 0.12s ease-out; }
    .qm-item:hover { transform: translateY(-2px); }
    .qm-item:active { transform: translateY(0) scale(0.95); }
    .qm-item--event { border-radius: 14px; padding: 6px 0 10px; overflow: visible; }
    .qm-icon-wrapper { position: relative; display: inline-block; }
    .qm-main-icon { width: 46px; height: 46px; object-fit: contain; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.06)); }
    .qm-label { font-size: 13px; font-weight: 700; color: var(--text-main); text-align: center; line-height: 1.3; white-space: nowrap; letter-spacing: -0.5px; }
    .qm-badge { position: absolute; top: 0; right: 0; transform: translate(50%, -50%); min-width: 18px; height: 18px; padding: 0 5px; border-radius: 999px; color: #fff; font-size: 10px; font-weight: 900; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 6px rgba(0,0,0,0.25); border: 2px solid var(--bg-body); z-index: 10; line-height: 1; }
    .qm-item--event .qm-badge { display: flex !important; }
    .qm-badge.req { background: #8b5cf6; }
    .qm-badge.req.worklog { background: #16a34a; }
    .qm-badge.issue { background: #ef4444; }
    .qm-badge.hide { display: none !important; }
    /* 알림 배지 전용 이벤트 효과 */
    .qm-badge.req {
      animation: active-badge-pulse-req 1.6s infinite ease-out;
      transform-origin: 50% 50%;
    }
    .qm-badge.req.worklog {
      animation: active-badge-pulse-worklog 1.6s infinite ease-out;
      transform-origin: 50% 50%;
    }
    .qm-badge.issue {
      animation: active-badge-pulse-issue 1.6s infinite ease-out;
      transform-origin: 50% 50%;
    }
    @keyframes active-badge-pulse-req {
      0% { transform: translate(50%, -50%) scale(1); box-shadow: 0 0 0 0 rgba(139, 92, 246, 0.45); }
      30% { transform: translate(50%, -50%) scale(1.06); box-shadow: 0 0 0 6px rgba(139, 92, 246, 0); }
      60% { transform: translate(50%, -50%) scale(1.02); box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.12); }
      100% { transform: translate(50%, -50%) scale(1); box-shadow: 0 0 0 0 rgba(139, 92, 246, 0); }
    }
    @keyframes active-badge-pulse-worklog {
      0% { transform: translate(50%, -50%) scale(1); box-shadow: 0 0 0 0 rgba(22, 163, 74, 0.45); }
      30% { transform: translate(50%, -50%) scale(1.06); box-shadow: 0 0 0 6px rgba(22, 163, 74, 0); }
      60% { transform: translate(50%, -50%) scale(1.02); box-shadow: 0 0 0 3px rgba(22, 163, 74, 0.12); }
      100% { transform: translate(50%, -50%) scale(1); box-shadow: 0 0 0 0 rgba(22, 163, 74, 0); }
    }
    @keyframes active-badge-pulse-issue {
      0% { transform: translate(50%, -50%) scale(1); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.45); }
      30% { transform: translate(50%, -50%) scale(1.06); box-shadow: 0 0 0 6px rgba(239, 68, 68, 0); }
      60% { transform: translate(50%, -50%) scale(1.02); box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.12); }
      100% { transform: translate(50%, -50%) scale(1); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
    }
    @keyframes pulse-error { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
    .section-error-highlight { animation: pulse-error 1.5s ease-in-out 3 !important; }
    .qm-cta { background: #f1f5f9; color: #475569; border: 1px solid #cbd5e1; border-radius: 12px; padding: 8px 14px; font-size: 14px; font-weight: 700; cursor: pointer; display: flex; align-items: center; gap: 6px; transition: 0.15s; }
    .qm-cta:active { transform: scale(0.98); opacity: 0.9; background: #e2e8f0; }
    /* Notice styles removed from HTML but CSS kept for safety if re-added later, or could be removed */
    .notice-slider-container { background: var(--bg-surface); border-radius: 12px; box-shadow: var(--shadow-soft); border: none; height: 52px; margin-bottom: 16px; position: relative; overflow: hidden; display: flex; align-items: center; padding: 0 16px; cursor: default; transition: background-color 0.3s; }
    body.dark-mode .notice-slider-container { border: 1px solid var(--border); box-shadow: none; }
    .notice-wrapper { position: relative; width: 100%; height: 100%; display: flex; align-items: center; }
    .notice-item { position: absolute; width: 100%; display: flex; align-items: center; gap: 10px; opacity: 0; transform: translateX(100%); transition: transform 0.5s ease, opacity 0.5s ease; pointer-events: none; }
    .notice-item.active { opacity: 1; transform: translateX(0); }
    .notice-item.prev { opacity: 0; transform: translateX(-100%); }
    .notice-badge { font-size: 11px; font-weight: 700; padding: 4px 8px; border-radius: 6px; white-space: nowrap; color: #fff; }
    .badge-alert { background: var(--badge-alert-bg); } .badge-update { background: var(--badge-update-bg); } .badge-info { background: var(--badge-info-bg); }
    .notice-text { font-size: 14px; font-weight: 500; color: var(--text-main); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; flex: 1; }

    /* Forms */
    .card-box { background: var(--bg-surface); border-radius: 16px; padding: 24px 20px; margin-bottom: 16px; box-shadow: var(--shadow-soft); border: none; }
    body.dark-mode .card-box { border: 1px solid var(--border); box-shadow: none; }
    .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
    .section-title { font-size: 20px; font-weight: 700; color: var(--header-navy); letter-spacing: -0.3px; }
    body.dark-mode .section-title { color: var(--text-main); }
    .required { color: var(--danger); margin-left: 2px; font-size: 18px; vertical-align: top; }
    .required-badge {
      font-size: 13px;
      font-weight: 700;
      color: var(--del-btn-text);
      background-color: var(--del-btn-bg);
      height: 32px;
      padding: 0 14px;
      border-radius: 12px;
      border: none;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      white-space: nowrap;
      flex-shrink: 0;
    }
    .divider { height: 1px; background-color: var(--border); margin: 24px -20px; }
    .form-group { margin-bottom: 16px; }
    .form-label { display: block; font-size: 17px; color: var(--text-sub); margin-bottom: 8px; font-weight: 700; }
    .form-sub-hint { font-size: 12px; color: var(--text-sub); margin-top: -4px; margin-bottom: 6px; font-weight: 500; line-height: 1.4; }
    .form-sub-hint { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .section-title .form-sub-hint { margin: 0; font-size: 12px; }
    .form-input { width: 100%; height: 54px; padding: 0 16px; border: 1px solid var(--border); border-radius: 12px; font-size: 17px; color: var(--text-main); background: var(--bg-input); font-weight: 500; transition: all 0.2s; }
    
    /* Select Box 스타일 (상단헤더 디자인 이식) */
    .form-select {
      appearance: none;
      -webkit-appearance: none;
      width: 100%;
      height: 54px; /* 높이 변경 */
      background-color: var(--bg-input);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 0 40px 0 16px; /* 화살표 공간 확보 */
      font-family: var(--font-main);
      font-size: 17px;
      font-weight: 500;
      color: var(--text-main);
      
      /* 커스텀 SVG 화살표 (진한 회색) */
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='18' height='18' viewBox='0 0 24 24' fill='none' stroke='%23333333' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 14px center;
      background-size: 18px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    /* 날짜 입력 필드에 캘린더 아이콘 적용 */
    input[type="date"].form-input {
      position: relative;
      padding-right: 44px;
      -webkit-appearance: none;
      appearance: none;
      background-image: none;
    }
    input[type="date"].form-input::-webkit-calendar-picker-indicator {
      position: absolute;
      right: 14px;
      width: 18px;
      height: 18px;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='18' height='18' viewBox='0 0 24 24' fill='none' stroke='%23333333' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Crect x='3' y='4' width='18' height='18' rx='2' ry='2'%3E%3C/rect%3E%3Cline x1='16' y1='2' x2='16' y2='6'%3E%3C/line%3E%3Cline x1='8' y1='2' x2='8' y2='6'%3E%3C/line%3E%3Cline x1='3' y1='10' x2='21' y2='10'%3E%3C/line%3E%3C/svg%3E");
      background-size: 18px;
      background-repeat: no-repeat;
      background-position: center;
      cursor: pointer;
      opacity: 1;
    }
    input[type="date"].form-input::-webkit-inner-spin-button,
    input[type="date"].form-input::-webkit-clear-button { display: none; }
    input[type="date"].form-input::-moz-focus-inner { border: 0; }
    body.dark-mode input[type="date"].form-input::-webkit-calendar-picker-indicator {
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='18' height='18' viewBox='0 0 24 24' fill='none' stroke='%2394a3b8' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Crect x='3' y='4' width='18' height='18' rx='2' ry='2'%3E%3C/rect%3E%3Cline x1='16' y1='2' x2='16' y2='6'%3E%3C/line%3E%3Cline x1='8' y1='2' x2='8' y2='6'%3E%3C/line%3E%3Cline x1='3' y1='10' x2='21' y2='10'%3E%3C/line%3E%3C/svg%3E");
    }

    /* Hover 효과 */
    .form-select:hover {
      border-color: #cbd5e1;
    }

    /* Focus 효과 (파란색 테두리 + 그림자) */
    .form-select:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(49, 163, 250, 0.15);
      outline: none;
    }

    /* 다크모드 대응 */
    body.dark-mode .form-select {
      /* 커스텀 SVG 화살표 (밝은 회색) */
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='18' height='18' viewBox='0 0 24 24' fill='none' stroke='%2394a3b8' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
    }
    .input-grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; }
    .input-grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; }
    .form-row-inline { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .form-col-half { display: flex; flex-direction: column; }
    .form-col-half .form-label { 
      white-space: nowrap; 
      overflow: hidden; 
      text-overflow: ellipsis; 
      max-width: 100%; 
    }
    .form-col-half .form-select,
    .form-col-half .form-input {
      min-width: 0;
      text-overflow: ellipsis;
    }
    @media (max-width: 480px) {
      .form-row-inline { 
        grid-template-columns: 1fr 1fr; 
        gap: 8px; 
      }
      .form-col-half .form-label { 
        font-size: 15px; 
        margin-bottom: 6px; 
      }
      .form-col-half .form-select,
      .form-col-half .form-input {
        font-size: 15px;
        padding: 0 12px;
      }
    }

    /* Work Set & Inputs */
    .work-set-item { background: #fff; border-radius: 16px; padding: 20px; margin-bottom: 16px; animation: slideDown 0.3s ease-out; border: 2px solid var(--primary); }
    body.dark-mode .work-set-item { background: var(--bg-input); border: 2px solid var(--primary); }
    .work-set-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .set-badge { font-size: 14px; font-weight: 700; color: var(--primary); background-color: var(--primary-bg); padding: 6px 12px; border-radius: 8px; }
    .chip-grid { display: flex; flex-wrap: wrap; gap: 8px; }
    .chip-grid.region-grid { 
      width: 100%; 
      display: grid;
      grid-template-columns: repeat(6, minmax(0, 1fr));
      gap: 6px; 
      padding-bottom: 2px;
    }
    .chip-grid.region-grid .select-chip { 
      width: 100%;
      min-width: 0;
      padding: 0 8px;
      font-size: 13px;
      height: 34px;
    }
    @media (max-width: 480px) {
      .chip-grid.region-grid { gap: 4px; }
      .chip-grid.region-grid .select-chip { 
        font-size: 12px; 
        padding: 0 6px; 
        height: 32px;
      }
    }
    .select-chip { height: 36px; background: var(--bg-surface); border: 1px solid var(--border); border-radius: 999px; color: var(--text-sub); font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s; padding: 0 16px; white-space: nowrap; display: inline-flex; align-items: center; justify-content: center; }
    .select-chip:hover { border-color: var(--primary); color: var(--primary); }
    .select-chip.active { border: 1px solid var(--primary); background-color: var(--primary-bg); color: var(--primary); font-weight: 700; box-shadow: 0 2px 4px rgba(49, 163, 250, 0.15); }
    body.dark-mode .select-chip.active { background-color: var(--primary-bg); }
    /* 부재명, 작업공정, 작업유형 선택칩 - 블럭 입력박스 스타일 */
    .work-set-item .chip-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; }
    .work-set-item .select-chip { height: 54px; background: var(--bg-input); border: 1px solid var(--border); border-radius: 12px; color: var(--text-sub); font-size: 17px; font-weight: 500; cursor: pointer; transition: all 0.2s; padding: 0 16px; display: flex; align-items: center; justify-content: center; white-space: nowrap; }
    .work-set-item .select-chip:hover { border-color: #cbd5e1; }
    .work-set-item .select-chip:focus { outline: none; box-shadow: none; }
    .work-set-item .select-chip.active { border: 1px solid var(--primary); background-color: var(--bg-surface); color: var(--primary); font-weight: 700; box-shadow: 0 2px 4px rgba(49, 163, 250, 0.15); }
    body.dark-mode .work-set-item .select-chip.active { background-color: var(--primary-bg); }
    .other-input-wrap { display: grid; grid-template-rows: 0fr; transition: grid-template-rows 0.3s; overflow: hidden; }
    .other-input-wrap.show { grid-template-rows: 1fr; }
    .other-input-inner { opacity: 0; transform: translateY(-10px); transition: 0.3s; min-height: 0; padding: 4px; margin-top: 4px; }
    .other-input-wrap.show .other-input-inner { opacity: 1; transform: translateY(0); }
    .manpower-row { 
      display: grid; 
      grid-template-columns: 1.35fr 1fr auto; 
      gap: 10px; 
      margin-bottom: 10px; 
      align-items: center; 
      animation: fadeIn 0.2s ease-out;
      background: var(--bg-surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px 12px 12px 12px;
    }
    .attachment-style-list { 
      min-height: 60px;
      border: 2px dashed var(--border);
      border-radius: 12px;
      padding: 12px;
      background: var(--bg-body);
    }
    .attachment-style-list:empty::before {
      content: "인원을 추가해주세요";
      display: block;
      text-align: center;
      color: var(--text-placeholder);
      font-size: 15px;
      padding: 20px 0;
    }
    .manpower-select-wrapper { position: relative; }
    .manpower-select-wrapper select { width: 100%; }
    .manpower-edit-btn { 
      background: none; 
      border: 1px solid var(--primary); 
      color: var(--primary); 
      padding: 4px 10px; 
      border-radius: 6px; 
      font-size: 13px; 
      cursor: pointer;
      margin-right: 4px;
    }
    .stepper { display: flex; width: 100%; height: var(--h-common); border: 1px solid var(--border); border-radius: var(--radius-input); background: var(--bg-input); overflow: hidden; }
    .stepper > * { flex: 1; display: flex; align-items: center; justify-content: center; border: none; background: transparent; }
    .btn-step { font-size: 20px; color: var(--text-sub); cursor: pointer; transition: 0.2s; }
    .btn-step:active { background: var(--bg-body); }
    .step-val { font-size: 16px; font-weight: 700; color: var(--text-main); border-left: 1px solid var(--bg-body); border-right: 1px solid var(--bg-body); min-width: 50px; text-align: center; }
    .mat-input-grid { display: grid; grid-template-columns: 1.8fr 1fr auto; gap: 10px; margin-bottom: 12px; align-items: center; }
    .mat-qty-wrapper { display: flex; align-items: center; background: var(--bg-input); border: 1px solid var(--border); border-radius: var(--radius-input); height: var(--h-common); padding: 0 12px; }
    .mat-qty-input { flex: 1; border: none; background: transparent; height: 100%; font-size: 16px; color: var(--text-main); font-weight: 500; text-align: right; padding-right: 4px; width: 100%; min-width: 0; }
    .mat-unit { flex-shrink: 0; color: var(--text-sub); font-size: 15px; font-weight: 500; margin-left: 4px; white-space: nowrap; }
    .btn-add-block { 
      width: 48px; 
      height: var(--h-common); 
      border: none;
      border-radius: 12px; 
      background: var(--primary-bg); 
      color: var(--primary); 
      font-size: 17px; 
      font-weight: 900;
      cursor: pointer; 
      display: flex; 
      align-items: center; 
      justify-content: center;
      transition: all 0.2s;
    }
    .btn-add-block:hover {
      background: #d1e9ff;
    }
    .btn-add-block:active {
      transform: scale(0.98);
      background: #b8dfff;
    }
    .mat-item { background: var(--bg-surface); border: 1px solid var(--border); border-radius: 12px; padding: 10px 14px; margin-bottom: 8px; font-size: 15px; display: flex; justify-content: space-between; align-items: center; animation: fadeIn 0.2s; }

    /* Summary & Buttons */
    .summary-body { max-height: 500px; overflow: hidden; transition: 0.3s; }
    .summary-body.collapsed { max-height: 0; opacity: 0; overflow: hidden; }
    .arrow-icon { width: 20px; height: 20px; color: var(--text-sub); transition: transform 0.3s; }
    .arrow-icon.collapsed { transform: rotate(0deg); }
    .sum-row { display: flex; justify-content: space-between; margin-bottom: 12px; align-items: center; flex-wrap: wrap; }
    .sum-key { font-size: 17px; color: var(--text-sub); font-weight: 700; }
    .sum-val { font-size: 17px; font-weight: 600; text-align: right; color: var(--text-main); }
    .btn-delete-capsule { background: var(--del-btn-bg); color: var(--del-btn-text); font-size: 14px; font-weight: 700; padding: 4px 10px; border-radius: 12px; cursor: pointer; border: none; height: 32px; }
    .btn-add-header { 
      border: none;
      background: var(--primary-bg); 
      color: var(--primary); 
      padding: 0 14px; 
      height: 32px; 
      border-radius: 12px; 
      font-size: 14px; 
      font-weight: 700; 
      cursor: pointer; 
      display: flex; 
      align-items: center; 
      gap: 6px;
      transition: all 0.2s;
    }
    .btn-add-header:hover {
      background: #d1e9ff;
    }
    .btn-add-header:active {
      transform: scale(0.98);
      background: #b8dfff;
    }
    .action-btn-row { display: flex; gap: 10px; margin-top: 32px; margin-bottom: 12px; }
    .floating-action-buttons {
      position: relative;
      display: flex;
      gap: 10px;
      z-index: 1000;
      background: transparent;
      padding: 0;
      border-radius: 0;
      box-shadow: none;
      border: none;
      transition: all 0.3s;
      margin: 0 auto 20px;
      max-width: 600px;
    }
    body.dark-mode .floating-action-buttons {
      box-shadow: 0 4px 20px rgba(0,0,0,0.5);
    }
    
    /* 필수 입력 완료 시 버튼 영역 표시 */
    .floating-action-buttons.ready-to-save {
      border: 2px solid #10b981;
      border-radius: 16px;
      padding: 16px 20px;
      background: linear-gradient(to bottom, #fff, rgba(16, 185, 129, 0.05));
      box-shadow: 0 4px 20px rgba(16, 185, 129, 0.3);
    }
    body.dark-mode .floating-action-buttons.ready-to-save {
      background: linear-gradient(to bottom, var(--bg-surface), rgba(16, 185, 129, 0.1));
      border-color: #10b981;
    }
    
    .ready-to-save-badge {
      position: absolute;
      top: -12px;
      left: 50%;
      transform: translateX(-50%);
      background: #10b981;
      color: #fff;
      font-size: 12px;
      font-weight: 700;
      padding: 4px 16px;
      border-radius: 20px;
      white-space: nowrap;
      box-shadow: 0 2px 8px rgba(16, 185, 129, 0.4);
      animation: slideDownFade 0.3s ease-out;
      z-index: 10;
    }
    @keyframes slideDownFade {
      from {
        opacity: 0;
        transform: translateX(-50%) translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
      }
    }
    
    .btn-save.ready {
      background: #10b981 !important;
      box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.2);
      animation: pulse-ready 2s ease-in-out infinite;
    }
    @keyframes pulse-ready {
      0%, 100% {
        box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.2);
      }
      50% {
        box-shadow: 0 0 0 6px rgba(16, 185, 129, 0.3);
      }
    }
    .btn-action { flex: 1; height: 50px; border-radius: 12px; border: none; font-size: 17px; font-weight: 700; cursor: pointer; transition: 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px; }
    .btn-reset { 
        background: #f1f5f9; 
        border: 1px solid #cbd5e1; 
        color: #475569; 
        transition: all 0.2s;
    }
    .btn-reset:hover {
        background: #e2e8f0;
    }
    body.dark-mode .btn-reset {
        background: #1e293b;
        border-color: #334155;
        color: #94a3b8;
    }
    body.dark-mode .btn-reset:hover {
        background: #334155;
    }
    .btn-save { 
        background: var(--header-navy); 
        color: #fff; 
        transition: all 0.2s;
    }
    .btn-save:hover {
        background: #2d3a5f;
    }
    body.dark-mode .btn-save { 
        background: var(--primary); 
    }
    body.dark-mode .btn-save:hover {
        background: #1d7fd9;
    }
    .uu-desc { font-size: 13px; color: var(--text-sub); margin-bottom: 14px; line-height: 1.4; margin-top: -6px; }
    .uu-btn-row { display: flex; gap: 10px; }
    .uu-btn { flex: 1; height: 48px; border-radius: 10px; font-size: 15px; font-weight: 700; display: flex; align-items: center; justify-content: center; gap: 8px; cursor: pointer; transition: 0.1s; }
    .uu-btn.dashed { border-style: dashed; border-width: 1px; }
    .uu-btn.solid { border-style: solid; border-width: 1px; }
    .uu-btn.dashed.type-gray { background-color: var(--dotted-gray-bg); border-color: var(--dotted-gray-border); color: var(--dotted-gray-text); }
    .uu-btn.dashed.type-blue { 
        background-color: var(--dotted-blue-bg); 
        border-color: var(--dotted-blue-border); 
        color: var(--dotted-blue-text); 
    }
    .uu-btn.dashed.type-blue:hover {
        background-color: #d1e9ff;
    }
    .uu-btn.dashed.type-mint { background-color: var(--dotted-mint-bg); border-color: var(--dotted-mint-border); color: var(--dotted-mint-text); }
    /* 회색 톤 버튼 스타일 (초기화 버튼과 동일) */
    /* 도면마킹 버튼용 포인트 컬러 (사진등록과 동일한 점선/굵기, 컬러만 민트톤) */
    .uu-btn.dashed.type-gray-secondary { 
      background-color: var(--dotted-mint-bg); 
      border-color: var(--dotted-mint-border); 
      color: var(--dotted-mint-text); 
    }
    .uu-btn.solid.type-gray-secondary { 
      background-color: var(--dotted-mint-bg); 
      border-color: var(--dotted-mint-border); 
      color: var(--dotted-mint-text); 
    }
    .uu-btn.dashed.type-gray-secondary:hover, 
    .uu-btn.solid.type-gray-secondary:hover { 
      background-color: #dcfce7; 
    }
    .uu-btn:active { opacity: 0.8; transform: scale(0.98); }

    /* Animations & Toast */
    @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes shake { 10%, 90% { transform: translate3d(-1px, 0, 0); } 20%, 80% { transform: translate3d(2px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-4px, 0, 0); } 40%, 60% { transform: translate3d(4px, 0, 0); } }
    @keyframes pulse-error { 0%, 100% { background-color: rgba(239, 68, 68, 0.1); border-color: var(--danger); } 50% { background-color: rgba(239, 68, 68, 0.2); border-color: #dc2626; } }
    @keyframes bounce-attention { 0%, 100% { transform: translateY(0); } 25% { transform: translateY(-8px); } 75% { transform: translateY(-4px); } }
    .error-shake { animation: shake 0.4s cubic-bezier(.36,.07,.19,.97) both; border-color: var(--danger) !important; }
    .section-error-highlight { animation: pulse-error 1.5s ease-in-out 3; border: 2px solid var(--danger) !important; border-radius: 16px; padding: 20px; background-color: rgba(239, 68, 68, 0.05) !important; }
    
    /* 다음 단계 안내 효과 - 자동 스크롤 및 강조 (하늘색) */
    .next-step-guide {
      animation: nextStepPulse 2s ease-in-out 2;
      border: 2px solid #87CEEB !important;
      border-radius: 16px;
      padding: 20px;
      padding-top: 28px; /* 라벨 공간 확보 */
      background-color: rgba(135, 206, 235, 0.05) !important;
      box-shadow: 0 0 0 3px rgba(135, 206, 235, 0.15) !important;
      position: relative;
      z-index: 1;
      margin-bottom: 16px;
      overflow: visible;
      height: auto; /* 높이 자동 조절 보장 */
      min-height: auto;
    }
    .next-step-guide::before {
      content: '다음 단계';
      position: absolute;
      top: -12px;
      left: 50%;
      transform: translateX(-50%);
      background: #87CEEB;
      color: #fff;
      font-size: 12px;
      font-weight: 700;
      padding: 4px 12px;
      border-radius: 12px;
      white-space: nowrap;
      z-index: 30; /* 콘텐츠 위로 올라오도록 높은 z-index */
      pointer-events: none; /* 클릭 방해 방지 */
      animation: fadeInDown 0.3s ease-out;
    }
    /* 모바일에서 작업 공정 안내 박스와 선택칩 겹침 방지 */
    @media (max-width: 480px) {
      .next-step-guide {
        padding: 16px;
        padding-top: 32px; /* 모바일에서 라벨 공간 더 확보 */
        margin-bottom: 20px;
        margin-top: 8px;
        height: auto; /* 높이 자동 조절 보장 */
        min-height: auto;
        overflow: visible; /* 라벨이 잘리지 않도록 */
      }
      .next-step-guide .chip-grid {
        position: relative;
        z-index: 2;
        margin-top: 12px; /* 상단 라벨과의 물리적 거리 확보 */
      }
      .next-step-guide::before {
        font-size: 11px;
        padding: 3px 10px;
        top: -10px;
        z-index: 30; /* 콘텐츠 위로 올라오도록 */
        pointer-events: none; /* 클릭 방해 방지 */
      }
      /* 작업 공정 안내 박스 내부 선택칩이 박스를 벗어나지 않도록 */
      .next-step-guide .work-set-item .chip-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 6px;
        margin-top: 12px; /* 상단 여백 추가 */
      }
      .next-step-guide .work-set-item .select-chip {
        font-size: 15px;
        padding: 0 12px;
        height: 48px;
      }
      /* 가이드 박스 내부 모든 요소에 상단 여백 확보 */
      .next-step-guide > *:first-child {
        margin-top: 0;
      }
      .next-step-guide .chip-grid:first-child {
        margin-top: 12px;
      }
    }
    @keyframes nextStepPulse {
      0%, 100% { 
        border-color: #87CEEB;
        box-shadow: 0 0 0 3px rgba(135, 206, 235, 0.15);
        background-color: rgba(135, 206, 235, 0.05);
      }
      50% { 
        border-color: #87CEEB;
        box-shadow: 0 0 0 6px rgba(135, 206, 235, 0.25);
        background-color: rgba(135, 206, 235, 0.1);
      }
    }
    @keyframes fadeInDown {
      from { opacity: 0; transform: translateX(-50%) translateY(-5px); }
      to { opacity: 1; transform: translateX(-50%) translateY(0); }
    }
    
    /* 다음 단계 안내 메시지 (하늘색) */
    .next-step-message {
      position: fixed;
      top: 100px;
      left: 50%;
      transform: translateX(-50%) translateY(-20px);
      background: #87CEEB;
      color: #fff;
      padding: 12px 20px;
      border-radius: 12px;
      font-size: 15px;
      font-weight: 700;
      box-shadow: 0 8px 24px rgba(135, 206, 235, 0.3);
      z-index: 10000;
      opacity: 0;
      pointer-events: none;
      display: flex;
      align-items: center;
      gap: 8px;
      white-space: nowrap;
    }
    .next-step-message.show {
      animation: showNextStepMessage 0.4s ease-out forwards;
    }
    @keyframes showNextStepMessage {
      0% { opacity: 0; transform: translateX(-50%) translateY(-20px); }
      100% { opacity: 1; transform: translateX(-50%) translateY(0); }
    }
    .btn-error-pulse { animation: bounce-attention 0.6s ease-in-out 3; border-color: var(--danger) !important; background-color: rgba(239, 68, 68, 0.1) !important; color: var(--danger) !important; }
    /* 토스트 메시지 공통 스타일 (간결하게) */
    .toast-message { position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%) translateY(100px); background: rgba(15, 23, 42, 0.95); color: #fff; padding: 10px 16px; border-radius: 14px; font-size: 13px; opacity: 0; transition: 0.25s; display: flex; align-items: center; gap: 6px; white-space: nowrap; z-index: 9999; box-shadow: 0 4px 16px rgba(0,0,0,0.2); font-weight: 700; max-width: 320px; overflow: hidden; text-overflow: ellipsis; }
    .toast-message.show { transform: translateX(-50%) translateY(0); opacity: 1; }

    /* Overlays */
    .overlay-backdrop { position: fixed; inset: 0; background-color: rgba(0,0,0,0.4); z-index: 1500; opacity: 0; pointer-events: none; transition: opacity 0.3s; }
    .overlay-backdrop.active { opacity: 1; pointer-events: auto; }
    .drawer-panel, .menu-panel { position: fixed; top: 0; bottom: 0; width: 85%; max-width: 320px; background-color: var(--bg-surface); z-index: 2200; transition: transform 0.3s; display: flex; flex-direction: column; }
    .menu-panel { left: 0; transform: translateX(-100%); }
    .drawer-panel { right: 0; transform: translateX(100%); z-index: 1600; }
    .menu-panel.active, .drawer-panel.active { transform: translateX(0); }
    .noti-header { height: var(--header-height); padding: 0 16px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid var(--border); }
    .noti-list { list-style: none; padding: 0; margin: 0; overflow-y: auto; flex: 1; }
    .noti-item { padding: 20px; border-bottom: 1px solid var(--border); display: flex; gap: 14px; align-items: flex-start; }
    .menu-nav-list { list-style: none; padding: 24px; margin: 0; flex: 1; overflow-y: auto; }
    .menu-nav-list li { margin-bottom: 24px; }
    .menu-link { font-size: 19px; font-weight: 700; color: var(--text-main); cursor: pointer; }

    /* =================================================================
       [2. 사진대지 편집기 전용 스타일 (새로운 디자인 적용)]
       ================================================================= */
    #photo-editor-app { position: fixed; inset: 0; background: #121212; z-index: 5000; display: none; flex-direction: column; color: #fff; }
    #photo-editor-app.active { display: flex; }
    
    .pe-header { height: 56px; background: #000; border-bottom: 1px solid #222; display: flex; align-items: center; justify-content: space-between; padding: 0 12px; flex-shrink: 0; z-index: 100; }
    .pe-title { font-size: 17px; font-weight: 700; color: #fff; }
    
    .icon-btn { background: none; border: none; color: #fff; padding: 8px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s; }
    .icon-btn:active { background: #333; }

    .pe-config { background: #1e1e1e; padding: 12px; border-bottom: 1px solid #2a2a2a; display: flex; flex-direction: column; gap: 8px; flex-shrink: 0; z-index: 90; }
    .pe-row { display: flex; gap: 8px; }
    
    .pe-input { flex: 1; background: #2c2c2c; border: 1px solid #3a3a3a; color: #fff; padding: 10px 12px; border-radius: 8px; font-size: 14px; min-width: 0; outline:none; transition: border-color 0.2s; }
    .pe-input:focus { border-color: var(--primary); background: #333; }
    .pe-input::placeholder { color: #666; font-size: 13px; }

    .action-btn { flex: 1; padding: 10px; border-radius: 8px; font-size: 13px; font-weight: 600; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 6px; white-space: nowrap; }
    .btn-sort { background: #333; color: #ccc; border: 1px solid #444; }
    .btn-delete { background: rgba(239, 68, 68, 0.15); color: #ef4444; border: 1px solid #7f1d1d; }
    .btn-delete:active { background: rgba(239, 68, 68, 0.3); }

    .pe-viewport { flex: 1; position: relative; overflow-y: auto; overflow-x: hidden; background: #121212; display: flex; justify-content: center; padding-top: 30px; padding-bottom: 120px; cursor: grab; touch-action: none; }
    .pe-viewport.panning { cursor: grabbing; overflow: hidden; }
    
    .pe-paper-wrapper { transform-origin: center top; transition: transform 0.1s ease-out; display: flex; flex-direction: column; gap: 30px; align-items: center; }
    
    /* A4 Paper */
    .pe-page { width: 794px; height: 1123px; background: #fff; color: #000; padding: 40px; box-shadow: 0 4px 20px rgba(0,0,0,0.5); display: flex; flex-direction: column; flex-shrink: 0; box-sizing: border-box; }
    .doc-header { text-align: center; margin-bottom: 15px; }
    .doc-title { font-size: 32px; font-weight: 900; letter-spacing: -1px; margin-bottom: 5px; color: #000; }
    
    .pe-tbl { width: 100%; border-collapse: collapse; border: 2px solid #333; table-layout: fixed; }
    .pe-tbl td { border: 1px solid #333; padding: 0; text-align: center; vertical-align: middle; color: #000; box-sizing: border-box; }
    
    .cell-photo { height: 215px; background: #f1f5f9; position: relative; cursor: pointer; overflow: hidden; padding: 0; }
    .cell-photo img { width: 100%; height: 100%; object-fit: cover; display: block; }
    .cell-photo.empty::after { content: "+"; font-size: 30px; font-weight: 300; color: #cbd5e1; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); border: 2px dashed #cbd5e1; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; }
    
    .cell-input { width: 100%; height: 100%; border: none; text-align: center; font-size: 14px; font-weight: 500; outline: none; background: transparent; color: #000; }
    .toggle-text { cursor: pointer; color: #000; font-weight: 800; padding: 10px; display: block; user-select: none; }

    /* Pill Controls */
    .pe-controls-pill { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: #222; padding: 8px 24px; border-radius: 100px; display: flex; gap: 24px; z-index: 200; box-shadow: 0 10px 30px rgba(0,0,0,0.5); border: 1px solid #333; }
    .pe-ctrl-btn { background: none; border: none; color: #fff; display: flex; flex-direction: column; align-items: center; gap: 2px; font-size: 10px; cursor: pointer; min-width: 40px; opacity: 0.6; transition: 0.2s; font-weight: 500; }
    .pe-ctrl-btn:hover { opacity: 1; }
    .pe-ctrl-btn.active { color: var(--primary); opacity: 1; font-weight: 700; }
    .pe-ctrl-btn i { margin-bottom: 2px; }

    .sheet { width: 100%; max-width: 500px; background: #1e1e1e; border-radius: 20px 20px 0 0; padding: 24px; display: flex; flex-direction: column; gap: 12px; animation: slideUp 0.2s ease-out; border-top: 1px solid #333; }
    @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
    .sheet-btn { width: 100%; padding: 16px; border: none; border-radius: 12px; font-size: 15px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; background: #333; color: #fff; }
    .sheet-btn.danger { background: #451a1a; color: #ff6b6b; }
    .sheet-btn.primary { background: var(--primary); color: #fff; }
    
    .loading-mask { position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 7000; display: none; flex-direction: column; align-items: center; justify-content: center; color: #fff; }
    .spinner { width: 30px; height: 30px; border: 3px solid #555; border-top-color: var(--primary); border-radius: 50%; animation: spin 1s infinite linear; margin-bottom: 10px; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 6000; display: none; align-items: flex-end; justify-content: center; }
    .overlay.active { display: flex; }

    /* 도면 선택용 바텀시트 (현장정보 @site 스타일 이식) */
    .backdrop-sheet { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 2000; opacity: 0; pointer-events: none; transition: 0.2s; }
    .backdrop-sheet.active { opacity: 1; pointer-events: auto; }
    .bottom-sheet {
      position: fixed; bottom: 0; left: 0; right: 0; background: #fff;
      border-radius: 20px 20px 0 0; padding: 24px; z-index: 2100;
      transform: translateY(100%); transition: 0.3s; max-width: 600px; margin: 0 auto;
    }
    .bottom-sheet.active { transform: translateY(0); }
    .sheet-btn {
      width: 100%; height: 54px; border-radius: 12px; margin-bottom: 10px;
      font-size: 16px; font-weight: 600; display: flex; align-items: center; justify-content: center;
      gap: 8px; border: none; cursor: pointer;
    }
    .sheet-btn.primary { background: #eaf6ff; color: #31a3fa; border: 1px solid #bae6fd; }
    .sheet-btn.default { background: #f8fafc; border: 1px solid #e2e8f0; color: #333; }
    .sheet-btn.close { background: var(--navy-btn); color: #ffffff; margin-top: 10px; border: none; }

    /* =================================================================
       [3. 도면 마킹 모달 전용 스타일 (Drawing Marking)]
       ================================================================= */
    .full-overlay { position: fixed; inset: 0; background-color: #333; z-index: 3000; display: none; flex-direction: column; }
    .full-overlay.active { display: flex; }
    .canvas-header { height: 50px; background: var(--header-navy); display: flex; justify-content: space-between; align-items: center; padding: 0 16px; color: #fff; flex-shrink: 0; border: none; }
    .canvas-container { flex: 1; position: relative; overflow: hidden; background: #333; display: flex; align-items: center; justify-content: center; touch-action: none; }
    canvas { display: block; box-shadow: 0 0 20px rgba(0,0,0,0.5); touch-action: none; }
    .canvas-toolbar-wrap { background: #fff; border-top: none; padding-bottom: env(safe-area-inset-bottom); flex-shrink: 0; }
    .tool-row { display: flex; justify-content: space-around; padding: 8px; border-bottom: 1px solid #eee; }
    .c-tool-btn { width: 44px; height: 44px; border-radius: 8px; border: 1px solid #eee; background: #fff; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 10px; gap: 2px; color: #666; transition: 0.2s; }
    .c-tool-btn.active { background: var(--primary-bg); border-color: var(--primary); color: var(--primary); font-weight: 700; }
    .palette-container { display: flex; gap: 10px; overflow-x: auto; padding: 5px; -ms-overflow-style: none; scrollbar-width: none; }
    .palette-container::-webkit-scrollbar { display: none; }
    .color-btn { width: 30px; height: 30px; border-radius: 50%; border: 2px solid #ddd; cursor: pointer; flex-shrink:0; transition: transform 0.1s, box-shadow 0.1s; }
    .color-btn.active { border-color: #fff; transform: scale(1.1); box-shadow: 0 0 0 2px #333; }
    .color-btn[data-color="blue"] { background: rgba(49, 163, 250, 0.8); }
    .color-btn[data-color="red"] { background: rgba(239, 68, 68, 0.8); }
    .color-btn[data-color="gray"] { background: rgba(100, 116, 139, 0.8); }
    .color-btn[data-color="green"] { background: rgba(34, 197, 94, 0.8); }
    .color-btn[data-color="orange"] { background: rgba(249, 115, 22, 0.8); }
    .color-btn[data-color="purple"] { background: rgba(168, 85, 247, 0.8); }
    input[type=range] { -webkit-appearance: none; appearance: none; width: 100%; background: transparent; }
    input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; height: 16px; width: 16px; border-radius: 50%; background: var(--primary); margin-top: -6px; box-shadow: 0 0 4px rgba(0,0,0,0.3); }
    input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; cursor: pointer; background: #e2e8f0; border-radius: 2px; }

    /* =================================================================
       [4. 작업완료확인서 모달 스타일 (격리된 네임스페이스)]
       ================================================================= */
    #work-report-modal {
      position: fixed; inset: 0; background: #1e1e1e; z-index: 8000; 
      display: none; flex-direction: column; overflow: hidden; color: #fff;
    }
    #work-report-modal.active { display: flex; }
    #work-report-modal .wr-header { height: 60px; background: #000; display: flex; align-items: center; justify-content: space-between; padding: 0 16px; flex-shrink: 0; border-bottom: 1px solid #333; }
    #work-report-modal .wr-title { font-size: 18px; font-weight: 700; color: #fff; }
    #work-report-modal .wr-icon-btn { background: none; border: none; color: #fff; cursor: pointer; padding: 8px; border-radius: 50%; display: flex; align-items: center; justify-content: center; }
    #work-report-modal .wr-icon-btn:hover { background: rgba(255,255,255,0.15); }
    #work-report-modal .wr-viewport { flex: 1; position: relative; overflow: hidden; background: #1e1e1e; display: flex; justify-content: center; align-items: flex-start; touch-action: none; padding-top: 20px; cursor: default; }
    #work-report-modal .wr-viewport.panning { cursor: grab !important; }
    #work-report-modal .wr-viewport.panning:active { cursor: grabbing !important; }
    #work-report-modal .wr-paper-wrapper { transform-origin: center top; transition: transform 0.05s linear; padding-bottom: 100px; will-change: transform; }
    #work-report-modal .wr-a4-paper { width: 210mm; min-height: 297mm; background: #ffffff; color: #000; padding: 15mm; box-shadow: 0 4px 30px rgba(0,0,0,0.5); display: flex; flex-direction: column; }
    #work-report-modal .wr-doc-header { text-align: center; margin-bottom: 30px; border-bottom: 3px double #000; padding-bottom: 15px; }
    #work-report-modal .wr-doc-title { font-size: 36px; font-weight: 900; letter-spacing: 5px; color: #111; margin: 0; }
    #work-report-modal .wr-info-table { width: 100%; border-collapse: collapse; border: 2px solid #1e293b; margin-bottom: 20px; }
    #work-report-modal .wr-info-table th, #work-report-modal .wr-info-table td { border: 1px solid #1e293b; padding: 10px 8px; vertical-align: middle; }
    #work-report-modal .wr-info-table th { background: #f8fafc; font-weight: 800; text-align: center; width: 16%; font-size: 16px; color: #334155; white-space: nowrap; }
    #work-report-modal .wr-input, #work-report-modal .wr-textarea { width: 100%; border: none; background: transparent; font-family: inherit; font-size: 16px; color: #000; outline: none; padding: 4px; font-weight: 600; resize: none; }
    #work-report-modal .wr-input::placeholder, #work-report-modal .wr-textarea::placeholder { color: #cbd5e1; font-weight: 400; }
    #work-report-modal .wr-input:focus, #work-report-modal .wr-textarea:focus { background: rgba(37, 99, 235, 0.05); }
    #work-report-modal .wr-section-block { padding: 15px; display: flex; flex-direction: column; border: 2px solid #1e293b; margin-bottom: 20px; }
    #work-report-modal .wr-section-block.note { height: 150px; }
    #work-report-modal .wr-sec-header { font-size: 18px; font-weight: 800; color: #1e293b; margin-bottom: 12px; padding-left: 12px; border-left: 5px solid #475569; }
    #work-report-modal .wr-footer-area { margin-top: 10px; text-align: center; }
    #work-report-modal .wr-confirm-msg { font-size: 20px; font-weight: 800; margin-bottom: 25px; }
    #work-report-modal .wr-date-input { font-size: 20px; font-weight: 800; text-align: center; margin-bottom: 30px; }
    #work-report-modal .wr-sign-grid { display: grid; grid-template-columns: 33% 27% 40%; border: 2px solid #1e293b; margin-bottom: 20px; }
    #work-report-modal .wr-sign-cell-text { background: #f8fafc; border-right: 1px solid #1e293b; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 10px; gap: 8px; }
    #work-report-modal .wr-sign-label-text { font-weight: 800; font-size: 18px; color: #334155; }
    #work-report-modal .wr-sign-input-text { text-align: center; font-size: 18px; font-weight: 700; width: 100%; border-bottom: 1px dashed #cbd5e1; }
    #work-report-modal .wr-sign-cell-canvas { position: relative; background: #fff; height: 280px; display: flex; flex-direction: column; overflow: hidden; box-sizing: border-box; }
    #work-report-modal .wr-sign-label-canvas { padding: 8px 12px; font-weight: 700; font-size: 14px; color: #64748b; border-bottom: 1px dashed #e2e8f0; pointer-events: none; text-align: left; flex-shrink: 0; }
    #work-report-modal .wr-canvas-wrapper { flex: 1; position: relative; width: 100%; height: 100%; overflow: hidden; touch-action: none; background-color: #ffffff; }
    #work-report-modal .wr-signature-canvas { display: block; width: 100%; height: 100%; cursor: crosshair; touch-action: none; }
    #work-report-modal .wr-sign-tools { position: relative; width: 100%; height: 44px; background: #f8fafc; border-top: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; padding: 0 10px; z-index: 10; flex-shrink: 0; }
    #work-report-modal .wr-sign-tools-group { display: flex; gap: 6px; }
    #work-report-modal .wr-mini-btn { font-size: 11px; padding: 5px 10px; border: 1px solid #cbd5e1; background: #fff; border-radius: 4px; cursor: pointer; color: #64748b; font-weight: 600; box-shadow: 0 1px 2px rgba(0,0,0,0.05); display: flex; align-items: center; gap: 4px; transition: all 0.2s; }
    #work-report-modal .wr-mini-btn.active { background: #3b82f6; color: white; border-color: #2563eb; }
    #work-report-modal #wr-signImageInput { display: none; }
    #work-report-modal #wr-imageEditLayer { display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.95); z-index: 50; flex-direction: column; justify-content: center; align-items: center; overflow: hidden; }
    #work-report-modal #wr-imageEditContainer { position: relative; width: 100%; height: 100%; overflow: hidden; border: 2px dashed #3b82f6; background: rgba(59, 130, 246, 0.05); touch-action: none; }
    #work-report-modal #wr-editingImage { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); cursor: grab; filter: drop-shadow(0 4px 6px rgba(0,0,0,0.2)); touch-action: none; user-select: none; max-width: 80%; max-height: 80%; object-fit: contain; }
    #work-report-modal #wr-editingImage:active { cursor: grabbing; }
    #work-report-modal .wr-edit-controls-bar { position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%); background: #1e293b; padding: 8px 16px; border-radius: 20px; display: flex; gap: 12px; align-items: center; box-shadow: 0 4px 15px rgba(0,0,0,0.3); width: 90%; justify-content: space-between; z-index: 60; }
    #work-report-modal .wr-slider-group { display: flex; align-items: center; gap: 8px; color: #fff; font-size: 12px; flex: 1; }
    #work-report-modal .wr-slider-group input { width: 100%; cursor: pointer; }
    #work-report-modal .wr-controls-pill { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.85); padding: 10px 30px; border-radius: 50px; display: flex; gap: 30px; z-index: 200; backdrop-filter: blur(8px); box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
    #work-report-modal .wr-ctrl-btn { background: none; border: none; color: #fff; display: flex; flex-direction: column; align-items: center; gap: 4px; font-size: 11px; cursor: pointer; min-width: 40px; opacity: 0.7; transition: 0.2s; }
    #work-report-modal .wr-ctrl-btn.active { color: #31a3fa; opacity: 1; font-weight: 700; }
    #work-report-modal .wr-toast { position: fixed; top: 80px; left: 50%; transform: translateX(-50%); background: rgba(30, 41, 59, 0.95); color: #fff; padding: 12px 24px; border-radius: 50px; opacity: 0; transition: 0.3s; pointer-events: none; z-index: 300; display: flex; align-items: center; gap: 8px; font-weight: 600; font-size: 14px; }
    #work-report-modal .wr-toast.show { opacity: 1; top: 90px; }

    /* =================================================================
       [5. DMM2 도면마킹 모달 스타일 (격리된 네임스페이스)]
       ================================================================= */
    .dmm2-root, .dmm2-root * { box-sizing: border-box; font-family: var(--font-main); -webkit-tap-highlight-color: transparent; }
    .dmm2-root button { cursor: pointer; user-select: none; }
    .dmm2-hide { display: none !important; }
    .dmm2-overlay { position: fixed; inset: 0; z-index: 9000; background: #111827; display: none; flex-direction: column; overflow: hidden; }
    .dmm2-overlay.dmm2-active { display: flex; }
    .dmm2-header { height: 52px; flex-shrink: 0; background: #1a254f; display: flex; align-items: center; justify-content: space-between; padding: 0 12px; color: #fff; border-bottom: 1px solid rgba(255,255,255,.08); }
    .dmm2-hleft { display: flex; align-items: center; gap: 8px; min-width: 0; }
    .dmm2-hbtn { background: none; border: none; color: #fff; width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center; }
    .dmm2-hbtn:active { background: rgba(255,255,255,.08); }
    .dmm2-title { font-size: 16px; font-weight: 800; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 55vw; }
    .dmm2-subtitle { font-size: 12px; color: rgba(255,255,255,.75); font-weight: 600; margin-left: 6px; }
    .dmm2-hright { display: flex; align-items: center; gap: 6px; flex-shrink: 0; }
    .dmm2-cta { border: 1px solid rgba(255,255,255,.25); background: rgba(255,255,255,.06); color: #fff; padding: 7px 10px; border-radius: 10px; font-size: 12px; font-weight: 800; display: inline-flex; align-items: center; gap: 6px; white-space: nowrap; flex-shrink: 0; }
    .dmm2-save { background: #31a3fa; border: none; color: #fff; padding: 8px 12px; border-radius: 10px; font-size: 13px; font-weight: 900; display: inline-flex; align-items: center; gap: 6px; white-space: nowrap; flex-shrink: 0; }
    .dmm2-pages { background: #0b1220; border-bottom: 1px solid rgba(255,255,255,.08); padding: 10px; display: flex; gap: 10px; overflow-x: auto; -ms-overflow-style: none; scrollbar-width: none; }
    .dmm2-pages::-webkit-scrollbar { display: none; }
    .dmm2-page { width: 88px; flex-shrink: 0; border-radius: 12px; border: 1px solid rgba(255,255,255,.12); background: rgba(255,255,255,.03); overflow: hidden; position: relative; box-shadow: 0 2px 10px rgba(0,0,0,.2); }
    .dmm2-page.dmm2-active { border-color: rgba(49,163,250,.9); box-shadow: 0 0 0 2px rgba(49,163,250,.2), 0 8px 18px rgba(0,0,0,.35); }
    .dmm2-thumb { width: 100%; height: 66px; object-fit: cover; display: block; background: #0f172a; }
    .dmm2-pmeta { padding: 6px 8px 7px; display: flex; align-items: center; justify-content: space-between; gap: 8px; }
    .dmm2-pnum { font-size: 11px; font-weight: 900; color: #e2e8f0; }
    .dmm2-pdirty { width: 8px; height: 8px; border-radius: 999px; background: #31a3fa; box-shadow: 0 0 0 2px rgba(49,163,250,.2); opacity: 0; }
    .dmm2-page.dmm2-dirty .dmm2-pdirty { opacity: 1; }
    .dmm2-pdel { position: absolute; top: 6px; right: 6px; width: 26px; height: 26px; border-radius: 10px; border: 1px solid rgba(255,255,255,.15); background: rgba(0,0,0,.35); color: #fff; display: flex; align-items: center; justify-content: center; }
    .dmm2-pdel:active { transform: scale(.97); }
    .dmm2-addpage { width: 88px; flex-shrink: 0; border-radius: 12px; border: 1px dashed rgba(255,255,255,.25); background: rgba(255,255,255,.03); display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 6px; color: #e2e8f0; min-height: 92px; }
    .dmm2-addpage span { font-size: 11px; font-weight: 800; color: rgba(226,232,240,.9); }
    .dmm2-canvas-wrap { flex: 1; position: relative; overflow: hidden; background: #111827; display: flex; align-items: center; justify-content: center; touch-action: none; }
    .dmm2-canvas { display: block; box-shadow: 0 0 20px rgba(0,0,0,.5); touch-action: none; }
    .dmm2-toolbar { background: #fff; padding-bottom: env(safe-area-inset-bottom); flex-shrink: 0; }
    .dmm2-row { display: flex; justify-content: space-around; padding: 8px; border-top: 1px solid #eef2f7; }
    .dmm2-row.dmm2-props { justify-content: flex-start; gap: 6px; align-items: center; flex-wrap: nowrap; }
    .dmm2-tool { width: 44px; height: 44px; border-radius: 10px; border: 1px solid #e5e7eb; background: #fff; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 10px; gap: 2px; color: #64748b; transition: .2s; flex-shrink: 0; }
    .dmm2-tool.dmm2-active { background: #eaf6ff; border-color: rgba(49,163,250,.75); color: #31a3fa; font-weight: 900; }
    .dmm2-palette { display: flex; gap: 8px; flex: 1; min-width: 0; overflow-x: auto; align-items: center; padding: 8px 6px; -ms-overflow-style: none; scrollbar-width: none; flex-shrink: 1; }
    .dmm2-palette::-webkit-scrollbar { display: none; }
    .dmm2-color { width: 28px; height: 28px; border-radius: 999px; border: 2px solid #e5e7eb; flex-shrink: 0; transition: .15s; }
    .dmm2-color.dmm2-active { border-color: #fff; box-shadow: inset 0 0 0 3px #0f172a, 0 2px 8px rgba(0,0,0,.18); }
    .dmm2-color:active { transform: scale(0.96); }
    .dmm2-color[data-c="blue"] { background: rgba(49,163,250,.85); }
    .dmm2-color[data-c="red"] { background: rgba(239,68,68,.85); }
    .dmm2-color[data-c="gray"] { background: rgba(100,116,139,.85); }
    .dmm2-color[data-c="green"] { background: rgba(34,197,94,.85); }
    .dmm2-color[data-c="orange"] { background: rgba(249,115,22,.85); }
    .dmm2-color[data-c="purple"] { background: rgba(168,85,247,.85); }
    .dmm2-sep { width: 1px; height: 22px; background: #e5e7eb; flex-shrink: 0; }
    .dmm2-range { width: 30%; max-width: 120px; min-width: 80px; flex-shrink: 0; }
    input[type=range].dmm2-range { -webkit-appearance: none; appearance: none; background: transparent; }
    input[type=range].dmm2-range::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 16px; height: 16px; border-radius: 999px; background: #31a3fa; margin-top: -6px; box-shadow: 0 0 4px rgba(0,0,0,.3); }
    input[type=range].dmm2-range::-webkit-slider-runnable-track { height: 4px; background: #e2e8f0; border-radius: 999px; }
    .dmm2-stamps { display: none; gap: 12px; justify-content: space-around; background: #f8fafc; }
    .dmm2-stamps.dmm2-show { display: flex; }
    .dmm2-stamps .dmm2-tool { width: 46px; height: 46px; }
    .dmm2-loading { position: absolute; inset: 0; background: rgba(0,0,0,.75); display: none; align-items: center; justify-content: center; flex-direction: column; z-index: 10; color: #fff; font-weight: 800; }
    .dmm2-loading.dmm2-show { display: flex; }
    .dmm2-spinner { width: 38px; height: 38px; border: 3px solid rgba(255,255,255,.25); border-top-color: #31a3fa; border-radius: 50%; animation: dmm2-spin 1s linear infinite; margin-bottom: 10px; }
    @keyframes dmm2-spin { to { transform: rotate(360deg); } }
    .dmm2-toast { position: absolute; top: 70px; left: 50%; transform: translateX(-50%); background: #fff; color: #0f172a; padding: 10px 14px; border-radius: 999px; box-shadow: 0 10px 30px rgba(0,0,0,.35); display: flex; align-items: center; gap: 8px; opacity: 0; pointer-events: none; transition: .25s; z-index: 20; font-weight: 900; font-size: 13px; }
    .dmm2-toast.dmm2-show { opacity: 1; top: 80px; }
    
    /* DMM2 모바일 최적화 (480px 이하) */
    @media (max-width: 480px) {
      /* 상단 헤더 버튼 최적화 */
      .dmm2-header { padding: 0 8px; }
      .dmm2-hright { gap: 4px; }
      .dmm2-cta { 
        padding: 5px 6px; 
        font-size: 11px; 
        gap: 3px; 
        border-radius: 8px;
      }
      .dmm2-cta i { width: 14px !important; height: 14px !important; }
      .dmm2-save { 
        padding: 6px 8px; 
        font-size: 11px; 
        gap: 3px; 
        border-radius: 8px;
      }
      .dmm2-save i { width: 14px !important; height: 14px !important; }
      
      /* 버튼 텍스트 축약 - 텍스트 노드 숨기고 ::after로 교체 */
      .dmm2-cta#dmm2PreviewBtn {
        position: relative;
      }
      .dmm2-cta#dmm2PreviewBtn i {
        margin-right: 2px;
      }
      /* 텍스트 노드 숨기기 (직접 자식 텍스트) */
      .dmm2-cta#dmm2PreviewBtn {
        color: transparent;
      }
      .dmm2-cta#dmm2PreviewBtn i {
        color: #fff;
      }
      .dmm2-cta#dmm2PreviewBtn::after {
        content: '보기';
        color: #fff;
        font-size: 11px;
        margin-left: 2px;
        position: relative;
      }
      
      .dmm2-cta#dmm2ClearBtn {
        position: relative;
      }
      .dmm2-cta#dmm2ClearBtn i {
        margin-right: 2px;
      }
      /* 텍스트 노드 숨기기 */
      .dmm2-cta#dmm2ClearBtn {
        color: transparent;
      }
      .dmm2-cta#dmm2ClearBtn i {
        color: #fff;
      }
      .dmm2-cta#dmm2ClearBtn::after {
        content: '삭제';
        color: #fff;
        font-size: 11px;
        margin-left: 2px;
        position: relative;
      }
      
      /* 하단 툴바 최적화 */
      .dmm2-row.dmm2-props { 
        gap: 4px; 
        padding: 6px 4px;
        flex-wrap: nowrap;
      }
      .dmm2-palette { 
        gap: 6px; 
        padding: 6px 4px;
        flex: 1 1 auto;
        min-width: 0;
      }
      .dmm2-color { 
        width: 26px; 
        height: 26px; 
        min-width: 26px;
      }
      .dmm2-sep { 
        width: 1px; 
        height: 20px; 
        margin: 0 2px;
      }
      .dmm2-range { 
        width: 70px !important; 
        min-width: 70px !important; 
        max-width: 70px !important;
        flex-shrink: 0;
      }
      .dmm2-cta#dmm2FitBtn {
        padding: 6px 8px;
        font-size: 11px;
        gap: 3px;
        flex-shrink: 0;
      }
      .dmm2-cta#dmm2FitBtn i { width: 14px !important; height: 14px !important; }
    }
    
    /* DMM2 미리보기 모달 스타일 (미리보기창.html 기반) */
    .dmm2-pm-overlay {
        position: fixed; inset: 0;
        background: #121212;
        z-index: 10000; display: none;
        flex-direction: column;
        font-family: var(--font-main);
        color: #ffffff;
        overflow: hidden; user-select: none;
    }
    .dmm2-pm-overlay.dmm2-pm-active { display: flex; }
    .dmm2-pm-header {
        height: 56px; background: #000;
        display: flex; align-items: center; justify-content: space-between;
        padding: 0 12px; flex-shrink: 0; border-bottom: 1px solid #333; z-index: 100;
    }
    .dmm2-pm-title {
        font-size: 17px; font-weight: 700; color: #fff;
        overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
        max-width: 70%; text-align: center;
    }
    .dmm2-pm-icon-btn {
        background: none; border: none; color: #fff; cursor: pointer;
        padding: 8px; display: flex; align-items: center; justify-content: center;
        border-radius: 50%; transition: 0.2s;
    }
    .dmm2-pm-icon-btn:active { background: #333; }
    .dmm2-pm-viewport {
        flex: 1; position: relative; overflow: hidden;
        background: #121212;
        display: flex; justify-content: center; align-items: center;
        cursor: grab; touch-action: none;
    }
    .dmm2-pm-viewport.dmm2-pm-panning { cursor: grabbing; }
    .dmm2-pm-content-wrapper {
        transform-origin: center center;
        transition: transform 0.1s ease-out;
        display: flex; flex-direction: column; align-items: center; gap: 20px;
        padding: 40px;
    }
    .dmm2-pm-controls {
        position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
        background: #222; padding: 10px 20px; border-radius: 100px;
        display: flex; gap: 24px; z-index: 200;
        box-shadow: 0 10px 30px rgba(0,0,0,0.5); border: 1px solid #333;
    }
    .dmm2-pm-ctrl-btn {
        background: none; border: none; color: #fff;
        display: flex; flex-direction: column; align-items: center; gap: 3px;
        font-size: 11px; cursor: pointer; min-width: 36px; opacity: 0.7; transition: 0.2s; font-weight: 500;
    }
    .dmm2-pm-ctrl-btn:hover { opacity: 1; }
    .dmm2-pm-ctrl-btn.dmm2-pm-active { color: #31a3fa; opacity: 1; font-weight: 700; }
    .dmm2-pm-loading {
        position: absolute; inset: 0; background: rgba(0,0,0,0.85);
        display: none; align-items: center; justify-content: center; flex-direction: column;
        z-index: 300; color: #fff; font-size: 14px;
    }
    .dmm2-pm-loading.dmm2-pm-show { display: flex; }
    .dmm2-pm-spinner {
        width: 36px; height: 36px; border: 3px solid #555;
        border-top-color: #31a3fa; border-radius: 50%;
        animation: dmm2-pm-spin 1s linear infinite; margin-bottom: 12px;
    }
    @keyframes dmm2-pm-spin { to { transform: rotate(360deg); } }
    .dmm2-pm-toast {
        position: absolute; top: 80px; left: 50%; transform: translateX(-50%);
        background: #fff; color: #000; padding: 12px 24px;
        border-radius: 30px; opacity: 0; transition: 0.3s; pointer-events: none; z-index: 400;
        display: flex; align-items: center; gap: 8px; font-weight: 700; font-size: 14px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    }
    .dmm2-pm-toast.dmm2-pm-show { opacity: 1; top: 90px; }
    .dmm2-pm-img-view {
        max-width: 90vw; max-height: 80vh;
        box-shadow: 0 4px 20px rgba(0,0,0,0.5);
    }
    
    /* ===== 업로드 선택 시트 (카메라/갤러리/파일) ===== */
    .dmm2-picker {
      position: fixed; inset: 0; z-index: 3500;
      display: none; align-items: flex-end; justify-content: center;
      padding: 0 12px calc(12px + env(safe-area-inset-bottom));
    }
    .dmm2-picker.dmm2-active { display: flex; }
    .dmm2-picker-dim {
      position: absolute; inset: 0; background: rgba(0,0,0,.65);
    }
    .dmm2-picker-card {
      position: relative;
      width: min(520px, 100%);
      background: #1f232a;
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 18px;
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
      padding: 14px;
      display: flex; flex-direction: column; gap: 10px;
      color: #fff;
    }
    .dmm2-picker-title {
      font-weight: 900; font-size: 14px;
      color: rgba(255,255,255,.9);
      padding: 2px 2px 6px;
    }
    .dmm2-picker-btn {
      display: flex; align-items: center; gap: 10px;
      width: 100%;
      border: none;
      background: rgba(255,255,255,.07);
      border: 1px solid rgba(255,255,255,.10);
      color: #fff;
      padding: 12px 12px;
      border-radius: 14px;
      font-weight: 900; font-size: 14px;
      justify-content: flex-start;
    }
    .dmm2-picker-btn:active {
      background: rgba(49,163,250,.16);
      border-color: rgba(49,163,250,.35);
    }
    .dmm2-picker-cancel {
      margin-top: 2px;
      width: 100%;
      border: none;
      background: rgba(255,255,255,.10);
      color: #fff;
      padding: 12px 12px;
      border-radius: 14px;
      font-weight: 900; font-size: 14px;
    }
    .dmm2-picker-cancel:active { background: rgba(255,255,255,.16); }
    
    /* ===== 텍스트 입력 모달 ===== */
    .dmm2-textm {
      position: fixed; inset: 0; z-index: 3600;
      display: none; align-items: center; justify-content: center;
      padding: 16px;
    }
    .dmm2-textm.dmm2-active { display: flex; }
    .dmm2-textm-dim {
      position: absolute; inset: 0; background: rgba(0,0,0,.65);
    }
    .dmm2-textm-card {
      position: relative;
      width: min(520px, 100%);
      background: #1f232a;
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 18px;
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
      padding: 16px;
      color: #fff;
      display: flex; flex-direction: column; gap: 12px;
    }
    .dmm2-textm-title { font-weight: 900; font-size: 15px; }
    .dmm2-textm-input {
      width: 100%;
      padding: 12px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.06);
      color: #fff;
      font-weight: 800;
      outline: none;
    }
    .dmm2-textm-input:focus {
      border-color: rgba(49,163,250,.55);
      box-shadow: 0 0 0 3px rgba(49,163,250,.18);
    }
    .dmm2-textm-actions {
      display: flex; gap: 10px; justify-content: flex-end;
    }
    .dmm2-textm-actions .dmm2-cta,
    .dmm2-textm-actions .dmm2-save { flex: 0 0 auto; }
    
    /* ===== 지우기 버튼 스타일 ===== */
    #dmm2ClearBtn {
      background: linear-gradient(180deg, rgba(68,18,18,.92), rgba(25,6,6,.92));
      border: 1px solid rgba(239,68,68,.60);
      color: rgba(239,68,68,.96);
      box-shadow: 0 0 0 1px rgba(239,68,68,.14) inset;
    }
    #dmm2ClearBtn:active {
      background: linear-gradient(180deg, rgba(86,22,22,.96), rgba(32,8,8,.96));
      border-color: rgba(239,68,68,.78);
    }
    #dmm2ClearBtn i { color: rgba(239,68,68,.96); }
    
    /* 추가 색상 버튼 */
    .dmm2-color[data-c="cyan"] { background: rgba(6,182,212,.90); }
    .dmm2-color[data-c="yellow"] { background: rgba(250,204,21,.90); }
    .dmm2-color[data-c="pink"] { background: rgba(236,72,153,.88); }
    .dmm2-color[data-c="teal"] { background: rgba(20,184,166,.88); }
    .dmm2-color[data-c="indigo"] { background: rgba(99,102,241,.88); }
    .dmm2-color[data-c="white"] {
      background: #ffffff;
      border-color: #cbd5e1;
    }
  
    /* =========================================================
      [PATCH] 투입 인원(공수) - @main2.html 기준 UI 통일
    ========================================================= */
    .readonly-field,
    .readonly-field:disabled{
      pointer-events:none;
      opacity:0.7 !important;
      color: var(--text-sub) !important;
      background: #f8fafc !important;
      border-color: #e2e8f0 !important;
      cursor: not-allowed !important;
    }
    body.dark-mode .readonly-field,
    body.dark-mode .readonly-field:disabled{
      background: #1e293b !important;
      border-color: #334155 !important;
      color: #94a3b8 !important;
    }

    #manpower-list.mp-list{
      display:flex;
      flex-direction:column;
      gap:0;
    }
    
    /* 추가 버튼 - 파란색 배경 스타일 (이미지 참고) */
    .mp-add-btn{
      width:100%;
      height:50px;
      border:none;
      background:var(--primary-bg);
      border-radius:12px;
      font-size:17px;
      font-weight:700;
      color:var(--primary);
      display:flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      margin-top:12px;
      cursor:pointer;
      transition:all 0.2s;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    .mp-add-btn:hover{
      background:#d1e9ff;
    }
    .mp-add-btn:active{ 
      transform: scale(0.98);
      background:#b8dfff;
    }

    /* 인원 카드(행) - 2번째 참고 이미지 스타일 (박스 배경만, 테두리 없음) */
    .manpower-row{
      display:grid !important;
      grid-template-columns: 1.2fr 1fr auto;
      gap:10px;
      align-items:center;
      animation:fadeIn 0.2s ease-out;
      background:#f8fafc;           /* 박스처럼 보이는 연한 배경 */
      border:none;                  /* 외곽 테두리 제거 */
      border-radius:16px;
      padding:14px 16px;
      margin-bottom:10px;           /* 행 간 간격 */
    }
    @media (max-width: 480px) {
      .manpower-row {
        grid-template-columns: minmax(0,1.05fr) minmax(0,0.95fr) auto;
        gap: 8px;
        padding: 12px 10px;
      }
      .manpower-row .stepper.mp-stepper {
        min-width: 0;
      }
    }
    /* 잠금/추가 구분은 구조만 다르고 박스 표현은 동일하게 유지 */
    .manpower-row.locked{
      background:#f8fafc;
    }
    .manpower-row:not(.locked){
      background:#f8fafc;
    }
    .manpower-row .manpower-select-wrapper{ 
      flex:1; 
      min-width:0; 
    }
    /* 작업자 선택 필터 - @main.html form-select 스타일 적용 */
    .manpower-row:not(.locked) .manpower-worker-select{
      appearance: none;
      -webkit-appearance: none;
      width: 100%;
      height: 50px;
      background-color: var(--bg-input);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 0 40px 0 16px;
      font-family: var(--font-main);
      font-size: 15px;
      font-weight: 500;
      color: var(--text-main);
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='18' height='18' viewBox='0 0 24 24' fill='none' stroke='%23333333' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 14px center;
      background-size: 18px;
      cursor: pointer;
      transition: all 0.2s;
      outline: none;
    }
    .manpower-row:not(.locked) .manpower-worker-select:hover {
      border-color: #cbd5e1;
    }
    .manpower-row:not(.locked) .manpower-worker-select:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(49, 163, 250, 0.15);
      outline: none;
    }
    body.dark-mode .manpower-row:not(.locked) .manpower-worker-select {
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='18' height='18' viewBox='0 0 24 24' fill='none' stroke='%2394a3b8' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
    }
    .manpower-row:not(.locked) .manpower-custom-input{
      width:100%;
      height:50px;
      border:1px solid var(--border);
      border-radius:12px;
      background:var(--bg-input);
      padding:0 14px;
      font-size:15px;
      font-weight:500;
      color:var(--text-main);
    }
    .manpower-row:not(.locked) .manpower-custom-input:hover {
      border-color: #cbd5e1;
    }
    .manpower-row:not(.locked) .manpower-custom-input:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(49, 163, 250, 0.15);
      outline: none;
    }

    .mp-name-text{
      font-size:17px;
      font-weight:700;
      color:var(--text-main);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .mp-del-btn { white-space: nowrap; }
    .mp-me{
      display:none;
    }

    /* 공수 스텝퍼 - @main.html 스타일 통일 */
    .stepper.mp-stepper{
      width:100%;
      height:var(--h-common);
      border:1px solid var(--border);
      border-radius:var(--radius-input);
      background:var(--bg-input);
      overflow:hidden;
      display:flex;
    }
    .stepper.mp-stepper > * {
      flex:1;
      display:flex;
      align-items:center;
      justify-content:center;
      border:none;
      background:transparent;
    }
    .stepper.mp-stepper .btn-step{
      font-size:20px;
      color:var(--text-sub);
      cursor:pointer;
    }
    .stepper.mp-stepper .step-val{
      font-size:16px;
      font-weight:700;
      color:var(--text-main);
      border-left:1px solid var(--bg-body);
      border-right:1px solid var(--bg-body);
    }

    /* 기본 인원(나) 삭제 불가 */
    .manpower-row.locked .mp-del-btn{ display:none !important; }
    .manpower-row.locked .manpower-edit-btn{ display:none !important; }

    /* 자재현황 아래 저장바: 스크롤 따라다니기(저장 용이) */
    .floating-action-buttons{
      position: sticky !important;
      bottom: 12px;
      background: var(--bg-surface);
      padding: 10px;
      border-radius: 16px;
      border: 1px solid var(--border);
      box-shadow: 0 10px 26px rgba(0,0,0,0.08);
      margin: 12px auto 20px;
    }

</style>
</head>
<body>

  <input type="file" id="profile-upload-input" style="display:none;" accept="image/*" onchange="handleProfilePreview(this)">
  <input type="file" id="bulk-upload-input" multiple style="display:none;" accept="image/*" onchange="handleBulkUpload(this)">
  <input type="file" id="drawing-upload-input" multiple style="display:none;" onchange="handleDrawingUpload(this)">
  
  <input type="file" id="pe-file-input" multiple accept="image/*" style="display:none;" onchange="handleEditorUpload(this)">
  <input type="file" id="pe-replace-input" accept="image/*" style="display:none;" onchange="handleReplace(this)">

  <div class="overlay-backdrop" id="notiBackdrop" onclick="closeNotification()"></div>
  <div class="drawer-panel" id="notiPanel">
    <div class="noti-header"><span class="noti-title">알림 센터</span><button onclick="closeNotification()" style="background:none; border:none;"><i data-lucide="x"></i></button></div>
    <ul class="noti-list" id="notificationList"></ul>
  </div>

  <div class="overlay-backdrop" id="menuBackdrop" onclick="closeMenu()"></div>
  <div class="menu-panel" id="menuPanel">
      <div style="padding:34px 24px; border-bottom:1px solid var(--border);">
          <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
              <div><span style="font-size:24px; font-weight:800; color:var(--text-main);">이현수</span> <span style="font-size:12px; font-weight:700; color:var(--primary); background:var(--primary-bg); padding:4px 8px; border-radius:4px;">작업자</span></div>
              <button onclick="closeMenu()" style="border:1px solid var(--border); background:none; border-radius:8px; padding:6px 14px; font-size:14px; color:var(--text-sub);">닫기</button>
          </div>
          <div style="font-size:15px; color:var(--text-sub);">manager@inopnc.com</div>
      </div>
      <ul class="menu-nav-list">
          <li><a class="menu-link" onclick="location.href='#'">홈</a></li>
          <li><a class="menu-link" onclick="location.href='#'">현장정보</a></li>
          <li class="menu-link-row" style="display:flex; justify-content:space-between; align-items:center;">
              <span class="menu-link">내정보</span>
              <button class="btn-acct-mgmt" onclick="openAccount()">계정관리</button>
          </li>
      </ul>
      <div style="padding:24px; border-top:1px solid var(--border);">
          <button class="btn-logout">로그아웃</button>
      </div>
  </div>

  <div class="app-wrapper" id="main-app">
    <section class="quick-menu-section">
      <div class="qm-header">
        <div style="display:flex; align-items:center; gap:6px;">
          <img src="https://postfiles.pstatic.net/MjAyNTA5MDlfMjYz/MDAxNzU3MzczOTIzNjUy.938EaPjiHzNGNoECgw9vItJhy_4pR6ZYVq3-8Z3tJecg.pSbWcXNy1U9El6kYe8OpwKmCEwkZiWJUiIM2R1qL2Swg.PNG/Flash.png?type=w966" alt="빠른메뉴" class="qm-title-icon-img">
          <span class="qm-title">빠른메뉴</span>
        </div>
      </div>
      <div class="qm-grid">
        <a href="#" class="qm-item"><div class="qm-icon-wrapper"><span class="qm-badge hide">0</span><img class="qm-main-icon" src="https://postfiles.pstatic.net/MjAyNTA5MDlfMzMg/MDAxNzU3MzczOTIzOTg2.eKgzH2aeZVhrEtYCSg-Vjyuok2eudz505Ck18_zeqpsg.r-W69aHdwVPEBS58wMg5LyR7-mDy3WaW_Yyt9I-Ax8kg.PNG/%EC%B6%9C%EB%A0%A5%ED%98%84%ED%99%A9.png?type=w966" alt="출력현황"></div><span class="qm-label">출력현황</span></a>
        <a href="#" class="qm-item qm-item--event"><div class="qm-icon-wrapper"><span class="qm-badge req worklog">3</span><img class="qm-main-icon" src="https://postfiles.pstatic.net/MjAyNTA5MDlfNDIg/MDAxNzU3MzczOTIzOTE5.uKHob9PU2yFuDqyYrTvUYHunByHEBj0A7pUASU7CEREg.3-0zMZk_TTNxnCDNBVAvSSxeGYcWdeot0GzIWhgD72Ug.PNG/%EC%9E%91%EC%97%85%EC%9D%BC%EC%A7%80.png?type=w966" alt="작업일지"></div><span class="qm-label">작업일지</span></a>
        <a href="#" class="qm-item"><div class="qm-icon-wrapper"><span class="qm-badge hide">0</span><img class="qm-main-icon" src="https://postfiles.pstatic.net/MjAyNTA5MDlfMTg4/MDAxNzU3MzczOTIzNjQ4.t3FLSpag_6badT7CAFsHXFj2wTbUWJh_3iHKxWR1DEwg.80vrXfmE4WGWg206E9n0XibJFSkfk1RkUr-lDpzyXh4g.PNG/%ED%98%84%EC%9E%A5%EC%A0%95%EB%B3%B4.png?type=w966" alt="현장정보"></div><span class="qm-label">현장정보</span></a>
        <a href="#" class="qm-item"><div class="qm-icon-wrapper"><span class="qm-badge hide">0</span><img class="qm-main-icon" src="https://postfiles.pstatic.net/MjAyNTA5MDlfMjc2/MDAxNzU3MzczOTIzNjUx.O1t90awoAKjRWjXhHYAnUEen68ptahXE1NWbYNvjy8Yg.440PWbQoaCp1dpPCgCvnlKU8EASGSAXMHb0zGEKnLHkg.PNG/%EB%AC%B8%EC%84%9C%ED%95%A8.png?type=w966" alt="문서함"></div><span class="qm-label">문서함</span></a>
        <a href="#" class="qm-item qm-item--event"><div class="qm-icon-wrapper"><span class="qm-badge req">2</span><img class="qm-main-icon" src="https://postfiles.pstatic.net/MjAyNTA5MDlfNjEg/MDAxNzU3MzczOTIzODI4.vHsIasE2fPt-A9r28ui5Sw7oGf9JXhxetAh96TdAHgcg.iV39dkzonq61Z_hvu1O1-FLwCNFqM-OCqrNDwN3EuI8g.PNG/%EB%B3%B8%EC%82%AC%EC%9A%94%EC%B2%AD.png?type=w966" alt="본사요청"></div><span class="qm-label">본사요청</span></a>
        <a href="#" class="qm-item qm-item--event"><div class="qm-icon-wrapper"><span class="qm-badge issue" id="issueBadge">0</span><img class="qm-main-icon" src="https://github.com/gpdavidyang/INOPNC_WM_20250829/blob/main/public/icons/photo.png?raw=true" alt="조치사항"></div><span class="qm-label">조치사항</span></a>
      </div>
    </section>

    <div class="card-box form-card">
      <div class="section-header">
        <div class="section-title" style="display:flex; align-items:center; gap:8px; flex-wrap:wrap;">
          <i data-lucide="map-pin" width="20" style="color:var(--header-navy);"></i>
          <span>현장</span><span class="required">*</span>
          <span class="form-sub-hint" style="margin:0; font-size:14px;">ㅣ 권역 선택 후 현장 선택</span>
        </div>
        <span class="required-badge">* 필수 입력</span>
      </div>
      <div class="form-group" style="margin-bottom:12px;">
        <div class="chip-grid region-grid" data-type="region" style="margin-bottom:12px;">
          <button class="select-chip active" onclick="toggleRegionChip(this, '전체')">전체</button>
          <button class="select-chip" onclick="toggleRegionChip(this, '수도권')">수도</button>
          <button class="select-chip" onclick="toggleRegionChip(this, '충청권')">충청</button>
          <button class="select-chip" onclick="toggleRegionChip(this, '전라권')">전라</button>
          <button class="select-chip" onclick="toggleRegionChip(this, '경상권')">경상</button>
          <button class="select-chip" onclick="toggleRegionChip(this, '강원권')">강원</button>
        </div>
        <select class="form-select required-field" id="siteSelect" onchange="autoLinkDept()">
          <option value="">현장 선택</option>
        </select>
      </div>
      <div class="form-group" style="margin-bottom:12px;">
        <div class="form-row-inline">
          <div class="form-col-half">
            <div style="display:flex; align-items:center; gap:6px; margin-bottom:8px; flex-wrap:nowrap;">
              <label class="form-label" style="margin-bottom:0; flex-shrink:0;">소속</label>
              <span class="form-sub-hint" style="margin:0; font-size:14px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:100%;">ㅣ 현장 소속 연동</span>
            </div>
            <select class="form-select required-field readonly-field" id="sel-dept" disabled aria-readonly="true">
              <option value="">소속 선택</option>
              <option value="HQ">본사</option>
            </select>
          </div>
          <div class="form-col-half">
            <label class="form-label" style="white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:100%;">작업일자</label>
            <input type="date" class="form-input" id="input-date">
          </div>
        </div>
      </div>
    </div>

    <div class="card-box">
      <div class="section-header">
        <div class="section-title" style="display:flex; align-items:center; gap:8px;">
          <i data-lucide="users" width="20" style="color:var(--header-navy);"></i>
          투입 인원(공수) <span class="required">*</span>
        </div>
        <button class="btn-add-header" onclick="addManpowerRow()">
          <span style="font-size:16px; font-weight:900;">+</span>
          <span>추가</span>
        </button>
      </div>
      <div id="manpower-list" class="mp-list"></div>
    </div>

    <div class="card-box">
      <div class="section-header">
        <div class="section-title" style="display:flex; align-items:center; gap:8px;">
          <i data-lucide="hard-hat" width="20" style="color:var(--header-navy);"></i>
          작업내용 <span class="required">*</span>
        </div>
        <button class="btn-add-header" onclick="addWorkSet()">
          <span style="font-size:16px; font-weight:900;">+</span>
          <span>추가</span>
        </button>
      </div>
      <div id="work-content-list"></div>
    </div>

    <div class="card-box">
      <div class="section-header">
        <div class="section-title" style="display:flex; align-items:center; gap:8px;">
          <i data-lucide="package" width="20" style="color:var(--header-navy);"></i>
          자재 사용 내역
          <span class="form-sub-hint" style="margin:0; font-size:14px;">ㅣ 자재 있을 시 입력</span>
        </div>
      </div>
      <div class="mat-input-grid">
         <select class="form-select" id="mat-name" onchange="handleMaterialSelect(this)">
           <option value="NPC-1000" selected>NPC-1000</option>
           <option value="NPC-3000Q">NPC-3000Q</option>
           <option value="custom">직접입력</option>
         </select>
         <div class="mat-qty-wrapper"><input type="number" id="mat-qty" class="mat-qty-input" placeholder="0" min="0.1" step="0.1" oninput="validateMaterialQtyInput()" onblur="checkAllRequiredComplete()"><span class="mat-unit">말</span></div>
         <button class="btn-add-block" onclick="addMaterial()">+</button>
      </div>
      <div id="mat-custom-input-wrap" style="display:none; margin-top:10px;">
        <input type="text" class="form-input" id="mat-custom-name" placeholder="자재명 직접 입력" oninput="handleCustomMaterialInput(this.value)" onkeypress="if(event.key==='Enter') confirmCustomMaterial()">
        <button class="btn-action btn-save" onclick="confirmCustomMaterial()" style="margin-top:8px; width:100%;">확인</button>
      </div>
      <div class="material-list" id="mat-list"></div>
    </div>

    <!-- 초기화/일지저장 버튼 (자재사용내역 아래) -->
    <div class="floating-action-buttons" id="floatingActionButtons" style="display:flex;">
      <button class="btn-action btn-reset" onclick="resetPage()">초기화</button>
      <button class="btn-action btn-save" onclick="validateAndSave()">일지저장</button>
    </div>

    <div class="card-box">
      <div class="section-header" style="margin-bottom:16px;">
        <div class="section-title" style="display:flex; align-items:center; gap:8px;">
          <i data-lucide="image" width="20" style="color:var(--header-navy);"></i>
          사진 및 도면
        </div>
      </div>
      <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px;">
        <div style="display:flex; flex-direction:column; gap:8px;">
          <div style="font-size:17px; font-weight:700; color:var(--text-sub);">사진등록</div>
          <button class="uu-btn dashed type-blue" id="btn-photo-register" onclick="document.getElementById('bulk-upload-input').click()" style="width:100%; justify-content:center; height:50px !important; min-height:50px !important; max-height:50px !important; font-size:17px !important; display:flex !important; align-items:center !important;">
            <i data-lucide="camera" width="20"></i> 사진등록
          </button>
        </div>
        <div style="display:flex; flex-direction:column; gap:8px;">
          <div style="font-size:17px; font-weight:700; color:var(--text-sub);">도면마킹</div>
          <button class="uu-btn dashed type-gray-secondary" onclick="openDrawingMarkingMenu()" style="width:100%; justify-content:center; height:50px !important; min-height:50px !important; max-height:50px !important; font-size:17px !important; display:flex !important; align-items:center !important;">
            <i data-lucide="scan-line" width="20"></i> 도면마킹
          </button>
        </div>
      </div>
    </div>

    <!-- 도면마킹 선택 바텀시트 -->
    <div class="backdrop-sheet" id="drawingSheetBackdrop" onclick="closeDrawingMarkingMenu()"></div>
    <div class="bottom-sheet" id="drawingSheet">
      <div style="text-align:center; font-weight:700; font-size:18px; margin-bottom:20px; color:var(--text-main);">
        도면 선택
      </div>
      <input type="file" id="drawingCameraInput" accept="image/*" capture="environment" hidden />
      <input type="file" id="drawingGalleryInput" accept="image/*" multiple hidden />
      <input type="file" id="drawingFileInput" accept="image/*,application/pdf" multiple hidden />
      <button class="sheet-btn primary" onclick="openDrawingUploadDirect()">
        <i data-lucide="camera" width="18"></i> 도면 업로드
      </button>
      <button class="sheet-btn default" onclick="openSiteDrawingMarkingDirect()">
        <i data-lucide="map" width="18"></i> 도면 불러오기
      </button>
      <button class="sheet-btn close" onclick="closeDrawingMarkingMenu()">
        닫기
      </button>
    </div>
    
    <div class="card-box summary-card">
      <div class="section-header cursor-pointer" onclick="toggleSummary()" style="margin-bottom:16px; border-bottom:1px solid var(--border); padding-bottom:12px; cursor:pointer;">
        <div class="section-title" style="display:flex; align-items:center; gap:8px;">
          <i data-lucide="file-text" width="20" style="color:var(--header-navy);"></i>
          작성 내용 요약
        </div>
        <i data-lucide="chevron-down" class="arrow-icon collapsed"></i>
      </div>
      <div id="summary-body" class="summary-body collapsed">
        <div class="sum-row"><span class="sum-key">현장</span><span class="sum-val" id="sum-site">선택 안됨</span></div>
        <div class="sum-row"><span class="sum-key">작업일자</span><span class="sum-val" id="sum-date">-</span></div>
        <div class="sum-row"><span class="sum-key">투입인원</span><span class="sum-val" id="sum-manpower">-</span></div>
        <div class="sum-row"><span class="sum-key">부재명</span><span class="sum-val" id="sum-member">-</span></div>
        <div class="sum-row"><span class="sum-key">작업공정</span><span class="sum-val" id="sum-process">-</span></div>
        <div class="sum-row"><span class="sum-key">작업유형</span><span class="sum-val" id="sum-type">-</span></div>
        <div class="sum-row"><span class="sum-key">블럭/동/층</span><span class="sum-val" id="sum-location">-</span></div>
        <div class="sum-row" style="margin-top:8px; padding-top:8px; border-top:1px solid var(--border); gap:16px;">
          <span style="display:flex; align-items:center; gap:8px;"><span class="sum-key">사진 업로드</span><span class="sum-val" id="sum-photos">0장</span></span>
          <span style="display:flex; align-items:center; gap:8px;"><span class="sum-key">도면 업로드</span><span class="sum-val" id="sum-drawings">0건</span></span>
        </div>
      </div>
    </div>
  </div> 

  <div id="photo-editor-app">
      <header class="pe-header">
        <button class="icon-btn" onclick="closePhotoEditor()">
            <i data-lucide="chevron-left" width="24"></i>
        </button>
        <div class="pe-title">스마트 사진대지</div>
        <div style="display:flex; gap: 4px;">
            <button class="icon-btn" onclick="resetData()">
                <i data-lucide="rotate-ccw" width="20"></i>
            </button>
            <button class="icon-btn" onclick="savePDF()">
                <i data-lucide="download" width="20"></i>
            </button>
        </div>
      </header>

      <div class="pe-config">
        <div class="pe-row">
            <input id="meta-site" class="pe-input" placeholder="현장명 (문서 제목)" oninput="render()">
            <input id="meta-project" class="pe-input" placeholder="공사명 (테이블 내)" oninput="render()">
        </div>
        <div class="pe-row">
            <input id="meta-member" class="pe-input" placeholder="부재명 (일괄적용)" oninput="applyToAll('member', this.value)">
            <input id="meta-process" class="pe-input" placeholder="공정명 (일괄적용)" oninput="applyToAll('process', this.value)">
        </div>
        <div class="pe-row">
            <input id="meta-desc" class="pe-input" style="flex:1.5;" placeholder="내용 기본값 (예: 보수후)">
            <button class="action-btn btn-sort" onclick="sortAndClassify()">
                <i data-lucide="arrow-down-up" width="14"></i> 정렬
            </button>
            <button class="action-btn btn-delete" onclick="removeEmptyPages()">
                <i data-lucide="trash" width="14"></i> 빈 페이지 삭제
            </button>
        </div>
      </div>

      <div class="pe-viewport" id="peViewport">
        <div class="pe-paper-wrapper" id="paperWrapper"></div>
      </div>

      <div class="pe-controls-pill">
        <button class="pe-ctrl-btn" onclick="document.getElementById('pe-file-input').click()">
            <i data-lucide="image-plus" width="20"></i> 추가
        </button>
        <div style="width:1px; background:#444; height:24px; align-self:center;"></div>
        <button class="pe-ctrl-btn" onclick="adjustZoom(-0.1)">
            <i data-lucide="minus" width="20"></i> 축소
        </button>
        <button class="pe-ctrl-btn" id="btnPan" onclick="togglePan()">
            <i data-lucide="hand" width="20"></i> 이동
        </button>
        <button class="pe-ctrl-btn" onclick="adjustZoom(0.1)">
            <i data-lucide="plus" width="20"></i> 확대
        </button>
        <button class="pe-ctrl-btn" onclick="shareContent()">
            <i data-lucide="share-2" width="20"></i> 공유
        </button>
      </div>
  </div>

  <div class="full-overlay" id="canvasModal">
      <div class="canvas-header">
          <div style="display:flex; align-items:center; gap:4px;">
              <button style="background:none; border:none; color:#fff; display:flex; align-items:center;" onclick="confirmCloseCanvas()"><i data-lucide="chevron-left"></i></button>
              <span style="font-size:16px; font-weight:700;">도면 마킹</span>
          </div>
          <div style="display:flex; gap:10px;">
              <button style="background:none; border:1px solid rgba(255,255,255,0.3); color:#fff; padding:4px 8px; border-radius:6px; font-size:12px; display:flex; align-items:center; gap:4px;" onclick="undoLastAction()"><i data-lucide="rotate-ccw" width="14"></i> 취소</button>
              <button style="background:none; border:1px solid rgba(255,255,255,0.3); color:#fff; padding:4px 8px; border-radius:6px; font-size:12px;" onclick="clearDrawingLayer()">지우기</button>
              <button style="background:var(--primary); border:none; color:#fff; font-weight:700; padding:6px 12px; border-radius:6px; font-size:14px;" onclick="saveCanvas()">저장</button>
          </div>
      </div>
      <div class="canvas-container" id="canvasContainer"><canvas id="mainCanvas"></canvas></div>
      <div class="canvas-toolbar-wrap">
          <div class="tool-row">
              <button class="c-tool-btn" onclick="setTool('hand')" id="tool-hand"><i data-lucide="hand"></i><span>이동</span></button>
              <button class="c-tool-btn active" onclick="setTool('rect')" id="tool-rect"><i data-lucide="scan"></i><span>구역</span></button>
              <button class="c-tool-btn" onclick="setTool('brush')" id="tool-brush"><i data-lucide="brush"></i><span>펜</span></button>
              <button class="c-tool-btn" onclick="setTool('stamp')" id="tool-stamp"><i data-lucide="stamp"></i><span>도장</span></button>
              <button class="c-tool-btn" onclick="setTool('text')" id="tool-text"><i data-lucide="type"></i><span>문자</span></button>
              <button class="c-tool-btn" onclick="setTool('eraser')" id="tool-eraser"><i data-lucide="eraser"></i><span>삭제</span></button>
          </div>
          <div class="tool-row props">
              <div class="palette-container">
                  <button class="color-btn active" data-color="blue" onclick="setColor('blue')"></button>
                  <button class="color-btn" data-color="red" onclick="setColor('red')"></button>
                  <button class="color-btn" data-color="green" onclick="setColor('green')"></button>
                  <button class="color-btn" data-color="orange" onclick="setColor('orange')"></button>
                  <button class="color-btn" data-color="purple" onclick="setColor('purple')"></button>
                  <button class="color-btn" data-color="gray" onclick="setColor('gray')"></button>
              </div>
              <div style="width:1px; height:24px; background:#ddd; margin:0 8px;"></div>
              <input type="range" id="sizeSlider" min="20" max="200" value="50" style="width:80px;">
          </div>
          <div class="tool-row" id="stamp-options" style="display:none; gap:16px; background:#fafafa;">
             <button onclick="setStamp('circle')" class="c-tool-btn" data-shape="circle"><i data-lucide="circle"></i></button>
             <button onclick="setStamp('square')" class="c-tool-btn" data-shape="square"><i data-lucide="square"></i></button>
             <button onclick="setStamp('triangle')" class="c-tool-btn" data-shape="triangle"><i data-lucide="triangle"></i></button>
             <button onclick="setStamp('star')" class="c-tool-btn" data-shape="star"><i data-lucide="star"></i></button>
          </div>
      </div>
  </div>

  <div class="overlay" id="actionModal" onclick="closeModal()">
    <div class="sheet" id="sheetContent" onclick="event.stopPropagation()"></div>
  </div>

  <div class="loading-mask" id="loadingMask">
      <div class="spinner"></div>
      <div id="loadingText">처리 중...</div>
  </div>
  
  <div id="toast" class="toast-message">
    <i data-lucide="check-circle-2" style="width:20px; color:#4ade80;"></i>
    <span id="toast-text">저장되었습니다.</span>
  </div>

  <!-- 작업완료확인서 모달 -->
  <div id="work-report-modal">
    <header class="wr-header">
      <button class="wr-icon-btn" id="wr-btnBack"><i data-lucide="chevron-left" width="28"></i></button>
      <div class="wr-title">작업완료확인서</div>
      <div style="display:flex; align-items:center; gap:8px;">
        <button class="wr-icon-btn" id="wr-btnReset"><i data-lucide="rotate-ccw"></i></button>
        <button class="wr-icon-btn" id="wr-btnDownload"><i data-lucide="download"></i></button>
      </div>
    </header>
    <div class="wr-viewport" id="wr-viewport">
      <div class="wr-paper-wrapper" id="wr-paperWrapper">
        <div class="wr-a4-paper" id="wr-documentArea">
          <header class="wr-doc-header"><h1 class="wr-doc-title">작 업 완 료 확 인 서</h1></header>
          <table class="wr-info-table">
            <tr><th>현 장 명</th><td><input type="text" class="wr-input" value="자이 아파트 101동" placeholder="내용 입력"></td><th>공 사 명</th><td><input type="text" class="wr-input" placeholder="공사명 입력"></td></tr>
            <tr><th>작 업 자</th><td><input type="text" class="wr-input" placeholder="성명 입력"></td><th>연락처</th><td><input type="text" class="wr-input" placeholder="010-0000-0000"></td></tr>
          </table>
          <div class="wr-section-block"><div class="wr-sec-header">작업내용</div><textarea class="wr-textarea" style="flex:1; line-height:1.6;" placeholder="상세 내용">* 지하주차장 PC부재 균열보수 완료&#10;* </textarea></div>
          <div class="wr-section-block note"><div class="wr-sec-header">특기사항</div><textarea class="wr-textarea" style="flex:1;" placeholder="특이사항"></textarea></div>
          <div class="wr-footer-area">
            <div class="wr-confirm-msg">상기 사항과 같이 작업을 완료하였음을 확인합니다.</div>
            <input type="text" id="wr-dateField" class="wr-date-input" value="">
            <div class="wr-sign-grid">
              <div class="wr-sign-cell-text"><span class="wr-sign-label-text">소 속 :</span><input type="text" class="wr-sign-input-text" value="(주)이노피앤씨" placeholder="소속 입력"></div>
              <div class="wr-sign-cell-text"><span class="wr-sign-label-text">성 명 :</span><input type="text" class="wr-sign-input-text" placeholder="이름 입력"></div>
              <div class="wr-sign-cell-canvas">
                <div class="wr-sign-label-canvas">확인자 (서명)</div>
                <div class="wr-canvas-wrapper" id="wr-canvasContainer">
                  <canvas id="wr-signatureCanvas" class="wr-signature-canvas"></canvas>
                  <div id="wr-imageEditLayer">
                    <div id="wr-imageEditContainer"><img id="wr-editingImage" src="" alt="Sign Preview" draggable="false"></div>
                    <div class="wr-edit-controls-bar">
                      <div class="wr-slider-group"><span>크기</span><input type="range" id="wr-scaleSlider" min="0.2" max="3.0" step="0.05" value="1.0"></div>
                      <div style="display:flex; gap:8px;"><button class="wr-mini-btn" id="wr-btnEditCancel">취소</button><button class="wr-mini-btn active" id="wr-btnEditApply">적용</button></div>
                    </div>
                  </div>
                </div>
                <div class="wr-sign-tools" id="wr-signTools">
                  <div class="wr-sign-tools-group"><button class="wr-mini-btn active" id="wr-btnPen">🖊️ 펜</button><button class="wr-mini-btn" id="wr-btnEraser">🧹 지우개</button></div>
                  <div class="wr-sign-tools-group"><input type="file" id="wr-signImageInput" accept="image/*"><button class="wr-mini-btn" id="wr-btnImportCamera"><i data-lucide="camera" width="14"></i> 가져오기</button><button class="wr-mini-btn" id="wr-btnUndo"><i data-lucide="undo-2" width="14"></i> 되돌리기</button><button class="wr-mini-btn" id="wr-btnClearSign">전체삭제</button></div>
                </div>
              </div>
            </div>
            <div style="margin-top:20px;"><input type="text" class="wr-input" placeholder="회사명" style="text-align:center;"> <span style="font-size:18px; font-weight:700;">귀중</span></div>
          </div>
        </div>
      </div>
    </div>
    <div class="wr-controls-pill">
      <button class="wr-ctrl-btn" id="wr-btnZoomOut"><i data-lucide="minus"></i>축소</button>
      <button class="wr-ctrl-btn" id="wr-btnPanToggle"><i data-lucide="hand"></i>이동</button>
      <button class="wr-ctrl-btn" id="wr-btnZoomIn"><i data-lucide="plus"></i>확대</button>
      <button class="wr-ctrl-btn" id="wr-btnShare"><i data-lucide="share-2"></i>공유</button>
    </div>
    <div class="wr-toast" id="wr-toast"><i data-lucide="check" size="18"></i> <span id="wr-toastMsg">완료</span></div>
  </div>

  <!-- DMM2 도면마킹 모달 -->
  <div class="dmm2-root" id="dmm2Root" aria-hidden="true">
    <input id="dmm2FileInput" type="file" accept="image/*,application/pdf" multiple hidden />
    <!-- 모바일 업로드 옵션: 카메라/갤러리/파일 -->
    <input id="dmm2FileCamera" type="file" accept="image/*" capture="environment" hidden />
    <input id="dmm2FileGallery" type="file" accept="image/*" multiple hidden />
    <input id="dmm2FileAny" type="file" accept="image/*,application/pdf" multiple hidden />
    
    <!-- 업로드 선택 시트 -->
    <div class="dmm2-picker" id="dmm2Picker" aria-hidden="true">
      <div class="dmm2-picker-dim" data-close="1"></div>
      <div class="dmm2-picker-card" role="dialog" aria-modal="true" aria-label="업로드 방식 선택">
        <div class="dmm2-picker-title">업로드</div>
        <button class="dmm2-picker-btn" id="dmm2PickCamera"><i data-lucide="camera" width="18"></i><span>카메라</span></button>
        <button class="dmm2-picker-btn" id="dmm2PickGallery"><i data-lucide="image" width="18"></i><span>갤러리</span></button>
        <button class="dmm2-picker-btn" id="dmm2PickFile"><i data-lucide="file-up" width="18"></i><span>파일</span></button>
        <button class="dmm2-picker-cancel" data-close="1">취소</button>
      </div>
    </div>
    
    <!-- 텍스트 입력 모달 (모바일 prompt 오류 대체) -->
    <div class="dmm2-textm" id="dmm2TextM" aria-hidden="true">
      <div class="dmm2-textm-dim" data-close="1"></div>
      <div class="dmm2-textm-card" role="dialog" aria-modal="true" aria-label="텍스트 입력">
        <div class="dmm2-textm-title">텍스트 입력</div>
        <input class="dmm2-textm-input" id="dmm2TextInput" type="text" inputmode="text" autocomplete="off" placeholder="내용을 입력하세요" />
        <div class="dmm2-textm-actions">
          <button class="dmm2-cta" id="dmm2TextCancel" type="button">취소</button>
          <button class="dmm2-save" id="dmm2TextOk" type="button">적용</button>
        </div>
      </div>
    </div>
    
    <!-- DMM2 미리보기 모달 (미리보기창.html 스타일) -->
    <div class="dmm2-pm-overlay" id="dmm2PmOverlay">
        <header class="dmm2-pm-header">
            <button class="dmm2-pm-icon-btn" id="dmm2PmCloseBtn">
                <i data-lucide="chevron-left" width="24"></i>
            </button>
            <div class="dmm2-pm-title" id="dmm2PmTitle">미리보기</div>
            <div style="display:flex; gap: 4px;">
                <button class="dmm2-pm-icon-btn" id="dmm2PmSaveBtn">
                    <i data-lucide="download" width="20"></i>
                </button>
            </div>
        </header>
        <div class="dmm2-pm-viewport" id="dmm2PmViewport">
            <div class="dmm2-pm-content-wrapper" id="dmm2PmContent"></div>
        </div>
        <div class="dmm2-pm-controls">
            <button class="dmm2-pm-ctrl-btn" id="dmm2PmZoomOutBtn">
                <i data-lucide="minus" width="20"></i> 축소
            </button>
            <button class="dmm2-pm-ctrl-btn" id="dmm2PmPanBtn">
                <i data-lucide="hand" width="20"></i> 이동
            </button>
            <button class="dmm2-pm-ctrl-btn" id="dmm2PmZoomInBtn">
                <i data-lucide="plus" width="20"></i> 확대
            </button>
            <button class="dmm2-pm-ctrl-btn" id="dmm2PmShareBtn">
                <i data-lucide="share-2" width="20"></i> 공유
            </button>
        </div>
        <div class="dmm2-pm-loading" id="dmm2PmLoading">
            <div class="dmm2-pm-spinner"></div>
            <span>처리 중...</span>
        </div>
        <div class="dmm2-pm-toast" id="dmm2PmToast">
            <i data-lucide="check" size="16"></i>
            <span id="dmm2PmToastMsg">완료</span>
        </div>
    </div>
    
    <div class="dmm2-overlay" id="dmm2Overlay">
      <div class="dmm2-header">
        <div class="dmm2-hleft">
          <button class="dmm2-hbtn" id="dmm2CloseBtn"><i data-lucide="chevron-left" width="22"></i></button>
          <div class="dmm2-title" id="dmm2Title">도면 마킹</div>
          <div class="dmm2-subtitle" id="dmm2PageInfo"></div>
        </div>
        <div class="dmm2-hright">
          <button class="dmm2-cta" id="dmm2UndoBtn"><i data-lucide="rotate-ccw" width="16"></i> 취소</button>
          <button class="dmm2-cta" id="dmm2ClearBtn"><i data-lucide="eraser" width="16"></i> 지우기</button>
          <button class="dmm2-cta" id="dmm2PreviewBtn"><i data-lucide="scan-eye" width="16"></i> 미리보기</button>
          <button class="dmm2-save" id="dmm2SaveBtn"><i data-lucide="save" width="16"></i> 저장</button>
        </div>
      </div>
      <div class="dmm2-pages" id="dmm2PagesBar"></div>
      <div class="dmm2-canvas-wrap" id="dmm2CanvasWrap">
        <canvas class="dmm2-canvas" id="dmm2Canvas"></canvas>
        <div class="dmm2-loading" id="dmm2Loading"><div class="dmm2-spinner"></div><div id="dmm2LoadingText">처리 중...</div></div>
        <div class="dmm2-toast" id="dmm2Toast"><i data-lucide="check" width="16"></i><span id="dmm2ToastMsg">완료</span></div>
      </div>
      <div class="dmm2-toolbar">
        <div class="dmm2-row">
          <button class="dmm2-tool" data-tool="hand" id="dmm2ToolHand"><i data-lucide="hand"></i><span>이동</span></button>
          <button class="dmm2-tool dmm2-active" data-tool="rect" id="dmm2ToolRect"><i data-lucide="scan"></i><span>구역</span></button>
          <button class="dmm2-tool" data-tool="brush" id="dmm2ToolBrush"><i data-lucide="brush"></i><span>펜</span></button>
          <button class="dmm2-tool" data-tool="stamp" id="dmm2ToolStamp"><i data-lucide="stamp"></i><span>도장</span></button>
          <button class="dmm2-tool" data-tool="text" id="dmm2ToolText"><i data-lucide="type"></i><span>문자</span></button>
          <button class="dmm2-tool" data-tool="eraser" id="dmm2ToolEraser"><i data-lucide="eraser"></i><span>삭제</span></button>
        </div>
        <div class="dmm2-row dmm2-props">
          <div class="dmm2-palette" id="dmm2Palette">
            <button class="dmm2-color dmm2-active" data-c="blue"></button>
            <button class="dmm2-color" data-c="red"></button>
            <button class="dmm2-color" data-c="gray"></button>
            <button class="dmm2-color" data-c="green"></button>
            <button class="dmm2-color" data-c="orange"></button>
            <button class="dmm2-color" data-c="purple"></button>
          </div>
          <div class="dmm2-sep"></div>
          <input class="dmm2-range" id="dmm2Size" type="range" min="2" max="100" value="30" />
          <button class="dmm2-cta" id="dmm2FitBtn"><i data-lucide="maximize-2" width="16"></i> 맞춤</button>
        </div>
        <div class="dmm2-row dmm2-stamps" id="dmm2StampRow">
          <button class="dmm2-tool dmm2-active" data-stamp="circle"><i data-lucide="circle"></i><span>원</span></button>
          <button class="dmm2-tool" data-stamp="square"><i data-lucide="square"></i><span>사각</span></button>
          <button class="dmm2-tool" data-stamp="triangle"><i data-lucide="triangle"></i><span>삼각</span></button>
          <button class="dmm2-tool" data-stamp="star"><i data-lucide="star"></i><span>별</span></button>
        </div>
      </div>
    </div>
  </div>

  <script>
    lucide.createIcons();

    /* =======================================================
       1. GLOBAL & MAIN LOGIC
       ======================================================= */
    let pendingFiles = [];
    let uploadedDrawingFile = null; 
    
    function openMenu() { document.getElementById('menuBackdrop').classList.add('active'); document.getElementById('menuPanel').classList.add('active'); }
    function closeMenu() { document.getElementById('menuBackdrop').classList.remove('active'); document.getElementById('menuPanel').classList.remove('active'); }
    function openNotification() { document.getElementById('notiBackdrop').classList.add('active'); document.getElementById('notiPanel').classList.add('active'); document.getElementById('notificationBadge').classList.add('hidden'); renderNotifications(); }
    function closeNotification() { document.getElementById('notiBackdrop').classList.remove('active'); document.getElementById('notiPanel').classList.remove('active'); }
    function openAccount() { document.getElementById('accountOverlay').classList.add('active'); closeMenu(); }
    function closeAccount() { document.getElementById('accountOverlay').classList.remove('active'); }
    function toggleDarkMode() {
        document.body.classList.toggle('dark-mode');
        const isDark = document.body.classList.contains('dark-mode');
        // 헤더 삭제로 인해 아이콘 버튼이 없으므로, 필요시 로직만 유지
        // document.getElementById('darkModeIcon').setAttribute('data-lucide', isDark ? 'sun' : 'moon');
        // document.getElementById('darkModeLabel').innerText = isDark ? '라이트모드' : '다크모드';
        lucide.createIcons();
    }

    let photoCount = 0;
    let drawingCount = 0;
    
    function handleBulkUpload(input) {
        if(input.files.length > 0) {
            pendingFiles = Array.from(input.files);
            photoCount += pendingFiles.length;
            showToast(`${pendingFiles.length}장 등록`);
            updateSummaryData();
            checkRequiredFields();
        }
    }

    function openDrawingMarkingMenu() {
        // 바텀시트 열기 (도면업로드/도면불러오기 선택)
        const backdrop = document.getElementById('drawingSheetBackdrop');
        const sheet = document.getElementById('drawingSheet');
        if (backdrop && sheet) {
            backdrop.classList.add('active');
            sheet.classList.add('active');
        }
    }
    
    // 도면업로드: 바로 파일 선택 (바텀시트 없이, 저장만 수행)
    function openDrawingUploadDirect() {
        // 바텀시트 없이 바로 파일 선택
        const fileInput = document.getElementById('drawingFileInput');
        if (fileInput) {
            fileInput.dataset.directUpload = 'true';
            fileInput.click();
        }
    }
    
    function closeDrawingMarkingMenu() {
        const backdrop = document.getElementById('drawingSheetBackdrop');
        const sheet = document.getElementById('drawingSheet');
        if (!backdrop || !sheet) return;
        backdrop.classList.remove('active');
        sheet.classList.remove('active');
    }
    
    // 도면 업로드: 카메라/갤러리/파일 선택 (바로 열림)
    function openDrawingUpload() {
        closeDrawingMarkingMenu();
        // 모바일에서는 파일 input 클릭 시 카메라/갤러리/파일 선택 옵션이 나타남
        // 데스크톱에서는 파일 선택만 가능
        const fileInput = document.getElementById('drawingFileInput');
        if (fileInput) {
            fileInput.dataset.directUpload = 'true';
            fileInput.click();
        }
    }
    
    // 도면 업로드 후 저장만 하고 토스트 알림 (도면마킹 툴 열지 않음)
    async function handleDrawingUploadForSave(input) {
        if (!input.files || input.files.length === 0) return;
        
        const files = Array.from(input.files);
        
        try {
            const siteSelect = document.getElementById('siteSelect');
            const siteValue = siteSelect ? siteSelect.value : '';
            const siteName = siteSelect ? siteSelect.options[siteSelect.selectedIndex]?.text || '' : '';
            const dateEl = document.getElementById('input-date');
            const inputDate = dateEl ? dateEl.value : (new Date().toISOString().slice(0,10));
            
            // 파일을 DataURL로 변환
            const filePromises = files.map(file => {
                return new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onload = (e) => resolve({ 
                        name: file.name, 
                        dataUrl: e.target.result,
                        type: file.type,
                        size: file.size
                    });
                    reader.readAsDataURL(file);
                });
            });
            
            const fileData = await Promise.all(filePromises);
            
            // 워크로그 데이터 구조에 맞게 저장
            const worklogData = {
                site: siteValue,
                siteName: siteName,
                date: inputDate,
                type: 'drawing-upload',
                files: fileData,
                timestamp: new Date().toISOString()
            };
            
            // 로컬 스토리지에 저장 (실제로는 서버 API 호출)
            let existingLogs = [];
            try {
                existingLogs = JSON.parse(localStorage.getItem('worklog_drawings') || '[]');
                if (!Array.isArray(existingLogs)) existingLogs = [];
            } catch (e) {
                existingLogs = [];
            }
            existingLogs.push(worklogData);

            // [보강] 용량 초과(QuotaExceededError) 발생 시 오래된 로그부터 정리 후 재시도
            try {
                localStorage.setItem('worklog_drawings', JSON.stringify(existingLogs));
            } catch (e) {
                // 오래된 항목부터 제거하며 재시도
                let saved = false;
                while (existingLogs.length > 1) {
                    existingLogs.shift();
                    try {
                        localStorage.setItem('worklog_drawings', JSON.stringify(existingLogs));
                        saved = true;
                        break;
                    } catch (e2) {}
                }
                if (!saved) {
                    // 그래도 실패하면(도면 데이터가 너무 큼) 이미지 데이터는 저장하지 않고 메타만 저장 시도
                    try {
                        const slim = { ...worklogData, drawings: [] };
                        const slimLogs = [];
                        slimLogs.push(slim);
                        localStorage.setItem('worklog_drawings', JSON.stringify(slimLogs));
                        showToast('저장 용량 초과: 도면 이미지는 제외하고 저장했습니다');
                    } catch (e3) {
                        console.error('로컬 저장 실패(용량):', e3);
                        throw e; // 상위 catch로 전달
                    }
                }
            }
            
            // 도면 카운트 업데이트
            drawingCount += files.length;
            
            // 요약 카드의 도면 업로드 건수 업데이트
            const sumDrawingsEl = document.getElementById('sum-drawings');
            if (sumDrawingsEl) {
                sumDrawingsEl.innerText = `${drawingCount}건`;
            }
            
            showToast(`도면 ${files.length}건 저장 완료`);
            console.log('도면이 저장되었습니다:', worklogData);
        } catch (error) {
            console.error('도면 저장 오류:', error);
            showToast('저장 오류');
        }
        
        // 입력 초기화
        input.value = '';
    }
    
    // 파일 업로드 후 저장만 수행 (도면마킹 툴 절대 열지 않음)
    async function handleDrawingUpload(input) {
        if (!input.files || input.files.length === 0) return;
        
        // 직접 업로드 모드인 경우 저장만 수행 (마킹 툴 절대 열지 않음)
        if (input.dataset.directUpload === 'true') {
            await handleDrawingUploadForSave(input);
            // 플래그 초기화
            input.dataset.directUpload = 'false';
            return;
        }
        
        // 기존 로직은 사용하지 않음 (업로드는 저장만 수행)
        // 필요시 별도 함수로 분리
    }
    
    // 워크로그에 도면 저장
    async function saveDrawingToWorklog(payload) {
        try {
            const siteSelect = document.getElementById('siteSelect');
            const siteValue = siteSelect ? siteSelect.value : '';
            const siteName = siteSelect ? siteSelect.options[siteSelect.selectedIndex].text : '';
            const dateEl = document.getElementById('input-date');
            const inputDate = dateEl ? dateEl.value : (new Date().toISOString().slice(0,10));
            
            // 페이지 데이터 추출
            const pages = payload.pages || [];
            const pageCount = pages.length;
            
            // 워크로그 데이터 구조에 맞게 저장
            // 실제 구현에서는 서버 API 호출 또는 로컬 스토리지에 저장
            const worklogData = {
                site: siteValue,
                siteName: siteName,
                date: inputDate,
                type: 'drawing-marking',
                drawings: pages,
                pageCount: pageCount,
                timestamp: new Date().toISOString()
            };
            
            // 로컬 스토리지에 저장 (실제로는 서버 API 호출)
            const existingLogs = JSON.parse(localStorage.getItem('worklog_drawings') || '[]');
            existingLogs.push(worklogData);
            localStorage.setItem('worklog_drawings', JSON.stringify(existingLogs));
            
            // 도면 카운트 업데이트
            drawingCount += pageCount;
            
            // 요약 카드의 도면 업로드 건수 업데이트
            const sumDrawingsEl = document.getElementById('sum-drawings');
            if (sumDrawingsEl) {
                sumDrawingsEl.innerText = `${drawingCount}건`;
            }
            
            console.log('도면이 워크로그에 저장되었습니다:', worklogData);
            showToast(`도면 ${pageCount}건 저장 완료`);
        } catch (error) {
            console.error('워크로그 저장 오류:', error);
            showToast('저장 오류');
        }
    }
    
    // 현장에 연동된 도면 불러오기 → 도면마킹.html 실행 (바로 실행)
    async function openSiteDrawingMarkingDirect() {
        // 바텀시트 닫기
        const backdrop = document.getElementById('drawingSheetBackdrop');
        const sheet = document.getElementById('drawingSheet');
        if (backdrop && sheet) {
            backdrop.classList.remove('active');
            sheet.classList.remove('active');
        }
        
        // 바로 도면마킹 툴 실행
        await openSiteDrawingMarking();
    }
    
    // 현장에 연동된 도면 불러오기 → 도면마킹.html 실행 (선택 창 없이 바로 실행)
    async function openSiteDrawingMarking() {
        const siteSelect = document.getElementById('siteSelect');
        const siteValue = siteSelect ? siteSelect.value : '';
        const siteName = siteSelect ? siteSelect.options[siteSelect.selectedIndex]?.text || '현장' : '현장';
        
        // 테스트 도면 데이터 즉시 생성 (A4 비율: 1240 x 1754)
        const canvas = document.createElement('canvas');
        canvas.width = 1240;
        canvas.height = 1754;
        const ctx = canvas.getContext('2d');
        
        // 배경 (흰색)
        ctx.fillStyle = '#ffffff';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        // 테두리
        ctx.strokeStyle = '#000000';
        ctx.lineWidth = 3;
        ctx.strokeRect(20, 20, canvas.width - 40, canvas.height - 40);
        
        // 제목 영역
        ctx.fillStyle = '#1a254f';
        ctx.font = 'bold 48px Pretendard, sans-serif';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText('현장 도면', canvas.width / 2, 150);
        
        // 현장 정보
        ctx.fillStyle = '#475569';
        ctx.font = 'bold 32px Pretendard, sans-serif';
        ctx.fillText(siteName, canvas.width / 2, 250);
        
        // 그리드 라인
        ctx.strokeStyle = '#cbd5e1';
        ctx.lineWidth = 1;
        for (let i = 0; i < 10; i++) {
            const y = 350 + i * 140;
            ctx.beginPath();
            ctx.moveTo(50, y);
            ctx.lineTo(canvas.width - 50, y);
            ctx.stroke();
        }
        
        // 좌측 세로 라인
        for (let i = 0; i < 8; i++) {
            const x = 50 + i * 150;
            ctx.beginPath();
            ctx.moveTo(x, 350);
            ctx.lineTo(x, canvas.height - 50);
            ctx.stroke();
        }
        
        // 즉시 DataURL 생성 (비동기 대기 없이)
        const dataUrl = canvas.toDataURL('image/png', 0.95);
        
        // 내장된 DMM2 모달로 바로 열기 (새 창 제거로 검은 화면 문제 근본 해결)
        if (window.DMM2 && window.DMM2.openWith) {
            // 저장 콜백 설정 - 도면마킹 저장 시 데이터 연동
            window.DMM2.onSave(async (payload) => {
                await saveDrawingToWorklog(payload);
            });
            
            // 데이터 전달 및 마킹 툴 열기
            window.DMM2.openWith([dataUrl]).catch(err => {
                console.error('도면마킹 툴 열기 오류:', err);
                showToast('도면 마킹 기능을 로드하는 중입니다.');
            });
        } else {
            showToast('도면 마킹 기능을 사용할 수 없습니다.');
        }
    }
    
    // 파일 입력 이벤트 리스너
    document.addEventListener('DOMContentLoaded', function() {
        const cameraInput = document.getElementById('drawingCameraInput');
        const galleryInput = document.getElementById('drawingGalleryInput');
        const fileInput = document.getElementById('drawingFileInput');
        
        // 도면업로드 버튼에서 직접 호출된 경우 저장만 수행
        if (cameraInput) {
            cameraInput.addEventListener('change', (e) => {
                // 바텀시트에서 호출된 경우 도면마킹 툴 열기, 직접 호출된 경우 저장만
                if (e.target.dataset.directUpload === 'true') {
                    handleDrawingUploadForSave(e.target);
                } else {
                    handleDrawingUpload(e.target);
                }
            });
        }
        if (galleryInput) {
            galleryInput.addEventListener('change', (e) => {
                if (e.target.dataset.directUpload === 'true') {
                    handleDrawingUploadForSave(e.target);
                } else {
                    handleDrawingUpload(e.target);
                }
            });
        }
        if (fileInput) {
            fileInput.addEventListener('change', (e) => {
                // 바텀시트에서 호출된 경우 도면마킹 툴 열기, 직접 호출된 경우 저장만
                if (e.target.dataset.directUpload === 'true') {
                    handleDrawingUploadForSave(e.target);
                } else {
                    handleDrawingUpload(e.target);
                }
            });
        }
    });
    

    /* 공도면 불러오기 로직 추가 */
    function loadBlankDrawing() {
        // 흰색 배경의 캔버스 생성 (A4 비율: 1240 x 1754)
        const canvas = document.createElement('canvas');
        canvas.width = 1240; 
        canvas.height = 1754; 
        const ctx = canvas.getContext('2d');
        ctx.fillStyle = '#ffffff';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        // DMM2로 공도면 전달
        canvas.toBlob((blob) => {
            const file = new File([blob], "blank-drawing.jpg", { type: "image/jpeg" });
            if (window.DMM2 && window.DMM2.openFilePicker) {
                const dmm2Input = document.getElementById('dmm2FileInput');
                if (dmm2Input) {
                    const dt = new DataTransfer();
                    dt.items.add(file);
                    dmm2Input.files = dt.files;
                    dmm2Input.dispatchEvent(new Event('change', { bubbles: true }));
                }
            }
        }, 'image/jpeg', 0.9);
        
        uploadedDrawingFile = { type: 'image/generated' };
        showToast("공도면 로드");
    }

    function openMarkingModal() {
        if(!uploadedDrawingFile) { alert("도면을 먼저 등록하거나 공도면을 불러오세요."); return; }
        
        // 공도면으로 생성된 경우(이미지 로드 완료 상태)가 아니면 파일을 읽음
        if(uploadedDrawingFile.type !== 'image/generated') {
            if(!uploadedDrawingFile.type.startsWith('image/')) { alert("이미지 파일만 마킹할 수 있습니다."); return; }
            const reader = new FileReader();
            reader.onload = e => {
                mkImgObj.src = e.target.result;
                mkImgObj.onload = initMarkingCanvas;
            };
            reader.readAsDataURL(uploadedDrawingFile);
        } else {
            // 이미 mkImgObj에 로드되어 있음
            initMarkingCanvas();
        }
    }

    const notificationData = [
        { id: 1, type: 'alert', badge: '긴급', title: '현장 안전 점검 요망', desc: 'A구역 비계 설치 상태 확인 부탁드립니다.', time: '방금 전', icon: 'alert-triangle' },
        { id: 2, type: 'info', badge: '공지', title: '12월 시스템 점검 안내', desc: '12월 10일 오전 2시~4시 서버 점검이 있습니다.', time: '2시간 전', icon: 'info' }
    ];
    function renderNotifications() {
        const listContainer = document.getElementById('notificationList');
        listContainer.innerHTML = '';
        notificationData.forEach(noti => {
            const li = document.createElement('li');
            li.className = `noti-item`;
            li.innerHTML = `<div class="noti-icon-box type-${noti.type}"><i data-lucide="${noti.icon}" style="width:20px;"></i></div><div class="noti-content"><span class="noti-item-title">${noti.title}</span><span class="noti-item-desc">${noti.desc}</span><span class="noti-time">${noti.time}</span></div>`;
            listContainer.appendChild(li);
        });
        lucide.createIcons();
    }
    // initNoticeSlider function definition kept for safety, but not called
    function initNoticeSlider() {
      const container = document.getElementById('notice-slider');
      if(container && notificationData.length > 0) {
          const n = notificationData[0];
          let bClass = n.type==='alert'?'badge-alert':'badge-info';
          container.innerHTML = `<div class="notice-item active"><span class="notice-badge ${bClass}">${n.badge}</span><span class="notice-text">${n.title}</span></div>`;
      }
    }

    let workSetCount = 0;
    function addWorkSet() {
      workSetCount++;
      const container = document.getElementById('work-content-list');
      const newSet = document.createElement('div');
      newSet.className = 'work-set-item';
      newSet.innerHTML = `
        <div class="work-set-top"><span class="set-badge">작업 세트 ${workSetCount}</span><button class="btn-delete-capsule" onclick="this.closest('.work-set-item').remove(); updateSummaryData();">삭제</button></div>
        <div style="margin-bottom:12px;">
          <label class="form-label">부재명 <span style="color:var(--danger)">*</span></label>
          <div class="chip-grid" data-type="member"><button class="select-chip" onclick="toggleChip(this)">슬라브</button><button class="select-chip" onclick="toggleChip(this)">거더</button><button class="select-chip" onclick="toggleChip(this)">기둥</button><button class="select-chip" onclick="toggleChip(this)">기타</button></div>
          <div class="other-input-wrap"><div class="other-input-inner"><input type="text" class="form-input" placeholder="부재명 입력" oninput="handleMemberInputComplete(this)" onblur="updateSummaryData()"></div></div>
        </div>
        <div style="margin-bottom:12px;">
          <label class="form-label">작업공정 <span style="color:var(--danger)">*</span></label>
          <div class="chip-grid" data-type="process"><button class="select-chip" onclick="toggleChip(this)">균열</button><button class="select-chip" onclick="toggleChip(this)">면</button><button class="select-chip" onclick="toggleChip(this)">마감</button><button class="select-chip" onclick="toggleChip(this)">기타</button></div>
          <div class="other-input-wrap"><div class="other-input-inner"><input type="text" class="form-input" placeholder="공정 입력" oninput="handleProcessInputComplete(this)" onblur="updateSummaryData()"></div></div>
        </div>
        <div style="margin-bottom:12px;">
          <label class="form-label">작업유형</label>
          <div class="chip-grid" data-type="type"><button class="select-chip" onclick="toggleChip(this)">지하</button><button class="select-chip" onclick="toggleChip(this)">지상</button><button class="select-chip" onclick="toggleChip(this)">지붕</button><button class="select-chip" onclick="toggleChip(this)">기타</button></div>
          <div class="other-input-wrap"><div class="other-input-inner"><input type="text" class="form-input" placeholder="유형 입력" oninput="updateSummaryData()"></div></div>
        </div>
        <div style="margin-bottom:0px;">
          <label class="form-label">블럭 / 동 / 층</label>
          <div class="input-grid-3">
            <input type="text" class="form-input" placeholder="블럭" style="text-align:center;" oninput="updateSummaryData()">
            <input type="text" class="form-input" placeholder="동" style="text-align:center;" oninput="updateSummaryData()">
            <input type="text" class="form-input" placeholder="층" style="text-align:center;" oninput="updateSummaryData()">
          </div>
        </div>
      `;
      container.appendChild(newSet);
      updateSummaryData();
    }
    function toggleChip(el) {
      const grid = el.closest('.chip-grid');
      const container = grid.parentElement;
      const isOther = el.innerText === '기타';
      const wasActive = el.classList.contains('active');
      const currentActive = grid.querySelector('.select-chip.active');
      if(currentActive && currentActive !== el) currentActive.classList.remove('active');
      el.classList.toggle('active');
      
      // 클릭 직후 포커스를 해제하여 CSS :focus 효과(파란 그림자)를 즉시 제거
      el.blur();
      
      const otherWrap = container.querySelector('.other-input-wrap');
      if (otherWrap) {
          if (isOther && el.classList.contains('active')) {
              otherWrap.classList.add('show');
              // 기타 선택 시 입력 필드에 포커스
              const input = otherWrap.querySelector('.form-input');
              if (input) {
                  setTimeout(() => input.focus(), 100);
              }
          } else {
              otherWrap.classList.remove('show');
          }
      }
      
      // 부재명/작업공정 선택 시 에러 효과 즉시 해제
      const dataType = grid.getAttribute('data-type');
      if (dataType === 'member' || dataType === 'process') {
          // 해당 섹션의 에러 효과 제거
          const memberSection = grid.closest('div');
          if (memberSection) {
              memberSection.classList.remove('section-error-highlight');
              memberSection.style.border = '';
              memberSection.style.borderRadius = '';
              memberSection.style.padding = '';
              memberSection.style.backgroundColor = '';
              memberSection.style.animation = '';
          }
      }
      
      // 부재명/작업공정 선택 완료 시 다음 단계 안내
      if (dataType === 'member' && el.classList.contains('active') && !isOther) {
          // 다음 단계로 이동: 작업공정 선택 영역으로 스크롤 및 강조
          setTimeout(() => {
              const processGrid = container.parentElement.querySelector('.chip-grid[data-type="process"]');
              if (processGrid && !processGrid.querySelector('.select-chip.active')) {
                  guideToNextStep(processGrid, '작업공정을 선택해주세요');
              }
          }, 300);
      } else if (dataType === 'process' && el.classList.contains('active') && !isOther) {
          // 모든 필수 항목 입력 완료 확인
          checkAllRequiredComplete();
      }
      
      updateSummaryData();
    }
    
    // 다음 단계로 이동하여 순서 안내하는 함수
    function guideToNextStep(elementIdOrSelector, message, isCardBox = false) {
      let targetElement = null;
      
      // ID로 찾기
      if (typeof elementIdOrSelector === 'string' && elementIdOrSelector.startsWith('#')) {
          targetElement = document.querySelector(elementIdOrSelector);
      } else if (typeof elementIdOrSelector === 'string') {
          targetElement = document.getElementById(elementIdOrSelector);
      } else {
          targetElement = elementIdOrSelector;
      }
      
      if (!targetElement) return;
      
      // 카드박스로 감싸기 (필요한 경우)
      if (isCardBox && targetElement.closest('.card-box')) {
          targetElement = targetElement.closest('.card-box');
      } else if (isCardBox && !targetElement.classList.contains('card-box')) {
          // 카드박스가 아니면 찾기
          const cardBox = targetElement.closest('.card-box');
          if (cardBox) targetElement = cardBox;
      }
      
      // 기존 안내 효과 제거
      document.querySelectorAll('.next-step-guide').forEach(el => {
          el.classList.remove('next-step-guide');
      });
      
      // 다음 단계 안내 메시지 표시
      showNextStepMessage(message);
      
      // 타겟 요소에 강조 효과 추가
      // 단일 입력 필드인 경우 스타일 직접 적용
      if (targetElement.tagName === 'INPUT' || targetElement.tagName === 'SELECT' || targetElement.tagName === 'TEXTAREA') {
          targetElement.style.borderColor = '#87CEEB';
          targetElement.style.boxShadow = '0 0 0 3px rgba(135, 206, 235, 0.15)';
          targetElement.style.animation = 'nextStepPulse 2s ease-in-out 2';
      } else {
          // 그룹/칩 영역인 경우 클래스 추가
          targetElement.classList.add('next-step-guide');
      }
      
      // 부드럽게 스크롤
      setTimeout(() => {
          targetElement.scrollIntoView({ 
              behavior: 'smooth', 
              block: 'center',
              inline: 'nearest'
          });
      }, 100);
      
      // 포커스 (입력 가능한 요소인 경우)
      if (targetElement.tagName === 'INPUT' || targetElement.tagName === 'SELECT' || targetElement.tagName === 'TEXTAREA') {
          setTimeout(() => {
              targetElement.focus();
          }, 500);
      }
      
      // 3초 후 강조 효과 제거
      setTimeout(() => {
          if (targetElement.tagName === 'INPUT' || targetElement.tagName === 'SELECT' || targetElement.tagName === 'TEXTAREA') {
              targetElement.style.borderColor = '';
              targetElement.style.boxShadow = '';
              targetElement.style.animation = '';
          } else {
              targetElement.classList.remove('next-step-guide');
          }
      }, 3000);
    }
    
    // 다음 단계 안내 메시지 표시 함수
    function showNextStepMessage(message) {
      // 기존 메시지 제거
      const existingMsg = document.querySelector('.next-step-message');
      if (existingMsg) {
          existingMsg.remove();
      }
      
      // 새 메시지 생성
      const msg = document.createElement('div');
      msg.className = 'next-step-message';
      msg.innerHTML = `<i data-lucide="arrow-down" width="18"></i> ${message}`;
      document.body.appendChild(msg);
      
      if (window.lucide) lucide.createIcons();
      
      // 애니메이션 시작
      setTimeout(() => {
          msg.classList.add('show');
      }, 10);
      
      // 2.5초 후 제거
      setTimeout(() => {
          msg.style.opacity = '0';
          msg.style.transform = 'translateX(-50%) translateY(-20px)';
          setTimeout(() => {
              if (msg.parentElement) msg.remove();
          }, 400);
      }, 2500);
    }
    
    // 부재명 직접입력 완료 처리
    function handleMemberInputComplete(input) {
      if (input.value.trim()) {
          // 다음 단계로 이동: 작업공정 선택 영역으로 스크롤 및 강조
          setTimeout(() => {
              const processGrid = input.closest('.work-set-item').querySelector('.chip-grid[data-type="process"]');
              if (processGrid && !processGrid.querySelector('.select-chip.active')) {
                  guideToNextStep(processGrid, '작업공정을 선택해주세요');
              }
          }, 300);
      }
      updateSummaryData();
    }
    
    // 작업공정 직접입력 완료 처리
    function handleProcessInputComplete(input) {
      if (input.value.trim()) {
          // 모든 필수 항목 입력 완료 확인
          checkAllRequiredComplete();
      }
      updateSummaryData();
    }
    
    // 자재 사용 내역 수량 검증 함수
    function validateMaterialQuantities() {
      const matItems = document.querySelectorAll('.mat-item');
      if (matItems.length === 0) return true; // 자재가 없으면 검증 통과
      
      for (let item of matItems) {
        const qtyText = item.querySelector('span[style*="color:var(--primary)"]')?.textContent || '';
        // "말" 단위 제거하고 숫자만 추출
        const qtyMatch = qtyText.match(/(\d+(?:\.\d+)?)/);
        if (qtyMatch) {
          const qty = parseFloat(qtyMatch[1]);
          // 0보다 큰 숫자인지 확인 (0 포함하여 차단)
          if (isNaN(qty) || qty <= 0) {
            return false;
          }
        } else {
          return false;
        }
      }
      return true;
    }
    
    // 수량 입력 필드 실시간 검증
    function validateMaterialQtyInput() {
      const qtyInput = document.getElementById('mat-qty');
      if (!qtyInput) return;
      
      const qtyValue = parseFloat(qtyInput.value) || 0;
      const matItems = document.querySelectorAll('.mat-item');
      
      // 입력 필드가 비어있거나 유효하지 않은 경우 (0 이하 포함)
      if (qtyInput.value.trim() === '' || isNaN(qtyValue) || qtyValue <= 0) {
        // 에러 스타일 제거 (입력 중이므로)
        qtyInput.style.borderColor = '';
        qtyInput.style.boxShadow = '';
        qtyInput.classList.remove('error-shake');
      } else {
        // 유효한 입력인 경우 정상 스타일
        qtyInput.style.borderColor = '';
        qtyInput.style.boxShadow = '';
        qtyInput.classList.remove('error-shake');
      }
      
      // 저장 가능 여부 업데이트
      checkAllRequiredComplete();
    }
    
    // 모든 필수 항목 입력 완료 확인
    function checkAllRequiredComplete() {
      const regionChips = document.querySelectorAll('.chip-grid[data-type="region"] .select-chip.active');
      const siteSelect = document.getElementById('siteSelect');
      const inputDate = document.getElementById('input-date');
      const hasValidManpower = manpowerList.length > 0 && manpowerList.some(m => m.worker && m.workHours > 0);
      const firstSet = document.querySelector('.work-set-item');
      const hasValidMaterials = validateMaterialQuantities();
      
      let hasMember = false;
      let hasProcess = false;
      
      if (firstSet) {
          const memberChip = firstSet.querySelector('.chip-grid[data-type="member"] .select-chip.active');
          const memberInput = firstSet.querySelector('.chip-grid[data-type="member"]')?.closest('div').querySelector('.other-input-wrap .form-input');
          if (memberChip) {
              const chipText = memberChip.innerText.trim();
              hasMember = chipText !== '기타' || (memberInput && memberInput.value.trim());
          }
          
          const processChip = firstSet.querySelector('.chip-grid[data-type="process"] .select-chip.active');
          const processInput = firstSet.querySelector('.chip-grid[data-type="process"]')?.closest('div').querySelector('.other-input-wrap .form-input');
          if (processChip) {
              const chipText = processChip.innerText.trim();
              hasProcess = chipText !== '기타' || (processInput && processInput.value.trim());
          }
      }
      
      const allComplete = regionChips.length > 0 && 
                         siteSelect && siteSelect.value.trim() && 
                         inputDate && inputDate.value.trim() && 
                         hasValidManpower && 
                         hasMember && 
                         hasProcess &&
                         hasValidMaterials;
      
      if (allComplete) {
          // 모든 필수 항목 입력 완료 시 버튼 영역에 표시
          const buttonArea = document.getElementById('floatingActionButtons');
          const saveBtn = document.querySelector('.btn-save');
          
          if (buttonArea) {
              // 기존 배지 제거
              const existingBadge = buttonArea.querySelector('.ready-to-save-badge');
              if (existingBadge) {
                  existingBadge.remove();
              }
              
              // 버튼 영역에 "저장 가능" 표시 추가
              buttonArea.classList.add('ready-to-save');
              
              // 배지 추가
              const badge = document.createElement('div');
              badge.className = 'ready-to-save-badge';
              badge.textContent = '✓ 저장 가능';
              buttonArea.appendChild(badge);
          }
          
          if (saveBtn) {
              saveBtn.classList.add('ready');
          }
      } else {
          // 필수 입력이 완료되지 않은 경우 표시 제거
          const buttonArea = document.getElementById('floatingActionButtons');
          const saveBtn = document.querySelector('.btn-save');
          
          if (buttonArea) {
              buttonArea.classList.remove('ready-to-save');
              const existingBadge = buttonArea.querySelector('.ready-to-save-badge');
              if (existingBadge) {
                  existingBadge.remove();
              }
          }
          
          if (saveBtn) {
              saveBtn.classList.remove('ready');
          }
      }
    }
    let manpowerList = [];
    const predefinedWorkers = ['이현수', '김철수', '박영희', '정민수', '최지영'];
    
    function addManpowerRow(opts = null) {
      const container = document.getElementById('manpower-list');
      container.classList.remove('section-error-highlight');
      container.style.border = '';
      container.style.backgroundColor = '';

      const locked = !!(opts && opts.locked);
      const presetWorker = (opts && opts.presetWorker) ? String(opts.presetWorker) : '';

      // 기본 인원(가입자)은 1회만 생성
      if (locked && manpowerList.some(m => m.locked)) return;

      const id = Date.now();
      const newItem = { id, worker: presetWorker || '', workHours: 1.0, isCustom: false, locked };
      manpowerList.push(newItem);

      const newRow = document.createElement('div');
      newRow.className = 'manpower-row' + (locked ? ' locked' : '');
      newRow.dataset.id = id;

      if (locked) {
        newRow.innerHTML = `
          <div class="mp-name-text">${newItem.worker}</div>
          <div class="stepper mp-stepper">
            <button class="btn-step" onclick="updateManpowerHours(${id}, -0.5)">－</button>
            <span class="step-val" data-id="${id}">1.0</span>
            <button class="btn-step" onclick="updateManpowerHours(${id}, 0.5)">＋</button>
          </div>
        `;
      } else {
        newRow.innerHTML = `
          <div class="manpower-select-wrapper">
            <select class="form-select manpower-worker-select" onchange="updateManpowerWorker(${id}, this.value)">
              <option value="">작업자 선택</option>
              ${predefinedWorkers.map(w => `<option value="${w}">${w}</option>`).join('')}
              <option value="__custom__">직접입력</option>
            </select>
            <input type="text" class="form-input manpower-custom-input" placeholder="이름 직접 입력" style="display:none;" onblur="handleCustomWorkerInput(${id}, this.value)">
          </div>
          <div class="stepper mp-stepper">
            <button class="btn-step" onclick="updateManpowerHours(${id}, -0.5)">－</button>
            <span class="step-val" data-id="${id}">1.0</span>
            <button class="btn-step" onclick="updateManpowerHours(${id}, 0.5)">＋</button>
          </div>
          <button class="btn-delete-capsule mp-del-btn" onclick="removeManpowerRow(${id})" style="width:auto; padding:0 14px; margin-left:8px;">삭제</button>
        `;
      }

      container.appendChild(newRow);
      lucide.createIcons();
      updateSummaryData();
    }
    
    function handleCustomWorkerInput(id, value) {
      const item = manpowerList.find(m => m.id === id);
      if (!item) return;
      
      const row = document.querySelector(`.manpower-row[data-id="${id}"]`);
      if (!row) return;
      
      const selectEl = row.querySelector('.manpower-worker-select');
      const inputEl = row.querySelector('.manpower-custom-input');
      const customValue = value.trim();
      
      if (customValue) {
        // 직접입력한 경우: select에 값 추가하고 선택
        if (selectEl && inputEl) {
          // 기존 직접입력 option 제거 (있는 경우)
          const existingCustomOptions = selectEl.querySelectorAll('option[data-custom="true"]');
          existingCustomOptions.forEach(opt => opt.remove());
          
          // 새로운 option 추가
          const newOption = document.createElement('option');
          newOption.value = customValue;
          newOption.textContent = customValue;
          newOption.setAttribute('data-custom', 'true');
          newOption.selected = true;
          selectEl.appendChild(newOption);
          
          item.worker = customValue;
          item.isCustom = true;
          
          selectEl.style.display = 'block';
          inputEl.style.display = 'none';
          inputEl.value = '';
        }
        updateSummaryData();
      }
    }
    
    function updateManpowerWorker(id, value, isCustom = false) {
      const item = manpowerList.find(m => m.id === id);
      if (!item) return;
      
      const row = document.querySelector(`.manpower-row[data-id="${id}"]`);
      if (!row) return;
      
      const selectEl = row.querySelector('.manpower-worker-select');
      const inputEl = row.querySelector('.manpower-custom-input');
      
      if (value === '__custom__') {
        item.isCustom = true;
        if (selectEl) selectEl.style.display = 'none';
        if (inputEl) {
          inputEl.style.display = 'block';
          inputEl.focus();
        }
      } else if (value) {
        item.worker = value;
        item.isCustom = isCustom;
        // 미리 정의된 작업자 선택
        if (selectEl) {
          selectEl.value = value;
          selectEl.style.display = 'block';
        }
        if (inputEl) inputEl.style.display = 'none';
        
        // 공수 입력 완료 시 다음 단계 안내
        checkManpowerComplete();
      }
      updateSummaryData();
    }
    
    function updateManpowerHours(id, change) {
      const item = manpowerList.find(m => m.id === id);
      if (!item) return;
      
      let newVal = item.workHours + change;
      if (newVal < 0) newVal = 0;
      if (newVal > 3.5) newVal = 3.5;
      
      // 0.5 단위로 제한 (0, 0.5, 1, 1.5, 2, 2.5, 3, 3.5)
      newVal = Math.round(newVal * 2) / 2;
      
      item.workHours = newVal;
      const valSpan = document.querySelector(`.step-val[data-id="${id}"]`);
      if (valSpan) valSpan.innerText = newVal.toFixed(1);
      
      // 공수 입력 완료 시 다음 단계 안내
      checkManpowerComplete();
      
      updateSummaryData();
    }
    
    // 공수 입력 완료 확인 및 다음 단계 안내
    function checkManpowerComplete() {
      const hasValidManpower = manpowerList.length > 0 && manpowerList.some(m => m.worker && m.workHours > 0);
      if (hasValidManpower) {
        const manpowerListEl = document.getElementById('manpower-list');
        if (manpowerListEl) {
          // 에러 효과 해제
          manpowerListEl.classList.remove('section-error-highlight');
          manpowerListEl.style.border = '';
          manpowerListEl.style.backgroundColor = '';
          manpowerListEl.style.animation = '';
          
          // 다음 단계로 이동: 부재명 선택 영역으로 스크롤 및 강조
          setTimeout(() => {
            const workContentList = document.getElementById('work-content-list');
            const firstSet = document.querySelector('.work-set-item');
            if (!firstSet && workContentList) {
              // 작업 세트가 없으면 추가 버튼이 있는 카드박스로 안내
              const cardBox = workContentList.closest('.card-box');
              if (cardBox) {
                guideToNextStep(cardBox, '부재명을 선택해주세요 (작업 세트 추가 필요)', true);
              }
            } else if (firstSet) {
              // 작업 세트가 있으면 부재명 선택 영역으로 안내
              const memberGrid = firstSet.querySelector('.chip-grid[data-type="member"]');
              if (memberGrid && !memberGrid.querySelector('.select-chip.active')) {
                guideToNextStep(memberGrid, '부재명을 선택해주세요');
              }
            }
          }, 300);
        }
      }
    }
    
    // 권역별 현장 데이터
    const regionSites = {
      '전체': [],
      '수도권': [
        { value: 'site1', text: '자이 아파트 101동', dept: 'HQ' },
        { value: 'site2', text: '삼성 반도체 P3', dept: 'HQ' },
        { value: 'site3', text: '힐스테이트 센트럴', dept: 'HQ' }
      ],
      '충청권': [
        { value: 'site4', text: '대전 테크노밸리', dept: 'HQ' },
        { value: 'site5', text: '청주 산업단지', dept: 'HQ' }
      ],
      '전라권': [
        { value: 'site6', text: '광주 첨단단지', dept: 'HQ' },
        { value: 'site7', text: '전주 혁신도시', dept: 'HQ' }
      ],
      '경상권': [
        { value: 'site8', text: '부산 해운대', dept: 'HQ' },
        { value: 'site9', text: '울산 산업단지', dept: 'HQ' },
        { value: 'site10', text: '대구 첨단단지', dept: 'HQ' }
      ],
      '강원권': [
        { value: 'site11', text: '강릉 관광단지', dept: 'HQ' },
        { value: 'site12', text: '원주 산업단지', dept: 'HQ' }
      ]
    };
    
    function getAllSites() {
      const all = [];
      Object.keys(regionSites).forEach(key => {
        if (key === '전체') return;
        all.push(...regionSites[key]);
      });
      return all;
    }
    
    let currentRegion = '전체';
    let hasRegionTouched = false; // 권역 선택 여부 추적
    
    function toggleRegionChip(el, region) {
      const grid = el.closest('.chip-grid');
      const chips = grid.querySelectorAll('.select-chip');
      chips.forEach(chip => chip.classList.remove('active'));
      el.classList.add('active');
      currentRegion = region;
      hasRegionTouched = true; // 권역 선택 완료 표시
      
      // 권역 선택 시 에러 효과 즉시 해제
      grid.classList.remove('error-shake', 'section-error-highlight');
      grid.style.border = '';
      grid.style.borderRadius = '';
      grid.style.padding = '';
      grid.style.boxShadow = '';
      grid.style.backgroundColor = '';
      grid.style.animation = '';
      
      filterSitesByRegion(region);
      updateSummaryData();
      checkRequiredFields();
      
      // 다음 단계로 이동: 현장 선택 필드로 스크롤 및 강조
      setTimeout(() => {
        guideToNextStep('siteSelect', '현장을 선택해주세요');
      }, 300);
    }
    
    function filterSitesByRegion(region) {
      const siteSelect = document.getElementById('siteSelect');
      if (!siteSelect) return;
      
      const sites = region === '전체' ? getAllSites() : (regionSites[region] || []);
      siteSelect.innerHTML = '';
      
      // localStorage에서 마지막 선택 현장 확인 (선택사항)
      const lastSiteValue = localStorage.getItem('lastSiteValue');
      let hasLastSite = false;
      
      // sites를 최신순으로 정렬하여 표시 (첫 번째 현장이 기본 선택)
      if (sites.length > 0) {
        for (let i = 0; i < sites.length; i++) {
          const option = document.createElement('option');
          option.value = sites[i].value;
          option.textContent = sites[i].text;
          
          // localStorage에 저장된 값이 있고, 해당 옵션이 존재하면 선택
          if (lastSiteValue && sites[i].value === lastSiteValue) {
            option.selected = true;
            hasLastSite = true;
          } else if (!hasLastSite && i === 0) {
            // 마지막 선택 현장이 없으면 첫 번째 현장(최신순)을 기본 선택
            option.selected = true;
          }
          
          siteSelect.appendChild(option);
        }
      } else {
        // 현장이 없을 경우에만 placeholder 표시
        const placeholderOption = document.createElement('option');
        placeholderOption.value = '';
        placeholderOption.textContent = '현장 선택';
        placeholderOption.selected = true;
        siteSelect.appendChild(placeholderOption);
      }
      
      autoLinkDept();
    }
    
    function autoLinkDept() {
      const siteSelect = document.getElementById('siteSelect');
      const selDept = document.getElementById('sel-dept');
      if (!siteSelect || !selDept) return;
      
      const siteValue = siteSelect.value;
      if (!siteValue) {
        selDept.value = '';
        updateSummaryData();
        return;
      }
      
      // 현재 선택된 권역의 현장 데이터에서 소속 찾기
      const sites = currentRegion === '전체' ? getAllSites() : (regionSites[currentRegion] || []);
      const selectedSite = sites.find(s => s.value === siteValue);
      
      if (selectedSite && selectedSite.dept) {
        const deptValue = selectedSite.dept;
        if (selDept.querySelector(`option[value="${deptValue}"]`)) {
          selDept.value = deptValue;
        }
      }
      updateSummaryData();
      checkRequiredFields();
    }
    
    function editManpowerRow(id) {
      const item = manpowerList.find(m => m.id === id);
      if (!item) return;
      
      const row = document.querySelector(`.manpower-row[data-id="${id}"]`);
      if (!row) return;
      
      const select = row.querySelector('.manpower-worker-select');
      const input = row.querySelector('.manpower-custom-input');
      
      if (item.isCustom) {
        select.style.display = 'none';
        input.style.display = 'block';
        input.value = item.worker;
        input.focus();
      } else {
        select.style.display = 'block';
        input.style.display = 'none';
        select.value = item.worker;
        select.focus();
      }
    }
    
    function removeManpowerRow(id) {
      const item = manpowerList.find(m => m.id === id);
      if (item && item.locked) {
        showToast('삭제 불가');
        return;
      }
      manpowerList = manpowerList.filter(m => m.id !== id);
      const row = document.querySelector(`.manpower-row[data-id="${id}"]`);
      if (row) row.remove();
      updateSummaryData();
    }
    function addMaterial() {
      const qtyInput = document.getElementById('mat-qty');
      const qtyValue = parseFloat(qtyInput.value) || 0;
      
      // 수량이 입력되지 않았거나 0 이하(0 포함)인 경우 리스트에 추가하지 않음
      if (!qtyInput.value || qtyInput.value.trim() === '' || isNaN(qtyValue) || qtyValue <= 0) { 
        showToast('수량을 입력해주세요 (0보다 큰 숫자)'); 
        qtyInput.focus();
        // 수량 입력 필드 강조 (error-shake 클래스 추가)
        qtyInput.classList.add('error-shake');
        qtyInput.style.borderColor = 'var(--danger)';
        qtyInput.style.boxShadow = '0 0 0 3px rgba(239, 68, 68, 0.15)';
        setTimeout(() => {
          qtyInput.classList.remove('error-shake');
          qtyInput.style.borderColor = '';
          qtyInput.style.boxShadow = '';
        }, 2000);
        return; 
      }
      
      const matSelect = document.getElementById('mat-name');
      const matName = customMaterialName || (matSelect.value && matSelect.value !== 'custom' && matSelect.value !== 'custom_temp' ? matSelect.options[matSelect.selectedIndex].text : '');
      
      // 직접입력이 선택되었지만 확인하지 않은 경우
      if (matSelect.value === 'custom' && !customMaterialName) {
        showToast('자재명을 입력하고 확인 버튼을 눌러주세요');
        return;
      }
      
      if (!matName) { showToast('자재 선택'); return; }
      
      const list = document.getElementById('mat-list');
      const item = document.createElement('div');
      item.className = 'mat-item';
      item.innerHTML = `<div><span style="font-weight:600;">${matName}</span><span style="color:var(--primary); margin-left:6px;">${qtyInput.value}말</span></div><button class="btn-delete-capsule" onclick="removeMaterialItem(this)">삭제</button>`;
      list.appendChild(item);
      
      // 자재 추가 후 수량 필드 비우고 포커스
      qtyInput.value = '';
      qtyInput.focus();
      // matSelect.value = ''; // 필터가 비어있지 않도록 유지
      showToast('자재 추가');
      updateMaterialHint();
      checkAllRequiredComplete();
    }
    
    function removeMaterialItem(btn) {
      btn.closest('.mat-item').remove();
      updateMaterialHint();
      checkAllRequiredComplete();
    }
    
    function updateMaterialHint() {
      // 자재 사용 내역 안내문구는 section-title 옆에 항상 표시됨
    }
    
    function openDMM2Marking() {
        if (window.DMM2 && window.DMM2.openFilePicker) {
            window.DMM2.openFilePicker();
        } else {
            alert('도면 마킹 기능을 로드하는 중입니다. 잠시 후 다시 시도해주세요.');
        }
    }
    
    // 기존 단순 마킹 모달은 DMM2로 대체되므로 제거하지 않고 유지 (하위 호환성)
    function openMarkingModal() {
        openDMM2Marking();
    }
    function toggleSummary() {
        const body = document.getElementById('summary-body');
        const icon = document.querySelector('.summary-card .arrow-icon');
        if (!body || !icon) return;
        
        const isCollapsed = body.classList.contains('collapsed');
        body.classList.toggle('collapsed');
        
        if (isCollapsed) {
            // 펼치기
            icon.classList.remove('collapsed');
            icon.setAttribute('data-lucide', 'chevron-up');
            updateSummaryData();
        } else {
            // 접기
            icon.classList.add('collapsed');
            icon.setAttribute('data-lucide', 'chevron-down');
        }
        lucide.createIcons();
    }
    
    // 요약 데이터 업데이트 (최적화)
    function updateSummaryData() {
        const site = document.getElementById('siteSelect');
        document.getElementById('sum-site').innerText = (site && site.value) ? site.options[site.selectedIndex].text : '선택 안됨';
        const dateInput = document.getElementById('input-date');
        document.getElementById('sum-date').innerText = (dateInput && dateInput.value) ? dateInput.value : '-';
        
        // 투입인원 계산
        let totalHours = 0;
        let workerCount = 0;
        manpowerList.forEach(item => {
            if(item.worker) {
                totalHours += item.workHours;
                workerCount++;
            }
        });
        if(workerCount > 0) {
            document.getElementById('sum-manpower').innerText = `${workerCount}명 (${totalHours.toFixed(1)}공수)`;
        } else {
            document.getElementById('sum-manpower').innerText = '-';
        }
        
        // 사진/도면 건수
        document.getElementById('sum-photos').innerText = `${photoCount}장`;
        document.getElementById('sum-drawings').innerText = `${drawingCount}건`;
        
        const firstSet = document.querySelector('.work-set-item');
        if(firstSet) {
             const getChipText = (type) => { 
                 const active = firstSet.querySelector(`.chip-grid[data-type="${type}"] .select-chip.active`); 
                 if(active) {
                     const text = active.innerText.trim();
                     if(text === '기타') {
                         const input = firstSet.querySelector(`.chip-grid[data-type="${type}"]`).closest('div').querySelector('.other-input-wrap .form-input');
                         return (input && input.value) ? input.value : '-';
                     }
                     return text;
                 }
                 return '-';
             };
             document.getElementById('sum-member').innerText = getChipText('member');
             document.getElementById('sum-process').innerText = getChipText('process');
             document.getElementById('sum-type').innerText = getChipText('type');
             const inputs = firstSet.querySelectorAll('.input-grid-3 input');
             const loc = Array.from(inputs).map(i => i.value).filter(v => v).join('/');
             document.getElementById('sum-location').innerText = loc || '-';
        } else {
             document.getElementById('sum-member').innerText = '-';
             document.getElementById('sum-process').innerText = '-';
             document.getElementById('sum-type').innerText = '-';
             document.getElementById('sum-location').innerText = '-';
        }
        
        checkRequiredFields();
    }
    
    function checkRequiredFields() {
        const siteSelect = document.getElementById('siteSelect');
        const selDept = document.getElementById('sel-dept');
        const hasManpower = manpowerList.length > 0 && manpowerList.some(m => m.worker);
        const hasWorkSet = document.querySelector('.work-set-item') !== null;
        
        const isValid = siteSelect && siteSelect.value && 
                       selDept && selDept.value && 
                       hasManpower && 
                       hasWorkSet;
        
        // 버튼은 항상 표시 (저장 시에만 검증)
        // const floatingBtns = document.getElementById('floatingActionButtons');
        // if(floatingBtns) {
        //     if(isValid) {
        //         floatingBtns.style.display = 'flex';
        //     } else {
        //         floatingBtns.style.display = 'none';
        //     }
        // }
    }
    
    /**
     * 에러 시각 효과 적용 및 스크롤 이동 함수
     */
    function applyErrorEffect(element, message) {
        if (!element) return;

        // 1. 토스트 메시지 표시
        showToast(message);

        // 2. 시각적 효과 부여
        if (element.tagName === 'SELECT' || element.tagName === 'INPUT') {
            // 단일 입력창: 테두리 강조 + 흔들림 (error-shake)
            element.classList.add('error-shake');
            element.style.borderColor = 'var(--danger)';
            element.style.boxShadow = '0 0 0 3px rgba(239, 68, 68, 0.15)';
            
            setTimeout(() => {
                element.classList.remove('error-shake');
                element.style.borderColor = '';
                element.style.boxShadow = '';
            }, 3500);
        } else {
            // 그룹/칩 영역: 박스 전체 강조 (section-error-highlight)
            element.classList.add('section-error-highlight');
            if (element.id === 'work-content-list') {
                element.style.border = '2px dashed var(--danger)';
                element.style.borderRadius = '12px';
                element.style.backgroundColor = 'rgba(239, 68, 68, 0.05)';
                element.style.minHeight = '60px';
                element.style.display = 'flex';
                element.style.alignItems = 'center';
                element.style.justifyContent = 'center';
                element.style.padding = '20px';
                element.style.animation = 'pulse-error 1.5s ease-in-out 3';
                
                setTimeout(() => {
                    element.classList.remove('section-error-highlight');
                    element.style.border = '';
                    element.style.borderRadius = '';
                    element.style.backgroundColor = '';
                    element.style.minHeight = '';
                    element.style.display = '';
                    element.style.alignItems = '';
                    element.style.justifyContent = '';
                    element.style.padding = '';
                    element.style.animation = '';
                }, 3500);
            } else if (element.id === 'manpower-list') {
                element.style.border = '2px dashed var(--danger)';
                element.style.backgroundColor = 'rgba(239, 68, 68, 0.05)';
                element.style.animation = 'pulse-error 1.5s ease-in-out 3';
                
                setTimeout(() => {
                    element.classList.remove('section-error-highlight');
                    element.style.border = '';
                    element.style.backgroundColor = '';
                    element.style.animation = '';
                }, 3500);
            } else {
                // 칩 그리드 영역
                element.style.border = '2px solid var(--danger)';
                element.style.borderRadius = '8px';
                element.style.padding = '4px';
                element.style.backgroundColor = 'rgba(239, 68, 68, 0.05)';
                element.style.animation = 'pulse-error 1.5s ease-in-out 3';
                
                setTimeout(() => {
                    element.classList.remove('section-error-highlight');
                    element.style.border = '';
                    element.style.borderRadius = '';
                    element.style.padding = '';
                    element.style.backgroundColor = '';
                    element.style.animation = '';
                }, 3500);
            }
        }

        // 3. 해당 위치로 스크롤 이동
        setTimeout(() => {
            const scrollTarget = element.closest('.card-box') || element;
            scrollTarget.scrollIntoView({ 
                behavior: 'smooth', 
                block: 'center',
                inline: 'nearest'
            });
        }, 200);
    }

    /**
     * 실제 데이터를 수집하고 저장하는 로직
     */
    function executeSaveProcess() {
        try {
            // 데이터 수집 (기존 데이터 구조 유지)
            const worklogData = {
                site: document.getElementById('siteSelect')?.value || '',
                siteName: document.getElementById('siteSelect')?.options[document.getElementById('siteSelect')?.selectedIndex]?.text || '',
                date: document.getElementById('input-date')?.value || '',
                region: currentRegion,
                manpower: manpowerList,
                workSets: Array.from(document.querySelectorAll('.work-set-item')).map(set => {
                    const memberChip = set.querySelector('.chip-grid[data-type="member"] .select-chip.active');
                    const processChip = set.querySelector('.chip-grid[data-type="process"] .select-chip.active');
                    const typeChip = set.querySelector('.chip-grid[data-type="type"] .select-chip.active');
                    const locationInputs = set.querySelectorAll('.input-grid-3 input');
                    
                    // 부재명/작업공정 '기타' 선택 시 직접 입력값 가져오기
                    let memberValue = '';
                    if (memberChip) {
                        const chipText = memberChip.innerText.trim();
                        if (chipText === '기타') {
                            const memberInput = set.querySelector('.chip-grid[data-type="member"]')?.closest('div').querySelector('.other-input-wrap .form-input');
                            memberValue = memberInput ? memberInput.value.trim() : '';
                        } else {
                            memberValue = chipText;
                        }
                    }
                    
                    let processValue = '';
                    if (processChip) {
                        const chipText = processChip.innerText.trim();
                        if (chipText === '기타') {
                            const processInput = set.querySelector('.chip-grid[data-type="process"]')?.closest('div').querySelector('.other-input-wrap .form-input');
                            processValue = processInput ? processInput.value.trim() : '';
                        } else {
                            processValue = chipText;
                        }
                    }
                    
                    return {
                        member: memberValue,
                        process: processValue,
                        type: typeChip ? typeChip.innerText.trim() : '',
                        location: {
                            block: locationInputs[0]?.value || '',
                            dong: locationInputs[1]?.value || '',
                            floor: locationInputs[2]?.value || ''
                        }
                    };
                }),
                photos: photoCount,
                drawings: drawingCount,
                timestamp: new Date().toISOString()
            };

            // localStorage에 저장 (실제로는 서버 API 호출)
            const existingLogs = JSON.parse(localStorage.getItem('worklog_data') || '[]');
            existingLogs.push(worklogData);
            localStorage.setItem('worklog_data', JSON.stringify(existingLogs));

            // 저장 완료 시 버튼 영역 표시 제거
            const buttonArea = document.getElementById('floatingActionButtons');
            const saveBtn = document.querySelector('.btn-save');
            
            if (buttonArea) {
                buttonArea.classList.remove('ready-to-save');
                const existingBadge = buttonArea.querySelector('.ready-to-save-badge');
                if (existingBadge) {
                    existingBadge.remove();
                }
            }
            
            if (saveBtn) {
                saveBtn.classList.remove('ready');
            }
            
            showToast('저장 완료');
        } catch (error) {
            console.error('저장 오류:', error);
            showToast('저장 실패');
        }
    }
    
    /**
     * 필수 입력 항목 순차 검증 및 저장 로직
     * 순서: 권역 -> 현장 -> 부재명 -> 작업공정 (위 4개 통과 후 작업일자, 공수, 소속 등 검증)
     */
    function validateAndSave() {
        console.log('일지저장 버튼 클릭됨 - validateAndSave 함수 시작');
        
        // 1. 모든 기존 에러 효과 및 다음 단계 안내 초기화
        document.querySelectorAll('.section-error-highlight, .error-shake, .next-step-guide').forEach(el => {
            el.classList.remove('section-error-highlight', 'error-shake', 'next-step-guide');
            if (el.style) {
                el.style.border = '';
                el.style.backgroundColor = '';
                el.style.animation = '';
                el.style.borderColor = '';
                el.style.boxShadow = '';
                el.style.borderRadius = '';
                el.style.padding = '';
            }
        });

        // 검증 변수 초기화
        let isValid = true;
        const invalidElements = [];
        let firstErrorMessage = '';

        // 검증할 요소들 미리 선언
        const regionChips = document.querySelectorAll('.chip-grid[data-type="region"] .select-chip.active');
        const siteSelect = document.getElementById('siteSelect');
        const firstSet = document.querySelector('.work-set-item');

        // 검증 로직 (순차적 실행 - return으로 즉시 중단)
        
        // [1단계] 권역 선택 검증
        if (regionChips.length === 0 || !hasRegionTouched) {
            const regionGrid = document.querySelector('.chip-grid[data-type="region"]');
            applyErrorEffect(regionGrid, '권역 선택');
            return;
        }
        
        // ============================================================
        // [Step2] 현장선택박스 검사
        // ============================================================
        // 엄격한 순서 제어: 이전 단계가 통과되지 않으면 건너뜀
        if (isValid) {
            const siteSelect = document.getElementById('siteSelect');
            if (!siteSelect || !siteSelect.value.trim()) {
                isValid = false;
                if (invalidElements.length === 0) {
                    invalidElements.push(siteSelect);
                    firstErrorMessage = '현장 선택';
                }
                
                // 단일 입력창: 테두리 강조 + 흔들림 (error-shake)
                siteSelect.classList.add('error-shake');
                siteSelect.style.borderColor = 'var(--danger)';
                siteSelect.style.boxShadow = '0 0 0 3px rgba(239, 68, 68, 0.15)';
                
                setTimeout(() => {
                    siteSelect.classList.remove('error-shake');
                    siteSelect.style.borderColor = '';
                    siteSelect.style.boxShadow = '';
                }, 3500);
            }
        }
        
        // ============================================================
        // [Step3] 부재명 검사
        // ============================================================
        // 엄격한 순서 제어: 이전 단계가 통과되지 않으면 건너뜀
        if (isValid) {
            const firstSet = document.querySelector('.work-set-item');
            if (!firstSet) {
                isValid = false;
                const workContentList = document.getElementById('work-content-list');
                if (workContentList && invalidElements.length === 0) {
                    invalidElements.push(workContentList);
                }
                
                if (workContentList) {
                    // 그룹/칩 영역: 박스 전체 강조 (section-error-highlight)
                    workContentList.classList.add('section-error-highlight');
                    workContentList.style.border = '2px dashed var(--danger)';
                    workContentList.style.borderRadius = '12px';
                    workContentList.style.backgroundColor = 'rgba(239, 68, 68, 0.05)';
                    workContentList.style.minHeight = '60px';
                    workContentList.style.display = 'flex';
                    workContentList.style.alignItems = 'center';
                    workContentList.style.justifyContent = 'center';
                    workContentList.style.padding = '20px';
                    workContentList.style.animation = 'pulse-error 1.5s ease-in-out 3';
                    
                    setTimeout(() => {
                        workContentList.classList.remove('section-error-highlight');
                        workContentList.style.border = '';
                        workContentList.style.borderRadius = '';
                        workContentList.style.backgroundColor = '';
                        workContentList.style.minHeight = '';
                        workContentList.style.display = '';
                        workContentList.style.alignItems = '';
                        workContentList.style.justifyContent = '';
                        workContentList.style.padding = '';
                        workContentList.style.animation = '';
                    }, 3500);
                }
            } else {
                // 부재명 디테일 검증: 칩 선택 및 '기타' 선택 시 텍스트 입력창 확인
                const memberChip = firstSet.querySelector('.chip-grid[data-type="member"] .select-chip.active');
                const memberChipContainer = firstSet.querySelector('.chip-grid[data-type="member"]');
                const memberInput = memberChipContainer ? memberChipContainer.closest('div').querySelector('.other-input-wrap .form-input') : null;
                
                let memberValue = '';
                if (memberChip) {
                    const chipText = memberChip.innerText.trim();
                    if (chipText === '기타') {
                        // 기타 선택 시 직접 입력 필드 확인 (디테일 검증)
                        memberValue = memberInput ? memberInput.value.trim() : '';
                    } else {
                        memberValue = chipText;
                    }
                }
                
                if (!memberValue) {
                    isValid = false;
                    const memberSection = memberChipContainer || (memberInput ? memberInput.closest('div') : null);
                    if (memberSection && invalidElements.length === 0) {
                        invalidElements.push(memberSection);
                        firstErrorMessage = '부재명 선택';
                    }
                    
                    // 그룹/칩 영역: 박스 전체 강조 (section-error-highlight)
                    if (memberSection) {
                        memberSection.classList.add('section-error-highlight');
                        memberSection.style.border = '2px solid var(--danger)';
                        memberSection.style.borderRadius = '8px';
                        memberSection.style.padding = '8px';
                        memberSection.style.backgroundColor = 'rgba(239, 68, 68, 0.05)';
                        memberSection.style.animation = 'pulse-error 1.5s ease-in-out 3';
                        
                        setTimeout(() => {
                            memberSection.classList.remove('section-error-highlight');
                            memberSection.style.border = '';
                            memberSection.style.borderRadius = '';
                            memberSection.style.padding = '';
                            memberSection.style.backgroundColor = '';
                            memberSection.style.animation = '';
                        }, 3500);
                    }
                }
            }
        }
        
        // ============================================================
        // [Step4] 작업공정 검사
        // ============================================================
        // 엄격한 순서 제어: 이전 단계가 통과되지 않으면 건너뜀
        if (isValid) {
            const firstSet = document.querySelector('.work-set-item');
            if (firstSet) {
                // 작업공정 디테일 검증: 칩 선택 및 '기타' 선택 시 텍스트 입력창 확인
                const processChip = firstSet.querySelector('.chip-grid[data-type="process"] .select-chip.active');
                const processChipContainer = firstSet.querySelector('.chip-grid[data-type="process"]');
                const processInput = processChipContainer ? processChipContainer.closest('div').querySelector('.other-input-wrap .form-input') : null;
                
                let processValue = '';
                if (processChip) {
                    const chipText = processChip.innerText.trim();
                    if (chipText === '기타') {
                        // 기타 선택 시 직접 입력 필드 확인 (디테일 검증)
                        processValue = processInput ? processInput.value.trim() : '';
                    } else {
                        processValue = chipText;
                    }
                }
                
                if (!processValue) {
                    isValid = false;
                    const processSection = processChipContainer || (processInput ? processInput.closest('div') : null);
                    if (processSection && invalidElements.length === 0) {
                        invalidElements.push(processSection);
                        firstErrorMessage = '작업공정 선택';
                    }
                    
                    // 그룹/칩 영역: 박스 전체 강조 (section-error-highlight)
                    if (processSection) {
                        processSection.classList.add('section-error-highlight');
                        processSection.style.border = '2px solid var(--danger)';
                        processSection.style.borderRadius = '8px';
                        processSection.style.padding = '8px';
                        processSection.style.backgroundColor = 'rgba(239, 68, 68, 0.05)';
                        processSection.style.animation = 'pulse-error 1.5s ease-in-out 3';
                        
                        setTimeout(() => {
                            processSection.classList.remove('section-error-highlight');
                            processSection.style.border = '';
                            processSection.style.borderRadius = '';
                            processSection.style.padding = '';
                            processSection.style.backgroundColor = '';
                            processSection.style.animation = '';
                        }, 3500);
                    }
                }
            }
        }
        
        // ============================================================
        // [Step5 이후] 기존 검증 (작업일자, 공수, 소속 등)
        // ============================================================
        // 위 4개 검증이 모두 통과한 다음에만 실행
        if (isValid) {
            // 작업일자 검사
            const inputDate = document.getElementById('input-date');
            if (!inputDate || !inputDate.value.trim()) {
                isValid = false;
                if (invalidElements.length === 0) {
                    invalidElements.push(inputDate);
                }
                
                // 단일 입력창: 테두리 강조 + 흔들림 (error-shake)
                inputDate.classList.add('error-shake');
                inputDate.style.borderColor = 'var(--danger)';
                inputDate.style.boxShadow = '0 0 0 3px rgba(239, 68, 68, 0.15)';
                
                setTimeout(() => {
                    inputDate.classList.remove('error-shake');
                    inputDate.style.borderColor = '';
                    inputDate.style.boxShadow = '';
                }, 3500);
            }
        }
        
        if (isValid) {
            // 공수입력컨트롤박스 검사
            const hasValidManpower = manpowerList.length > 0 && manpowerList.some(m => m.worker && m.workHours > 0);
            if (!hasValidManpower) {
                isValid = false;
                const manpowerListEl = document.getElementById('manpower-list');
                if (manpowerListEl && invalidElements.length === 0) {
                    invalidElements.push(manpowerListEl);
                }
                
                if (manpowerListEl) {
                    // 그룹/칩 영역: 박스 전체 강조 (section-error-highlight)
                    manpowerListEl.classList.add('section-error-highlight');
                    manpowerListEl.style.border = '2px dashed var(--danger)';
                    manpowerListEl.style.backgroundColor = 'rgba(239, 68, 68, 0.05)';
                    manpowerListEl.style.animation = 'pulse-error 1.5s ease-in-out 3';
                    
                    setTimeout(() => {
                        manpowerListEl.classList.remove('section-error-highlight');
                        manpowerListEl.style.border = '';
                        manpowerListEl.style.backgroundColor = '';
                        manpowerListEl.style.animation = '';
                    }, 3500);
                }
            }
        }
        
        if (isValid) {
            // 소속 검사
            const selDept = document.getElementById('sel-dept');
            if (selDept && !selDept.value.trim()) {
                isValid = false;
                if (invalidElements.length === 0) {
                    invalidElements.push(selDept);
                }
                
                // 단일 입력창: 테두리 강조 + 흔들림 (error-shake)
                selDept.classList.add('error-shake');
                selDept.style.borderColor = 'var(--danger)';
                selDept.style.boxShadow = '0 0 0 3px rgba(239, 68, 68, 0.15)';
                
                setTimeout(() => {
                    selDept.classList.remove('error-shake');
                    selDept.style.borderColor = '';
                    selDept.style.boxShadow = '';
                }, 3500);
            }
        }
        
        if (isValid) {
            // 작업일지 작성 검사
            const workSets = document.querySelectorAll('.work-set-item');
            if (workSets.length === 0) {
                isValid = false;
                const workContentList = document.getElementById('work-content-list');
                if (workContentList && invalidElements.length === 0) {
                    invalidElements.push(workContentList);
                }
                
                if (workContentList) {
                    // 그룹/칩 영역: 박스 전체 강조 (section-error-highlight)
                    workContentList.classList.add('section-error-highlight');
                    workContentList.style.border = '2px dashed var(--danger)';
                    workContentList.style.borderRadius = '12px';
                    workContentList.style.backgroundColor = 'rgba(239, 68, 68, 0.05)';
                    workContentList.style.minHeight = '60px';
                    workContentList.style.display = 'flex';
                    workContentList.style.alignItems = 'center';
                    workContentList.style.justifyContent = 'center';
                    workContentList.style.padding = '20px';
                    workContentList.style.animation = 'pulse-error 1.5s ease-in-out 3';
                    
                    setTimeout(() => {
                        workContentList.classList.remove('section-error-highlight');
                        workContentList.style.minHeight = '';
                        workContentList.style.border = '';
                        workContentList.style.borderRadius = '';
                        workContentList.style.backgroundColor = '';
                        workContentList.style.display = '';
                        workContentList.style.alignItems = '';
                        workContentList.style.justifyContent = '';
                        workContentList.style.padding = '';
                        workContentList.style.animation = '';
                    }, 3500);
                }
            }
        }
        
        // ============================================================
        // [Step6] 자재 사용 내역 수량 검사
        // ============================================================
        if (isValid) {
            const matItems = document.querySelectorAll('.mat-item');
            if (matItems.length > 0) {
                // 자재가 있는 경우 수량 검증
                let hasInvalidQty = false;
                for (let item of matItems) {
                    const qtyText = item.querySelector('span[style*="color:var(--primary)"]')?.textContent || '';
                    // "말" 단위 제거하고 숫자만 추출
                    const qtyMatch = qtyText.match(/(\d+(?:\.\d+)?)/);
                    if (qtyMatch) {
                        const qty = parseFloat(qtyMatch[1]);
                        // 0보다 큰 숫자인지 확인 (0 포함하여 차단)
                        if (isNaN(qty) || qty <= 0) {
                            hasInvalidQty = true;
                            break;
                        }
                    } else {
                        hasInvalidQty = true;
                        break;
                    }
                }
                
                if (hasInvalidQty) {
                    isValid = false;
                    const matList = document.getElementById('mat-list');
                    const matSection = matList ? matList.closest('.card-box') : null;
                    if (matSection && invalidElements.length === 0) {
                        invalidElements.push(matSection);
                        firstErrorMessage = '자재 수량을 입력해주세요 (0보다 큰 숫자)';
                    }
                    
                    // 수량 입력 필드 강조
                    const qtyInput = document.getElementById('mat-qty');
                    if (qtyInput) {
                        qtyInput.classList.add('error-shake');
                        qtyInput.style.borderColor = 'var(--danger)';
                        qtyInput.style.boxShadow = '0 0 0 3px rgba(239, 68, 68, 0.15)';
                        
                        setTimeout(() => {
                            qtyInput.classList.remove('error-shake');
                            qtyInput.style.borderColor = '';
                            qtyInput.style.boxShadow = '';
                        }, 3500);
                    }
                    
                    if (matSection) {
                        matSection.classList.add('section-error-highlight');
                        matSection.style.border = '2px solid var(--danger)';
                        matSection.style.borderRadius = '16px';
                        matSection.style.backgroundColor = 'rgba(239, 68, 68, 0.05)';
                        matSection.style.animation = 'pulse-error 1.5s ease-in-out 3';
                        
                        setTimeout(() => {
                            matSection.classList.remove('section-error-highlight');
                            matSection.style.border = '';
                            matSection.style.borderRadius = '';
                            matSection.style.backgroundColor = '';
                            matSection.style.animation = '';
                        }, 3500);
                    }
                }
            }
        }
        
        // ============================================================
        // 자동 스크롤 (첫 번째 에러 위치로 이동)
        // ============================================================
        if (!isValid && invalidElements.length > 0) {
            const firstError = invalidElements[0];
            setTimeout(() => {
                if (firstError) {
                    // 그룹/칩 영역의 경우 카드 전체로 스크롤
                    let scrollTarget = firstError;
                    
                    // 권역선택칩, 공수입력컨트롤박스, 부재명, 작업공정의 경우 카드 전체로 스크롤
                    if (firstError.classList.contains('chip-grid') || 
                        firstError.id === 'manpower-list' ||
                        firstError.id === 'work-content-list' ||
                        firstError.classList.contains('section-error-highlight')) {
                        const cardBox = firstError.closest('.card-box');
                        if (cardBox) {
                            scrollTarget = cardBox;
                        }
                    }
                    
                    scrollTarget.scrollIntoView({ 
                        behavior: 'smooth', 
                        block: 'center',
                        inline: 'nearest'
                    });
                }
            }, 200); // 애니메이션 시작 후 약간의 딜레이
        }
        
        // ============================================================
        // 토스트 메시지 (항목별 1회만 출력)
        // ============================================================
        if (!isValid) {
            setTimeout(() => {
                if (firstErrorMessage) {
                    showToast(firstErrorMessage);
                } else {
                    showToast('필수 항목 입력');
                }
            }, 300); // 스크롤 후 메시지 표시
            return;
        }
        
        // 모든 검사 통과 시 저장 로직 실행 (일지저장 버튼 클릭 시에만)
        // 실제 저장 로직은 여기에 구현 (예: 서버 API 호출 또는 localStorage 저장)
        try {
            let worklogData = null;
            
            // 데이터 수집 단계를 별도 try-catch로 감싸서 오류 추적
            try {
                // 안전하게 데이터 수집
                const siteSelectEl = document.getElementById('siteSelect');
                const siteValue = siteSelectEl?.value || '';
                let siteName = '';
                if (siteSelectEl && siteSelectEl.selectedIndex >= 0 && siteSelectEl.options[siteSelectEl.selectedIndex]) {
                    siteName = siteSelectEl.options[siteSelectEl.selectedIndex].text || '';
                }
                
                const inputDateEl = document.getElementById('input-date');
                const dateValue = inputDateEl?.value || '';
                
                // 저장 로직 구현
                // 예시: localStorage에 저장
                worklogData = {
                site: siteValue,
                siteName: siteName,
                date: dateValue,
                region: currentRegion || '전체',
                manpower: manpowerList || [],
                workSets: Array.from(document.querySelectorAll('.work-set-item')).map(set => {
                    if (!set) return null;
                    
                    const memberChip = set.querySelector('.chip-grid[data-type="member"] .select-chip.active');
                    const processChip = set.querySelector('.chip-grid[data-type="process"] .select-chip.active');
                    const typeChip = set.querySelector('.chip-grid[data-type="type"] .select-chip.active');
                    const locationInputs = set.querySelectorAll('.input-grid-3 input');
                    
                    // 부재명/작업공정 '기타' 선택 시 직접 입력값 가져오기
                    let memberValue = '';
                    if (memberChip) {
                        const chipText = memberChip.innerText?.trim() || '';
                        if (chipText === '기타') {
                            try {
                                const memberInput = set.querySelector('.chip-grid[data-type="member"]')?.closest('div')?.querySelector('.other-input-wrap .form-input');
                                memberValue = memberInput ? (memberInput.value?.trim() || '') : '';
                            } catch (e) {
                                console.warn('부재명 입력값 가져오기 오류:', e);
                                memberValue = '';
                            }
                        } else {
                            memberValue = chipText;
                        }
                    }
                    
                    let processValue = '';
                    if (processChip) {
                        const chipText = processChip.innerText?.trim() || '';
                        if (chipText === '기타') {
                            try {
                                const processInput = set.querySelector('.chip-grid[data-type="process"]')?.closest('div')?.querySelector('.other-input-wrap .form-input');
                                processValue = processInput ? (processInput.value?.trim() || '') : '';
                            } catch (e) {
                                console.warn('작업공정 입력값 가져오기 오류:', e);
                                processValue = '';
                            }
                        } else {
                            processValue = chipText;
                        }
                    }
                    
                    return {
                        member: memberValue,
                        process: processValue,
                        type: typeChip ? (typeChip.innerText?.trim() || '') : '',
                        location: {
                            block: locationInputs[0]?.value || '',
                            dong: locationInputs[1]?.value || '',
                            floor: locationInputs[2]?.value || ''
                        }
                    };
                }).filter(set => set !== null),
                materials: Array.from(document.querySelectorAll('.mat-item')).map(item => {
                    if (!item) return null;
                    try {
                        const nameSpan = item.querySelector('span[style*="font-weight:600"]');
                        const qtySpan = item.querySelector('span[style*="color:var(--primary)"]');
                        const name = nameSpan ? (nameSpan.textContent?.trim() || '') : '';
                        const qtyText = qtySpan ? (qtySpan.textContent?.trim() || '') : '';
                        const qtyMatch = qtyText.match(/(\d+(?:\.\d+)?)/);
                        const qty = qtyMatch ? parseFloat(qtyMatch[1]) : 0;
                        return { name, qty };
                    } catch (e) {
                        console.warn('자재 데이터 가져오기 오류:', e);
                        return null;
                    }
                }).filter(item => item !== null),
                photos: photoCount || 0,
                drawings: drawingCount || 0,
                timestamp: new Date().toISOString()
                };
            } catch (dataCollectionError) {
                console.error('데이터 수집 중 오류:', dataCollectionError);
                throw new Error('데이터 수집 중 오류가 발생했습니다: ' + (dataCollectionError.message || '알 수 없는 오류'));
            }
            
            if (!worklogData) {
                throw new Error('저장할 데이터를 생성할 수 없습니다.');
            }
            
            // localStorage에 저장 (실제로는 서버 API 호출)
            try {
                // 데이터 직렬화 가능 여부 확인
                const testStringify = JSON.stringify(worklogData);
                if (!testStringify) {
                    throw new Error('데이터 직렬화 실패');
                }
                
                // localStorage 사용 가능 여부 확인
                if (typeof Storage === 'undefined') {
                    throw new Error('localStorage를 사용할 수 없습니다.');
                }
                
                const existingLogsStr = localStorage.getItem('worklog_data');
                let existingLogs = [];
                
                if (existingLogsStr) {
                    try {
                        existingLogs = JSON.parse(existingLogsStr);
                        if (!Array.isArray(existingLogs)) {
                            console.warn('기존 로그 데이터가 배열이 아닙니다. 초기화합니다.');
                            existingLogs = [];
                        }
                    } catch (parseError) {
                        console.warn('기존 로그 데이터 파싱 오류. 초기화합니다:', parseError);
                        existingLogs = [];
                    }
                }
                
                // 오래된 데이터 자동 정리 (최근 200개만 유지)
                const MAX_LOGS = 200;
                if (existingLogs.length >= MAX_LOGS) {
                    // 타임스탬프 기준으로 정렬 후 최신 것만 유지
                    existingLogs.sort((a, b) => {
                        const timeA = a.timestamp ? new Date(a.timestamp).getTime() : 0;
                        const timeB = b.timestamp ? new Date(b.timestamp).getTime() : 0;
                        return timeB - timeA; // 최신순 정렬
                    });
                    existingLogs = existingLogs.slice(0, MAX_LOGS - 1); // 새 데이터를 위해 1개 공간 남김
                    console.log(`오래된 데이터 정리: 최근 ${MAX_LOGS - 1}개만 유지`);
                }
                
                existingLogs.push(worklogData);
                const serialized = JSON.stringify(existingLogs);
                
                // localStorage 용량 확인 (대략적으로)
                const sizeInMB = serialized.length / (1024 * 1024);
                if (sizeInMB > 4) { // 4MB 초과 시 경고 및 추가 정리
                    console.warn('저장 데이터가 큽니다:', sizeInMB.toFixed(2), 'MB');
                    // 더 적극적으로 정리 (최근 100개만 유지)
                    existingLogs.sort((a, b) => {
                        const timeA = a.timestamp ? new Date(a.timestamp).getTime() : 0;
                        const timeB = b.timestamp ? new Date(b.timestamp).getTime() : 0;
                        return timeB - timeA;
                    });
                    existingLogs = existingLogs.slice(0, 100);
                    const reSerialized = JSON.stringify(existingLogs);
                    console.log('데이터 정리 후 크기:', (reSerialized.length / (1024 * 1024)).toFixed(2), 'MB');
                    
                    // 정리된 데이터로 다시 시도
                    try {
                        localStorage.setItem('worklog_data', reSerialized);
                        console.log('데이터 정리 후 저장 성공');
                        return; // 성공적으로 저장했으므로 함수 종료
                    } catch (retryError) {
                        console.error('정리 후에도 저장 실패:', retryError);
                        throw retryError; // 여전히 실패하면 에러 전달
                    }
                }
                
                // 정상 저장 시도
                localStorage.setItem('worklog_data', serialized);
            } catch (storageError) {
                console.error('localStorage 저장 오류:', storageError);
                const errorMsg = storageError.message || storageError.toString() || '알 수 없는 오류';
                
                // QuotaExceededError 발생 시 자동으로 오래된 데이터 정리 후 재시도
                if (errorMsg.includes('QuotaExceededError') || errorMsg.includes('quota') || errorMsg.includes('QUOTA_EXCEEDED')) {
                    console.log('저장 공간 부족 감지. 오래된 데이터 자동 정리 시작...');
                    
                    try {
                        // 기존 데이터를 최근 50개만 남기고 삭제
                        const existingLogsStr = localStorage.getItem('worklog_data');
                        if (existingLogsStr) {
                            try {
                                let existingLogs = JSON.parse(existingLogsStr);
                                if (Array.isArray(existingLogs) && existingLogs.length > 0) {
                                    // 타임스탬프 기준으로 정렬
                                    existingLogs.sort((a, b) => {
                                        const timeA = a.timestamp ? new Date(a.timestamp).getTime() : 0;
                                        const timeB = b.timestamp ? new Date(b.timestamp).getTime() : 0;
                                        return timeB - timeA; // 최신순
                                    });
                                    
                                    // 최근 50개만 유지
                                    existingLogs = existingLogs.slice(0, 50);
                                    
                                    // 새 데이터 추가
                                    existingLogs.push(worklogData);
                                    
                                    // 다시 저장 시도
                                    const cleanedSerialized = JSON.stringify(existingLogs);
                                    localStorage.setItem('worklog_data', cleanedSerialized);
                                    
                                    console.log('오래된 데이터 정리 후 저장 성공');
                                    showToast('오래된 데이터를 정리하고 저장했습니다');
                                    
                                    // 저장 성공 시 버튼 영역 표시 제거
                                    const buttonAreaSuccess = document.getElementById('floatingActionButtons');
                                    const saveBtnSuccess = document.querySelector('.btn-save');
                                    
                                    if (buttonAreaSuccess) {
                                        buttonAreaSuccess.classList.remove('ready-to-save');
                                        const existingBadge = buttonAreaSuccess.querySelector('.ready-to-save-badge');
                                        if (existingBadge) {
                                            existingBadge.remove();
                                        }
                                    }
                                    
                                    if (saveBtnSuccess) {
                                        saveBtnSuccess.classList.remove('ready');
                                    }
                                    
                                    // 저장 후 요약 데이터 업데이트
                                    updateSummaryData();
                                    return; // 성공적으로 저장했으므로 함수 종료
                                }
                            } catch (cleanError) {
                                console.error('데이터 정리 중 오류:', cleanError);
                            }
                        }
                        
                        // 정리 후에도 실패하면 기존 데이터를 모두 삭제하고 새 데이터만 저장
                        console.log('기존 데이터 삭제 후 새 데이터만 저장 시도...');
                        localStorage.setItem('worklog_data', JSON.stringify([worklogData]));
                        console.log('기존 데이터 삭제 후 저장 성공');
                        showToast('기존 데이터를 정리하고 저장했습니다');
                        
                        // 저장 성공 시 버튼 영역 표시 제거
                        const buttonAreaSuccess2 = document.getElementById('floatingActionButtons');
                        const saveBtnSuccess2 = document.querySelector('.btn-save');
                        
                        if (buttonAreaSuccess2) {
                            buttonAreaSuccess2.classList.remove('ready-to-save');
                            const existingBadge = buttonAreaSuccess2.querySelector('.ready-to-save-badge');
                            if (existingBadge) {
                                existingBadge.remove();
                            }
                        }
                        
                        if (saveBtnSuccess2) {
                            saveBtnSuccess2.classList.remove('ready');
                        }
                        
                        // 저장 후 요약 데이터 업데이트
                        updateSummaryData();
                        return; // 성공적으로 저장했으므로 함수 종료
                        
                    } catch (retryError) {
                        console.error('자동 정리 후 재시도 실패:', retryError);
                        throw new Error('저장 공간이 부족합니다. 브라우저 캐시를 정리한 후 다시 시도해주세요.');
                    }
                } else if (errorMsg.includes('localStorage')) {
                    throw new Error('브라우저 저장소를 사용할 수 없습니다. 브라우저 설정을 확인해주세요.');
                } else {
                    throw new Error('데이터 저장 중 오류가 발생했습니다: ' + errorMsg);
                }
            }
            
            // 저장 완료 시 버튼 영역 표시 제거
            const buttonArea = document.getElementById('floatingActionButtons');
            const saveBtn = document.querySelector('.btn-save');
            
            if (buttonArea) {
                buttonArea.classList.remove('ready-to-save');
                const existingBadge = buttonArea.querySelector('.ready-to-save-badge');
                if (existingBadge) {
                    existingBadge.remove();
                }
            }
            
            if (saveBtn) {
                saveBtn.classList.remove('ready');
            }
            
            // 저장 성공 로그
            console.log('작업일지 저장 완료:', worklogData);
            showToast('저장 완료');
            
            // 저장 후 요약 데이터 업데이트
            updateSummaryData();
        } catch (error) {
            console.error('저장 오류 상세:', error);
            console.error('오류 스택:', error.stack);
            
            // 사용자에게 명확한 오류 메시지 표시
            const errorMessage = error.message || '알 수 없는 오류가 발생했습니다.';
            showToast('저장 실패: ' + errorMessage);
            
            // 심각한 오류인 경우에만 alert 표시
            if (errorMessage.includes('저장 공간') || errorMessage.includes('브라우저 저장소')) {
                alert(errorMessage + '\n\n콘솔에서 자세한 오류 정보를 확인할 수 있습니다.');
            } else {
                // 일반 오류는 토스트만 표시하고 콘솔에 상세 정보 기록
                console.error('저장 실패 - 사용자에게 표시된 메시지:', errorMessage);
            }
        }
    }
    
    function handleMaterialSelect(select) {
        const customWrap = document.getElementById('mat-custom-input-wrap');
        if (select.value === 'custom') {
            customWrap.style.display = 'block';
            // 직접입력 필드에 포커스
            setTimeout(() => {
                const input = document.getElementById('mat-custom-name');
                if (input) input.focus();
            }, 100);
        } else {
            customWrap.style.display = 'none';
            customMaterialName = '';
        }
    }
    
    let customMaterialName = '';
    
    // 직접입력 시 실시간으로 입력값 반영
    function handleCustomMaterialInput(value) {
        if (!value.trim()) return;
        
        const select = document.getElementById('mat-name');
        let customOpt = select.querySelector('option[value="custom_temp"]');
        if (!customOpt) {
            customOpt = document.createElement('option');
            customOpt.value = 'custom_temp';
            select.appendChild(customOpt);
        }
        customOpt.text = value.trim(); // 입력값으로 바로 표시
        customOpt.selected = true;
        customMaterialName = value.trim();
    }
    
    function confirmCustomMaterial() {
        const input = document.getElementById('mat-custom-name');
        const select = document.getElementById('mat-name');
        if (!input.value.trim()) {
            showToast('자재명 입력');
            return;
        }
        
        const customName = input.value.trim();
        customMaterialName = customName;
        
        // 직접입력한 이름을 선택 필터에 표시하기 위해 옵션 추가 또는 텍스트 변경
        let customOpt = select.querySelector('option[value="custom_temp"]');
        if (!customOpt) {
            customOpt = document.createElement('option');
            customOpt.value = 'custom_temp';
            select.appendChild(customOpt);
        }
        customOpt.text = customName; // 입력값으로 바로 표시
        customOpt.selected = true;
        
        document.getElementById('mat-custom-input-wrap').style.display = 'none';
        showToast('자재 선택');
    }
    function resetPage() { 
        if(confirm('초기화하시겠습니까?')) {
            // 1. 권역 선택 초기화 (전체로 설정)
            const regionChips = document.querySelectorAll('.chip-grid[data-type="region"] .select-chip');
            regionChips.forEach(chip => chip.classList.remove('active'));
            // "전체" 버튼 찾기 (onclick 속성에 '전체'가 포함된 버튼)
            const allChip = Array.from(regionChips).find(chip => {
                const onclick = chip.getAttribute('onclick') || '';
                return onclick.includes("'전체'") || onclick.includes('"전체"') || onclick.includes('전체');
            });
            if (allChip) {
                allChip.classList.add('active');
            } else if (regionChips.length > 0) {
                // 첫 번째 버튼을 기본 선택
                regionChips[0].classList.add('active');
            }
            currentRegion = '전체';
            hasRegionTouched = false;
            
            // 2. 현장 선택 초기화
            const siteSelect = document.getElementById('siteSelect');
            if (siteSelect) {
                siteSelect.innerHTML = '';
                const placeholderOption = document.createElement('option');
                placeholderOption.value = '';
                placeholderOption.textContent = '현장 선택';
                placeholderOption.selected = true;
                siteSelect.appendChild(placeholderOption);
                // 권역에 맞는 현장 목록 다시 로드
                filterSitesByRegion('전체');
            }
            
            // 3. 소속 초기화
            const selDept = document.getElementById('sel-dept');
            if (selDept) {
                selDept.value = '';
            }
            
            // 4. 작업일자 초기화
            const inputDate = document.getElementById('input-date');
            if (inputDate) {
                inputDate.value = '';
            }
            
            // 5. 투입 인원 리스트 초기화
            manpowerList = [];
            const manpowerListEl = document.getElementById('manpower-list');
            if (manpowerListEl) {
                manpowerListEl.innerHTML = '';
            }
            // 기본 인원 다시 추가
            addManpowerRow({ presetWorker: (predefinedWorkers && predefinedWorkers[0]) ? predefinedWorkers[0] : '이현수', locked: true });
            
            // 6. 작업 세트 초기화
            const workContentList = document.getElementById('work-content-list');
            if (workContentList) {
                workContentList.innerHTML = '';
            }
            workSetCount = 0;
            
            // 7. 자재 사용 내역 초기화
            const matList = document.getElementById('mat-list');
            if (matList) {
                matList.innerHTML = '';
            }
            const matQty = document.getElementById('mat-qty');
            if (matQty) {
                matQty.value = '';
            }
            const matName = document.getElementById('mat-name');
            if (matName) {
                matName.value = 'NPC-1000';
            }
            const matCustomInput = document.getElementById('mat-custom-input-wrap');
            if (matCustomInput) {
                matCustomInput.style.display = 'none';
            }
            const matCustomName = document.getElementById('mat-custom-name');
            if (matCustomName) {
                matCustomName.value = '';
            }
            customMaterialName = '';
            
            // 8. 사진/도면 카운트 초기화
            photoCount = 0;
            drawingCount = 0;
            
            // 9. 저장 가능 배지 제거
            const buttonArea = document.getElementById('floatingActionButtons');
            if (buttonArea) {
                buttonArea.classList.remove('ready-to-save');
                const existingBadge = buttonArea.querySelector('.ready-to-save-badge');
                if (existingBadge) {
                    existingBadge.remove();
                }
            }
            const saveBtn = document.querySelector('.btn-save');
            if (saveBtn) {
                saveBtn.classList.remove('ready');
            }
            
            // 10. 모든 에러 효과 및 안내 효과 제거
            document.querySelectorAll('.section-error-highlight, .error-shake, .next-step-guide').forEach(el => {
                el.classList.remove('section-error-highlight', 'error-shake', 'next-step-guide');
                if (el.style) {
                    el.style.border = '';
                    el.style.backgroundColor = '';
                    el.style.animation = '';
                    el.style.borderColor = '';
                    el.style.boxShadow = '';
                    el.style.borderRadius = '';
                    el.style.padding = '';
                }
            });
            
            // 11. 요약 데이터 업데이트
            updateSummaryData();
            
            // 12. 필수 필드 검증 초기화
            checkRequiredFields();
            checkAllRequiredComplete();
            
            showToast('초기화 완료');
        }
    }

    /* =======================================================
       2. NEW PHOTO EDITOR LOGIC (Integrated - 이식3 반영)
       ======================================================= */
    let cellData = []; 
    let selectedIndex = -1;
    let peZoomLevel = 0.5;
    let peIsPanning = false;
    let peStartX = 0, peStartY = 0, pePointX = 0, pePointY = 0;

    const viewport = document.getElementById('peViewport');
    const paperWrapper = document.getElementById('paperWrapper');
    const btnPan = document.getElementById('btnPan');

    function openPhotoEditorWithData() {
        const siteSelect = document.getElementById('siteSelect');
        const siteName = siteSelect.options[siteSelect.selectedIndex].text;
        const inputDate = document.getElementById('input-date').value;
        const firstSet = document.querySelector('.work-set-item');
        let m = '', p = '';
        if(firstSet) {
             const mChip = firstSet.querySelector('.chip-grid[data-type="member"] .select-chip.active');
             const pChip = firstSet.querySelector('.chip-grid[data-type="process"] .select-chip.active');
             if(mChip) m = mChip.innerText;
             if(pChip) p = pChip.innerText;
        }
        
        document.getElementById('meta-site').value = (siteName === '현장 선택') ? '현장명 미입력' : `${siteName} (${inputDate})`;
        document.getElementById('meta-project').value = "균열보수 공사";
        document.getElementById('meta-member').value = m;
        document.getElementById('meta-process').value = p;
        
        document.getElementById('main-app').style.display = 'none';
        document.getElementById('photo-editor-app').classList.add('active');
        
        // Init View
        if(window.innerWidth > 800) peZoomLevel = 0.7; else peZoomLevel = window.innerWidth / 850;
        initPan();
        updateTransform();

        // Handle Pending Files
        if (pendingFiles.length > 0) {
            processPendingFiles(pendingFiles, m, p);
            pendingFiles = []; 
            document.getElementById('bulk-upload-label').innerText = "대량 업로드";
            const btn = document.getElementById('btn-bulk-upload');
            btn.style.borderColor = "var(--dotted-gray-border)";
            btn.style.color = "var(--dotted-gray-text)";
            btn.style.backgroundColor = "var(--dotted-gray-bg)";
        } else { 
            ensureMinLength(); 
            render(); 
        }
    }

    function closePhotoEditor() {
        if(cellData.some(d => d !== null)) { if(!confirm("작성 중인 내용이 저장되지 않았습니다. 나가시겠습니까?")) return; }
        document.getElementById('photo-editor-app').classList.remove('active');
        document.getElementById('main-app').style.display = 'block';
    }

    function ensureMinLength() {
        const rem = cellData.length % 6;
        if(rem !== 0) {
            const needed = 6 - rem;
            for(let i=0; i<needed; i++) cellData.push(null);
        } else if(cellData.length === 0) {
            for(let i=0; i<6; i++) cellData.push(null);
        }
    }

    function render() {
        const container = document.getElementById('paperWrapper');
        const siteTitle = document.getElementById('meta-site').value || '공사 사진대지'; 
        const projectTitle = document.getElementById('meta-project').value || '';
        container.innerHTML = '';

        for (let i = 0; i < cellData.length; i += 6) {
            const pageDiv = document.createElement('div');
            pageDiv.className = 'pe-page';
            let html = `
                <div class="doc-header"><div class="doc-title">${siteTitle}</div></div>
                <table class="pe-tbl" style="border-bottom:none;">
                    <tr><td style="background:#f1f5f9; font-weight:700; width:15%; height:30px;">공사명</td><td style="text-align:left; padding-left:10px;">${projectTitle}</td></tr>
                </table>
                <table class="pe-tbl">
                    <colgroup><col style="width:15%"><col style="width:35%"><col style="width:15%"><col style="width:35%"></colgroup>
            `;
            for (let r = 0; r < 3; r++) {
                const idx1 = i + (r * 2);
                const idx2 = i + (r * 2) + 1;
                const D1 = cellData[idx1];
                const D2 = cellData[idx2];
                const desc1 = (D1 && D1.desc) ? D1.desc : '보수후';
                const desc2 = (D2 && D2.desc) ? D2.desc : '보수후';

                html += `
                    <tr>
                        <td colspan="2" class="cell-photo ${!D1?'empty':''}" onclick="onCellClick(${idx1})">${D1 ? `<img src="${D1.img}">` : ''}</td>
                        <td colspan="2" class="cell-photo ${!D2?'empty':''}" onclick="onCellClick(${idx2})">${D2 ? `<img src="${D2.img}">` : ''}</td>
                    </tr>
                    <tr>
                        <td class="cell-text" style="background:#f1f5f9; font-weight:700;">부재명</td><td><input class="cell-input" value="${D1?.member||''}" oninput="updateData(${idx1}, 'member', this.value)"></td>
                        <td class="cell-text" style="background:#f1f5f9; font-weight:700;">부재명</td><td><input class="cell-input" value="${D2?.member||''}" oninput="updateData(${idx2}, 'member', this.value)"></td>
                    </tr>
                    <tr>
                        <td class="cell-text" style="background:#f1f5f9; font-weight:700;">공 정</td><td><input class="cell-input" value="${D1?.process||''}" oninput="updateData(${idx1}, 'process', this.value)"></td>
                        <td class="cell-text" style="background:#f1f5f9; font-weight:700;">공 정</td><td><input class="cell-input" value="${D2?.process||''}" oninput="updateData(${idx2}, 'process', this.value)"></td>
                    </tr>
                    <tr>
                        <td class="cell-text" style="background:#f1f5f9; font-weight:700;">내 용</td><td><span class="toggle-text" onclick="toggleDesc(${idx1}); event.stopPropagation();">${desc1}</span></td>
                        <td class="cell-text" style="background:#f1f5f9; font-weight:700;">내 용</td><td><span class="toggle-text" onclick="toggleDesc(${idx2}); event.stopPropagation();">${desc2}</span></td>
                    </tr>
                `;
            }
            html += `</table>`;
            pageDiv.innerHTML = html;
            container.appendChild(pageDiv);
        }
        lucide.createIcons();
    }

    // --- Action Handlers ---
    function onCellClick(idx) {
        if (peIsPanning) return;
        selectedIndex = idx;
        const item = cellData[idx];
        const sheet = document.getElementById('sheetContent');
        const modal = document.getElementById('actionModal');

        if (!item) {
            sheet.innerHTML = `<button class="sheet-btn primary" onclick="document.getElementById('pe-file-input').click(); closeModal();"><i data-lucide="plus"></i> 사진 추가</button><button class="sheet-btn danger" onclick="deleteAndPull()"><i data-lucide="trash"></i> 칸 삭제 (당기기)</button><button class="sheet-btn" onclick="closeModal()">취소</button>`;
        } else {
            sheet.innerHTML = `<button class="sheet-btn" onclick="document.getElementById('pe-replace-input').click()"><i data-lucide="image-plus"></i> 사진 교체</button><button class="sheet-btn danger" onclick="deleteAndPull()"><i data-lucide="trash-2"></i> 삭제하고 당기기</button><button class="sheet-btn" onclick="closeModal()">취소</button>`;
        }
        lucide.createIcons();
        modal.classList.add('active');
    }

    async function handleEditorUpload(input) {
        if (!input.files.length) return;
        const m = document.getElementById('meta-member').value;
        const p = document.getElementById('meta-process').value;
        processPendingFiles(Array.from(input.files), m, p);
        input.value = '';
    }

    async function processPendingFiles(files, defM, defP) {
        showLoading("사진 처리 중...");
        let insertIdx = cellData.findIndex(item => item === null);
        if (insertIdx === -1) insertIdx = cellData.length;
        const defD = document.getElementById('meta-desc').value || '보수후';

        for (const file of files) {
            try {
                const imgStr = await cropImageToAspect(file);
                const newItem = { img: imgStr, member: defM || '', process: defP || '', desc: defD };
                if (insertIdx < cellData.length) cellData[insertIdx] = newItem; else cellData.push(newItem);
                insertIdx++;
                while (insertIdx < cellData.length && cellData[insertIdx] !== null) insertIdx++;
            } catch (err) {}
        }
        ensureMinLength(); render(); hideLoading();
    }

    function cropImageToAspect(file) {
        return new Promise((resolve) => {
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    let w = img.width, h = img.height;
                    const max = 1280; 
                    if (w > h) { if (w > max) { h *= max/w; w = max; } } else { if (h > max) { w *= max/h; h = max; } }
                    canvas.width = w; canvas.height = h;
                    canvas.getContext('2d').drawImage(img, 0, 0, w, h);
                    resolve(canvas.toDataURL('image/jpeg', 0.8));
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        });
    }

    async function handleReplace(input) {
        if(input.files.length && selectedIndex !== -1) {
            showLoading('교체 중...');
            cellData[selectedIndex].img = await cropImageToAspect(input.files[0]);
            render(); hideLoading();
        }
        input.value = ''; closeModal();
    }

    function updateData(idx, key, val) { if(cellData[idx]) cellData[idx][key] = val; }
    function toggleDesc(idx) { 
        if(!cellData[idx]) return; 
        const c = cellData[idx].desc || '보수후';
        cellData[idx].desc = (c === '보수후') ? '보수전' : '보수후';
        render(); 
    }
    function applyToAll(k, v) { cellData.forEach(d => { if(d) d[k] = v; }); render(); }
    function deleteAndPull() { if(selectedIndex!==-1) { cellData.splice(selectedIndex, 1); ensureMinLength(); render(); closeModal(); showToast("삭제"); } }
    function resetData() { if(confirm("초기화?")) { cellData=[]; ensureMinLength(); render(); showToast("초기화"); } }
    
    function removeEmptyPages() {
        if(!confirm('빈 페이지를 정리하시겠습니까?')) return;
        let newCells = [];
        for(let i=0; i<cellData.length; i+=6) {
            const chunk = cellData.slice(i, i+6);
            if(!chunk.every(item => item === null)) newCells.push(...chunk);
        }
        cellData = newCells; 
        if(cellData.length===0) ensureMinLength();
        render(); showToast("정리");
    }

    function sortAndClassify() {
        if(!confirm('보수 전->후 순서로 정렬하시겠습니까?')) return;
        cellData.sort((a,b) => {
            if(!a && !b) return 0; if(!a) return 1; if(!b) return -1;
            const aB = (a.desc||'').includes('보수전');
            const bB = (b.desc||'').includes('보수전');
            if(aB && !bB) return -1; if(!aB && bB) return 1; return 0;
        });
        render(); showToast("정렬");
    }

    // --- Viewport Control ---
    function adjustZoom(delta) { peZoomLevel = Math.max(0.2, peZoomLevel + delta); updateTransform(); }
    function togglePan() { peIsPanning = !peIsPanning; btnPan.classList.toggle('active', peIsPanning); viewport.classList.toggle('panning', peIsPanning); }
    function updateTransform() { paperWrapper.style.transform = `translate(${pePointX}px, ${pePointY}px) scale(${peZoomLevel})`; }
    
    function initPan() {
        let sx=0, sy=0, cx=0, cy=0;
        const start = (e) => {
            if(!peIsPanning) return;
            if(['INPUT','BUTTON'].includes(e.target.tagName)) return;
            e.preventDefault();
            const evt = e.touches ? e.touches[0] : e;
            sx = evt.clientX - cx; sy = evt.clientY - cy;
            document.addEventListener('mousemove', move); document.addEventListener('touchmove', move, {passive:false});
            document.addEventListener('mouseup', end); document.addEventListener('touchend', end);
        };
        const move = (e) => {
            const evt = e.touches ? e.touches[0] : e;
            cx = evt.clientX - sx; cy = evt.clientY - sy;
            pePointX = cx; pePointY = cy; updateTransform();
        };
        const end = () => { document.removeEventListener('mousemove', move); document.removeEventListener('touchmove', move); document.removeEventListener('mouseup', end); document.removeEventListener('touchend', end); };
        viewport.addEventListener('mousedown', start); viewport.addEventListener('touchstart', start, {passive:false});
    }

    async function savePDF() {
        showToast("PDF 생성");
        const oldTrans = paperWrapper.style.transform;
        paperWrapper.style.transform = 'scale(1)'; paperWrapper.style.margin = '0';
        try {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');
            const pages = document.querySelectorAll('.pe-page');
            for(let i=0; i<pages.length; i++) {
                if(i>0) doc.addPage();
                const cvs = await html2canvas(pages[i], { scale: 1.5, useCORS: true, backgroundColor: "#ffffff" });
                doc.addImage(cvs.toDataURL('image/jpeg', 0.8), 'JPEG', 0, 0, 210, 297);
            }
            doc.save(`${document.getElementById('meta-site').value}.pdf`);
            showToast("다운로드");
        } catch(e) { showToast("오류"); }
        finally { paperWrapper.style.transform = oldTrans; }
    }

    async function shareContent() {
        if(!navigator.share) { alert("공유 미지원 브라우저"); return; }
        showToast("공유 준비 중...");
        const oldTrans = paperWrapper.style.transform;
        paperWrapper.style.transform = 'scale(1)';
        try {
            const page = document.querySelector('.pe-page');
            const cvs = await html2canvas(page, { scale: 1.5, useCORS: true });
            cvs.toBlob(async blob => {
                const file = new File([blob], "photo_log.jpg", { type: "image/jpeg" });
                try { await navigator.share({ title: '사진대지', files: [file] }); showToast("공유"); } catch(e){}
            });
        } catch(e) {}
        finally { paperWrapper.style.transform = oldTrans; }
    }

    /* =======================================================
       3. MARKING MODAL LOGIC
       ======================================================= */
    let mkCvs, mkCtx, mkImgObj = new Image();
    let mkDrawObjects = [];
    let mkCurrentTool = 'rect';
    let mkCurrentColor = 'rgba(49, 163, 250, 0.3)';
    let mkStrokeColor = '#31a3fa';
    let mkIsDown = false;
    let mkCamera = { x: 0, y: 0, scale: 1 };
    let mkLastPan = { x: 0, y: 0 };
    let mkCurrentObj = null;
    let mkMoveStartPos = { x: 0, y: 0 };
    let mkCurrentStamp = 'circle';

    function initMarkingCanvas() {
        document.getElementById('canvasModal').classList.add('active');
        const container = document.getElementById('canvasContainer');
        mkCvs = document.getElementById('mainCanvas');
        mkCtx = mkCvs.getContext('2d');
        const w = container.clientWidth; const h = container.clientHeight;
        mkCvs.width = w; mkCvs.height = h;
        
        let scale = Math.min(mkCvs.width/mkImgObj.width, mkCvs.height/mkImgObj.height) * 0.9;
        mkCamera = { scale: scale, x: (mkCvs.width - mkImgObj.width*scale)/2, y: (mkCvs.height - mkImgObj.height*scale)/2 };
        
        mkDrawObjects = [];
        setTool('rect');
        
        mkCvs.addEventListener('mousedown', mkHandleStart);
        mkCvs.addEventListener('mousemove', mkHandleMove);
        mkCvs.addEventListener('mouseup', mkHandleEnd);
        mkCvs.addEventListener('touchstart', mkHandleStart, {passive:false});
        mkCvs.addEventListener('touchmove', mkHandleMove, {passive:false});
        mkCvs.addEventListener('touchend', mkHandleEnd);
        mkRedrawCanvas();
    }

    function confirmCloseCanvas() { if(confirm("저장하지 않고 닫으시겠습니까?")) document.getElementById('canvasModal').classList.remove('active'); }
    function mkRedrawCanvas() {
        mkCtx.setTransform(1,0,0,1,0,0);
        mkCtx.clearRect(0,0,mkCvs.width,mkCvs.height);
        mkCtx.setTransform(mkCamera.scale, 0, 0, mkCamera.scale, mkCamera.x, mkCamera.y);
        mkCtx.drawImage(mkImgObj, 0, 0);
        mkDrawObjects.forEach(o => drawSingleObject(mkCtx, o));
        if(mkCurrentObj) drawSingleObject(mkCtx, mkCurrentObj);
    }
    
    function drawSingleObject(c, o) {
        c.lineWidth = (o.type === 'rect') ? (o.size/5) : 2;
        c.strokeStyle = o.stroke; c.fillStyle = o.fill || o.stroke;
        c.beginPath();
        if(o.type === 'rect') { c.rect(o.x, o.y, o.w, o.h); if(o.fill) c.fill(); c.stroke(); }
        else if(o.type === 'brush') { c.lineWidth = o.size; c.lineCap='round'; c.lineJoin='round'; c.moveTo(o.points[0].x, o.points[0].y); o.points.forEach(p => c.lineTo(p.x, p.y)); c.stroke(); }
        else if(o.type === 'text') { c.font = `bold ${parseInt(o.size)+20}px Pretendard`; c.fillStyle = o.stroke; c.fillText(o.text, o.x, o.y); }
        else if(o.type === 'stamp') { 
            const s = parseInt(o.size);
            if(o.shape === 'circle') c.arc(o.x, o.y, s, 0, Math.PI*2);
            else if(o.shape === 'square') c.rect(o.x-s, o.y-s, s*2, s*2);
            else if(o.shape === 'triangle'){ c.moveTo(o.x,o.y-s);c.lineTo(o.x+s,o.y+s);c.lineTo(o.x-s,o.y+s);c.closePath(); }
            else if(o.shape === 'star'){ let rot=Math.PI/2*3, step=Math.PI/5, outer=s, inner=s/2; c.moveTo(o.x,o.y-outer); for(let i=0; i<5; i++){ c.lineTo(o.x+Math.cos(rot)*outer,o.y+Math.sin(rot)*outer); rot+=step; c.lineTo(o.x+Math.cos(rot)*inner,o.y+Math.sin(rot)*inner); rot+=step; } c.lineTo(o.x,o.y-outer); c.closePath(); }
            c.fill();
        }
    }

    function toWorld(sx, sy) { return { x: (sx - mkCamera.x)/mkCamera.scale, y: (sy - mkCamera.y)/mkCamera.scale }; }
    function getEventPos(e) { const r = mkCvs.getBoundingClientRect(); if(e.touches && e.touches.length > 0) return { x: e.touches[0].clientX - r.left, y: e.touches[0].clientY - r.top }; return { x: e.clientX - r.left, y: e.clientY - r.top }; }

    function mkHandleStart(e) {
        const pos = getEventPos(e);
        const wp = toWorld(pos.x, pos.y);
        const size = document.getElementById('sizeSlider').value;
        mkMoveStartPos = { x: pos.x, y: pos.y };
        
        if(mkCurrentTool === 'hand') { mkIsDown = true; mkLastPan = {x: pos.x, y: pos.y}; return; }
        if(mkCurrentTool === 'text') { const t = prompt("텍스트 입력:"); if(t) { mkDrawObjects.push({type:'text', x:wp.x, y:wp.y, text:t, stroke:mkStrokeColor, size:parseInt(size)}); mkRedrawCanvas(); } return; }
        
        mkIsDown = true;
        if(mkCurrentTool === 'rect') mkCurrentObj = {type:'rect', x:wp.x, y:wp.y, w:0, h:0, stroke:mkStrokeColor, fill:mkCurrentColor, size:parseInt(size)};
        else if(mkCurrentTool === 'brush') mkCurrentObj = {type:'brush', points:[wp], stroke:mkStrokeColor, size:parseInt(size)};
    }

    function mkHandleMove(e) {
        if(!mkIsDown) return;
        e.preventDefault();
        const pos = getEventPos(e);
        const wp = toWorld(pos.x, pos.y);
        
        if(mkCurrentTool === 'hand') { mkCamera.x += pos.x - mkLastPan.x; mkCamera.y += pos.y - mkLastPan.y; mkLastPan = {x: pos.x, y: pos.y}; }
        else if(mkCurrentTool === 'rect') { mkCurrentObj.w = wp.x - mkCurrentObj.x; mkCurrentObj.h = wp.y - mkCurrentObj.y; }
        else if(mkCurrentTool === 'brush') { mkCurrentObj.points.push(wp); }
        mkRedrawCanvas();
    }

    function mkHandleEnd(e) {
        if(mkCurrentTool === 'stamp' && mkIsDown && !mkCurrentObj) {
            const pos = getEventPos(e.changedTouches ? e.changedTouches[0] : e);
            if(Math.hypot(pos.x - mkMoveStartPos.x, pos.y - mkMoveStartPos.y) < 10) {
                const wp = toWorld(pos.x, pos.y);
                const size = document.getElementById('sizeSlider').value;
                mkDrawObjects.push({type:'stamp', x:wp.x, y:wp.y, shape:mkCurrentStamp, stroke:mkStrokeColor, size:parseInt(size)});
                mkRedrawCanvas();
            }
        }
        if(mkIsDown && mkCurrentObj) {
            if(mkCurrentTool === 'rect') { if(mkCurrentObj.w < 0) { mkCurrentObj.x += mkCurrentObj.w; mkCurrentObj.w = Math.abs(mkCurrentObj.w); } if(mkCurrentObj.h < 0) { mkCurrentObj.y += mkCurrentObj.h; mkCurrentObj.h = Math.abs(mkCurrentObj.h); } if(mkCurrentObj.w>5 || mkCurrentObj.h>5) mkDrawObjects.push(mkCurrentObj); }
            else { mkDrawObjects.push(mkCurrentObj); }
            mkCurrentObj = null;
        }
        mkIsDown = false; mkRedrawCanvas();
    }

    function setTool(t) {
        mkCurrentTool = t;
        document.querySelectorAll('.c-tool-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('tool-'+t).classList.add('active');
        document.getElementById('stamp-options').style.display = (t === 'stamp') ? 'flex' : 'none';
        if(t === 'hand') mkCvs.style.cursor = 'grab'; else mkCvs.style.cursor = 'crosshair';
    }
    function setStamp(s) { mkCurrentStamp = s; document.getElementById('stamp-options').querySelectorAll('button').forEach(b => b.classList.remove('active')); event.currentTarget.classList.add('active'); }
    function setColor(c) {
        if(c==='blue') { mkStrokeColor='#31a3fa'; mkCurrentColor='rgba(49,163,250,0.3)'; } 
        else if(c==='red') { mkStrokeColor='#ef4444'; mkCurrentColor='rgba(239,68,68,0.3)'; } 
        else if(c==='green') { mkStrokeColor='#22c55e'; mkCurrentColor='rgba(34,197,94,0.3)'; } 
        else if(c==='orange') { mkStrokeColor='#f97316'; mkCurrentColor='rgba(249,115,22,0.3)'; } 
        else if(c==='purple') { mkStrokeColor='#a855f7'; mkCurrentColor='rgba(168,85,247,0.3)'; } 
        else if(c==='gray') { mkStrokeColor='#64748b'; mkCurrentColor='rgba(100,116,139,0.3)'; }
        document.querySelectorAll('.color-btn').forEach(b => b.classList.remove('active'));
        document.querySelector(`.color-btn[data-color="${c}"]`).classList.add('active');
    }
    function undoLastAction() { if(mkDrawObjects.length > 0) { mkDrawObjects.pop(); mkRedrawCanvas(); } }
    function clearDrawingLayer() { if(confirm("모두 지우시겠습니까?")) { mkDrawObjects = []; mkRedrawCanvas(); } }
    function saveCanvas() {
        const t = document.createElement('canvas'); t.width = mkImgObj.width; t.height = mkImgObj.height;
        const tx = t.getContext('2d'); tx.drawImage(mkImgObj, 0, 0);
        mkDrawObjects.forEach(o => drawSingleObject(tx, o));
        const dataURL = t.toDataURL("image/png");
        console.log("Saved Drawing:", dataURL);
        showToast("도면 저장");
        document.getElementById('canvasModal').classList.remove('active');
    }

    function showLoading(msg) { document.getElementById('loadingMask').style.display = 'flex'; if(msg) document.getElementById('loadingText').innerText = msg; }
    function hideLoading() { document.getElementById('loadingMask').style.display = 'none'; }
    function closeModal() { document.getElementById('actionModal').classList.remove('active'); }
    function showToast(msg) {
        const t = document.getElementById('toast');
        const textEl = document.getElementById('toast-text');
        if (!t || !textEl) return;
        // 핵심만 간결하게 표시
        const shortMsg = msg.length > 20 ? msg.substring(0, 18) + '...' : msg;
        textEl.innerText = shortMsg;
        t.classList.add('show');
        clearTimeout(window.toastTimer);
        window.toastTimer = setTimeout(() => t.classList.remove('show'), 2000);
    }

    // =================================================================
    // 작업완료확인서 모달 클래스 (네임스페이스 격리)
    // =================================================================
    const WorkReportModal = (function() {
        let modal, viewport, paperWrapper, signaturePad, canvas, wrapper;
        let zoomLevel = 1.0, isPanning = false, pointX = 0, pointY = 0, startX = 0, startY = 0;
        
        function showToast(msg) {
            const toast = document.getElementById('wr-toast');
            const msgEl = document.getElementById('wr-toastMsg');
            if (!toast || !msgEl) return;
            msgEl.innerText = msg;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 2000);
        }
        
        function initViewer() {
            viewport = document.getElementById('wr-viewport');
            paperWrapper = document.getElementById('wr-paperWrapper');
            const btnPan = document.getElementById('wr-btnPanToggle');
            
            document.getElementById('wr-btnZoomIn').addEventListener('click', () => adjustZoom(0.1));
            document.getElementById('wr-btnZoomOut').addEventListener('click', () => adjustZoom(-0.1));
            btnPan.addEventListener('click', () => togglePan());
            viewport.addEventListener('mousedown', onPointerDown);
            viewport.addEventListener('touchstart', onPointerDown, {passive:false});
            window.addEventListener('resize', () => {
                clearTimeout(this.resizeTimer);
                this.resizeTimer = setTimeout(() => fitToWidth(), 200);
            });
            setTimeout(() => fitToWidth(), 100);
        }
        
        function fitToWidth() {
            const viewportW = viewport.clientWidth;
            const contentW = 854;
            let scale = viewportW / contentW;
            if(scale > 1.2) scale = 1.0;
            zoomLevel = scale;
            updateTransform();
        }
        
        function adjustZoom(delta) {
            zoomLevel = Math.max(0.3, zoomLevel + delta);
            updateTransform();
        }
        
        function togglePan() {
            isPanning = !isPanning;
            const btnPan = document.getElementById('wr-btnPanToggle');
            btnPan.classList.toggle('active', isPanning);
            viewport.classList.toggle('panning', isPanning);
        }
        
        function updateTransform() {
            paperWrapper.style.transform = `translate(${pointX}px, ${pointY}px) scale(${zoomLevel})`;
        }
        
        function onPointerDown(e) {
            if(!isPanning) return;
            const tagName = e.target.tagName;
            if(['INPUT', 'TEXTAREA', 'BUTTON', 'LABEL', 'CANVAS'].includes(tagName)) return;
            if(e.target.closest('#wr-imageEditLayer')) return;
            if(e.target.type === 'range') return;
            e.preventDefault();
            e.stopPropagation();
            const cx = e.touches ? e.touches[0].clientX : e.clientX;
            const cy = e.touches ? e.touches[0].clientY : e.clientY;
            startX = cx - pointX;
            startY = cy - pointY;
            const moveHandler = (ev) => {
                ev.preventDefault();
                const mx = ev.touches ? ev.touches[0].clientX : ev.clientX;
                const my = ev.touches ? ev.touches[0].clientY : ev.clientY;
                pointX = mx - startX;
                pointY = my - startY;
                updateTransform();
            };
            const upHandler = () => {
                document.removeEventListener('mousemove', moveHandler);
                document.removeEventListener('mouseup', upHandler);
                document.removeEventListener('touchmove', moveHandler);
                document.removeEventListener('touchend', upHandler);
            };
            document.addEventListener('mousemove', moveHandler);
            document.addEventListener('mouseup', upHandler);
            document.addEventListener('touchmove', moveHandler, {passive: false});
            document.addEventListener('touchend', upHandler);
        }
        
        function initSignature() {
            canvas = document.getElementById('wr-signatureCanvas');
            wrapper = document.getElementById('wr-canvasContainer');
            if (!canvas || !wrapper || !window.SignaturePad) return;
            
            signaturePad = new SignaturePad(canvas, {
                backgroundColor: 'rgba(255, 255, 255, 0)',
                penColor: 'rgb(0, 0, 0)',
                minWidth: 0.5,
                maxWidth: 2.5,
                throttle: 0,
                velocityFilterWeight: 0.7
            });
            
            const resizeObserver = new ResizeObserver(() => resizeCanvas());
            resizeObserver.observe(wrapper);
            setTimeout(() => resizeCanvas(), 100);
            
            document.getElementById('wr-btnPen').addEventListener('click', (e) => setMode('pen', e.target));
            document.getElementById('wr-btnEraser').addEventListener('click', (e) => setMode('erase', e.target));
            document.getElementById('wr-btnClearSign').addEventListener('click', () => clear());
            document.getElementById('wr-btnUndo').addEventListener('click', () => undo());
            document.getElementById('wr-btnImportCamera').addEventListener('click', () => document.getElementById('wr-signImageInput').click());
            document.getElementById('wr-signImageInput').addEventListener('change', (e) => handleImageFile(e));
            document.getElementById('wr-btnEditCancel').addEventListener('click', () => closeEditor());
            document.getElementById('wr-btnEditApply').addEventListener('click', () => applyEditorImage());
            document.getElementById('wr-scaleSlider').addEventListener('input', (e) => {
                if (window.WorkReportModal && window.WorkReportModal.currentImgState) {
                    window.WorkReportModal.currentImgState.scale = parseFloat(e.target.value);
                    updateEditTransform();
                }
            });
        }
        
        function resizeCanvas() {
            if (!canvas || !wrapper) return;
            const ratio = Math.max(window.devicePixelRatio || 1, 1);
            const width = wrapper.clientWidth;
            const height = wrapper.clientHeight;
            if (width === 0 || height === 0) return;
            const data = signaturePad.toData();
            canvas.width = width * ratio;
            canvas.height = height * ratio;
            const ctx = canvas.getContext("2d");
            ctx.scale(ratio, ratio);
            signaturePad.clear();
            signaturePad.fromData(data);
        }
        
        function setMode(mode, btn) {
            document.querySelectorAll('#work-report-modal .wr-sign-tools .wr-mini-btn').forEach(b => b.classList.remove('active'));
            btn.closest('.wr-mini-btn').classList.add('active');
            if (mode === 'erase') {
                signaturePad.compositeOperation = 'source-over';
                signaturePad.penColor = '#ffffff';
                signaturePad.minWidth = 10;
                signaturePad.maxWidth = 30;
                showToast("지우개");
            } else {
                signaturePad.compositeOperation = 'source-over';
                signaturePad.penColor = '#000000';
                signaturePad.minWidth = 0.5;
                signaturePad.maxWidth = 2.5;
                showToast("펜");
            }
        }
        
        function undo() {
            const data = signaturePad.toData();
            if (data && data.length > 0) {
                data.pop();
                signaturePad.fromData(data);
                showToast("되돌림");
            } else {
                showToast("내역 없음");
            }
        }
        
        function clear() {
            if(confirm("서명을 삭제하시겠습니까?")) {
                signaturePad.clear();
                setMode('pen', document.getElementById('wr-btnPen'));
            }
        }
        
        function handleImageFile(e) {
            const file = e.target.files[0];
            if(!file) return;
            showToast("처리 중");
            const reader = new FileReader();
            reader.onload = (ev) => {
                const img = new Image();
                img.onload = () => {
                    const processed = removeBackground(img);
                    openEditor(processed);
                };
                img.src = ev.target.result;
            };
            reader.readAsDataURL(file);
            e.target.value = '';
        }
        
        function removeBackground(img) {
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = img.width;
            tempCanvas.height = img.height;
            const ctx = tempCanvas.getContext('2d');
            ctx.drawImage(img, 0, 0);
            const imageData = ctx.getImageData(0, 0, tempCanvas.width, tempCanvas.height);
            const data = imageData.data;
            let brightnesses = [];
            for(let i=0; i<data.length; i+=16) brightnesses.push(0.299*data[i] + 0.587*data[i+1] + 0.114*data[i+2]);
            brightnesses.sort((a,b)=>a-b);
            const p95 = brightnesses[Math.floor(brightnesses.length * 0.95)] || 255;
            const threshold = Math.max(200, p95 - 30);
            for(let i=0; i<data.length; i+=4) {
                const b = 0.299*data[i] + 0.587*data[i+1] + 0.114*data[i+2];
                if(b > threshold) data[i+3] = 0;
                else {
                    const alpha = Math.min(255, Math.max(0, (threshold - b)/threshold * 350));
                    data[i]=0; data[i+1]=0; data[i+2]=0; data[i+3]=alpha;
                }
            }
            ctx.putImageData(imageData, 0, 0);
            return tempCanvas.toDataURL();
        }
        
        let currentImgState = { x: 0, y: 0, scale: 1.0 };
        let dragStart = { mouseX: 0, mouseY: 0, imgX: 0, imgY: 0 };
        let isDraggingImg = false;
        
        function openEditor(src) {
            const editingImage = document.getElementById('wr-editingImage');
            const editLayer = document.getElementById('wr-imageEditLayer');
            const signTools = document.getElementById('wr-signTools');
            editingImage.src = src;
            editLayer.style.display = 'flex';
            signTools.style.visibility = 'hidden';
            currentImgState = { x: 0, y: 0, scale: 1.0 };
            document.getElementById('wr-scaleSlider').value = 1.0;
            updateEditTransform();
            showToast("위치 이동");
            
            editingImage.addEventListener('mousedown', startImgDrag);
            editingImage.addEventListener('touchstart', startImgDrag, {passive:false});
        }
        
        function closeEditor() {
            const editLayer = document.getElementById('wr-imageEditLayer');
            const signTools = document.getElementById('wr-signTools');
            const editingImage = document.getElementById('wr-editingImage');
            editLayer.style.display = 'none';
            signTools.style.visibility = 'visible';
            editingImage.src = "";
        }
        
        function applyEditorImage() {
            const ctx = canvas.getContext('2d');
            const editingImage = document.getElementById('wr-editingImage');
            const imgRect = editingImage.getBoundingClientRect();
            const canvasRect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / canvasRect.width;
            const scaleY = canvas.height / canvasRect.height;
            const relativeLeft = imgRect.left - canvasRect.left;
            const relativeTop = imgRect.top - canvasRect.top;
            const drawX = relativeLeft * scaleX;
            const drawY = relativeTop * scaleY;
            const drawW = imgRect.width * scaleX;
            const drawH = imgRect.height * scaleY;
            ctx.save();
            ctx.setTransform(1, 0, 0, 1, 0, 0);
            const prevOp = ctx.globalCompositeOperation;
            ctx.globalCompositeOperation = 'source-over';
            ctx.drawImage(editingImage, drawX, drawY, drawW, drawH);
            ctx.globalCompositeOperation = prevOp;
            ctx.restore();
            closeEditor();
            showToast("적용");
        }
        
        function startImgDrag(e) {
            e.preventDefault();
            e.stopPropagation();
            isDraggingImg = true;
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            dragStart.mouseX = clientX;
            dragStart.mouseY = clientY;
            dragStart.imgX = currentImgState.x;
            dragStart.imgY = currentImgState.y;
            const moveHandler = (ev) => onImgDragMove(ev);
            const upHandler = (ev) => onImgDragEnd(ev, moveHandler, upHandler);
            document.addEventListener('mousemove', moveHandler);
            document.addEventListener('mouseup', upHandler);
            document.addEventListener('touchmove', moveHandler, {passive:false});
            document.addEventListener('touchend', upHandler);
        }
        
        function onImgDragMove(e) {
            if(!isDraggingImg) return;
            e.preventDefault();
            e.stopPropagation();
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            const dx = clientX - dragStart.mouseX;
            const dy = clientY - dragStart.mouseY;
            currentImgState.x = dragStart.imgX + dx;
            currentImgState.y = dragStart.imgY + dy;
            updateEditTransform();
        }
        
        function onImgDragEnd(e, moveHandler, upHandler) {
            if (e) e.stopPropagation();
            isDraggingImg = false;
            document.removeEventListener('mousemove', moveHandler);
            document.removeEventListener('mouseup', upHandler);
            document.removeEventListener('touchmove', moveHandler);
            document.removeEventListener('touchend', upHandler);
        }
        
        function updateEditTransform() {
            const editingImage = document.getElementById('wr-editingImage');
            if (!editingImage) return;
            editingImage.style.transform = `translate(calc(-50% + ${currentImgState.x}px), calc(-50% + ${currentImgState.y}px)) scale(${currentImgState.scale})`;
        }
        
        async function savePDF() {
            showToast("PDF 생성");
            const paperArea = document.getElementById('wr-documentArea');
            const signTools = document.getElementById('wr-signTools');
            const originalTransform = paperWrapper.style.transform;
            const originalMargin = paperWrapper.style.margin;
            paperWrapper.style.transform = 'scale(1)';
            paperWrapper.style.margin = '0';
            signTools.style.display = 'none';
            try {
                const canvas = await html2canvas(paperArea, { scale: 2, useCORS: true, backgroundColor: "#ffffff" });
                const imgData = canvas.toDataURL('image/jpeg', 0.95);
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'a4');
                const pageWidth = 210;
                const imgHeight = canvas.height * pageWidth / canvas.width;
                pdf.addImage(imgData, 'JPEG', 0, 0, pageWidth, imgHeight);
                const d = new Date();
                const dateStr = `${d.getFullYear()}${String(d.getMonth()+1).padStart(2,'0')}${String(d.getDate()).padStart(2,'0')}`;
                pdf.save(`작업완료확인서_${dateStr}.pdf`);
                showToast("저장");
            } catch(err) {
                console.error(err);
                showToast("오류 발생");
            } finally {
                paperWrapper.style.transform = originalTransform;
                paperWrapper.style.margin = originalMargin;
                signTools.style.display = 'flex';
            }
        }
        
        async function shareContent() {
            if (!navigator.share) {
                alert("지원하지 않는 브라우저입니다.");
                return;
            }
            showToast("공유 준비");
            const paperArea = document.getElementById('wr-documentArea');
            const signTools = document.getElementById('wr-signTools');
            const originalTransform = paperWrapper.style.transform;
            const originalMargin = paperWrapper.style.margin;
            paperWrapper.style.transform = 'scale(1)';
            paperWrapper.style.margin = '0';
            signTools.style.display = 'none';
            try {
                const canvas = await html2canvas(paperArea, { scale: 2, useCORS: true });
                canvas.toBlob(async (blob) => {
                    const file = new File([blob], "work_confirm.jpg", { type: "image/jpeg" });
                    try {
                        await navigator.share({ title: '작업완료확인서', files: [file] });
                    } catch (e) {}
                }, 'image/jpeg', 0.9);
            } catch(e) {
                showToast("공유 실패");
            } finally {
                paperWrapper.style.transform = originalTransform;
                paperWrapper.style.margin = originalMargin;
                signTools.style.display = 'flex';
            }
        }
        
        return {
            open() {
                modal = document.getElementById('work-report-modal');
                if (!modal) return;
                modal.classList.add('active');
                document.body.style.overflow = 'hidden';
                initViewer();
                setTimeout(() => {
                    initSignature();
                    const d = new Date();
                    document.getElementById('wr-dateField').value = `${d.getFullYear()}년 ${d.getMonth()+1}월 ${d.getDate()}일`;
                }, 100);
                lucide.createIcons();
                
                document.getElementById('wr-btnBack').addEventListener('click', () => {
                    if(confirm("이전 화면으로 돌아가시겠습니까?")) this.close();
                });
                document.getElementById('wr-btnReset').addEventListener('click', () => {
                    if(confirm("초기화하시겠습니까?")) location.reload();
                });
                document.getElementById('wr-btnDownload').addEventListener('click', savePDF);
                document.getElementById('wr-btnShare').addEventListener('click', shareContent);
            },
            close() {
                if (modal) {
                    modal.classList.remove('active');
                    document.body.style.overflow = '';
                }
            },
            currentImgState: currentImgState
        };
    })();
    
    // 전역 노출
    window.JobConfirmModal = WorkReportModal;
    
    // =================================================================
    // DMM2 도면마킹 클래스 (네임스페이스 격리)
    // =================================================================
    const DrawingApp = (function() {
        if (window.pdfjsLib) {
            pdfjsLib.GlobalWorkerOptions.workerSrc = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.7.76/pdf.worker.min.js";
        }
        
        const $ = (sel, root=document) => root.querySelector(sel);
        const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
        
        const Root = $("#dmm2Root");
        const Overlay = $("#dmm2Overlay");
        const FileInput = $("#dmm2FileInput");
        const PagesBar = $("#dmm2PagesBar");
        const CanvasWrap = $("#dmm2CanvasWrap");
        const Canvas = $("#dmm2Canvas");
        if (!Canvas) return {};
        const Ctx = Canvas.getContext("2d");
        
        let isOpen = false;
        let pages = [];
        let currentIndex = -1;
        let currentTool = "rect";
        let currentStamp = "circle";
        let currentColorFill = "rgba(49,163,250,0.3)";
        let currentStroke = "#31a3fa";
        let isDown = false;
        let currentObj = null;
        let camera = { x: 0, y: 0, scale: 1 };
        const pointers = new Map();
        let isPinching = false;
        let pinchStartDist = 0;
        let pinchStartCamera = { x:0, y:0, scale:1 };
        let panLast = { x:0, y:0 };
        
        function showToast(msg="완료") {
            const Toast = $("#dmm2Toast");
            const ToastMsg = $("#dmm2ToastMsg");
            if (!Toast || !ToastMsg) return;
            ToastMsg.textContent = msg;
            Toast.classList.add("dmm2-show");
            setTimeout(() => Toast.classList.remove("dmm2-show"), 1800);
        }
        
        function showLoading(text="처리 중...") {
            const Loading = $("#dmm2Loading");
            const LoadingText = $("#dmm2LoadingText");
            if (!Loading || !LoadingText) return;
            LoadingText.textContent = text;
            Loading.classList.add("dmm2-show");
        }
        
        function hideLoading() {
            const Loading = $("#dmm2Loading");
            if (Loading) Loading.classList.remove("dmm2-show");
        }
        
        function setCanvasSize() {
            if (!CanvasWrap || !Canvas) return;
            const w = CanvasWrap.clientWidth;
            const h = CanvasWrap.clientHeight;
            if (Canvas.width !== w) Canvas.width = w;
            if (Canvas.height !== h) Canvas.height = h;
        }
        
        function toWorld(sx, sy) {
            return { x: (sx - camera.x) / camera.scale, y: (sy - camera.y) / camera.scale };
        }
        
        function fitToScreen() {
            const p = pages[currentIndex];
            if(!p) return;
            setCanvasSize();
            const margin = 0.92;
            const scale = Math.min(Canvas.width / p.bgW, Canvas.height / p.bgH) * margin;
            camera = { scale, x: (Canvas.width - p.bgW * scale) / 2, y: (Canvas.height - p.bgH * scale) / 2 };
            p.camera = { ...camera };
            redraw();
        }
        
        function drawSingle(c, o) {
            if(o.type === "rect") {
                c.lineWidth = (o.size/5);
                c.strokeStyle = o.stroke;
                c.fillStyle = o.fill;
                c.beginPath();
                c.rect(o.x, o.y, o.w, o.h);
                c.fill();
                c.stroke();
            } else if(o.type === "brush") {
                c.lineWidth = o.size;
                c.strokeStyle = o.stroke;
                c.lineCap = "round";
                c.lineJoin = "round";
                c.beginPath();
                c.moveTo(o.points[0].x, o.points[0].y);
                for(const pt of o.points) c.lineTo(pt.x, pt.y);
                c.stroke();
            } else if(o.type === "text") {
                const fontSize = parseInt(o.size) + 20;
                c.font = `900 ${fontSize}px Pretendard, sans-serif`;
                c.fillStyle = o.stroke;
                c.fillText(o.text, o.x, o.y);
            } else if(o.type === "stamp") {
                const s = parseInt(o.size);
                c.fillStyle = o.stroke;
                c.beginPath();
                if(o.shape === "circle") c.arc(o.x, o.y, s, 0, Math.PI*2);
                else if(o.shape === "square") c.rect(o.x-s, o.y-s, s*2, s*2);
                else if(o.shape === "triangle") {
                    c.moveTo(o.x, o.y-s);
                    c.lineTo(o.x+s, o.y+s);
                    c.lineTo(o.x-s, o.y+s);
                    c.closePath();
                } else if(o.shape === "star") {
                    let rot = Math.PI/2*3, step = Math.PI/5, outer=s, inner=s/2;
                    c.moveTo(o.x, o.y-outer);
                    for(let i=0;i<5;i++) {
                        c.lineTo(o.x+Math.cos(rot)*outer, o.y+Math.sin(rot)*outer); rot+=step;
                        c.lineTo(o.x+Math.cos(rot)*inner, o.y+Math.sin(rot)*inner); rot+=step;
                    }
                    c.lineTo(o.x, o.y-outer);
                    c.closePath();
                }
                c.fill();
            }
        }
        
        function redraw() {
            const p = pages[currentIndex];
            if(!p) return;
            Ctx.setTransform(1,0,0,1,0,0);
            Ctx.clearRect(0,0,Canvas.width, Canvas.height);
            Ctx.setTransform(camera.scale, 0, 0, camera.scale, camera.x, camera.y);
            Ctx.drawImage(p.bgImage, 0, 0, p.bgW, p.bgH);
            for(const o of p.objects) drawSingle(Ctx, o);
            if(currentObj) drawSingle(Ctx, currentObj);
        }
        
        function setTool(t) {
            currentTool = t;
            $$(".dmm2-tool", Overlay).forEach(b => b.classList.remove("dmm2-active"));
            const btn = $(`#dmm2Tool${t.charAt(0).toUpperCase() + t.slice(1)}`);
            if(btn) btn.classList.add("dmm2-active");
            const StampRow = $("#dmm2StampRow");
            if(t === "stamp") StampRow.classList.add("dmm2-show");
            else StampRow.classList.remove("dmm2-show");
            if(t === "brush") $("#dmm2Size").value = 5;
            else if(t === "stamp") $("#dmm2Size").value = 15;
            else if(t === "rect") $("#dmm2Size").value = 30;
            else if(t === "text") $("#dmm2Size").value = 30;
            Canvas.style.cursor = (t === "hand") ? "grab" : "crosshair";
        }
        
        function setColor(name) {
            if(name==="blue"){ currentStroke="#31a3fa"; currentColorFill="rgba(49,163,250,0.3)"; }
            if(name==="red"){ currentStroke="#ef4444"; currentColorFill="rgba(239,68,68,0.3)"; }
            if(name==="green"){ currentStroke="#22c55e"; currentColorFill="rgba(34,197,94,0.3)"; }
            if(name==="orange"){ currentStroke="#f97316"; currentColorFill="rgba(249,115,22,0.3)"; }
            if(name==="purple"){ currentStroke="#a855f7"; currentColorFill="rgba(168,85,247,0.3)"; }
            if(name==="gray"){ currentStroke="#64748b"; currentColorFill="rgba(100,116,139,0.3)"; }
            $$(".dmm2-color", $("#dmm2Palette")).forEach(b => b.classList.remove("dmm2-active"));
            const b = $("#dmm2Palette").querySelector(`[data-c="${name}"]`);
            if(b) b.classList.add("dmm2-active");
        }
        
        function setStamp(shape) {
            currentStamp = shape;
            $$(".dmm2-tool", $("#dmm2StampRow")).forEach(b => b.classList.remove("dmm2-active"));
            const b = $("#dmm2StampRow").querySelector(`[data-stamp="${shape}"]`);
            if(b) b.classList.add("dmm2-active");
        }
        
        async function importFiles(fileList) {
            if(!fileList || fileList.length===0) return;
            showLoading("파일 분석 중...");
            try {
                const newPages = [];
                for(const file of fileList) {
                    if(file.type === "application/pdf" || file.name.toLowerCase().endsWith(".pdf")) {
                        if (!window.pdfjsLib) {
                            showToast("PDF 라이브러리를 로드할 수 없습니다.");
                            continue;
                        }
                        // PDF.js 워커 중복 설정 방지
                        if (!window.pdfjsLib.GlobalWorkerOptions.workerSrc) {
                            window.pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
                        }
                        showLoading(`PDF 변환 중... (${file.name})`);
                        const buf = await new Promise((resolve, reject) => {
                            const r = new FileReader();
                            r.onload = () => resolve(r.result);
                            r.onerror = reject;
                            r.readAsArrayBuffer(file);
                        });
                        const pdf = await pdfjsLib.getDocument({ data: buf }).promise;
                        const numPages = pdf.numPages;
                        for(let i=1; i<=numPages; i++) {
                            showLoading(`PDF 페이지 렌더링 ${i}/${numPages}`);
                            const page = await pdf.getPage(i);
                            const viewport1 = page.getViewport({ scale: 1 });
                            const targetW = 1800;
                            const scale = Math.max(1.2, Math.min(2.4, targetW / viewport1.width));
                            const viewport = page.getViewport({ scale });
                            const c = document.createElement("canvas");
                            c.width = Math.floor(viewport.width);
                            c.height = Math.floor(viewport.height);
                            const cx = c.getContext("2d", { alpha: false });
                            await page.render({ canvasContext: cx, viewport }).promise;
                            const dataUrl = c.toDataURL("image/jpeg", 0.92);
                            const img = await new Promise((resolve, reject) => {
                                const i = new Image();
                                i.onload = () => resolve(i);
                                i.onerror = reject;
                                i.src = dataUrl;
                            });
                            newPages.push({
                                id: Math.random().toString(36).slice(2, 10) + "-" + Date.now().toString(36),
                                name: file.name.replace(/\.pdf$/i,"") || "PDF",
                                type: "pdfpage",
                                bgImage: img,
                                bgW: img.width,
                                bgH: img.height,
                                thumbUrl: dataUrl,
                                objects: [],
                                camera: null,
                                dirty: false,
                            });
                        }
                    } else if(file.type.startsWith("image/")) {
                        showLoading(`이미지 로딩 중... (${file.name})`);
                        const dataUrl = await new Promise((resolve, reject) => {
                            const r = new FileReader();
                            r.onload = () => resolve(r.result);
                            r.onerror = reject;
                            r.readAsDataURL(file);
                        });
                        const img = await new Promise((resolve, reject) => {
                            const i = new Image();
                            i.onload = () => resolve(i);
                            i.onerror = reject;
                            i.src = dataUrl;
                        });
                        newPages.push({
                            id: Math.random().toString(36).slice(2, 10) + "-" + Date.now().toString(36),
                            name: file.name || "IMAGE",
                            type: "image",
                            bgImage: img,
                            bgW: img.width,
                            bgH: img.height,
                            thumbUrl: dataUrl,
                            objects: [],
                            camera: null,
                            dirty: false,
                        });
                    }
                }
                if(newPages.length === 0) {
                    alert("지원되는 파일이 없습니다. (이미지 또는 PDF)");
                    close();
                    return;
                }
                pages = newPages;
                currentIndex = 0;
                open();
                renderPagesBar();
                switchPage(currentIndex);
                fitToScreen();
                showToast("업로드");
            } finally {
                hideLoading();
            }
        }
        
        function renderPagesBar() {
            if (!PagesBar) return;
            PagesBar.innerHTML = "";
            pages.forEach((p, idx) => {
                const card = document.createElement("div");
                card.className = "dmm2-page" + (idx === currentIndex ? " dmm2-active" : "") + (p.dirty ? " dmm2-dirty" : "");
                card.dataset.pageId = p.id;
                card.innerHTML = `
                    <button class="dmm2-pdel" title="페이지 삭제"><i data-lucide="x" width="16"></i></button>
                    <img class="dmm2-thumb" src="${p.thumbUrl || ""}" alt="page ${idx+1}">
                    <div class="dmm2-pmeta">
                        <div class="dmm2-pnum">${idx+1}</div>
                        <div class="dmm2-pdirty" title="수정됨"></div>
                    </div>
                `;
                card.addEventListener("click", (e) => {
                    if(e.target.closest(".dmm2-pdel")) return;
                    switchPage(idx);
                });
                const delBtn = card.querySelector(".dmm2-pdel");
                delBtn.addEventListener("click", (e) => {
                    e.stopPropagation();
                    if(confirm(`페이지 ${idx+1}를 삭제할까요?`)) {
                        pages.splice(idx, 1);
                        if(pages.length === 0) { close(); return; }
                        currentIndex = Math.max(0, Math.min(currentIndex, pages.length-1));
                        renderPagesBar();
                        switchPage(currentIndex);
                    }
                });
                PagesBar.appendChild(card);
            });
            const add = document.createElement("button");
            add.type = "button";
            add.className = "dmm2-addpage";
            add.innerHTML = `<i data-lucide="plus" width="20"></i><span>추가</span>`;
            add.addEventListener("click", () => FileInput.click());
            PagesBar.appendChild(add);
            if(window.lucide) lucide.createIcons();
            updateHeader();
        }
        
        function updateHeader() {
            const TitleEl = $("#dmm2Title");
            const PageInfoEl = $("#dmm2PageInfo");
            if (!TitleEl || !PageInfoEl) return;
            const p = pages[currentIndex];
            const total = pages.length;
            PageInfoEl.textContent = total ? `(${currentIndex+1}/${total})` : "";
            TitleEl.textContent = p?.name ? `도면 마킹` : "도면 마킹";
        }
        
        function switchPage(idx) {
            if(idx < 0 || idx >= pages.length) return;
            const cur = pages[currentIndex];
            if(cur) cur.camera = { ...camera };
            currentIndex = idx;
            const p = pages[currentIndex];
            camera = p.camera ? { ...p.camera } : { x:0, y:0, scale:1 };
            $$(".dmm2-page", PagesBar).forEach(el => el.classList.remove("dmm2-active"));
            const card = PagesBar.querySelector(`[data-page-id="${p.id}"]`);
            if(card) card.classList.add("dmm2-active");
            updateHeader();
            redraw();
            showToast(`페이지 ${idx+1}`);
        }
        
        function open() {
            if(isOpen) return;
            isOpen = true;
            if (Root) Root.setAttribute("aria-hidden","false");
            if (Overlay) Overlay.classList.add("dmm2-active");
            document.documentElement.style.overflow = "hidden";
            document.body.style.overflow = "hidden";
            setCanvasSize();
            setTool(currentTool);
            setColor("blue");
            setStamp("circle");
            if(window.lucide) lucide.createIcons();
        }
        
        function close() {
            if(!isOpen) return;
            const dirtyAny = pages.some(p => p.dirty);
            if(dirtyAny && !confirm("저장하지 않은 마킹이 있습니다. 닫을까요?")) return;
            isOpen = false;
            if (Overlay) Overlay.classList.remove("dmm2-active");
            document.documentElement.style.overflow = "";
            document.body.style.overflow = "";
            if (Root) Root.setAttribute("aria-hidden","true");
        }
        
        function openFilePicker() {
            if (FileInput) FileInput.click();
        }
        
        // 이벤트 바인딩
        if (FileInput) {
            FileInput.addEventListener("change", async (e) => {
                const files = Array.from(e.target.files || []);
                e.target.value = "";
                await importFiles(files);
            });
        }
        
        function pointerPosFromEvent(e) {
            if (!Canvas) return { x: 0, y: 0 };
            const r = Canvas.getBoundingClientRect();
            return { x: e.clientX - r.left, y: e.clientY - r.top };
        }
        
        // ========= 히트 테스트 함수 (지우개 기능용) =========
        function isHit(o, mx, my) {
            const pad = 15;
            if(o.type === "rect") {
                return mx >= o.x-pad && mx <= o.x+o.w+pad && my >= o.y-pad && my <= o.y+o.h+pad;
            }
            if(o.type === "stamp") {
                const s = parseInt(o.size)+pad;
                return mx>=o.x-s && mx<=o.x+s && my>=o.y-s && my<=o.y+s;
            }
            if(o.type === "text") {
                Ctx.font = `900 ${parseInt(o.size)+20}px Pretendard, sans-serif`;
                const w = Ctx.measureText(o.text).width;
                const h = parseInt(o.size)+20;
                return mx>=o.x && mx<=o.x+w && my>=o.y-h && my<=o.y+(h*0.3);
            }
            if(o.type === "brush") {
                for(const pt of o.points) {
                    if(Math.hypot(mx-pt.x, my-pt.y) < 20) return true;
                }
                return false;
            }
            return false;
        }
        
        function onPointerDown(e) {
            if (!pages[currentIndex]) return;
            e.preventDefault();
            if (Canvas) Canvas.setPointerCapture(e.pointerId);
            const pos = pointerPosFromEvent(e);
            pointers.set(e.pointerId, pos);
            
            if(pointers.size === 2) {
                isPinching = true;
                const pts = Array.from(pointers.values());
                pinchStartDist = Math.hypot(pts[0].x-pts[1].x, pts[0].y-pts[1].y);
                pinchStartCamera = { ...camera };
                return;
            }
            
            isDown = true;
            const wp = toWorld(pos.x, pos.y);
            const size = parseInt($("#dmm2Size")?.value || 30, 10);
            const p = pages[currentIndex];
            
            if(currentTool === "eraser") {
                let found = null;
                for(let i=p.objects.length-1;i>=0;i--) {
                    if(isHit(p.objects[i], wp.x, wp.y)) {
                        found = p.objects[i];
                        break;
                    }
                }
                if(found) {
                    p.objects = p.objects.filter(o => o !== found);
                    p.dirty = true;
                    redraw();
                }
                isDown = false;
                return;
            }
            
            if(currentTool === "text") {
                setTimeout(() => {
                    const t = prompt("입력할 텍스트:");
                    if(t) {
                        p.objects.push({ type:"text", x:wp.x, y:wp.y, text:t, stroke: currentStroke, size });
                        p.dirty = true;
                        redraw();
                    }
                }, 80);
                isDown = false;
                return;
            }
            
            if(currentTool === "hand") {
                panLast = { ...pos };
                return;
            }
            
            if(currentTool === "stamp") {
                return;
            }
            
            if(currentTool === "rect") {
                currentObj = { type:"rect", x:wp.x, y:wp.y, w:0, h:0, stroke: currentStroke, fill: currentColorFill, size };
            } else if(currentTool === "brush") {
                currentObj = { type:"brush", points:[{x:wp.x,y:wp.y}], stroke: currentStroke, size };
            }
        }
        
        function onPointerMove(e) {
            if(!pages[currentIndex]) return;
            if(!pointers.has(e.pointerId)) return;
            const pos = pointerPosFromEvent(e);
            pointers.set(e.pointerId, pos);
            
            if(isPinching && pointers.size === 2) {
                e.preventDefault();
                const pts = Array.from(pointers.values());
                const dist = Math.hypot(pts[0].x-pts[1].x, pts[0].y-pts[1].y);
                const scaleFactor = dist / pinchStartDist;
                const newScale = Math.max(0.1, Math.min(6, pinchStartCamera.scale * scaleFactor));
                const cx = (pts[0].x + pts[1].x) / 2;
                const cy = (pts[0].y + pts[1].y) / 2;
                camera.x = cx - (cx - pinchStartCamera.x) * (newScale / pinchStartCamera.scale);
                camera.y = cy - (cy - pinchStartCamera.y) * (newScale / pinchStartCamera.scale);
                camera.scale = newScale;
                pages[currentIndex].camera = { ...camera };
                redraw();
                return;
            }
            
            if(!isDown) return;
            e.preventDefault();
            const wp = toWorld(pos.x, pos.y);
            const p = pages[currentIndex];
            
            if(currentTool === "hand") {
                camera.x += (pos.x - panLast.x);
                camera.y += (pos.y - panLast.y);
                panLast = { ...pos };
                p.camera = { ...camera };
                redraw();
                return;
            }
            
            if(currentTool === "rect" && currentObj) {
                currentObj.w = wp.x - currentObj.x;
                currentObj.h = wp.y - currentObj.y;
                redraw();
            } else if(currentTool === "brush" && currentObj) {
                currentObj.points.push({ x: wp.x, y: wp.y });
                redraw();
            }
        }
        
        function onPointerUp(e) {
            if(!pages[currentIndex]) return;
            const pos = pointerPosFromEvent(e);
            pointers.delete(e.pointerId);
            
            if(pointers.size < 2) {
                isPinching = false;
            }
            
            if(currentTool === "stamp") {
                if(Math.hypot(pos.x - (pointers.values().next().value?.x || pos.x), pos.y - (pointers.values().next().value?.y || pos.y)) < 10) {
                    const wp = toWorld(pos.x, pos.y);
                    const size = parseInt($("#dmm2Size")?.value || 15, 10);
                    const p = pages[currentIndex];
                    p.objects.push({ type:"stamp", x:wp.x, y:wp.y, shape: currentStamp, stroke: currentStroke, size });
                    p.dirty = true;
                    redraw();
                }
            }
            
            if(isDown && currentObj) {
                const p = pages[currentIndex];
                if(currentObj.type === "rect") {
                    if(currentObj.w < 0) { currentObj.x += currentObj.w; currentObj.w = Math.abs(currentObj.w); }
                    if(currentObj.h < 0) { currentObj.y += currentObj.h; currentObj.h = Math.abs(currentObj.h); }
                    if(currentObj.w > 5 || currentObj.h > 5) {
                        p.objects.push(currentObj);
                        p.dirty = true;
                    }
                } else {
                    p.objects.push(currentObj);
                    p.dirty = true;
                }
                currentObj = null;
                redraw();
            }
            
            isDown = false;
            const p = pages[currentIndex];
            if(p) p.camera = { ...camera };
        }
        
        function onWheel(e) {
            if(!pages[currentIndex]) return;
            e.preventDefault();
            const zoomFactor = Math.exp(-e.deltaY * 0.001);
            const newScale = Math.max(0.1, Math.min(8, camera.scale * zoomFactor));
            const rect = Canvas.getBoundingClientRect();
            const mx = e.clientX - rect.left;
            const my = e.clientY - rect.top;
            camera.x = mx - (mx - camera.x) * (newScale / camera.scale);
            camera.y = my - (my - camera.y) * (newScale / camera.scale);
            camera.scale = newScale;
            pages[currentIndex].camera = { ...camera };
            redraw();
        }
        
        function undo() {
            const p = pages[currentIndex];
            if(!p || p.objects.length===0) return;
            p.objects.pop();
            p.dirty = true;
            redraw();
        }
        
        function clearAll() {
            const p = pages[currentIndex];
            if(!p) return;
            if(!confirm("현재 페이지 마킹을 모두 지울까요?")) return;
            p.objects = [];
            p.dirty = true;
            redraw();
            showToast("지움");
        }
        
        function saveCurrentToDataURL() {
            const p = pages[currentIndex];
            if(!p) return null;
            const t = document.createElement("canvas");
            t.width = p.bgW;
            t.height = p.bgH;
            const tx = t.getContext("2d", { alpha:false });
            tx.drawImage(p.bgImage, 0, 0, p.bgW, p.bgH);
            for(const o of p.objects) drawSingle(tx, o);
            return t.toDataURL("image/png");
        }
        
        // 이벤트 바인딩
        if (FileInput) {
            FileInput.addEventListener("change", async (e) => {
                const files = Array.from(e.target.files || []);
                e.target.value = "";
                await importFiles(files);
            });
        }
        
        if ($("#dmm2CloseBtn")) {
            $("#dmm2CloseBtn").addEventListener("click", () => close());
        }
        
        if ($("#dmm2UndoBtn")) {
            $("#dmm2UndoBtn").addEventListener("click", undo);
        }
        
        if ($("#dmm2ClearBtn")) {
            $("#dmm2ClearBtn").addEventListener("click", clearAll);
        }
        
        if ($("#dmm2FitBtn")) {
            $("#dmm2FitBtn").addEventListener("click", () => {
                fitToScreen();
                showToast("맞춤");
            });
        }
        
        /* [비활성화] 중복 저장(기기 다운로드) 핸들러 제거 - 서버/워크로그 저장만 사용
if ($("#dmm2SaveBtn")) {
            $("#dmm2SaveBtn").addEventListener("click", () => {
                const dataUrl = saveCurrentToDataURL();
                if(dataUrl) {
                    const a = document.createElement("a");
                    a.href = dataUrl;
                    a.download = `marked-page-${currentIndex+1}.png`;
                    document.body.appendChild(a);
                    a.click();
                    a.remove();
                    pages[currentIndex].dirty = false;
                    showToast("저장");
                }
            });
        }
*/
        
        // 미리보기 기능 (미리보기창.html 스타일)
        const PreviewModal = {
            zoomLevel: 1,
            isPanning: false,
            pointX: 0, pointY: 0,
            startX: 0, startY: 0,
            overlay: null, wrapper: null, viewport: null, panBtn: null, titleEl: null,
            
            init() {
                this.overlay = $("#dmm2PmOverlay");
                this.wrapper = $("#dmm2PmContent");
                this.viewport = $("#dmm2PmViewport");
                this.panBtn = $("#dmm2PmPanBtn");
                this.titleEl = $("#dmm2PmTitle");
                this.setupEvents();
            },
            
            open(title, contentHTML) {
                if (!this.overlay) this.init();
                this.titleEl.textContent = title || "미리보기";
                this.wrapper.innerHTML = contentHTML;
                this.resetView();
                this.overlay.classList.add("dmm2-pm-active");
                document.documentElement.style.overflow = "hidden";
                document.body.style.overflow = "hidden";
                if(window.lucide) lucide.createIcons();
            },
            
            close() {
                if(this.overlay) {
                    this.overlay.classList.remove("dmm2-pm-active");
                    document.documentElement.style.overflow = "";
                    document.body.style.overflow = "";
                }
                this.isPanning = false;
                if(this.panBtn) this.panBtn.classList.remove("dmm2-pm-active");
                if(this.viewport) this.viewport.classList.remove("dmm2-pm-panning");
            },
            
            zoom(delta) {
                this.zoomLevel = Math.max(0.2, this.zoomLevel + delta);
                this.updateTransform();
            },
            
            resetView() {
                const screenW = window.innerWidth;
                this.zoomLevel = screenW < 800 ? screenW / 850 : 0.7;
                this.pointX = 0; this.pointY = 0;
                this.updateTransform();
            },
            
            togglePan() {
                this.isPanning = !this.isPanning;
                if(this.panBtn) this.panBtn.classList.toggle("dmm2-pm-active", this.isPanning);
                if(this.viewport) this.viewport.classList.toggle("dmm2-pm-panning", this.isPanning);
            },
            
            updateTransform() {
                if(this.wrapper) {
                    this.wrapper.style.transform = `translate(${this.pointX}px, ${this.pointY}px) scale(${this.zoomLevel})`;
                }
            },
            
            setupEvents() {
                const start = (e) => {
                    if (!this.isPanning) return;
                    if (e.target.closest(".dmm2-pm-controls") || ['BUTTON'].includes(e.target.tagName)) return;
                    e.preventDefault();
                    const evt = e.touches ? e.touches[0] : e;
                    this.startX = evt.clientX - this.pointX;
                    this.startY = evt.clientY - this.pointY;
                    document.addEventListener('mousemove', move);
                    document.addEventListener('touchmove', move, {passive:false});
                    document.addEventListener('mouseup', end);
                    document.addEventListener('touchend', end);
                };
                const move = (e) => {
                    const evt = e.touches ? e.touches[0] : e;
                    this.pointX = evt.clientX - this.startX;
                    this.pointY = evt.clientY - this.startY;
                    this.updateTransform();
                };
                const end = () => {
                    document.removeEventListener('mousemove', move);
                    document.removeEventListener('touchmove', move);
                    document.removeEventListener('mouseup', end);
                    document.removeEventListener('touchend', end);
                };
                if(this.viewport) {
                    this.viewport.addEventListener('mousedown', start);
                    this.viewport.addEventListener('touchstart', start, {passive:false});
                }
            },
            
            async savePDF() {
                this.showLoading(true);
                const fileName = this.titleEl.textContent || 'download';
                const oldTransform = this.wrapper.style.transform;
                this.wrapper.style.transform = 'scale(1)';
                this.wrapper.style.margin = '0';
                try {
                    if(!window.html2canvas || !window.jspdf) {
                        alert("PDF 저장 기능을 사용할 수 없습니다.");
                        return;
                    }
                    const canvas = await html2canvas(this.wrapper, { scale: 2, useCORS: true, backgroundColor: "#ffffff" });
                    const imgData = canvas.toDataURL('image/jpeg', 0.9);
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF('p', 'mm', 'a4');
                    const imgProps = doc.getImageProperties(imgData);
                    const pdfWidth = doc.internal.pageSize.getWidth();
                    const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
                    doc.addImage(imgData, 'JPEG', 0, 0, pdfWidth, pdfHeight);
                    doc.save(`${fileName}.pdf`);
                    
                    // 데이터 연동 저장 (워크로그에 저장)
                    try {
                        const siteSelect = document.getElementById('siteSelect');
                        const siteValue = siteSelect ? siteSelect.value : '';
                        const siteName = siteSelect ? siteSelect.options[siteSelect.selectedIndex].text : '';
                        const dateEl = document.getElementById('input-date');
            const inputDate = dateEl ? dateEl.value : (new Date().toISOString().slice(0,10));
                        
                        // 현재 페이지의 마킹 데이터 가져오기
                        const p = pages[currentIndex];
                        if (p) {
                            const worklogData = {
                                site: siteValue,
                                siteName: siteName,
                                date: inputDate,
                                type: 'drawing-marking-preview',
                                drawing: {
                                    name: p.name || fileName,
                                    dataUrl: imgData,
                                    timestamp: new Date().toISOString()
                                },
                                timestamp: new Date().toISOString()
                            };
                            
                            // 로컬 스토리지에 저장 (실제로는 서버 API 호출)
                            const existingLogs = JSON.parse(localStorage.getItem('worklog_drawings') || '[]');
                            existingLogs.push(worklogData);
                            localStorage.setItem('worklog_drawings', JSON.stringify(existingLogs));
                            
                            // 요약 카드의 도면 업로드 건수 증가
                            const el = document.getElementById('sum-drawings');
                            if (el) {
                                const cur = parseInt(el.innerText) || 0;
                                el.innerText = (cur + 1) + '건';
                            }
                            
                            console.log('도면이 워크로그에 저장되었습니다:', worklogData);
                        }
                    } catch (error) {
                        console.error('워크로그 저장 오류:', error);
                    }
                    
                    this.showToast("PDF 저장이 완료되었습니다.");
                } catch (e) {
                    console.error(e);
                    alert("저장 중 오류가 발생했습니다.");
                } finally {
                    this.wrapper.style.transform = oldTransform;
                    this.showLoading(false);
                }
            },
            
            async share() {
                if (!navigator.share) {
                    alert("공유를 지원하지 않는 환경입니다.");
                    return;
                }
                this.showLoading(true);
                const oldTransform = this.wrapper.style.transform;
                this.wrapper.style.transform = 'scale(1)';
                try {
                    if(!window.html2canvas) {
                        alert("공유 기능을 사용할 수 없습니다.");
                        return;
                    }
                    const canvas = await html2canvas(this.wrapper, { scale: 2, useCORS: true });
                    canvas.toBlob(async (blob) => {
                        const file = new File([blob], "share.jpg", { type: "image/jpeg" });
                        try {
                            await navigator.share({
                                title: this.titleEl.textContent,
                                files: [file]
                            });
                        } catch (err) {}
                    }, 'image/jpeg', 0.9);
                } catch (e) {
                    alert("이미지 생성 실패");
                } finally {
                    this.wrapper.style.transform = oldTransform;
                    this.showLoading(false);
                }
            },
            
            showLoading(visible) {
                const el = $("#dmm2PmLoading");
                if(el) el.style.display = visible ? 'flex' : 'none';
            },
            
            showToast(msg) {
                const t = $("#dmm2PmToast");
                const msgEl = $("#dmm2PmToastMsg");
                if(msgEl) msgEl.textContent = msg;
                if(t) {
                    t.classList.add('dmm2-pm-show');
                    setTimeout(() => t.classList.remove('dmm2-pm-show'), 2000);
                }
            }
        };
        
        function openPreview() {
            const p = pages[currentIndex];
            if(!p) return;
            const dataUrl = saveCurrentToDataURL();
            if(!dataUrl) return;
            const title = p.name ? `도면 마킹 - ${p.name}` : "도면 마킹";
            PreviewModal.open(title, `<img src="${dataUrl}" class="dmm2-pm-img-view" alt="미리보기">`);
        }
        
        if ($("#dmm2PreviewBtn")) {
            $("#dmm2PreviewBtn").addEventListener("click", openPreview);
        }
        
        if ($("#dmm2PmCloseBtn")) {
            $("#dmm2PmCloseBtn").addEventListener("click", () => PreviewModal.close());
        }
        
        if ($("#dmm2PmZoomOutBtn")) {
            $("#dmm2PmZoomOutBtn").addEventListener("click", () => PreviewModal.zoom(-0.1));
        }
        
        if ($("#dmm2PmZoomInBtn")) {
            $("#dmm2PmZoomInBtn").addEventListener("click", () => PreviewModal.zoom(0.1));
        }
        
        if ($("#dmm2PmPanBtn")) {
            $("#dmm2PmPanBtn").addEventListener("click", () => PreviewModal.togglePan());
        }
        
        if ($("#dmm2PmSaveBtn")) {
            $("#dmm2PmSaveBtn").addEventListener("click", () => PreviewModal.savePDF());
        }
        
        if ($("#dmm2PmShareBtn")) {
            $("#dmm2PmShareBtn").addEventListener("click", () => PreviewModal.share());
        }
        
        // 도구 버튼 이벤트
        const toolIds = { hand: "Hand", rect: "Rect", brush: "Brush", stamp: "Stamp", text: "Text", eraser: "Eraser" };
        Object.keys(toolIds).forEach(t => {
            const btn = $(`#dmm2Tool${toolIds[t]}`);
            if(btn) btn.addEventListener("click", () => setTool(t));
        });
        
        // 색상 버튼 이벤트
        $$(".dmm2-color", $("#dmm2Palette")).forEach(btn => {
            btn.addEventListener("click", () => setColor(btn.dataset.c));
        });
        
        // 도장 버튼 이벤트
        $$(".dmm2-tool", $("#dmm2StampRow")).forEach(btn => {
            btn.addEventListener("click", () => setStamp(btn.dataset.stamp));
        });
        
        // 캔버스 이벤트 (open 시에만 바인딩)
        function bindCanvasEvents() {
            if (!Canvas) return;
            Canvas.addEventListener("pointerdown", onPointerDown, { passive:false });
            Canvas.addEventListener("pointermove", onPointerMove, { passive:false });
            Canvas.addEventListener("pointerup", onPointerUp, { passive:false });
            Canvas.addEventListener("pointercancel", onPointerUp, { passive:false });
            Canvas.addEventListener("wheel", onWheel, { passive:false });
        }
        
        function unbindCanvasEvents() {
            if (!Canvas) return;
            Canvas.removeEventListener("pointerdown", onPointerDown);
            Canvas.removeEventListener("pointermove", onPointerMove);
            Canvas.removeEventListener("pointerup", onPointerUp);
            Canvas.removeEventListener("pointercancel", onPointerUp);
            Canvas.removeEventListener("wheel", onWheel);
        }
        
        const originalOpen = open;
        open = function() {
            originalOpen();
            bindCanvasEvents();
        };
        
        const originalClose = close;
        close = function() {
            unbindCanvasEvents();
            originalClose();
        };
        
        // openWith 메서드 추가 (도면마킹.html 호환)
        async function openWith(filesOrUrls) {
            if(!filesOrUrls) return;
            if(Array.isArray(filesOrUrls) && typeof filesOrUrls[0] === "string"){
                showLoading("이미지 로딩 중...");
                try{
                    const newPages = [];
                    for(const url of filesOrUrls){
                        const img = await new Promise((resolve, reject) => {
                            const i = new Image();
                            i.onload = () => resolve(i);
                            i.onerror = reject;
                            i.src = url;
                        });
                        newPages.push({
                            id: Math.random().toString(36).slice(2, 10) + "-" + Date.now().toString(36),
                            name: (url.split("/").pop() || "IMAGE"),
                            type: "imageUrl",
                            bgImage: img,
                            bgW: img.width,
                            bgH: img.height,
                            thumbUrl: url,
                            objects: [],
                            camera: null,
                            dirty: false,
                        });
                    }
                    pages = newPages;
                    currentIndex = 0;
                    open();
                    renderPagesBar();
                    switchPage(0);
                    fitToScreen();
                } finally { hideLoading(); }
            } else {
                await importFiles(Array.from(filesOrUrls), false);
            }
        }
        
        // onSave 콜백 등록
        let onSaveCb = null;
        function setOnSave(cb) {
            onSaveCb = cb;
        }
        
        // 저장 버튼 클릭 시 콜백 호출 및 데이터 연동 저장
        if ($("#dmm2SaveBtn")) {
            $("#dmm2SaveBtn").addEventListener("click", async () => {
                try {
                    // [변경됨] 기기 다운로드 로직 제거, 서버(워크로그) 저장 로직만 수행

                    // 1. 모든 페이지 데이터 생성 (서버 전송용)
                    const allPages = [];
                    for (let i = 0; i < pages.length; i++) {
                        const p = pages[i];
                        const tempCanvas = document.createElement("canvas");
                        tempCanvas.width = p.bgW;
                        tempCanvas.height = p.bgH;
                        const tempCtx = tempCanvas.getContext("2d", { alpha: false });
                        tempCtx.drawImage(p.bgImage, 0, 0, p.bgW, p.bgH);
                        for(const o of p.objects) drawSingle(tempCtx, o);
                        allPages.push({
                            name: p.name || `page-${i+1}`,
                            dataUrl: tempCanvas.toDataURL("image/png")
                        });
                    }

                    // 2. 데이터 연동 저장 (콜백 호출 -> 서버/워크로그 저장)
                    if (onSaveCb) {
                        try {
                            await onSaveCb({ pages: allPages, currentIndex });

                            // [추가] 저장이 완료되면 dirty 상태 해제 및 UI 갱신
                            if(pages[currentIndex]) {
                                pages[currentIndex].dirty = false;
                            }
                            renderPagesBar();

                            // [추가] 메인에서 통일된 토스트/카운트 갱신 처리(DMM2_SAVE) 트리거
                            try {
                                window.postMessage({ type: 'DMM2_SAVE', payload: { added: allPages.length } }, '*');
                            } catch (e) {}

                        } catch (error) {
                            console.error('저장 콜백 오류:', error);
                            showToast('저장 오류');
                            return;
                        }
                    } else {
                        // 콜백이 없는 경우(단독 실행 등) 안내
                        showToast('저장 설정이 없습니다.');
                    }

                } catch (error) {
                    console.error('저장 처리 오류:', error);
                    showToast('저장 처리 중 오류가 발생했습니다');
                }
            });
        }
        
        return {
            openFilePicker,
            open,
            close,
            openWith,
            onSave: setOnSave
        };
    })();
    
    // 전역 노출
    window.DMM2 = DrawingApp;

    // Init Logic
    window.addEventListener('message', function(event) {
        const data = event.data;
        if (!data || data.type !== 'DMM2_SAVE') return;
        const payload = data.payload || {};
        // 저장 완료 토스트
        showToast('도면 저장');
        // 요약 카드의 도면 업로드 건수 증가
        try {
            const el = document.getElementById('sum-drawings');
            if (el) {
                const cur = parseInt(el.innerText) || 0;
                const added = Array.isArray(payload.pages) ? payload.pages.length : 1;
                el.innerText = (cur + added) + '건';
            }
        } catch (e) {}
    });

    window.onload = function() {
        renderNotifications();
        // initNoticeSlider(); // 공지사항 박스 삭제로 인해 호출 제거
        addWorkSet();
        addManpowerRow({ presetWorker: (predefinedWorkers && predefinedWorkers[0]) ? predefinedWorkers[0] : '이현수', locked: true });
        
        // 빠른메뉴 업데이트 이벤트 효과 제어
        // 실제 서비스에서는 hasUpdate 값을 서버/데이터와 연동해서 설정
        const hasUpdate = { worklog: true, hqRequest: true, issue: true }; // 현재는 테스트를 위해 모두 true
        const qmItems = document.querySelectorAll('.quick-menu-section .qm-grid .qm-item');
        // 인덱스: 0=출력현황, 1=작업일지, 2=현장정보, 3=문서함, 4=본사요청, 5=지적사항
        if (!hasUpdate.worklog && qmItems[1]) qmItems[1].classList.remove('qm-item--event');
        if (!hasUpdate.hqRequest && qmItems[4]) qmItems[4].classList.remove('qm-item--event');
        if (!hasUpdate.issue && qmItems[5]) qmItems[5].classList.remove('qm-item--event');
        
        // 작업일자 오늘 날짜로 설정
        const dateInput = document.getElementById('input-date');
        if(dateInput) {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            dateInput.value = `${year}-${month}-${day}`;
            dateInput.addEventListener('change', function() {
                // 작업일자 선택 시 에러 효과 즉시 해제
                dateInput.classList.remove('error-shake');
                dateInput.style.borderColor = '';
                dateInput.style.boxShadow = '';
                
                if (dateInput.value) {
                    // 다음 단계로 이동: 공수 입력 영역으로 스크롤 및 강조
                    setTimeout(() => {
                        guideToNextStep('manpower-list', '투입인원(공수)를 확인해주세요', true);
                    }, 300);
                }
                
                updateSummaryData();
                checkRequiredFields();
            });
        }
        
        // 초기 권역에 맞는 현장 목록 로드
        filterSitesByRegion(currentRegion);
        
        // 현장 선택 시 소속 자동 입력 및 에러 효과 해제
        const siteSelect = document.getElementById('siteSelect');
        const selDept = document.getElementById('sel-dept');
        if (siteSelect && selDept) {
            siteSelect.addEventListener('change', function() {
                // 현장 선택 시 에러 효과 즉시 해제
                siteSelect.classList.remove('error-shake');
                siteSelect.style.borderColor = '';
                siteSelect.style.boxShadow = '';
                
                if (siteSelect.value) {
                    // 선택한 현장을 localStorage에 저장 (선택사항)
                    localStorage.setItem('lastSiteValue', siteSelect.value);
                    
                    // 다음 단계로 이동: 작업일자 필드로 스크롤 및 강조
                    setTimeout(() => {
                        guideToNextStep('input-date', '작업일자를 확인해주세요');
                    }, 300);
                }
                
                autoLinkDept();
                checkRequiredFields();
            });
        }
        
        // 필수 필드 변경 감지
        if(selDept) selDept.addEventListener('change', checkRequiredFields);
        
        // 작성 내용 요약 초기 상태: 접힌 상태
        const summaryBody = document.getElementById('summary-body');
        const summaryIcon = document.querySelector('.summary-card .arrow-icon');
        if (summaryBody && summaryIcon) {
            summaryBody.classList.add('collapsed');
            summaryIcon.classList.add('collapsed');
            summaryIcon.setAttribute('data-lucide', 'chevron-down');
        }
        
        // 초기 체크
        setTimeout(() => {
            updateSummaryData();
            checkRequiredFields();
            updateMaterialHint(); // 자재 사용 내역 안내문구 업데이트
        }, 100);
        
        // DMM2 도면마킹 툴은 이미 HTML에 포함되어 있음
        // DMM2 객체는 도면마킹.html 스크립트가 로드되면 자동으로 window.DMM2에 등록됨
        setTimeout(()=>{
            const badge = document.getElementById('notificationBadge');
            if(badge) badge.classList.remove('hidden');
        }, 800);
        
        // Lucide 아이콘 초기화
        if(window.lucide) {
            lucide.createIcons();
            // 빠른 메뉴 아이콘도 다시 렌더링
            setTimeout(() => lucide.createIcons(), 500);
        }
    };
  </script>
</body>
</html>
</html>