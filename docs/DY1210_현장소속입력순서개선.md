# DY1210 · 현장→소속 입력 순서 개선 분석

## 1. 개선 배경

- 배포 버전의 작업일지 작성 화면(모바일 `modules/mobile/components/home/HomePage.tsx`, 본사 관리자 `components/daily-reports/daily-report-form.tsx`)은 “소속 → 현장” 순으로 입력하도록 강제한다.
- 현장을 통해 본인 작업 위치를 먼저 알고 있는 작업자가 더 많고, 새로 합류한 인력은 본사에서 소속을 아직 확정하지 않은 경우도 있다. 지금처럼 소속을 먼저 선택하게 하면 **반드시 두 번 드롭다운을 조작**해야 하며, 소속을 모르는 사용자는 진입에서 멈춘다.
- 본사에서는 현장과 소속(시공사)을 매핑하고 있으므로, UI가 현장 선택만으로 소속을 자동 결정하도록 바꾸는 것이 UX/데이터 일관성 모두에 맞다.

## 2. 현재 UX 및 데이터 흐름

### 2.1 모바일 작업자/현장관리자 화면

- `DepartmentSelect` 컴포넌트가 `/api/mobile/organizations/list`에서 시공사 목록을 받아 첫 번째 드롭다운을 채운다. (ref: `modules/mobile/components/home/HomePage.tsx:890` 부근)
- 소속 선택 이후에만 `/api/mobile/sites/by-organization` 또는 `/api/mobile/sites/list`를 호출해 현장 목록을 채운다. (ref: `HomePage.tsx:584-676`)
- 임시 저장/프리필(`worklog_prefill`) 로직도 **1단계에서 소속을 세팅해 놓고** 2단계에서 현장을 로드한다. (ref: `HomePage.tsx:280-355`)
- 저장 시 유효성 검증: `department`가 비어 있으면 저장 자체가 막힌다. (ref: `HomePage.tsx:820` 인근)

### 2.2 본사 관리자 데스크탑 화면

- `components/daily-reports/daily-report-form.tsx`의 “현장 정보” 섹션에서 `partner_company_id`(소속) 선택이 우선이며, 선택값을 기준으로 `/api/sites/by-partner`를 호출해 현장 목록을 필터링한다. (ref: `daily-report-form.tsx:1354-1398`, `daily-report-form.tsx:520-590`)
- 초기값이 있는 수정 화면도 `partner_company_id` → `site_id` 순으로 의존한다. 기존 일지에서 `site_id`만 설정되어 있어도 `partner_company_id`가 비어 있으면 현장을 찾기 어렵다.
- 레거시 모달(`components/admin/legacy/daily-reports/DailyReportCreateModal.tsx`)은 현재 “현장만” 고르면 되지만, 개선 방향과 UI 통일성을 위해 함께 조정해야 한다.

### 2.3 데이터 레이어

- 모든 작업일지 payload(`types/worklog.ts`, `modules/mobile/services/work-log.service.ts`, `/api/admin/daily-reports`)는 `department` 또는 `partner_company_id`를 포함한다. 현재는 사용자 입력을 그대로 통과시키며, 사이트-소속 일관성 검증은 없다.
- `sites` 테이블에는 `organization_id`가 이미 존재하므로, **현장 선택 → 소속 자동 결정**이 가능하다.

## 3. 영향 범위 요약

- **UI/UX**
  - 모바일 홈(작업자/현장관리자) 메인 폼
  - 본사 관리자용 작업일지 생성/수정(신규 App Router 페이지 & legacy modal)
  - 관련 툴팁/도움말/검증 메세지
- **API & 데이터**
  - `/api/mobile/sites/list`, `/api/mobile/sites/by-organization`, `/api/sites/by-partner`
  - `DepartmentSelect` 사용 여부 및 대체 UI
  - `worklog_prefill` 저장 구조, `createWorklogMutation` 파라미터
  - Admin `daily-report-form`이 전송하는 `partner_company_id` 값
- **권한 및 RLS**
  - 현장 접근 제어는 그대로 유지되어야 하며, 자동으로 설정되는 소속이 권한 범위를 벗어나지 않도록 서버에서도 교차 검증 필요.
- **테스트 / QA**
  - e2e: 모바일 홈 진입, 현장 필터, 관리자 신규 작성
  - 유닛/컴포넌트: `DepartmentSelect`, 신규 사이트 선택 컴포넌트, prefill 로직

## 4. 구현 제안

### 4.1 데이터/APIs

1. **사이트 응답 스키마 확장**
   - `/api/mobile/sites/list`, `/api/mobile/sites/by-organization`, `/api/sites/by-partner` 모두 `organization_id` 뿐 아니라 `organization_name`(join)까지 내려주어 UI에서 즉시 표시 가능하도록 변경.
   - 소속 미존재 시 `null`과 `"소속사 미지정"` 라벨을 함께 반환해 사용자 혼란을 줄임.
2. **단일 사이트 조회 엔드포인트 추가**
   - 현장 ID에서 소속 정보를 역으로 가져올 수 있도록 `/api/mobile/sites/:id`(또는 공용 `/api/sites/:id`)를 추가. 프리필/상세 편집에서 유용.
3. **서버 측 검증**
   - `/api/admin/daily-reports`, `/api/mobile/daily-reports` 작성 시 `site_id` 기준으로 `organization_id`를 강제 세팅/검증하여 클라이언트 조작을 막는다.

### 4.2 모바일 (작업자/현장관리자)

1. **UI 재구성**
   - 현장 선택을 첫 번째 드롭다운으로 이동하고, `DepartmentSelect`는 읽기 전용 라벨(또는 `InfoBadge`)로 교체.
   - 현장 리스트는 “내가 접근 가능한 전체 현장 + 검색” 기준으로 보여주고, 선택 시 자동으로 소속 필드가 업데이트.
2. **상태/검증 로직 변경** (`HomePage.tsx`)
   - `selectedSite` 변경 시 `const matchedSite = sites.find(...); setDepartment(matchedSite?.organization_id ?? 'unassigned')`.
   - 저장 시 `department` 비어 있어도 `selectedSite`가 있으면 통과시키고, payload 빌드 시 `department || 'unassigned'`.
   - 프리필 로직: siteId만 있어도 로드 가능하도록 순서를 역전. (Stage1에서 siteId를 먼저 세팅하여 site fetch 트리거 → fetch 완료 후 department 자동 세팅.)
3. **신규 컴포넌트 제안**
   - `SiteSelect` (검색 + 최근 사용 + 권한 필터) 컴포넌트 도입으로 `HomePage` 코드 복잡도 감소.
4. **오류/예외 처리**
   - 소속 미지정 시 “소속사 미지정 · 본사에 문의” 상태표시.
   - 현장을 바꾸면 소속 표기가 즉시 교체되고 추가 입력 없이 저장 가능해야 함.

### 4.3 본사 관리자 (데스크탑)

1. **`daily-report-form.tsx` 재정렬**
   - “현장 선택”을 가장 먼저 배치하고, `partner_company_id` 필드는 읽기 전용 `Badge` 또는 disabled `Input`으로 표시.
   - 사이트 선택 시 `setFormData(prev => ({ ...prev, site_id: value, partner_company_id: site.organization_id ?? '' }))`.
2. **필터링 로직**
   - `filteredSites`는 기본적으로 전체 site 리스트(supplied via page props)에서 검색/정렬.
   - 선택된 파트너로 site를 필터하는 기존 UX는 보조 필터로 유지하되, 핵심 플로우는 site-first.
3. **수정 화면/통합뷰**
   - 조회/편집 시 `site_id`만 존재해도 소속이 자동 도출되도록 `useEffect` 추가.
   - 레거시 `DailyReportCreateModal`도 동일 동작(현장 선택 -> 소속 표시)으로 맞춰 사용자 혼선을 제거.
4. **검증/토스트**
   - 사이트가 선택되지 않은 경우만 에러 처리.
   - 소속이 미지정인 현장을 선택하면 “소속사 미지정” 라벨과 함께 관리자 주의 문구 노출.

### 4.4 공통 고려사항

- **Form Prefill & Draft 저장**: 로컬 스토리지/URL prefill 구조를 `siteId` 기반으로 단순화하고, department는 파생 값으로만 취급.
- **검색/필터 가이드**: 현장 리스트가 길어질 수 있으므로, 입력형 검색(`Combobox`) + 최근 사용 현장 5개 우선 노출 권장.
- **권한 체크**: 현장 접근 권한이 없는 사용자가 ID를 주입해도 서버에서 site→organization 매핑 실패 시 403/400을 반환하도록 강화.
- **미지정 현장 처리**: 본사에서 아직 소속을 연결하지 않은 현장은 “소속사 미지정” 상태로 표기하고, 저장은 허용하되 관리자 대시보드에서 리뷰하도록 태그 처리.

## 5. QA / 배포 체크리스트

1. **단위 테스트**
   - Site 선택 시 department 상태가 자동 변하는 hook/component 테스트.
   - Prefill 로직(임시저장 → 돌아왔을 때)에서 siteId만으로 복구되는지 검증.
2. **e2e / 수동 시나리오**
   - 모바일: 현장만 알고 있는 계정이 즉시 일지를 작성할 수 있는지, 소속 미지정 경고가 노출되는지.
   - 관리자: 기존 일지 편집 시 자동으로 소속이 채워지고 저장 가능한지.
3. **데이터 검증**
   - 실제 DB에 저장된 `daily_reports.department`/`organization_id`가 site와 일치하는지 샘플 점검.
4. **운영 커뮤니케이션**
   - 본사 관리자에게 “현장-소속 매핑이 선행되어야 자동 표시가 된다”는 점을 공지하고, 미매핑 현장을 정리하도록 안내.

> 위 계획을 기반으로 UI/데이터 일관성을 확보하면 사용자는 현장만 선택해도 되고, 본사도 소속-현장 매핑 정책을 더 확실히 enforcing 할 수 있다.
