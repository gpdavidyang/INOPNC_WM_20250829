# DY1119: 필수서류 관리 – 모바일 연동 개선 및 단일 소스 마이그레이션 계획

작성일: 2025-11-19  
대상 시스템: INOPNC Work Management (본사 관리자 + 모바일 문서함)

---

## 1. 배경 및 문제점

1. **이중 테이블 운용**
   - 모바일/현장 화면: `document_requirements` 테이블과 `/api/required-document-types`(사용자 전용) API를 사용.
   - 본사 관리자 화면: `required_document_types` + `/api/admin/required-document-types`를 사용.
2. **싱크 보증 장치 부재**
   - 두 테이블 간 동기화를 담당하는 트리거/잡이 없고, 필드 스키마도 다름(roles/site 매핑, sort_order 등).
   - 모바일 UI는 고정 8종 코드(`REQUIRED_LIST`)만 인식 → 신규 필수 서류 추가 시 업로드/연동 실패.
3. **워크플로우 분절**
   - 승인 시 `unified_document_system`만 갱신되고 `user_document_submissions`는 그대로 → 사용자 측 상태/알림 미연동.

결론: 데이터 소스 단일화 및 API 정립이 선행되어야 모바일 ‘내문서함’과 본사 ‘필수서류 관리’가 완전하게 동기화된다.

---

## 2. 목표

1. **단일 SSOT(Single Source of Truth)**: `required_document_types`를 기준 테이블로 확정하고, `document_requirements`는 단계적으로 제거.
2. **API 정비**: 사용자/관리자 API 모두 `required_document_types`와 `unified_document_system` 조합을 사용하도록 수정.
3. **모바일 UI 연동**: 고정 리스트를 제거하고, 서버에서 내려주는 요구사항 데이터로 카드가 구성되게 리팩터링.
4. **승인 상태 동기화**: 본사 승인 결과가 `user_document_submissions`를 통해 모바일에 반영되도록 액션 API 개선.

---

## 3. 현행 DB 비교 요약

| 항목        | `document_requirements`                                               | `required_document_types`                                   |
| ----------- | --------------------------------------------------------------------- | ----------------------------------------------------------- |
| 주요 소비처 | 모바일 `/api/required-document-types`, `/api/documents` 업로드        | 관리자 설정/필터, Admin Tab                                 |
| 필드        | requirement_name, document_type, is_mandatory, file_format_allowed 등 | code, name_ko/en, file_types, max_file_size, role/site 매핑 |
| FK/확장     | 없음                                                                  | `required_documents_by_role`, `site_required_documents`     |
| 문제        | 코드/ID가 모바일 하드코딩 값과 상이 가능, sort/order 미지정           | 모바일에서 사용 안 함, 일부 필드 부족(requirement_name 등)  |

### 3.1 제출 상태 체계 개선

| 상태         | 정의                                                   | 비고                               |
| ------------ | ------------------------------------------------------ | ---------------------------------- |
| **미제출**   | 작업자·현장관리자가 아직 업로드하지 않은 상태          | 기존 `대기` 문구를 `미제출`로 통일 |
| **검토중**   | 파일을 업로드했으나 본사 관리자 승인/반려 판정 전 단계 | 기존 `제출완료` 문구 제거          |
| **반려**     | 본사 관리자가 서류를 반려한 상태                       | 반려 사유를 함께 노출              |
| **승인완료** | 본사 관리자가 서류를 승인한 상태                       | 기존 `승인`과 동일 맥락            |

- 본사 관리자 화면과 현장관리자(모바일) 화면 모두 위 네 가지 상태만 사용한다.
- `대기`, `제출완료` 상태 코드는 UI에서 제거하고, 해당 값이 남아 있다면 `미제출`/`검토중`으로 매핑한다.
- DB와 API에서는 `submission_status` 값을 `not_submitted`/`pending`/`approved`/`rejected` 네 가지 Enum으로 통일한다.
- `user_document_submissions.submission_status` / `required_document_types` 응답 DTO에 동일한 Enum을 정의하고, badge 색상도 문서 전반에서 재사용한다.

---

## 4. 마이그레이션 전략 개요

### Phase 0. 사전 조사 (0.5일)

1. 두 테이블의 스키마/데이터 비교 스크립트 작성 (중복/누락 파악).
2. 운영 환경에서 두 테이블을 참조하는 API/컴포넌트 목록 확정 → 제거/수정 우선순위 산정.

### Phase 1. 단일 소스 구조 정의 (1일)

1. `required_document_types` 테이블에 누락 필드 추가
   - `requirement_name` 텍스트 (ko/en 별칭 통합)
   - `instructions`, `valid_duration_days` 등 `document_requirements` 필드 이관.
2. `document_requirements` → `required_document_types` 데이터 마이그레이션 SQL/스크립트 작성
   - code 매핑 기준: 기존 `document_type` 값; 중복 시 prefix 부여.
   - 레코드별로 role/site 매핑 기본값 생성.
3. 참조 무결성 확보
   - `user_document_submissions.requirement_id`가 새 테이블 PK를 바라보도록 업데이트.
   - `app/api/documents` 업로드 로직에서 requirement 조회 소스를 교체.

### Phase 2. API/서비스 교체 (1일)

1. `/api/required-document-types` → `required_document_types` 조회로 변경.
2. `/api/admin/document-requirements/*` route를 `/api/admin/required-document-types/*`로 리디렉션 후 기능 통합.
3. 모바일/웹에서 requirement 데이터를 호출하는 모든 위치의 DTO를 새 스키마에 맞춰 수정.

### Phase 3. 모바일 UI 리팩터링 (1일)

1. `REQUIRED_LIST` 상수 제거 → API 응답 기반 동적 렌더링.
2. 카드 ID=type.code를 사용하고, 업로드 시 requirementId 매핑.
3. 제출 상태 뱃지/반려 사유가 노출되도록 `user_document_submissions` 응답을 UI에 반영하고, 상태 라벨은 `미제출/검토중/반려/승인완료` 네 가지로 고정.

### Phase 4. 승인 워크플로우 동기화 (0.5일)

1. `/api/admin/required-docs/actions`에서 승인/반려 시
   - 대상 문서의 `required_document_type_id`(또는 코드) 확인
   - 해당 `user_document_submissions` 레코드 `submission_status`/`approved_at`/`rejection_reason` 업데이트.
2. 모바일 `MyDocsTab`에서 status badge, 알림 토스트 표시.

### Phase 5. 정리 및 제거 (0.5일)

1. 모든 의존성이 교체되면 `document_requirements` 테이블을 read-only로 전환 → 백업 후 drop.
2. 관련 스크립트/문서 업데이트(`docs/required-documents-implementation-*`).

총 소요: 약 4일 (QA 제외).

---

## 5. 작업 상세 체크리스트

1. **데이터 감사**
   - [x] `scripts/audit-required-docs.ts` 작성: 두 테이블 row count/코드 비교, user_document_submissions FK 유효성 확인.
2. **스키마 보강**
   - [x] `required_document_types`에 신규 컬럼 추가 (SQL Migration).
   - [x] role/site 매핑 default upsert.
3. **데이터 이관**
   - [x] `INSERT ... ON CONFLICT`로 document_requirements 데이터를 required_document_types에 병합.
   - [x] `user_document_submissions.requirement_id`를 새 PK로 업데이트 (FK constraint 추가).
4. **API 수정**
   - [x] `/api/required-document-types` 소스 변경.
   - [x] `/api/documents` 업로드 시 requirement 조회 테이블 교체.
   - [x] `/api/user-document-submissions` select 조인 대상 변경.
5. **UI/UX**
   - [x] 모바일 내문서함 카드 동적 구성 + 상태 배지 복원.
   - [x] 관리자 RequiredManagerClient 필터(문서 유형) 다시 활성화 → `required_document_types` 기반 옵션 제공.
6. **승인 연동**
   - [x] actions API → user_document_submissions 업데이트 추가.
   - [ ] 승인/반려 이벤트 알림(추후 푸시) 고려.
7. **테스트/검증**
   - [ ] 통합 테스트 스크립트 업데이트 (`scripts/test-required-documents-*`).
   - [ ] QA 시나리오: 모바일 업로드 → 관리자 승인 → 모바일 상태 확인.

---

## 6. 리스크 및 완화 전략

| 리스크                                    | 영향             | 대응                                                                                                        |
| ----------------------------------------- | ---------------- | ----------------------------------------------------------------------------------------------------------- |
| 기존 requirement ID 참조 파악 실패        | 업로드/승인 중단 | 선행 감사 스크립트에서 모든 참조를 수집하고 마이그레이션 전 백업                                            |
| 모바일 UI 고정 코드 제거 시 레이아웃 변경 | 사용자 혼선      | API에서 sort_order/data 그룹 필드를 내려 UI 순서를 유지                                                     |
| 승인 시 상태 불일치                       | 작업자 혼란      | actions API에서 `user_document_submissions`와 `unified_document_system`를 동시에 업데이트, QA 스크립트 포함 |

---

## 7. 산출물

- SQL Migration 파일(테이블 보강 + 데이터 이관)
- 감사/검증 스크립트: `scripts/audit-required-docs.ts`
- 업데이트된 API 코드 및 모바일 문서함 컴포넌트
- 테스트 로그(업로드~승인 시나리오)
- 본 문서 업데이트 내역

---

## 8. 타임라인 (예상)

| Day | 작업                                    | 비고                   |
| --- | --------------------------------------- | ---------------------- |
| D0  | 감사 스크립트 작성/실행, 영향 범위 확정 | 운영 데이터 백업       |
| D1  | 스키마 보강 + 데이터 이관               | read-only 창 확보      |
| D2  | API/모바일 UI 수정                      | feature flag 적용 가능 |
| D3  | 승인 연동 + QA                          | 스크립트/문서 업데이트 |

---

문의: 시스템 아키텍트 (david.yang@inopnc.com) / Slack #wm-required-docs
