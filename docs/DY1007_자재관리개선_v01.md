# DY1007 자재 관리 연계/연동 개선 계획 v0.1

작성일: 2025-10-07

## 1) 배경과 목표

- 관리자 화면의 “현장 관리”와 “자재 관리” 기능을 유기적으로 연결하고, 모바일(작업자/현장관리자/파트너사)에서도 동일한 기준의 자재 정보를 일관되게 제공한다.
- 기존 Site 상세 탭(Materials)에서 사용 중인 경로는 있으나 API 구현이 비어있는 부분을 보완하고, 작업일지 저장 흐름과 재고/트랜잭션을 자동 연계한다.

## 2) 범위(Scope)

- 관리자:
  - 현장 상세 > Materials 탭 데이터 소스 정비(요약/요청/트랜잭션 연동)
  - 작업일지 제출/수정 시 재고 차감 및 트랜잭션 기록
- 모바일(작업자/현장관리자/파트너사):
  - 단일 요약 API로 동일한 항목(입고/사용/재고) 제공
  - 파트너사는 자신의 파트너사에 속한 현장만 열람(Read-only)
- 제외: 모바일 홈 위젯 “임박 재고/대기 출고” 카운터(현 시점 미구현)

### 2.1 단일 자재 모드(현 운영 정책 반영)

- 현재 관리 대상 자재는 1종: `INC-1000` (단위: `말`).
- 단일 자재 전용으로 화면/API를 간소화하고, 다자재 확장은 필요 시 이후에 진행.
- 재고 스냅샷(목록)은 운영상 혼선 방지를 위해 비표시(토글) 처리.

## 3) 데이터 모델(현행 테이블 활용)

- `material_inventory`(현장별 자재 재고: current_stock, minimum_stock 등)
- `material_transactions`(입고/사용/조정/출고 단일 원장)
- `material_requests`(요청)
- `material_shipments`(출고/배송)
- `material_usage`(작업일지에서 기록한 사용량 – 이력을 보존하고, 집계/재고 반영은 transactions 기준으로 일원화)

## 4) 권한/접근 제어

- 관리자: 전체 접근
- 현장관리자/작업자: 조회는 모든 현장에 대해 허용(조직/배정과 무관). 쓰기(생성/수정/삭제)는 기존 역할 정책에 따름.
- 파트너사(Partner):
  - 본 파트너사에 속한 현장만 조회 가능(필수 필터)
  - Read-only(쓰기 기능 없음)

## 5) API 설계

### 5.1 관리자용(현장 상세 탭 연동)

- 현장 요약
  - `GET /api/admin/sites/:id/materials/summary`
  - 응답: 상위 N개 재고, 최근 출고(Shipments) N개(필요 시 생산도 포함)와 간단 지표
- 현장 요청 목록(페이징/정렬)
  - `GET /api/admin/sites/:id/materials/requests?limit=&offset=&q=&status=&sort=&order=`
- 현장 트랜잭션 목록(페이징/필터)
  - `GET /api/admin/sites/:id/materials/transactions?limit=&offset=&type=&date_from=&date_to=`
- 구현: 기존 서버 액션 `app/actions/admin/materials.ts` 재사용, `withAdminAuth` + `assertOrgAccess` 적용

### 5.2 모바일 공통 요약 API(역할 공통 스키마, 파트너 필터, 단일자재 필터)

- 단일 엔드포인트(모든 역할 동일 항목 제공, 파트너만 범위 제한):
  - `GET /api/mobile/materials/site/:id/summary`
  - Query:
    - `date_from`/`date_to`(선택) – 기본 최근 7일
    - `limit`(선택) – 목록 상한(기본 10)
  - 응답(예시):
    ```json
    {
      "site_id": "...",
      "period": { "from": "YYYY-MM-DD", "to": "YYYY-MM-DD" },
      "inbound": {
        "total": 123.4,
        "items": [
          {
            "material_code": "INC-1000",
            "quantity": 80,
            "source": "shipment|production",
            "date": "..."
          }
        ]
      },
      "usage": {
        "total": 95.0,
        "items": [
          { "material_code": "INC-1000", "quantity": 5, "daily_report_id": "...", "date": "..." }
        ]
      },
      "inventory": {
        "count": 12,
        "items": [
          {
            "material_code": "INC-1000",
            "material_name": "INC-1000",
            "current_stock": 240,
            "minimum_stock": 50
          }
        ]
      }
    }
    ```
  - 권한/필터:
    - 관리자/현장관리자/작업자: 모든 현장 조회 허용(읽기). 서버에서 역할 확인 후 사이트 범위 제한 없음.
    - 파트너: 본 파트너사에 속한 현장만 조회(필수), Read-only
  - 비고: 쓰기 기능(요청 생성/재고 조정 등)은 별도 엔드포인트에서만 허용. 본 요약 API는 조회 전용.
  - 단일자재 적용: 서버에서 `INC-1000` 코드만 필터링하여 inbound/usage/inventory 응답 구성.

## 6) 작업일지 ↔ 재고 연계(백엔드 로직)

- 작업일지 저장/수정 시:
  1. `material_usage` 기록 유지(원천 이력)
  2. `material_transactions`에 `usage` 트랜잭션 생성(일자/현장/자재/수량/작성자/연계ID)
  3. `material_inventory.current_stock` 차감(트랜잭션 단위로 반영)
  4. `minimum_stock` 하회 시 저재고 알림 발송(`lib/notifications/triggers.ts`)
  5. 감사/지표 로깅(`lib/utils/logging.ts: logInventoryChange`)
- 멱등성: `daily_report_id + material_code` 단위로 중복 방지
  \n+단일자재 보정
- `material_usage` → `materials` 매핑 시 `INC-1000` 코드 우선 매칭.
- 저재고 알림/정책은 현 시점 비활성(필요 시 이후 적용).

## 7) UI 반영

- 관리자
  - Site 상세 > Materials 탭: 신규 관리자 API(5.1)로 데이터 연결
  - 자재 관리 메인 페이지는 현행 유지(필요 시 site 필터에서 상세 탭으로 이동 경로 제공)
  - 단일자재 모드 적용:
    - “재고 스냅샷” 섹션 비표시(환경변수 토글, 기본 숨김)
    - “최근 입출고” 목록은 `INC-1000`만 표시, 수량은 ‘말’ 단위로 해석
- 모바일
  - 현장 화면에서 `GET /api/mobile/materials/site/:id/summary` 호출하여 입고/사용 정보를 표시
  - “재고 스냅샷” 표는 비표시(혼선 방지). 합계(입고/사용)만 노출, 필요 시 기간 필터만 제공
  - 파트너는 자신의 현장만 선택/조회 가능(읽기 전용)
- 제외: 모바일 홈의 “임박 재고/대기 출고” 위젯은 현 시점 미구현(요구사항 제외)

## 8) 단계별 일정(제안)

- Sprint A (2~3일)
  - 관리자 현장별 자재 API 3종 구현(요약/요청/트랜잭션)
  - SiteDetailTabs 연동 및 확인
- Sprint B (2~3일)
  - 작업일지 저장 시 트랜잭션/재고 반영(멱등성/알림/로깅 포함)
  - 기본 통합 테스트(단위 + 간단 e2e)
- Sprint C (2일)
  - 모바일 요약 API 구현 및 모바일 화면 연동(단일자재 필터 적용, 재고 표 숨김)
  - 파트너 필터/권한(읽기 전용) 적용

## 9) 리스크/검증 포인트

- RLS/조직 경계: 파트너 범위 필수 적용, 현장관리자/작업자 조회 전면 허용에 따른 민감 정보(가격/원가) 노출 검증 및 비식별/필드 필터 필요
- 성능: 요약 API의 기간 집계 비용 – 필요 시 캐시/서브쿼리 최적화
- 정합성: 작업일지 수정/삭제 시 트랜잭션/재고 롤백/재적용 로직
- 테스트: 역할별 접근, 멱등 처리, 저재고 알림, 페이징/정렬, 경계값(minimum_stock=0 등)

### 환경 변수(권장)

- `NEXT_PUBLIC_SINGLE_MATERIAL_CODE=INC-1000`
- `NEXT_PUBLIC_MATERIAL_UNIT=말`
- `NEXT_PUBLIC_SHOW_INVENTORY_SNAPSHOT=false` (재고 스냅샷 섹션 숨김)

## 10) 구현 체크리스트

- [ ] `GET /api/admin/sites/:id/materials/summary` 구현
- [ ] `GET /api/admin/sites/:id/materials/requests` 구현
- [ ] `GET /api/admin/sites/:id/materials/transactions` 구현
- [ ] 작업일지 저장 훅과 서버 액션 연계(usage→transactions→inventory)
- [ ] `GET /api/mobile/materials/site/:id/summary` 구현(역할 공통, 파트너 범위 제한, Read-only)
- [ ] 관리자/모바일 UI 연동 및 스냅샷 테스트
