# DY0926\_급여현황화면 개선안 (HTML-first)

## 목적

- 급여명세서 생성/열람을 PDF 대신 HTML-first로 전환하여 구현/운영 복잡도와 비용을 낮추고, 모바일/웹 공통 템플릿으로 UX/유지보수를 단순화한다.
- 모바일(현장관리자)과 시스템관리자 화면 모두 동일한 계산식과 데이터 소스를 사용해 정합성을 보장한다.

## 기준 계산식(관리자 도구와 일치)

- 기본급(프리/일용/상용의 일급) × 총공수 − 세금(소득세+주민세) = 실수령액
- 총공수: 해당 월의 labor_hours 합(없으면 work_hours/8), 다현장 근무 시 합산
- 세금: 본사/시스템관리자가 사용자별로 설정(커스텀 가능)

## 모바일 UI 변경(현장관리자 > 출력정보 > 급여현황)

- 상단 영역
  - [년월 선택]만 제공. ‘현장’ 드롭다운 제거(월 단위 합산 관점)
- 핵심 통계(캘린더 하단과 동일 레이블)
  - 현장수: 해당 월 작업 기록이 있는 고유 site_id 개수
  - 공수: 월 총공수(소수 1자리)
  - 근무일: status ∈ {present, late, in-progress} 날짜 수
- 급여 요약 카드(간단 표기)
  - 고용형태/일급: 예) 일용 · 150,000원/공수
  - 기본급(월): 150,000 × 22.5공수 = 3,375,000원
  - 세금(소득세+주민세): 123,000원
  - 실수령액: 3,252,000원
  - 배지: [확정] salary_records 기준 / [예상] work_records+설정으로 추정 시
  - 행동: [급여명세서 보기] → 새 탭에서 HTML 열람(브라우저 인쇄로 PDF 저장 유도)
- 급여명세서 이력(옵션)
  - 최근 N개월 목록(월, 발행일, 상태). 항목 터치 → HTML 열람
- 상태 처리
  - 데이터 없음/로딩/오류에 대한 간단 메시지 및 Skeleton
- 참고 스크린샷
  - dy_memo/screenshots_INOPNC_0829/스크린샷 2025-09-26 16.51.44.png
  - dy_memo/screenshots_INOPNC_0829/스크린샷 2025-09-26 17.04.32.png

## 시스템관리자 UI 변경(급여관리 도구)

- 생성 방식을 HTML-first로 전환
  - ‘발행’ 시점에 계산 스냅샷(JSON)을 저장하고, 이를 렌더링하는 HTML 페이지를 링크로 제공
  - [열람]은 새 탭에서 HTML을 열고, [PDF 저장]은 브라우저 인쇄를 이용(운영 비용/복잡도 감소)
- 목록/상세
  - 급여 레코드 목록에서 각 항목에 [HTML 보기] 링크 제공
  - 상태 배지: calculated/approved/paid
  - (옵션) 대량 발행 시 비동기 큐로 스냅샷 생성만 수행
- 정합성
  - 모바일과 동일 계산식(일급 × 총공수 − 세금)
  - 다현장 합산 기준 동일

## 데이터/연동

- 소스
  - 작업 기록: work_records (work_date, work_hours, labor_hours, status, site_id)
  - 개인 급여 설정/세율: worker_salary_settings, employment_tax_rates
  - 발행본: salary_records(있으면 확정치로 우선)
- 우선순위
  1. salary_records 월 요약 존재 시 이를 사용(세금/실수령액 확정)
  2. 없으면 work_records+설정/세율로 예상치 계산(배지로 ‘예상’ 표기)

## 라우팅/페이지

- HTML 급여명세서 뷰: app/payslip/[userId]/[year]/[month]/page.tsx (공용 템플릿)
  - 전달: 계산 스냅샷 또는 월 집계 결과
  - 동작: 새 탭 열람, 인쇄 버튼(window.print) 제공(브라우저 PDF 저장)
- 모바일 급여현황: modules/mobile/pages/attendance-page.tsx(급여 탭)
  - 년월 선택 → 해당 월 스냅샷 또는 집계 호출 → 요약/통계 표시 → [보기]로 HTML 뷰 이동

## 인쇄용 CSS 가이드

- @page { size: A4; margin: 12mm; }
- @media print { .no-print { display:none } .page-break { break-before: page; } }
- \*-webkit-print-color-adjust: exact; print-color-adjust: exact;
- 웹 전용 버튼/내비는 .no-print 처리

## 구현 계획(핵심 작업)

- 모바일(간단 변경)
  - attendance-page.tsx(급여 탭)
    - [삭제] 급여 탭의 현장 선택 드롭다운
    - [유지] 년월 선택 + 통계(현장수/공수/근무일)
    - [추가] 급여 요약 카드(고용형태/일급/기본급/세금/실수령액) + [급여명세서 보기] 버튼(새 탭으로 app/payslip 경로 열기)
    - [표시] salary_records 존재 여부에 따른 확정/예상 배지
- 관리자(점진 변경)
  - 급여관리 목록/상세에서 [HTML 보기] 링크 노출, 발행 시 스냅샷 저장 후 HTML 열람 경로 제공
  - (옵션) PDF 대량 발행은 비동기 서버 기능으로 후순위 지원
- 서버 액션 제안(모바일 전용)
  - app/actions/mobile/salary-monthly.ts(신규)
    - 입력: { worker_id, year, month }
    - 처리: salary_records 월 요약 조회 → 없으면 work_records 집계 + 설정/세율로 예상치 계산
    - 출력: { siteCount, totalManDays, workDays, employment_type, daily_rate, gross_pay, tax, net_pay, snapshot? }

## QA 체크리스트

- 년월 변경 시 통계/요약 동기화
- salary_records 우선 적용(확정/예상 배지 확인)
- 다현장 공수 합산 정확성
- 브라우저 인쇄 시 여백/페이지 나눔/색상 기대치
- 권한/접근 제어(본인/관리자만 접근)

## 단계적 적용

1. Phase 1: 모바일 UI 정리(현장 드롭다운 제거, 요약/통계, HTML 보기 링크) + 인쇄 CSS
2. Phase 2: 스냅샷 저장/조회(발행본) 연계, 관리자 목록에 HTML 보기 확장
3. Phase 3: 선택적 비동기 PDF(서명/직인 필요 시) 보조

---

참고 코드

- app/actions/admin/salary.ts, app/actions/admin/worker-salary-settings.ts
- modules/mobile/pages/attendance-page.tsx
- app/payslip/[userId]/[year]/[month]/page.tsx
