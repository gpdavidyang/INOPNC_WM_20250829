# DY1025 사진대지 직접입력 개선 구현 계획안

## 1) 목표와 범위

- 대상: 본사관리자 화면 > 사진대지 관리 > 직접업로드 플로우 전면 개편 (작업일지에서 생성은 현행 유지)
- 결과물: 미리보기/다운로드·인쇄 결과가 제공 템플릿(`/dy_memo/요청데이터_20251010/사진대지사진대지.html`)과 동일한 레이아웃/스타일로 출력
- 핵심: 사용자가 가로/세로 방향과 사진 그리드(행×열 프리셋)를 선택 → 해당 양식에 제목/공사명/메타(부재명·공정·내용·보수전/후) 입력 → 각 칸을 클릭해 사진 업로드 → 미리보기/인쇄

## 2) 확정 요구사항 요약

- 방향: 세로(포트레이트), 가로(랜드스케이프) 선택 지원
- 프리셋(세로 기준):
  - 1×1, 2×1, 3×1, 2×2, 3×2, 4×2, 3×3, 4×3, 5×3, 4×4, 5×4, 5×5
  - 가로 양식도 동일 프리셋 제공(단, 인쇄 시 orientation만 가로)
- 상단: 사진대지 제목(자유 입력)
- 공사명(현장명): 기존 현장 테이블에서 선택(검색형 콤보박스)
- 항목 메타: 부재명/공정은 기존 방식 유지(선택/검색), 내용은 자유입력, 보수 전/보수 후 드롭다운 제공
- 1페이지 내 사진 수량 = 행×열. 페이지 수는 자동 분할(넘치는 경우 동일 헤더/테이블 구조로 다음 페이지 생성)
- 출력: A4 고정, 템플릿과 폰트/여백/선두께 등 완전 일치. 캡션(촬영자/일자 등) 추가 없음
- 데스크톱 UI 기준(관리자용). 드래그앤드롭/클릭 업로드 지원

## 3) 화면/UX 설계

- 좌측: 설정 패널
  - 방향 토글: 세로/가로
  - 프리셋 선택: 드롭다운(아이콘/미리보기 썸네일 포함) 또는 Grid 선택기
  - 제목 입력
  - 공사명(현장) 선택: 서버 검색형(기존 현장 테이블)
  - 공통 액션: 초안 저장, 미리보기, 인쇄(PDF저장)
- 우측: 그리드 편집 캔버스
  - 선택된 프리셋대로 타일 렌더(예: 3×2)
  - 각 타일:
    - 이미지 업로드 영역(클릭/드롭) + 업로드 진행/검증(형식·용량)
    - 메타 입력: 부재명(선택), 공정(선택), 내용(자유), 보수전/보수후(드롭다운)
    - 순서 드래그 정렬(옵션): 그리드 내 재배치
  - 페이지 자동 분배: 사진 수가 프리셋 용량을 초과하면 다음 페이지로 자동 이동(각 페이지에 동일한 헤더/테이블)
- 미리보기
  - 인쇄 전 실제 A4 비율 캔버스에 1:1 미러링
  - 페이지 경계 표시, 실제 줄/선 두께/여백 확인 가능

## 4) 출력/프린트 사양

- CSS 인쇄 규칙
  - `@page { size: A4 portrait|landscape; margin: [템플릿과 동일 mm]; }`
  - 페이지 컨테이너 간 `break-after: page`; 타일/테이블 행에는 `break-inside: avoid`
  - 단위: mm/pt 활용해 템플릿 선두께/여백/폰트 크기 정확 매칭
  - 폰트: 템플릿과 동일 폰트(예: Noto Sans KR) 적용. 웹폰트 사전 로드 및 `print` 미디어 최적화
- 레이아웃
  - 상단 타이틀(사진대지 제목)
  - 공사명(현장명) 입력란을 표 상부 라인에 템플릿과 동일 위치로 렌더
  - 그리드(행×열) 이미지 영역: 비율 유지 `object-fit: cover` 기본, 테두리/간격 템플릿 일치
  - 하단 메타 테이블: 이미지 칸 수에 맞춰 행 개수 = 사진 수, 열 = [부재명 | 공정 | 내용 | 보수전/후]
- 정밀 매칭 절차
  - 제공 HTML을 기준으로 CSS 토큰(여백 mm, 폰트 크기 pt, 선 두께 px) 추출 → 디자인 토큰으로 공통화
  - 미리보기 화면과 인쇄 PDF를 크로스 체크(픽셀단위 시각 비교)

## 5) 데이터 모델(제안)

- PhotoSheet
  - id (uuid), title, orientation('portrait'|'landscape'), rows, cols
  - site_id (현장 FK), created_by, created_at, updated_at, status('draft'|'final')
- PhotoSheetItem
  - id (uuid), photosheet_id (FK), index (0..N-1)
  - member_id(부재 FK?) 또는 member_name (현행 구조 유지에 맞춤)
  - process_id(공정 FK?) 또는 process_name (현행 구조 유지에 맞춤)
  - content (문자열), stage ('before'|'after'|null)
  - image_url (Supabase Storage 경로), width, height, mime(optional)

참고: “기존 방식 유지”에 맞춰 부재/공정은 현재 사용중인 선택 소스(테이블/뷰/API)를 재사용. FK/이름 중 실제 구축 방식에 맞춰 타입 결정.

## 6) 라우팅/구성(Next.js App Router)

- 경로(예시):
  - `app/dashboard/photo-sheets/page.tsx` 목록/검색
  - `app/dashboard/photo-sheets/new/page.tsx` 직접입력 편집기(본 작업 핵심)
  - `app/dashboard/photo-sheets/[id]/edit/page.tsx` 재편집
  - `app/dashboard/photo-sheets/[id]/preview/page.tsx` 프린트 미리보기
- 서버 액션(actions)
  - `saveDraft(formData)`: PhotoSheet/Items upsert
  - `finalize(id)`: 상태 전환, 불변 스냅샷(optional)
  - `uploadImage(file)`: Supabase Storage 업로드, URL 반환

## 7) 컴포넌트 구조(핵심)

- UI 패널
  - `PhotoSheetConfigPanel`: 방향, 프리셋, 제목, 현장 선택, 액션 버튼
  - `SiteSelect`: 서버 검색형 콤보박스(Supabase RPC 또는 edge function)
- 그리드/에디터
  - `PhotoGridRenderer`: 행×열에 따라 타일 렌더, 비율 유지를 위한 컨테이너
  - `PhotoTile`: 업로드영역 + 메타입력(부재/공정 선택, 내용, 보수전/후)
  - `ReorderableGrid`(옵션): 드래그 정렬 지원
- 프린트 템플릿
  - `PhotoSheetPrint`: 템플릿과 완전 일치하는 A4 레이아웃(헤더/공사명란/그리드/하단 테이블)
  - `print.css`(또는 CSS module): @media print와 @page 규칙 별도 관리
- 상태/훅
  - `usePhotoSheetEditor`(rows, cols, orientation, items CRUD, validation, dirty state)
  - `useUploadImage`(drag&drop, 용량/형식 검증, 업로드 진행률)

## 8) 업로드/스토리지

- Supabase Storage 버킷: `photosheets`
  - 경로: `/<org>/<site_id>/<photosheet_id>/<index>.<ext>`
  - 보안: 관리자 전용 읽기/쓰기(대시보드 RLS/정책 확인)
- 이미지 규격
  - 허용 포맷: jpg/jpeg/png (필요 시 heic→jpeg 변환은 서버측 처리 검토)
  - 최대 용량/해상도 제한 및 리사이즈 정책(인쇄 품질 기준)

## 9) 검증/밸리데이션

- 필수: 제목, 현장, 프리셋(rows/cols), 최소 1장 업로드
- 각 타일: 부재/공정 선택 값 유효성(현행 로직 준수), 보수전/후 드롭다운 값
- 페이지 분할: 사진 개수 N에 대해 pageCount = ceil(N / (rows×cols))
- 프린트: 각 페이지 이미지/표 행 수 일치, 줄넘김 금지(`break-inside: avoid`)

## 10) 호환/마이그레이션

- 현행 “직접업로드” 생성분은 조회/인쇄 그대로 유지
- 신규 생성은 PhotoSheet/PhotoSheetItem 스키마 사용
- 필요 시 기존 레코드 → 신규 포맷 변환 툴 별도 제공(범위 외)

## 11) 접근제어/권한

- 관리자 역할만 편집/인쇄 접근 허용
- API/서버액션에서 사용자 역할/소속 현장 권한 체크(Supabase RLS와 일관)

## 12) 개발 단계/일정(제안)

1. 템플릿 추출/토큰화: 제공 HTML → 디자인 토큰(mm, px, pt, 폰트)
2. 프린트 컴포넌트/스타일 1차 구현(+ 미리보기 route)
3. 에디터 UI(방향/프리셋/현장/제목) + 그리드 렌더러
4. 타일 업로드 + 메타 입력(부재/공정/내용/보수전후)
5. 저장/불러오기 서버액션 + 스토리지 연동
6. 페이지 분할 로직 + 하단 메타 테이블 동기화
7. 픽셀매칭/출력 검증(인쇄-PDF 교차 비교) 및 QA
8. 성능/UX 다듬기(드래그정렬, 단축키, 포커스 이동 등 선택)

## 13) 테스트/검수 항목

- 기능
  - 프리셋 전부(세로/가로)에서 레이아웃/줄바꿈 정확
  - 타일 업로드/삭제/교체, 드래그 정렬(옵션) 정상
  - 부재/공정 선택 소스가 현행과 동일 동작
  - 보수전/후 값 프린트 테이블에 반영
  - 페이지 초과 시 자동 분할 및 헤더/표 재렌더
- 품질
  - 인쇄 결과가 템플릿과 1:1 매칭(여백, 폰트, 선두께, 셀 크기)
  - PDF 저장 시 글꼴 임베딩/깨짐 없음
  - 큰 이미지/대량 타일에서 성능/메모리 안정
- 보안/권한
  - 관리자만 접근/편집 가능, 스토리지 경로 접근 제어

## 14) 기술 상세(핵심 포인트)

- 레이아웃 계산
  - 컨테이너는 A4 비율 박스(미리보기). `grid-template-columns: repeat(cols, 1fr)`
  - 이미지 박스는 내부 패딩/보더를 템플릿 수치에 맞춤. `aspect-ratio`와 내부 `object-fit: cover` 사용
- 페이지 분할
  - 에디터는 가상 페이지 배열을 구성해 렌더 → 프린트 시 각 페이지 컨테이너에 `break-after: page`
- 프린트 폰트/선두께
  - pt와 mm를 병용해 출력 장치에 독립적인 일관성 확보. 웹폰트는 preload 및 `font-display: swap`
- Next.js
  - 서버컴포넌트 + 클라이언트 컴포넌트 혼용. 저장/업로드는 서버액션 사용
  - 미리보기는 별도 route에서 동일 DOM을 프린트 모드로 렌더(@media print)

## 15) 수용 기준(Definition of Done)

- 모든 프리셋(가로/세로) 인쇄 결과가 제공 템플릿과 육안/픽셀 매칭 수준으로 동일
- 제목/현장/메타(부재/공정/내용/보수전후)가 표/그리드와 정확히 동기화
- A4 고정, 브라우저 인쇄/PDF 저장 시 페이지/줄바꿈 오류 없음
- 관리자 대시보드에서 자연스러운 작성/저장/재편집/미리보기/인쇄 플로우

## 16) 후속 옵션(범위 외 제안)

- 다국어/폰트 자동 대체, 사진 자동 리사이즈/압축, EXIF 회전 교정
- 항목 템플릿 즐겨찾기(프리셋+메타 사전 구성)
- 워터마크/서명칸 추가 옵션
- 전/후 비교 양식(2열 구조) 전용 프리셋 추가
