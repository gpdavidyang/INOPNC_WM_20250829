# DY0929 — 시스템관리자 화면 탭형 복원 계획서

## 목적

- 2~3주 전 구축했던 관리자 UI/UX 수준(탭형 통합 문서 관리 포함)으로 복원 및 개선
- 현재 간소화/플레이스홀더 상태의 화면을 레거시 고도화 컴포넌트와 재결합하여 기능 완성도 회복

## 배경 · 변경 시점

- 2025-09-21~22 사이 App Router/빌드 안정화 과정에서 일부 관리자 화면이 축약/스텁화됨
  - 예: “Simplify admin documents stubs for build” (2025-09-22), “Add admin dashboard layout for App Router” (2025-09-22)
- 레거시의 고도화된 탭형 문서 관리 컴포넌트가 `components/admin/legacy/documents/*` 경로에 보존되어 있음
- 통합 문서 API는 v1(`/api/unified-documents`)와 v2(`/api/unified-documents/v2`)가 공존

## 범위(우선순위 순)

1. 문서 관리 탭형 UI 복원(최우선)
2. 파트너/조직 화면 실데이터화(스텁 → Supabase 질의)
3. 분석 대시보드 실데이터화(스텁 → Supabase 질의)
4. 도구/백업 화면은 안내/선택적 연결(후순위)

## 산출물

- 탭형 문서 관리 UI로 `/dashboard/admin/documents` 복원
- 문서 카테고리별(공유/도면마킹/필수/정산/사진대지/유형관리) 리스트·상세·히스토리·필터/페이지네이션 정상 동작
- 파트너/조직/분석 화면 실데이터 API 교체
- 진행현황 체크 가능한 TODO 추적 표(본 문서) 업데이트

## 기술 기준

- Next.js 14 App Router, TypeScript, Supabase(Postgres)
- 관리자 권한 검증: `requireAdminProfile`, `requireApiAuth`
- API 우선: `/api/unified-documents/v2`(권장), 필요시 `/api/unified-documents`(레거시 호환)

## 단계별 계획

### Phase 1 — 문서 탭형 UI 복원 (최우선)

- 목표: `components/admin/legacy/documents/UnifiedDocumentManagement.tsx`를 재활용하여 탭형 UI 복귀
- 작업
  - [ ] `app/dashboard/admin/documents/page.tsx`를 탭형 컴포넌트로 연결
  - [ ] 레거시 하위 탭(Shared/Markup/Required/Invoice/PhotoGrid/Types) 호출 API 점검
    - 1차: 레거시 `/api/unified-documents` 경로 유지로 신속 복원
    - 2차: 교체 가능한 지점부터 `/api/unified-documents/v2`로 전환(점진)
  - [ ] 상세/이력/접근로그 연동 확인(`/api/unified-documents/v2/[id]` + `document_history`, `document_access_logs`)
  - [ ] 권한/RLS 확인(관리자 뷰에서 전체 접근, 제한 계정 테스트)
- 파일 영향(예상)
  - `app/dashboard/admin/documents/page.tsx`
  - `components/admin/legacy/documents/*` (필요 시 경미 수정)
  - `app/api/unified-documents/*`, `app/api/unified-documents/v2/*` (필요 시 보완)
- 검증 체크리스트
  - [ ] `/dashboard/admin/documents` 로딩·탭 이동
  - [ ] 검색/필터/페이지네이션 반영
  - [ ] 상세·이력·접근로그 표시
  - [ ] 업로드/생성 → 목록 반영(최소 플로우)

참고(9/22 버전 기준 존재 여부)

- 탭 내 개별 필터/페이지네이션 UI: 9/22 축약판에는 미포함 → 후속 단계로 이관
- 탭 내 문서 상세 패널/프리뷰: 9/22 축약판에는 미포함(레거시에는 존재) → 후속 단계로 이관
- 카테고리별 추가 지표(승인/대기 배지): 9/22 축약판에는 미포함(레거시 개념 존재) → 후속 단계로 이관

### Phase 2 — 파트너/조직 실데이터화

- 목표: 스텁 API 제거 및 Supabase 질의로 교체
- 작업
  - [ ] `/api/admin/partner-companies` 스텁 → `partner_companies`/관련 매핑 테이블 실쿼리로 대체
  - [ ] 조직 목록/생성 API 재점검(`/api/admin/organizations`) — 이미 실쿼리 연결, 에러시 폴백 제거/정리
- 검증 체크리스트
  - [ ] `/dashboard/admin/partners` 필터/검색 동작
  - [ ] `/dashboard/admin/organizations` 목록/생성 성공

### Phase 3 — 분석 대시보드 실데이터화

- 목표: `/api/admin/analytics/dashboard` 스텁 → 실데이터 질의로 교체
- 데이터 소스(예시)
  - 사용자/현장/문서/일일보고 카운트 및 추이, 분포
- 작업
  - [ ] 개요/트렌드/분포 지표를 Supabase 질의로 구성(기간 파라미터: week/month/quarter)
- 검증 체크리스트
  - [ ] 기간 변경 시 그래프/수치 갱신
  - [ ] 빈 데이터 환경에서도 안전 동작(0/빈 배열)

### Phase 4 — 도구/백업(선택)

- 목표: 안내 → 최소 기능 혹은 메뉴 가이드 유지 결정
- 작업(선택)
  - [ ] 마크업/포토그리드 툴 최소 기능 연결 or 안내 명확화
  - [ ] 백업: 수동 트리거/타임스탬프 기록 API 제공(옵션)

## 진행 현황(체크리스트)

- 사전 보완(완료)
  - [x] 알림 이력 서버 검색 연동(app/dashboard/admin/notifications/page.tsx)
  - [x] 공지 서버 검색 연동(app/api/announcements/route.ts, communication 페이지)
  - [x] 가입요청 서버 검색 연동(app/actions/admin/signup-approvals.ts, signup-requests 페이지)
  - [x] 작업 옵션 생성/수정 UI 추가(WorkOptionsEditor)
  - [x] 시스템 지표 문서 통계 통합 테이블 우선 사용(unified_documents, documents 폴백)
  - [x] 관리자 화면의 Phase 2 안내 문구 제거(2FA 기능명 제외)
- Phase 1 — 문서 탭형 복원
  - [x] `/dashboard/admin/documents` 탭형 UI 연결
  - [ ] 하위 탭 API 점검(/api/unified-documents ↔ /v2 단계 전환 계획 반영)
  - [ ] 상세/이력/접근로그 정상
  - [x] 필터/페이지네이션/검색 정상(탭 내 구현 완료)
- Phase 2 — 파트너/조직 실데이터화
  - [x] `/api/admin/partner-companies` 실쿼리화
  - [ ] 조직 API 폴백/에러 처리 정리
- Phase 3 — 분석 대시보드 실데이터화
  - [ ] `/api/admin/analytics/dashboard` 실데이터화
- Phase 4 — 도구/백업(선택)
  - [ ] 마크업/포토그리드 툴 연결 or 안내 유지 결정
  - [ ] 백업 트리거/표시 최소 구현(옵션)

## 검증 루트(Quick Verify)

- 문서: `/dashboard/admin/documents`, `/dashboard/admin/documents/markup`, `/dashboard/admin/documents/invoice`, `/dashboard/admin/documents/photo-grid`, `/dashboard/admin/documents/required`
- 상세/업로드: `/dashboard/admin/documents/[id]`, `/dashboard/admin/documents/upload`
- 일일보고: `/dashboard/admin/daily-reports`, `/dashboard/admin/daily-reports/[id]`
- 파트너/조직: `/dashboard/admin/partners`, `/dashboard/admin/organizations`
- 분석: `/dashboard/admin/analytics`

## 의존성/데이터 소스

- 통합 문서: `unified_document_system`, `unified_documents`, `document_history`, `document_access_logs`
- 사진대지/마크업/정산: `photo_grid_reports`, `markup_documents`, 통합 문서 스키마
- 사용자/현장: `profiles`, `sites`, `site_assignments`
- 공지/알림: `announcements`, `notification_logs`

## 위험 · 대응

- 레거시 컴포넌트가 구형 API를 호출: 1차 레거시 API 사용으로 빠른 복원, 2차로 v2 전환
- 환경별 테이블 부재: 빈 목록/안내로 degrade — try/catch 유지
- 권한/RLS 차이: `requireAdminProfile/requireApiAuth` 강제, 제한계정 테스트 체크

## 롤백 전략

- 모든 변경은 기존 페이지 교체가 아닌 연결 전환 위주로 진행
- 문제 발생 시 즉시 기존 단순 리스트 뷰로 리버트 가능(`/dashboard/admin/documents/page.tsx` 원복)

## 일정 제안(상한)

- Phase 1: 0.5~1일
- Phase 2: 0.5일
- Phase 3: 0.5~1일
- Phase 4: 0.5일(선택)

## 변경 로그(작성 예시)

- 2025-09-29: 문서 탭형 UI 연결, Shared/Markup 탭 실동작 확인, 상세 이력 확인(개발/스테이징)
- 2025-09-30: 파트너 실데이터화, 조직 API 정리, 분석 일부 카드 실데이터화

---

본 문서는 세션 간 컨텍스트 유지 및 작업 진행 상황 추적을 위한 기준 문서입니다. 업데이트 시 체크박스를 갱신하고, API 전환 여부(/api/unified-documents → /v2)를 각 탭별로 명시해 주세요.
