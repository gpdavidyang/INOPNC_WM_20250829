# DY0926*급여현황화면*개선안

## 1) 목적/범위

- 대상: 현장관리자(및 본인) 모바일 화면 > 출력정보 > 급여현황 탭
- 목표: 선택한 년월 기준으로 월 단위 급여 계산 결과를 “간단하고 직관적”으로 조회. 동일 월 여러 현장에서 일한 공수를 합산하여 표시. 발행된 급여명세서(PDF) 이력 조회 및 브라우저 네이티브 뷰어로 열람.
- 정합성: 시스템관리자 화면의 ‘급여관리 도구’ 계산 방식과 일관성 유지(공수 기반, 개인별 세금/설정 반영).

## 2) 요구사항 요약

- 상단에 년월 선택만 제공. “현장” 드롭다운은 제거(급여는 월 합산 관점).
- 핵심 통계 3개(캘린더 아래와 동일 레이블): 현장수 / 공수 / 근무일.
- 급여 계산 요약: 기본급 × 공수 − 세금(소득세+주민세) = 실수령액.
  - 기본급은 고용형태(프리, 일용, 상용)에 따라 설정된 일급을 사용.
  - 공수: 해당 월 전체 공수 합산(labor_hours 합, 없으면 work_hours/8).
  - 세금: 본사관리자/시스템관리자가 설정한 개인별 세율 반영.
- 급여명세서(PDF) 이력 리스트: 클릭 시 새 창/탭으로 네이티브 PDF 뷰어에서 열람(확대/축소/저장 브라우저 기본 기능).
- 단순/명료 UI 유지. 필요 시 상세는 접힘(선택)으로 제공.

## 3) 데이터 및 연동 정책

- 출퇴근/작업 데이터: `work_records`
  - 주요 필드: `work_date`, `work_hours`, `labor_hours`, `status`, `site_id`, `sites.name`
  - 집계 기준: status ∈ {present, late, in-progress}인 날짜를 근무일로 카운트.
  - 공수: 우선 `labor_hours` 사용, 없으면 `work_hours/8`.
- 급여 설정/세금: `worker_salary_settings`, `employment_tax_rates`
  - 고용형태(프리/일용/상용), 일급(daily_rate), 개인별 커스텀 세율(custom_tax_rates) 반영.
  - 단일 계산 기준을 위해 ‘공수 기반’(일급 × 총공수)로 맞춤(관리자 도구와 정합).
- 관리자 급여 도구와 정합성 참고
  - `app/actions/admin/salary.ts`의 공수 기반 계산: 역할별 일급 × 공수(연장수당 별도 미계산).
  - `app/actions/admin/worker-salary-settings.ts`의 개인별 계산/세율 관리 API 존재.
  - 월 집계가 `salary_records`를 기준으로 제공되는 경우가 있음(`getPersonalMonthlySalarySummary`).
- 모바일 표시 데이터 소스 우선순위
  1. 발행/저장된 `salary_records`가 있으면 월 요약 사용(세금/공제 확정치).
  2. 없으면 `work_records` + 개인 급여 설정/세율로 “예상치” 계산 표기.

## 4) 계산 로직 정리(모바일)

- 통계(현장수/공수/근무일):
  - 현장수: 해당 월에 작업 기록이 존재하는 고유 `site_id` 개수.
  - 공수: ∑(labor_hours) 또는 ∑(work_hours)/8, 소수 1자리 표기.
  - 근무일: 해당 월의 근무 상태 날짜 수(Set로 중복 제거).
- 급여 요약:
  - 고용형태/일급: `worker_salary_settings`에서 최신 유효 설정.
  - 기본급(월총): `일급 × 총공수`(공수에 이미 일수 개념이 내재되어 중복 산정 방지).
  - 세금: 개인별(소득세+주민세) 우선 적용. `employment_tax_rates`/개인 커스텀 세율 기반.
  - 실수령액: 기본급 − 세금(간소화). 필요 시 다른 4대 보험 항목이 존재하면 합산 공제 표기(관리자 도구와 동일한 방식).
- 주의: “일수 × 공수” 표현은 UI 통계 항목 표기를 의미하며 실제 계산은 `총공수`만으로 수행해 중복 카운트 방지(관리자 도구와 동일). UI에는 [근무일, 공수] 모두 노출.

## 5) UX 구조(모바일 급여현황 탭)

1. 상단 바
   - [년월 선택 셀렉터] (기본: 이번 달)
   - 사이트 선택 제거
2. 핵심 통계 3카드
   - 현장수 | 공수 | 근무일
3. 급여 요약 카드(심플)
   - 고용형태/일급: 예) 일용 · 150,000원/공수
   - 기본급(월): 150,000 × 22.5공수 = 3,375,000원
   - 세금(소득세+주민세): 123,000원
   - 실수령액: 3,252,000원
   - [i] ‘관리자 도구와 동일한 공수 기반 계산’ 안내 문구(작게)
4. (선택) 상세 접힘 섹션
   - 일자별 공수/현장 라인 리스트(압축 표시), 합계 하단 고정
5. 급여명세서(PDF) 이력
   - 최근 N개월 목록(월, 발행일, 지급상태). 항목 클릭 → `/pdf-viewer?url=`로 새창/새탭 열기.
   - 파일 없을 시 빈 상태 안내.
6. 로딩/빈 상태/오류
   - Skeleton, “데이터 없음”, “불러오기 실패” 가이드 텍스트 간결 제공.
7. 시각 스타일
   - 기존 스크린샷 스타일 유지(`dy_memo/screenshots_INOPNC_0829/...`). 여백·폰트·배지 톤 일관.

## 6) 화면 흐름

1. 진입 시 현재 월 데이터 로드 → 통계/요약 표시
2. 년월 변경 시 해당 월 재계산
3. 급여명세서 리스트는 비동기 로드(있으면 표시)
4. PDF 클릭 시 `/app/pdf-viewer`로 이동하여 네이티브 뷰어로 열람

## 7) 구현 계획(핵심 TODO)

- UI 변경
  - [삭제] 급여현황 탭의 현장 선택 드롭다운 제거(`modules/mobile/pages/attendance-page.tsx`).
  - [유지] 년월 선택, 통계 3카드(현장수/공수/근무일).
  - [요약 카드] 고용형태/일급/기본급/세금/실수령액 간단 표기.
- 데이터 수집/집계
  - 출퇴근: 기존 `work_records` 로딩 로직 재사용(월 범위 필터만 적용).
  - 통계: `siteCount`, `totalManDays`, `workDays`는 현재 구현 패턴 재사용.
- 급여 계산 일관성
  - 1순위: `salary_records` 월 요약(`getPersonalMonthlySalarySummary`). 존재 시 세금/실수령액 “확정치”로 표기.
  - 2순위: `work_records` + `worker_salary_settings` + `employment_tax_rates`로 “예상치” 집계(일급 × 총공수 − 세금). 세율 커스텀 반영.
- 급여명세서 PDF
  - 리스트: `getPayslips(worker_id)` 또는 통합 문서 테이블/스토리지 메타데이터에서 조회.
  - 열람: `/pdf-viewer?url=${encodeURIComponent(fileUrl)}` 로 이동(브라우저 기본 뷰어 UI 사용).

## 8) 연계 포인트(관리자 화면과의 정합)

- 공수 기반 계산(일급 × 공수)으로 통일.
- 세율/공제: `worker_salary_settings` + `employment_tax_rates`/개인 커스텀 세율 사용.
- 월 합산 단위: 동일 월 내 여러 현장 공수 합산.
- 발행된 `salary_records`가 존재하면 모바일에서도 동일 수치 노출(확정치).

## 9) 기술 상세(제안)

- 상태/훅
  - `salarySelectedYearMonth`만 유지. `salarySiteId`/드롭다운 제거.
  - `salaryStats`: `{ siteCount, totalManDays, workDays }`(이미 구현 패턴 활용).
- 계산 경로
  - Server Action(모바일 전용) 제안: `app/actions/mobile/salary-monthly.ts`
    - 입력: `{ worker_id, year, month }`
    - 처리:
      1. `salary_records` 월 요약 조회 → 있으면 그대로 반환.
      2. 없으면 `work_records` 월 집계 + `worker_salary_settings`/세율로 예상치 계산.
    - 출력: `{ siteCount, totalManDays, workDays, employment_type, daily_rate, gross_pay, taxes: { income, resident }, net_pay, details? }`
- PDF 뷰어
  - 기존 페이지 활용: `app/pdf-viewer/page.tsx` (iframe/embed로 네이티브 컨트롤 노출).

## 10) 엣지 케이스

- 월 내 데이터 없음: 통계 0, “이번 달 데이터가 없습니다” 표시.
- 급여 설정 없음: 일급 미설정 배지/안내, 예상치 계산 불가 시 안내.
- 세율 미설정: 기본 세율(0% 또는 시스템 기본) 적용 안내.
- salary_records는 없고 work_records만 있는 경우: “예상치” 라벨 표시.

## 11) QA 체크리스트

- [ ] 년월 변경 시 통계/요약이 일관되게 갱신되는가?
- [ ] 동일 월 다현장 근무 시 공수가 합산되는가?
- [ ] 근무일 카운트가 상태 기준으로 정확한가?(present/late/in-progress)
- [ ] `salary_records` 존재 시 값이 관리자 화면과 동일한가?
- [ ] 세율 커스텀/개인별 설정이 반영되는가?
- [ ] PDF 리스트 존재 시 클릭 열람/다운로드 정상 동작하는가?
- [ ] 데이터 없음/오류/로딩 상태가 간결히 표현되는가?

## 12) 릴리스/마이그레이션

- 1차: 드롭다운 제거 + 통계/요약 UI 정비 + PDF 링크 목록 노출(목업/모의 데이터 허용).
- 2차: 모바일 전용 Server Action 연동, `salary_records` 우선/예상치 보조 집계.
- 3차: 관리자 도구에서 발행 시 모바일 알림/배지 연계(선택).

---

참고 파일(코드 레퍼런스)

- 모바일 급여현황 페이지: `modules/mobile/pages/attendance-page.tsx`
- 관리자 급여 계산: `app/actions/admin/salary.ts`, `app/actions/admin/worker-salary-settings.ts`
- PDF 뷰어: `app/pdf-viewer/page.tsx`
