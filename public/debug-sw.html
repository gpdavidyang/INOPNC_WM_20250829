<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Service Worker Debug - INOPNC</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f5f5;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #333;
            margin-bottom: 30px;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
        }
        
        .debug-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
        }
        
        .debug-section h2 {
            margin: 0 0 15px 0;
            color: #555;
            font-size: 18px;
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: 200px 1fr;
            gap: 10px;
            align-items: start;
        }
        
        .info-key {
            font-weight: bold;
            color: #666;
        }
        
        .info-value {
            color: #333;
            font-family: monospace;
            background: #f8f9fa;
            padding: 4px 8px;
            border-radius: 4px;
        }
        
        .status-ok {
            color: #28a745;
        }
        
        .status-warning {
            color: #ffc107;
        }
        
        .status-error {
            color: #dc3545;
        }
        
        .button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        
        .button:hover {
            background: #0056b3;
        }
        
        .log {
            background: #212529;
            color: #ffffff;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 10px;
        }
        
        .log-entry {
            margin: 2px 0;
            opacity: 0.9;
        }
        
        .log-error {
            color: #ff6b6b;
        }
        
        .log-warning {
            color: #ffa500;
        }
        
        .log-success {
            color: #51cf66;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Service Worker Debug Console</h1>
        
        <div class="debug-section">
            <h2>üåç Environment Information</h2>
            <div class="info-grid" id="env-info">
                <!-- Will be populated by JavaScript -->
            </div>
        </div>
        
        <div class="debug-section">
            <h2>‚öôÔ∏è Service Worker Status</h2>
            <div class="info-grid" id="sw-info">
                <!-- Will be populated by JavaScript -->
            </div>
            <div>
                <button class="button" onclick="refreshServiceWorkerInfo()">Refresh SW Info</button>
                <button class="button" onclick="testFetch()">Test Fetch</button>
                <button class="button" onclick="clearAllData()">Clear All</button>
            </div>
        </div>
        
        <div class="debug-section">
            <h2>üì¶ Cache Information</h2>
            <div id="cache-info"></div>
        </div>
        
        <div class="debug-section">
            <h2>üö¶ Network Tests</h2>
            <div id="network-tests">
                <button class="button" onclick="testAuthPageFetch()">Test Auth Page Fetch</button>
                <button class="button" onclick="testApiAuth()">Test Auth API</button>
                <button class="button" onclick="testLoginPage()">Test Login Page</button>
            </div>
        </div>
        
        <div class="debug-section">
            <h2>üìã Debug Log</h2>
            <button class="button" onclick="clearLog()">Clear Log</button>
            <div class="log" id="debug-log"></div>
        </div>
    </div>
    
    <script>
        const log = [];
        
        function addLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const entry = {
                time: timestamp,
                message: message,
                type: type
            };
            
            log.push(entry);
            
            const logContainer = document.getElementById('debug-log');
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            logEntry.textContent = `[${timestamp}] ${message}`;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
            
            console.log(`[DEBUG] ${message}`);
        }
        
        function clearLog() {
            log.length = 0;
            document.getElementById('debug-log').innerHTML = '';
        }
        
        function createInfoRow(key, value, status = 'info') {
            return `
                <div class="info-key">${key}:</div>
                <div class="info-value status-${status}">${value}</div>
            `;
        }
        
        async function populateEnvironmentInfo() {
            const envInfo = document.getElementById('env-info');
            let info = '';
            
            info += createInfoRow('User Agent', navigator.userAgent);
            info += createInfoRow('URL', window.location.href);
            info += createInfoRow('Protocol', window.location.protocol);
            info += createInfoRow('Host', window.location.host);
            info += createInfoRow('Pathname', window.location.pathname);
            info += createInfoRow('Online Status', navigator.onLine ? 'Online' : 'Offline', navigator.onLine ? 'ok' : 'warning');
            info += createInfoRow('Service Worker Support', 'serviceWorker' in navigator ? 'Yes' : 'No', 'serviceWorker' in navigator ? 'ok' : 'error');
            info += createInfoRow('Cache API Support', 'caches' in window ? 'Yes' : 'No', 'caches' in window ? 'ok' : 'error');
            
            envInfo.innerHTML = info;
        }
        
        async function populateServiceWorkerInfo() {
            const swInfo = document.getElementById('sw-info');
            let info = '';
            
            if ('serviceWorker' in navigator) {
                try {
                    const registrations = await navigator.serviceWorker.getRegistrations();
                    info += createInfoRow('Registrations', registrations.length, registrations.length > 0 ? 'warning' : 'ok');
                    
                    registrations.forEach((reg, index) => {
                        info += createInfoRow(`Registration ${index + 1}`, reg.scope);
                        if (reg.active) {
                            info += createInfoRow(`  State`, reg.active.state);
                            info += createInfoRow(`  Script URL`, reg.active.scriptURL);
                        }
                        if (reg.waiting) {
                            info += createInfoRow(`  Waiting`, 'Yes', 'warning');
                        }
                        if (reg.installing) {
                            info += createInfoRow(`  Installing`, 'Yes', 'warning');
                        }
                    });
                    
                    const controller = navigator.serviceWorker.controller;
                    info += createInfoRow('Controller', controller ? controller.scriptURL : 'None');
                    
                } catch (error) {
                    info += createInfoRow('Error', error.message, 'error');
                    addLog(`SW Info Error: ${error.message}`, 'error');
                }
            } else {
                info += createInfoRow('Support', 'Not supported', 'error');
            }
            
            swInfo.innerHTML = info;
        }
        
        async function populateCacheInfo() {
            const cacheInfo = document.getElementById('cache-info');
            
            if ('caches' in window) {
                try {
                    const cacheNames = await caches.keys();
                    let html = `<div class="info-grid">`;
                    html += createInfoRow('Cache Count', cacheNames.length);
                    
                    for (const name of cacheNames) {
                        const cache = await caches.open(name);
                        const keys = await cache.keys();
                        html += createInfoRow(name, `${keys.length} entries`);
                    }
                    
                    html += `</div>`;
                    cacheInfo.innerHTML = html;
                    
                } catch (error) {
                    cacheInfo.innerHTML = `<div class="status-error">Error: ${error.message}</div>`;
                    addLog(`Cache Info Error: ${error.message}`, 'error');
                }
            } else {
                cacheInfo.innerHTML = '<div class="status-error">Cache API not supported</div>';
            }
        }
        
        async function refreshServiceWorkerInfo() {
            addLog('Refreshing Service Worker information...');
            await populateServiceWorkerInfo();
            await populateCacheInfo();
            addLog('Service Worker information refreshed');
        }
        
        async function testFetch() {
            addLog('Testing basic fetch...');
            try {
                const response = await fetch(window.location.href, { 
                    cache: 'no-store',
                    credentials: 'same-origin' 
                });
                addLog(`Fetch test: ${response.status} ${response.statusText}`, 'success');
                addLog(`Response headers: ${JSON.stringify([...response.headers.entries()])}`, 'info');
            } catch (error) {
                addLog(`Fetch test failed: ${error.message}`, 'error');
            }
        }
        
        async function testAuthPageFetch() {
            addLog('Testing auth page fetch...');
            try {
                const response = await fetch('/auth/login', { 
                    cache: 'no-store',
                    credentials: 'same-origin' 
                });
                addLog(`Auth page fetch: ${response.status} ${response.statusText}`, response.ok ? 'success' : 'error');
                addLog(`Response type: ${response.type}`);
                addLog(`Response URL: ${response.url}`);
                
                if (response.headers.get('X-From-Cache')) {
                    addLog('WARNING: Response came from cache!', 'warning');
                }
            } catch (error) {
                addLog(`Auth page fetch failed: ${error.message}`, 'error');
            }
        }
        
        async function testApiAuth() {
            addLog('Testing auth API fetch...');
            try {
                const response = await fetch('/api/auth/session', { 
                    cache: 'no-store',
                    credentials: 'same-origin' 
                });
                addLog(`Auth API fetch: ${response.status} ${response.statusText}`, response.status < 500 ? 'success' : 'error');
            } catch (error) {
                addLog(`Auth API fetch failed: ${error.message}`, 'error');
            }
        }
        
        async function testLoginPage() {
            addLog('Testing login page navigation...');
            window.location.href = '/auth/login';
        }
        
        async function clearAllData() {
            addLog('Clearing all data...');
            
            try {
                // Clear Service Workers
                if ('serviceWorker' in navigator) {
                    const registrations = await navigator.serviceWorker.getRegistrations();
                    for (let registration of registrations) {
                        await registration.unregister();
                        addLog(`Unregistered SW: ${registration.scope}`, 'success');
                    }
                }
                
                // Clear Caches
                if ('caches' in window) {
                    const cacheNames = await caches.keys();
                    for (let name of cacheNames) {
                        await caches.delete(name);
                        addLog(`Deleted cache: ${name}`, 'success');
                    }
                }
                
                // Clear Storage
                localStorage.clear();
                sessionStorage.clear();
                addLog('Cleared localStorage and sessionStorage', 'success');
                
                addLog('All data cleared successfully!', 'success');
                
                setTimeout(() => {
                    window.location.reload();
                }, 2000);
                
            } catch (error) {
                addLog(`Error clearing data: ${error.message}`, 'error');
            }
        }
        
        // Initialize
        window.addEventListener('load', async () => {
            addLog('Debug console initialized');
            await populateEnvironmentInfo();
            await populateServiceWorkerInfo();
            await populateCacheInfo();
        });
        
        // Listen for Service Worker events
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.addEventListener('controllerchange', () => {
                addLog('Service Worker controller changed', 'warning');
                refreshServiceWorkerInfo();
            });
            
            navigator.serviceWorker.addEventListener('message', (event) => {
                addLog(`SW Message: ${JSON.stringify(event.data)}`, 'info');
            });
        }
        
        // Listen for online/offline events
        window.addEventListener('online', () => {
            addLog('Network status: Online', 'success');
            populateEnvironmentInfo();
        });
        
        window.addEventListener('offline', () => {
            addLog('Network status: Offline', 'warning');
            populateEnvironmentInfo();
        });
    </script>
</body>
</html>