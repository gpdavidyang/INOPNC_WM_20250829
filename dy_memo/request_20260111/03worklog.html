<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>ì‘ì—…ì¼ì§€ ê´€ë¦¬ - INOPNC</title>
  
  <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <style>
    /* =================================================================
       [Design System - @site.html ê¸°ë°˜ í†µì¼]
       ================================================================= */
    :root {
      --font-main: "Pretendard Variable", Pretendard, -apple-system, BlinkMacSystemFont, system-ui, Roboto, sans-serif;
      --primary: #31a3fa;           
      --primary-bg: #eaf6ff;        
      --header-navy: #1a254f;
      --navy-dark: #1a254f;
      --navy-btn: #1a254f;
      --text-main: #111111; 
      --text-sub: #475569;
      --text-placeholder: #94a3b8;
      --border: #e2e8f0; 
      --bg-body: #f2f4f6; 
      --bg-surface: #ffffff;
      --bg-input: #ffffff;
      --danger: #ef4444;
      --shadow-soft: 0 4px 20px rgba(0,0,0,0.05);
      --radius-card: 16px;

      /* Status Colors (Worklog Specific) */
      --st-draft-bg: #eff6ff; --st-draft-text: #3b82f6; --st-draft-border: #bfdbfe;     /* ì‘ì„±ì¤‘ (Blue) */
      --st-pending-bg: #eef2ff; --st-pending-text: #6366f1; --st-pending-border: #c7d2fe; /* ìš”ì²­ (Indigo) */
      --st-reject-bg: #fef2f2; --st-reject-text: #dc2626; --st-reject-border: #fecaca;    /* ë°˜ë ¤ (Red) */
      --st-approved-bg: #f8fafc; --st-approved-text: #475569; --st-approved-border: #cbd5e1; /* ì™„ë£Œ (Gray) */
      --st-approved-gray-bg: #f1f5f9; --st-approved-gray-text: #475569; --st-approved-gray-border: #e2e8f0;

      --tag-affil-bg: #e0f2fe; --tag-affil-text: #0284c7; --tag-affil-border: #bae6fd;
      
      --btn-icon-bg: #eff6ff; --btn-icon-border: #dbeafe; --btn-icon-color: #1e3a8a;
    }

    body.dark-mode {
      --primary: #31a3fa; --primary-bg: #1e293b;
      --header-navy: #f1f5f9; --navy-dark: #f1f5f9;
      --text-main: #f1f5f9; --text-sub: #94a3b8;
      --bg-body: #0f172a; --bg-surface: #1e293b; --bg-input: #0f172a;
      --border: #334155; --shadow-soft: none;
      
      --st-draft-bg: #172554; --st-draft-text: #60a5fa; --st-draft-border: #1e40af;
      --st-pending-bg: #312e81; --st-pending-text: #818cf8; --st-pending-border: #3730a3;
      --st-reject-bg: #450a0a; --st-reject-text: #fca5a5; --st-reject-border: #7f1d1d;
      --st-approved-bg: #14532d; --st-approved-text: #bbf7d0; --st-approved-border: #166534;
      
      --tag-affil-bg: #0c4a6e; --tag-affil-text: #7dd3fc; --tag-affil-border: #075985;
    }

    html, body { margin: 0; padding: 0; width: 100%; height: 100%; -webkit-text-size-adjust: 100%; overflow-x: hidden; }
    body { font-family: var(--font-main); font-size: 17px; color: var(--text-main); background-color: var(--bg-body); line-height: 1.5; padding-top: 20px; padding-bottom: 20px; transition: background-color 0.3s, color 0.3s; }
    button, select, input, textarea { font-family: var(--font-main); outline: none; -webkit-tap-highlight-color: transparent; }
    * { box-sizing: border-box; }
    
    .app-wrapper { width: 100%; max-width: 600px; margin: 0 auto; padding: 12px 16px 20px 16px; }

    /* Search Input Optimized */
    .search-input-optimized { width: 100%; height: 54px; border-radius: 12px; background: var(--bg-input); border: 1px solid var(--border); padding: 0 16px; font-size: 17px; color: var(--text-main); font-weight: 500; transition: all 0.2s; box-shadow: var(--shadow-soft); box-sizing: border-box; }
    .search-input-optimized:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(49, 163, 250, 0.15); }
    
    /* ê²€ìƒ‰ì°½ ìŠ¤íƒ€ì¼ ìˆ˜ì • (ìµœì‹ ìˆœ í•„í„°ì™€ ì»¬ëŸ¬ í†µì¼) */
    .site-search-optimized {
        width: 100%;
        height: 54px;
        background: var(--bg-input);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 0 48px 0 16px;
        font-size: 17px;
        font-weight: 500;
        color: var(--text-main);
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        box-sizing: border-box;
    }
    
    /* í¬ì»¤ìŠ¤ ì‹œ: ìµœì‹ ìˆœ í•„í„°ì™€ ë™ì¼í•œ rgba(49, 163, 250, 0.15) ì ìš© */
    .site-search-optimized:focus {
        border-color: var(--primary) !important;
        box-shadow: 0 0 0 3px rgba(49, 163, 250, 0.15) !important;
        transform: translateY(-1px);
        outline: none;
    }
    
    /* í˜¸ë²„ ì‹œ: í…Œë‘ë¦¬ ìƒ‰ìƒë„ Primary í†¤ìœ¼ë¡œ ë³€ê²½ */
    .site-search-optimized:hover:not(:focus) {
        border-color: rgba(49, 163, 250, 0.5);
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }
    
    /* ê²€ìƒ‰ì°½ ì§€ìš°ê¸° ë²„íŠ¼ */
    .clear-button {
        position: absolute; right: 40px; top: 50%; transform: translateY(-50%);
        background: #e2e8f0; border: none; border-radius: 50%;
        width: 20px; height: 20px; display: flex; align-items: center;
        justify-content: center; cursor: pointer; font-size: 12px; color: #64748b;
    }
    
    /* ë“œë¡­ë‹¤ìš´ ìŠ¤íƒ€ì¼ */
    .site-dropdown-optimized {
        position: absolute; z-index: 50; width: 100%; margin-top: 6px;
        max-height: 240px; overflow-y: auto; background: var(--bg-surface);
        border: 1px solid var(--border); border-radius: 12px;
        box-shadow: 0 10px 25px rgba(0,0,0,0.1); display: none;
    }
    .site-dropdown-optimized.show { display: block; }
    .site-dropdown-item {
        padding: 14px 16px; border-bottom: 1px solid var(--border); 
        cursor: pointer; transition: background-color 0.2s;
    }
    .site-dropdown-item:hover {
        background: var(--bg-input);
    }

    @keyframes inopnc-shake {
        0% { transform: translateX(0); }
        20% { transform: translateX(-6px); }
        40% { transform: translateX(6px); }
        60% { transform: translateX(-4px); }
        80% { transform: translateX(4px); }
        100% { transform: translateX(0); }
    }

    /* ë¯¸ë””ì–´ ìŠ¤í¬ë¡¤ ìŠ¤íƒ€ì¼ (@list.html) */
    .media-scroll { 
        display: flex; 
        gap: 10px; 
        overflow-x: auto; 
        padding-bottom: 12px; 
        scrollbar-width: thin;
        scrollbar-color: rgba(148, 163, 184, 0.5) transparent;
    }
    .media-scroll::-webkit-scrollbar { 
        height: 6px;
        display: block;
    }
    .media-scroll::-webkit-scrollbar-track {
        background: transparent;
        border-radius: 10px;
    }
    .media-scroll::-webkit-scrollbar-thumb {
        background: rgba(148, 163, 184, 0.5);
        border-radius: 10px;
    }
    .media-scroll::-webkit-scrollbar-thumb:hover {
        background: rgba(148, 163, 184, 0.8);
    }
    .media-add-btn { min-width: 90px; height: 90px; border-radius: 10px; border: 1px dashed var(--primary); background: #f0f9ff; color: var(--primary); display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 4px; font-size: 11px; font-weight: 700; cursor: pointer; flex-shrink: 0; }
    .media-obj { position: relative; min-width: 90px; height: 90px; border-radius: 10px; overflow: hidden; border: 1px solid var(--border); flex-shrink: 0; }
    .media-obj img { width: 100%; height: 100%; object-fit: cover; }
    .media-tag { position: absolute; bottom: 0; left: 0; right: 0; background: rgba(0,0,0,0.6); color: #fff; font-size: 10px; text-align: center; padding: 4px 0; cursor: pointer; transition:0.2s; }
    .media-tag.before { background: #ef4444; } /* ë³´ìˆ˜ì „ (Red) */
    .media-tag.after { background: var(--primary); } /* ë³´ìˆ˜í›„ (Blue) */

    /* í™•ì¸ì„œ ìŠ¤íƒ€ì¼ */
    .cert-list { display: flex; align-items: center; justify-content: space-between; padding: 12px; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; }
    
    /* Mainpage ìŠ¤íƒ€ì¼ ì¶”ê°€ */
    .material-select {
        width: 100%;
        height: 54px;
        background: var(--bg-input);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 0 16px;
        font-size: 17px;
        outline: none;
        color: var(--text-main);
        box-sizing: border-box;
    }
    .material-select:focus {
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(49, 163, 250, 0.15);
    }
    
    .inopnc-invalid {
        border-color: var(--danger) !important;
        box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.15) !important;
        outline: 2px solid rgba(239, 68, 68, 0.35);
        animation: inopnc-shake 0.35s;
    }
    
    /* A4/Signature Styles - @pworklog.html ë™ì¼ */
    .a4-page { width: 794px; min-height: 1123px; background: #fff; padding: 40px; box-sizing: border-box; color: #000; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
    .cert-title { font-size: 32px; font-weight: 900; text-align: center; border-bottom: 3px double #000; padding-bottom: 10px; margin-bottom: 20px; }
    .info-table { width: 100%; border-collapse: collapse; margin-bottom: 15px; }
    .info-table th, .info-table td { border: 1px solid #000; padding: 8px; font-size: 14px; }
    .info-table th { background: #f2f2f2; width: 15%; }
    .sign-grid { display: grid; grid-template-columns: 1fr 1fr; border: 1px solid #000; margin-top: 20px; height: 120px; }
    .sign-box { border-left: 1px solid #000; position: relative; }
    .sign-box canvas { width: 100%; height: 100%; }

    /* ì—…ë¡œë“œ/ì¶”ê°€ ë²„íŠ¼ ìŠ¤íƒ€ì¼ (@pworklog3 í†µì¼) */
    .btn-upload-dashed { 
        width: 100%; 
        height: 54px; 
        border: 1px dashed var(--primary); 
        background: rgba(49, 163, 250, 0.04); 
        color: var(--primary); 
        border-radius: 12px; 
        font-weight: 700; 
        font-size: 15px;
        display: flex; 
        align-items: center; 
        justify-content: center; 
        gap: 8px; 
        cursor: pointer;
        transition: all 0.2s;
        box-sizing: border-box;
    }
    .btn-upload-dashed:hover {
        background: rgba(49, 163, 250, 0.08);
        border-color: #0284c7;
    }
    .btn-upload-dashed:active {
        transform: scale(0.98);
    }

    /* customMaterialValue í¬ì»¤ìŠ¤ ìŠ¤íƒ€ì¼ */
    input[id*="customMaterial"]:focus,
    input.customMaterialValue:focus {
        border-color: var(--primary) !important;
        background-color: rgba(49, 163, 250, 0.05) !important;
        box-shadow: 0 0 0 3px rgba(49, 163, 250, 0.15) !important;
    }
    
    /* ìì¬ ì„ íƒë°•ìŠ¤ CSS (mainpageì™€ ë™ì¼) */
    .material-select {
        appearance: none;
        -webkit-appearance: none;
        width: 100%;
        height: 54px;
        background-color: var(--bg-input);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 0 40px 0 16px;
        font-family: var(--font-main);
        font-size: 17px;
        font-weight: 500;
        color: var(--text-main);
        transition: all 0.2s;
        position: relative;
        cursor: pointer;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%236b7280' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 14px center;
        box-sizing: border-box;
    }
    .material-select:focus {
        border-color: var(--primary) !important;
        box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.15) !important;
        outline: none;
    }
    
    /* ì‘ì—…ì ì„ íƒë°•ìŠ¤ í™”ì‚´í‘œ ë° ì´ë²¤íŠ¸ íš¨ê³¼ (@main.html ë™ì¼) */
    .worker-select {
        appearance: none;
        -webkit-appearance: none;
        width: 100%;
        height: 54px;
        background: var(--bg-input);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 0 40px 0 16px;
        font-family: var(--font-main);
        font-size: 17px;
        font-weight: 600;
        color: var(--text-main);
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        cursor: pointer;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23475569' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='m6 9 6 6 6-6'%3E%3C/path%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 14px center;
        background-size: 16px;
    }
    
    .worker-select:focus {
        border-color: var(--primary) !important;
        box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.15) !important;
        transform: translateY(-1px);
        outline: none;
    }
    
    .worker-select:hover:not(:focus) {
        border-color: rgba(14, 165, 233, 0.5);
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    /* ë¦¬ìŠ¤íŠ¸ ë°•ìŠ¤ ì•„ì´í…œ (pworklog3ì™€ ë™ì¼) */
    .list-box-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        background: #ffffff;
        border: 1px solid var(--border);
        padding: 16px;
        border-radius: 12px;
        margin-bottom: 12px;
        cursor: pointer;
    }
    .list-box-left {
        display: flex;
        align-items: center;
        gap: 12px;
        flex: 1;
        min-width: 0;
    }
    .list-box-icon {
        color: #94a3b8;
        width: 24px;
    }
    .list-box-title {
        font-size: 16px;
        font-weight: 700;
        color: var(--text-main);
        margin-bottom: 2px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 200px;
    }
    .list-box-sub {
        font-size: 13px;
        color: var(--text-placeholder);
    }
    .btn-cert-create {
        width: 100%;
        height: 54px;
        background: var(--header-navy);
        color: #fff;
        border-radius: 12px;
        border: none;
        font-weight: 700;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        margin-top: 8px;
        cursor: pointer;
        box-shadow: 0 2px 8px rgba(26, 37, 79, 0.2);
        box-sizing: border-box;
    }
    .btn-cert-create[disabled] {
        opacity: 0.5;
        cursor: not-allowed;
    }

    /* ê²€ìƒ‰ì°½ X ë²„íŠ¼ ë° ë“œë¡­ë‹¤ìš´ ìŠ¤íƒ€ì¼ (@money2 ë™ì¼) */
    .clear-button {
        position: absolute;
        right: 40px;
        top: 50%;
        transform: translateY(-50%);
        background: #e2e8f0;
        border: none;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 12px;
        color: #64748b;
        z-index: 10;
        transition: all 0.2s;
    }
    .clear-button:hover {
        background: #cbd5e1;
        color: #475569;
    }
    
    .site-dropdown-optimized {
        position: absolute;
        z-index: 50;
        width: 100%;
        margin-top: 6px;
        max-height: 240px;
        overflow-y: auto;
        background: var(--bg-surface);
        border: 1px solid var(--border);
        border-radius: 12px;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        display: none;
        animation: dropdownSlide 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .site-dropdown-optimized.show {
        display: block;
    }
    @keyframes dropdownSlide {
        from { opacity: 0; transform: translateY(-10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    .site-dropdown-item {
        padding: 14px 16px;
        border-bottom: 1px solid var(--border);
        cursor: pointer;
        color: var(--text-main);
        transition: background-color 0.2s;
        font-size: 15px;
        font-weight: 500;
    }
    .site-dropdown-item:hover {
        background: var(--bg-body);
    }
    .site-dropdown-item:last-child {
        border-bottom: none;
    }

    /* =========================================
       [í†µì¼ëœ ìŠ¤íƒ€ì¼] í•„í„° ì…€ë ‰íŠ¸ ë°•ìŠ¤
       ========================================= */
    .custom-select {
        appearance: none;
        -webkit-appearance: none;
        /* í™”ì‚´í‘œ ì•„ì´ì½˜ (ê¸°ì¡´ ìƒ‰ìƒ #475569 ìœ ì§€) */
        background-image: url("data:image/svg+xml;charset=UTF-8,%3Csvg xmlns=%27http://www.w3.org/2000/svg%27 width=%2716%27 height=%2716%27 viewBox=%270 0 24 24%27 fill=%27none%27 stroke=%27%23475569%27 stroke-width=%272%27 stroke-linecap=%27round%27 stroke-linejoin=%27round%27%3E%3Cpath d=%27m6 9 6 6 6-6%27%3E%3C/path%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 12px center;
        padding-right: 36px; /* í…ìŠ¤íŠ¸ ê²¹ì¹¨ ë°©ì§€ */
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }

    /* í¬ì»¤ìŠ¤ íš¨ê³¼ (ë‹¤ë¥¸ í˜ì´ì§€ì™€ ë™ì¼í•œ ìƒ‰ìƒ/ê·¸ë¦¼ì) */
    .custom-select:focus {
        border-color: var(--primary) !important;
        box-shadow: 0 0 0 3px rgba(49, 163, 250, 0.15) !important;
        transform: translateY(-1px);
        outline: none;
    }

    /* í˜¸ë²„ íš¨ê³¼ */
    .custom-select:hover:not(:focus) {
        border-color: rgba(49, 163, 250, 0.5);
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    /* sortFilter select í˜¸ë²„ íš¨ê³¼ */
    #sortFilter:hover:not(:focus) {
        border-color: rgba(49, 163, 250, 0.5);
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    /* sortFilter select í¬ì»¤ìŠ¤ íš¨ê³¼ */
    #sortFilter:focus {
        border-color: var(--primary) !important;
        box-shadow: 0 0 0 3px rgba(49, 163, 250, 0.15) !important;
        transform: translateY(-1px);
        outline: none;
    }

    /* í•„í„° ì„¹ì…˜: ë¶€ëª¨ì˜ íŒ¨ë”©ì„ ë¬´ì‹œí•˜ê³  ì–‘ ëìœ¼ë¡œ í™•ì¥ */
    .filter-section { 
        margin-left: -16px;  /* wrapperì˜ padding-left ìƒì‡„ */
        margin-right: -16px; /* wrapperì˜ padding-right ìƒì‡„ */
        margin-bottom: 16px; 
        overflow: hidden; 
    }

    /* ìŠ¤í¬ë¡¤ í–‰: ì‹¤ì œ ìŠ¤í¬ë¡¤ì´ ì¼ì–´ë‚˜ëŠ” ì˜ì—­ */
    .filter-row-scroll { 
        display: flex; 
        flex-wrap: nowrap; 
        gap: 6px;           /* ì¹© ì‚¬ì´ ê°„ê²© */
        overflow-x: auto; 
        padding: 0 16px 4px 16px; /* ì¢Œìš° 16px íŒ¨ë”©ìœ¼ë¡œ ë‚´ë¶€ ì •ë ¬ ìœ ì§€ */
        scrollbar-width: none; 
        -ms-overflow-style: none; /* IE/Edge ìŠ¤í¬ë¡¤ë°” ìˆ¨ê¹€ */
    }

    .filter-row-scroll::-webkit-scrollbar {
        display: none; /* Chrome/Safari ìŠ¤í¬ë¡¤ë°” ìˆ¨ê¹€ */
    }
    .filter-chip { height: 38px; padding: 0 11px; background-color: var(--bg-surface); border: 1px solid var(--border); border-radius: 100px; color: var(--text-sub); font-size: 14px; font-weight: 500; cursor: pointer; transition: all 0.2s; white-space: nowrap; flex-shrink: 0; box-shadow: 0 1px 2px rgba(0,0,0,0.02); }
    
    /* Chip Active States - Matching Badge Colors */
    .filter-chip.status-all.active { background-color: var(--primary); border-color: var(--primary); color: white; font-weight: 700; box-shadow: 0 2px 8px rgba(49, 163, 250, 0.15); }
    .filter-chip.status-draft.active { background-color: #3b82f6; border-color: #3b82f6; color: white; font-weight: 700; box-shadow: 0 2px 8px rgba(59, 130, 246, 0.15); }
    .filter-chip.status-pending.active { background-color: #6366f1; border-color: #6366f1; color: white; font-weight: 700; box-shadow: 0 2px 8px rgba(99, 102, 241, 0.25); }
    .filter-chip.status-reject.active { background-color: #dc2626; border-color: #dc2626; color: white; font-weight: 700; box-shadow: 0 2px 8px rgba(220, 38, 38, 0.15); }
    .filter-chip.status-approved.active { background-color: #64748b; border-color: #64748b; color: white; font-weight: 700; box-shadow: 0 2px 8px rgba(100, 116, 139, 0.15); }
    
    .btn-add-chip { border: 1.5px solid var(--primary) !important; background: var(--primary-bg); color: var(--primary); padding: 0 11px; height: 38px; border-radius: 12px; font-size: 13px; font-weight: 800; cursor: pointer; display: flex; align-items: center; gap: 4px; transition: all 0.2s; white-space: nowrap; flex-shrink: 0; position: relative; overflow: hidden; }
    .btn-add-chip::before { content: ''; position: absolute; top: 50%; left: 50%; width: 0; height: 0; border-radius: 50%; background: rgba(255, 255, 255, 0.5); transform: translate(-50%, -50%); transition: width 0.6s, height 0.6s; }
    .btn-add-chip:active::before { width: 300px; height: 300px; }
    .btn-add-chip:active { transform: scale(0.95); }

    #modalManpowerList .grid {
    display: grid !important;
    grid-template-columns: minmax(0, 1.05fr) minmax(0, 0.95fr) auto !important; /* ì´ë¦„ : ê³µìˆ˜ : ì‚­ì œ ë²„íŠ¼ ì •ë°€ ë¹„ìœ¨ */
    align-items: center;
}

    /* ëª¨ë‹¬ ì…ë ¥ í•„ë“œ ë°°ê²½ìƒ‰ í†µì¼ */
    #modalManpowerList input, #modalManpowerList select {
        background-color: #ffffff !important;
    }

    /* ì„ íƒë°•ìŠ¤ í™”ì‚´í‘œ ìŠ¤íƒ€ì¼ í†µì¼ */
    .material-select {
        appearance: none;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%236b7280' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E") !important;
        background-repeat: no-repeat !important;
        background-position: right 12px center !important;
    }

    /* Status Badge Styles */
    .status-badge { 
        display: inline-flex; 
        align-items: center; 
        justify-content: center; 
        font-size: 14px; 
        font-weight: 700; 
        padding: 0 14px; 
        border-radius: 12px; 
        height: 32px;
        white-space: nowrap;
        border: none;
        cursor: pointer;
        transition: all 0.2s;
        gap: 4px;
    }
    .status-badge.draft { 
        background: #e0f2fe; 
        color: #0284c7; 
        border: none; 
    }
    .status-badge.pending { 
        background: #f3e8ff; 
        color: #9333ea; 
        border: none; 
    }
    .status-badge.approved { 
        background: #f1f5f9; 
        color: #475569; 
        border: none; 
    }
    .status-badge.reject { 
        background: #fef2f2; 
        color: #dc2626; 
        border: none; 
    }

    /* Summary Grid */
    .summary-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-bottom: 20px; }
    .sum-card { background: var(--bg-surface); border-radius: 12px; padding: 12px 4px; display: flex; flex-direction: column; align-items: center; justify-content: center; box-shadow: var(--shadow-soft); border: 1px solid transparent; cursor: pointer; transition: 0.1s; position:relative; overflow:hidden;}
    .sum-card:active { transform: scale(0.98); opacity: 0.8; }
    .sum-val { font-size: 20px; font-weight: 800; line-height: 1.2; margin-bottom: 2px; }
    .sum-label { font-size: 12px; font-weight: 600; color: var(--text-sub); }

    /* Site Card Style */
    .site-card { background: var(--bg-surface); border: none; box-shadow: var(--shadow-soft); border-radius: var(--radius-card); padding: 0; overflow: visible; transition: all 0.2s; margin-bottom: 16px; position: relative; cursor: pointer; }
    .site-card:active { transform: scale(0.98); }
    .site-card.pinned-item { border: 2px solid var(--primary); box-shadow: 0 4px 12px rgba(49, 163, 250, 0.2); position: relative; }
    .site-card.pinned-item::before { content: ''; position: absolute; top: -2px; left: -2px; right: -2px; bottom: -2px; border-radius: 14px; background: linear-gradient(135deg, rgba(49, 163, 250, 0.1), rgba(49, 163, 250, 0.05)); z-index: -1; pointer-events: none; }
    
    /* Reject Card Style - ë°˜ë ¤ ìƒíƒœ ê°•ì¡° */
    .site-card.reject-item { border: 1px solid rgba(220, 38, 38, 0.2); box-shadow: 0 2px 8px rgba(220, 38, 38, 0.15); }
    .site-card.reject-item::before { content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0; border-radius: var(--radius-card); background: linear-gradient(135deg, rgba(220, 38, 38, 0.03), rgba(220, 38, 38, 0.01)); z-index: -1; pointer-events: none; }
    
    /* ë°˜ë ¤ UI ê°•í™” - í‚¤ì›Œë“œ ê¸°ë°˜ ì„¹ì…˜ ê°•ì¡° */
    .reject-highlight-photo { border: 2px solid #dc2626 !important; box-shadow: 0 0 0 4px rgba(220, 38, 38, 0.1) !important; animation: rejectPulse 2s infinite; }
    .reject-highlight-manpower { border: 2px solid #dc2626 !important; box-shadow: 0 0 0 4px rgba(220, 38, 38, 0.1) !important; animation: rejectPulse 2s infinite; }
    .reject-highlight-workset { border: 2px solid #dc2626 !important; box-shadow: 0 0 0 4px rgba(220, 38, 38, 0.1) !important; animation: rejectPulse 2s infinite; }
    .reject-highlight-material { border: 2px solid #dc2626 !important; box-shadow: 0 0 0 4px rgba(220, 38, 38, 0.1) !important; animation: rejectPulse 2s infinite; }
    .reject-highlight-drawing { border: 2px solid #dc2626 !important; box-shadow: 0 0 0 4px rgba(220, 38, 38, 0.1) !important; animation: rejectPulse 2s infinite; }
    
    @keyframes rejectPulse {
        0%, 100% { box-shadow: 0 0 0 4px rgba(220, 38, 38, 0.1); }
        50% { box-shadow: 0 0 0 8px rgba(220, 38, 38, 0.05); }
    }
    
    .card-header-main { padding: 20px 22px; position: relative; }
    .site-date { font-size: 15px; color: var(--text-sub); font-weight: 500; margin-bottom: 4px; display:flex; align-items:center; gap:6px; }
    .site-top-row { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; }
    .site-name-text { font-size: 20px; font-weight: 800; color: var(--navy-dark); flex: 1; line-height: 1.3; margin-right: 10px; word-break: keep-all; white-space: normal; display: -webkit-box; -webkit-line-clamp: 2; line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
    
    /* ë°˜ë ¤ ì¹´ë“œ í„ìŠ¤ íš¨ê³¼ */
    .reject-pulse {
        animation: rejectCardPulse 3.5s ease-in-out;
        border: 2px solid #dc2626 !important;
        background: linear-gradient(135deg, #fff1f2 0%, #fef2f2 100%) !important;
    }
    
    .reject-highlight {
        box-shadow: 0 0 25px rgba(220, 38, 38, 0.5) !important;
        transform: scale(1.02) !important;
        transition: all 0.3s ease !important;
    }
    
    @keyframes rejectCardPulse {
        0% { 
            transform: scale(1); 
            box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.7);
        }
        25% { 
            transform: scale(1.02); 
            box-shadow: 0 0 20px rgba(220, 38, 38, 0.4);
        }
        50% { 
            transform: scale(1.01); 
            box-shadow: 0 0 30px rgba(220, 38, 38, 0.3);
        }
        75% { 
            transform: scale(1.015); 
            box-shadow: 0 0 20px rgba(220, 38, 38, 0.2);
        }
        100% { 
            transform: scale(1); 
            box-shadow: 0 0 0 0 rgba(220, 38, 38, 0);
        }
    }
    
    /* [ìµœì í™”] ìˆ˜ì • í•„ìš” í•­ëª©: Shake ì• ë‹ˆë©”ì´ì…˜ íš¨ê³¼ */
    .reject-effect {
        animation: shake-hard 0.4s ease-in-out, flash-red 0.8s ease-in-out;
        border-color: #ef4444 !important; /* ì• ë‹ˆë©”ì´ì…˜ í›„ì—ë„ ë¶‰ì€ìƒ‰ ìœ ì§€ */
        position: relative;
        transition: all 0.3s ease;
    }

    .reject-effect:hover {
        transform: translateY(-2px);
        animation-play-state: paused; /* í˜¸ë²„ ì‹œ ì• ë‹ˆë©”ì´ì…˜ ì¼ì‹œì •ì§€ */
    }

    /* ì¢Œìš°ë¡œ í”ë“¤ë¦¬ëŠ” ì• ë‹ˆë©”ì´ì…˜ (0.4ì´ˆ) */
    @keyframes shake-hard {
        0%, 100% { transform: translateX(0); }
        10%, 30%, 50%, 70%, 90% { transform: translateX(-4px); }
        20%, 40%, 60%, 80% { transform: translateX(4px); }
    }

    /* ë¶‰ì€ìƒ‰ ê¹œë¹¡ì„ íš¨ê³¼ */
    @keyframes flash-red {
        0%, 100% { border-color: var(--border); background-color: #f8fafc; }
        50% { border-color: #ef4444; background-color: #fef2f2; }
    }

    /* ë°˜ë ¤ ì‚¬ìœ  í…ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ */
    .reject-msg {
        color: #ef4444;
        font-size: 13px;
        font-weight: 700;
        margin-top: 6px;
        display: flex;
        align-items: center;
        gap: 4px;
        animation: slideDown 0.2s ease-out;
    }

    @keyframes slideDown {
        from { opacity: 0; transform: translateY(-10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    /* ì¹´ë“œ ë ˆë²¨ ë°˜ë ¤ íš¨ê³¼ */
    .reject-highlight-card {
        border: 2px solid #dc2626 !important;
        background-color: #fff1f2 !important;
        box-shadow: 0 0 15px rgba(220, 38, 38, 0.3) !important;
        animation: card-reject-pulse 2s ease-in-out;
    }
    
    @keyframes card-reject-pulse {
        0% { 
            transform: scale(1); 
            box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.4);
        }
        50% { 
            transform: scale(1.02); 
            box-shadow: 0 0 20px rgba(220, 38, 38, 0.4);
        }
        100% { 
            transform: scale(1); 
            box-shadow: 0 0 0 0 rgba(220, 38, 38, 0);
        }
    }
    
    /* ìŠ¹ì¸ë˜ì–´ ìˆ˜ì •ì´ ë¶ˆê°€ëŠ¥í•œ ë°ì´í„° (ì ê¸ˆ) */
    .data-locked {
        background-color: #f8fafc !important;
        border: 1px solid #e2e8f0 !important;
        opacity: 0.7;
        pointer-events: none !important;
        position: relative;
    }
    .data-locked::after {
        content: 'ğŸ”’ ìŠ¹ì¸ë¨';
        position: absolute;
        top: 8px;
        right: 12px;
        font-size: 11px;
        font-weight: 700;
        color: #64748b;
        background: white;
        padding: 2px 6px;
        border-radius: 10px;
        border: 1px solid #e2e8f0;
    }

    /* ìŠ¤í¬ë¡¤ í–‰: ì‹¤ì œ ìŠ¤í¬ë¡¤ì´ ì¼ì–´ë‚˜ëŠ” ì˜ì—­ */
    .filter-row-scroll { 
        display: flex; 
        flex-wrap: nowrap; 
        gap: 6px;           /* ì¹© ì‚¬ì´ ê°„ê²© */
        overflow-x: auto; 
        padding: 0 16px 4px 16px; /* ì¢Œìš° 16px íŒ¨ë”©ìœ¼ë¡œ ë‚´ë¶€ ì •ë ¬ ìœ ì§€ */
        scrollbar-width: none; 
        -ms-overflow-style: none; /* IE/Edge ìŠ¤í¬ë¡¤ë°” ìˆ¨ê¹€ */
    }

    .filter-row-scroll::-webkit-scrollbar {
        display: none; /* Chrome/Safari ìŠ¤í¬ë¡¤ë°” ìˆ¨ê¹€ */
    }
        .filter-chip { height: 38px; padding: 0 11px; background-color: var(--bg-surface); border: 1px solid var(--border); border-radius: 100px; color: var(--text-sub); font-size: 14px; font-weight: 500; cursor: pointer; transition: all 0.2s; white-space: nowrap; flex-shrink: 0; box-shadow: 0 1px 2px rgba(0,0,0,0.02); }
        
        /* Chip Active States - Matching Badge Colors */
        .filter-chip.status-all.active { background-color: var(--primary); border-color: var(--primary); color: white; font-weight: 700; box-shadow: 0 2px 8px rgba(49, 163, 250, 0.15); }
        .filter-chip.status-draft.active { background-color: #3b82f6; border-color: #3b82f6; color: white; font-weight: 700; box-shadow: 0 2px 8px rgba(59, 130, 246, 0.15); }
        .filter-chip.status-pending.active { background-color: #6366f1; border-color: #6366f1; color: white; font-weight: 700; box-shadow: 0 2px 8px rgba(99, 102, 241, 0.25); }
        .filter-chip.status-reject.active { background-color: #dc2626; border-color: #dc2626; color: white; font-weight: 700; box-shadow: 0 2px 8px rgba(220, 38, 38, 0.15); }
        .filter-chip.status-approved.active { background-color: #64748b; border-color: #64748b; color: white; font-weight: 700; box-shadow: 0 2px 8px rgba(100, 116, 139, 0.15); }
        
        .btn-add-chip { border: 1.5px solid var(--primary) !important; background: var(--primary-bg); color: var(--primary); padding: 0 11px; height: 38px; border-radius: 12px; font-size: 13px; font-weight: 800; cursor: pointer; display: flex; align-items: center; gap: 4px; transition: all 0.2s; white-space: nowrap; flex-shrink: 0; position: relative; overflow: hidden; }
        .btn-add-chip::before { content: ''; position: absolute; top: 50%; left: 50%; width: 0; height: 0; border-radius: 50%; background: rgba(255, 255, 255, 0.5); transform: translate(-50%, -50%); transition: width 0.6s, height 0.6s; }
        .btn-add-chip:active::before { width: 300px; height: 300px; }
        .btn-add-chip:active { transform: scale(0.95); }

    /* ìŠ¹ì¸ ì™„ë£Œ ì•„ì´ì½˜ íš¨ê³¼ */
    .data-approved-locked::after {
        content: 'âœ“ ìŠ¹ì¸ë¨';
        position: absolute;
        top: 12px;
        right: 16px;
        font-size: 12px;
        font-weight: 800;
        color: #16a34a;
        background: white;
        padding: 4px 10px;
        border-radius: 20px;
        border: 1px solid #bbf7d0;
        z-index: 10;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    /* ìˆ˜ì •ì´ í•„ìš”í•œ ì„¹ì…˜ ê°•ì¡° (í„ìŠ¤ ì• ë‹ˆë©”ì´ì…˜) */
    .reject-field-focus {
        border: 2px solid #ef4444 !important;
        background-color: #fff1f2 !important;
        animation: reject-pulse-modal 1.5s infinite;
    }

    @keyframes reject-pulse-modal {
        0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); }
        70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
        100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
    }

    .edit-required-tag {
        display: inline-flex;
        align-items: center;
        background: #dc2626;
        color: white;
        padding: 2px 8px;
        border-radius: 6px;
        font-size: 11px;
        font-weight: 800;
        margin-left: 8px;
    }
    
    /* ë°˜ë ¤ ì‚¬ìœ  ì•Œë¦¼ ì¹´ë“œ í„ìŠ¤ íš¨ê³¼ */
    @keyframes rejectReasonPulse {
        0%, 100% { 
            box-shadow: 0 4px 20px rgba(220, 38, 38, 0.25), 0 0 0 4px rgba(220, 38, 38, 0.1);
        }
        50% { 
            box-shadow: 0 4px 25px rgba(220, 38, 38, 0.35), 0 0 0 6px rgba(220, 38, 38, 0.15);
        }
    }
    
    /* ë°˜ë ¤ì‚¬ìœ  ì¹´ë“œ ì•Œë¦¼ íš¨ê³¼ */
    .reject-reason-highlight {
        border: 2px solid #dc2626 !important;
        box-shadow: 0 0 0 4px rgba(220, 38, 38, 0.1), 0 4px 12px rgba(220, 38, 38, 0.15) !important;
        background: linear-gradient(135deg, #fff1f2, #fef2f2) !important;
        animation: rejectReasonPulse 2s ease-in-out;
        position: relative;
    }
    
    .reject-reason-highlight::before {
        content: 'ğŸ”´ ë°˜ë ¤ì‚¬ìœ  í™•ì¸';
        position: absolute;
        top: -12px;
        right: 10px;
        background: #dc2626;
        color: white;
        padding: 6px 12px;
        border-radius: 16px;
        font-size: 12px;
        font-weight: 700;
        z-index: 10;
        box-shadow: 0 2px 8px rgba(220, 38, 38, 0.3);
        animation: slideInDown 0.3s ease;
    }
    
    @keyframes rejectReasonPulse {
        0% { 
            transform: scale(1);
            box-shadow: 0 0 0 4px rgba(220, 38, 38, 0.1), 0 4px 12px rgba(220, 38, 38, 0.15);
        }
        50% { 
            transform: scale(1.02);
            box-shadow: 0 0 0 8px rgba(220, 38, 38, 0.05), 0 6px 16px rgba(220, 38, 38, 0.25);
        }
        100% { 
            transform: scale(1);
            box-shadow: 0 0 0 4px rgba(220, 38, 38, 0.1), 0 4px 12px rgba(220, 38, 38, 0.15);
        }
    }
    
    @keyframes slideInDown {
        from {
            transform: translateY(-10px);
            opacity: 0;
        }
        to {
            transform: translateY(0);
            opacity: 1;
        }
    }
    
    /* ì‘ì—…ë‚´ìš© í…ìŠ¤íŠ¸ - @site.html addr-text ìŠ¤íƒ€ì¼ ë™ì¼ ì ìš© */
    .work-text-summary {
        display: flex;
        align-items: flex-start;
        gap: 6px;
        flex: 1;
        overflow: visible;
        font-size: 16px;
        color: var(--text-sub);
        font-weight: 700;
        margin-top: 6px;
    }
    
    .ver-badge-card {
        background: var(--primary);
        color: #fff;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 800;
        margin-left: 6px;
        flex-shrink: 0;
    }
    
    /* Badges */
    .site-badge { position: absolute; top: 0; right: 0; z-index: 20; font-size: 13px; font-weight: 700; padding: 6px 14px; border-radius: 0 12px 0 12px; border: 1px solid transparent; display: inline-flex; align-items: center; justify-content: center; white-space: nowrap; line-height: 1; color: #ffffff; box-shadow: none; }
    .site-badge.bdg-draft { background: #3b82f6; border-color: #60a5fa; }
    .site-badge.bdg-pending { background: var(--st-pending-text); border-color: var(--st-pending-text); color: #ffffff; }
    .site-badge.bdg-reject { background: #dc2626; border-color: #dc2626; color: #ffffff; }
    
    .site-card.reject-card { box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.15); animation: rejectCardPulse 2s infinite; }
    
    @keyframes rejectCardPulse {
        0%, 100% { box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.15); }
        50% { box-shadow: 0 0 0 8px rgba(220, 38, 38, 0); }
    }
    .site-badge.bdg-approved { background: #64748b; border-color: #94a3b8; }

    .site-sub-info { display: flex; align-items: center; justify-content: space-between; width: 100%; margin-bottom: 12px; }
    .site-sub-left { display: flex; gap: 6px; align-items: center; flex-wrap: wrap; min-width: 0; }
    .sub-badge { font-size: 14px; padding: 0 10px; height: 28px; border-radius: 6px; border: 1px solid transparent; display: flex; align-items: center; gap: 6px; font-weight: 700; }
    .sub-badge.dept { background: var(--tag-affil-bg); color: var(--tag-affil-text); border-color: var(--tag-affil-border); }
    
    .indicator-group { display: flex; gap: 8px; align-items: center; padding-left: 10px; margin-left: 4px; border-left: 1px solid var(--border); }
    .data-icon-wrap { display: flex; align-items: center; gap: 3px; font-size: 13px; font-weight: 600; color: #cbd5e1; }
    .data-icon-wrap.active { color: var(--navy-dark); }
    .data-icon-wrap.active .icon-svg { color: var(--navy-dark); }
    .data-icon-wrap .count-num { color: #31a3fa; font-weight: 700; margin-left: 2px; }
    .icon-svg { width: 16px; height: 16px; transition: all 0.2s; }

    /* Manpower & History Row */
    .bottom-info-row { display: flex; align-items: center; justify-content: space-between; padding-top: 12px; border-top: 1px dashed var(--border); font-size: 14px; }
    .manpower-info { display: flex; align-items: center; gap: 6px; color: var(--text-main); font-weight: 600; }
    .history-info { display: flex; align-items: center; gap: 4px; color: var(--text-sub); font-size: 13px; }

    /* Load More & Layout */
    .btn-load-more { width: 100%; height: 54px; background: var(--bg-surface); border: 1px solid var(--border); border-radius: 100px; color: var(--text-sub); font-weight: 600; font-size: 15px; cursor: pointer; margin-top: 10px; display: flex; align-items: center; justify-content: center; gap: 6px; transition: 0.2s; box-sizing: border-box; }
    .btn-load-more:hover { background: var(--bg-body); }
    .btn-star { background: none; border: none; padding: 4px; color: var(--border); transition: 0.2s; cursor: pointer; display: flex; align-items: center; }
    .btn-star.active { color: var(--primary); fill: var(--primary); }
    .btn-star:active { transform: scale(0.95); opacity: 0.8; }
    
    .site-card.pinned-item { border: 2px solid var(--primary); box-shadow: 0 4px 12px rgba(49, 163, 250, 0.2); position: relative; }
    .site-card.pinned-item::before { content: ''; position: absolute; top: -2px; left: -2px; right: -2px; bottom: -2px; border-radius: 14px; background: linear-gradient(135deg, rgba(49, 163, 250, 0.1), rgba(49, 163, 250, 0.05)); z-index: -1; pointer-events: none; }

    /* Detail Panel (FM Panel Style) */
    .fm-panel { position: fixed; inset: 0; background: var(--bg-body); z-index: 2200; display: flex; flex-direction: column; transform: translateY(100%); transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1); max-width: 600px; margin: 0 auto; }
    .fm-panel.active { transform: translateY(0); }
    .fm-header { height: 60px; padding: 0 20px; background: #fff; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; font-weight: 800; font-size: 18px; color: var(--navy-dark); flex-shrink: 0; }
    .fm-body { flex: 1; overflow-y: auto; padding: 20px; padding-bottom: 80px; }
    
    .detail-section { background: var(--bg-surface); border-radius: 16px; padding: 20px; margin-bottom: 16px; box-shadow: var(--shadow-soft); }
    .sec-head { display: flex; align-items: center; gap: 8px; font-size: 17px; font-weight: 700; color: var(--navy-dark); margin-bottom: 14px; }
    .info-row { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 15px; }
    .info-label { color: var(--text-sub); font-weight: 500; }
    .info-val { color: var(--text-main); font-weight: 600; text-align: right; }
    
    .media-scroll { 
        display: flex; 
        gap: 10px; 
        overflow-x: auto; 
        padding-bottom: 12px; 
        scrollbar-width: thin;
        scrollbar-color: rgba(148, 163, 184, 0.5) transparent;
    }
    .media-card { min-width: 120px; height: 120px; background: #f8fafc; border-radius: 12px; border: 1px solid var(--border); position: relative; overflow: hidden; display: flex; align-items: center; justify-content: center; }
    .media-card img { width: 100%; height: 100%; object-fit: cover; }
    .ver-badge { position: absolute; top: 6px; left: 6px; background: rgba(0,0,0,0.6); color: #fff; font-size: 10px; padding: 2px 6px; border-radius: 4px; font-weight: 700; }

    /* Timeline */
    .timeline-item { display: flex; gap: 12px; padding-bottom: 20px; position: relative; }
    .timeline-item::before { content: ''; position: absolute; left: 7px; top: 20px; bottom: 0; width: 1px; background: var(--border); }
    .timeline-item:last-child::before { display: none; }
    .tl-dot { width: 14px; height: 14px; border-radius: 50%; background: var(--primary); border: 2px solid var(--primary-bg); z-index: 1; margin-top: 4px; flex-shrink: 0; }
    .tl-content { flex: 1; background: var(--bg-body); padding: 12px; border-radius: 12px; }
    .tl-time { font-size: 13px; color: var(--text-main); font-weight: 700; margin-bottom: 4px; }
    .tl-desc { font-size: 15px; color: var(--text-main); line-height: 1.4; font-weight: 600; }

    /* Sticky Footer Buttons */
    .sticky-footer { position: fixed; bottom: 0; left: 0; right: 0; background: #fff; padding: 16px 20px calc(16px + env(safe-area-inset-bottom)); border-top: 1px solid var(--border); display: flex; gap: 10px; z-index: 2210; width: 100%; max-width: 600px; margin: 0 auto; }
    .btn-action { flex: 1; height: 50px; border-radius: 12px; font-weight: 700; font-size: 16px; border: none; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s; }
    .info-input { background: var(--bg-input); border: 1px solid var(--border); border-radius: 8px; padding: 8px 12px; font-size: 14px; color: var(--text-main); width: 100%; }
    .info-input:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(49, 163, 250, 0.1); }
    .material-item { display: flex; align-items: center; gap: 12px; padding: 12px; background: var(--bg-input); border-radius: 8px; margin-bottom: 8px; }
    .btn-navy { background: var(--header-navy); color: #fff; }
    .btn-white { background: #f1f5f9; color: var(--text-sub); border: 1px solid var(--border); }
    .btn-pending { background: var(--st-pending-bg); color: var(--st-pending-text); border: 1px solid var(--st-pending-border); }
    .btn-reject { background: var(--st-reject-bg); color: var(--st-reject-text); border: 1px solid var(--st-reject-border); }
    .btn-success { background: var(--st-approved-bg); color: var(--st-approved-text); border: 1px solid var(--st-approved-border); cursor: default; }
    
    /* Toast & Utils */
    .toast-msg { position: fixed; bottom: 100px; left: 50%; transform: translate(-50%, 20px); background: rgba(30, 41, 59, 0.95); color: #fff; padding: 12px 24px; border-radius: 30px; font-size: 14px; font-weight: 600; opacity: 0; transition: 0.3s; pointer-events: none; z-index: 3000; display: flex; align-items: center; gap: 8px; }
    .toast-msg.show { opacity: 1; transform: translate(-50%, 0); }
    .upload-box { width: 100%; height: 50px; border: 1px dashed #7dd3fc; background: #f0f9ff; color: #0284c7; border-radius: 12px; font-weight: 700; display: flex; align-items: center; justify-content: center; gap: 8px; cursor: pointer; transition: all 0.2s; font-size: 15px; }
    .upload-box:hover { background: #e0f2fe; transform: translateY(-1px); }
    
    .hidden { display: none; }

    /* ===== [ê³µí†µ ë¯¸ë¦¬ë³´ê¸°ì°½ (pmOverlay) - @pworklog3 ë™ì¼] ===== */
    #pmOverlay {
        position: fixed; inset: 0; 
        background: #121212;
        z-index: 9999; display: none;
        flex-direction: column;
        font-family: var(--font-main);
        color: #ffffff;
        overflow: hidden; user-select: none;
    }
    #pmOverlay.active { display: flex; }

    .pm-header {
        height: 56px; background: #000;
        display: flex; align-items: center; justify-content: space-between;
        padding: 0 12px; flex-shrink: 0; border-bottom: 1px solid #333; z-index: 100;
    }
    .pm-title { 
        font-size: 17px; font-weight: 700; color: #fff; 
        overflow: hidden; text-overflow: ellipsis; white-space: nowrap; 
        max-width: 70%; text-align: center;
    }
    .pm-icon-btn {
        background: none; border: none; color: #fff; cursor: pointer;
        padding: 8px; display: flex; align-items: center; justify-content: center;
        border-radius: 50%; transition: 0.2s;
    }
    .pm-icon-btn:active { background: #333; }

    .pm-viewport {
        flex: 1; position: relative; overflow: hidden;
        background: #121212;
        display: flex; justify-content: center; align-items: center;
        cursor: grab; touch-action: none;
    }
    .pm-viewport.panning { cursor: grabbing; }

    .pm-content-wrapper {
        transform-origin: center center;
        transition: transform 0.1s ease-out;
        display: flex; flex-direction: column; align-items: center; gap: 20px;
        padding: 40px;
    }

    .pm-controls {
        position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
        background: #222; padding: 10px 20px; border-radius: 100px;
        display: flex; gap: 24px; z-index: 200;
        box-shadow: 0 10px 30px rgba(0,0,0,0.5); border: 1px solid #333;
    }
    .pm-ctrl-btn {
        background: none; border: none; color: #fff;
        display: flex; flex-direction: column; align-items: center; gap: 3px;
        font-size: 11px; cursor: pointer; min-width: 36px; opacity: 0.7; transition: 0.2s; font-weight: 500;
    }
    .pm-ctrl-btn:hover { opacity: 1; }
    .pm-ctrl-btn.active { color: var(--primary); opacity: 1; font-weight: 700; }
    
    .pm-loading {
        position: absolute; inset: 0; background: rgba(0,0,0,0.85);
        display: none; align-items: center; justify-content: center; flex-direction: column;
        z-index: 300; color: #fff; font-size: 14px;
    }
    .pm-loading.show { display: flex; }
    .pm-spinner {
        width: 40px; height: 40px; border: 3px solid #333;
        border-top-color: var(--primary); border-radius: 50%;
        animation: spin 0.8s linear infinite; margin-bottom: 12px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    .pm-toast {
        position: fixed; bottom: 100px; left: 50%; transform: translate(-50%, 20px);
        background: rgba(30, 41, 59, 0.95); color: #fff; padding: 12px 24px;
        border-radius: 50px; opacity: 0; transition: 0.3s; z-index: 400;
        display: flex; align-items: center; gap: 8px; font-size: 14px; font-weight: 600;
    }
    .pm-toast.show { opacity: 1; transform: translate(-50%, 0); }
  </style>
</head>
<body>

  <div class="app-wrapper">
    <div class="mb-3" style="display: flex; gap: 8px; align-items: center;">
        <div class="relative" style="flex: 1;">
            <input type="text" id="siteSearchInput" placeholder="í˜„ì¥ ì„ íƒ ë˜ëŠ” ê²€ìƒ‰" class="site-search-optimized w-full h-[54px] bg-bg-input dark:bg-slate-900 border border-border dark:border-slate-600 rounded-xl px-4 text-[17px] font-medium outline-none transition-all placeholder:text-slate-400 dark:placeholder:text-slate-500" style="background: var(--bg-input); border: 1px solid var(--border)" oninput="handleSiteSearch(this.value)" onfocus="toggleSiteDropdown(true)" autocomplete="off">
            
            <button onclick="toggleSiteDropdown()" class="absolute right-4 top-1/2 -translate-y-1/2 text-slate-400 transition-colors" style="background: none; border: none; cursor: pointer; display:flex; align-items:center; justify-content:center; color: var(--text-sub);">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" data-lucide="chevron-down" style="width: 20px; height: 20px" class="lucide lucide-chevron-down"><path d="m6 9 6 6 6-6"></path></svg>
            </button>
            
            <div id="siteDropdownList" class="site-dropdown-optimized"></div>
        </div>
        <select 
            id="sortFilter" 
            class="w-[95px] h-[54px] rounded-xl px-3 text-[15px] font-semibold focus:outline-none focus:border-primary focus:shadow-[0_0_0_3px_rgba(49,163,250,0.15)] bg-[var(--bg-surface)] border border-[var(--border)] text-[var(--text-main)]" 
            onchange="handleSortFilter(this.value)"
            style="cursor:pointer; appearance:none; background-image:url('data:image/svg+xml;charset=UTF-8,%3Csvg xmlns=%27http://www.w3.org/2000/svg%27 width=%2716%27 height=%2716%27 viewBox=%270 0 24 24%27 fill=%27none%27 stroke=%27%23475569%27 stroke-width=%272%27 stroke-linecap=%27round%27 stroke-linejoin=%27round%27%3E%3Cpath d=%27m6 9 6 6 6-6%27%3E%3C/path%3E%3C/svg%3E'); background-repeat:no-repeat; background-position:right 12px center; padding-right:36px;"
        >
            <option value="latest">ìµœì‹ ìˆœ</option>
            <option value="name">ì´ë¦„ìˆœ</option>
        </select>
    </div>
    
    <div class="filter-section">
        <div class="filter-row-scroll" style="display:flex; gap:6px; overflow-x:hidden; justify-content:space-between;">
            <button class="filter-chip status-all active" onclick="setFilter('all', this)" style="flex:1;">ì „ì²´</button>
            <button class="filter-chip status-draft" onclick="setFilter('draft', this)" style="flex:1;">ì‘ì„±</button>
            <button class="filter-chip status-reject" onclick="setFilter('reject', this)" style="flex:1;">ë°˜ë ¤</button>
            <button class="filter-chip status-pending" onclick="setFilter('pending', this)" style="flex:1;">ìš”ì²­</button>
            <button class="filter-chip status-approved" onclick="setFilter('approved', this)" style="flex:1;">ì™„ë£Œ</button>
            <button class="btn-add-chip" onclick="showCopyWorklogDialog()" style="flex:1; display: flex; align-items: center; justify-content: center; gap: 4px;">
                <span style="font-size:18px; font-weight:800; line-height:1;">+</span>&nbsp;ì¶”ê°€
            </button>
        </div>
    </div>

    <div class="summary-grid">
        <div class="sum-card" onclick="triggerFilter('draft')" style="background: var(--st-draft-bg); border: 1px solid var(--st-draft-border);">
            <span class="sum-val" id="sum-draft" style="color:var(--st-draft-text);">0</span>
            <span class="sum-label" style="color:var(--st-draft-text);">ì‘ì„±</span>
        </div>
        <div class="sum-card" onclick="triggerFilter('reject')" style="background: var(--st-reject-bg); border: 1px solid var(--st-reject-border);">
            <span class="sum-val" id="sum-reject" style="color:var(--st-reject-text);">0</span>
            <span class="sum-label" style="color:var(--st-reject-text);">ë°˜ë ¤</span>
        </div>
        <div class="sum-card" onclick="triggerFilter('pending')" style="background: var(--st-pending-bg); border: 1px solid var(--st-pending-border);">
            <span class="sum-val" id="sum-pending" style="color:var(--st-pending-text);">0</span>
            <span class="sum-label" style="color:var(--st-pending-text);">ìš”ì²­</span>
        </div>
        <div class="sum-card" onclick="triggerFilter('approved')" style="background: var(--st-approved-bg); border: 1px solid var(--st-approved-border);">
            <span class="sum-val" id="sum-approved" style="color:var(--st-approved-text);">0</span>
            <span class="sum-label" style="color:var(--st-approved-text);">ì™„ë£Œ</span>
        </div>
    </div>

    <div id="logList"></div>

    <button id="loadMoreBtn" class="btn-load-more" style="display:none;" onclick="handleLoadMore()">
        <span id="loadMoreText">ë” ë³´ê¸°</span>
        <i data-lucide="chevron-down" id="loadMoreIcon" style="width:16px;"></i>
    </button>

    <div id="emptyState" style="display:none; text-align:center; padding:80px 20px; color:var(--text-placeholder);">
        <div style="display:inline-flex; align-items:center; justify-content:center; width:80px; height:80px; background:var(--bg-input); border-radius:50%; margin-bottom:20px;">
            <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="var(--text-sub)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="opacity:0.6;">
                <circle cx="11" cy="11" r="8"></circle>
                <path d="m21 21-4.35-4.35"></path>
                <line x1="8" y1="11" x2="14" y2="11"></line>
            </svg>
        </div>
        <p style="font-size:16px; font-weight:500; margin-bottom:8px;">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</p>
    </div>
  </div>

  <div class="fm-panel" id="detailPanel">
      <div class="fm-header">
          <div style="width:24px;"></div>
          <span style="font-size:20px; font-weight:700; position:absolute; left:50%; transform:translateX(-50%);">í˜„ì¥ê¸°ë¡ë³´ê³ ì„œ</span>
          <button onclick="closeDetail()" style="background:none; border:none; cursor:pointer; color:var(--text-sub);"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" data-lucide="x" class="lucide lucide-x"><path d="M18 6 6 18"></path><path d="m6 6 12 12"></path></svg></button>
      </div>
      
      <!-- íƒ­ ë„¤ë¹„ê²Œì´ì…˜ -->
      <div style="display:flex; border-bottom:2px solid var(--border); background:var(--bg-surface);">
          <button onclick="switchDetailTab('status')" id="tab-status" class="detail-tab" style="flex:1; height:55px; padding:0; border:none; background:none; font-size:20px; font-weight:800; color:#31a3fa; border-bottom:3px solid #31a3fa; cursor:pointer; transition:all 0.2s;">ì‘ì—…í˜„í™©</button>
          <button onclick="switchDetailTab('attachment')" id="tab-attachment" class="detail-tab" style="flex:1; height:55px; padding:0; border:none; background:none; font-size:20px; font-weight:800; color:var(--text-sub); border-bottom:3px solid transparent; cursor:pointer; transition:all 0.2s;">ìë£Œì²¨ë¶€</button>
      </div>
      
      <div class="fm-body" id="detailContent"></div>
      <div class="sticky-footer" id="detailFooter"></div>
  </div>

  <div class="toast-msg" id="toast">
      <i data-lucide="check-circle-2" width="18" style="color:#4ade80;"></i>
      <span id="toastText">ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.</span>
  </div>

  <!-- ì‘ì—…ì¼ì§€ ì¶”ê°€ ë°”í…€ì‹œíŠ¸ ëª¨ë‹¬ (ë™ì  ìƒì„±ìš© ì»¨í…Œì´ë„ˆ) -->
  <div id="addWorklogModalContainer"></div>

  <!-- íˆ¬ì…ì¸ì› ìˆ˜ì • ë°”í…€ì‹œíŠ¸ ëª¨ë‹¬ -->
  <div id="editManpowerModal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.5); z-index:9999; backdrop-filter:blur(2px);">
      <div style="position:absolute; bottom:0; left:0; right:0; background:var(--bg-surface); border-radius:20px 20px 0 0; height:90vh; max-height:700px; overflow-y:auto; ;">
          <div style="padding:20px; border-bottom:1px solid var(--border);">
              <div style="display:flex; align-items:center; justify-content:space-between;">
                  <h3 style="font-size:20px; font-weight:800; color:var(--text-main);">íˆ¬ì…ì¸ì› ìˆ˜ì •</h3>
                  <button onclick="closeEditManpowerModal()" style="background:none; border:none; cursor:pointer; padding:4px; color:var(--text-sub);">
                      <i data-lucide="x" style="width:24px;"></i>
                  </button>
              </div>
          </div>
          
          <div style="padding:20px;">
              <!-- ì‘ì—…ì ì´ë¦„ -->
              <div style="margin-bottom:20px;">
                  <label style="display:block; font-size:15px; font-weight:700; color:var(--text-sub); margin-bottom:8px;">ì‘ì—…ì ì´ë¦„ <span style="color:#dc2626;">*</span></label>
                  <input type="text" id="editWorkerName" style="width:100%; height:48px; background:var(--bg-input); border:1px solid var(--border); border-radius:12px; padding:0 16px; font-size:15px; outline:none;" />
              </div>
              
              <!-- íˆ¬ì… ì‹œê°„ -->
              <div style="margin-bottom:20px;">
                  <label style="display:block; font-size:15px; font-weight:700; color:var(--text-sub); margin-bottom:8px;">íˆ¬ì… ì‹œê°„ <span style="color:#dc2626;">*</span></label>
                  <input type="number" id="editWorkHours" min="0" step="0.5" style="width:100%; height:48px; background:var(--bg-input); border:1px solid var(--border); border-radius:12px; padding:0 16px; font-size:15px; outline:none;" />
              </div>
          </div>
          
          <div style="padding:20px; border-top:1px solid var(--border); display:flex; gap:12px;">
              <button onclick="closeEditManpowerModal()" style="flex:1; height:52px; border-radius:12px; border:1px solid var(--border); background:#f3f4f6; color:#6b7280; font-size:16px; font-weight:700; cursor:pointer;">ì·¨ì†Œ</button>
              <button onclick="submitEditManpower()" style="flex:1; height:52px; border-radius:12px; border:none; background:#1e3a8a; color:white; font-size:16px; font-weight:700; cursor:pointer;">ìˆ˜ì •í•˜ê¸°</button>
          </div>
      </div>
  </div>

  <!-- ì‘ì—…ë‚´ìš© ìˆ˜ì • ë°”í…€ì‹œíŠ¸ ëª¨ë‹¬ -->
  <div id="editWorkSetModal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.5); z-index:9999; backdrop-filter:blur(2px);">
      <div style="position:absolute; bottom:0; left:0; right:0; background:var(--bg-surface); border-radius:20px 20px 0 0; height:90vh; max-height:700px; overflow-y:auto; ;">
          <div style="padding:20px; border-bottom:1px solid var(--border);">
              <div style="display:flex; align-items:center; justify-content:space-between;">
                  <h3 style="font-size:20px; font-weight:800; color:var(--text-main);">ì‘ì—…ë‚´ìš© ìˆ˜ì •</h3>
                  <button onclick="closeEditWorkSetModal()" style="background:none; border:none; cursor:pointer; padding:4px; color:var(--text-sub);">
                      <i data-lucide="x" style="width:24px;"></i>
                  </button>
              </div>
          </div>
          
          <div style="padding:20px;">
                            
              <!-- ì‘ì—…ìœ í˜• -->
              <div style="margin-bottom:20px;">
                  <label style="display:block; font-size:15px; font-weight:700; color:var(--text-sub); margin-bottom:8px;">ì‘ì—…ìœ í˜•</label>
                  <div style="display:flex; flex-wrap:wrap; gap:8px; margin-bottom:8px;">
                      <button onclick="selectEditTypeChip(this, 'ì§€í•˜')" class="edit-type-chip" style="padding:8px 16px; border-radius:20px; border:1px solid var(--border); background:white; color:var(--text-main); font-size:14px; font-weight:600; cursor:pointer;">ì§€í•˜</button>
                      <button onclick="selectEditTypeChip(this, 'ì§€ìƒ')" class="edit-type-chip" style="padding:8px 16px; border-radius:20px; border:1px solid var(--border); background:white; color:var(--text-main); font-size:14px; font-weight:600; cursor:pointer;">ì§€ìƒ</button>
                      <button onclick="selectEditTypeChip(this, 'ì§€ë¶•')" class="edit-type-chip" style="padding:8px 16px; border-radius:20px; border:1px solid var(--border); background:white; color:var(--text-main); font-size:14px; font-weight:600; cursor:pointer;">ì§€ë¶•</button>
                      <button onclick="selectEditTypeChip(this, 'ê¸°íƒ€')" class="edit-type-chip" style="padding:8px 16px; border-radius:20px; border:1px solid var(--border); background:white; color:var(--text-main); font-size:14px; font-weight:600; cursor:pointer;">ê¸°íƒ€</button>
                  </div>
                  <input type="text" id="editCustomType" placeholder="ê¸°íƒ€ ì…ë ¥" style="width:100%; height:48px; background:var(--bg-input); border:1px solid var(--border); border-radius:12px; padding:0 16px; font-size:15px; outline:none;" />
              </div>
              
              <!-- ë¸”ëŸ­/ë™/ì¸µ -->
              <div style="margin-bottom:20px;">
                  <label style="display:block; font-size:15px; font-weight:700; color:var(--text-sub); margin-bottom:8px;">ë¸”ëŸ­/ë™/ì¸µ</label>
                  <div style="display:grid; grid-template-columns:repeat(3, 1fr); gap:8px;">
                      <input type="text" id="editBlock" placeholder="ë¸”ëŸ­" style="height:48px; background:var(--bg-input); border:1px solid var(--border); border-radius:12px; padding:0 12px; font-size:15px; outline:none;" />
                      <input type="text" id="editDong" placeholder="ë™" style="height:48px; background:var(--bg-input); border:1px solid var(--border); border-radius:12px; padding:0 12px; font-size:15px; outline:none;" />
                      <input type="text" id="editFloor" placeholder="ì¸µ" style="height:48px; background:var(--bg-input); border:1px solid var(--border); border-radius:12px; padding:0 12px; font-size:15px; outline:none;" />
                  </div>
              </div>
          </div>
          
          <div style="padding:20px; border-top:1px solid var(--border); display:flex; gap:12px;">
              <button onclick="closeEditWorkSetModal()" style="flex:1; height:52px; border-radius:12px; border:1px solid var(--border); background:#f3f4f6; color:#6b7280; font-size:16px; font-weight:700; cursor:pointer;">ì·¨ì†Œ</button>
              <button onclick="submitEditWorkSet()" style="flex:1; height:52px; border-radius:12px; border:none; background:#1e3a8a; color:white; font-size:16px; font-weight:700; cursor:pointer;">ìˆ˜ì •í•˜ê¸°</button>
          </div>
      </div>
  </div>

  <!-- ë¯¸ë¦¬ë³´ê¸° ëª¨ë‹¬ (í†µí•© ë·°ì–´) -->
  <div id="pmOverlay">
      <header class="pm-header">
          <button class="pm-icon-btn" onclick="PreviewModal.close()">
              <i data-lucide="chevron-left" width="24"></i>
          </button>
          <div class="pm-title" id="pmTitle">ë¯¸ë¦¬ë³´ê¸°</div>
          <div style="display:flex; gap: 4px;">
              <button class="pm-icon-btn" onclick="PreviewModal.savePDF()">
                  <i data-lucide="download" width="20"></i>
              </button>
          </div>
      </header>

      <div class="pm-viewport" id="pmViewport">
          <div class="pm-content-wrapper" id="pmContent"></div>
      </div>

      <div class="pm-controls">
          <button class="pm-ctrl-btn" onclick="PreviewModal.zoom(-0.1)">
              <i data-lucide="minus" width="20"></i> ì¶•ì†Œ
          </button>
          
          <button class="pm-ctrl-btn" id="pmPanBtn" onclick="PreviewModal.togglePan()">
              <i data-lucide="hand" width="20"></i> ì´ë™
          </button>
          
          <button class="pm-ctrl-btn" onclick="PreviewModal.zoom(0.1)">
              <i data-lucide="plus" width="20"></i> í™•ëŒ€
          </button>

          <button class="pm-ctrl-btn" onclick="PreviewModal.share()">
              <i data-lucide="share-2" width="20"></i> ê³µìœ 
          </button>
      </div>

      <div class="pm-loading" id="pmLoading"><div class="pm-spinner"></div><span>ì²˜ë¦¬ ì¤‘...</span></div>
      <div class="pm-toast" id="pmToast"><i data-lucide="check" size="16"></i> <span id="pmToastMsg">ì™„ë£Œ</span></div>
  </div>

  <input type="file" id="confirmFileInput_${g_currentSite}_${g_currentDate}" accept="image/*,.pdf" style="display:none;" onchange="handleConfirmUpload(this)">

  <script>
    // @confirm3.html í†µí•© í•¨ìˆ˜
    function openConfirm3() {
        const site = g_worklogs[g_currentSite];
        if (!site) return;
        
        // í˜„ì¬ ì„ íƒëœ ë‚ ì§œê°€ ì—†ìœ¼ë©´ ê°€ì¥ ìµœê·¼ ë‚ ì§œ ì‚¬ìš©
        const dailyDates = Object.keys(site.dailyData || {}).sort();
        const targetDate = g_currentDate || dailyDates[dailyDates.length - 1];
        const dayData = site.dailyData[targetDate];
        const bi = site.baseInfo;
        
        if (!bi.siteName) {
            showToast('í˜„ì¥ ì •ë³´ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.');
            return;
        }
        
        const confirmData = {
            siteName: bi.siteName,
            contractor: bi.contractor || '',
            workDate: targetDate,
            workContent: dayData?.workSets?.map(ws => `${ws.member} ${ws.process}`).join(', ') || 'í˜„ì¥ ë³´ìˆ˜ ì‘ì—…',
            company: bi.contractor || '(ì£¼)ì´ë…¸í”¼ì•¤ì”¨'
        };
        
        // @confirm3.htmlì—ì„œ ì‚¬ìš©í•˜ëŠ” í‚¤ê°’ 'confirm3_data'ë¡œ í†µì¼
        localStorage.setItem('confirm3_data', JSON.stringify(confirmData));
        
        // ect í´ë”ì˜ @confirm3.html íŒŒì¼ ì—´ê¸°
        const url = './ect/@confirm3.html'; 
        const win = window.open(url, '_blank');
        if (!win) alert('íŒì—… ì°¨ë‹¨ì´ ì„¤ì •ë˜ì–´ ìˆìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì € ì„¤ì •ì—ì„œ íŒì—…ì„ í—ˆìš©í•´ ì£¼ì„¸ìš”.');
    }
        
        // ë©”ì‹œì§€ ë¦¬ìŠ¤ë„ˆ - í™•ì¸ì„œ ì™„ë£Œ ì‹ í˜¸ ë°›ê¸°
    window.addEventListener('message', function confirmMessageHandler(event) {
        if (event.data.type === 'CONFIRM_COMPLETE') {
            const imageData = event.data.imageData;
            if (imageData) {
                saveConfirmFromWindow(imageData);
            }
            window.removeEventListener('message', confirmMessageHandler);
        }
    });
    
    // í™•ì¸ì„œ ì´ë¯¸ì§€ ì €ì¥
    function saveConfirmFromWindow(imageData) {
        const site = g_worklogs[g_currentSite];
        
        if (!site.dailyData[g_currentDate].assets) {
            site.dailyData[g_currentDate].assets = { photos: [], drawings: [], confirm: null };
        }
        
        const oldConfirm = site.dailyData[g_currentDate].assets.confirm;
        const version = oldConfirm ? (oldConfirm.version || 1) + 1 : 1;
        
        site.dailyData[g_currentDate].assets.confirm = {
            url: imageData,
            uploadDate: new Date().toISOString().slice(0,10),
            fileName: 'ì‘ì—…ì™„ë£Œí™•ì¸ì„œ.png',
            version: version
        };

        const versions = site.dailyData[g_currentDate].versions;
        versions.push({
            ver: versions.length + 1,
            time: new Date().toISOString(),
            type: 'confirm',
            desc: `ì‘ì—…ì™„ë£Œ í™•ì¸ì„œ ìƒì„± (v${version})`
        });

        saveData();
        openDetail(g_currentSite, g_currentTab);
        showToast(`ì‘ì—…ì™„ë£Œ í™•ì¸ì„œê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤. (v${version})`);
    }
    
    // [í•µì‹¬] ë”ë³´ê¸° ê¸°ëŠ¥ì„ ìœ„í•œ ë³€ìˆ˜
    let visibleCount = 20;
    let initialCount = 20;
    
    let pinnedLogs = new Set();
    
    // Filter & Sort variables
    let currentFilter = 'all';
    let currentSortFilter = 'latest';
    
    // Search & Dropdown variables
    let siteSearchQuery = ''; 
    let dropdownQuery = '';
    let showSiteDropdown = false;
    let copyLogs = [];

    // [ê°œì„ ] ë°ì´í„° ë§ˆì´ê·¸ë ˆì´ì…˜: ê¸°ì¡´ ë‚ ì§œë³„ êµ¬ì¡° â†’ í˜„ì¥ë³„ ëˆ„ì  êµ¬ì¡°
    function migrateToSiteBasedStructure(oldData) {
        const newData = {};
        
        Object.keys(oldData).forEach(siteKey => {
            const siteDates = oldData[siteKey];
            
            // ì²« ë²ˆì§¸ ë‚ ì§œì˜ ê¸°ë³¸ ì •ë³´ë¥¼ í˜„ì¥ ê¸°ë³¸ ì •ë³´ë¡œ ì‚¬ìš©
            const firstDate = Object.keys(siteDates)[0];
            const firstLog = siteDates[firstDate];
            
            if (!firstLog || !firstLog.baseInfo) return;
            
            // í˜„ì¥ë³„ ë‹¨ì¼ êµ¬ì¡°ë¡œ ë³€í™˜
            newData[siteKey] = {
                baseInfo: {
                    siteName: firstLog.baseInfo.siteName || '',
                    dept: firstLog.baseInfo.dept || '',
                    createdDate: firstDate,
                    status: 'draft' // ê¸°ë³¸ ìƒíƒœ
                },
                dailyData: {},
                status: 'draft'
            };
            
            // ê° ë‚ ì§œì˜ ë°ì´í„°ë¥¼ dailyDataë¡œ ì´ë™
            Object.keys(siteDates).forEach(dateKey => {
                const log = siteDates[dateKey];
                newData[siteKey].dailyData[dateKey] = {
                    workSets: log.workSets || [],
                    manpower: log.manpowerHistory || [],
                    materials: log.materials || [],
                    assets: log.assets || { photos: [], drawings: [], confirm: null },
                    versions: log.versions || []
                };
                
                // ê°€ì¥ ìµœê·¼ ìƒíƒœë¥¼ í˜„ì¥ ìƒíƒœë¡œ ì‚¬ìš©
                if (log.baseInfo && log.baseInfo.status) {
                    newData[siteKey].status = log.baseInfo.status;
                }
            });
        });
        
        return newData;
    }

    // ì „ì—­ ë³€ìˆ˜ ì„ ì–¸
    let g_worklogs = {};
    let g_currentSite = null;
    let g_currentDate = null;
    let g_editSourceDate = null; // ìˆ˜ì • ëª¨ë“œ ì‹œ ì›ë³¸ ë‚ ì§œ ì¶”ì ìš©
    let g_isEditMode = false;

    // [ìˆ˜ì • 1] ë°ì´í„° ì´ˆê¸°í™” í•¨ìˆ˜ (í˜„ì¥ë³„ ëˆ„ì  ê´€ë¦¬)
    function initData() {
        const storageKey = 'inopnc_worklogs_v5_optimized';
        const stored = localStorage.getItem(storageKey);
        
        // ê¸°ì¡´ ë°ì´í„°ê°€ ìˆìœ¼ë©´ ë¡œë“œ
        if (stored) { 
            try {
                g_worklogs = JSON.parse(stored);
                if (g_worklogs && typeof g_worklogs === 'object' && Object.keys(g_worklogs).length > 0) {
                    console.log('ê¸°ì¡´ ë°ì´í„° ë¡œë“œ:', Object.keys(g_worklogs).length, 'ê°œ í˜„ì¥');
                    // UI ë Œë”ë§ í˜¸ì¶œ ì¶”ê°€
                    setTimeout(() => {
                        try { renderLogs(); } catch(e) { console.error('ë Œë”ë§ ì‹¤íŒ¨:', e); }
                        try { updateStats(); } catch(e) { console.error('í†µê³„ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', e); }
                        if (typeof lucide !== 'undefined' && lucide.createIcons) {
                            lucide.createIcons();
                        }
                    }, 100);
                    return; // ë°ì´í„°ê°€ ìˆìœ¼ë©´ ì¢…ë£Œ
                }
            } catch (e) {
                console.error('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', e);
            }
        }
        
        // ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ìƒ˜í”Œ ë°ì´í„° ìƒì„±
        console.log('ìƒ˜í”Œ ë°ì´í„° ìƒì„± ì‹œì‘...');

        // [ê°œì„ ] ìƒˆë¡œìš´ í˜„ì¥ë³„ ëˆ„ì  êµ¬ì¡°ë¡œ ìƒ˜í”Œ ë°ì´í„° ìƒì„±
        const today = new Date().toISOString().slice(0, 10);
        const yesterday = new Date(Date.now() - 86400000).toISOString().slice(0, 10);
        g_worklogs = {};

        // ë‹¤ì–‘í•œ ë°˜ë ¤ ì¼€ì´ìŠ¤ë¥¼ í¬í•¨í•œ í…ŒìŠ¤íŠ¸ ë°ì´í„° ìƒì„±
        const rejectReasons = [
            'ìì¬ ì •ë³´ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤. ì˜ìˆ˜ì¦ì„ ì²¨ë¶€í•´ì£¼ì„¸ìš”.',
            'ì‘ì—…ì ì •ë³´ê°€ ì •í™•í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ê³µìˆ˜ ê³„ì‚°ì„ ë‹¤ì‹œ í™•ì¸í•˜ì„¸ìš”.',
            'ë¶€ì¬ëª…ê³¼ ì‘ì—…ê³µì •ì´ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. í˜„ì¥ ìƒí™©ì„ ë‹¤ì‹œ í™•ì¸í•˜ì„¸ìš”.',
            'ì‘ì—…ìœ„ì¹˜ ì •ë³´ê°€ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤. ë¸”ëŸ­/ë™/ì¸µ ì •ë³´ë¥¼ ì •í™•íˆ ì…ë ¥í•˜ì„¸ìš”.',
            'ì‚¬ì§„ í’ˆì§ˆì´ ë‚®ìŠµë‹ˆë‹¤. ì„ ëª…í•œ ì‚¬ì§„ìœ¼ë¡œ ë‹¤ì‹œ ì´¬ì˜í•´ì£¼ì„¸ìš”.',
            'ë„ë©´ì´ ì—†ìŠµë‹ˆë‹¤. ì‘ì—… ì „í›„ ë„ë©´ì„ ë°˜ë“œì‹œ ì²¨ë¶€í•´ì•¼ í•©ë‹ˆë‹¤.',
            'ì‘ì—…ë‚´ìš©ì´ ìƒì„¸í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. êµ¬ì²´ì ì¸ ì‘ì—… ë²”ìœ„ë¥¼ ê¸°ì¬í•˜ì„¸ìš”.',
            'ì•ˆì „ì¥ë¹„ ì°©ìš© í™•ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤. ì•ˆì „ ê´€ë ¨ ì‚¬ì§„ì„ ì¶”ê°€í•˜ì„¸ìš”.'
        ];

        // 30ê°œì˜ í˜„ì¥ ìƒì„± (ìƒíƒœ ê³¨ê³ ë£¨ ë¶„í¬, ë°˜ë ¤ ì¼€ì´ìŠ¤ ë‹¤ì–‘í™”)
        const statuses = ['draft', 'pending', 'reject', 'approved'];
        const depts = ['ì„œìš¸ì§€ì‚¬', 'ê²½ê¸°ì§€ì‚¬', 'ì¸ì²œì§€ì‚¬', 'ë¶€ì‚°ì§€ì‚¬', 'ëŒ€ì „ì§€ì‚¬'];
        
        for (let i = 1; i <= 30; i++) {
            const siteKey = `site${i}`;
            const status = statuses[i % 4];
            const dept = depts[i % 5];
            const createdDate = i % 3 === 0 ? yesterday : today;
            
            // í˜„ì¥ë³„ ë‹¨ì¼ êµ¬ì¡°
            const contractors = ['í˜„ëŒ€ê±´ì„¤', 'ì‚¼ì„±ë¬¼ì‚°', 'GSê±´ì„¤', 'ëŒ€ìš°ê±´ì„¤', 'ë¡¯ë°ê±´ì„¤'];
            g_worklogs[siteKey] = {
                baseInfo: {
                    siteName: `í…ŒìŠ¤íŠ¸ í˜„ì¥ ${i}êµ¬ì—­ ê³µì‚¬`,
                    contractor: contractors[i % 5],
                    dept,
                    createdDate,
                    status,
                    rejectReason: status === 'reject' ? rejectReasons[i % rejectReasons.length] : null
                },
                dailyData: {}
            };
            
            // ì²« ë‚  ì‘ì—… ë°ì´í„° (ë” ìƒì„¸í•œ ë°ì´í„°)
            g_worklogs[siteKey].dailyData[createdDate] = {
                workSets: [
                    {
                        id: Date.now() + i,
                        member: ['ì² ê·¼', 'ê±°í‘¸ì§‘', 'ì½˜í¬ë¦¬íŠ¸', 'ë°©ìˆ˜'][i % 4],
                        process: ['ë°°ê·¼ì‘ì—…', 'ì„¤ì¹˜', 'íƒ€ì„¤', 'ë„í¬'][i % 4],
                        type: ['êµ¬ì¡°ë¬¼', 'ë§ˆê°', 'ë°©ìˆ˜ê³µì‚¬', 'ê¸°íƒ€'][i % 4],
                        location: { 
                            block: String.fromCharCode(65 + (i % 8)) + 'ë™', // Aë™-Hë™
                            dong: `${101 + (i % 5)}ë™`, // 101ë™-105ë™
                            floor: `${1 + (i % 10)}ì¸µ` // 1ì¸µ-10ì¸µ
                        }
                    },
                    // ì¼ë¶€ í˜„ì¥ì— ì¶”ê°€ ì‘ì—… ì„¸íŠ¸
                    ...(i % 3 === 0 ? [{
                        id: Date.now() + i + 500,
                        member: 'ì² ê·¼',
                        process: 'ë°°ê·¼ì‘ì—…',
                        type: 'êµ¬ì¡°ë¬¼',
                        location: { block: 'Cë™', dong: '103ë™', floor: '7ì¸µ' }
                    }] : [])
                ],
                manpower: [
                    {
                        date: createdDate,
                        workers: [
                            { name: `ê¹€ì² ìˆ˜`, hours: 1 },
                            { name: `ì´ì˜í¬`, hours: 1.5 },
                            ...(i % 2 === 0 ? [{ name: `ë°•ë¯¼ìˆ˜`, hours: 2 }] : [])
                        ]
                    }
                ],
                materials: [
                    ...(i % 2 === 0 ? [{
                        name: 'NPC-1000',
                        qty: 5,
                        unit: 'ë§',
                        receipt: null
                    }] : []),
                    ...(i % 3 === 0 ? [{
                        name: `ìì¬${i}`,
                        qty: 10,
                        unit: 'ê°œ',
                        receipt: null
                    }] : [])
                ],
                assets: {
                    photos: [
                        ...(i % 3 === 0 ? [{
                            id: Date.now() + i,
                            fileName: `ì‘ì—…ì „_${i}.jpg`,
                            url: `https://picsum.photos/seed/work${i}/400/300.jpg`,
                            uploadDate: createdDate,
                            status: 'before'
                        }] : []),
                        ...(i % 2 === 0 ? [{
                            id: Date.now() + i + 100,
                            fileName: `ì‘ì—…í›„_${i}.jpg`,
                            url: `https://picsum.photos/seed/after${i}/400/300.jpg`,
                            uploadDate: createdDate,
                            status: 'after'
                        }] : []),
                        // ìŠ¹ì¸ì™„ë£Œ ìƒíƒœì— ë” ë§ì€ ì‚¬ì§„ ì¶”ê°€
                        ...(status === 'approved' ? [
                            {
                                id: Date.now() + i + 300,
                                fileName: `ë³´ìˆ˜ì „_1.jpg`,
                                url: `https://picsum.photos/seed/before1_${i}/400/300.jpg`,
                                uploadDate: createdDate,
                                status: 'before',
                                member: 'ìŠ¬ë¼ë¸Œ',
                                process: 'ê· ì—´ ë³´ìˆ˜'
                            },
                            {
                                id: Date.now() + i + 301,
                                fileName: `ë³´ìˆ˜í›„_1.jpg`,
                                url: `https://picsum.photos/seed/after1_${i}/400/300.jpg`,
                                uploadDate: createdDate,
                                status: 'after',
                                member: 'ìŠ¬ë¼ë¸Œ',
                                process: 'ê· ì—´ ë³´ìˆ˜'
                            },
                            {
                                id: Date.now() + i + 302,
                                fileName: `ë³´ìˆ˜ì „_2.jpg`,
                                url: `https://picsum.photos/seed/before2_${i}/400/300.jpg`,
                                uploadDate: createdDate,
                                status: 'before',
                                member: 'ê¸°ë‘¥',
                                process: 'ë©´ ë³´ìˆ˜'
                            },
                            {
                                id: Date.now() + i + 303,
                                fileName: `ë³´ìˆ˜í›„_2.jpg`,
                                url: `https://picsum.photos/seed/after2_${i}/400/300.jpg`,
                                uploadDate: createdDate,
                                status: 'after',
                                member: 'ê¸°ë‘¥',
                                process: 'ë©´ ë³´ìˆ˜'
                            },
                            {
                                id: Date.now() + i + 304,
                                fileName: `ë³´ìˆ˜ì „_3.jpg`,
                                url: `https://picsum.photos/seed/before3_${i}/400/300.jpg`,
                                uploadDate: createdDate,
                                status: 'before',
                                member: 'ê±°ë”',
                                process: 'ë§ˆê° ë³´ìˆ˜'
                            },
                            {
                                id: Date.now() + i + 305,
                                fileName: `ë³´ìˆ˜í›„_3.jpg`,
                                url: `https://picsum.photos/seed/after3_${i}/400/300.jpg`,
                                uploadDate: createdDate,
                                status: 'after',
                                member: 'ê±°ë”',
                                process: 'ë§ˆê° ë³´ìˆ˜'
                            }
                        ] : [])
                    ],
                    drawings: [
                        ...(i % 4 === 0 ? [{
                            id: Date.now() + i + 200,
                            fileName: `ë„ë©´_${i}.dwg`,
                            url: `https://picsum.photos/seed/drawing${i}/600/400.jpg`,
                            uploadDate: createdDate,
                            status: 'progress'
                        }] : []),
                        // ìŠ¹ì¸ì™„ë£Œ ìƒíƒœì— ë„ë©´ ì¶”ê°€
                        ...(status === 'approved' ? [
                            {
                                id: Date.now() + i + 400,
                                fileName: `í‰ë©´ë„_Aë™.dwg`,
                                url: `https://picsum.photos/seed/plan_${i}/800/600.jpg`,
                                uploadDate: createdDate,
                                status: 'progress',
                                name: 'í‰ë©´ë„ - Aë™ 1ì¸µ'
                            },
                            {
                                id: Date.now() + i + 401,
                                fileName: `ìƒì„¸ë„_ê¸°ë‘¥.dwg`,
                                url: `https://picsum.photos/seed/detail_${i}/800/600.jpg`,
                                uploadDate: createdDate,
                                status: 'progress',
                                name: 'ê¸°ë‘¥ ìƒì„¸ë„'
                            },
                            {
                                id: Date.now() + i + 402,
                                fileName: `ì™„ë£Œë„ë©´.dwg`,
                                url: `https://picsum.photos/seed/complete_${i}/800/600.jpg`,
                                uploadDate: createdDate,
                                status: 'complete',
                                name: 'ì‘ì—… ì™„ë£Œ ë„ë©´'
                            }
                        ] : [])
                    ],
                    // ìŠ¹ì¸ì™„ë£Œ ìƒíƒœì— ì‘ì—…ì™„ë£Œí™•ì¸ì„œ ì¶”ê°€
                    confirm: status === 'approved' ? {
                        url: `https://picsum.photos/seed/confirm_${i}/794/1123.jpg`,
                        uploadDate: createdDate,
                        fileName: 'ì‘ì—…ì™„ë£Œí™•ì¸ì„œ.png',
                        version: 1
                    } : null
                },
                confirmDoc: null
            };
            
            // ì¼ë¶€ í˜„ì¥ì— ì˜¤ëŠ˜ ì‘ì—… ì¶”ê°€ (ëˆ„ì  ë°ì´í„°)
            if (i % 3 === 0 && createdDate !== today) {
                g_worklogs[siteKey].dailyData[today] = {
                    workSets: [
                        {
                            id: Date.now() + i + 1000,
                            member: 'ê¸°ë‘¥',
                            process: 'ë©´',
                            location: { block: 'B', dong: '2', floor: '5', type: 'ì‹ ì„¤' },
                            type: 'ì‹ ì„¤'
                        }
                    ],
                    manpower: [
                        { date: today, workers: [{ name: `ì‘ì—…ì${i}`, hours: 1.0 }, { name: `ì‘ì—…ì${i+1}`, hours: 1.0 }] }
                    ],
                    materials: [],
                    assets: { photos: [], drawings: [], confirm: null },
                    versions: [
                        { ver: 2, time: new Date().toISOString(), type: 'edit', desc: "ì‘ì—… ë‚´ìš© ì¶”ê°€" }
                    ]
                };
            }
        }
        saveData();
        
        // ìƒ˜í”Œ ë°ì´í„° ìƒì„± í›„ UI ë Œë”ë§
        setTimeout(() => {
            try { renderLogs(); } catch(e) { console.error('ë Œë”ë§ ì‹¤íŒ¨:', e); }
            try { updateStats(); } catch(e) { console.error('í†µê³„ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', e); }
            if (typeof lucide !== 'undefined' && lucide.createIcons) {
                lucide.createIcons();
            }
        }, 100);
    }

    function ensureNonEmptyData() {
        if (!g_worklogs || typeof g_worklogs !== 'object' || Object.keys(g_worklogs).length === 0) {
            try { localStorage.removeItem('inopnc_worklogs_v3_test'); } catch (e) {}
            initData();
        }
    }

    function ensureStatusSeedData() {
        const today = new Date().toISOString().slice(0, 10);
        const counts = { draft: 0, pending: 0, reject: 0, approved: 0 };

        Object.keys(g_worklogs || {}).forEach(siteKey => {
            Object.keys(g_worklogs[siteKey] || {}).forEach(dateKey => {
                const log = g_worklogs[siteKey][dateKey];
                const st = log?.baseInfo?.status;
                if (counts[st] !== undefined) counts[st] += 1;
            });
        });

        const need = Object.keys(counts).filter(st => counts[st] === 0);
        if (need.length === 0) return;

        const deptMap = { draft: 'ê±´ì¶•íŒ€', pending: 'í† ëª©íŒ€', reject: 'ì „ê¸°íŒ€', approved: 'ì„¤ë¹„íŒ€' };
        const labelMap = { draft: 'ì‘ì„±', pending: 'ìš”ì²­', reject: 'ë°˜ë ¤', approved: 'ì™„ë£Œ' };

        need.forEach((st, i) => {
            const siteKey = `seed_${st}_${Date.now()}_${i}`;
            const siteName = `ê¸°ëŠ¥í™•ì¸ìš© ${labelMap[st]} í˜„ì¥`;
            const dept = deptMap[st] || 'ê±´ì¶•íŒ€';

            g_worklogs[siteKey] = {
                [today]: {
                    baseInfo: {
                        siteName,
                        dept,
                        workDate: today,
                        status: st,
                        rejectReason: st === 'reject' ? 
                        (i % 6 === 0 ? 'í˜„ì¥ëª… ì •ë³´ê°€ ë¶€ì •í™•í•©ë‹ˆë‹¤. ì •í™•í•œ í˜„ì¥ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.' :
                         i % 6 === 1 ? 'íˆ¬ì…ì¸ì› ì •ë³´ë¥¼ ë‹¤ì‹œ í™•ì¸í•´ì£¼ì„¸ìš”. ì‘ì—…ì ì´ë¦„ê³¼ ì‹œê°„ì„ ì •í™•íˆ ê¸°ì…í•´ì£¼ì„¸ìš”.' :
                         i % 6 === 2 ? 'ì‘ì—…ë‚´ìš©ì´ ë¶ˆëª…í™•í•©ë‹ˆë‹¤. ë¶€ì¬ëª…ê³¼ ê³µì •ì„ ìƒì„¸íˆ ê¸°ì¬í•´ì£¼ì„¸ìš”.' :
                         i % 6 === 3 ? 'ìì¬ ì‚¬ìš© ë‚´ì—­ì„ í™•ì¸í•´ì£¼ì„¸ìš”. ìì¬ëª…ê³¼ ìˆ˜ëŸ‰ì„ ì •í™•íˆ ì…ë ¥í•´ì£¼ì„¸ìš”.' :
                         i % 6 === 4 ? 'ì‚¬ì§„ ìë£Œë¥¼ ì¶”ê°€ë¡œ ì²¨ë¶€í•´ì£¼ì„¸ìš”. ë³´ìˆ˜ ì „í›„ ì‚¬ì§„ì´ í•„ìš”í•©ë‹ˆë‹¤.' :
                         i % 6 === 5 ? 'ë„ë©´ ìë£Œê°€ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤. ê´€ë ¨ ë„ë©´ì„ ì²¨ë¶€í•´ì£¼ì„¸ìš”.' : null) : null
                    },
                    workSets: [
                        {
                            id: Date.now() + i,
                            member: 'ìŠ¬ë¼ë¸Œ',
                            process: 'ê· ì—´',
                            type: 'ì§€ìƒ',
                            location: { block: 'A', dong: '1', floor: '1' },
                            customMemberValue: '',
                            customProcessValue: ''
                        }
                    ],
                    manpowerHistory: [
                        { date: today, workers: [{ name: 'í…ŒìŠ¤íŠ¸ì‘ì—…ì', hours: 1.0 }] }
                    ],
                    versions: [
                        { ver: 1, time: new Date().toISOString(), type: 'create', desc: `${labelMap[st]} ìƒíƒœ ê¸°ëŠ¥ í™•ì¸ìš© ìƒì„±` }
                    ],
                    assets: {
                        photos: [],
                        drawings: [],
                        confirm: null
                    },
                    materials: []
                }
            };
        });

        saveData();
    }

    function saveData() { 
        // ìƒˆë¡œìš´ í˜„ì¥ë³„ êµ¬ì¡° ì €ì¥ í‚¤
        localStorage.setItem('inopnc_worklogs_v5_optimized', JSON.stringify(g_worklogs)); 
        
        // ë¦¬ìŠ¤íŠ¸ ì¹´ë“œ ì—…ë°ì´íŠ¸ (ìˆ˜ì •ëœ ë°ì´í„° ë°˜ì˜)
        updateSiteCard(g_currentSite);
    }
    
    // í˜„ì¥ ì¹´ë“œ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
    function updateSiteCard(siteKey) {
        if (!siteKey) return;
        
        const site = g_worklogs[siteKey];
        if (!site) return;
        
        // í•´ë‹¹ í˜„ì¥ ì¹´ë“œ ì°¾ê¸°
        const siteCard = document.getElementById(`log-${siteKey}`);
        if (!siteCard) return;
        
        // ì¹´ë“œ ë‚´ìš© ì—…ë°ì´íŠ¸
        const updatedCardHtml = generateSiteCardHtml(site, siteKey);
        siteCard.outerHTML = updatedCardHtml;
        
        // ì•„ì´ì½˜ ì¬ë Œë”ë§
        setTimeout(() => {
            lucide.createIcons();
        }, 100);
        
        console.log('í˜„ì¥ ì¹´ë“œ ì—…ë°ì´íŠ¸ ì™„ë£Œ:', siteKey);
    }
    
    // í˜„ì¥ ì¹´ë“œ HTML ìƒì„± í•¨ìˆ˜
    function generateSiteCardHtml(site, siteKey) {
        const bi = site.baseInfo;
        const dailyDates = Object.keys(site.dailyData || {}).sort();
        const latestDate = dailyDates[dailyDates.length - 1];
        const latestData = latestDate ? site.dailyData[latestDate] : null;
        
        // ìµœì‹  ì‘ì—…ë‚´ìš© ì¶”ì¶œ
        let workSets = [];
        let manpower = [];
        if (latestData) {
            workSets = latestData.workSets || [];
            manpower = latestData.manpower || [];
        }
        
        const members = [...new Set(workSets.map(ws => ws.member).filter(Boolean))];
        const processes = [...new Set(workSets.map(ws => ws.process).filter(Boolean))];
        const types = [...new Set(workSets.map(ws => ws.type).filter(Boolean))];
        const locations = workSets.map(ws => {
            const loc = ws.location || {};
            return [loc.block, loc.dong, loc.floor].filter(Boolean).join('/');
        }).filter(Boolean);
        const uniqueLocations = [...new Set(locations)];
        
        return `
        <div class="site-card ${site.status === 'reject' ? 'reject-item' : ''}" id="log-${siteKey}">
            <div class="card-header-main" onclick="openDetail('${siteKey}')">
                <div class="site-date">
                    <span class="sub-badge contractor" style="background:var(--st-pending-bg); color:var(--st-pending-text); border:1px solid var(--st-pending-border);">${bi?.contractor || 'ì›ì²­ì‚¬'}</span>
                    <span class="sub-badge dept">${bi?.dept || '-'}</span>
                    <span class="site-name">${bi?.siteName || '-'}</span>
                    <span class="work-date">${bi?.workDate || '-'}</span>
                </div>
                <div class="card-actions">
                    ${site.status === 'reject' ? `
                        <button class="reject-edit-btn" onclick="event.stopPropagation(); showRejectEditNotification()">
                            <i data-lucide="edit-3" style="width:16px;"></i>
                            ìˆ˜ì •
                        </button>
                    ` : ''}
                    <button class="pin-btn ${site.pinned ? 'active' : ''}" onclick="event.stopPropagation(); togglePin('${siteKey}')">
                        <i data-lucide="bookmark" style="width:16px;"></i>
                    </button>
                    <button class="p-1 text-red-400 hover:text-red-600" onclick="event.stopPropagation(); deleteSiteWithConfirm('${siteKey}')" style="background:none; border:none; cursor:pointer; padding:4px; transition:color 0.2s;">
                        <i data-lucide="trash-2" style="width:18px;"></i>
                    </button>
                </div>
            </div>
            <div class="card-content">
                ${site.status === 'reject' && bi.rejectReason ? `
                    <div class="reject-reason-box">
                        <div class="reject-reason-header">
                            <i data-lucide="alert-circle" style="width:16px;"></i>
                            <span>ë°˜ë ¤ ì‚¬ìœ </span>
                        </div>
                        <div class="reject-reason-text">${bi.rejectReason}</div>
                    </div>
                ` : ''}
                <div class="stats-row">
                    <div class="stat-item">
                        <span class="stat-value">${dailyDates.length}</span>
                        <span class="stat-label">ì‘ì—…ì¼ì§€</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-value">${latestData ? (latestData.photos || []).length : 0}</span>
                        <span class="stat-label">ì‚¬ì§„ ìë£Œ</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-value">${latestData ? (latestData.drawings || []).length : 0}</span>
                        <span class="stat-label">ë„ë©´í•¨</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-value">${latestData && latestData.confirm ? '1' : '0'}</span>
                        <span class="stat-label">í™•ì¸ì„œ</span>
                    </div>
                </div>
                ${workSets.length > 0 ? `
                    <div style="font-size:14px; color:var(--text-sub); line-height:1.5; margin-top:8px;">
                        ${manpower.length > 0 ? manpower.map(mp => {
                            const workers = mp.workers.map(w => w.name).join(', ');
                            const hours = mp.workers.reduce((sum, w) => sum + Number(w.hours || 0), 0);
                            return '<span style="font-weight:600;">ì‘ì—…ì:</span> ' + workers + ' ã…£ (' + hours + 'ê³µìˆ˜)(1ì¼)';
                        }).join(' ã…£ ') : ''}
                        ${manpower.length > 0 && (members.length > 0 || processes.length > 0) ? ' ã…£ ' : ''}
                        ${members.length > 0 ? '<span style="font-weight:600;">ë¶€ì¬ëª…:</span> ' + members.join(', ') : ''}
                        ${members.length > 0 && processes.length > 0 ? ' ã…£ ' : ''}
                        ${processes.length > 0 ? '<span style="font-weight:600;">ì‘ì—…ê³µì •:</span> ' + processes.join(', ') : ''}
                        ${types.length > 0 ? ' ã…£ <span style="font-weight:600;">ì‘ì—…ìœ í˜•:</span> ' + types.join(', ') : ''}
                        ${uniqueLocations.length > 0 ? ' ã…£ <span style="font-weight:600;">ìœ„ì¹˜:</span> ' + uniqueLocations.join(', ') : ''}
                    </div>
                ` : ''}
            </div>
        </div>`;
    }

    // --- ê²€ìƒ‰ ê´€ë ¨ ë¡œì§ (ê¸°ì¡´ ìœ ì§€) ---
    function toggleSiteDropdown(forceOpen) {
        const dropdown = document.getElementById('siteDropdownList');
        if (forceOpen === true) {
            renderSiteDropdown();
            dropdown.classList.add('show');
        } else if (dropdown.classList.contains('show')) {
            dropdown.classList.remove('show');
        } else {
            renderSiteDropdown();
            dropdown.classList.add('show');
        }
    }
    
    function getAllSiteNames() {
        let names = [];
        Object.keys(g_worklogs).forEach(siteKey => {
            Object.keys(g_worklogs[siteKey]).forEach(dateKey => {
                const log = g_worklogs[siteKey][dateKey];
                names.push(log.baseInfo.siteName);
            });
        });
        return names;
    }

    function handleSiteSearch(value) {
        siteSearchQuery = value.toLowerCase();
        dropdownQuery = value.toLowerCase();
        
        const input = document.getElementById('siteSearchInput');
        const dropdown = document.getElementById('siteDropdownList');
        
        updateClearButton(input);
        
        if (value.length > 0) {
            showSiteDropdown = true;
            renderSiteDropdown();
            dropdown.classList.add('show');
        } else {
            dropdown.classList.remove('show');
            showSiteDropdown = false;
        }
        
        renderLogs();
    }

    function updateClearButton(input) {
        let clearBtn = input.parentNode.querySelector('.clear-button');
        if (input.value.length > 0) {
            if (!clearBtn) {
                clearBtn = document.createElement('button');
                clearBtn.className = 'clear-button';
                clearBtn.innerHTML = 'âœ•';
                clearBtn.onclick = (e) => {
                    e.stopPropagation();
                    input.value = '';
                    siteSearchQuery = '';
                    dropdownQuery = '';
                    updateClearButton(input);
                    document.getElementById('siteDropdownList').classList.remove('show');
                    renderLogs();
                    input.focus();
                };
                input.parentNode.appendChild(clearBtn);
            }
        } else {
            if (clearBtn) clearBtn.remove();
        }
    }
    
    function handleSortFilter(value) {
        currentSortFilter = value;
        renderLogs();
    }
    
    function renderSiteDropdown() {
        const dropdown = document.getElementById('siteDropdownList');
        // g_worklogsì—ì„œ ê³ ìœ í•œ í˜„ì¥ ì´ë¦„ ì¶”ì¶œ
        const siteNames = [];
        Object.keys(g_worklogs).forEach(siteKey => {
            const site = g_worklogs[siteKey];
            // baseInfoê°€ ìˆëŠ” ê²½ìš°ì—ë§Œ ì¶”ê°€
            if (site && site.baseInfo && site.baseInfo.siteName) {
                siteNames.push(site.baseInfo.siteName);
            }
        });
        const uniqueSites = [...new Set(siteNames)];
        const filtered = uniqueSites.filter(name => name && name.toLowerCase().includes(dropdownQuery));
        
        dropdown.innerHTML = filtered.map(name => `
            <div class="site-dropdown-item" onclick="selectSiteFromDropdown('${name}')">
                ${name}
            </div>
        `).join('') || '<div style="padding:14px; text-align:center; color:var(--text-placeholder);">ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ</div>';
    }
    
    function selectSiteFromDropdown(name) {
        const input = document.getElementById('siteSearchInput');
        input.value = name;
        siteSearchQuery = name.toLowerCase();
        dropdownQuery = name.toLowerCase();
        document.getElementById('siteDropdownList').classList.remove('show');
        updateClearButton(input);
        renderLogs();
    }

    // --- [Senior Optimization] ë” ë³´ê¸° ë° ë Œë”ë§ ë¡œì§ ---
    function renderLogs() {
        const listEl = document.getElementById('logList');
        if (!listEl) return;

        let logs = Object.keys(g_worklogs || {}).map(siteKey => {
            const site = g_worklogs[siteKey];
            if (!site || !site.baseInfo) return null;

            // [Data Integrity] Optional Chainingìœ¼ë¡œ ë°ì´í„° ì•ˆì „ì„± í™•ë³´
            const dailyDates = Object.keys(site.dailyData || {}).sort();
            const latestDate = dailyDates[dailyDates.length - 1] || '-';
            const latestData = site.dailyData?.[latestDate] || {};
            const version = latestData.versions?.length || 1;
            const currentStatus = site.status || site.baseInfo?.status || 'draft';
            
            // [í•µì‹¬] ìµœì¢… ë°ì´í„°ë§Œ í•˜ë‚˜ë¡œ í‘œê¸° (ë§ˆì§€ë§‰ workSetë§Œ ì‚¬ìš©)
            const workSets = latestData.workSets || [];
            const lastWorkSet = workSets.length > 0 ? workSets[workSets.length - 1] : null;
            
            let summary = 'ì‘ì—… ë‚´ìš© ì—†ìŒ';
            if (lastWorkSet) {
                const loc = lastWorkSet.location || {};
                const locStr = [loc.block, loc.dong, loc.floor].filter(Boolean).join('/');
                summary = `${lastWorkSet.member || '-'} ã…£ ${lastWorkSet.process || '-'}${lastWorkSet.type ? ` [${lastWorkSet.type}]` : ''}${locStr ? ` (${locStr})` : ''}`;
            }
            
            console.log('ìµœì¢… summary:', summary, 'latestDate:', latestDate, 'lastWorkSet:', lastWorkSet);
            
            // ëˆ„ì  í†µê³„ ê³„ì‚°
            const dailyDataValues = Object.values(site.dailyData || {});
            const allManpower = dailyDataValues.flatMap(d => d?.manpower || []);
            const totalWorkers = new Set(allManpower.flatMap(m => (m?.workers || []).map(w => w?.name || ''))).size;
            const photoCnt = dailyDataValues.reduce((sum, d) => sum + (d?.assets?.photos?.length || 0), 0);
            const drawCnt = dailyDataValues.reduce((sum, d) => sum + (d?.assets?.drawings?.length || 0), 0);
            const workDays = dailyDates.length;

            return { 
                siteKey, 
                site, 
                latestDate: latestDate || '-', 
                summary: summary || 'ì‘ì—… ë‚´ìš© ì—†ìŒ', 
                version: version || 1, 
                status: currentStatus || 'draft', 
                totalWorkers: totalWorkers || 0, 
                photoCnt: photoCnt || 0, 
                drawCnt: drawCnt || 0, 
                workDays: workDays || 0 
            };
        }).filter(log => {
            if (!log) return false;
            // [í•„í„° ë¡œì§] allì¼ ë•ŒëŠ” ë¬´ì¡°ê±´ true
            const matchesFilter = currentFilter === 'all' || log.status === currentFilter;
            const searchVal = (document.getElementById('siteSearchInput')?.value || '').toLowerCase();
            return matchesFilter && log?.site?.baseInfo?.siteName?.toLowerCase().includes(searchVal);
        });

        // ì •ë ¬ (ìµœì‹ ìˆœ/ì´ë¦„ìˆœ)
        logs.sort((a, b) => {
            // í•€ ê³ ì •ëœ í•­ëª© ìš°ì„ 
            if (pinnedLogs.has(a?.siteKey) !== pinnedLogs.has(b?.siteKey)) return pinnedLogs.has(a?.siteKey) ? -1 : 1;
            
            // ì •ë ¬ í•„í„° ì ìš©
            if (currentSortFilter === 'name') {
                // ì´ë¦„ìˆœ ì •ë ¬ (ê°€ë‚˜ë‹¤ìˆœ)
                return (a?.site?.baseInfo?.siteName || '').localeCompare(b?.site?.baseInfo?.siteName || '', 'ko');
            } else {
                // ìµœì‹ ìˆœ ì •ë ¬ (ê¸°ë³¸ê°’)
                return new Date(b?.latestDate || 0) - new Date(a?.latestDate || 0);
            }
        });

        const displayLogs = logs.slice(0, visibleCount || 20);
        
        // ë°ì´í„°ê°€ ì—†ëŠ” ê²½ìš° ë¹ˆ í™”ë©´ ì²˜ë¦¬
        if (displayLogs.length === 0) {
            listEl.innerHTML = `
                <div style="text-align: center; padding: 60px 20px; color: var(--text-sub);">
                    <div style="display: flex; justify-content: center; margin-bottom: 16px;">
                        <i data-lucide="inbox" style="width: 48px; height: 48px; opacity: 0.3;"></i>
                    </div>
                    <div style="font-size: 16px; font-weight: 600; margin-bottom: 8px;">í˜„ì¥ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤</div>
                    <div style="font-size: 14px; opacity: 0.7;">ì²« ë²ˆì§¸ í˜„ì¥ ê¸°ë¡ì„ ì¶”ê°€í•´ë³´ì„¸ìš”</div>
                </div>
            `;
        } else {
            listEl.innerHTML = displayLogs.map(item => {
                const bi = item.site?.baseInfo;
                const badgeText = getStatusLabel(item.status);
                const badgeClass = `bdg-${item.status}`;

                const isPinned = pinnedLogs.has(item.siteKey);
                const pinClass = isPinned ? 'active' : '';
                
                return `
                <div class="site-card ${item.status === 'reject' ? 'reject-item' : ''} ${isPinned ? 'pinned-item' : ''}" id="log-${item.siteKey}">
                    <div class="card-header-main" onclick="openDetail('${item.siteKey}')">
                        <div class="site-date">
                            <span class="sub-badge contractor" style="background:var(--st-pending-bg); color:var(--st-pending-text); border:1px solid var(--st-pending-border);">${bi?.contractor || 'ì›ì²­ì‚¬'}</span>
                            <span class="sub-badge dept">${bi?.dept || '-'}</span> 
                            ìµœê·¼: ${item.latestDate}
                        </div>
                        <div class="site-top-row">
                            <div style="display:flex; flex-direction:column; flex:1; min-width:0;">
                                <div class="site-name-text">${bi?.siteName || '-'}</div>
                                <div class="work-text-summary">
                                    <i data-lucide="map-pin" style="width:16px; height:16px; color:var(--text-main); flex-shrink:0; margin-top: 2.5px;"></i>
                                    <span style="overflow:visible; text-overflow:unset; white-space:normal; word-break:break-word;">${item.summary}</span>
                                </div>
                            </div>
                            <div style="display:flex; gap:4px; align-items:center; flex-shrink:0;">
                                <span class="site-badge ${badgeClass}" style="white-space:nowrap;">${badgeText}</span>
                                <button class="btn-star ${pinClass}" onclick="event.stopPropagation(); togglePin('${item.siteKey}')" style="flex-shrink:0;">
                                    <i data-lucide="${isPinned ? 'pin-off' : 'pin'}" style="width:20px; height:20px; ${isPinned ? 'color:var(--primary);' : ''}"></i>
                                </button>
                            </div>
                        </div>
                        
                        <!-- ìš”ì•½ ì¹´ë“œ -->
                        <div style="display:grid; grid-template-columns:repeat(4, 1fr); gap:4px; background:#f8fafc; border:1px solid #e2e8f0; border-radius:12px; padding:12px 4px; margin-top:12px;">
                            <div style="text-align:center; border-right:1px solid #e2e8f0;">
                                <span style="display:block; font-size:17px; font-weight:800; color:#31a3fa;">${item.workDays}ì¼</span>
                                <span style="display:block; font-size:11px; color:var(--text-sub); font-weight:600;">ëˆ„ì  ê¸°ê°„</span>
                            </div>
                            <div style="text-align:center; border-right:1px solid #e2e8f0;">
                                <span style="display:block; font-size:17px; font-weight:800; color:#31a3fa;">${item.totalWorkers}ëª…</span>
                                <span style="display:block; font-size:11px; color:var(--text-sub); font-weight:600;">ì´ ì¸ì›</span>
                            </div>
                            <div style="text-align:center; border-right:1px solid #e2e8f0;">
                                <span style="display:block; font-size:17px; font-weight:800; color:#31a3fa;">${item.photoCnt}ê±´</span>
                                <span style="display:block; font-size:11px; color:var(--text-sub); font-weight:600;">ì‚¬ì§„ ìë£Œ</span>
                            </div>
                            <div style="text-align:center;">
                                <span style="display:block; font-size:17px; font-weight:800; color:#31a3fa;">${item.drawCnt}ê±´</span>
                                <span style="display:block; font-size:11px; color:var(--text-sub); font-weight:600;">ë„ë©´í•¨</span>
                            </div>
                        </div>
                    </div>
                </div>`;
            }).join('');
        }
        
        // [ë”ë³´ê¸°/ì ‘ê¸° ë²„íŠ¼ í‘œì‹œ ë¡œì§]
        const loadMoreBtn = document.getElementById('loadMoreBtn');
        if (loadMoreBtn && logs.length > initialCount) {
            loadMoreBtn.style.display = 'flex';
            const loadMoreText = document.getElementById('loadMoreText');
            const loadMoreIcon = document.getElementById('loadMoreIcon');
            
            if (visibleCount >= logs.length) {
                loadMoreText.textContent = 'ì ‘ê¸°';
                loadMoreIcon.setAttribute('data-lucide', 'chevron-up');
            } else {
                loadMoreText.textContent = `ë” ë³´ê¸° (${logs.length - visibleCount}ê°œ)`;
                loadMoreIcon.setAttribute('data-lucide', 'chevron-down');
            }
            lucide.createIcons();
        } else if (loadMoreBtn) {
            loadMoreBtn.style.display = 'none';
        }
        
        updateStats(); 
        lucide.createIcons();
    }

    // [ìˆ˜ì • 4] ë” ë³´ê¸° ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
    function handleLoadMore() {
        const searchInput = document.getElementById('siteSearchInput');
        const searchVal = siteSearchQuery || (searchInput ? searchInput.value.toLowerCase() : '');
        
        // í˜„ì¬ í•„í„°ë§ëœ ë¡œê·¸ ê³„ì‚°
        let logs = Object.keys(g_worklogs || {}).map(siteKey => {
            const site = (g_worklogs || {})[siteKey];
            if (!site || !site.baseInfo) return null;

            const currentStatus = site.status || site.baseInfo.status || 'draft';
            return {
                siteKey,
                ...site,
                status: currentStatus
            };
        }).filter(log => {
            if (!log) return false;
            const matchesFilter = currentFilter === 'all' || log.status === currentFilter;
            const matchesSearch = log?.baseInfo?.siteName?.toLowerCase().includes(searchVal) || false;
            return matchesFilter && matchesSearch;
        });

        // ë”ë³´ê¸°/ì ‘ê¸° ë¡œì§
        if (visibleCount >= logs.length) {
            // ì ‘ê¸° - ì´ˆê¸° ê°œìˆ˜ë¡œ ëŒì•„ê°€ê¸°
            visibleCount = initialCount;
        } else {
            // ë”ë³´ê¸° - 20ê°œ ì¶”ê°€
            visibleCount += 20;
        }

        renderLogs(); // ë‹¤ì‹œ ë Œë”ë§
    }

    function updateStats() {
        const counts = { draft: 0, pending: 0, reject: 0, approved: 0 };
        Object.values(g_worklogs || {}).forEach(site => {
            // site.status ë˜ëŠ” baseInfo.statusë¥¼ ì•ˆì „í•˜ê²Œ ê°€ì ¸ì˜´
            const st = site?.status || (site?.baseInfo?.status) || 'draft';
            if (counts[st] !== undefined) counts[st]++;
        });
        
        // UI ì—…ë°ì´íŠ¸
        const draftEl = document.getElementById('sum-draft');
        const pendingEl = document.getElementById('sum-pending');
        const rejectEl = document.getElementById('sum-reject');
        const approvedEl = document.getElementById('sum-approved');
        
        if (draftEl) draftEl.innerText = counts.draft;
        if (pendingEl) pendingEl.innerText = counts.pending;
        if (rejectEl) rejectEl.innerText = counts.reject;
        if (approvedEl) approvedEl.innerText = counts.approved;
    }

    window.triggerFilter = function(status) {
        const targetChip = document.querySelector(`.filter-chip.status-${status}`);
        setFilter(status, targetChip);
    };

    function setFilter(filter, btn) {
        currentFilter = filter;
        
        // 'ì „ì²´' í•„í„° í´ë¦­ ì‹œ ê²€ìƒ‰ì–´ ì´ˆê¸°í™” (ëª¨ë“  ë°ì´í„° ë³´ì´ë„ë¡)
        if (filter === 'all') {
            const searchInput = document.getElementById('siteSearchInput');
            if (searchInput) {
                searchInput.value = '';
                siteSearchQuery = '';
                dropdownQuery = '';
                updateClearButton(searchInput);
            }
        }
        
        document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
        if(btn) btn.classList.add('active');
        else {
             const target = document.querySelector(`.filter-chip.status-${filter}`);
             if(target) target.classList.add('active');
        }
        visibleCount = initialCount;
        renderLogs();
    }

    function togglePin(logKey) {
        if(pinnedLogs.has(logKey)) {
            pinnedLogs.delete(logKey);
            showToast('ê³ ì •ì´ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
        } else {
            pinnedLogs.add(logKey);
            showToast('ìƒë‹¨ì— ê³ ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
        }
        saveData();
        renderLogs();
    }
    
    // [Senior Helper] ìƒíƒœ ë¼ë²¨ ë³€í™˜
    function getStatusLabel(status) {
        const labels = {
            draft: 'ì‘ì„±ì¤‘',
            pending: 'ìŠ¹ì¸ìš”ì²­',
            reject: 'ë°˜ë ¤',
            approved: 'ìŠ¹ì¸ì™„ë£Œ'
        };
        return labels[status] || 'ì‘ì„±ì¤‘';
    }
    
    // [í†µí•©] ìƒíƒœ ë³€ê²½ í•¨ìˆ˜
    function changeStatus(newStatus, rejectReason = null) {
        if (!g_currentSite) return;
        const site = g_worklogs[g_currentSite];
        if (!site) return;
        
        // 1. ìƒíƒœ ë° ë°ì´í„° ë³€ê²½
        site.status = newStatus;
        if (site.baseInfo) {
            site.baseInfo.status = newStatus;
            if (newStatus === 'reject' && rejectReason) {
                site.baseInfo.rejectReason = rejectReason;
            } else if (newStatus !== 'reject') {
                site.baseInfo.rejectReason = null; // ë°˜ë ¤ê°€ ì•„ë‹ˆë©´ ì‚¬ìœ  ì´ˆê¸°í™”
            }
        }
        
        // 2. ì €ì¥ ë° ë¦¬ìŠ¤íŠ¸ ê°±ì‹ 
        saveData();
        renderLogs();
        
        // 3. [í•µì‹¬] ìƒì„¸ í™”ë©´ ì¦‰ì‹œ ê°±ì‹  (ë²„íŠ¼ ìƒíƒœ ë™ê¸°í™”)
        openDetail(g_currentSite, g_currentTab || 'status');
        
        // 4. ì•Œë¦¼ ë©”ì‹œì§€
        let msg = "ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.";
        if (newStatus === 'pending') msg = "ìŠ¹ì¸ ìš”ì²­ë˜ì—ˆìŠµë‹ˆë‹¤.";
        if (newStatus === 'draft') msg = "ì‘ì„±ì¤‘ ìƒíƒœë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.";
        if (newStatus === 'approved') msg = "ìŠ¹ì¸ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.";
        if (newStatus === 'reject') msg = "ë°˜ë ¤ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.";
        showToast(msg);
    }
    
    // [Business Logic] ìŠ¹ì¸ ì·¨ì†Œ ì‹œ ì‘ì„±ì¤‘ìœ¼ë¡œ ë³€ê²½
    function cancelApproval() {
        if(confirm('ìŠ¹ì¸ì„ ì·¨ì†Œí•˜ê³  ì‘ì„±ì¤‘ ìƒíƒœë¡œ ë˜ëŒë¦¬ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            changeStatus('draft');
        }
    }
    
    // [Senior Optimization] ìƒíƒœë³„ í•˜ë‹¨ ë²„íŠ¼ ê¸°ëŠ¥
    function updateDetailFooter(status) {
        const footerEl = document.getElementById('detailFooter');
        if (!footerEl) return;
        
        let buttons = '';
        
        switch(status) {
            case 'draft': // ì‘ì„±ì¤‘: [ë‹«ê¸°][ì„ì‹œì €ì¥][ìŠ¹ì¸ìš”ì²­]
                buttons = `
                    <button class="btn-action btn-white" onclick="closeDetail()">ë‹«ê¸°</button>
                    <button class="btn-action" style="background:#cbd5e1; color:#475569;" onclick="saveDraft()">ì„ì‹œì €ì¥</button>
                    <button class="btn-action btn-navy" onclick="changeStatus('pending')">ìŠ¹ì¸ìš”ì²­</button>
                `;
                break;
            case 'pending': // ìŠ¹ì¸ìš”ì²­: [ë‹«ê¸°][ìš”ì²­ì·¨ì†Œ] (ìˆ˜ì • ë¶ˆê°€)
                buttons = `
                    <button class="btn-action btn-white" onclick="closeDetail()">ë‹«ê¸°</button>
                    <button class="btn-action" style="background:var(--danger); color:white;" onclick="cancelApproval()">ìš”ì²­ì·¨ì†Œ</button>
                `;
                break;
            case 'reject': // ë°˜ë ¤: [ë‹«ê¸°][ìˆ˜ì •][ìŠ¹ì¸ìš”ì²­] (ì•Œë¦¼ ì¹´ë“œ í‘œì‹œ)
                buttons = `
                    <button class="btn-action btn-white" onclick="closeDetail()">ë‹«ê¸°</button>
                    <button class="btn-action" style="background:#cbd5e1; color:#475569;" onclick="showRejectEditNotification()">ìˆ˜ì •</button>
                    <button class="btn-action btn-navy" onclick="changeStatus('pending')">ìŠ¹ì¸ìš”ì²­</button>
                `;
                break;
            case 'approved': // ìŠ¹ì¸ì™„ë£Œ: [ë‹«ê¸°][ë³´ê³ ì„œë³´ê¸°] (ìˆ˜ì •ë¶ˆê°€)
                buttons = `
                    <button class="btn-action btn-white" onclick="closeDetail()">ë‹«ê¸°</button>
                    <button class="btn-action btn-navy" onclick="openReportPreview()">ë³´ê³ ì„œ ë³´ê¸°</button>
                `;
                break;
        }
        footerEl.innerHTML = buttons;
        
        // [ê¶Œí•œ ë¶„ê¸°] ìŠ¹ì¸ ì™„ë£Œ ë˜ëŠ” ìŠ¹ì¸ ëŒ€ê¸° ì‹œ ëª¨ë“  ì…ë ¥ ì»¨íŠ¸ë¡¤ ë¹„í™œì„±í™”(ì¡°íšŒ ì „ìš©)
        const inputs = document.querySelectorAll('#detailContent input, #detailContent select, #detailContent button:not(.btn-action)');
        inputs.forEach(el => {
            if (status === 'approved' || status === 'pending') {
                el.disabled = true;
                el.style.opacity = "0.7";
                el.style.pointerEvents = "none";
            } else {
                el.disabled = false;
                el.style.opacity = "1";
                el.style.pointerEvents = "auto";
            }
        });
    }
    
    // ìˆ˜ì • ëª¨ë“œ ì·¨ì†Œ
    function cancelEdit() {
        g_isEditMode = false;
        openDetail(g_currentSite, 'status');
        showToast('ìˆ˜ì •ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.');
    }
    
    // ë³´ê³ ì„œ ë¯¸ë¦¬ë³´ê¸°
    function openReportPreview() {
        const site = g_worklogs[g_currentSite];
        if (!site) {
            showToast('í˜„ì¥ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            return;
        }
        
        // ë³´ê³ ì„œ ë°ì´í„° ì¤€ë¹„
        const reportData = {
            siteKey: g_currentSite,
            baseInfo: site.baseInfo,
            dailyData: site.dailyData,
            status: site.status
        };
        
        // localStorageì— ë³´ê³ ì„œ ë°ì´í„° ì €ì¥
        localStorage.setItem('reportData', JSON.stringify(reportData));
        
        // ë³´ê³ ì„œ í˜ì´ì§€ ì—´ê¸°
        window.open('../ect/@report.html', '_blank');
    }
    
    // [1] ì •ë°€ ê³µìˆ˜ ì¡°ì ˆ ë¡œì§ (0.0 ~ 3.5 ë²”ìœ„, 0.5 ë‹¨ìœ„)
    function updateWorkerHours(idx, delta) {
        const site = g_worklogs[g_currentSite];
        const data = site?.dailyData?.[g_currentDate];
        if (!data || !data.manpowerHistory || !data.manpowerHistory[0]) return;

        const workers = data.manpowerHistory[0].workers;
        const worker = workers?.[idx];
        if (!worker) return;

        let newHours = (parseFloat(worker.hours) || 0) + delta;
        // 0 ~ 3.5 ë²”ìœ„ ì œí•œ ë° 0.5 ë‹¨ìœ„ ì •ë°€ë„ ìœ ì§€
        newHours = Math.max(0, Math.min(3.5, newHours));
        worker.hours = Math.round(newHours * 10) / 10;

        saveData();
        // UI ì¦‰ì‹œ ë°˜ì˜ì„ ìœ„í•´ í˜„ì¬ íƒ­ ìœ ì§€í•˜ë©° ìƒˆë¡œê³ ì¹¨
        openDetail(g_currentSite, g_currentTab);
    }
    
    function increaseWorkerHours(idx, extra = null) {
        updateWorkerHours(idx, 0.5);
    }
    
    function decreaseWorkerHours(idx, extra = null) {
        updateWorkerHours(idx, -0.5);
    }

    function isValidDateKey(v) {
        return /^\d{4}-\d{2}-\d{2}$/.test(String(v || '').trim());
    }

    function switchDetailDate(dateKey) {
        if (!g_currentSite) return;
        if (!g_worklogs[g_currentSite] || !g_worklogs[g_currentSite][dateKey]) return;
        openDetail(g_currentSite, dateKey);
    }

    function addNewWorklogDate() {
        if (!g_currentSite || !g_currentDate) return;
        const siteKey = g_currentSite;
        const siteLogs = g_worklogs[siteKey] || {};
        
        // ìë™ìœ¼ë¡œ ì˜¤ëŠ˜ ë‚ ì§œ ì‚¬ìš©
        const today = new Date();
        let dk = today.toISOString().slice(0, 10);
        
        // ì´ë¯¸ ì˜¤ëŠ˜ ë‚ ì§œê°€ ìˆìœ¼ë©´ ë‹¤ìŒ ë‚ ì§œ ì°¾ê¸°
        let dateCounter = 0;
        while (siteLogs[dk] && dateCounter < 365) {
            today.setDate(today.getDate() + 1);
            dk = today.toISOString().slice(0, 10);
            dateCounter++;
        }
        
        if (siteLogs[dk]) {
            showToast('ë” ì´ìƒ ë‚ ì§œë¥¼ ì¶”ê°€í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
            return;
        }

        const base = siteLogs[g_currentDate];
        const firstDate = Object.keys(siteLogs).sort()[0] || dk;

        // ë¹ˆ ì‘ì—…ì¼ì§€ ìƒì„± (íˆ¬ì…ì¸ì›ê³¼ ì‘ì—…ë‚´ìš©ì€ ë‚˜ì¤‘ì— ì…ë ¥)
        const next = {
            baseInfo: {
                siteName: base?.baseInfo?.siteName || '',
                dept: base?.baseInfo?.dept || '',
                workDate: firstDate,
                status: 'draft',
                rejectReason: null
            },
            workSets: [],
            manpower: [],
            manpowerHistory: [],
            versions: [{ ver: 1, time: new Date().toISOString(), type: 'create', desc: 'ì‘ì—…ì¼ì§€ ìƒì„±' }],
            assets: { photos: [], drawings: [], confirm: null },
            materials: []
        };

        g_worklogs[siteKey][dk] = next;
        g_currentDate = dk;
        saveData();
        openDetail(siteKey, dk);
        showToast(`${dk} ì‘ì—…ì¼ì§€ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.`);
        renderLogs();
    }

    function deleteCurrentDate() {
        if (!g_currentSite || !g_currentDate) return;
        const siteLogs = g_worklogs[g_currentSite].dailyData || {};
        const dateKeys = Object.keys(siteLogs).sort();
        if (dateKeys.length <= 1) {
            showToast('ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. í˜„ì¥ì— ë‚ ì§œê°€ í•˜ë‚˜ë§Œ ì¡´ì¬í•©ë‹ˆë‹¤.');
            return;
        }
        const isConfirmed = confirm(`'${g_currentDate}' ì¼ì§€ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nâ€» ì‚­ì œëœ ë°ì´í„°ëŠ” ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);
        if (!isConfirmed) return;
        delete siteLogs[g_currentDate];
        saveData();
        const nextDate = dateKeys.find(dk => dk !== g_currentDate) || dateKeys[0];
        openDetail(g_currentSite);
        showToast('ë‚ ì§œê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
        renderLogs();
    }

    function cloneWorklogDate() {
        if (!g_currentSite || !g_currentDate) return;
        const siteLogs = g_worklogs[g_currentSite] || {};
        const suggested = new Date().toISOString().slice(0, 10);
        const targetDateKey = prompt('ë³µì œí•  ëŒ€ìƒ ë‚ ì§œë¥¼ ì…ë ¥í•˜ì„¸ìš” (YYYY-MM-DD)', suggested);
        if (!targetDateKey) return;
        const dk = String(targetDateKey).trim();
        if (!isValidDateKey(dk)) {
            showToast('ë‚ ì§œ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤');
            flashInvalid(document.getElementById('detailBasicInfo'));
            return;
        }
        if (siteLogs[dk]) {
            showToast('ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì‘ì—…ì¼ìì…ë‹ˆë‹¤');
            flashInvalid(document.getElementById('detailBasicInfo'));
            return;
        }
        const original = siteLogs[g_currentDate];
        const cloned = JSON.parse(JSON.stringify(original));
        cloned.baseInfo.status = 'draft';
        cloned.baseInfo.rejectReason = null;
        cloned.versions = [{ ver: 1, time: new Date().toISOString(), type: 'create', desc: 'ì‘ì—…ì¼ì§€ ìƒì„± (ë³µì œ)' }];
        siteLogs[dk] = cloned;
        saveData();
        openDetail(g_currentSite, dk);
        showToast('ë‚ ì§œê°€ ë³µì œë˜ì—ˆìŠµë‹ˆë‹¤.');
        renderLogs();
    }

    function toggleManpowerBatchMode() {
        const batchSection = document.getElementById('manpowerBatchSection');
        const normalSection = document.getElementById('manpowerListEdit');
        const toggleBtn = document.getElementById('toggleBatchModeBtn');
        if (!batchSection || !normalSection || !toggleBtn) return;
        const isBatch = batchSection.style.display !== 'none';
        if (isBatch) {
            batchSection.style.display = 'none';
            normalSection.style.display = 'block';
            toggleBtn.textContent = 'í˜„ì¥ ëˆ„ì  ì…ë ¥ ëª¨ë“œ';
        } else {
            batchSection.style.display = 'block';
            normalSection.style.display = 'none';
            toggleBtn.textContent = 'ë‚ ì§œë³„ ì…ë ¥ ëª¨ë“œ';
            renderManpowerBatchGrid();
        }
    }

    function renderManpowerBatchGrid() {
        const siteLogs = g_worklogs[g_currentSite] || {};
        const siteDateKeys = Object.keys(siteLogs).sort();
        const container = document.getElementById('manpowerBatchGrid');
        if (!container) return;
        const allWorkers = new Set();
        siteDateKeys.forEach(dk => {
            const manpower = siteLogs[dk]?.manpowerHistory || [];
            manpower.forEach(day => {
                (day.workers || []).forEach(w => {
                    if (w.name) allWorkers.add(w.name);
                });
            });
        });
        const workerList = Array.from(allWorkers).sort();
        let tableHtml = '<div style="overflow-x:auto;"><table style="width:100%; border-collapse:collapse; font-size:14px;">';
        tableHtml += '<thead><tr><th style="padding:8px; border:1px solid var(--border); background:var(--bg-section);">ì´ë¦„</th>';
        siteDateKeys.forEach(dk => {
            tableHtml += `<th style="padding:8px; border:1px solid var(--border); background:var(--bg-section); min-width:80px;">${dk}</th>`;
        });
        tableHtml += '</tr></thead><tbody>';
        workerList.forEach(name => {
            tableHtml += '<tr>';
            tableHtml += `<td style="padding:8px; border:1px solid var(--border); font-weight:600;">${name}</td>`;
            siteDateKeys.forEach(dk => {
                const manpower = siteLogs[dk]?.manpowerHistory || [];
                let dayHours = 0;
                manpower.forEach(day => {
                    const w = (day.workers || []).find(w => w.name === name);
                    if (w) dayHours = Number(w.hours || 0);
                });
                tableHtml += `<td style="padding:4px; border:1px solid var(--border);"><input type="number" min="0" step="0.5" value="${dayHours}" data-worker="${name}" data-date="${dk}" style="width:100%; border:none; background:transparent; text-align:center; font-weight:500;" /></td>`;
            });
            tableHtml += '</tr>';
        });
        tableHtml += '</tbody></table></div>';
        tableHtml += '<div style="margin-top:12px; display:flex; gap:8px;"><button onclick="addNewWorkerToBatch()" style="padding:8px 16px; border-radius:8px; border:1px solid var(--border); background:var(--primary-bg); color:var(--primary); font-weight:700; cursor:pointer;">+ ì¸ì› ì¶”ê°€</button><button onclick="saveManpowerBatch()" style="padding:8px 16px; border-radius:8px; border:none; background:var(--primary); color:white; font-weight:700; cursor:pointer;">ì €ì¥</button></div>';
        container.innerHTML = tableHtml;
    }

    function addNewWorkerToBatch() {
        const name = prompt('ì¶”ê°€í•  ì¸ì› ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”');
        if (!name) return;
        renderManpowerBatchGrid();
        setTimeout(() => {
            const lastRow = document.querySelector('#manpowerBatchGrid tbody tr:last-child');
            if (lastRow) {
                const nameInput = lastRow.querySelector('input[data-worker]');
                if (nameInput) {
                    nameInput.dataset.worker = name;
                    nameInput.closest('tr').querySelector('td:first-child').textContent = name;
                }
            }
        }, 0);
    }

    function saveManpowerBatch() {
        const siteLogs = g_worklogs[g_currentSite] || {};
        const siteDateKeys = Object.keys(siteLogs).sort();
        const inputs = document.querySelectorAll('#manpowerBatchGrid input[data-worker]');
        const newData = {};
        siteDateKeys.forEach(dk => { newData[dk] = []; });
        inputs.forEach(input => {
            const name = input.dataset.worker;
            const dk = input.dataset.date;
            const hours = Number(input.value) || 0;
            if (hours > 0) {
                newData[dk].push({ name, hours });
            }
        });
        siteDateKeys.forEach(dk => {
            siteLogs[dk].manpowerHistory = [{
                date: dk,
                workers: newData[dk]
            }];
        });
        saveData();
        showToast('í˜„ì¥ ëˆ„ì  ì¸ì›ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
        renderManpowerBatchGrid();
    }

    // [ìˆ˜ì • 5] ìƒì„¸ í™”ë©´ ì—´ê¸° (ëˆ„ì  ë°ì´í„° í†µí•© í‘œì‹œ - ìš”ì•½ ì¹´ë“œ + íƒ­ êµ¬ì¡°)
    let g_currentTab = 'basic'; // í˜„ì¬ í™œì„± íƒ­
    
    function openDetail(siteKey, targetTab = null) {
        g_currentSite = siteKey;
        const site = g_worklogs[siteKey];
        if (!site || !site.baseInfo) {
            return;
        }
        
        const bi = site.baseInfo;
        // [ìˆ˜ì •] ìƒíƒœê°’ ì°¸ì¡° ì¼ì›í™” (site.statusë¥¼ ìš°ì„  ì°¸ì¡°)
        const currentStatus = site.status || (site.baseInfo && site.baseInfo.status) || 'draft';
        const dailyDates = Object.keys(site.dailyData || {}).sort();
        g_currentDate = dailyDates[dailyDates.length - 1] || bi.createdDate;
        
        // [ìˆ˜ì •] targetTabì´ ëª…ì‹œì ìœ¼ë¡œ ì „ë‹¬ë˜ë©´ ê·¸ ê°’ì„ ì‚¬ìš©í•˜ê³ , 
    // ì²˜ìŒ ì¹´ë“œë¥¼ ëˆŒëŸ¬ì„œ ë“¤ì–´ì˜¬ ë•Œ(null)ë§Œ 'status'ë¥¼ ê¸°ë³¸ê°’ìœ¼ë¡œ ì‚¬ìš©í•©ë‹ˆë‹¤.
    if (targetTab) {
        g_currentTab = targetTab;
    } else if (!g_currentTab || targetTab === null) {
        g_currentTab = 'status'; 
    }
        
        const contentEl = document.getElementById('detailContent');
        const footerEl = document.getElementById('detailFooter');
        
        // ëª¨ë“  ë‚ ì§œì˜ ë°ì´í„° ìˆ˜ì§‘
        let allManpower = [];
        let allWorkSets = [];
        let allMaterials = [];
        let allPhotos = [];
        let allDrawings = [];
        let allVersions = [];
        let confirmDoc = null;
        
        dailyDates.forEach(dateKey => {
            const dayData = site.dailyData[dateKey];
            if (!dayData) return;
            
            allManpower = allManpower.concat(dayData.manpower || []);
            allWorkSets = allWorkSets.concat(dayData.workSets || []);
                        (dayData.materials || []).forEach((m, mi) => allMaterials.push({ ...m, _dateKey: dateKey, _idx: mi }));
            
            if (dayData.assets) {
                                (dayData.assets.photos || []).forEach((p, pi) => allPhotos.push({ ...p, _dateKey: dateKey, _idx: pi }));
                                (dayData.assets.drawings || []).forEach((d, di) => allDrawings.push({ ...d, _dateKey: dateKey, _idx: di }));
                if (dayData.assets.confirm) confirmDoc = dayData.assets.confirm;
            }
            
            allVersions = allVersions.concat((dayData.versions || []).map(v => ({ ...v, _dateKey: dateKey })));
        });
        
        allVersions.sort((a, b) => new Date(a.time) - new Date(b.time));
        
        // íˆ¬ì…ì¸ì› ëˆ„ì  ê³„ì‚°
        const totalDays = dailyDates.length;
        const totalWorkers = new Set(allManpower.flatMap(m => m.workers.map(w => w.name))).size;
        const totalHours = allManpower.reduce((sum, m) => 
            sum + m.workers.reduce((s, w) => s + Number(w.hours || 0), 0), 0);
        
        // ì‘ì—… ë‚´ìš© ì¤‘ë³µ ì œê±°
        const uniqueMembers = [...new Set(allWorkSets.map(ws => ws.member).filter(Boolean))];
        const uniqueProcesses = [...new Set(allWorkSets.map(ws => ws.process).filter(Boolean))];
        const uniqueTypes = [...new Set(allWorkSets.map(ws => ws.type).filter(Boolean))];
        const uniqueLocations = [...new Set(allWorkSets.map(ws => {
            const loc = ws.location || {};
            return [loc.block, loc.dong, loc.floor].filter(Boolean).join('/');
        }).filter(Boolean))];
        
        const photoCount = allPhotos.length;
        const drawingCount = allDrawings.length;
        const materialCount = allMaterials.length;
        const hasConfirm = !!confirmDoc;
        
        let html = `
            <!-- ëˆ„ì  ìš”ì•½ ì¹´ë“œ -->
            <div style="background:linear-gradient(135deg, #eaf6ff 0%, #f0f9ff 100%); border:1px solid #bae6fd; border-radius:12px; padding:16px; margin-bottom:16px;">
                <div style="display:grid; grid-template-columns:repeat(4, 1fr); gap:8px;">
                    <div style="text-align:center;">
                        <div style="font-size:20px; font-weight:800; color:#31a3fa; margin-bottom:4px;">${dailyDates.length}ê±´</div>
                        <div style="font-size:12px; color:var(--text-sub); font-weight:600;">ì‘ì—…ì¼ì§€</div>
                    </div>
                    <div style="text-align:center;">
                        <div style="font-size:20px; font-weight:800; color:#31a3fa; margin-bottom:4px;">${photoCount}ê±´</div>
                        <div style="font-size:12px; color:var(--text-sub); font-weight:600;">ì‚¬ì§„ ìë£Œ</div>
                    </div>
                    <div style="text-align:center;">
                        <div style="font-size:20px; font-weight:800; color:#31a3fa; margin-bottom:4px;">${drawingCount}ê±´</div>
                        <div style="font-size:12px; color:var(--text-sub); font-weight:600;">ë„ë©´í•¨</div>
                    </div>
                    <div style="text-align:center;">
                        <div style="font-size:20px; font-weight:800; color:#31a3fa; margin-bottom:4px;">${hasConfirm ? '1' : '0'}ê±´</div>
                        <div style="font-size:12px; color:var(--text-sub); font-weight:600;">í™•ì¸ì„œ</div>
                    </div>
                </div>
            </div>
            
            <!-- ì‘ì—…í˜„í™© íƒ­ -->
            <div id="tab-content-status" class="tab-content">
            
            ${site.status === 'reject' ? `
            <!-- ë°˜ë ¤ ì‚¬ìœ  ì¹´ë“œ (í˜„ì¥ì •ë³´ ìƒë‹¨ì— ê³„ì† í‘œì‹œ) -->
            <div class="detail-section reject-reason-alert" style="background:linear-gradient(135deg, #fef2f2 0%, #fff1f2 100%); border:2px solid #dc2626; border-radius:16px; padding:16px; margin-bottom:16px; box-shadow: 0 4px 20px rgba(220, 38, 38, 0.25), 0 0 0 4px rgba(220, 38, 38, 0.1);">
                <div style="display:flex; align-items:center; gap:10px; margin-bottom:12px;">
                    <div style="width:32px; height:32px; background:linear-gradient(135deg, #dc2626, #b91c1c); border-radius:50%; display:flex; align-items:center; justify-content:center; box-shadow: 0 2px 8px rgba(220, 38, 38, 0.3);">
                        <i data-lucide="alert-circle" style="width:18px; height:18px; color:white;"></i>
                    </div>
                    <span style="font-size:16px; font-weight:800; color:#dc2626;">ë°˜ë ¤ ì‚¬ìœ </span>
                </div>
                <div style="background:white; padding:14px; border-radius:12px; font-size:15px; line-height:1.6; color:#991b1b; font-weight:600; border-left:4px solid #dc2626;">
                    ${bi.rejectReason || 'ì‚¬ìœ  ì—†ìŒ'}
                </div>
            </div>
            ` : ''}
            
            <!-- í˜„ì¥ ì •ë³´ -->
            <div class="detail-section">
                ${currentStatus === 'reject' ? `
                <div class="detail-section reject-reason-alert" style="background:linear-gradient(135deg, #fef2f2 0%, #fff1f2 100%); border:2px solid #dc2626; border-radius:16px; padding:16px; margin-bottom:16px;">
                    <div style="display:flex; align-items:center; gap:10px; margin-bottom:12px;">
                        <div style="width:32px; height:32px; background:#dc2626; border-radius:50%; display:flex; align-items:center; justify-content:center;">
                            <i data-lucide="alert-circle" style="width:18px; color:white;"></i>
                        </div>
                        <span style="font-size:16px; font-weight:800; color:#dc2626;">ë°˜ë ¤ ì‚¬ìœ </span>
                    </div>
                    <div style="background:rgba(255,255,255,0.8); padding:14px; border-radius:12px; font-size:15px; color:#991b1b; font-weight:600;">
                        ${bi.rejectReason || 'ì‚¬ìœ  ì—†ìŒ'}
                    </div>
                </div>` : ''}
                
                <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:16px;">
                    <div style="display:flex; align-items:center; gap:8px;">
                        <i data-lucide="info" style="width:20px; color:var(--navy-dark);"></i>
                        <span style="font-size:18px; font-weight:800; color:var(--navy-dark);">í˜„ì¥ ì •ë³´</span>
                    </div>
                    <span class="status-badge ${currentStatus}">
                        ${getStatusLabel(currentStatus)}
                    </span>
                </div>
                
                ${g_isEditMode && site.status === 'reject' ? (() => {
                    const rejectReason = bi.rejectReason || '';
                    const editableFields = parseRejectReason(rejectReason);
                    const isFieldEditable = (field) => editableFields.includes(field) || editableFields.includes('all');
                    const siteInfo = getSiteInfo(bi.siteName);
                    
                    return isFieldEditable('siteName') ? `
                    <!-- ìˆ˜ì • ëª¨ë“œ: í˜„ì¥ëª… ì…ë ¥ -->
                    <div class="mb-4">
                        <label class="block text-[17px] font-bold text-text-sub mb-2">
                            í˜„ì¥ëª… (ì†Œì† ìë™ì—°ë™) <span style="color: var(--danger)">*</span>
                        </label>
                        <div class="relative">
                            <input 
                                type="text"
                                id="editSiteName"
                                placeholder="í˜„ì¥ ì„ íƒ ë˜ëŠ” ê²€ìƒ‰"
                                class="site-search-optimized w-full h-[54px] bg-bg-input border border-border rounded-xl px-4 text-[17px] font-medium outline-none transition-all placeholder:text-slate-400"
                                value="${bi.siteName}"
                                style="background: var(--bg-input); border: 1px solid var(--border)"
                            />
                            <button onclick="toggleSiteDropdownEdit()" class="absolute right-4 top-1/2 -translate-y-1/2 text-slate-400 hover:text-slate-600 transition-colors">
                                <i data-lucide="chevron-down" style="width: 20px; height: 20px"></i>
                            </button>
                            <ul id="siteDropdownEdit" class="site-dropdown-optimized absolute z-50 w-full mt-1.5 max-h-60 overflow-auto bg-[var(--bg-surface)] border border-border rounded-xl shadow-xl hidden" style="background: var(--bg-surface); border: 1px solid var(--border)">
                            </ul>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-3 mb-4">
                        <div>
                            <label class="block text-[15px] font-bold text-text-sub mb-2">
                                ì†Œì† <span class="text-[14px] font-medium ml-1">ã…£ ìë™ì—°ë™</span>
                            </label>
                            <input 
                                type="text" 
                                id="editDept" 
                                readonly 
                                value="${siteInfo.dept}"
                                class="w-full h-[54px] bg-slate-100 border border-border rounded-xl px-4 text-[17px] font-medium text-text-sub cursor-not-allowed" 
                                style="background: #f1f5f9; border: 1px solid var(--border); color: var(--text-sub)"
                            />
                        </div>
                        <div>
                            <label class="block text-[15px] font-bold text-text-sub mb-2">ì‘ì—…ì¼ì</label>
                            <input 
                                type="date" 
                                id="editWorkDate"
                                class="w-full h-[54px] bg-bg-input border border-border rounded-xl px-4 text-[15px] font-medium outline-none focus:border-primary focus:ring-2 focus:ring-primary/20 transition-all cursor-pointer"
                                value="${g_currentDate}"
                                style="background: var(--bg-input); border: 1px solid var(--border); font-family: var(--font-main)"
                            />
                        </div>
                    </div>
                    ` : `
                    <!-- ì½ê¸° ëª¨ë“œ: ìŠ¹ì¸ëœ í˜„ì¥ ì •ë³´ -->
                    <div style="background:#f0fdf4; border:2px solid #86efac; border-radius:12px; padding:16px; margin-bottom:12px;">
                        <div style="display:flex; align-items:center; gap:12px; margin-bottom:8px;">
                            <i data-lucide="check-circle" style="width:24px; color:#10b981;"></i>
                            <div style="font-size:15px; font-weight:700; color:#065f46;">í˜„ì¥ ì •ë³´ê°€ ìŠ¹ì¸ë˜ì—ˆìŠµë‹ˆë‹¤</div>
                        </div>
                        <div style="display:grid; grid-template-columns:repeat(2, 1fr); gap:8px;">
                            <div style="background:white; padding:10px; border-radius:8px;">
                                <div style="font-size:12px; color:#059669; margin-bottom:4px;">í˜„ì¥ëª…</div>
                                <div style="font-size:14px; font-weight:700; color:#065f46;">${bi.siteName}</div>
                            </div>
                            <div style="background:white; padding:10px; border-radius:8px;">
                                <div style="font-size:12px; color:#059669; margin-bottom:4px;">ì†Œì†</div>
                                <div style="font-size:14px; font-weight:700; color:#065f46;">${bi.dept}</div>
                            </div>
                        </div>
                    </div>
                    `;
                })() : `
                <!-- ì½ê¸° ëª¨ë“œ: ì¼ë°˜ í˜„ì¥ ì •ë³´ -->
                <div style="display:grid; grid-template-columns:repeat(2, 1fr); gap:12px;">
                    <div style="background:#f8fafc; padding:12px; border-radius:10px;">
                        <div style="font-size:13px; color:var(--text-sub); margin-bottom:4px; font-weight:700;">í˜„ì¥ëª…</div>
                        <div style="font-size:15px; font-weight:700; color:var(--text-main);">${bi.siteName}</div>
                    </div>
                    <div style="background:#f8fafc; padding:12px; border-radius:10px; display:flex; gap:8px;">
                        <div style="flex:1; display:flex; flex-direction:column;">
                            <div style="font-size:13px; color:var(--text-sub); margin-bottom:4px; font-weight:700;">ì›ì²­ì‚¬</div>
                            <div style="font-size:15px; font-weight:700; color:var(--text-main);">${bi.contractor || '-'}</div>
                        </div>
                        <div style="width:1px; background:#e2e8f0;"></div>
                        <div style="flex:1; display:flex; flex-direction:column;">
                            <div style="font-size:13px; color:var(--text-sub); margin-bottom:4px; font-weight:700;">ì†Œì†</div>
                            <div style="font-size:15px; font-weight:700; color:var(--text-main);">${bi.dept}</div>
                        </div>
                    </div>
                    <div style="background:#f8fafc; padding:12px; border-radius:10px;">
                        <div style="font-size:13px; color:var(--text-sub); margin-bottom:4px; font-weight:700;">íˆ¬ì…ì¼</div>
                        <div style="font-size:15px; font-weight:700; color:#31a3fa;">${dailyDates.length}ì¼</div>
                    </div>
                    <div style="background:#f8fafc; padding:12px; border-radius:10px;">
                        <div style="font-size:13px; color:var(--text-sub); margin-bottom:4px; font-weight:700;">ìƒì„±ì¼</div>
                        <div style="font-size:15px; font-weight:700; color:var(--text-main);">${bi.createdDate}</div>
                    </div>
                </div>
                `}
            </div>
            
            <!-- ìˆ˜ì • ëª¨ë“œ: ë‚ ì§œë³„ ìƒì„¸ ìˆ˜ì • í¼ -->
            ${g_isEditMode ? (() => {
                // ë°˜ë ¤ ìƒíƒœê°€ ì•„ë‹ˆë©´ ëª¨ë“  í•„ë“œ ìˆ˜ì • ê°€ëŠ¥
                const rejectReason = bi.rejectReason || '';
                const editableFields = site.status === 'reject' ? parseRejectReason(rejectReason) : ['all'];
                const isFieldEditable = (field) => editableFields.includes(field) || editableFields.includes('all');
                const currentData = site.dailyData[g_currentDate] || {};
                
                return `
                <div class="detail-section">
                    <div style="display:flex; align-items:center; gap:8px; margin-bottom:16px;">
                        <i data-lucide="edit-3" style="width:20px; color:var(--navy-dark);"></i>
                        <span style="font-size:18px; font-weight:800; color:var(--navy-dark);">${g_currentDate} ìƒì„¸ ìˆ˜ì •</span>
                        <button onclick="saveDetailedEdit()" style="background:linear-gradient(135deg, rgba(16, 185, 129, 0.15), rgba(16, 185, 129, 0.05)); color:#047857; height:36px; padding:0 16px; border-radius:12px; font-size:14px; font-weight:800; display:flex; align-items:center; gap:4px; border:none; cursor:pointer; transition:all 0.2s; margin-left:auto;">
                            <i data-lucide="save" style="width:16px;"></i>
                            ì €ì¥
                        </button>
                    </div>
                    
                    ${isFieldEditable('manpower') ? `
                    <!-- íˆ¬ì…ì¸ì› ìˆ˜ì • -->
                    <div class="mb-6">
                        <div class="sec-head" style="display:flex; align-items:center; justify-content:space-between; font-size:17px; font-weight:700; color:var(--navy-dark); margin-bottom:14px;">
                            <div style="display:flex; align-items:center; gap:8px;">
                                <i data-lucide="users" style="width:20px; color:var(--navy-dark);"></i>
                                íˆ¬ì…ì¸ì› <span style="color:var(--danger);">*</span>
                            </div>
                            <button onclick="addWorker(0)" class="bg-primary-bg text-primary h-8 px-3 rounded-xl text-sm font-bold flex items-center gap-1 hover:bg-sky-100 transition-colors whitespace-nowrap" style="background: var(--primary-bg); color: var(--primary)">
                                <span class="text-lg font-black">+</span> ì¶”ê°€
                            </button>
                        </div>
                        <div id="manpowerListEdit">
                            ${(() => {
                                // ë¦¬ìŠ¤íŠ¸ì¹´ë“œì—ì„œ ì‘ì—…ì ì •ë³´ ì¶”ì¶œ (ì‚¬ë‹¨ í˜„ì¥ ê¸°ë¡ ê¸°ë³¸ê°’)
                                const workSets = currentData.workSets || [];
                                const members = [...new Set(workSets.map(ws => ws.member).filter(Boolean))];
                                const processes = [...new Set(workSets.map(ws => ws.process).filter(Boolean))];
                                const manpower = currentData.manpower || [];
                                
                                // ê¸°ë³¸ ì‘ì—…ì ì •ë³´ ìƒì„± (ì‚¬ë‹¨ í˜„ì¥ ê¸°ë¡ ë¦¬ìŠ¤íŠ¸ ê¸°ë³¸ê°’)
                                const defaultWorkers = [];
                                if (manpower.length > 0) {
                                    manpower.forEach(worker => {
                                        defaultWorkers.push({
                                            ...worker,
                                            isDefault: true, // ê¸°ë³¸ê°’ í‘œì‹œ
                                            isCustom: false
                                        });
                                    });
                                } else if (members.length > 0) {
                                    defaultWorkers.push({
                                        name: members[0] || 'ì‘ì—…ì',
                                        hours: 1.0,
                                        isDefault: true,
                                        isCustom: false
                                    });
                                } else {
                                    defaultWorkers.push({
                                        name: 'ì‘ì—…ì',
                                        hours: 1.0,
                                        isDefault: true,
                                        isCustom: false
                                    });
                                }
                                
                                // manpowerHistoryê°€ ìˆìœ¼ë©´ ì‚¬ìš©, ì—†ìœ¼ë©´ ê¸°ë³¸ê°’ìœ¼ë¡œ ìƒì„±
                                const displayManpower = currentData.manpowerHistory && currentData.manpowerHistory.length > 0 
                                    ? currentData.manpowerHistory.map(mp => ({
                                        ...mp,
                                        workers: mp.workers.map(worker => ({
                                            ...worker,
                                            isDefault: worker.isDefault || false,
                                            isCustom: worker.isCustom || false
                                        }))
                                    }))
                                    : [{
                                        date: g_currentDate,
                                        workers: defaultWorkers
                                    }];
                                
                                return displayManpower.map((mp, idx) => `
                                    <div class="manpower-item mb-3" data-idx="${idx}">
                                        <div class="flex items-center justify-between gap-2 mb-2">
                                            <div class="flex items-center gap-2 flex-1 min-w-0">
                                                <input type="date" class="h-[54px] bg-bg-input border border-border rounded-xl px-3 text-[16px] font-medium outline-none flex-1 min-w-[150px]" value="${mp.date || g_currentDate}" style="background: var(--bg-input); border: 1px solid var(--border);" onchange="updateManpowerDate(${idx}, this.value)">
                                            </div>
                                            <div class="flex items-center gap-2 flex-shrink-0">
                                                ${displayManpower.length > 1 ? `
                                                <button onclick="removeManpowerItem(${idx})" class="text-red-500 hover:text-red-700">
                                                    <i data-lucide="trash-2" style="width:16px;"></i>
                                                </button>
                                                ` : ''}
                                            </div>
                                        </div>
                                        <div class="flex flex-col gap-2.5" data-manpower-idx="${idx}">
                                            ${mp.workers.map((worker, widx) => `
                                                <div class="grid grid-cols-[minmax(0,1.05fr)_minmax(0,0.95fr)_auto] sm:grid-cols-[1.2fr_1fr_auto] gap-2 sm:gap-2.5 items-center bg-slate-50 dark:bg-slate-700/50 p-3 sm:p-3.5 rounded-2xl transition-all" style="background: var(--bg-input)">
                                                    <div class="relative w-full min-w-0">
                                                        ${!worker.isCustom ? `
                                                            <select 
                                                                onchange="updateWorkerName(${idx}, ${widx}, this.value === '__custom__' ? 'CUSTOM' : this.value)"
                                                                class="worker-select"
                                                                style="height:54px; font-size:16px;"
                                                            >
                                                                <option value="">ì‘ì—…ì</option>
                                                                ${['ê¹€ì² ìˆ˜', 'ì´ì˜í¬', 'ë°•ë¯¼ì¤€', 'ìµœì„œì—°', 'ì •ë‹¤ìš´', 'ê°•í•˜ëŠ˜'].map(w => `<option value="${w}" ${worker.name === w ? 'selected' : ''}>${w}</option>`).join('')}
                                                                ${worker.name && !['ê¹€ì² ìˆ˜', 'ì´ì˜í¬', 'ë°•ë¯¼ì¤€', 'ìµœì„œì—°', 'ì •ë‹¤ìš´', 'ê°•í•˜ëŠ˜'].includes(worker.name) ? `<option value="${worker.name}" selected>${worker.name}</option>` : ''}
                                                                <option value="__custom__">ì§ì ‘ì…ë ¥</option>
                                                            </select>
                                                        ` : `
                                                            <input 
                                                                autoFocus
                                                                placeholder="ì´ë¦„ ì…ë ¥"
                                                                value="${worker.name || ''}"
                                                                onblur="updateWorkerName(${idx}, ${widx}, this.value || 'CANCEL')"
                                                                onkeypress="if(event.key === 'Enter') { this.blur(); }"
                                                                class="w-full h-[54px] bg-[var(--bg-surface)] dark:bg-slate-900 border border-border dark:border-slate-600 rounded-xl px-4 outline-none focus:border-primary focus:ring-2 focus:ring-primary/20 transition-all text-[16px] font-medium placeholder:text-slate-400 dark:placeholder:text-slate-500"
                                                                style="background: var(--bg-surface); border: 1px solid var(--border)"
                                                            />
                                                        `}
                                                    </div>
                                                    
                                                    <div class="flex h-[54px] border border-border rounded-xl bg-[var(--bg-surface)] overflow-hidden w-full min-w-0" style="border: 1px solid var(--border); background: var(--bg-surface)">
                                                        <button onclick="decreaseWorkerHours(${idx}, ${widx})" class="flex-1 flex items-center justify-center text-xl text-text-sub hover:bg-slate-50 w-10 sm:w-auto">ï¼</button>
                                                        <span class="flex-1 flex items-center justify-center text-[17px] font-bold border-x border-slate-100 min-w-[30px] sm:min-w-[50px]" style="border-color: var(--border)">${(worker.hours || 0).toFixed(1)}</span>
                                                        <button onclick="increaseWorkerHours(${idx}, ${widx})" class="flex-1 flex items-center justify-center text-xl text-text-sub hover:bg-slate-50 w-10 sm:w-auto">ï¼‹</button>
                                                    </div>

                                                    ${mp.workers.length > 1 ? `
                                                        <button onclick="removeWorker(${idx}, ${widx})" class="bg-red-50 text-red-500 text-sm font-bold px-2.5 py-1 rounded-xl">ì‚­ì œ</button>
                                                    ` : '<div style="width:48px;"></div>'}
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>
                                `).join('');
                            })()}
                        </div>
                    </div>
                    ` : `
                    <div class="mb-6" style="background:#f0fdf4; border:2px solid #86efac; border-radius:12px; padding:16px;">
                        <div style="display:flex; align-items:center; gap:12px; margin-bottom:8px;">
                            <i data-lucide="check-circle" style="width:24px; color:#10b981;"></i>
                            <div style="font-size:15px; font-weight:700; color:#065f46;">íˆ¬ì…ì¸ì› ì •ë³´ê°€ ìŠ¹ì¸ë˜ì—ˆìŠµë‹ˆë‹¤</div>
                        </div>
                    </div>
                    `}
                    
                    ${isFieldEditable('workSets') ? `
                    <!-- ì‘ì—…ë‚´ìš© ìˆ˜ì • -->
                    <div class="mb-6">
                        <div class="sec-head" style="display:flex; align-items:center; gap:8px; font-size:17px; font-weight:700; color:var(--navy-dark); margin-bottom:14px;">
                            <i data-lucide="hard-hat" style="width:20px; color:var(--navy-dark);"></i>
                            ì‘ì—…ë‚´ìš© <span style="color:var(--danger);">*</span>
                            <button onclick="addWorkSetEdit()" class="bg-primary-bg text-primary h-8 px-3.5 rounded-xl text-sm font-bold flex items-center gap-1 hover:bg-sky-100 transition-colors ml-auto" style="background: var(--primary-bg); color: var(--primary)">
                                <span class="text-lg font-black">+</span> ì¶”ê°€
                            </button>
                        </div>
                        <div class="flex flex-col gap-4" id="workSetsEdit">
                            ${currentData.workSets && currentData.workSets.length > 0 ? currentData.workSets.map((ws, idx) => `
                                <div class="bg-bg-surface rounded-2xl p-4 border border-border" style="background: var(--bg-surface); border: 1px solid var(--border);">
                                    <div class="flex justify-between items-center mb-3">
                                        <span class="text-sm font-bold text-primary bg-primary-bg px-3 py-1.5 rounded-lg" style="color: var(--primary); background: var(--primary-bg)">ì‘ì—… ì„¸íŠ¸ ${idx + 1}</span>
                                        <button onclick="removeWorkSetEdit(${idx})" class="bg-red-50 text-red-500 text-sm font-bold px-3 py-1 rounded-xl">ì‚­ì œ</button>
                                    </div>
                                    
                                    <!-- ë¶€ì¬ëª… -->
                                    <div class="mb-3">
                                        <label class="block text-[17px] font-bold text-text-sub mb-2">ë¶€ì¬ëª… <span style="color: var(--danger)">*</span></label>
                                        <div class="grid grid-cols-4 gap-2 mb-2">
                                            ${['ìŠ¬ë¼ë¸Œ', 'ê±°ë”', 'ê¸°ë‘¥', 'ê¸°íƒ€'].map(chip => `
                                                <button 
                                                    onclick="toggleWorkSetChipEdit(${idx}, 'member', '${chip}')"
                                                    class="h-[54px] rounded-xl border text-[17px] font-medium transition-all ${
                                                        ws.member === chip 
                                                            ? 'bg-[var(--bg-surface)] border-primary text-primary font-bold shadow-sm' 
                                                            : 'bg-bg-input border-border text-text-sub'
                                                    }"
                                                    style="${ws.member === chip ? 'background: var(--bg-surface); border: 1px solid var(--primary); color: var(--primary)' : 'background: var(--bg-input); border: 1px solid var(--border); color: var(--text-sub)'}"
                                                >
                                                    ${chip}
                                                </button>
                                            `).join('')}
                                        </div>
                                        ${ws.member === 'ê¸°íƒ€' ? `
                                            <input 
                                                class="w-full h-[54px] border border-border rounded-xl px-4 text-[17px] mt-1 outline-none focus:border-primary focus:ring-2 focus:ring-primary/20 transition-all"
                                                placeholder="ì§ì ‘ ì…ë ¥"
                                                value="${ws.customMemberValue || ''}"
                                                id="customMemberEdit${idx}"
                                                style="border: 1px solid var(--border); "
                                            />
                                        ` : ''}
                                    </div>
                                    
                                    <!-- ì‘ì—…ê³µì • -->
                                    <div class="mb-3">
                                        <label class="block text-[17px] font-bold text-text-sub mb-2">ì‘ì—…ê³µì • <span style="color: var(--danger)">*</span></label>
                                        <div class="grid grid-cols-4 gap-2 mb-2">
                                            ${['ê· ì—´', 'ë©´', 'ë§ˆê°', 'ê¸°íƒ€'].map(chip => `
                                                <button 
                                                    onclick="toggleWorkSetChipEdit(${idx}, 'process', '${chip}')"
                                                    class="h-[54px] rounded-xl border text-[17px] font-medium transition-all ${
                                                        ws.process === chip 
                                                            ? 'bg-[var(--bg-surface)] border-primary text-primary font-bold shadow-sm' 
                                                            : 'bg-bg-input border-border text-text-sub'
                                                    }"
                                                    style="${ws.process === chip ? 'background: var(--bg-surface); border: 1px solid var(--primary); color: var(--primary)' : 'background: var(--bg-input); border: 1px solid var(--border); color: var(--text-sub)'}"
                                                >
                                                    ${chip}
                                                </button>
                                            `).join('')}
                                        </div>
                                        ${ws.process === 'ê¸°íƒ€' ? `
                                            <input 
                                                class="w-full h-[54px] border border-border rounded-xl px-4 text-[17px] mt-1 outline-none focus:border-primary focus:ring-2 focus:ring-primary/20 transition-all"
                                                placeholder="ì§ì ‘ ì…ë ¥"
                                                value="${ws.customProcessValue || ''}"
                                                id="customProcessEdit${idx}"
                                                style="border: 1px solid var(--border); "
                                            />
                                        ` : ''}
                                    </div>
                                    
                                    <!-- ì‘ì—…ìœ„ì¹˜ -->
                                    <div class="mb-3">
                                        <label class="block text-[15px] font-bold text-text-sub mb-2">ì‘ì—…ìœ í˜•</label>
                                        <div class="grid grid-cols-4 gap-2 mb-3">
                                            ${['ì§€í•˜', 'ì§€ìƒ', 'ì§€ë¶•', 'ê¸°íƒ€'].map(chip => `
                                                <button 
                                                    onclick="toggleWorkTypeChipEdit(${idx}, '${chip}')"
                                                    class="h-[54px] rounded-xl border text-[16px] font-medium transition-all ${
                                                        ws.type === chip 
                                                            ? 'bg-[var(--bg-surface)] border-primary text-primary font-bold shadow-sm' 
                                                            : 'bg-bg-input border-border text-text-sub'
                                                    }"
                                                    style="${ws.type === chip ? 'background: var(--bg-surface); border: 1px solid var(--primary); color: var(--primary)' : 'background: var(--bg-input); border: 1px solid var(--border); color: var(--text-sub)'}"
                                                    data-work-type="${chip}"
                                                >
                                                    ${chip}
                                                </button>
                                            `).join('')}
                                        </div>
                                        ${ws.type === 'ê¸°íƒ€' ? `
                                            <input 
                                                class="w-full h-[54px] border border-border rounded-xl px-4 text-[16px] mb-3 outline-none focus:border-primary focus:ring-2 focus:ring-primary/20 transition-all"
                                                placeholder="ì§ì ‘ ì…ë ¥"
                                                value="${ws.customTypeValue || ''}"
                                                id="customTypeEdit${idx}"
                                                style="border: 1px solid var(--border);"
                                            />
                                        ` : ''}
                                        <label class="block text-[15px] font-bold text-text-sub mb-2">ë¸”ëŸ­ / ë™ / ì¸µ</label>
                                        <div class="grid grid-cols-3 gap-2">
                                            <input 
                                                type="text"
                                                id="blockEdit${idx}"
                                                placeholder="ë¸”ëŸ­"
                                                value="${ws.location?.block || ''}"
                                                class="h-[54px] border border-border rounded-xl px-3 text-[16px] font-medium outline-none focus:border-primary focus:ring-2 focus:ring-primary/20 transition-all"
                                                style="border: 1px solid var(--border);"
                                                onchange="updateLocationEdit(${idx}, 'block', this.value)"
                                            />
                                            <input 
                                                type="text"
                                                id="dongEdit${idx}"
                                                placeholder="ë™"
                                                value="${ws.location?.dong || ''}"
                                                class="h-[54px] border border-border rounded-xl px-3 text-[16px] font-medium outline-none focus:border-primary focus:ring-2 focus:ring-primary/20 transition-all"
                                                style="border: 1px solid var(--border);"
                                                onchange="updateLocationEdit(${idx}, 'dong', this.value)"
                                            />
                                            <input 
                                                type="text"
                                                id="floorEdit${idx}"
                                                placeholder="ì¸µ"
                                                value="${ws.location?.floor || ''}"
                                                class="h-[54px] border border-border rounded-xl px-3 text-[16px] font-medium outline-none focus:border-primary focus:ring-2 focus:ring-primary/20 transition-all"
                                                style="border: 1px solid var(--border);"
                                                onchange="updateLocationEdit(${idx}, 'floor', this.value)"
                                            />
                                        </div>
                                    </div>
                                </div>
                            `).join('') : '<div class="text-center text-text-sub py-4">ì‘ì—… ì„¸íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.</div>'}
                        </div>
                    </div>
                    ` : `
                    <div class="mb-6" style="background:#f0fdf4; border:2px solid #86efac; border-radius:12px; padding:16px;">
                        <div style="display:flex; align-items:center; gap:12px; margin-bottom:8px;">
                            <i data-lucide="check-circle" style="width:24px; color:#10b981;"></i>
                            <div style="font-size:15px; font-weight:700; color:#065f46;">ì‘ì—…ë‚´ìš©ì´ ìŠ¹ì¸ë˜ì—ˆìŠµë‹ˆë‹¤</div>
                        </div>
                    </div>
                    `}
                </div>
                `;
            })() : ''}
            
            <!-- ì‘ì—…ì¼ì ë¦¬ìŠ¤íŠ¸ -->
            <div class="detail-section">
                <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:16px;">
                    <div style="display:flex; align-items:center; gap:8px;">
                        <i data-lucide="calendar" style="width:20px; color:var(--navy-dark);"></i>
                        <span style="font-size:18px; font-weight:800; color:var(--navy-dark);">í˜„ì¥ê¸°ë¡ (${dailyDates.length}ì¼)</span>
                    </div>
                    <div style="display:flex; align-items:center; gap:8px;">
                        ${site.deletedDates && site.deletedDates.length > 0 ? `
                            <button onclick="viewDeletedDates('${g_currentSite}')" style="background:rgba(220, 38, 38, 0.1); color:#dc2626; height:32px; padding:0 14px; border-radius:12px; font-size:13px; font-weight:700; display:flex; align-items:center; gap:4px; border:none; cursor:pointer; transition:all 0.2s;">
                                <i data-lucide="rotate-ccw" style="width:16px;"></i> ë³µì› (${site.deletedDates.length})
                            </button>
                        ` : ''}
                        ${currentStatus !== 'approved' ? `
                            <button onclick="openAddWorklogModal()" style="background:rgba(49, 163, 250, 0.1); color:#31a3fa; height:32px; padding:0 14px; border-radius:12px; font-size:14px; font-weight:700; display:flex; align-items:center; gap:4px; border:none; cursor:pointer; transition:all 0.2s;">
                                <span style="font-size:18px; font-weight:800;">+</span> ì¶”ê°€
                            </button>
                        ` : ''}
                        ${dailyDates.length > 3 ? `
                            <button id="toggleWorkHistoryBtn" onclick="toggleWorkHistory()" style="background:var(--bg-input); border:1px solid var(--border); height:32px; padding:0 12px; border-radius:8px; font-size:13px; font-weight:600; display:flex; align-items:center; gap:4px; color:var(--text-sub); cursor:pointer;">
                                <span>ë” ë³´ê¸°</span>
                                <i data-lucide="chevron-down" id="workHistoryChevron" style="width:16px; transition:transform 0.3s;"></i>
                            </button>
                        ` : ''}
                    </div>
                </div>
                <div id="workHistorySection" data-open="false" style="display:none; opacity:0; max-height:0px; overflow:hidden; transition:all 0.4s ease;">
                    <div style="display:flex; flex-direction:column; gap:8px;">
                        ${dailyDates.sort().reverse().slice(3).map(date => {
                        const dayData = site.dailyData[date];
                        const workSets = dayData?.workSets || [];
                        const members = [...new Set(workSets.map(ws => ws.member).filter(Boolean))];
                        const processes = [...new Set(workSets.map(ws => ws.process).filter(Boolean))];
                        const types = [...new Set(workSets.map(ws => ws.type).filter(Boolean))];
                        const locations = workSets.map(ws => {
                            const loc = ws.location || {};
                            return [loc.block, loc.dong, loc.floor].filter(Boolean).join('/');
                        }).filter(Boolean);
                        const uniqueLocations = [...new Set(locations)];
                        const manpower = dayData?.manpower || [];
                        const versions = dayData?.versions || [];
                        const currentVersion = versions.length > 0 ? versions[versions.length - 1].ver : 1;
                        
                        return `
                        <div style="background:#ffffff; border:1px solid #e2e8f0; border-radius:12px; padding:12px;">
                            <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:6px;">
                                <div style="display:flex; align-items:center; gap:8px;">
                                    <div style="font-size:16px; font-weight:800; color:var(--text-main);">${date}</div>
                                    ${versions.length > 1 ? `
                                        <div style="background:var(--header-navy); color:white; font-size:11px; font-weight:700; padding:2px 6px; border-radius:10px;">v${currentVersion}</div>
                                    ` : ''}
                                </div>
                                ${site.status !== 'approved' ? `
                                    <div style="display:flex; gap:8px;">
                                        <button onclick="editWorklogDate('${date}')" style="background:none; border:none; cursor:pointer; padding:4px; color:var(--text-sub);">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" data-lucide="edit-3" style="width:18px;" class="lucide lucide-edit-3"><path d="M13 21h8"></path><path d="M21.174 6.812a1 1 0 0 0-3.986-3.987L3.842 16.174a2 2 0 0 0-.5.83l-1.321 4.352a.5.5 0 0 0 .623.622l4.353-1.32a2 2 0 0 0 .83-.497z"></path></svg>
                                        </button>
                                        ${dailyDates.length > 1 ? `
                                            <button onclick="deleteDateWithConfirm('${date}')" style="background:none; border:none; cursor:pointer; padding:4px; color:#dc2626;">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" data-lucide="trash-2" style="width:18px;" class="lucide lucide-trash-2"><path d="M10 11v6"></path><path d="M14 11v6"></path><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"></path><path d="M3 6h18"></path><path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                                            </button>
                                        ` : ''}
                                    </div>
                                ` : ''}
                            </div>
                            ${workSets.length > 0 ? `
                                <div style="font-size:14px; color:var(--text-sub); line-height:1.5;">
                                    ${manpower.length > 0 ? manpower.map(mp => {
                                        const workers = mp.workers.map(w => w.name).join(', ');
                                        const hours = mp.workers.reduce((sum, w) => sum + Number(w.hours || 0), 0);
                                        const workDays = 1; // íˆ¬ì… ë‚ ì§œ ê¸°ì¤€ (í•­ìƒ 1ì¼)
                                        return '<span style="font-weight:600;">ì‘ì—…ì:</span> ' + workers + ' ã…£ (' + hours + 'ê³µìˆ˜)(' + workDays + 'ì¼)';
                                    }).join(' ã…£ ') : ''}
                                    ${manpower.length > 0 && (members.length > 0 || processes.length > 0) ? ' ã…£ ' : ''}
                                    ${members.length > 0 ? '<span style="font-weight:600;">ë¶€ì¬ëª…:</span> ' + members.join(', ') : ''}
                                    ${members.length > 0 && processes.length > 0 ? ' ã…£ ' : ''}
                                    ${processes.length > 0 ? '<span style="font-weight:600;">ì‘ì—…ê³µì •:</span> ' + processes.join(', ') : ''}
                                    ${types.length > 0 ? ' ã…£ <span style="font-weight:600;">ì‘ì—…ìœ í˜•:</span> ' + types.join(', ') : ''}
                                    ${uniqueLocations.length > 0 ? ' ã…£ <span style="font-weight:600;">ìœ„ì¹˜:</span> ' + uniqueLocations.join(', ') : ''}
                                </div>
                            ` : `
                                <div style="font-size:14px; color:var(--text-placeholder); text-align:center; padding:4px 0;">ì‘ì—…ë‚´ìš©ì´ ì…ë ¥ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤</div>
                            `}
                        </div>
                        `;
                    }).join('')}
                    </div>
                </div>
                <!-- íˆìŠ¤í† ë¦¬ ë°©ì‹ìœ¼ë¡œ ì¶•ì  UI êµ¬í˜„ -->
                <div style="display:flex; flex-direction:column; gap:8px;">
                    ${dailyDates.sort().reverse().slice(0, 3).map(date => {
                        const dayData = site.dailyData[date];
                        const workSets = dayData?.workSets || [];
                        const members = [...new Set(workSets.map(ws => ws.member).filter(Boolean))];
                        const processes = [...new Set(workSets.map(ws => ws.process).filter(Boolean))];
                        const types = [...new Set(workSets.map(ws => ws.type).filter(Boolean))];
                        const locations = workSets.map(ws => {
                            const loc = ws.location || {};
                            return [loc.block, loc.dong, loc.floor].filter(Boolean).join('/');
                        }).filter(Boolean);
                        const uniqueLocations = [...new Set(locations)];
                        const manpower = dayData?.manpower || [];
                        const versions = dayData?.versions || [];
                        const currentVersion = versions.length > 0 ? versions[versions.length - 1].ver : 1;
                        
                        return `
                        <div class="worklog-date-card" data-date="${date}" style="background:#ffffff; border:1px solid #e2e8f0; border-radius:12px; padding:16px; margin-bottom:12px; position:relative;">
                            <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:8px;">
                                <div style="display:flex; align-items:center; gap:8px;">
                                    <div style="font-size:17px; font-weight:800; color:var(--navy-dark);">${date}</div>
                                    ${versions.length > 1 ? `<span class="ver-badge-card">v${currentVersion}</span>` : ''}
                                </div>
                                ${currentStatus !== 'approved' ? `
                                    <div style="display:flex; gap:10px;">
                                        <button onclick="window.editWorklogDate('${date}')" style="background:none; border:none; cursor:pointer; color:var(--text-sub);">
                                            <i data-lucide="edit-3" style="width:20px;"></i>
                                        </button>
                                        <button onclick="window.deleteDateWithConfirm('${date}')" style="background:none; border:none; cursor:pointer; color:#dc2626;">
                                            <i data-lucide="trash-2" style="width:20px;"></i>
                                        </button>
                                    </div>
                                ` : ''}
                            </div>
                            ${workSets.length > 0 ? `
                                <div style="font-size:14px; color:var(--text-sub); line-height:1.5;">
                                    ${manpower.length > 0 ? manpower.map(mp => {
                                        const workers = mp.workers.map(w => w.name).join(', ');
                                        const hours = mp.workers.reduce((sum, w) => sum + Number(w.hours || 0), 0);
                                        const workDays = 1; // íˆ¬ì… ë‚ ì§œ ê¸°ì¤€ (í•­ìƒ 1ì¼)
                                        return '<span style="font-weight:600;">ì‘ì—…ì:</span> ' + workers + ' ã…£ (' + hours + 'ê³µìˆ˜)(' + workDays + 'ì¼)';
                                    }).join(' ã…£ ') : ''}
                                    ${manpower.length > 0 && (members.length > 0 || processes.length > 0) ? ' ã…£ ' : ''}
                                    ${members.length > 0 ? '<span style="font-weight:600;">ë¶€ì¬ëª…:</span> ' + members.join(', ') : ''}
                                    ${members.length > 0 && processes.length > 0 ? ' ã…£ ' : ''}
                                    ${processes.length > 0 ? '<span style="font-weight:600;">ì‘ì—…ê³µì •:</span> ' + processes.join(', ') : ''}
                                    ${types.length > 0 ? ' ã…£ <span style="font-weight:600;">ì‘ì—…ìœ í˜•:</span> ' + types.join(', ') : ''}
                                    ${uniqueLocations.length > 0 ? ' ã…£ <span style="font-weight:600;">ìœ„ì¹˜:</span> ' + uniqueLocations.join(', ') : ''}
                                </div>
                            ` : `
                                <div style="font-size:14px; color:var(--text-placeholder); text-align:center; padding:4px 0;">ì‘ì—…ë‚´ìš©ì´ ì…ë ¥ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤</div>
                            `}
                        </div>
                        `;
                    }).join('')}
                </div>
            </div>
            
            </div>
            <!-- ì‘ì—…í˜„í™© íƒ­ ë -->
            
            <!-- ìë£Œì²¨ë¶€ íƒ­ -->
            <div id="tab-content-attachment" class="tab-content" style="display:none;">

            <!-- ìì¬ì‚¬ìš© ì„¹ì…˜ -->
            <div class="bg-bg-surface dark:bg-slate-800 rounded-2xl p-6 mb-4 shadow-sm border border-transparent dark:border-slate-700" style="background: var(--bg-surface); border: 1px solid var(--border)">
                <div class="sec-head">
                    <div style="display:flex; align-items:center; gap:8px;">
                        <i data-lucide="package" style="width:20px; color:var(--header-navy);"></i>
                        <div style="font-size:18px; font-weight:800; color:var(--header-navy);">ìì¬ ì‚¬ìš©ë‚´ì—­</div>
                    </div>
                </div>
                
                ${bi.status !== 'approved' ? `
                <div class="grid grid-cols-[1.8fr_1fr_auto] gap-2.5 mb-3 items-center">
                    <select id="materialSelect" class="material-select" onchange="handleAttachmentMaterialSelectChange(event)">
                        <option value="NPC-1000">NPC-1000</option>
                        <option value="NPC-3000Q">NPC-3000Q</option>
                        <option value="custom">ì§ì ‘ì…ë ¥</option>
                    </select>
                    <div class="flex items-center bg-bg-input dark:bg-slate-900 border border-border rounded-xl h-[48px] px-3" style="background: var(--bg-input); border: 1px solid var(--border)">
                        <input type="number" min="0" id="materialQty" placeholder="0" class="flex-1 bg-transparent text-right font-medium outline-none w-full">
                        <span class="text-text-sub text-[15px] font-medium ml-1">ë§</span>
                    </div>
                    <button onclick="addMaterial()" class="w-12 h-[48px] bg-primary-bg text-primary rounded-xl font-black text-lg flex items-center justify-center hover:bg-sky-100" style="background: var(--primary-bg); color: var(--primary)">+</button>
                </div>

                <div id="customMaterialInput" class="flex gap-2 items-center mb-3 hidden">
                    <input type="text" id="customMaterialValue" class="flex-1 min-w-0 h-[48px] bg-bg-input dark:bg-slate-900 border border-border rounded-xl px-3 sm:px-4 outline-none focus:border-primary focus:ring-2 focus:ring-primary/20 transition-all text-sm sm:text-base" placeholder="ìì¬ëª… ì§ì ‘ ì…ë ¥" style="background: var(--bg-input); border: 1px solid var(--border)">
                    <button onclick="handleConfirmCustomMaterial()" class="bg-header-navy text-white px-3 sm:px-4 h-[48px] rounded-xl font-bold text-xs sm:text-sm whitespace-nowrap shrink-0" style="background: var(--header-navy)">
                        í™•ì¸
                    </button>
                </div>
                
                <!-- ì˜ìˆ˜ì¦ ì—…ë¡œë“œ -->
                <div id="receiptUploadSection_${g_currentSite}_${g_currentDate}" class="mb-3" style="display:block;">
                    <div class="flex items-center gap-3">
                        <input type="file" id="customReceiptInput_${g_currentSite}_${g_currentDate}" accept="image/*" multiple style="display:none;" onchange="handleCustomReceiptUpload(event)" />
                        <button onclick="document.getElementById('customReceiptInput_${g_currentSite}_${g_currentDate}').click()" class="btn-upload-dashed">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" data-lucide="receipt-text" style="width:20px; height:20px;">
                                <path d="M13 16H8"></path>
                                <path d="M14 8H8"></path>
                                <path d="M16 12H8"></path>
                                <path d="M4 3a1 1 0 0 1 1-1 1.3 1.3 0 0 1 .7.2l.933.6a1.3 1.3 0 0 0 1.4 0l.934-.6a1.3 1.3 0 0 1 1.4 0l.933.6a1.3 1.3 0 0 0 1.4 0l.933-.6a1.3 1.3 0 0 1 1.4 0l.934.6a1.3 1.3 0 0 0 1.4 0l.933-.6A1.3 1.3 0 0 1 19 2a1 1 0 0 1 1 1v18a1 1 0 0 1-1 1 1.3 1.3 0 0 1-.7-.2l-.933-.6a1.3 1.3 0 0 0-1.4 0l-.934.6a1.3 1.3 0 0 1-1.4 0l-.933-.6a1.3 1.3 0 0 0-1.4 0l-.933.6a1.3 1.3 0 0 1-1.4 0l-.934-.6a1.3 1.3 0 0 0-1.4 0l-.933.6a1.3 1.3 0 0 1-.7.2 1 1 0 0 1-1-1z"></path>
                            </svg>
                            ì˜ìˆ˜ì¦ ì—…ë¡œë“œ
                        </button>
                    </div>
                    
                    <div id="customReceiptPreview_${g_currentSite}_${g_currentDate}" style="display:none; margin-top:8px;">
                        <div id="receiptFilesList_${g_currentSite}_${g_currentDate}" style="display:flex; flex-direction:column; gap:8px;"></div>
                    </div>
                </div>
                ` : ''}

                <div class="flex flex-col gap-2" id="materialsList">
                    ${allMaterials.length > 0 ? allMaterials.map((m) => `
                        <div style="display:flex; align-items:center; justify-content:space-between; background:var(--bg-input); border:1px solid var(--border); border-radius:12px; padding:12px;">
                            <div style="display:flex; align-items:center; gap:8px;">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" data-lucide="package" style="width:16px; color:var(--primary);" class="lucide lucide-package"><path d="M11 21.73a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73z"></path><path d="M12 22V12"></path><polyline points="3.29 7 12 12 20.71 7"></polyline><path d="m7.5 4.27 9 5.15"></path></svg>
                                <div style="min-width:0;">
                                    <div style="font-size:14px; color:var(--text-main); font-weight:700;">${m.worker}</div>
                                    <div style="font-size:13px; color:var(--text-sub);">${m.quantity}${m.unit || ''}</div>
                                </div>
                            </div>

                            ${bi.status !== 'approved' ? `
                            <button onclick="event.stopPropagation(); deleteMaterialAt('${m._dateKey}', ${m._idx})" style="background:none; border:none; cursor:pointer; padding:4px;">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" data-lucide="trash-2" style="width:16px; color:#dc2626;" class="lucide lucide-trash-2"><path d="M3 6h18"></path><path d="M8 6V4h8v2"></path><path d="M19 6l-1 14H6L5 6"></path><path d="M10 11v6"></path><path d="M14 11v6"></path></svg>
                            </button>
                            ` : ''}
                        </div>
                    `).join('') : ''}
                </div>
            </div>

            <!-- ì‚¬ì§„í•¨ ì„¹ì…˜ -->
            <div class="detail-section" id="detailPhotoSection">
                <div class="sec-head" style="display:flex; justify-content:space-between; align-items:center;">
                    <div style="display:flex; align-items:center; gap:8px; white-space:nowrap;">
                        <i data-lucide="camera" style="width:20px; color:var(--header-navy);"></i>
                        <div style="font-size:18px; font-weight:800; color:var(--header-navy);">ì‚¬ì§„í•¨(ëˆ„ì ${photoCount}ê±´)</div>
                    </div>
                    ${bi.status !== 'approved' && photoCount > 0 ? `
                        <button onclick="clearAllPhotos()" style="background:rgba(220, 38, 38, 0.1); color:#dc2626; height:32px; padding:0 14px; border-radius:12px; font-size:13px; font-weight:700; display:flex; align-items:center; gap:4px; border:none; cursor:pointer; transition:all 0.2s;">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" data-lucide="trash-2" style="width:16px;">
                                <path d="M3 6h18"></path>
                                <path d="M8 6V4h8v2"></path>
                                <path d="M19 6l-1 14H6L5 6"></path>
                                <path d="M10 11v6"></path>
                                <path d="M14 11v6"></path>
                            </svg>
                            ì „ì²´ì‚­ì œ
                        </button>
                    ` : ''}
                </div>

                <div class="media-scroll">
                    ${allPhotos.map((p) => `
                        <div class="media-obj">
                            <img src="${p.url}" onclick="viewPhotoAt('${p._dateKey}', ${p._idx})">
                            <div class="media-tag ${p.status === 'before' ? 'before' : 'after'}" style="${p.status === 'before' ? 'background: rgba(59, 130, 246, 0.95);' : 'background: rgba(148, 163, 184, 0.95);'}" onclick="togglePhotoStatusAt('${p._dateKey}', ${p._idx})">${p.status === 'before' ? 'ë³´ìˆ˜ì „' : 'ë³´ìˆ˜í›„'}</div>

                            ${bi.status !== 'approved' ? `
                                <div style="position:absolute; top:4px; left:4px; background:rgba(0,0,0,0.55); border-radius:50%; padding:2px; cursor:pointer;" onclick="event.stopPropagation(); replacePhotoAt('${p._dateKey}', ${p._idx})" title="êµì²´">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                      <path d="M21 12a9 9 0 0 1-9 9 9 9 0 0 1-9-9 9 9 0 0 1 9-9"/>
                                      <path d="M21 3v6h-6"/>
                                    </svg>
                                </div>
                                <div style="position:absolute; top:4px; right:4px; background:rgba(220,38,38,0.9); border-radius:50%; padding:2px; cursor:pointer;" onclick="event.stopPropagation(); deletePhotoAt('${p._dateKey}', ${p._idx})" title="ì‚­ì œ">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                      <path d="M18 6 6 18"></path>
                                      <path d="m6 6 12 12"></path>
                                    </svg>
                                </div>
                            ` : ''}
                        </div>
                    `).join('')}
                </div>

                ${bi.status !== 'approved' ? `
                    <button class="btn-upload-dashed" onclick="triggerPhotoUpload()" style="margin-top:10px;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" data-lucide="camera"><path d="M13.997 4a2 2 0 0 1 1.76 1.05l.486.9A2 2 0 0 0 18.003 7H20a2 2 0 0 1 2 2v9a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V9a2 2 0 0 1 2-2h1.997a2 2 0 0 0 1.759-1.048l.489-.904A2 2 0 0 1 10.004 4z"></path><circle cx="12" cy="13" r="3"></circle></svg>
                        ì‚¬ì§„ ë“±ë¡
                    </button>
                ` : ''}
            </div>

            <!-- ë„ë©´ ì„¹ì…˜ -->
            <div class="detail-section" id="detailDrawingSection">
                <div class="sec-head" style="display:flex; justify-content:space-between; align-items:center;">
                    <div style="display:flex; align-items:center; gap:8px; white-space:nowrap;">
                        <i data-lucide="file-text" style="width:20px; color:var(--header-navy);"></i>
                        <div style="font-size:18px; font-weight:800; color:var(--header-navy);">ë„ë©´í•¨(ëˆ„ì ${drawingCount}ê±´)</div>
                    </div>
                    ${bi.status !== 'approved' && drawingCount > 0 ? `
                        <button onclick="clearAllDrawings()" style="background:rgba(220, 38, 38, 0.1); color:#dc2626; height:32px; padding:0 14px; border-radius:12px; font-size:13px; font-weight:700; display:flex; align-items:center; gap:4px; border:none; cursor:pointer; transition:all 0.2s;">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" data-lucide="trash-2" style="width:16px;">
                                <path d="M3 6h18"></path>
                                <path d="M8 6V4h8v2"></path>
                                <path d="M19 6l-1 14H6L5 6"></path>
                                <path d="M10 11v6"></path>
                                <path d="M14 11v6"></path>
                            </svg>
                            ì „ì²´ì‚­ì œ
                        </button>
                    ` : ''}
                </div>

                <div class="media-scroll">
                    ${allDrawings.map((d) => `
                        <div class="media-obj">
                            <img src="${d.url}" onclick="viewDrawingAt('${d._dateKey}', ${d._idx})">
                            <div class="media-tag after" style="${d.status === 'complete' ? 'background: rgba(148, 163, 184, 0.95);' : 'background: rgba(42, 193, 188, 0.95);'}" onclick="toggleDrawingStatusAt('${d._dateKey}', ${d._idx})">${d.status === 'complete' ? 'ì™„ë£Œë„ë©´' : 'ì§„í–‰ë„ë©´'}</div>
                            ${bi.status !== 'approved' ? `
                                <div style="position:absolute; top:4px; left:4px; background:rgba(0,0,0,0.55); border-radius:50%; padding:2px; cursor:pointer;" onclick="event.stopPropagation(); replaceDrawingAt('${d._dateKey}', ${d._idx})" title="êµì²´">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                      <path d="M21 12a9 9 0 0 1-9 9 9 9 0 0 1-9-9 9 9 0 0 1 9-9"/>
                                      <path d="M21 3v6h-6"/>
                                    </svg>
                                </div>
                                <div style="position:absolute; top:4px; right:4px; background:rgba(220,38,38,0.9); border-radius:50%; padding:2px; cursor:pointer;" onclick="event.stopPropagation(); deleteDrawingAt('${d._dateKey}', ${d._idx})" title="ì‚­ì œ">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                      <path d="M18 6 6 18"></path>
                                      <path d="m6 6 12 12"></path>
                                    </svg>
                                </div>
                            ` : ''}
                        </div>
                    `).join('')}
                </div>

                ${bi.status !== 'approved' ? `
                    <button class="btn-upload-dashed" onclick="triggerDrawingUpload()" style="margin-top:10px;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" data-lucide="map"><path d="M14.106 5.553a2 2 0 0 0 1.788 0l3.659-1.83A1 1 0 0 1 21 4.619v12.764a1 1 0 0 1-.553.894l-4.553 2.277a2 2 0 0 1-1.788 0l-4.212-2.106a2 2 0 0 0-1.788 0l-3.659 1.83A1 1 0 0 1 3 19.381V6.618a1 1 0 0 1 .553-.894l4.553-2.277a2 2 0 0 1 1.788 0z"></path><path d="M15 5.764v15"></path><path d="M9 3.236v15"></path></svg>
                        ë„ë©´ ì—…ë¡œë“œ
                    </button>
                ` : ''}
            </div>

            <!-- ì‘ì—…ì™„ë£Œ í™•ì¸ì„œ ì„¹ì…˜ -->
            <div class="detail-section" id="detailConfirmSection">
                <div class="sec-head" style="display:flex; align-items:center; justify-content:space-between;">
                    <div style="display:flex; align-items:center; gap:8px;">
                        <i data-lucide="file-check" style="width:20px; color:var(--header-navy);"></i>
                        <div style="font-size:18px; font-weight:800; color:var(--header-navy);">ì‘ì—…ì™„ë£Œ í™•ì¸ì„œ</div>
                    </div>
                    ${currentStatus !== 'approved' ? `
                        <button onclick="openConfirm3()" class="btn-action-ignore" style="background:rgba(42, 193, 188, 0.1); color:#2AC1BC; height:32px; padding:0 12px; border-radius:12px; font-size:13px; font-weight:800; border:none; cursor:pointer; display:flex; align-items:center; gap:4px;">
                            í™•ì¸ì„œì‹¤í–‰
                        </button>
                    ` : ''}
                </div>

                ${hasConfirm ? `
                    <div class="list-box-item">
                        <div class="list-box-left" onclick="openViewer('cert_view','${confirmDoc.fileName || 'ì‘ì—…ì™„ë£Œ í™•ì¸ì„œ'}')" style="flex:1; cursor:pointer;">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" data-lucide="clipboard-check" class="list-box-icon">
                                <rect width="8" height="4" x="8" y="2" rx="1" ry="1"></rect>
                                <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path>
                                <path d="m9 14 2 2 4-4"></path>
                            </svg>
                            <div style="flex:1;">
                                <div class="list-box-title">${confirmDoc.fileName || 'ì‘ì—…ì™„ë£Œ í™•ì¸ì„œ'}</div>
                                <div class="list-box-sub">${confirmDoc.uploadDate || ''}${confirmDoc.version ? ` Â· v${confirmDoc.version}` : ''}</div>
                            </div>
                        </div>
                        <div style="display:flex; align-items:center; gap:8px;">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" data-lucide="eye" style="width:20px; color:#94a3b8; cursor:pointer;" onclick="event.stopPropagation(); openViewer('cert_view','${confirmDoc.fileName || 'ì‘ì—…ì™„ë£Œ í™•ì¸ì„œ'}')">
                                <path d="M2.062 12.348a1 1 0 0 1 0-.696 10.75 10.75 0 0 1 19.876 0 1 1 0 0 1 0 .696 10.75 10.75 0 0 1-19.876 0"></path>
                                <circle cx="12" cy="12" r="3"></circle>
                            </svg>
                            ${site.status !== 'approved' || site.status === 'pending' ? `
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" data-lucide="trash-2" style="width:20px; color:#dc2626; cursor:pointer;" onclick="event.stopPropagation(); deleteConfirm()" title="ì‚­ì œ">
                                    <path d="M3 6h18"></path>
                                    <path d="M8 6V4h8v2"></path>
                                    <path d="M19 6l-1 14H6L5 6"></path>
                                    <path d="M10 11v6"></path>
                                    <path d="M14 11v6"></path>
                                </svg>
                            ` : ''}
                        </div>
                    </div>
                ` : ''}

                ${site.status !== 'approved' ? `
                    <button class="btn-upload-dashed" onclick="triggerConfirmUpload()" style="margin-top:10px;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" data-lucide="upload-cloud"><path d="M12 13v8"></path><path d="M4 14.899A7 7 0 0 1 15.71 8h1.79a4.5 4.5 0 0 1 2.5 8.242"></path><path d="m8 17 4-4 4 4"></path></svg>
                        í™•ì¸ì„œ ì—…ë¡œë“œ
                    </button>
                ` : ''}
                <input type="file" id="confirmFileInput_${g_currentSite}_${g_currentDate}" accept="image/*,.pdf" style="display:none;" onchange="handleConfirmUpload(this)">
            </div>

            </div>

            <div id="tab-content-material" class="tab-content" style="display:none;">
            
            <!-- ìì¬ ì…ë ¥ ì„¹ì…˜ -->
            <div class="detail-section">
                <div style="display:flex; align-items:center; gap:8px; margin-bottom:12px;">
                    <i data-lucide="package" style="width:20px; color:var(--navy-dark);"></i>
                    <span style="font-size:18px; font-weight:800; color:var(--navy-dark);">ìì¬ ì…ë ¥ (${materialCount}ê±´)</span>
                </div>
                <div style="margin-top:12px;">
                    ${site.status !== 'approved' ? `
                    <div style="display:grid; grid-template-columns:1.8fr 1fr auto; gap:10px; margin-bottom:12px; align-items:center;">
                        <select id="materialSelect_${g_currentSite}_${g_currentDate}" class="material-select" onchange="handleMaterialSelectChange(event)">
                            <option value="">ìì¬ ì„ íƒ</option>
                            <option value="NPC-1000">NPC-1000</option>
                            <option value="NPC-3000Q">NPC-3000Q</option>
                            <option value="custom">ì§ì ‘ì…ë ¥</option>
                        </select>
                        <div style="display:flex; align-items:center; background:var(--bg-input); border:1px solid var(--border); border-radius:12px; height:48px; padding:0 12px;">
                            <input type="number" min="0" id="materialQty_${g_currentSite}_${g_currentDate}" placeholder="0" style="flex:1; background:transparent; text-align:right; font-weight:500; outline:none; border:none; width:100%;" />
                            <span style="color:var(--text-sub); font-size:15px; font-weight:500; margin-left:4px;">ë§</span>
                        </div>
                        <button onclick="addMaterialFromSelect()" style="width:48px; height:48px; background:var(--primary-bg); color:var(--primary); border-radius:12px; font-weight:800; font-size:18px; display:flex; align-items:center; justify-content:center; border:none; cursor:pointer;">+</button>
                    </div>
                    ` : ''}
                    <div id="materialsList_${g_currentSite}_${g_currentDate}" style="display:flex; flex-direction:column; gap:8px;">
                        ${allMaterials && allMaterials.length > 0 ? allMaterials.map((m, idx) => `
                            <div class="list-box-item">
                                <div class="list-box-left" style="flex:1;">
                                    <i data-lucide="package" class="list-box-icon"></i>
                                    <div style="flex:1;">
                                        <div class="list-box-title">${m.worker}</div>
                                        <div class="list-box-sub">${m.quantity}${m.unit}${m.receipt ? ' Â· ì˜ìˆ˜ì¦ ì²¨ë¶€' : ''}</div>
                                    </div>
                                </div>
                                <div style="display:flex; align-items:center; gap:8px;">
                                    ${m.receipt && bi.status === 'approved' ? `
                                        <button onclick="viewReceipt(${idx})" style="background:none; border:none; cursor:pointer; padding:4px;">
                                            <i data-lucide="eye" style="width:20px; color:#94a3b8;"></i>
                                        </button>
                                    ` : ''}
                                    ${bi.status !== 'approved' ? `
                                        ${m.receipt ? `<button onclick="viewReceipt(${idx})" style="background:none; border:none; cursor:pointer; padding:4px;"><i data-lucide="eye" style="width:16px; color:var(--primary);"></i></button>` : ''}
                                        <button onclick="deleteMaterial(${idx})" style="background:none; border:none; cursor:pointer; padding:4px;"><i data-lucide="trash-2" style="width:16px; color:#dc2626;"></i></button>
                                    ` : ''}
                                </div>
                            </div>
                        `).join('') : ''}
                    </div>
                </div>
            </div>
            
            <!-- í™•ì¸ì„œ ì—…ë¡œë“œ ì„¹ì…˜ -->
            <div class="detail-section">
                <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:12px;">
                    <div style="display:flex; align-items:center; gap:8px;">
                        <i data-lucide="file-check" style="width:20px; color:var(--navy-dark);"></i>
                        <span style="font-size:18px; font-weight:800; color:var(--navy-dark);">í™•ì¸ì„œ</span>
                    </div>
                    ${site.status !== 'approved' ? `
                        <button onclick="triggerConfirmUpload()" style="padding:8px 12px; border-radius:8px; border:1px solid var(--primary); background:var(--primary-bg); color:var(--primary); font-weight:700; font-size:14px; cursor:pointer; display:flex; align-items:center; gap:4px;">
                            <i data-lucide="upload" style="width:16px;"></i>ì—…ë¡œë“œ
                        </button>
                    ` : ''}
                </div>
                ${hasConfirm ? `
                    <div style="background:#f8fafc; border:1px solid #e2e8f0; border-radius:10px; padding:12px; display:flex; align-items:center; justify-content:space-between;">
                        <div style="display:flex; align-items:center; gap:8px;">
                            <i data-lucide="file-check" style="width:18px; color:#10b981;"></i>
                            <div>
                                <div style="font-size:14px; font-weight:700; color:var(--text-main);">í™•ì¸ì„œ.pdf</div>
                                <div style="font-size:12px; color:var(--text-sub);">ì—…ë¡œë“œ ì™„ë£Œ</div>
                            </div>
                        </div>
                        <div style="display:flex; gap:4px;">
                            <button onclick="viewConfirm()" style="padding:6px 10px; border-radius:6px; border:1px solid var(--border); background:white; color:var(--text-main); font-weight:600; font-size:13px; cursor:pointer;">ë³´ê¸°</button>
                            ${site.status !== 'approved' ? `
                                <button onclick="deleteConfirm()" style="padding:6px 10px; border-radius:6px; border:1px solid #fecaca; background:#fef2f2; color:#dc2626; font-weight:600; font-size:13px; cursor:pointer;">ì‚­ì œ</button>
                            ` : ''}
                        </div>
                    </div>
                ` : '<div style="text-align:center; padding:20px; color:var(--text-placeholder);">í™•ì¸ì„œê°€ ì—†ìŠµë‹ˆë‹¤</div>'}
            </div>
            
            <!-- ê¸°íƒ€ ì„œë¥˜ ì—…ë¡œë“œ ì„¹ì…˜ -->
            <div class="detail-section">
                <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:12px;">
                    <div style="display:flex; align-items:center; gap:8px;">
                        <i data-lucide="folder" style="width:20px; color:var(--navy-dark);"></i>
                        <span style="font-size:18px; font-weight:800; color:var(--navy-dark);">ê¸°íƒ€ ì„œë¥˜</span>
                    </div>
                    ${site.status !== 'approved' ? `
                        <button onclick="triggerOtherDocUpload()" style="padding:8px 12px; border-radius:8px; border:1px solid var(--primary); background:var(--primary-bg); color:var(--primary); font-weight:700; font-size:14px; cursor:pointer; display:flex; align-items:center; gap:4px;">
                            <i data-lucide="upload" style="width:16px;"></i>ì—…ë¡œë“œ
                        </button>
                    ` : ''}
                </div>
                ${site.otherDocs && site.otherDocs.length > 0 ? `
                    <div style="display:flex; flex-direction:column; gap:8px;">
                        ${site.otherDocs.map((doc, idx) => `
                            <div style="background:#f8fafc; border:1px solid #e2e8f0; border-radius:10px; padding:12px; display:flex; align-items:center; justify-content:space-between;">
                                <div style="display:flex; align-items:center; gap:8px;">
                                    <i data-lucide="file" style="width:18px; color:var(--text-sub);"></i>
                                    <div>
                                        <div style="font-size:14px; font-weight:700; color:var(--text-main);">${doc.name}</div>
                                        <div style="font-size:12px; color:var(--text-sub);">${doc.date || ''}</div>
                                    </div>
                                </div>
                                <div style="display:flex; gap:4px;">
                                    <button onclick="viewOtherDoc(${idx})" style="padding:6px 10px; border-radius:6px; border:1px solid var(--border); background:white; color:var(--text-main); font-weight:600; font-size:13px; cursor:pointer;">ë³´ê¸°</button>
                                    ${site.status !== 'approved' ? `
                                        <button onclick="deleteOtherDoc(${idx})" style="padding:6px 10px; border-radius:6px; border:1px solid #fecaca; background:#fef2f2; color:#dc2626; font-weight:600; font-size:13px; cursor:pointer;">ì‚­ì œ</button>
                                    ` : ''}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                ` : '<div style="text-align:center; padding:20px; color:var(--text-placeholder);">ê¸°íƒ€ ì„œë¥˜ê°€ ì—†ìŠµë‹ˆë‹¤</div>'}
            </div>
            
            </div>

        <div id="tab-content-material" class="tab-content" style="display:none;">
        
        <!-- ìì¬ ì…ë ¥ ì„¹ì…˜ -->
        <div class="detail-section">
            <div style="display:flex; align-items:center; gap:8px; margin-bottom:12px;">
                <i data-lucide="package" style="width:20px; color:var(--navy-dark);"></i>
                <span style="font-size:18px; font-weight:800; color:var(--navy-dark);">ìì¬ ì…ë ¥ (${materialCount}ê±´)</span>
            </div>
            <div style="margin-top:12px;">
                ${site.status !== 'approved' ? `
                <div style="display:grid; grid-template-columns:1.8fr 1fr auto; gap:10px; margin-bottom:12px; align-items:center;">
                    <select id="materialSelect_${g_currentSite}_${g_currentDate}" class="material-select" onchange="handleMaterialSelectChange(event)">
                        <option value="">ìì¬ ì„ íƒ</option>
                        <option value="NPC-1000">NPC-1000</option>
                        <option value="NPC-3000Q">NPC-3000Q</option>
                        <option value="custom">ì§ì ‘ì…ë ¥</option>
                    </select>
                    <div style="display:flex; align-items:center; background:var(--bg-input); border:1px solid var(--border); border-radius:12px; height:48px; padding:0 12px;">
                        <input type="number" min="0" id="materialQty_${g_currentSite}_${g_currentDate}" placeholder="0" style="flex:1; background:transparent; text-align:right; font-weight:500; outline:none; border:none; width:100%;" />
                        <span style="color:var(--text-sub); font-size:15px; font-weight:500; margin-left:4px;">ë§</span>
                    </div>
                    <button onclick="addMaterialFromSelect()" style="width:48px; height:48px; background:var(--primary-bg); color:var(--primary); border-radius:12px; font-weight:800; font-size:18px; display:flex; align-items:center; justify-content:center; border:none; cursor:pointer;">+</button>
                </div>
                ` : ''}
            </div>
        </div>
        
        </div>
        `;
        
        // HTML í• ë‹¹
        contentEl.innerHTML = html;
        
        // ìƒíƒœë³„ ë²„íŠ¼ ë Œë”ë§
        updateDetailFooter(currentStatus);
        
        // íƒ­ í™œì„±í™” ë° ì•„ì´ì½˜ ë Œë”ë§
        switchDetailTab(g_currentTab);
        
        document.getElementById('detailPanel').classList.add('active');
        lucide.createIcons();
        
        // ë°˜ë ¤ ìƒíƒœì¼ ë•Œ ì„¹ì…˜ë³„ íš¨ê³¼ ìë™ ì ìš©
        if (currentStatus === 'reject') {
            setTimeout(() => {
                const status = getSectionStatus(bi);
                console.log('openDetail - ë°˜ë ¤ ìƒíƒœ ê°ì§€, ì„¹ì…˜ íš¨ê³¼ ì ìš©:', status);
                applySectionEffects(status);
            }, 100);
        }
        
        // openDetail í•¨ìˆ˜ ìµœí•˜ë‹¨ setTimeout ë¶€ë¶„ì„ ì•„ë˜ ì½”ë“œë¡œ êµì²´í•˜ì„¸ìš”.
        setTimeout(() => {
            const isLocked = (currentStatus === 'approved' || currentStatus === 'pending');
            const panel = document.getElementById('detailPanel');
            
            if (isLocked) {
                // 1. ëª¨ë“  ì…ë ¥ì°½ ì ê¸ˆ (ì¡°íšŒ ì „ìš©)
                panel.querySelectorAll('input, select, textarea').forEach(el => el.disabled = true);
                
                // 2. [ì¤‘ìš”] í¸ì§‘/ì‚­ì œ ë²„íŠ¼ë§Œ ìˆ¨ê¸°ê¸° (í•˜ë‹¨ ì•¡ì…˜ë²„íŠ¼, íƒ­ ë²„íŠ¼, í™•ì¸ì„œì‹¤í–‰ ë²„íŠ¼ì€ ìœ ì§€)
                panel.querySelectorAll('button').forEach(btn => {
                    // ì œì™¸í•  ë²„íŠ¼ë“¤: í•˜ë‹¨ ì•¡ì…˜(.btn-action), íƒ­(.detail-tab), í™•ì¸ì„œì‹¤í–‰(.btn-action-ignore), í—¤ë”ë‹«ê¸°
                    const isActionBtn = btn.classList.contains('btn-action');
                    const isTabBtn = btn.classList.contains('detail-tab');
                    const isIgnoreBtn = btn.classList.contains('btn-action-ignore');
                    const isHeaderBtn = btn.closest('.fm-header');
                    
                    if (!isActionBtn && !isTabBtn && !isIgnoreBtn && !isHeaderBtn) {
                        btn.style.display = 'none';
                    }
                });

                // 3. ì‚¬ì§„/ë„ë©´ì˜ ì‚­ì œ/êµì²´ ì•„ì´ì½˜ ê°•ì œ ìˆ¨ê¹€ ì²˜ë¦¬
                panel.querySelectorAll('.media-obj div[onclick*="delete"], .media-obj div[onclick*="replace"]').forEach(el => {
                    el.style.display = 'none';
                });
                
                // 4. ì‘ì—…ì™„ë£Œí™•ì¸ì„œ ì‚­ì œ ë²„íŠ¼ ìˆ¨ê¹€ (ë¯¸ë¦¬ë³´ê¸°ëŠ” ê°€ëŠ¥)
                panel.querySelectorAll('[onclick*="deleteConfirm"]').forEach(btn => {
                    btn.style.display = 'none';
                });
            }
            
            if (typeof lucide !== 'undefined') lucide.createIcons();
        }, 100);
        
        // ìˆ˜ì • ëª¨ë“œì¼ ë•Œ í˜„ì¥ëª… ê²€ìƒ‰ ê¸°ëŠ¥ ì´ˆê¸°í™”
        if (g_isEditMode && site.status === 'reject') {
            setTimeout(() => {
                initSiteSearchEdit();
            }, 100);
        }
    }

    function closeDetail() {
        document.getElementById('detailPanel').classList.remove('active');
        document.getElementById('detailPanel').classList.remove('edit-mode');
        g_currentSite = null;
        g_currentDate = null;
        g_isEditMode = false; // ìˆ˜ì • ëª¨ë“œ ì´ˆê¸°í™”
    }
    
    // ì‚­ì œ íˆìŠ¤í† ë¦¬ ì €ì¥ì†Œ
    let g_deletedHistory = JSON.parse(localStorage.getItem('inopnc_deleted_history')) || [];
    
    function deleteSite() {
        if (!g_currentSite) return;
        deleteSiteWithConfirm(g_currentSite);
    }
    
    function deleteSiteWithConfirm(siteKey) {
        const site = g_worklogs[siteKey];
        if (!site) return;
        
        if (confirm(`"${site.baseInfo.siteName}" í˜„ì¥ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì‚­ì œëœ ë°ì´í„°ëŠ” íˆìŠ¤í† ë¦¬ì— ë³´ê´€ë˜ë©° ë³µì›í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.`)) {
            // ì‚­ì œ íˆìŠ¤í† ë¦¬ì— ì €ì¥
            const deletedItem = {
                siteKey: siteKey,
                data: JSON.parse(JSON.stringify(site)), // ê¹Šì€ ë³µì‚¬
                deletedAt: new Date().toISOString(),
                deletedBy: 'ì‚¬ìš©ì'
            };
            
            g_deletedHistory.unshift(deletedItem); // ìµœì‹  í•­ëª©ì„ ì•ì— ì¶”ê°€
            
            // ìµœëŒ€ 50ê°œê¹Œì§€ë§Œ ë³´ê´€
            if (g_deletedHistory.length > 50) {
                g_deletedHistory = g_deletedHistory.slice(0, 50);
            }
            
            localStorage.setItem('inopnc_deleted_history', JSON.stringify(g_deletedHistory));
            
            // í˜„ì¥ ì‚­ì œ
            delete g_worklogs[siteKey];
            saveData();
            
            // ìƒì„¸ íŒ¨ë„ì´ ì—´ë ¤ìˆìœ¼ë©´ ë‹«ê¸°
            if (g_currentSite === siteKey) {
                closeDetail();
            }
            
            renderLogs();
            showToast('í˜„ì¥ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤. íˆìŠ¤í† ë¦¬ì—ì„œ ë³µì›í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
        }
    }
    
    function restoreSite(index) {
        if (index < 0 || index >= g_deletedHistory.length) return;
        
        const item = g_deletedHistory[index];
        
        if (confirm(`"${item.data.baseInfo.siteName}" í˜„ì¥ì„ ë³µì›í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
            // í˜„ì¥ ë³µì›
            g_worklogs[item.siteKey] = item.data;
            
            // íˆìŠ¤í† ë¦¬ì—ì„œ ì œê±°
            g_deletedHistory.splice(index, 1);
            localStorage.setItem('inopnc_deleted_history', JSON.stringify(g_deletedHistory));
            
            saveData();
            renderLogs();
            showToast('í˜„ì¥ì´ ë³µì›ë˜ì—ˆìŠµë‹ˆë‹¤.');
        }
    }
    
    window.deleteDateWithConfirm = function(date) {
        if (!g_currentSite || !date) return;
        const site = g_worklogs[g_currentSite];
        if (confirm(`"${date}" ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\në³µì› ê¸°ëŠ¥ì„ í†µí•´ ë˜ì‚´ë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤.`)) {
            if (!site.deletedDates) site.deletedDates = [];
            site.deletedDates.unshift({
                date: date,
                data: JSON.parse(JSON.stringify(site.dailyData[date])),
                deletedAt: new Date().toLocaleString()
            });
            delete site.dailyData[date];
            saveData();
            renderLogs();
            openDetail(g_currentSite);
            showToast('ê¸°ë¡ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
        }
    };
    
    window.viewDeletedDates = function(siteKey) {
        if (!siteKey) return;
        
        const site = g_worklogs[siteKey];
        if (!site || !site.deletedDates || site.deletedDates.length === 0) {
            showToast('ì‚­ì œëœ ë‚ ì§œê°€ ì—†ìŠµë‹ˆë‹¤.');
            return;
        }
        
        const modalHTML = `
        <div id="deletedDatesModal" style="position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 9999; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(2px);" onclick="if(event.target.id==='deletedDatesModal') closeDeletedDatesModal();">
            <div style="background: white; border-radius: 16px; width: 90%; max-width: 500px; max-height: 80vh; overflow: hidden; box-shadow: 0 20px 60px rgba(0,0,0,0.3);" onclick="event.stopPropagation();">
                <div style="padding: 20px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; background: linear-gradient(135deg, #fef2f2 0%, #fff 100%);">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <i data-lucide="rotate-ccw" style="width: 22px; color: #dc2626;"></i>
                        <h3 style="margin: 0; font-size: 18px; font-weight: 800; color: var(--text-main);">ì‚­ì œëœ ë‚ ì§œ ë³µì› (${site.deletedDates.length}ê±´)</h3>
                    </div>
                    <button onclick="closeDeletedDatesModal()" style="background: none; border: none; cursor: pointer; padding: 4px; color: var(--text-sub);">
                        <i data-lucide="x" style="width: 24px;"></i>
                    </button>
                </div>
                <div style="padding: 20px; overflow-y: auto; max-height: 60vh;">
                    ${site.deletedDates.length === 0 ? `
                        <div style="text-align: center; padding: 40px 20px; color: var(--text-placeholder);">
                            <i data-lucide="inbox" style="width: 48px; height: 48px; margin: 0 auto 16px; opacity: 0.3;"></i>
                            <p style="font-size: 15px; margin: 0;">ì‚­ì œëœ ë‚ ì§œê°€ ì—†ìŠµë‹ˆë‹¤</p>
                        </div>
                    ` : `
                        <div style="display: flex; flex-direction: column; gap: 12px;">
                            ${site.deletedDates.map((item, index) => {
                                const workSets = item.data?.workSets || [];
                                const manpower = item.data?.manpower || [];
                                const workerCount = manpower.reduce((sum, m) => sum + (m.workers?.length || 0), 0);
                                const summary = workSets.length > 0 ? workSets.map(ws => ws.member).filter(Boolean).join(', ') : 'ì‘ì—…ë‚´ìš© ì—†ìŒ';
                                
                                return `
                                <div style="background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 12px; padding: 14px; transition: all 0.2s; cursor: pointer;" onmouseover="this.style.borderColor='#31a3fa'; this.style.boxShadow='0 2px 8px rgba(49,163,250,0.1)';" onmouseout="this.style.borderColor='#e2e8f0'; this.style.boxShadow='none';">
                                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
                                        <div style="font-size: 16px; font-weight: 800; color: var(--navy-dark);">${item.date}</div>
                                        <button onclick="event.stopPropagation(); restoreDate('${siteKey}', ${index})" style="background: rgba(49, 163, 250, 0.1); color: #31a3fa; height: 32px; padding: 0 14px; border-radius: 8px; font-size: 13px; font-weight: 700; display: flex; align-items: center; gap: 4px; border: none; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#31a3fa'; this.style.color='white';" onmouseout="this.style.background='rgba(49, 163, 250, 0.1)'; this.style.color='#31a3fa';">
                                            <i data-lucide="rotate-ccw" style="width: 16px;"></i> ë³µì›
                                        </button>
                                    </div>
                                    <div style="font-size: 13px; color: var(--text-sub); margin-bottom: 6px;">
                                        <i data-lucide="users" style="width: 14px; display: inline; vertical-align: middle;"></i> ${workerCount}ëª… Â· ${summary}
                                    </div>
                                    <div style="font-size: 12px; color: var(--text-placeholder);">
                                        <i data-lucide="clock" style="width: 12px; display: inline; vertical-align: middle;"></i> ì‚­ì œ: ${item.deletedAt}
                                    </div>
                                </div>
                            `}).join('')}
                        </div>
                    `}
                </div>
            </div>
        </div>`;
        
        document.body.insertAdjacentHTML('beforeend', modalHTML);
        
        if (typeof lucide !== 'undefined') {
            setTimeout(() => lucide.createIcons(), 50);
        }
    };
    
    window.closeDeletedDatesModal = function() {
        const modal = document.getElementById('deletedDatesModal');
        if (modal) modal.remove();
    };
    
    window.restoreDate = function(siteKey, index) {
        const site = g_worklogs[siteKey];
        const item = site.deletedDates[index];
        site.dailyData[item.date] = item.data;
        site.deletedDates.splice(index, 1);
        saveData();
        closeDeletedDatesModal();
        openDetail(siteKey);
        renderLogs();
        showToast('ë°ì´í„°ê°€ ë³µì›ë˜ì—ˆìŠµë‹ˆë‹¤.');
    };
    
    function viewDeletedHistory() {
        if (g_deletedHistory.length === 0) {
            alert('ì‚­ì œëœ í˜„ì¥ì´ ì—†ìŠµë‹ˆë‹¤.');
            return;
        }
        
        let html = '<div style="padding:20px;"><h3 style="margin-bottom:16px; font-size:18px; font-weight:800;">ì‚­ì œëœ í˜„ì¥ íˆìŠ¤í† ë¦¬</h3>';
        
        g_deletedHistory.forEach((item, index) => {
            const deletedDate = new Date(item.deletedAt);
            const dateStr = `${deletedDate.getFullYear()}-${String(deletedDate.getMonth()+1).padStart(2,'0')}-${String(deletedDate.getDate()).padStart(2,'0')} ${String(deletedDate.getHours()).padStart(2,'0')}:${String(deletedDate.getMinutes()).padStart(2,'0')}`;
            
            html += `
                <div style="background:var(--bg-surface); border:1px solid var(--border); border-radius:12px; padding:16px; margin-bottom:12px;">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <div>
                            <div style="font-size:16px; font-weight:700; color:var(--text-main); margin-bottom:4px;">${item.data.baseInfo.siteName}</div>
                            <div style="font-size:13px; color:var(--text-sub);">ì‚­ì œì¼ì‹œ: ${dateStr}</div>
                        </div>
                        <button onclick="restoreSite(${index})" style="padding:8px 16px; background:var(--primary); color:white; border:none; border-radius:8px; font-weight:700; cursor:pointer;">ë³µì›</button>
                    </div>
                </div>
            `;
        });
        
        html += '</div>';
        
        // ê°„ë‹¨í•œ ëª¨ë‹¬ë¡œ í‘œì‹œ
        const modal = document.createElement('div');
        modal.style.cssText = 'position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:9999; display:flex; align-items:center; justify-content:center;';
        modal.innerHTML = `
            <div style="background:var(--bg-body); border-radius:16px; max-width:500px; width:90%; max-height:80vh; overflow-y:auto;">
                ${html}
                <div style="padding:0 20px 20px;">
                    <button onclick="this.closest('div[style*=fixed]').remove()" style="width:100%; padding:12px; background:var(--bg-input); border:1px solid var(--border); border-radius:12px; font-weight:700; cursor:pointer;">ë‹«ê¸°</button>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
    }
    
    function switchDetailTab(tabName) {
        // 1. ëª¨ë“  íƒ­ ë²„íŠ¼ ì´ˆê¸°í™” (íšŒìƒ‰ ì²˜ë¦¬)
        document.querySelectorAll('.detail-tab').forEach(btn => {
            btn.style.color = 'var(--text-sub)';
            btn.style.borderBottom = '3px solid transparent';
        });
        
        // 2. ëª¨ë“  íƒ­ ì»¨í…ì¸  ìˆ¨ê¸°ê¸°
        document.querySelectorAll('.tab-content').forEach(content => {
            content.style.display = 'none';
        });
        
        // 3. ì„ íƒëœ íƒ­ í™œì„±í™” (íŒŒë€ìƒ‰ ì²˜ë¦¬)
        const activeBtn = document.getElementById(`tab-${tabName}`);
        if (activeBtn) {
            activeBtn.style.color = '#31a3fa';
            activeBtn.style.borderBottom = '3px solid #31a3fa';
        }
        
        // 4. ì„ íƒëœ íƒ­ ì»¨í…ì¸  í‘œì‹œ
        const activeContent = document.getElementById(`tab-content-${tabName}`);
        if (activeContent) {
            activeContent.style.display = 'block';
        }
        
        g_currentTab = tabName;
        
        // ì•„ì´ì½˜ ë‹¤ì‹œ ë Œë”ë§
        if (typeof lucide !== 'undefined' && lucide.createIcons) {
            lucide.createIcons();
        }
    }

    // ìˆ˜ì • ëª¨ë“œ í† ê¸€ (g_isEditMode ê¸°ë°˜)
    function toggleEditMode() {
        if (!g_currentSite) return;
        
        g_isEditMode = !g_isEditMode;
        
        // ìˆ˜ì • ëª¨ë“œ ì§„ì… ì‹œ detailPanelì— CSS í´ë˜ìŠ¤ ì¶”ê°€
        const detailPanel = document.getElementById('detailPanel');
        if (g_isEditMode) {
            detailPanel.classList.add('edit-mode');
        } else {
            detailPanel.classList.remove('edit-mode');
        }
        
        // ìˆ˜ì • ëª¨ë“œ ì§„ì… ì‹œì—ëŠ” í˜„ì¬ íƒ­ ìœ ì§€, ì¢…ë£Œ ì‹œì—ëŠ” ê¸°ë³¸ íƒ­ìœ¼ë¡œ
        if (g_isEditMode) {
            openDetail(g_currentSite, g_currentTab);
        } else {
            openDetail(g_currentSite, null);
        }
    }
    
    /**
     * [2026-01-11 ì—…ë°ì´íŠ¸]
     * ìƒì„¸ ìˆ˜ì • ê¸°ëŠ¥ì€ ë°”í…€ì‹œíŠ¸ ë°©ì‹(openAddWorklogModal)ìœ¼ë¡œ í†µí•©
     * enableEditModeëŠ” ì¤‘ë³µ ê¸°ëŠ¥ìœ¼ë¡œ ì œê±°ë¨
     */
    
    // ë°˜ë ¤ ì•Œë¦¼ íš¨ê³¼ í•¨ìˆ˜
    function showRejectNotification(reason) {
        // ì•Œë¦¼ ë°°ë„ˆ ìƒì„±
        const notification = document.createElement('div');
        notification.className = 'reject-notification';
        notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            padding: 16px 20px;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(239, 68, 68, 0.3);
            z-index: 10000;
            max-width: 400px;
            animation: slideInRight 0.3s ease, pulse 2s infinite;
            font-size: 14px;
            line-height: 1.5;
        `;
        
        notification.innerHTML = `
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
                    <line x1="12" y1="9" x2="12" y2="13"></line>
                    <line x1="12" y1="17" x2="12.01" y2="17"></line>
                </svg>
                <strong style="font-size: 15px;">ë°˜ë ¤ ì•Œë¦¼</strong>
            </div>
            <div style="background: rgba(255,255,255,0.15); padding: 10px; border-radius: 8px;">
                ${reason || 'ë°˜ë ¤ ì‚¬ìœ ê°€ ì—†ìŠµë‹ˆë‹¤.'}
            </div>
            <button onclick="this.parentElement.remove()" style="
                position: absolute;
                top: 8px;
                right: 8px;
                background: rgba(255,255,255,0.2);
                border: none;
                color: white;
                width: 24px;
                height: 24px;
                border-radius: 50%;
                cursor: pointer;
                display: flex;
                align-items: center;
                justify-content: center;
            ">Ã—</button>
        `;
        
        // ì• ë‹ˆë©”ì´ì…˜ ìŠ¤íƒ€ì¼ ì¶”ê°€
        if (!document.getElementById('reject-notification-styles')) {
            const style = document.createElement('style');
            style.id = 'reject-notification-styles';
            style.textContent = `
                @keyframes slideInRight {
                    from { transform: translateX(100%); opacity: 0; }
                    to { transform: translateX(0); opacity: 1; }
                }
                @keyframes pulse {
                    0%, 100% { transform: scale(1); }
                    50% { transform: scale(1.02); }
                }
                .reject-notification {
                    animation: slideInRight 0.3s ease, pulse 2s infinite;
                }
            `;
            document.head.appendChild(style);
        }
        
        document.body.appendChild(notification);
        
        // 5ì´ˆ í›„ ìë™ ì œê±°
        setTimeout(() => {
            if (notification.parentElement) {
                notification.style.animation = 'slideInRight 0.3s ease reverse';
                setTimeout(() => notification.remove(), 300);
            }
        }, 5000);
    }
    
    // [ìˆ˜ì •] ìˆ˜ì • ë²„íŠ¼ í´ë¦­ ì‹œ ë™ì‘
    function showRejectEditNotification() {
        const site = g_worklogs[g_currentSite];
        if (!site || !site.baseInfo) return;
        
        const bi = site.baseInfo;
        console.log("ë¶„ì„ëœ ë°˜ë ¤ì‚¬ìœ :", bi.rejectReason); // ì´ì œ undefinedê°€ ëœ¨ì§€ ì•ŠìŠµë‹ˆë‹¤.
        
        // ìƒì„¸ í™”ë©´ì´ ì—´ë ¤ìˆëŠ”ì§€ í™•ì¸
        const detailPanel = document.getElementById('detailPanel');
        if (!detailPanel || !detailPanel.classList.contains('active')) {
            console.log('ìƒì„¸ í™”ë©´ì´ ì—´ë ¤ìˆì§€ ì•Šì•„ íš¨ê³¼ ì ìš© ì¤‘ë‹¨');
            return;
        }
        
        // ë°˜ë ¤ ì‚¬ìœ  ë¶„ì„
        const status = getSectionStatus(bi);
        console.log('ì„¹ì…˜ ìƒíƒœ ë¶„ì„:', status);
        
        // í™”ë©´ ê°±ì‹  ì—†ì´ í˜„ì¬ ì„¹ì…˜ì— í´ë˜ìŠ¤ ì ìš©
        applySectionEffects(status);
        
        // ì‹œê°ì  í”¼ë“œë°±: ì²« ë²ˆì§¸ ìˆ˜ì • í•­ëª©ìœ¼ë¡œ ì´ë™
        setTimeout(() => {
            const target = document.querySelector('.reject-effect');
            if (target) {
                target.scrollIntoView({ behavior: 'smooth', block: 'center' });
                showToast("ë°˜ë ¤ëœ í•­ëª©ì„ í™•ì¸í•˜ê³  ìˆ˜ì •í•´ ì£¼ì„¸ìš”.");
            }
        }, 300);
    }
    
    // Shake ì• ë‹ˆë©”ì´ì…˜ íŠ¸ë¦¬ê±° í•¨ìˆ˜
    function triggerRejection(elementId, message) {
        const el = document.getElementById(elementId);
        if (!el) return;

        // 1. ì‹œê°ì  íš¨ê³¼ (í”ë“¤ë¦¼ + ë¶‰ì€ìƒ‰)
        // ê¸°ì¡´ í´ë˜ìŠ¤ë¥¼ ì œê±°í–ˆë‹¤ê°€ ë‹¤ì‹œ ì¶”ê°€í•´ì•¼ ì• ë‹ˆë©”ì´ì…˜ì´ ì¬ì‹¤í–‰ë¨
        el.classList.remove('reject-effect');
        void el.offsetWidth; // ë¦¬í”Œë¡œìš° ê°•ì œ (ì• ë‹ˆë©”ì´ì…˜ ë¦¬ì…‹ íŠ¸ë¦¬ê±°)
        el.classList.add('reject-effect');

        // 2. í¬ì»¤ìŠ¤ ë° ìŠ¤í¬ë¡¤ (ì‚¬ìš©ì í¸ì˜)
        el.scrollIntoView({ behavior: 'smooth', block: 'center' });
        el.focus();

        // 3. ë°˜ë ¤ ì‚¬ìœ  ë©”ì‹œì§€ ë…¸ì¶œ (ì—†ìœ¼ë©´ ìƒì„±)
        let msgEl = document.getElementById(elementId + '-msg');
        if (!msgEl) {
            msgEl = document.createElement('div');
            msgEl.id = elementId + '-msg';
            msgEl.className = 'reject-msg';
            // ì•„ì´ì½˜ + ë©”ì‹œì§€
            msgEl.innerHTML = `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg> ${message}`;
            el.parentNode.appendChild(msgEl);
        } else {
            msgEl.innerHTML = `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg> ${message}`;
        }
    }
    
    // ì„¹ì…˜ë³„ íš¨ê³¼ ì ìš© í•¨ìˆ˜
    function applySectionEffects(status) {
        // ë°˜ë ¤ ì‚¬ìœ ì— ëª…ì‹œëœ ì„¹ì…˜ë§Œ ë¹¨ê°„ìƒ‰ í„ìŠ¤ íš¨ê³¼ ì ìš©
        // ë°ì´í„° ê¸°ì¤€ì´ ëª…í™•í•˜ì§€ ì•Šì„ ë•Œ ì˜¤ë¥˜ ë°©ì§€
        
        // ì‘ì—…ë‚´ìš©(ë¶€ì¬ëª…, ì‘ì—…ê³µì •) ì„¹ì…˜ íš¨ê³¼ ì ìš©
        if (status.workSets) {
            // ì‘ì—…ë‚´ìš© ì„¹ì…˜
            const workSection = document.getElementById('detailWorkSetSection');
            if (workSection) {
                triggerRejection('detailWorkSetSection', 'ë¶€ì¬ëª…ê³¼ ì‘ì—…ê³µì •ì´ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
            }
            
            // ì‘ì—…ì¼ì§€ ì¹´ë“œ ì¤‘ ë¶€ì¬ëª…/ê³µì •ì´ ìˆëŠ” ì¹´ë“œë§Œ íš¨ê³¼ ì ìš©
            const worklogCards = document.querySelectorAll('.worklog-date-card');
            worklogCards.forEach(card => {
                const dateKey = card.getAttribute('data-date');
                
                // site ë³€ìˆ˜ ëŒ€ì‹  cardì˜ dataë¥¼ ì§ì ‘ í™•ì¸
                const hasWorkContent = card.textContent.includes('ë¶€ì¬ëª…') || 
                                     card.textContent.includes('ì‘ì—…ê³µì •') || 
                                     card.textContent.includes('ì‘ì—…ì');
                
                if (hasWorkContent) {
                    const cardId = `worklog-card-${dateKey}`;
                    card.id = cardId; // ID ì„¤ì •
                    triggerRejection(cardId, 'ë¶€ì¬ëª…ê³¼ ì‘ì—…ê³µì •ì´ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                }
            });
        }
        
        // í˜„ì¥ëª… ì„¹ì…˜ íš¨ê³¼ ì ìš©
        if (status.siteName) {
            const siteSection = document.getElementById('siteInfoSection');
            if (siteSection) {
                triggerRejection('siteInfoSection', 'í˜„ì¥ëª… ì •ë³´ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
            }
        }
        
        // íˆ¬ì…ì¸ì› ì„¹ì…˜ íš¨ê³¼ ì ìš©
        if (status.manpower) {
            const manpowerSection = document.getElementById('detailManpowerSection');
            if (manpowerSection) {
                triggerRejection('detailManpowerSection', 'íˆ¬ì…ì¸ì› ì •ë³´ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
            }
        }
        
        // ì‘ì—…ì™„ë£Œí™•ì¸ì„œ ì„¹ì…˜ íš¨ê³¼ ì ìš©
        if (status.confirm) {
            const confirmSection = document.getElementById('detailConfirmSection');
            if (confirmSection) {
                triggerRejection('detailConfirmSection', 'ì‘ì—…ì™„ë£Œí™•ì¸ì„œ ì •ë³´ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
            }
        }
        
        // ê¸°íƒ€ ì„¹ì…˜ íš¨ê³¼ ì ìš©
        if (status.weather) {
            const weatherSection = document.getElementById('weatherSection');
            if (weatherSection) {
                triggerRejection('weatherSection', 'ë‚ ì”¨ ì •ë³´ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
            }
        }
        
        if (status.specialNotes) {
            const notesSection = document.getElementById('specialNotesSection');
            if (notesSection) {
                triggerRejection('specialNotesSection', 'íŠ¹ì´ì‚¬í•­ ì •ë³´ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
            }
        }
        
        if (status.photos) {
            const photoSection = document.getElementById('photoSection');
            if (photoSection) {
                triggerRejection('photoSection', 'ì‚¬ì§„ ì •ë³´ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
            }
        }
        
        console.log('ì„¹ì…˜ íš¨ê³¼ ì ìš© ì™„ë£Œ - ë°˜ë ¤ ì‚¬ìœ ì— ëª…ì‹œëœ ì„¹ì…˜ë§Œ ê°•ì¡°');
    }
    
    // ì¹´ë“œ ë ˆë²¨ ë°˜ë ¤ íš¨ê³¼ ì ìš©
    function applyCardLevelRejectEffects(status) {
        // ìƒì„¸ í™”ë©´ì´ ì—´ë ¤ìˆëŠ”ì§€ í™•ì¸
        const detailPanel = document.getElementById('detailPanel');
        if (!detailPanel || !detailPanel.classList.contains('active')) {
            console.log('ìƒì„¸ í™”ë©´ì´ ì—´ë ¤ìˆì§€ ì•Šì•„ íš¨ê³¼ ì ìš© ì¤‘ë‹¨');
            return;
        }
        
        // 1. í˜„ì¥ê¸°ë¡ ì¹´ë“œ - ë°˜ë ¤ íš¨ê³¼ë§Œ ì ìš©
        if (status.site || status.workSets) {
            const siteCard = document.querySelector('.site-card'); // í˜„ì¬ ì—´ë¦° í˜„ì¥ ì¹´ë“œ
            if (siteCard) {
                siteCard.classList.add('reject-highlight-card');
                setTimeout(() => {
                    siteCard.classList.remove('reject-highlight-card');
                }, 3000);
                console.log('í˜„ì¥ê¸°ë¡ ì¹´ë“œì— ë°˜ë ¤ íš¨ê³¼ ì ìš©:', siteCard);
            } else {
                console.log('í˜„ì¥ê¸°ë¡ ì¹´ë“œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ');
            }
        }
        
        // 2. ë‚˜ë¨¸ì§€ ì¹´ë“œë“¤ - ìŠ¹ì¸ ì™„ë£Œ íš¨ê³¼ ì ìš© (ìƒì„¸ í™”ë©´ ë‚´ë¶€ ìš”ì†Œë“¤)
        // ìì¬ì‚¬ìš©ë‚´ì—­ ì¹´ë“œ
        const materialCards = detailPanel.querySelectorAll('.material-item');
        materialCards.forEach(card => {
            addApprovalBadge(card);
        });
        console.log('ìì¬ì‚¬ìš©ë‚´ì—­ ì¹´ë“œì— ìŠ¹ì¸ ì™„ë£Œ íš¨ê³¼ ì ìš©:', materialCards.length);
        
        // ì‚¬ì§„/ë„ë©´ ì¹´ë“œ
        const photoCards = detailPanel.querySelectorAll('.media-obj');
        photoCards.forEach(card => {
            addApprovalBadge(card);
        });
        console.log('ì‚¬ì§„/ë„ë©´ ì¹´ë“œì— ìŠ¹ì¸ ì™„ë£Œ íš¨ê³¼ ì ìš©:', photoCards.length);
        
        // ì‘ì—…ì™„ë£Œí™•ì¸ì„œ ì¹´ë“œ
        const confirmSection = detailPanel.querySelector('#detailConfirmSection');
        if (confirmSection) {
            addApprovalBadge(confirmSection);
            console.log('ì‘ì—…ì™„ë£Œí™•ì¸ì„œ ì¹´ë“œì— ìŠ¹ì¸ ì™„ë£Œ íš¨ê³¼ ì ìš©');
        }
    }
    
    // ìŠ¹ì¸ ë±ƒì§€ ì¶”ê°€
    function addApprovalBadge(card) {
        // ê¸°ì¡´ ë±ƒì§€ê°€ ìˆìœ¼ë©´ ì œê±°
        const existingBadge = card.querySelector('.approval-badge');
        if (existingBadge) existingBadge.remove();
        
        // ìŠ¹ì¸ ë±ƒì§€ ì¶”ê°€ (ì„¸ë ¨ëœ íšŒìƒ‰ í†¤)
        const badge = document.createElement('div');
        badge.className = 'approval-badge';
        badge.innerHTML = '<i data-lucide="check-circle" style="width:12px; height:12px; margin-right:4px;"></i>ìŠ¹ì¸ë¨';
        badge.style.cssText = `
            position: absolute;
            top: 8px;
            right: 8px;
            background: linear-gradient(135deg, #64748b, #475569);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 700;
            z-index: 10;
            box-shadow: 0 2px 8px rgba(71, 85, 105, 0.3);
            display: flex;
            align-items: center;
            backdrop-filter: blur(4px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        `;
        
        card.style.position = 'relative';
        card.appendChild(badge);
        
        // ì•„ì´ì½˜ ë Œë”ë§
        setTimeout(() => {
            lucide.createIcons();
        }, 100);
    }
    
    // [í•µì‹¬] ë°˜ë ¤ ì‚¬ìœ  ë¶„ì„ ë° ì„¹ì…˜ë³„ ìƒíƒœ ê²°ì •
    function getSectionStatus(bi) {
        // undefined ë°©ì§€: baseInfoì—ì„œ ì‚¬ìœ ë¥¼ ê°€ì ¸ì˜¤ê³  ì—†ì„ ê²½ìš° ë¹ˆ ë¬¸ìì—´ ì²˜ë¦¬
        const reason = bi.rejectReason || ""; 
        const fields = parseRejectReason(reason);
        
        return {
            site: fields.includes('siteName') || fields.includes('í˜„ì¥ëª…') || fields.includes('all'),
            manpower: fields.includes('manpower') || fields.includes('íˆ¬ì…ì¸ì›') || fields.includes('ì‘ì—…ì') || fields.includes('all'),
            workSets: fields.includes('workSets') || fields.includes('ì‘ì—…ë‚´ìš©') || fields.includes('ë¶€ì¬ëª…') || fields.includes('ê³µì •') || fields.includes('all'),
            materials: fields.includes('materials') || fields.includes('ìì¬') || fields.includes('all'),
            assets: fields.includes('photos') || fields.includes('drawings') || fields.includes('ì‚¬ì§„') || fields.includes('ë„ë©´') || fields.includes('all'),
            confirm: fields.includes('confirm') || fields.includes('í™•ì¸ì„œ') || fields.includes('all')
        };
    }
    
    // ë°˜ë ¤ ì‚¬ìœ  íŒŒì‹± í•¨ìˆ˜
    function parseRejectReason(reason) {
        const keywords = {
            'í˜„ì¥ëª…': ['í˜„ì¥ëª…', 'siteName'],
            'íˆ¬ì…ì¸ì›': ['íˆ¬ì…ì¸ì›', 'ì‘ì—…ì', 'manpower', 'ì¸ì›'],
            'ì‘ì—…ë‚´ìš©': ['ì‘ì—…ë‚´ìš©', 'ë¶€ì¬ëª…', 'ê³µì •', 'workSets'],
            'ìì¬': ['ìì¬', 'materials'],
            'ì‚¬ì§„': ['ì‚¬ì§„', 'photos'],
            'ë„ë©´': ['ë„ë©´', 'drawings'],
            'í™•ì¸ì„œ': ['í™•ì¸ì„œ', 'confirm']
        };
        
        const foundFields = [];
        for (const [field, terms] of Object.entries(keywords)) {
            if (terms.some(term => reason.includes(term))) {
                foundFields.push(field);
            }
        }
        
        return foundFields.length > 0 ? foundFields : ['all'];
    }
    
    // í˜„ì¥ ì •ë³´ ì„¹ì…˜ ë Œë”ë§ í•¨ìˆ˜
    function renderSiteInfoSection(bi, isEditMode) {
        const status = getEditableStatus(bi);
        const canEdit = isEditMode && status.site;
        const sectionClass = isEditMode ? (status.site ? 'data-locked' : 'data-locked') : '';

        return `
        <div class="detail-section ${sectionClass}" id="siteInfoSection">
            <div class="sec-head">
                <i data-lucide="info"></i> í˜„ì¥ ì •ë³´
                ${canEdit ? '<span class="edit-required-tag">ìˆ˜ì • í•„ìš”</span>' : ''}
            </div>
            ${canEdit ? `
                <input type="text" id="editSiteName" value="${bi.siteName}" class="material-select mb-3" style="background:white;">
                <div class="grid grid-cols-2 gap-3">
                    <input type="text" value="${bi.dept}" readonly class="material-select" style="background:#f1f5f9;">
                    <input type="date" id="editWorkDate" value="${g_currentDate}" class="material-select">
                </div>
            ` : ` 
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
                    <div class="p-3 bg-white rounded-xl">
                        <div style="font-size:12px; color:#94a3b8;">í˜„ì¥ëª…</div>
                        <div style="font-weight:700;">${bi.siteName}</div>
                    </div>
                    <div class="p-3 bg-white rounded-xl">
                        <div style="font-size:12px; color:#94a3b8;">ì†Œì†</div>
                        <div style="font-weight:700;">${bi.dept}</div>
                    </div>
                </div>
            `}
        </div>`;
    }
    
    // íˆ¬ì…ì¸ì› ì„¹ì…˜ ë Œë”ë§ í•¨ìˆ˜
    function renderManpowerSection(bi, isEditMode) {
        const status = getEditableStatus(bi);
        const canEdit = isEditMode && status.manpower;
        const sectionClass = isEditMode ? (status.manpower ? 'data-locked' : 'data-locked') : '';

        return `
        <div class="detail-section ${sectionClass}" id="manpowerSection">
            <div class="sec-head">
                <i data-lucide="users"></i> íˆ¬ì…ì¸ì›
                ${canEdit ? '<span class="edit-required-tag">ìˆ˜ì • í•„ìš”</span>' : ''}
            </div>
            ${canEdit ? `
                <div class="manpower-edit-form">
                    <input type="text" placeholder="ì‘ì—…ì ì´ë¦„" class="material-select mb-2">
                    <input type="number" placeholder="ì‘ì—…ì‹œê°„" class="material-select mb-2">
                    <button class="btn-primary">ì‘ì—…ì ì¶”ê°€</button>
                </div>
            ` : `
                <div class="manpower-display">
                    <div style="font-size:14px; color:var(--text-placeholder); text-align:center; padding:20px;">
                        íˆ¬ì…ì¸ì› ì •ë³´ê°€ ìŠ¹ì¸ë˜ì—ˆìŠµë‹ˆë‹¤
                    </div>
                </div>
            `}
        </div>`;
    }
    
    // ì‘ì—…ë‚´ìš© ì„¹ì…˜ ë Œë”ë§ í•¨ìˆ˜
    function renderWorkSetSection(bi, isEditMode) {
        const status = getEditableStatus(bi);
        const canEdit = isEditMode && status.workSets;
        const sectionClass = isEditMode ? (status.workSets ? 'data-locked' : 'data-locked') : '';

        return `
        <div class="detail-section ${sectionClass}" id="workSetSection">
            <div class="sec-head">
                <i data-lucide="briefcase"></i> ì‘ì—…ë‚´ìš©
                ${canEdit ? '<span class="edit-required-tag">ìˆ˜ì • í•„ìš”</span>' : ''}
            </div>
            ${canEdit ? `
                <div class="workset-edit-form">
                    <input type="text" placeholder="ë¶€ì¬ëª…" class="material-select mb-2">
                    <input type="text" placeholder="ì‘ì—…ê³µì •" class="material-select mb-2">
                    <textarea placeholder="ì‘ì—…ìƒì„¸" class="material-select mb-2" rows="3"></textarea>
                    <button class="btn-primary">ì‘ì—…ë‚´ìš© ì¶”ê°€</button>
                </div>
            ` : `
                <div class="workset-display">
                    <div style="font-size:14px; color:var(--text-placeholder); text-align:center; padding:20px;">
                        ì‘ì—…ë‚´ìš©ì´ ìŠ¹ì¸ë˜ì—ˆìŠµë‹ˆë‹¤
                    </div>
                </div>
            `}
        </div>`;
    }
    // ë°˜ë ¤ì‚¬ìœ ê°€ í¬í•¨ëœ ì¹´ë“œì—ë§Œ ì•Œë¦¼ íš¨ê³¼ ì ìš© (í•­ëª© ìœ í˜•ë³„)
    function applyRejectReasonHighlight() {
        const site = g_worklogs[g_currentSite];
        if (!site || !site.baseInfo) return;
        
        // ë°˜ë ¤ì‚¬ìœ  í™•ì¸ (baseInfo ë ˆë²¨ì—ì„œ í™•ì¸)
        const rejectReason = site.baseInfo.rejectReason;
        console.log('ë°˜ë ¤ì‚¬ìœ  í™•ì¸:', rejectReason);
        
        // ë°˜ë ¤ì‚¬ìœ ê°€ ìˆëŠ” ê²½ìš°ì—ë§Œ ê³ ë„í™”ëœ íš¨ê³¼ ì ìš©
        if (rejectReason && rejectReason.trim() !== '') {
            // 1. ë°˜ë ¤ ì‚¬ìœ  ë¶„ì„ ë° ì„¹ì…˜ë³„ í¸ì§‘ ê°€ëŠ¥ ì—¬ë¶€ íŒë‹¨
            const status = getEditableStatus(site.baseInfo);
            console.log('í¸ì§‘ ê°€ëŠ¥ ìƒíƒœ:', status);
            
            // 2. í•´ë‹¹ ì„¹ì…˜ì— ê³ ë„í™”ëœ íš¨ê³¼ ì ìš©
            applyAdvancedRejectEffects(status);
            
            // 3. ìë™ ìŠ¤í¬ë¡¤ ë° íˆ´íŒ ì•Œë¦¼
            scrollToFirstEditableSection(status);
            showEditTooltip(status);
            
            console.log('ê³ ë„í™”ëœ ë°˜ë ¤ ì•Œë¦¼ íš¨ê³¼ ì ìš©:', rejectReason);
        } else {
            console.log('ë°˜ë ¤ì‚¬ìœ ê°€ ì—†ì–´ íš¨ê³¼ ì ìš© ì¤‘ë‹¨');
        }
    }
    
    // ê³ ë„í™”ëœ ë°˜ë ¤ íš¨ê³¼ ì ìš©
    function applyAdvancedRejectEffects(status) {
        // 1. í˜„ì¥ ì •ë³´ ì„¹ì…˜ ê°•ì¡°
        if (status.site) {
            const siteSections = document.querySelectorAll('#detailPanel > div');
            siteSections.forEach(section => {
                if (section.textContent.includes('í˜„ì¥ ì •ë³´') || section.textContent.includes('í˜„ì¥ëª…') || section.textContent.includes('ì†Œì†')) {
                    triggerRejection(section.id || 'site-section', 'í˜„ì¥ ì •ë³´ê°€ ë°˜ë ¤ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    console.log('í˜„ì¥ ì •ë³´ ì„¹ì…˜ì— ìˆ˜ì • í•„ìš” íš¨ê³¼ ì ìš©');
                }
            });
        }
        
        // 2. íˆ¬ì…ì¸ì› ì„¹ì…˜ ê°•ì¡°
        if (status.manpower) {
            const manpowerSections = document.querySelectorAll('#detailPanel > div');
            manpowerSections.forEach(section => {
                if (section.textContent.includes('íˆ¬ì…ì¸ì›') || section.textContent.includes('ì‘ì—…ì')) {
                    triggerRejection(section.id || 'manpower-section', 'íˆ¬ì…ì¸ì› ì •ë³´ê°€ ë°˜ë ¤ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    console.log('íˆ¬ì…ì¸ì› ì„¹ì…˜ì— ìˆ˜ì • í•„ìš” íš¨ê³¼ ì ìš©');
                }
            });
        }
        
        // 3. ì‘ì—…ë‚´ìš© ì„¹ì…˜ ê°•ì¡°
        if (status.workSets) {
            const workSections = document.querySelectorAll('#detailPanel > div');
            workSections.forEach(section => {
                if (section.textContent.includes('ì‘ì—…ë‚´ìš©') || section.textContent.includes('ë¶€ì¬ëª…') || section.textContent.includes('ê³µì •')) {
                    triggerRejection(section.id || 'work-section', 'ì‘ì—…ë‚´ìš©ì´ ë°˜ë ¤ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    console.log('ì‘ì—…ë‚´ìš© ì„¹ì…˜ì— ìˆ˜ì • í•„ìš” íš¨ê³¼ ì ìš©');
                }
            });
        }
        
        // 4. ìì¬ ì„¹ì…˜ ê°•ì¡°
        if (status.materials) {
            const materialSections = document.querySelectorAll('#detailPanel > div');
            materialSections.forEach(section => {
                if (section.textContent.includes('ìì¬') || section.textContent.includes('ì¬ë£Œ')) {
                    triggerRejection(section.id || 'material-section', 'ìì¬ ì •ë³´ê°€ ë°˜ë ¤ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    console.log('ìì¬ ì„¹ì…˜ì— ìˆ˜ì • í•„ìš” íš¨ê³¼ ì ìš©');
                }
            });
        }
        
        // 5. ì‚¬ì§„/ë„ë©´ ì„¹ì…˜ ê°•ì¡°
        if (status.assets) {
            const assetSections = document.querySelectorAll('#detailPanel > div');
            assetSections.forEach(section => {
                if (section.textContent.includes('ì‚¬ì§„') || section.textContent.includes('ë„ë©´') || section.querySelector('.media-scroll')) {
                    triggerRejection(section.id || 'asset-section', 'ì‚¬ì§„/ë„ë©´ ì •ë³´ê°€ ë°˜ë ¤ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    console.log('ì‚¬ì§„/ë„ë©´ ì„¹ì…˜ì— ìˆ˜ì • í•„ìš” íš¨ê³¼ ì ìš©');
                }
            });
        }
        
        // 6. ìŠ¹ì¸ëœ ì„¹ì…˜ì— ì ê¸ˆ íš¨ê³¼ ì ìš©
        const allSections = document.querySelectorAll('#detailPanel > div');
        allSections.forEach(section => {
            if (!section.classList.contains('reject-effect')) {
                section.classList.add('data-locked');
                console.log('ìŠ¹ì¸ëœ ì„¹ì…˜ì— ì ê¸ˆ íš¨ê³¼ ì ìš©');
            }
        });
    }
    
    // ì²« ë²ˆì§¸ í¸ì§‘ ê°€ëŠ¥ ì„¹ì…˜ìœ¼ë¡œ ìë™ ìŠ¤í¬ë¡¤
    function scrollToFirstEditableSection(status) {
        let targetSection = null;
        
        const allSections = document.querySelectorAll('#detailPanel > div');
        
        if (status.site) {
            allSections.forEach(section => {
                if (section.textContent.includes('í˜„ì¥ ì •ë³´') || section.textContent.includes('í˜„ì¥ëª…')) {
                    targetSection = section;
                }
            });
        } else if (status.manpower) {
            allSections.forEach(section => {
                if (section.textContent.includes('íˆ¬ì…ì¸ì›') || section.textContent.includes('ì‘ì—…ì')) {
                    targetSection = section;
                }
            });
        } else if (status.workSets) {
            allSections.forEach(section => {
                if (section.textContent.includes('ì‘ì—…ë‚´ìš©') || section.textContent.includes('ë¶€ì¬ëª…')) {
                    targetSection = section;
                }
            });
        } else if (status.materials) {
            allSections.forEach(section => {
                if (section.textContent.includes('ìì¬')) {
                    targetSection = section;
                }
            });
        } else if (status.assets) {
            allSections.forEach(section => {
                if (section.textContent.includes('ì‚¬ì§„') || section.textContent.includes('ë„ë©´')) {
                    targetSection = section;
                }
            });
        }
        
        if (targetSection) {
            targetSection.scrollIntoView({ behavior: 'smooth', block: 'center' });
            console.log('ì²« ë²ˆì§¸ í¸ì§‘ ê°€ëŠ¥ ì„¹ì…˜ìœ¼ë¡œ ìŠ¤í¬ë¡¤');
        }
    }
    
    // ìˆ˜ì • íˆ´íŒ ì•Œë¦¼ í‘œì‹œ
    function showEditTooltip(status) {
        const tooltip = document.createElement('div');
        tooltip.style.cssText = `
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #dc2626;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 700;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(220, 38, 38, 0.3);
            animation: slideInDown 0.3s ease;
        `;
        tooltip.textContent = 'ğŸ”´ ì´ í•­ëª©ì„ ìˆ˜ì •í•´ì£¼ì„¸ìš”';
        
        document.body.appendChild(tooltip);
        
        setTimeout(() => {
            tooltip.remove();
        }, 3000);
        
        console.log('ìˆ˜ì • íˆ´íŒ ì•Œë¦¼ í‘œì‹œ');
    }
    
    // ë¶€ì¬ëª…/ì‘ì—…ê³µì • í•­ëª©ì— ë°˜ë ¤ íš¨ê³¼ ì ìš©
    function applyRejectEffectToWorkSets(date, dayData) {
        const workSetElements = document.querySelectorAll('.workset-item, .work-content, .work-text-summary');
        console.log('workSet ìš”ì†Œ ì°¾ê¸°:', workSetElements.length);
        workSetElements.forEach((element, index) => {
            element.classList.add('reject-highlight-workset');
            console.log('workSet íš¨ê³¼ ì ìš©:', index, element);
            setTimeout(() => {
                element.classList.remove('reject-highlight-workset');
            }, 3000);
        });
    }
    
    // ì‚¬ì§„ í•­ëª©ì— ë°˜ë ¤ íš¨ê³¼ ì ìš©
    function applyRejectEffectToPhotos(date, dayData) {
        const photoElements = document.querySelectorAll('.media-obj img, .photo-item, .media-scroll img');
        console.log('ì‚¬ì§„ ìš”ì†Œ ì°¾ê¸°:', photoElements.length);
        photoElements.forEach((element, index) => {
            const photoCard = element.closest('.media-obj, .photo-item');
            if (photoCard) {
                photoCard.classList.add('reject-highlight-photo');
                console.log('ì‚¬ì§„ íš¨ê³¼ ì ìš©:', index, photoCard);
                setTimeout(() => {
                    photoCard.classList.remove('reject-highlight-photo');
                }, 3000);
            }
        });
    }
    
    // ë„ë©´ í•­ëª©ì— ë°˜ë ¤ íš¨ê³¼ ì ìš©
    function applyRejectEffectToDrawings(date, dayData) {
        const drawingElements = document.querySelectorAll('.drawing-item, .media-scroll img[src*="drawing"]');
        console.log('ë„ë©´ ìš”ì†Œ ì°¾ê¸°:', drawingElements.length);
        drawingElements.forEach((element, index) => {
            element.classList.add('reject-highlight-drawing');
            console.log('ë„ë©´ íš¨ê³¼ ì ìš©:', index, element);
            setTimeout(() => {
                element.classList.remove('reject-highlight-drawing');
            }, 3000);
        });
    }
    
    // íˆ¬ì…ì¸ì› í•­ëª©ì— ë°˜ë ¤ íš¨ê³¼ ì ìš©
    function applyRejectEffectToManpower(date, dayData) {
        const manpowerElements = document.querySelectorAll('.manpower-item, .worker-item, .manpower-list li');
        console.log('íˆ¬ì…ì¸ì› ìš”ì†Œ ì°¾ê¸°:', manpowerElements.length);
        manpowerElements.forEach((element, index) => {
            element.classList.add('reject-highlight-manpower');
            console.log('íˆ¬ì…ì¸ì› íš¨ê³¼ ì ìš©:', index, element);
            setTimeout(() => {
                element.classList.remove('reject-highlight-manpower');
            }, 3000);
        });
    }
    
    // í•˜ë‹¨ ë²„íŠ¼ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
    function updateDetailFooter(status) {
        const footerEl = document.getElementById('detailFooter');
        if (!footerEl) return;
        
        let buttons = '';
        
        switch(status) {
            case 'draft': // ì‘ì„±ì¤‘: [ë‹«ê¸°][ì„ì‹œì €ì¥][ìŠ¹ì¸ìš”ì²­]
                buttons = `
                    <button class="btn-action btn-white" onclick="closeDetail()">ë‹«ê¸°</button>
                    <button class="btn-action" style="background:#cbd5e1; color:#475569;" onclick="saveDraft()">ì„ì‹œì €ì¥</button>
                    <button class="btn-action btn-navy" onclick="changeStatus('pending')">ìŠ¹ì¸ìš”ì²­</button>
                `;
                break;
            case 'pending': // ìŠ¹ì¸ìš”ì²­: [ë‹«ê¸°][ìš”ì²­ì·¨ì†Œ] (ìˆ˜ì • ë¶ˆê°€)
                buttons = `
                    <button class="btn-action btn-white" onclick="closeDetail()">ë‹«ê¸°</button>
                    <button class="btn-action" style="background:var(--danger); color:white;" onclick="cancelApproval()">ìš”ì²­ì·¨ì†Œ</button>
                `;
                break;
            case 'reject': // ë°˜ë ¤: [ë‹«ê¸°][ìˆ˜ì •][ìŠ¹ì¸ìš”ì²­] (ì•Œë¦¼ ì¹´ë“œ í‘œì‹œ)
                buttons = `
                    <button class="btn-action btn-white" onclick="closeDetail()">ë‹«ê¸°</button>
                    <button class="btn-action" style="background:#cbd5e1; color:#475569;" onclick="showRejectEditNotification()">ìˆ˜ì •</button>
                    <button class="btn-action btn-navy" onclick="changeStatus('pending')">ìŠ¹ì¸ìš”ì²­</button>
                `;
                break;
            case 'approved': // ìŠ¹ì¸ì™„ë£Œ: [ë‹«ê¸°][ë³´ê³ ì„œë³´ê¸°] (ìˆ˜ì •ë¶ˆê°€)
                buttons = `
                    <button class="btn-action btn-white" onclick="closeDetail()">ë‹«ê¸°</button>
                    <button class="btn-action btn-navy" onclick="openReportPreview()">ë³´ê³ ì„œë³´ê¸°</button>
                `;
                break;
        }
        
        footerEl.innerHTML = buttons;
    }
    
    // ë„ë©´ ì—…ë¡œë“œ (ìˆ˜ì •ìš©)
    function triggerDrawingUploadEdit() {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = 'image/*,.pdf';
        input.multiple = true;
        input.onchange = (e) => {
            const files = Array.from(e.target.files);
            if (files.length === 0) {
                showToast('íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”');
                flashInvalid(document.getElementById('detailContent'));
                return;
            }
            const site = g_worklogs[g_currentSite];
            if (!site) return;
            
            const data = site.dailyData[g_currentDate];
            if (!data) return;
            
            if (!data.assets) data.assets = {};
            if (!data.assets.drawings) data.assets.drawings = [];
            
            files.forEach(file => {
                const reader = new FileReader();
                reader.onload = (ev) => {
                    data.assets.drawings.push({
                        url: ev.target.result,
                        name: file.name
                    });
                    if (files.indexOf(file) === files.length - 1) {
                        openDetail(g_currentSite, 'attachment');
                    }
                };
                reader.readAsDataURL(file);
            });
        };
        input.click();
    }
    
    // ë„ë©´ ì‚­ì œ (ìˆ˜ì •ìš©)
    function removeDrawingEdit(idx) {
        const site = g_worklogs[g_currentSite];
        if (!site) return;
        
        const data = site.dailyData[g_currentDate];
        if (!data || !data.assets || !data.assets.drawings) return;
        
        data.assets.drawings.splice(idx, 1);
        openDetail(g_currentSite, g_currentTab);
    }

    function flashInvalid(el) {
        if (!el) return;
        try {
            el.classList.add('inopnc-invalid');
        } catch (e) {}
        try {
            el.scrollIntoView({ behavior: 'smooth', block: 'center' });
        } catch (e) {}
        setTimeout(() => {
            try { el.classList.remove('inopnc-invalid'); } catch (e) {}
        }, 450);
    }

    function validateEditModeRequired() {
        const site = g_worklogs[g_currentSite];
        if (!site) return false;
        
        const bi = site.baseInfo;
        const data = site.dailyData[g_currentDate];
        if (!data) return false;
        
        // ë°˜ë ¤ ëª¨ë“œ ì²´í¬
        const isRejectMode = bi.status === 'reject';
        const rejectReason = bi.rejectReason || '';
        const editableFields = isRejectMode ? parseRejectReason(rejectReason) : ['all'];
        const isFieldEditable = (field) => editableFields.includes(field) || editableFields.includes('all');

        const siteEl = document.getElementById('editSiteName');
        const dateEl = document.getElementById('editWorkDate');

        // í˜„ì¥ëª… ê²€ì¦ (ìˆ˜ì • ê°€ëŠ¥í•œ ê²½ìš°ë§Œ)
        if (isFieldEditable('siteName')) {
            const siteName = (siteEl?.value || '').trim();
            if (!siteName) {
                showToast('í˜„ì¥ëª…ì„ ì…ë ¥í•˜ì„¸ìš”');
                flashInvalid(siteEl);
                siteEl?.focus();
                return false;
            }
        } else if (isRejectMode) {
            // ë°˜ë ¤ ëª¨ë“œì—ì„œ ìˆ˜ì • ë¶ˆê°€ëŠ¥í•œ í•„ë“œëŠ” ê¸°ì¡´ ë°ì´í„°ê°€ ìˆë‹¤ê³  ê°„ì£¼
            console.log('í˜„ì¥ëª…ì€ ìŠ¹ì¸ë˜ì–´ ê²€ì¦ ìƒëµ');
        }

        // íˆ¬ì…ì¸ì› ê²€ì¦ (ìˆ˜ì • ê°€ëŠ¥í•œ ê²½ìš°ë§Œ)
        if (isFieldEditable('manpower')) {
            const manpowerItems = document.querySelectorAll('#manpowerListEdit .manpower-item');
            let hasValidManpower = false;
            manpowerItems.forEach(item => {
                const dateInput = item.querySelector('input[type="date"]');
                const workerDivs = item.querySelectorAll('.flex.items-center.gap-2');
                workerDivs.forEach(workerDiv => {
                    const nameInput = workerDiv.querySelector('input[type="text"]');
                    const hoursInput = workerDiv.querySelector('input[type="number"]');
                    const n = (nameInput?.value || '').trim();
                    const h = Number(hoursInput?.value || 0);
                    if ((dateInput?.value || '').trim() && n && h > 0) {
                        hasValidManpower = true;
                    }
                });
            });
            if (!hasValidManpower) {
                showToast('íˆ¬ì…ì¸ì›(ì´ë¦„/ì‹œê°„)ì„ ìµœì†Œ 1ëª… ì´ìƒ ì…ë ¥í•˜ì„¸ìš”');
                const mpWrap = document.getElementById('manpowerListEdit');
                flashInvalid(mpWrap);
                const firstName = mpWrap?.querySelector('input[type="text"]');
                firstName?.focus();
                return false;
            }
        } else if (isRejectMode) {
            // ë°˜ë ¤ ëª¨ë“œì—ì„œ ìˆ˜ì • ë¶ˆê°€ëŠ¥í•œ í•„ë“œëŠ” ê¸°ì¡´ ë°ì´í„°ê°€ ìˆë‹¤ê³  ê°„ì£¼
            console.log('íˆ¬ì…ì¸ì›ì€ ìŠ¹ì¸ë˜ì–´ ê²€ì¦ ìƒëµ');
        }

        // ì‘ì—…ë‚´ìš© ê²€ì¦ (ìˆ˜ì • ê°€ëŠ¥í•œ ê²½ìš°ë§Œ)
        const workSets = Array.isArray(data.workSets) ? data.workSets : [];
        if (isFieldEditable('workSets')) {
            if (workSets.length === 0) {
                showToast('ì‘ì—… ì„¸íŠ¸ë¥¼ 1ê°œ ì´ìƒ ì¶”ê°€í•˜ì„¸ìš”');
                const wsWrap = document.getElementById('workSetsEdit');
                flashInvalid(wsWrap);
                return false;
            }

            for (let i = 0; i < workSets.length; i++) {
                const ws = workSets[i] || {};
                const member = (ws.member || '').trim();
                const process = (ws.process || '').trim();
                const memberCustom = (document.getElementById(`customMemberEdit${i}`)?.value || '').trim();
                const processCustom = (document.getElementById(`customProcessEdit${i}`)?.value || '').trim();

                if (!member || (member === 'ê¸°íƒ€' && !memberCustom)) {
                    showToast('ë¶€ì¬ëª…ì€ í•„ìˆ˜ì…ë‹ˆë‹¤');
                    const card = document.querySelectorAll('#workSetsEdit > div')[i];
                    flashInvalid(card);
                    (member === 'ê¸°íƒ€' ? document.getElementById(`customMemberEdit${i}`) : card)?.focus?.();
                    return false;
                }
                
                if (!process || (process === 'ê¸°íƒ€' && !processCustom)) {
                    showToast('ê³µì •ì€ í•„ìˆ˜ì…ë‹ˆë‹¤');
                    const card = document.querySelectorAll('#workSetsEdit > div')[i];
                    flashInvalid(card);
                    (process === 'ê¸°íƒ€' ? document.getElementById(`customProcessEdit${i}`) : card)?.focus?.();
                    return false;
                }
            }
        } else if (isRejectMode) {
            // ë°˜ë ¤ ëª¨ë“œì—ì„œ ìˆ˜ì • ë¶ˆê°€ëŠ¥í•œ í•„ë“œëŠ” ê¸°ì¡´ ë°ì´í„°ê°€ ìˆë‹¤ê³  ê°„ì£¼
            console.log('ì‘ì—…ë‚´ìš©ì€ ìŠ¹ì¸ë˜ì–´ ê²€ì¦ ìƒëµ');
        }

        return true;
    }

    function validateDraftBeforeRequest() {
        const site = g_worklogs[g_currentSite];
        if (!site) return false;
        
        const bi = site.baseInfo || {};
        
        // ë””ë²„ê¹… ë¡œê·¸ ì¶”ê°€
        console.log('ìŠ¹ì¸ìš”ì²­ ê²€ì¦ ì‹œì‘:', {
            siteKey: g_currentSite,
            baseInfo: bi,
            dailyDataCount: Object.keys(site.dailyData || {}).length
        });

        if (!bi.siteName || !String(bi.siteName).trim()) {
            console.log('í˜„ì¥ëª… ê²€ì¦ ì‹¤íŒ¨:', bi.siteName);
            showToast('í˜„ì¥ëª…ì„ ì…ë ¥í•˜ì„¸ìš”');
            const el = document.getElementById('detailBasicInfo');
            flashInvalid(el);
            return false;
        }

        // íˆ¬ì…ì¸ì›: ëª¨ë“  ë‚ ì§œì˜ ë°ì´í„° í™•ì¸
        const dailyDates = Object.keys(site.dailyData || {});
        let hasManpower = false;
        console.log('íˆ¬ì…ì¸ì› ê²€ì¦ - ë‚ ì§œ ëª©ë¡:', dailyDates);
        
        dailyDates.forEach(dateKey => {
            const dayData = site.dailyData[dateKey];
            console.log(`${dateKey} ë‚ ì§œ ë°ì´í„°:`, dayData);
            
            if (dayData && dayData.manpower) {
                const hasMp = dayData.manpower.some(m => {
                    const ws = Array.isArray(m.workers) ? m.workers : [];
                    const validWorker = ws.some(w => (w?.name || '').trim() && Number(w?.hours || 0) > 0);
                    console.log(`${dateKey} ì‘ì—…ì ê²€ì¦:`, ws, 'ìœ íš¨í•œ ì‘ì—…ì:', validWorker);
                    return validWorker;
                });
                if (hasMp) hasManpower = true;
            }
        });
        
        console.log('íˆ¬ì…ì¸ì› ìµœì¢… ê²°ê³¼:', hasManpower);
        
        if (!hasManpower) {
            console.log('íˆ¬ì…ì¸ì› ê²€ì¦ ì‹¤íŒ¨');
            showToast('íˆ¬ì…ì¸ì›ì„ ìµœì†Œ 1ëª… ì´ìƒ ë“±ë¡í•˜ì„¸ìš”');
            const el = document.getElementById('detailManpowerSection');
            flashInvalid(el);
            return false;
        }

        // ì‘ì—… ì„¸íŠ¸: ëª¨ë“  ë‚ ì§œì˜ ë°ì´í„° í™•ì¸
        let hasWorkSets = false;
        console.log('ì‘ì—…ì„¸íŠ¸ ê²€ì¦ ì‹œì‘');
        
        dailyDates.forEach(dateKey => {
            const dayData = site.dailyData[dateKey];
            console.log(`${dateKey} ì‘ì—…ì„¸íŠ¸:`, dayData?.workSets);
            
            if (dayData && dayData.workSets && dayData.workSets.length > 0) {
                hasWorkSets = true;
            }
        });
        
        console.log('ì‘ì—…ì„¸íŠ¸ ì¡´ì¬ ì—¬ë¶€:', hasWorkSets);
        
        if (!hasWorkSets) {
            console.log('ì‘ì—…ì„¸íŠ¸ ê²€ì¦ ì‹¤íŒ¨ - ë°ì´í„° ì—†ìŒ');
            showToast('ì‘ì—…ë‚´ìš©(ë¶€ì¬ëª…/ê³µì •)ì„ ë“±ë¡í•˜ì„¸ìš”');
            const el = document.getElementById('detailWorkSetsAnchor') || document.getElementById('detailBasicInfo');
            flashInvalid(el);
            return false;
        }

        // ì‘ì—… ì„¸íŠ¸ ìƒì„¸ ê²€ì¦
        let allWorkSetsValid = true;
        console.log('ì‘ì—…ì„¸íŠ¸ ìƒì„¸ ê²€ì¦ ì‹œì‘');
        
        dailyDates.forEach(dateKey => {
            const dayData = site.dailyData[dateKey];
            if (dayData && dayData.workSets && dayData.workSets.length > 0) {
                dayData.workSets.forEach((ws, idx) => {
                    const member = (ws.member || '').trim();
                    const process = (ws.process || '').trim();
                    console.log(`${dateKey} ì‘ì—…ì„¸íŠ¸[${idx}]:`, { member, process, customMemberValue: ws.customMemberValue, customProcessValue: ws.customProcessValue });
                    
                    if (!member || (member === 'ê¸°íƒ€' && !(ws.customMemberValue || '').trim())) {
                        console.log('ë¶€ì¬ëª… ê²€ì¦ ì‹¤íŒ¨:', member, ws.customMemberValue);
                        allWorkSetsValid = false;
                    }
                    if (!process || (process === 'ê¸°íƒ€' && !(ws.customProcessValue || '').trim())) {
                        console.log('ê³µì • ê²€ì¦ ì‹¤íŒ¨:', process, ws.customProcessValue);
                        allWorkSetsValid = false;
                    }
                });
            }
        });

        console.log('ì‘ì—…ì„¸íŠ¸ ìƒì„¸ ê²€ì¦ ê²°ê³¼:', allWorkSetsValid);

        if (!allWorkSetsValid) {
            console.log('ì‘ì—…ì„¸íŠ¸ ìƒì„¸ ê²€ì¦ ì‹¤íŒ¨');
            showToast('ì‘ì—…ë‚´ìš©ì˜ ë¶€ì¬ëª…ê³¼ ê³µì •ì„ ëª¨ë‘ ì…ë ¥í•˜ì„¸ìš”');
            const el = document.getElementById('detailWorkSetsAnchor') || document.getElementById('detailBasicInfo');
            flashInvalid(el);
            return false;
        }

        return true;
    }
    
    // ìˆ˜ì • ì €ì¥ í›„ ìŠ¹ì¸ ìš”ì²­
    function saveEditAndRequest() {
        const site = g_worklogs[g_currentSite];
        if (!site) return;
        
        const bi = site.baseInfo;
        const data = site.dailyData[g_currentDate];
        if (!data) return;
        
        const status = bi.status;
        const rejectReason = bi.rejectReason || '';
        const editableFields = parseRejectReason(rejectReason);
        const isFieldEditable = (field) => editableFields.includes(field) || editableFields.includes('all');

        if (!validateEditModeRequired()) {
            return;
        }

        // ê¸°ë³¸ ì •ë³´ ì €ì¥ (ìˆ˜ì • ê°€ëŠ¥í•œ í•„ë“œë§Œ)
        if (isFieldEditable('siteName')) {
            const siteNameVal = document.getElementById('editSiteName')?.value;
            if (siteNameVal) bi.siteName = siteNameVal;
        }
        if (isFieldEditable('dept')) {
            const deptVal = document.getElementById('editDept')?.value;
            if (deptVal) bi.dept = deptVal;
        }
        
        // íˆ¬ì…ì¸ì› ì •ë³´ ì €ì¥ (ìˆ˜ì • ê°€ëŠ¥í•œ ê²½ìš°ë§Œ)
        if (isFieldEditable('manpower')) {
            const manpowerItems = document.querySelectorAll('#manpowerListEdit .manpower-item');
            data.manpowerHistory = [];
            manpowerItems.forEach(item => {
                const dateInput = item.querySelector('input[type="date"]');
                const workerInputs = item.querySelectorAll('.flex.items-center.gap-2');
                const workers = [];
                
                workerInputs.forEach(workerDiv => {
                    const nameInput = workerDiv.querySelector('input[type="text"]');
                    const hoursInput = workerDiv.querySelector('input[type="number"]');
                    if (nameInput && hoursInput && nameInput.value && hoursInput.value) {
                        workers.push({
                            name: nameInput.value,
                            hours: parseFloat(hoursInput.value)
                        });
                    }
                });
                
                if (dateInput && dateInput.value && workers.length > 0) {
                    data.manpowerHistory.push({
                        date: dateInput.value,
                        workers: workers
                    });
                }
            });
        }
        
        // ìì¬ ì •ë³´ ì €ì¥ (ìˆ˜ì • ê°€ëŠ¥í•œ ê²½ìš°ë§Œ)
        if (isFieldEditable('materials')) {
            const oldMaterials = Array.isArray(data.materials) ? data.materials : [];
            const materialInputs = document.querySelectorAll('[id^="materialNameEdit"]');
            data.materials = [];
            materialInputs.forEach((input, idx) => {
                const name = input.value;
                const qty = document.getElementById(`materialQtyEdit${idx}`)?.value || 1;
                const unit = document.getElementById(`materialUnitEdit${idx}`)?.value || 'ë§';
                
                if (name && qty) {
                    data.materials.push({
                        name: name,
                        quantity: parseFloat(qty),
                        unit: unit,
                        receipt: oldMaterials[idx]?.receipt || null
                    });
                }
            });
        }
        
        // ì‘ì—… ì„¸íŠ¸ ì •ë³´ ì €ì¥ (ìˆ˜ì • ê°€ëŠ¥í•œ ê²½ìš°ë§Œ)
        if (isFieldEditable('workSets')) {
            const existingSets = Array.isArray(data.workSets) ? data.workSets : [];
            data.workSets = existingSets.map((ws, idx) => {
                const blockInput = document.getElementById(`blockEdit${idx}`);
                const dongInput = document.getElementById(`dongEdit${idx}`);
                const floorInput = document.getElementById(`floorEdit${idx}`);
                const typeInput = document.getElementById(`typeEdit${idx}`);
                const member = (ws.member || '').trim();
                const process = (ws.process || '').trim();
                return {
                    id: ws.id || (Date.now() + idx),
                    member,
                    process,
                    type: typeInput ? typeInput.value : (ws.type || ''),
                    location: {
                        block: blockInput ? blockInput.value : (ws.location?.block || ''),
                        dong: dongInput ? dongInput.value : (ws.location?.dong || ''),
                        floor: floorInput ? floorInput.value : (ws.location?.floor || '')
                    },
                    customMemberValue: member === 'ê¸°íƒ€' ? (document.getElementById(`customMemberEdit${idx}`)?.value || ws.customMemberValue || '') : '',
                    customProcessValue: process === 'ê¸°íƒ€' ? (document.getElementById(`customProcessEdit${idx}`)?.value || ws.customProcessValue || '') : ''
                };
            });
        }
        
        // ìƒíƒœë¥¼ ìš”ì²­ìœ¼ë¡œ ë³€ê²½
        bi.status = 'pending';
        site.status = 'pending';
        bi.rejectReason = null; // ë°˜ë ¤ ì‚¬ìœ  ì´ˆê¸°í™”
        
        // ë²„ì „ íˆìŠ¤í† ë¦¬ ì¶”ê°€
        if (!Array.isArray(data.versions)) data.versions = [];
        data.versions.push({
            ver: data.versions.length + 1,
            time: new Date().toISOString(),
            type: 'request',
            desc: status === 'reject' ? 'ë°˜ë ¤ í•­ëª© ìˆ˜ì • í›„ ì¬ìš”ì²­' : 'ìŠ¹ì¸ ìš”ì²­'
        });
        
        saveData();
        openDetail(g_currentSite, 'status');
        showToast('ìŠ¹ì¸ ìš”ì²­ë˜ì—ˆìŠµë‹ˆë‹¤.');
    }

    // [ìˆ˜ì • 6] ë°˜ë ¤ ë‹¤ì´ì–¼ë¡œê·¸ í‘œì‹œ
    function showRejectDialog() {
        const html = `
            <div style="position:fixed; inset:0; background:rgba(0,0,0,0.6); z-index:3500; display:flex; align-items:center; justify-content:center; animation:fadeIn 0.2s;" id="rejectDialog" onclick="if(event.target.id==='rejectDialog') document.getElementById('rejectDialog').remove();">
                <div style="background:white; border-radius:16px; padding:24px; width:90%; max-width:450px; box-shadow:0 20px 60px rgba(0,0,0,0.3); " onclick="event.stopPropagation();">
                    <div style="display:flex; align-items:center; gap:12px; margin-bottom:20px;">
                        <div style="width:48px; height:48px; background:linear-gradient(135deg, #fee2e2, #fecaca); border-radius:12px; display:flex; align-items:center; justify-content:center;">
                            <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#dc2626" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>
                        </div>
                        <div>
                            <h3 style="margin:0; font-size:20px; font-weight:800; color:#991b1b;">ë°˜ë ¤ ì‚¬ìœ  ì…ë ¥</h3>
                            <p style="margin:4px 0 0 0; font-size:13px; color:#6b7280;">ë°˜ë ¤ ì‚¬ìœ ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”</p>
                        </div>
                    </div>
                    
                    <textarea id="rejectReasonInput" placeholder="ì˜ˆ: ì‘ì—… ë‚´ìš©ì´ ë¶ˆëª…í™•í•©ë‹ˆë‹¤. ìƒì„¸ ë‚´ìš©ì„ ì¶”ê°€í•´ì£¼ì„¸ìš”." 
                        style="width:100%; min-height:120px; border:2px solid #e5e7eb; border-radius:12px; padding:14px; font-size:15px; font-family:inherit; resize:vertical; margin-bottom:16px; transition:all 0.2s;"
                        onfocus="this.style.borderColor='#dc2626'; this.style.boxShadow='0 0 0 3px rgba(220,38,38,0.1)';" 
                        onblur="this.style.borderColor='#e5e7eb'; this.style.boxShadow='none';"></textarea>
                    
                    <div style="display:flex; gap:12px;">
                        <button onclick="document.getElementById('rejectDialog').remove()" style="flex:1; height:50px; border-radius:12px; border:1px solid #e5e7eb; background:#f9fafb; color:#6b7280; font-weight:700; font-size:16px; cursor:pointer; transition:all 0.2s;" onmouseover="this.style.background='#f3f4f6';" onmouseout="this.style.background='#f9fafb';">ì·¨ì†Œ</button>
                        <button onclick="confirmReject()" style="flex:1; height:50px; border-radius:12px; border:none; background:linear-gradient(135deg, #dc2626, #b91c1c); color:white; font-weight:700; font-size:16px; cursor:pointer; box-shadow:0 4px 12px rgba(220,38,38,0.3); transition:all 0.2s;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(220,38,38,0.4)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(220,38,38,0.3)';">ë°˜ë ¤ í™•ì •</button>
                    </div>
                </div>
            </div>
            <style>
                @keyframes fadeIn { from { opacity:0; } to { opacity:1; } }
                @keyframes slideUp { from { transform:translateY(20px); opacity:0; } to { transform:translateY(0); opacity:1; } }
                @keyframes rejectPulse { 0%, 100% { box-shadow:0 0 0 0 rgba(220,38,38,0.4); } 50% { box-shadow:0 0 0 8px rgba(220,38,38,0); } }
            </style>
        `;
        document.body.insertAdjacentHTML('beforeend', html);
        setTimeout(() => document.getElementById('rejectReasonInput').focus(), 100);
    }
    
    function confirmReject() {
        const reason = document.getElementById('rejectReasonInput').value.trim();
        if(!reason) {
            alert('ë°˜ë ¤ ì‚¬ìœ ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            return;
        }
        document.getElementById('rejectDialog').remove();
        changeStatus('reject', reason);
    }
    
    // ë°˜ë ¤ ì•Œë¦¼ ì‹œìŠ¤í…œ
    function showRejectNotification(rejectReason) {
        const html = `
            <div style="position:fixed; inset:0; background:rgba(0,0,0,0.7); z-index:4000; display:flex; align-items:center; justify-content:center; animation:fadeIn 0.3s;" id="rejectNotification" onclick="if(event.target.id==='rejectNotification') closeRejectNotification();">
                <div style="background:white; border-radius:20px; padding:32px; width:90%; max-width:480px; box-shadow:0 25px 70px rgba(220,38,38,0.4); animation:slideUpBounce 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);" onclick="event.stopPropagation();">
                    <div style="display:flex; justify-content:center; margin-bottom:24px;">
                        <div style="width:80px; height:80px; background:linear-gradient(135deg, #fee2e2, #fecaca); border-radius:50%; display:flex; align-items:center; justify-content:center; box-shadow:0 8px 24px rgba(220,38,38,0.3); animation:rejectPulse 2s infinite;">
                            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#dc2626" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="12" cy="12" r="10"></circle>
                                <line x1="15" y1="9" x2="9" y2="15"></line>
                                <line x1="9" y1="9" x2="15" y2="15"></line>
                            </svg>
                        </div>
                    </div>
                    <h2 style="margin:0 0 12px 0; font-size:24px; font-weight:900; color:#991b1b; text-align:center;">ì‘ì—…ì¼ì§€ê°€ ë°˜ë ¤ë˜ì—ˆìŠµë‹ˆë‹¤</h2>
                    <p style="margin:0 0 24px 0; font-size:15px; color:#6b7280; text-align:center; line-height:1.6;">ì•„ë˜ ì‚¬ìœ ë¥¼ í™•ì¸í•˜ì‹œê³ <br>ìˆ˜ì • í›„ ë‹¤ì‹œ ìŠ¹ì¸ ìš”ì²­í•´ì£¼ì„¸ìš”</p>
                    <div style="background:#fef2f2; border:2px solid #fca5a5; border-radius:16px; padding:20px; margin-bottom:24px;">
                        <div style="display:flex; align-items:center; gap:8px; margin-bottom:12px;">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#dc2626" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="12" cy="12" r="10"></circle>
                                <line x1="12" y1="8" x2="12" y2="12"></line>
                                <line x1="12" y1="16" x2="12.01" y2="16"></line>
                            </svg>
                            <span style="font-size:14px; font-weight:700; color:#dc2626;">ë°˜ë ¤ ì‚¬ìœ </span>
                        </div>
                        <div style="font-size:15px; line-height:1.7; color:#991b1b; font-weight:500; white-space:pre-wrap;">${rejectReason || 'ì‚¬ìœ ê°€ ì…ë ¥ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.'}</div>
                    </div>
                    <div style="background:#fff7ed; border:1px solid #fed7aa; border-radius:12px; padding:16px; margin-bottom:24px;">
                        <div style="display:flex; gap:12px;">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#f59e0b" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="flex-shrink:0; margin-top:2px;">
                                <circle cx="12" cy="12" r="10"></circle>
                                <line x1="12" y1="16" x2="12" y2="12"></line>
                                <line x1="12" y1="8" x2="12.01" y2="8"></line>
                            </svg>
                            <div style="font-size:13px; color:#92400e; line-height:1.6;">
                                <strong style="display:block; margin-bottom:4px;">ìˆ˜ì • ë°©ë²•</strong>
                                ë°˜ë ¤ ì‚¬ìœ ì— í•´ë‹¹í•˜ëŠ” í•­ëª©ì„ ìˆ˜ì •í•˜ì‹  í›„<br>í•˜ë‹¨ì˜ <strong>[ìŠ¹ì¸ìš”ì²­]</strong> ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.
                            </div>
                        </div>
                    </div>
                    <button onclick="closeRejectNotification()" style="width:100%; height:56px; border-radius:14px; border:none; background:linear-gradient(135deg, #dc2626, #b91c1c); color:white; font-weight:800; font-size:17px; cursor:pointer; box-shadow:0 6px 20px rgba(220,38,38,0.4); transition:all 0.2s; display:flex; align-items:center; justify-content:center; gap:8px;">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="20 6 9 17 4 12"></polyline>
                        </svg>
                        í™•ì¸í–ˆìŠµë‹ˆë‹¤
                    </button>
                </div>
            </div>
            <style>
                @keyframes slideUpBounce { 0% { transform: translateY(100px); opacity: 0; } 60% { transform: translateY(-10px); opacity: 1; } 80% { transform: translateY(5px); } 100% { transform: translateY(0); } }
            </style>
        `;
        document.body.insertAdjacentHTML('beforeend', html);
        if (navigator.vibrate) navigator.vibrate([200, 100, 200]);
    }
    
    function closeRejectNotification() {
        const notification = document.getElementById('rejectNotification');
        if (notification) {
            notification.style.animation = 'fadeOut 0.2s';
            setTimeout(() => notification.remove(), 200);
        }
    }
    
    // ì„ì‹œì €ì¥ í•¨ìˆ˜
    function saveDraft() {
        if (!g_currentSite) return;
        const site = g_worklogs[g_currentSite];
        if (!site) return;
        
        saveData();
        showToast('ì„ì‹œì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
    }

    // ìƒíƒœ ë³€ê²½ í•¨ìˆ˜ (ë°˜ë ¤ ì‚¬ìœ  í¬í•¨)
    function changeStatus(newStatus, rejectReason = null) {
        if(!g_currentSite) return;
        const site = g_worklogs[g_currentSite];
        if (!site) return;
        
        const curStatus = site.status;
        
        // ì‘ì„±ì¤‘ â†’ ìŠ¹ì¸ìš”ì²­: ê²€ì¦ í•„ìš”
        if (curStatus === 'draft' && newStatus === 'pending') {
            if (!validateDraftBeforeRequest()) {
                return;
            }
        }
        
        // ë°˜ë ¤ â†’ ìŠ¹ì¸ìš”ì²­: ê¸°ì¡´ ë°ì´í„°ê°€ ìˆìœ¼ë¯€ë¡œ ê²€ì¦ ë¶ˆí•„ìš” (ìˆ˜ì • ëª¨ë“œì—ì„œ ì´ë¯¸ ê²€ì¦ë¨)
        // ë°˜ë ¤ ìƒíƒœì—ì„œëŠ” enableEditMode â†’ saveEditAndRequestë¥¼ í†µí•´ ìˆ˜ì •í•˜ê±°ë‚˜
        // ìˆ˜ì • ì—†ì´ ë°”ë¡œ ì¬ìš”ì²­í•  ìˆ˜ ìˆìŒ
        
        // í˜„ì¥ ì „ì²´ ìƒíƒœ ë³€ê²½
        g_worklogs[g_currentSite].status = newStatus;
        g_worklogs[g_currentSite].baseInfo.status = newStatus;
        
        if(newStatus === 'reject' && rejectReason) {
            g_worklogs[g_currentSite].baseInfo.rejectReason = rejectReason;
        } else if (newStatus === 'pending' && curStatus === 'reject') {
            // ë°˜ë ¤ â†’ ìŠ¹ì¸ìš”ì²­: ë°˜ë ¤ ì‚¬ìœ  ì´ˆê¸°í™”
            g_worklogs[g_currentSite].baseInfo.rejectReason = null;
        }
        
        saveData();
        
        // ì•Œë¦¼ ë©”ì‹œì§€ ì²˜ë¦¬
        let msg = "ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.";
        if(newStatus === 'pending') msg = "ìŠ¹ì¸ ìš”ì²­ë˜ì—ˆìŠµë‹ˆë‹¤.";
        if(newStatus === 'draft') msg = "ì‘ì„±ì¤‘ìœ¼ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.";
        if(newStatus === 'approved') msg = "ìµœì¢… ìŠ¹ì¸ë˜ì—ˆìŠµë‹ˆë‹¤.";
        if(newStatus === 'reject') msg = `ë°˜ë ¤ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.`;
        
        showToast(msg);
        
        // [í•µì‹¬] í˜„ì¬ ë³´ê³  ìˆëŠ” íƒ­(g_currentTab)ì„ ì¸ìë¡œ ë„˜ê²¨ íƒ­ ì´ë™ì„ ë°©ì§€í•©ë‹ˆë‹¤.
        console.log('ìƒíƒœ ë³€ê²½ ì‹œ í˜„ì¬ íƒ­:', g_currentTab);
        
        // ë¦¬ìŠ¤íŠ¸ ë Œë”ë§ ë¨¼ì € ì‹¤í–‰
        renderLogs();
        
        // ìƒì„¸ íŒ¨ë„ ì—´ê¸°
        openDetail(g_currentSite, g_currentTab);
        
        // ë°˜ë ¤ ì•Œë¦¼ ì´ë²¤íŠ¸ (ìƒì„¸ íŒ¨ë„ì´ ì—´ë¦° í›„ ì¹´ë“œ íš¨ê³¼ë§Œ ì ìš©)
        if (newStatus === 'reject') {
            setTimeout(() => {
                // ë°˜ë ¤ ì¹´ë“œì— ì•Œë¦¼ íš¨ê³¼ ì ìš© - ì—¬ëŸ¬ ë²ˆ ì‹œë„
                const applyCardEffect = () => {
                    const logCard = document.getElementById(`log-${g_currentSite}`);
                    if (logCard) {
                        logCard.classList.add('reject-pulse');
                        logCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        setTimeout(() => {
                            logCard.classList.remove('reject-pulse');
                        }, 3000);
                    } else {
                        // ì¹´ë“œë¥¼ ì°¾ì§€ ëª»í•˜ë©´ ë‹¤ì‹œ ì‹œë„
                        setTimeout(applyCardEffect, 200);
                    }
                };
                applyCardEffect();
            }, 500);
        }
    }

    function showToast(msg) {
        const t = document.getElementById('toast');
        document.getElementById('toastText').innerText = msg;
        t.classList.add('show');
        setTimeout(() => t.classList.remove('show'), 2000);
    }

    // ========== ì‚¬ì§„ ê´€ë ¨ í•¨ìˆ˜ ==========
    // [ìµœì í™”] ì´ë¯¸ì§€ ì••ì¶• í•¨ìˆ˜
    function compressImage(file, maxWidth = 1920, quality = 0.8) {
        return new Promise((resolve) => {
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    let width = img.width;
                    let height = img.height;
                    
                    if (width > maxWidth) {
                        height = (height * maxWidth) / width;
                        width = maxWidth;
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    canvas.toBlob((blob) => {
                        resolve(canvas.toDataURL('image/jpeg', quality));
                    }, 'image/jpeg', quality);
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        });
    }

    function triggerPhotoUpload() {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '*/*'; // ëª¨ë“  íŒŒì¼ íƒ€ì… í—ˆìš©
        input.multiple = true; // ëŒ€ëŸ‰ ì—…ë¡œë“œ ì§€ì›
        input.onchange = async (e) => {
            const files = Array.from(e.target.files);
            if(files.length === 0) {
                showToast('íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”');
                flashInvalid(document.getElementById('detailPhotoSection'));
                return;
            }
            
            showToast(`${files.length}ê°œ íŒŒì¼ ì—…ë¡œë“œ ì¤‘...`);
            
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                let dataUrl;
                
                // ì´ë¯¸ì§€ íŒŒì¼ì¸ ê²½ìš° ì••ì¶• ì ìš©
                if (file.type.startsWith('image/')) {
                    dataUrl = await compressImage(file);
                } else {
                    // ì´ë¯¸ì§€ê°€ ì•„ë‹Œ íŒŒì¼ì€ ê·¸ëŒ€ë¡œ ì½ê¸°
                    const reader = new FileReader();
                    dataUrl = await new Promise((resolve) => {
                        reader.onload = (ev) => resolve(ev.target.result);
                        reader.readAsDataURL(file);
                    });
                }
                
                const newPhoto = {
                    url: dataUrl,
                    uploadDate: new Date().toISOString().slice(0,10),
                    desc: file.name.replace(/\.[^/.]+$/, ""),
                    fileName: file.name,
                    fileType: file.type || 'unknown',
                    status: "after" // ê¸°ë³¸ê°’: ë³´ìˆ˜í›„
                };
                
                if(!g_worklogs[g_currentSite].dailyData[g_currentDate].assets.photos) {
                    g_worklogs[g_currentSite].dailyData[g_currentDate].assets.photos = [];
                }
                g_worklogs[g_currentSite].dailyData[g_currentDate].assets.photos.push(newPhoto);
            }
            
            // íˆìŠ¤í† ë¦¬ ì¶”ê°€
            if (!g_worklogs[g_currentSite].dailyData[g_currentDate].versions) {
                g_worklogs[g_currentSite].dailyData[g_currentDate].versions = [];
            }
            const versions = g_worklogs[g_currentSite].dailyData[g_currentDate].versions;
            versions.push({
                ver: versions.length + 1,
                time: new Date().toISOString(),
                type: 'photo',
                desc: `ì‚¬ì§„ ${files.length}ê°œ ì—…ë¡œë“œ`
            });
            
            saveData();
            openDetail(g_currentSite, 'attachment'); // ìë£Œì²¨ë¶€ íƒ­ìœ¼ë¡œ ì´ë™
            showToast(`ì‚¬ì§„ ${files.length}ê°œê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.`);
        };
        input.click();
    }
    
    function viewPhoto(idx) {
        const photo = g_worklogs[g_currentSite].dailyData[g_currentDate].assets.photos[idx];
        showPreviewModal(photo.url, photo.desc || 'ì‚¬ì§„ ' + (idx+1), 'image');
    }
    
    function deletePhoto(idx) {
        if(!confirm('ì´ ì‚¬ì§„ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
        g_worklogs[g_currentSite].dailyData[g_currentDate].assets.photos.splice(idx, 1);
        saveData();
        openDetail(g_currentSite);
        showToast('ì‚¬ì§„ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
    }

    function togglePhotoStatus(idx) {
        const photo = g_worklogs[g_currentSite].dailyData[g_currentDate].assets.photos[idx];
        photo.status = photo.status === 'before' ? 'after' : 'before';
        saveData();
        openDetail(g_currentSite, g_currentTab);
        showToast(`ìƒíƒœê°€ '${photo.status === 'before' ? 'ë³´ìˆ˜ì „' : 'ë³´ìˆ˜í›„'}'ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.`);
    }

    function replacePhoto(idx) {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = 'image/*';
        input.onchange = (e) => {
            const file = e.target.files[0];
            if(!file) {
                showToast('íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”');
                flashInvalid(document.getElementById('detailPhotoSection'));
                return;
            }
            const reader = new FileReader();
            reader.onload = (ev) => {
                g_worklogs[g_currentSite].dailyData[g_currentDate].assets.photos[idx].url = ev.target.result;
                g_worklogs[g_currentSite].dailyData[g_currentDate].assets.photos[idx].uploadDate = new Date().toISOString().slice(0,10);
                saveData();
                openDetail(g_currentSite);
                showToast('ì‚¬ì§„ì´ êµì²´ë˜ì—ˆìŠµë‹ˆë‹¤.');
            };
            reader.readAsDataURL(file);
        };
        input.click();
    }

    // ========== ë„ë©´ ê´€ë ¨ í•¨ìˆ˜ ==========
    function triggerDrawingUpload() {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '*/*'; // ëª¨ë“  íŒŒì¼ íƒ€ì… í—ˆìš©
        input.multiple = true; // ëŒ€ëŸ‰ ì—…ë¡œë“œ ì§€ì›
        input.onchange = async (e) => {
            const files = Array.from(e.target.files);
            if(files.length === 0) {
                showToast('íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”');
                flashInvalid(document.getElementById('detailDrawingSection'));
                return;
            }
            
            showToast(`${files.length}ê°œ íŒŒì¼ ì—…ë¡œë“œ ì¤‘...`);
            
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                let dataUrl;
                
                // ì´ë¯¸ì§€ íŒŒì¼ì¸ ê²½ìš° ì••ì¶• ì ìš©
                if (file.type.startsWith('image/')) {
                    dataUrl = await compressImage(file);
                } else {
                    // ì´ë¯¸ì§€ê°€ ì•„ë‹Œ íŒŒì¼ì€ ê·¸ëŒ€ë¡œ ì½ê¸°
                    const reader = new FileReader();
                    dataUrl = await new Promise((resolve) => {
                        reader.onload = (ev) => resolve(ev.target.result);
                        reader.readAsDataURL(file);
                    });
                }
                
                const newDrawing = {
                    url: dataUrl,
                    uploadDate: new Date().toISOString().slice(0,10),
                    marked: false,
                    desc: file.name.replace(/\.[^/.]+$/, ""),
                    fileName: file.name,
                    fileType: file.type || 'unknown',
                    status: "progress" // ê¸°ë³¸ê°’: ì§„í–‰ë„ë©´
                };
                
                if(!g_worklogs[g_currentSite].dailyData[g_currentDate].assets.drawings) {
                    g_worklogs[g_currentSite].dailyData[g_currentDate].assets.drawings = [];
                }
                g_worklogs[g_currentSite].dailyData[g_currentDate].assets.drawings.push(newDrawing);
            }
            
            if (!g_worklogs[g_currentSite].dailyData[g_currentDate].versions) {
                g_worklogs[g_currentSite].dailyData[g_currentDate].versions = [];
            }
            const versions = g_worklogs[g_currentSite].dailyData[g_currentDate].versions;
            versions.push({
                ver: versions.length + 1,
                time: new Date().toISOString(),
                type: 'drawing',
                desc: `ë„ë©´ ${files.length}ê°œ ì—…ë¡œë“œ`
            });
            
            saveData();
            openDetail(g_currentSite, 'attachment'); // ìë£Œì²¨ë¶€ íƒ­ìœ¼ë¡œ ì´ë™
            showToast(`ë„ë©´ ${files.length}ê°œê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.`);
        };
        input.click();
    }
    
    function viewDrawing(idx) {
        const drawing = g_worklogs[g_currentSite].dailyData[g_currentDate].assets.drawings[idx];
        showPreviewModal(drawing.url, drawing.desc || 'ë„ë©´ ' + (idx+1), 'image');
    }
    
    function deleteDrawing(idx) {
        if(!confirm('ì´ ë„ë©´ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
        g_worklogs[g_currentSite].dailyData[g_currentDate].assets.drawings.splice(idx, 1);
        saveData();
        openDetail(g_currentSite);
        showToast('ë„ë©´ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
    }

    function toggleDrawingStatus(idx) {
        const drawing = g_worklogs[g_currentSite].dailyData[g_currentDate].assets.drawings[idx];
        drawing.status = drawing.status === 'progress' ? 'complete' : 'progress';
        saveData();
        openDetail(g_currentSite, g_currentTab);
        showToast(`ìƒíƒœê°€ '${drawing.status === 'complete' ? 'ì™„ë£Œë„ë©´' : 'ì§„í–‰ë„ë©´'}'ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.`);
    }

    function replaceDrawing(idx) {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = 'image/*,.pdf';
        input.onchange = (e) => {
            const file = e.target.files[0];
            if(!file) {
                showToast('íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”');
                flashInvalid(document.getElementById('detailDrawingSection'));
                return;
            }
            const reader = new FileReader();
            reader.onload = (ev) => {
                g_worklogs[g_currentSite][g_currentDate].assets.drawings[idx].url = ev.target.result;
                g_worklogs[g_currentSite][g_currentDate].assets.drawings[idx].uploadDate = new Date().toISOString().slice(0,10);
                saveData();
                openDetail(g_currentSite, g_currentDate);
                showToast('ë„ë©´ì´ êµì²´ë˜ì—ˆìŠµë‹ˆë‹¤.');
            };
            reader.readAsDataURL(file);
        };
        input.click();
    }

    // ========== ìì¬ ê´€ë ¨ í•¨ìˆ˜ (mainpage ë°©ì‹) ==========
    let g_selectedMaterialName = '';
    let g_customMaterialValue = '';
    let g_customReceiptFile = null;
    let g_customReceiptFiles = [];

    function addMaterialFromSelect() {
        const selectId = `materialSelect_${g_currentSite}_${g_currentDate}`;
        const qtyId = `materialQty_${g_currentSite}_${g_currentDate}`;
        const select = document.getElementById(selectId);
        const qtyInput = document.getElementById(qtyId);
        
        const materialName = g_selectedMaterialName || select?.value;
        const qty = parseFloat(qtyInput?.value);
        
        if(!materialName || materialName === '') {
            showToast('ìì¬ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”');
            return;
        }
        if(isNaN(qty) || qty <= 0) {
            showToast('ì˜¬ë°”ë¥¸ ìˆ˜ëŸ‰ì„ ì…ë ¥í•˜ì„¸ìš”');
            return;
        }
        
        if(!g_worklogs[g_currentSite][g_currentDate].materials) {
            g_worklogs[g_currentSite][g_currentDate].materials = [];
        }
        
        g_worklogs[g_currentSite][g_currentDate].materials.push({
            name: materialName,
            quantity: qty,
            unit: 'ë§',
            receipt: g_customReceiptFile
        });
        
        const versions = g_worklogs[g_currentSite][g_currentDate].versions;
        versions.push({
            ver: versions.length + 1,
            time: new Date().toISOString(),
            type: 'material',
            desc: `ìì¬ ì¶”ê°€ (${materialName} ${qty}ë§)`
        });
        
        // ì´ˆê¸°í™”
        if(qtyInput) qtyInput.value = '';
        g_selectedMaterialName = '';
        g_customReceiptFile = null;
        
        saveData();
        openDetail(g_currentSite, g_currentDate);
        showToast('ìì¬ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.');
    }
    
    function handleMaterialSelectChange(e) {
        const customInputId = `customMaterialInput_${g_currentSite}_${g_currentDate}`;
        const receiptSectionId = `receiptUploadSection_${g_currentSite}_${g_currentDate}`;
        const customInput = document.getElementById(customInputId);
        const receiptSection = document.getElementById(receiptSectionId);
        
        if(e.target.value === 'custom') {
            g_selectedMaterialName = '';
            if(customInput) customInput.style.display = 'block';
            if(receiptSection) receiptSection.style.display = 'none';
        } else if(e.target.value) {
            g_selectedMaterialName = e.target.value;
            if(customInput) customInput.style.display = 'none';
            if(receiptSection) receiptSection.style.display = 'block';
        } else {
            g_selectedMaterialName = '';
            if(customInput) customInput.style.display = 'none';
            if(receiptSection) receiptSection.style.display = 'none';
        }
    }
    
    function confirmCustomMaterial() {
        const valueId = `customMaterialValue_${g_currentSite}_${g_currentDate}`;
        const selectId = `materialSelect_${g_currentSite}_${g_currentDate}`;
        const receiptSectionId = `receiptUploadSection_${g_currentSite}_${g_currentDate}`;
        const customInputId = `customMaterialInput_${g_currentSite}_${g_currentDate}`;
        
        const valueInput = document.getElementById(valueId);
        const value = valueInput?.value.trim();
        
        if(!value) {
            showToast('ìì¬ëª…ì„ ì…ë ¥í•˜ì„¸ìš”');
            return;
        }
        
        g_selectedMaterialName = value;
        g_customMaterialValue = value;
        
        const select = document.getElementById(selectId);
        if(select) {
            const option = document.createElement('option');
            option.value = value;
            option.textContent = value;
            option.selected = true;
            select.appendChild(option);
        }
        
        const customInput = document.getElementById(customInputId);
        const receiptSection = document.getElementById(receiptSectionId);
        if(customInput) customInput.style.display = 'none';
        if(receiptSection) receiptSection.style.display = 'block';
        
        showToast('ìì¬ ì„ íƒ');
    }
    
    function handleCustomReceiptUpload(event) {
        const files = Array.from(event.target.files);
        if(!files || files.length === 0) {
            showToast('íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”');
            const receiptSectionId = `receiptUploadSection_${g_currentSite}_${g_currentDate}`;
            flashInvalid(document.getElementById(receiptSectionId));
            return;
        }
        
        // Initialize receipt files array if not exists
        if (!g_customReceiptFiles) {
            g_customReceiptFiles = [];
        }
        
        const MAX_FILE_SIZE = 10 * 1024 * 1024;
        const validFiles = [];
        
        // Validate each file
        for (const file of files) {
            if(file.size > MAX_FILE_SIZE) {
                showToast(`${file.name} íŒŒì¼ í¬ê¸°ëŠ” 10MB ì´í•˜ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤`);
                continue;
            }
            
            const isValidType = file.type.startsWith('image/') || file.type.includes('pdf');
            if(!isValidType) {
                showToast(`${file.name} ì´ë¯¸ì§€ ë˜ëŠ” PDF íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤`);
                continue;
            }
            
            validFiles.push(file);
        }
        
        if (validFiles.length === 0) {
            event.target.value = '';
            return;
        }
        
        // Process valid files
        let processedCount = 0;
        validFiles.forEach(file => {
            const reader = new FileReader();
            reader.onload = (e) => {
                // Check for duplicates
                const isDuplicate = g_customReceiptFiles.some(existing => existing.name === file.name);
                if (!isDuplicate) {
                    g_customReceiptFiles.push({
                        name: file.name,
                        data: e.target.result,
                        type: file.type,
                        size: file.size
                    });
                }
                
                processedCount++;
                if (processedCount === validFiles.length) {
                    // All files processed, update UI
                    updateReceiptPreview();
                    showToast(`${validFiles.length}ê°œì˜ ì˜ìˆ˜ì¦ì´ ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤`);
                    lucide.createIcons();
                }
            };
            reader.readAsDataURL(file);
        });
        
        // Clear input
        event.target.value = '';
    }
    
    function updateReceiptPreview() {
        const previewId = `customReceiptPreview_${g_currentSite}_${g_currentDate}`;
        const filesListId = `receiptFilesList_${g_currentSite}_${g_currentDate}`;
        const previewEl = document.getElementById(previewId);
        const filesListEl = document.getElementById(filesListId);
        
        if (g_customReceiptFiles && g_customReceiptFiles.length > 0) {
            if(filesListEl) {
                // ê° íŒŒì¼ì„ ê°œë³„ ë¦¬ìŠ¤íŠ¸ë°•ìŠ¤ë¡œ ìƒì„±
                filesListEl.innerHTML = g_customReceiptFiles.map((file, index) => `
                    <div style="display:flex; align-items:center; gap:8px; padding:8px 12px; background:var(--bg-input); border-radius:12px; border:1px solid var(--border);">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" data-lucide="file-text" style="color:var(--primary); flex-shrink:0;">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                            <polyline points="14,2 14,8 20,8"></polyline>
                            <line x1="16" y1="13" x2="8" y2="13"></line>
                            <line x1="16" y1="17" x2="8" y2="17"></line>
                            <polyline points="10,9 9,9 8,9"></polyline>
                        </svg>
                        <span style="font-size:13px; color:var(--text-main); flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;" title="${file.name}">${file.name}</span>
                        <button onclick="removeSingleReceipt(${index})" style="background:none; border:none; cursor:pointer; padding:4px; color:#dc2626; display:flex; align-items:center; justify-content:center; flex-shrink:0;">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" data-lucide="trash-2" style="width:16px; height:16px;" class="lucide lucide-trash-2">
                                <path d="M3 6h18"></path>
                                <path d="M8 6V4h8v2"></path>
                                <path d="M19 6l-1 14H6L5 6"></path>
                                <path d="M10 11v6"></path>
                                <path d="M14 11v6"></path>
                            </svg>
                        </button>
                    </div>
                `).join('');
                
                // Lucide ì•„ì´ì½˜ ë‹¤ì‹œ ë Œë”ë§
                if (typeof lucide !== 'undefined') {
                    setTimeout(() => lucide.createIcons(), 50);
                }
            }
            if(previewEl) previewEl.style.display = 'block';
        } else {
            if(filesListEl) filesListEl.innerHTML = '';
            if(previewEl) previewEl.style.display = 'none';
        }
    }
    
    // ê°œë³„ ì˜ìˆ˜ì¦ ì‚­ì œ
    function removeSingleReceipt(index) {
        g_customReceiptFiles.splice(index, 1);
        updateReceiptPreview();
        showToast('ì˜ìˆ˜ì¦ì´ ì œê±°ë˜ì—ˆìŠµë‹ˆë‹¤');
    }
    
    function removeCustomReceipt() {
        g_customReceiptFiles = [];
        g_customReceiptFile = null;
        const previewId = `customReceiptPreview_${g_currentSite}_${g_currentDate}`;
        const inputId = `customReceiptInput_${g_currentSite}_${g_currentDate}`;
        const previewEl = document.getElementById(previewId);
        const inputEl = document.getElementById(inputId);
        if(previewEl) previewEl.style.display = 'none';
        if(inputEl) inputEl.value = '';
        updateReceiptPreview();
        showToast('ëª¨ë“  ì˜ìˆ˜ì¦ì´ ì œê±°ë˜ì—ˆìŠµë‹ˆë‹¤');
    }
    
    function deleteMaterial(idx) {
        if(!confirm('ì´ ìì¬ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
        g_worklogs[g_currentSite].dailyData[g_currentDate].materials.splice(idx, 1);
        saveData();
        openDetail(g_currentSite, g_currentTab);
        showToast('ìì¬ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
    }
    
    function uploadReceipt(idx) {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = 'image/*,.pdf';
        input.onchange = (e) => {
            const file = e.target.files[0];
            if(!file) {
                showToast('íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”');
                const receiptSectionId = `receiptUploadSection_${g_currentSite}_${g_currentDate}`;
                flashInvalid(document.getElementById(receiptSectionId));
                return;
            }
            
            const reader = new FileReader();
            reader.onload = (ev) => {
                g_worklogs[g_currentSite][g_currentDate].materials[idx].receipt = ev.target.result;
                saveData();
                openDetail(g_currentSite, g_currentDate);
                showToast('ì˜ìˆ˜ì¦ì´ ì²¨ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤.');
            };
            reader.readAsDataURL(file);
        };
        input.click();
    }
    
    function viewReceipt(idx) {
        const receipt = g_worklogs[g_currentSite][g_currentDate].materials[idx].receipt;
        showPreviewModal(receipt, 'ì˜ìˆ˜ì¦', 'image');
    }

    // ========== í™•ì¸ì„œ ê´€ë ¨ í•¨ìˆ˜ ==========
    function openViewer(type, titleText = '') {
        let title = titleText || 'ë¯¸ë¦¬ë³´ê¸°';
        let html = '';

        if(type === 'cert_create') {
            title = "ì‘ì—…ì™„ë£Œ í™•ì¸ì„œ";
            html = `
                <div class="a4-page">
                    <div class="cert-title">ì‘ ì—… ì™„ ë£Œ í™• ì¸ ì„œ</div>
                    <table class="info-table">
                        <tr><th>í˜„ì¥ëª…</th><td>${document.getElementById('dt-site')?.innerText || ''}</td><th>ì¼ì</th><td>2025.12.26</td></tr>
                        <tr><th>ì‘ì—…ë‚´ìš©</th><td colspan="3">${document.getElementById('dt-work')?.innerText || ''}</td></tr>
                    </table>
                    <div style="height:300px; border:1px solid #000; padding:15px; margin-top:10px;">ìƒê¸° í˜„ì¥ì˜ ì‘ì—…ì„ ì™„ë£Œí•˜ì˜€ìŒì„ í™•ì¸í•©ë‹ˆë‹¤.</div>
                    <div class="sign-grid">
                        <div style="display:flex; align-items:center; justify-content:center; font-weight:700;">í™•ì¸ì(ì„œëª…)</div>
                        <div class="sign-box"><canvas id="signCanvas"></canvas></div>
                    </div>
                </div>
            `;
            PreviewModal.open(title, html);
            setTimeout(initSignature, 200);
            return;
        }
        
        if(type === 'cert_view') {
            const data = g_worklogs[g_currentSite].dailyData[g_currentDate];
            const bi = data.baseInfo;
            const confirmDoc = data.assets.confirm;
            
            if(confirmDoc && confirmDoc.url) {
                // ì—…ë¡œë“œëœ í™•ì¸ì„œ í‘œì‹œ
                const viewerHTML = `
                    <div id="confirmViewer" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #1e1e1e; z-index: 10000; display: flex; flex-direction: column; overflow: hidden;">
                        <div style="height: 60px; background: #000; display: flex; align-items: center; justify-content: center; padding: 0 16px; border-bottom: 1px solid #333; flex-shrink: 0; position: relative;">
                            <div style="font-size: 18px; font-weight: 700; color: #fff; position: absolute; left: 50%; transform: translateX(-50%);">${titleText}</div>
                            <div style="position: absolute; right: 16px; display: flex; align-items: center; gap: 8px;">
                                <button onclick="closeConfirmViewer()" style="background: none; border: none; color: #fff; cursor: pointer; padding: 8px; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                    <i data-lucide="x" style="width: 24px; height: 24px;"></i>
                                </button>
                            </div>
                        </div>
                        <div id="confirmViewport" style="flex: 1; overflow: auto; background: #1e1e1e; padding: 20px; display: flex; justify-content: center; align-items: flex-start;">
                            <div id="confirmPaperWrapper" style="width: 100%; max-width: 210mm; background: #ffffff; box-shadow: 0 4px 30px rgba(0,0,0,0.5); box-sizing: border-box;">
                                <div style="width: 210mm; min-height: 297mm; background: #ffffff; color: #000; padding: 15mm; display: flex; flex-direction: column; justify-content: center;">
                                    <img src="${confirmDoc.url}" style="max-width:100%; max-height:100%; object-fit:contain;">
                                </div>
                            </div>
                        </div>
                        <div style="position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: #222; padding: 10px 25px; border-radius: 50px; display: flex; gap: 25px; z-index: 200; backdrop-filter: blur(8px); box-shadow: 0 10px 30px rgba(0,0,0,0.5); border: 1px solid #333;">
                            <button onclick="zoomConfirm('out')" style="background: none; border: none; color: #fff; display: flex; flex-direction: column; align-items: center; gap: 4px; font-size: 10px; cursor: pointer; min-width: 35px; opacity: 0.7; transition: 0.2s;">
                                <i data-lucide="minus" style="width: 24px; height: 24px;"></i>
                                <span>ì¶•ì†Œ</span>
                            </button>
                            <button onclick="toggleConfirmPan()" id="btnConfirmPan" style="background: none; border: none; color: #fff; display: flex; flex-direction: column; align-items: center; gap: 4px; font-size: 10px; cursor: pointer; min-width: 35px; opacity: 0.7; transition: 0.2s;">
                                <i data-lucide="hand" style="width: 24px; height: 24px;"></i>
                                <span>ì´ë™</span>
                            </button>
                            <button onclick="zoomConfirm('in')" style="background: none; border: none; color: #fff; display: flex; flex-direction: column; align-items: center; gap: 4px; font-size: 10px; cursor: pointer; min-width: 35px; opacity: 0.7; transition: 0.2s;">
                                <i data-lucide="plus" style="width: 24px; height: 24px;"></i>
                                <span>í™•ëŒ€</span>
                            </button>
                            <button onclick="shareConfirm()" style="background: none; border: none; color: #fff; display: flex; flex-direction: column; align-items: center; gap: 4px; font-size: 10px; cursor: pointer; min-width: 35px; opacity: 0.7; transition: 0.2s;">
                                <i data-lucide="share-2" style="width: 24px; height: 24px;"></i>
                                <span>ê³µìœ </span>
                            </button>
                        </div>
                    </div>
                `;
                
                // ê¸°ì¡´ ë·°ì–´ê°€ ìˆìœ¼ë©´ ì œê±°
                const existingViewer = document.getElementById('confirmViewer');
                if (existingViewer) {
                    existingViewer.remove();
                }
                
                document.body.insertAdjacentHTML('beforeend', viewerHTML);
                
                // ì•„ì´ì½˜ ë Œë”ë§
                if (typeof lucide !== 'undefined' && lucide.createIcons) {
                    lucide.createIcons();
                }
                
                // ì´ˆê¸°í™”
                confirmZoomScale = 1;
                confirmPanEnabled = false;
                initConfirmViewer();
            } else {
                // ì—…ë¡œë“œëœ íŒŒì¼ì´ ì—†ì„ ë•Œ confirm3.htmlê³¼ ë™ì¼í•œ ì–‘ì‹ì„ ìˆ˜ì • ë¶ˆê°€ëŠ¥í•œ ìƒ˜í”Œë¡œ ë³´ì—¬ì¤Œ
                const sampleHTML = `
                    <div id="confirmViewer" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #1e1e1e; z-index: 10000; display: flex; flex-direction: column; overflow: hidden;">
                        <div style="height: 60px; background: #000; display: flex; align-items: center; justify-content: center; padding: 0 16px; border-bottom: 1px solid #333; flex-shrink: 0; position: relative;">
                            <div style="font-size: 18px; font-weight: 700; color: #fff; position: absolute; left: 50%; transform: translateX(-50%);">${titleText}</div>
                            <div style="position: absolute; right: 16px; display: flex; align-items: center; gap: 8px;">
                                <button onclick="closeConfirmViewer()" style="background: none; border: none; color: #fff; cursor: pointer; padding: 8px; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                    <i data-lucide="x" style="width: 24px; height: 24px;"></i>
                                </button>
                            </div>
                        </div>
                        <div id="confirmViewport" style="flex: 1; overflow: auto; background: #1e1e1e; padding: 20px; display: flex; justify-content: center; align-items: flex-start;">
                            <div id="confirmPaperWrapper" style="width: 100%; max-width: 210mm; background: #ffffff; box-shadow: 0 4px 30px rgba(0,0,0,0.5); box-sizing: border-box;">
                                <div style="width: 210mm; min-height: 297mm; background: #ffffff; color: #000; padding: 15mm; display: flex; flex-direction: column; justify-content: center;">
                                    <header style="text-align: center; margin-bottom: 30px; border-bottom: 3px double #000; padding-bottom: 15px;">
                                        <h1 style="font-size: 36px; font-weight: 900; letter-spacing: 5px; color: #111; margin: 0;">ì‘ ì—… ì™„ ë£Œ í™• ì¸ ì„œ</h1>
                                    </header>
                                    <table style="width: 100%; border-collapse: collapse; border: 2px solid #1e293b; margin-bottom: 20px; table-layout: fixed;">
                                        <colgroup>
                                            <col style="width: 12%;">
                                            <col style="width: 48%;">
                                            <col style="width: 10%;">
                                            <col style="width: 30%;">
                                        </colgroup>
                                        <tr>
                                            <th style="border: 1px solid #1e293b; padding: 8px; vertical-align: middle; background: #f8fafc; font-weight: 800; text-align: center; font-size: 16px; color: #334155;">í˜„ ì¥ ëª…</th>
                                            <td style="border: 1px solid #1e293b; padding: 8px; vertical-align: middle; color: #000; font-weight: 600;">${document.getElementById('dt-site')?.innerText || 'ìì´ ì•„íŒŒíŠ¸ 101ë™'}</td>
                                            <th style="border: 1px solid #1e293b; padding: 8px; vertical-align: middle; background: #f8fafc; font-weight: 800; text-align: center; font-size: 16px; color: #334155;">ì—… ì²´</th>
                                            <td style="border: 1px solid #1e293b; padding: 8px; vertical-align: middle; color: #000; font-weight: 600;">${data.baseInfo?.company || ''}</td>
                                        </tr>
                                        <tr>
                                            <th style="border: 1px solid #1e293b; padding: 8px; vertical-align: middle; background: #f8fafc; font-weight: 800; text-align: center; font-size: 16px; color: #334155;">ê³µ ì‚¬ ëª…</th>
                                            <td style="border: 1px solid #1e293b; padding: 8px; vertical-align: middle; color: #000; font-weight: 600;">${document.getElementById('dt-work')?.innerText || ''}</td>
                                            <th style="border: 1px solid #1e293b; padding: 8px; vertical-align: middle; background: #f8fafc; font-weight: 800; text-align: center; font-size: 16px; color: #334155;">ê³µì‚¬ê¸°ê°„</th>
                                            <td style="border: 1px solid #1e293b; padding: 8px; vertical-align: middle; color: #000; font-weight: 600;">${data.baseInfo?.period || ''}</td>
                                        </tr>
                                    </table>
                                    <div style="padding: 15px; display: flex; flex-direction: column; border: 2px solid #1e293b; margin-bottom: 20px;">
                                        <div style="font-size: 18px; font-weight: 800; color: #1e293b; margin-bottom: 12px; padding-left: 12px; border-left: 5px solid #475569;">ì‘ì—…ë‚´ìš©</div>
                                        <div style="flex:1; line-height:1.6; color: #000; font-weight: 600;">${document.getElementById('dt-work')?.innerText || '* ì§€í•˜ì£¼ì°¨ì¥ PCë¶€ì¬ ê· ì—´ë³´ìˆ˜ ì™„ë£Œ\n* '}</div>
                                    </div>
                                    <div style="padding: 15px; display: flex; flex-direction: column; border: 2px solid #1e293b; margin-bottom: 20px; height: 150px;">
                                        <div style="font-size: 18px; font-weight: 800; color: #1e293b; margin-bottom: 12px; padding-left: 12px; border-left: 5px solid #475569;">íŠ¹ê¸°ì‚¬í•­</div>
                                        <div style="flex:1; color: #000; font-weight: 600;">íŠ¹ì´ì‚¬í•­</div>
                                    </div>
                                    <div style="margin-top: 10px; text-align: center;">
                                        <div style="font-size: 20px; font-weight: 800; margin-bottom: 25px;">ìƒê¸° ì‚¬í•­ê³¼ ê°™ì´ ì‘ì—…ì„ ì™„ë£Œí•˜ì˜€ìŒì„ í™•ì¸í•©ë‹ˆë‹¤.</div>
                                        <div style="font-size: 20px; font-weight: 800; text-align: center; margin-bottom: 30px; color: #000;">${new Date().getFullYear()}ë…„ ${new Date().getMonth()+1}ì›” ${new Date().getDate()}ì¼</div>
                                        <div style="display: grid; grid-template-columns: 33% 27% 40%; border: 2px solid #1e293b; margin-bottom: 20px;">
                                            <div style="background: #f8fafc; border-right: 1px solid #1e293b; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 10px; gap: 8px;">
                                                <span style="font-weight: 800; font-size: 18px; color: #334155;">ì†Œ ì† :</span>
                                                <div style="text-align: center; font-size: 18px; font-weight: 700; width: 100%; color: #000;">(ì£¼)ì´ë…¸í”¼ì•¤ì”¨</div>
                                            </div>
                                            <div style="background: #f8fafc; border-right: 1px solid #1e293b; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 10px; gap: 8px;">
                                                <span style="font-weight: 800; font-size: 18px; color: #334155;">ì„± ëª… :</span>
                                                <div style="text-align: center; font-size: 18px; font-weight: 700; width: 100%; color: #000;">ì‘ì„±ì</div>
                                            </div>
                                            <div style="position: relative; background: #fff; height: 180px; display: flex; flex-direction: column; overflow: hidden;">
                                                <div style="padding: 8px 12px; font-weight: 700; font-size: 14px; color: #64748b; border-bottom: 1px dashed #e2e8f0; text-align: left;">í™•ì¸ì (ì„œëª…)</div>
                                                <div style="flex: 1; width: 100%; height: 100%; position: relative; display: flex; align-items: center; justify-content: center;">
                                                    <div style="color: #94a3b8; font-weight: 700; font-size: 14px; background: rgba(255,255,255,0.8); padding: 4px 8px; border-radius: 4px;">ì„œëª… ì˜ì—­</div>
                                                </div>
                                            </div>
                                        </div>
                                        <div style="margin-top: 40px; display: flex; justify-content: center; align-items: flex-end; gap: 8px; font-weight: 700; height: 80px;">
                                            <div style="text-align: center; font-size: 24px; font-weight: 800; width: 300px; border-bottom: 2px solid #000; height: 60px; padding-top: 20px; padding-bottom: 0; box-sizing: border-box; line-height: 1.4; margin-bottom: 3px; color: #000;">íšŒì‚¬ëª…</div>
                                            <div style="width: 60px; text-align: left; font-size: 20px; font-weight: 700; border: none; background: transparent; margin-bottom: 10px; color: #000;">ê·€ì¤‘</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div style="position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: #222; padding: 10px 25px; border-radius: 50px; display: flex; gap: 25px; z-index: 200; backdrop-filter: blur(8px); box-shadow: 0 10px 30px rgba(0,0,0,0.5); border: 1px solid #333;">
                            <button onclick="zoomConfirm('out')" style="background: none; border: none; color: #fff; display: flex; flex-direction: column; align-items: center; gap: 4px; font-size: 10px; cursor: pointer; min-width: 35px; opacity: 0.7; transition: 0.2s;">
                                <i data-lucide="minus" style="width: 24px; height: 24px;"></i>
                                <span>ì¶•ì†Œ</span>
                            </button>
                            <button onclick="toggleConfirmPan()" id="btnConfirmPan" style="background: none; border: none; color: #fff; display: flex; flex-direction: column; align-items: center; gap: 4px; font-size: 10px; cursor: pointer; min-width: 35px; opacity: 0.7; transition: 0.2s;">
                                <i data-lucide="hand" style="width: 24px; height: 24px;"></i>
                                <span>ì´ë™</span>
                            </button>
                            <button onclick="zoomConfirm('in')" style="background: none; border: none; color: #fff; display: flex; flex-direction: column; align-items: center; gap: 4px; font-size: 10px; cursor: pointer; min-width: 35px; opacity: 0.7; transition: 0.2s;">
                                <i data-lucide="plus" style="width: 24px; height: 24px;"></i>
                                <span>í™•ëŒ€</span>
                            </button>
                            <button onclick="shareConfirm()" style="background: none; border: none; color: #fff; display: flex; flex-direction: column; align-items: center; gap: 4px; font-size: 10px; cursor: pointer; min-width: 35px; opacity: 0.7; transition: 0.2s;">
                                <i data-lucide="share-2" style="width: 24px; height: 24px;"></i>
                                <span>ê³µìœ </span>
                            </button>
                        </div>
                    </div>
                `;
                
                // ê¸°ì¡´ ë·°ì–´ê°€ ìˆìœ¼ë©´ ì œê±°
                const existingViewer = document.getElementById('confirmViewer');
                if (existingViewer) {
                    existingViewer.remove();
                }
                
                document.body.insertAdjacentHTML('beforeend', sampleHTML);
                
                // ì•„ì´ì½˜ ë Œë”ë§
                if (typeof lucide !== 'undefined' && lucide.createIcons) {
                    lucide.createIcons();
                }
                
                // ì´ˆê¸°í™”
                confirmZoomScale = 1;
                confirmPanEnabled = false;
                initConfirmViewer();
            }
            return;
        }

        html = `<div class="a4-page" style="padding:40px; display:flex; align-items:center; justify-content:center; color:#64748b; font-weight:700;">
            ${titleText}<br><span style="font-size:12px; font-weight:400; margin-top:10px;">(ë¬¸ì„œ ë¯¸ë¦¬ë³´ê¸° ì‹œë®¬ë ˆì´ì…˜)</span>
        </div>`;
        PreviewModal.open(title, html);
    }

    function initSignature() {
        const canvas = document.getElementById('signCanvas');
        if(canvas) {
            canvas.width = canvas.parentElement.offsetWidth;
            canvas.height = canvas.parentElement.offsetHeight;
            signaturePad = new SignaturePad(canvas);
        }
    }
    function triggerConfirmUpload() {
        const input = document.getElementById('confirmFileInput_${g_currentSite}_${g_currentDate}');
        if (!input) {
            showToast('ì—…ë¡œë“œ ì…ë ¥ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
            flashInvalid(document.getElementById('detailConfirmSection'));
            return;
        }
        input.value = '';
        input.click();
    }

    function handleConfirmUpload(input) {
        const file = input?.files?.[0];
        if(!file) {
            showToast('íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”');
            flashInvalid(document.getElementById('detailConfirmSection') || document.getElementById('editConfirmSection'));
            return;
        }

        // ì´ë¯¸ì§€ íŒŒì¼ì¸ ê²½ìš° ì••ì¶• ì²˜ë¦¬
        if (file.type.startsWith('image/')) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    let width = img.width;
                    let height = img.height;
                    
                    // ìµœëŒ€ í¬ê¸° ì œí•œ (1280x1280) - ë” ê°•í•œ ì••ì¶•
                    const maxSize = 1280;
                    if (width > maxSize || height > maxSize) {
                        if (width > height) {
                            height = (height / width) * maxSize;
                            width = maxSize;
                        } else {
                            width = (width / height) * maxSize;
                            height = maxSize;
                        }
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    // JPEG ì••ì¶• (í’ˆì§ˆ 0.5) - ë” ê°•í•œ ì••ì¶•
                    const compressedDataUrl = canvas.toDataURL('image/jpeg', 0.5);
                    
                    // í™•ì¸ì„œëŠ” í•œ ê°œë§Œ ìœ ì§€ (ë®ì–´ì“°ê¸°)
                    const site = g_worklogs[g_currentSite];
                    if (!site || !site.dailyData || !site.dailyData[g_currentDate]) {
                        showToast('í˜„ì¥ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                        return;
                    }
                    
                    // assets ê°ì²´ê°€ ì—†ìœ¼ë©´ ìƒì„±
                    if (!site.dailyData[g_currentDate].assets) {
                        site.dailyData[g_currentDate].assets = { photos: [], drawings: [], confirm: null };
                    }
                    
                    const oldConfirm = site.dailyData[g_currentDate].assets.confirm;
                    const version = oldConfirm ? (oldConfirm.version || 1) + 1 : 1;
                    
                    site.dailyData[g_currentDate].assets.confirm = {
                        url: compressedDataUrl,
                        uploadDate: new Date().toISOString().slice(0,10),
                        fileName: file.name,
                        version: version
                    };

                    const versions = site.dailyData[g_currentDate].versions || [];
                    versions.push({
                        ver: versions.length + 1,
                        time: new Date().toISOString(),
                        type: 'confirm',
                        desc: `ì‘ì—…ì™„ë£Œ í™•ì¸ì„œ ì—…ë¡œë“œ (v${version})`
                    });
                    site.dailyData[g_currentDate].versions = versions;

                    saveData();
                    openDetail(g_currentSite, g_currentTab);
                    showToast(`ì‘ì—…ì™„ë£Œ í™•ì¸ì„œê°€ ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤. (v${version})`);
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        } else {
            // PDF íŒŒì¼ì€ ê·¸ëŒ€ë¡œ ì €ì¥ (ì••ì¶• ë¶ˆê°€)
            const reader = new FileReader();
            reader.onload = (ev) => {
                const site = g_worklogs[g_currentSite];
                
                // assets ê°ì²´ê°€ ì—†ìœ¼ë©´ ìƒì„±
                if (!site.dailyData[g_currentDate].assets) {
                    site.dailyData[g_currentDate].assets = { photos: [], drawings: [], confirm: null };
                }
                
                const oldConfirm = site.dailyData[g_currentDate].assets.confirm;
                const version = oldConfirm ? (oldConfirm.version || 1) + 1 : 1;
                
                site.dailyData[g_currentDate].assets.confirm = {
                    url: ev.target.result,
                    uploadDate: new Date().toISOString().slice(0,10),
                    fileName: file.name,
                    version: version
                };

                const versions = site.dailyData[g_currentDate].versions;
                versions.push({
                    ver: versions.length + 1,
                    time: new Date().toISOString(),
                    type: 'confirm',
                    desc: `ì‘ì—…ì™„ë£Œ í™•ì¸ì„œ ì—…ë¡œë“œ (v${version})`
                });

                saveData();
                openDetail(g_currentSite, g_currentTab);
                showToast(`ì‘ì—…ì™„ë£Œ í™•ì¸ì„œê°€ ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤. (v${version})`);
            };
            reader.readAsDataURL(file);
        }
    }
    
    function uploadConfirmFromFile() {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = 'image/*,.pdf';
        input.onchange = (e) => {
            const file = e.target.files[0];
            if(!file) {
                showToast('íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”');
                flashInvalid(document.getElementById('detailConfirmSection') || document.getElementById('editConfirmSection'));
                return;
            }
            
            const reader = new FileReader();
            reader.onload = (ev) => {
                g_worklogs[g_currentSite][g_currentDate].assets.confirm = {
                    url: ev.target.result,
                    uploadDate: new Date().toISOString().slice(0,10),
                    fileName: file.name,
                    uploadedBy: g_worklogs[g_currentSite][g_currentDate].baseInfo?.dept || 'ê´€ë¦¬ì'
                };
                
                const versions = g_worklogs[g_currentSite][g_currentDate].versions;
                versions.push({
                    ver: versions.length + 1,
                    time: new Date().toISOString(),
                    type: 'confirm',
                    desc: 'ì‘ì—…ì™„ë£Œ í™•ì¸ì„œ ì—…ë¡œë“œ'
                });
                
                saveData();
                openDetail(g_currentSite, g_currentTab);
                showToast('ì‘ì—…ì™„ë£Œ í™•ì¸ì„œê°€ ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.');
            };
            reader.readAsDataURL(file);
        };
        input.click();
    }
    
    function viewConfirm() {
        window.open('../ect/@confirm3.html', '_blank');
    }
    
    let confirmZoomScale = 1;
    let confirmPanEnabled = false;
    let confirmPanX = 0;
    let confirmPanY = 0;
    
    function initConfirmViewer() {
        const wrapper = document.getElementById('confirmPaperWrapper');
        const viewport = document.getElementById('confirmViewport');
        
        if (!wrapper || !viewport) return;
        
        // ì´ˆê¸° í™•ëŒ€/ì¶•ì†Œ ì„¤ì •
        wrapper.style.transform = `scale(${confirmZoomScale})`;
        
        // íŒ¨ë‹ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
        let isDragging = false;
        let startX, startY;
        
        viewport.addEventListener('mousedown', (e) => {
            if (!confirmPanEnabled) return;
            isDragging = true;
            startX = e.clientX - confirmPanX;
            startY = e.clientY - confirmPanY;
            viewport.style.cursor = 'grabbing';
        });
        
        viewport.addEventListener('mousemove', (e) => {
            if (!isDragging || !confirmPanEnabled) return;
            confirmPanX = e.clientX - startX;
            confirmPanY = e.clientY - startY;
            wrapper.style.transform = `scale(${confirmZoomScale}) translate(${confirmPanX}px, ${confirmPanY}px)`;
        });
        
        viewport.addEventListener('mouseup', () => {
            isDragging = false;
            if (confirmPanEnabled) viewport.style.cursor = 'grab';
        });
        
        // í„°ì¹˜ ì´ë²¤íŠ¸
        let touchStartX, touchStartY;
        
        viewport.addEventListener('touchstart', (e) => {
            if (!confirmPanEnabled) return;
            const touch = e.touches[0];
            touchStartX = touch.clientX - confirmPanX;
            touchStartY = touch.clientY - confirmPanY;
        });
        
        viewport.addEventListener('touchmove', (e) => {
            if (!confirmPanEnabled) return;
            e.preventDefault();
            const touch = e.touches[0];
            confirmPanX = touch.clientX - touchStartX;
            confirmPanY = touch.clientY - touchStartY;
            wrapper.style.transform = `scale(${confirmZoomScale}) translate(${confirmPanX}px, ${confirmPanY}px)`;
        });
    }
    
    function zoomConfirm(direction) {
        const wrapper = document.getElementById('confirmPaperWrapper');
        
        if (direction === 'in') {
            confirmZoomScale = Math.min(confirmZoomScale + 0.1, 2);
        } else {
            confirmZoomScale = Math.max(confirmZoomScale - 0.1, 0.5);
        }
        
        wrapper.style.transform = `scale(${confirmZoomScale}) translate(${confirmPanX}px, ${confirmPanY}px)`;
        
        // ì•„ì´ì½˜ ì¬ë Œë”ë§
        if (typeof lucide !== 'undefined' && lucide.createIcons) {
            lucide.createIcons();
        }
    }
    
    function toggleConfirmPan() {
        confirmPanEnabled = !confirmPanEnabled;
        const viewport = document.getElementById('confirmViewport');
        const btn = document.getElementById('btnConfirmPan');
        
        if (confirmPanEnabled) {
            viewport.style.cursor = 'grab';
            btn.style.color = '#31a3fa';
            btn.style.opacity = '1';
            btn.style.fontWeight = '700';
        } else {
            viewport.style.cursor = 'default';
            btn.style.color = '#fff';
            btn.style.opacity = '0.7';
            btn.style.fontWeight = 'normal';
        }
        
        // ì•„ì´ì½˜ ì¬ë Œë”ë§
        if (typeof lucide !== 'undefined' && lucide.createIcons) {
            lucide.createIcons();
        }
    }
    
    function shareConfirm() {
        if (navigator.share) {
            navigator.share({
                title: 'ì‘ì—…ì™„ë£Œ í™•ì¸ì„œ',
                text: 'ì‘ì—…ì™„ë£Œ í™•ì¸ì„œë¥¼ ê³µìœ í•©ë‹ˆë‹¤.'
            }).catch(() => {});
        } else {
            alert('ê³µìœ  ê¸°ëŠ¥ì„ ì§€ì›í•˜ì§€ ì•ŠëŠ” í™˜ê²½ì…ë‹ˆë‹¤.');
        }
    }
    
    function closeConfirmViewer() {
        const viewer = document.getElementById('confirmViewer');
        if (viewer) {
            viewer.remove();
        }
        confirmZoomScale = 1;
        confirmPanEnabled = false;
        confirmPanX = 0;
        confirmPanY = 0;
    }
    
    function replaceConfirm() {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '*';
        input.onchange = (e) => {
            const file = e.target.files[0];
            if(!file) return;
            
            const reader = new FileReader();
            reader.onload = (ev) => {
                g_worklogs[g_currentSite][g_currentDate].assets.confirm.url = ev.target.result;
                g_worklogs[g_currentSite][g_currentDate].assets.confirm.uploadDate = new Date().toISOString().slice(0,10);
                g_worklogs[g_currentSite][g_currentDate].assets.confirm.fileName = file.name;
                
                saveData();
                openDetail(g_currentSite, g_currentDate);
                showToast('í™•ì¸ì„œê°€ êµì²´ë˜ì—ˆìŠµë‹ˆë‹¤.');
            };
            reader.readAsDataURL(file);
        };
        input.click();
    }
    
    function deleteConfirm() {
        if(!confirm('ì‘ì—…ì™„ë£Œ í™•ì¸ì„œë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
        
        const site = g_worklogs[g_currentSite];
        if (!site) return;
        
        // ëª¨ë“  ë‚ ì§œì—ì„œ í™•ì¸ì„œë¥¼ ì°¾ì•„ì„œ ì‚­ì œ
        let deleted = false;
        const dailyDates = Object.keys(site.dailyData || {});
        dailyDates.forEach(dateKey => {
            const dayData = site.dailyData[dateKey];
            if (dayData && dayData.assets && dayData.assets.confirm) {
                dayData.assets.confirm = null;
                
                // ë²„ì „ íˆìŠ¤í† ë¦¬ì— ì‚­ì œ ê¸°ë¡
                const versions = dayData.versions || [];
                versions.push({
                    ver: versions.length + 1,
                    time: new Date().toISOString(),
                    type: 'confirm',
                    desc: 'ì‘ì—…ì™„ë£Œ í™•ì¸ì„œ ì‚­ì œ'
                });
                dayData.versions = versions;
                deleted = true;
            }
        });
        
        if (deleted) {
            saveData();
            openDetail(g_currentSite, g_currentTab);
            showToast('í™•ì¸ì„œê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
        } else {
            showToast('ì‚­ì œí•  í™•ì¸ì„œê°€ ì—†ìŠµë‹ˆë‹¤.');
        }
    }

    // ========== ì‚¬ì§„ëŒ€ì§€ ë·°ì–´ ==========
    let photoSheetZoomScale = 1;
    
    function viewPhotoSheet() {
        const data = g_worklogs[g_currentSite][g_currentDate];
        const photos = data.assets.photos || [];
        
        if (photos.length === 0) {
            showToast('ì‚¬ì§„ì´ ì—†ìŠµë‹ˆë‹¤.');
            return;
        }
        
        const photoSheetHTML = `
            <div style="width: 210mm; background: #ffffff; color: #000; padding: 15mm;">
                <div style="text-align: center; margin-bottom: 20px; border-bottom: 2px solid #000; padding-bottom: 10px;">
                    <h1 style="font-size: 28px; font-weight: 900; margin: 0;">ê³µì‚¬ ì‚¬ì§„ëŒ€ì§€</h1>
                    <div style="font-size: 14px; margin-top: 8px; color: #666;">
                        ${data.baseInfo.siteName} Â· ${g_currentDate}
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                    ${photos.map((p, idx) => `
                        <div style="border: 1px solid #ddd; padding: 10px; border-radius: 8px;">
                            <div style="aspect-ratio: 4/3; background: #f5f5f5; border-radius: 4px; overflow: hidden; margin-bottom: 8px;">
                                <img src="${p.url}" style="width: 100%; height: 100%; object-fit: cover;" />
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span style="font-size: 12px; color: #666;">ì‚¬ì§„ ${idx + 1}</span>
                                <span style="font-size: 11px; padding: 3px 8px; border-radius: 4px; background: ${p.status === 'before' ? '#e0f2fe' : '#f1f5f9'}; color: ${p.status === 'before' ? '#0369a1' : '#475569'}; font-weight: 600;">
                                    ${p.status === 'before' ? 'ë³´ìˆ˜ì „' : 'ë³´ìˆ˜í›„'}
                                </span>
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
        
        openPhotoSheetViewer(photoSheetHTML);
    }

    function openPhotoSheetViewer(htmlContent) {
        const existingViewer = document.getElementById('photoSheetViewer');
        if (existingViewer) existingViewer.remove();
        
        const viewerHTML = `
            <div id="photoSheetViewer" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #1e1e1e; z-index: 10000; display: flex; flex-direction: column; overflow: hidden;">
                <div style="height: 60px; background: #000; display: flex; align-items: center; justify-content: space-between; padding: 0 16px; border-bottom: 1px solid #333; flex-shrink: 0;">
                    <div style="font-size: 18px; font-weight: 700; color: #fff;">ì‚¬ì§„ëŒ€ì§€</div>
                    <button onclick="closePhotoSheetViewer()" style="background: none; border: none; color: #fff; cursor: pointer; padding: 8px;">
                        <i data-lucide="x" style="width: 24px; height: 24px;"></i>
                    </button>
                </div>
                <div style="flex: 1; overflow: auto; background: #1e1e1e; padding: 20px; display: flex; justify-content: center; align-items: flex-start;">
                    <div id="photoSheetPaperWrapper" style="width: 100%; max-width: 210mm; background: #ffffff; box-shadow: 0 4px 30px rgba(0,0,0,0.5);">
                        ${htmlContent}
                    </div>
                </div>
                <div style="position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: #222; padding: 10px 25px; border-radius: 50px; display: flex; gap: 25px; z-index: 200; box-shadow: 0 10px 30px rgba(0,0,0,0.5); border: 1px solid #333;">
                    <button onclick="zoomPhotoSheet('out')" style="background: none; border: none; color: #fff; display: flex; flex-direction: column; align-items: center; gap: 4px; font-size: 10px; cursor: pointer; opacity: 0.7;">
                        <i data-lucide="minus" style="width: 24px; height: 24px;"></i>
                        <span>ì¶•ì†Œ</span>
                    </button>
                    <button onclick="zoomPhotoSheet('in')" style="background: none; border: none; color: #fff; display: flex; flex-direction: column; align-items: center; gap: 4px; font-size: 10px; cursor: pointer; opacity: 0.7;">
                        <i data-lucide="plus" style="width: 24px; height: 24px;"></i>
                        <span>í™•ëŒ€</span>
                    </button>
                </div>
            </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', viewerHTML);
        if (typeof lucide !== 'undefined') lucide.createIcons();
    }

    function zoomPhotoSheet(direction) {
        const wrapper = document.getElementById('photoSheetPaperWrapper');
        if (!wrapper) return;
        
        if (direction === 'in') {
            photoSheetZoomScale = Math.min(photoSheetZoomScale + 0.2, 3);
        } else {
            photoSheetZoomScale = Math.max(photoSheetZoomScale - 0.2, 0.5);
        }
        
        wrapper.style.transform = `scale(${photoSheetZoomScale})`;
    }

    function closePhotoSheetViewer() {
        const viewer = document.getElementById('photoSheetViewer');
        if (viewer) viewer.remove();
        photoSheetZoomScale = 1;
    }

    // ========== ë„ë©´ ê°€ë¡œí˜• ë·°ì–´ ==========
    function viewDrawingSheet() {
        const data = g_worklogs[g_currentSite][g_currentDate];
        const drawings = data.assets.drawings || [];
        
        if (drawings.length === 0) {
            showToast('ë„ë©´ì´ ì—†ìŠµë‹ˆë‹¤.');
            return;
        }
        
        openDrawingSheetViewer(drawings);
    }

    function openDrawingSheetViewer(drawings) {
        const existingViewer = document.getElementById('drawingSheetViewer');
        if (existingViewer) existingViewer.remove();
        
        const viewerHTML = `
            <div id="drawingSheetViewer" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #1e1e1e; z-index: 10000; display: flex; flex-direction: column;">
                <div style="height: 60px; background: #000; display: flex; align-items: center; justify-content: space-between; padding: 0 16px; border-bottom: 1px solid #333;">
                    <div style="font-size: 18px; font-weight: 700; color: #fff;">ë„ë©´ ë§ˆí‚¹</div>
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <div style="color: #aaa; font-size: 14px;">
                            <span id="drawingCurrentPage">1</span> / <span id="drawingTotalPages">${drawings.length}</span>
                        </div>
                        <button onclick="closeDrawingSheetViewer()" style="background: none; border: none; color: #fff; cursor: pointer; padding: 8px;">
                            <i data-lucide="x" style="width: 24px; height: 24px;"></i>
                        </button>
                    </div>
                </div>
                <div style="flex: 1; overflow: hidden; background: #1e1e1e; display: flex; justify-content: center; align-items: center;">
                    <div style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; overflow: auto;">
                        <img id="drawingImage" src="${drawings[0].url}" style="max-width: 100%; max-height: 100%; object-fit: contain; transition: transform 0.3s;" />
                    </div>
                </div>
                <div style="position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: #222; padding: 10px 25px; border-radius: 50px; display: flex; gap: 25px; z-index: 200; box-shadow: 0 10px 30px rgba(0,0,0,0.5); border: 1px solid #333;">
                    <button onclick="prevDrawing()" style="background: none; border: none; color: #fff; display: flex; flex-direction: column; align-items: center; gap: 4px; font-size: 10px; cursor: pointer; opacity: 0.7;">
                        <i data-lucide="chevron-left" style="width: 24px; height: 24px;"></i>
                        <span>ì´ì „</span>
                    </button>
                    <button onclick="zoomDrawing('out')" style="background: none; border: none; color: #fff; display: flex; flex-direction: column; align-items: center; gap: 4px; font-size: 10px; cursor: pointer; opacity: 0.7;">
                        <i data-lucide="minus" style="width: 24px; height: 24px;"></i>
                        <span>ì¶•ì†Œ</span>
                    </button>
                    <button onclick="zoomDrawing('in')" style="background: none; border: none; color: #fff; display: flex; flex-direction: column; align-items: center; gap: 4px; font-size: 10px; cursor: pointer; opacity: 0.7;">
                        <i data-lucide="plus" style="width: 24px; height: 24px;"></i>
                        <span>í™•ëŒ€</span>
                    </button>
                    <button onclick="nextDrawing()" style="background: none; border: none; color: #fff; display: flex; flex-direction: column; align-items: center; gap: 4px; font-size: 10px; cursor: pointer; opacity: 0.7;">
                        <i data-lucide="chevron-right" style="width: 24px; height: 24px;"></i>
                        <span>ë‹¤ìŒ</span>
                    </button>
                </div>
            </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', viewerHTML);
        if (typeof lucide !== 'undefined') lucide.createIcons();
        
        window.currentDrawings = drawings;
        window.currentDrawingIndex = 0;
        window.drawingZoomScale = 1;
    }

    function prevDrawing() {
        if (!window.currentDrawings) return;
        window.currentDrawingIndex = Math.max(0, window.currentDrawingIndex - 1);
        updateDrawingDisplay();
    }

    function nextDrawing() {
        if (!window.currentDrawings) return;
        window.currentDrawingIndex = Math.min(window.currentDrawings.length - 1, window.currentDrawingIndex + 1);
        updateDrawingDisplay();
    }

    function updateDrawingDisplay() {
        const img = document.getElementById('drawingImage');
        const currentPage = document.getElementById('drawingCurrentPage');
        
        if (img && window.currentDrawings) {
            img.src = window.currentDrawings[window.currentDrawingIndex].url;
            window.drawingZoomScale = 1;
            img.style.transform = `scale(1)`;
        }
        
        if (currentPage) {
            currentPage.textContent = window.currentDrawingIndex + 1;
        }
    }

    function zoomDrawing(direction) {
        const img = document.getElementById('drawingImage');
        if (!img) return;
        
        if (direction === 'in') {
            window.drawingZoomScale = Math.min(window.drawingZoomScale + 0.2, 3);
        } else {
            window.drawingZoomScale = Math.max(window.drawingZoomScale - 0.2, 0.5);
        }
        
        img.style.transform = `scale(${window.drawingZoomScale})`;
    }

    function closeDrawingSheetViewer() {
        const viewer = document.getElementById('drawingSheetViewer');
        if (viewer) viewer.remove();
        window.currentDrawings = null;
        window.currentDrawingIndex = 0;
        window.drawingZoomScale = 1;
    }

    // ========== ë¯¸ë¦¬ë³´ê¸° ëª¨ë‹¬ ==========
    function showPreviewModal(url, title, type) {
        const content = url && String(url).startsWith('data:application/pdf') ? 
            `<iframe src="${url}" style="width:100%; height:100vh; border:none; border-radius:8px;"></iframe>` :
            `<img src="${url}" style="max-width:100%; max-height:100vh; object-fit:contain; border-radius:8px; box-shadow:0 10px 40px rgba(0,0,0,0.5);">`;
        PreviewModal.open(title, content);
    }

    // Copy Dialog State Management
    let copyState = {
        searchQuery: '',
        showDropdown: false,
        selectedSite: ''
    };

    // Enhanced Copy Search Function (matching main.html)
    function handleCopySiteSearch(value) {
        copyState.searchQuery = value;
        if (!value) {
            copyState.selectedSite = '';
        }
        
        // Show/hide clear button
        const clearBtn = document.getElementById('copyClearBtn');
        if (clearBtn) {
            clearBtn.classList.toggle('hidden', !value);
        }
        
        // Filter options without opening dropdown
        filterCopyOptions(value);
        
        // Prevent dropdown from opening when typing
        copyState.showDropdown = false;
        
        // Always keep list area stable; show "ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤" in-place when no matches
        ensureCopyDialogMinHeight();
    }

    // Toggle dropdown functionality
    function toggleCopySiteDropdown() {
        const searchInput = document.getElementById('copySearchInput');
        if (!copyState.searchQuery.trim()) {
            copyState.showDropdown = !copyState.showDropdown;
            // Show all sites when toggled
            filterCopyOptions('');
        }
    }

    // Clear search input
    function clearCopySearchInput() {
        const searchInput = document.getElementById('copySearchInput');
        if (searchInput) {
            searchInput.value = '';
            copyState.searchQuery = '';
            copyState.selectedSite = '';
            
            // Filter options to show all sites
            filterCopyOptions('');
            
            // Hide clear button
            const clearBtn = document.getElementById('copyClearBtn');
            if (clearBtn) {
                clearBtn.classList.add('hidden');
            }
            
            // Ensure bottom sheet maintains minimum height
            ensureCopyDialogMinHeight();
            
            // IMPORTANT: Do NOT close the dialog when clearing search
            // Only close when user explicitly clicks the X button in header
        }
    }

    // Ensure copy dialog maintains minimum height
    function ensureCopyDialogMinHeight() {
        const listContainer = document.getElementById('copyListContainer');
        if (!listContainer) return;

        // If empty (no search results), show an in-place placeholder (do NOT collapse the bottom sheet)
        if (listContainer.children.length === 0) {
            listContainer.innerHTML = `
                <div style="display:flex; align-items:center; justify-content:center; min-height:200px; padding:24px 12px; color:var(--text-sub); font-size:14px;">
                    ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤
                </div>
            `;
        }
    }

// Original filterCopyOptions function (maintained for compatibility)
    function filterCopyOptions(query) {
        const list = document.getElementById('copyListContainer');
        if (!list) return;

        const q = (query || '').toLowerCase();
        const items = [];
        (copyLogs || []).forEach((log, idx) => {
            const name = (log && log.baseInfo && log.baseInfo.siteName) ? String(log.baseInfo.siteName) : '';
            if (name.toLowerCase().includes(q)) {
                items.push({ log, idx });
            }
        });

        if (items.length === 0) {
            list.innerHTML = `
                <div style="display:flex; align-items:center; justify-content:center; min-height:200px; padding:24px 12px; color:var(--text-sub); font-size:14px;">
                    ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤
                </div>
            `;
            return;
        }

        list.innerHTML = items.map(({ log, idx }) => {
            const wsSummary = (log.workSets && log.workSets.length > 0)
                ? log.workSets
                    .map(ws => [ws.member, ws.process, ws.type].filter(Boolean).join(' '))
                    .filter(Boolean)
                    .slice(0, 2)
                    .join(' / ')
                : (log.baseInfo && log.baseInfo.workSet && log.baseInfo.workSet.detail ? log.baseInfo.workSet.detail : '');

            return `<div class="copy-item" onclick="selectCopyItem(this, ${idx})" style="padding:14px 16px; border-bottom:1px solid var(--border); cursor:pointer; font-size:14px;">
                <div style="font-weight:700; color:var(--text-main); margin-bottom:4px;">${log.baseInfo.siteName}</div>
                <div style="color:var(--text-sub); font-size:13px; line-height:1.4;">${log.baseInfo.workDate} | ${wsSummary}</div>
            </div>`;
        }).join('');
    }

function selectCopyItem(el, idx) {
        document.querySelectorAll('.copy-item').forEach(i => i.classList.remove('selected'));
        el.classList.add('selected');
        document.getElementById('selectedCopyIdx').value = idx;
    }

    function showCopyWorklogDialog() {
        let logs = [];
        Object.keys(g_worklogs).forEach(siteKey => {
            const site = g_worklogs[siteKey];
            // ì‘ì„±ì¤‘(draft) ìƒíƒœì˜ ì‘ì—…ì¼ì§€ë§Œ í‘œì‹œ
            if (site && site.baseInfo && site.baseInfo.status === 'draft') {
                logs.push({ siteKey, ...site });
            }
        });
        
        if(logs.length === 0) { alert('ë³µì‚¬ ê°€ëŠ¥í•œ ì‘ì„±ì¤‘ ì‘ì—…ì¼ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.'); return; }
        logs.sort((a,b) => b.baseInfo.createdDate.localeCompare(a.baseInfo.createdDate));
        copyLogs = logs;
        
        const html = `
            <div style="position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:3000; display:flex; align-items:flex-end; justify-content:center;" id="copyDialog" onclick="if(event.target.id==='copyDialog') document.getElementById('copyDialog').remove();">
                <div style="background:var(--bg-surface); border-radius:16px 16px 0 0; padding:20px; width:100%; max-width:600px; max-height:80vh; display:flex; flex-direction:column;" onclick="event.stopPropagation();">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
                        <h3 style="margin:0; font-size:20px; font-weight:800; color:var(--navy-dark);">ì‘ì—…ì¼ì§€ ë³µì‚¬</h3>
                        <button onclick="document.getElementById('copyDialog').remove()" style="background:none; border:none; color:var(--text-sub); cursor:pointer; padding:4px;">âœ•</button>
                    </div>
                    <div class="relative">
                        <input 
                            type="text"
                            id="copySearchInput"
                            placeholder="í˜„ì¥ ì„ íƒ ë˜ëŠ” ê²€ìƒ‰"
                            class="site-search-optimized w-full h-[54px] bg-bg-input dark:bg-slate-900 border border-border dark:border-slate-600 rounded-xl px-4 text-[17px] font-medium outline-none transition-all placeholder:text-slate-400 dark:placeholder:text-slate-500"
                            style="background: var(--bg-input); border: 1px solid var(--border)"
                            oninput="handleCopySiteSearch(this.value)"
                        />
                        <button onclick="toggleCopySiteDropdown()" class="absolute right-4 top-1/2 -translate-y-1/2 text-slate-400 dark:text-slate-500 hover:text-slate-600 dark:hover:text-slate-300 transition-colors">
                            <i data-lucide="chevron-down" style="width: 20px; height: 20px"></i>
                        </button>
                        <button onclick="clearCopySearchInput()" class="absolute right-12 top-1/2 -translate-y-1/2 text-slate-400 dark:text-slate-500 hover:text-slate-600 dark:hover:text-slate-300 transition-colors hidden" id="copyClearBtn">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <line x1="18" y1="6" x2="6" y2="18"></line>
                                <line x1="6" y1="6" x2="18" y2="18"></line>
                            </svg>
                        </button>
                    </div>
                    <div id="copyListContainer" style="flex:1; overflow-y:auto; border:1px solid var(--border); border-radius:12px; margin-bottom:16px; min-height:200px;">
                        ${logs.map((log, idx) => {
                            const dailyDates = Object.keys(log.dailyData || {});
                            const latestDate = dailyDates[dailyDates.length - 1];
                            return `
                            <div class="copy-item" onclick="selectCopyItem(this, ${idx})" style="padding:14px 16px; border-bottom:1px solid var(--border); cursor:pointer; font-size:14px;">
                                <div style="font-weight:700; color:var(--text-main); margin-bottom:4px;">${log.baseInfo.siteName}</div>
                                <div style="color:var(--text-sub); font-size:13px; line-height:1.4;">${log.baseInfo.dept} | ${latestDate || log.baseInfo.createdDate}</div>
                            </div>
                        `;
                        }).join('')}
                    </div>
                    <input type="hidden" id="selectedCopyIdx" value="">
                    <div style="display:flex; gap:12px;">
                        <button onclick="document.getElementById('copyDialog').remove()" style="flex:1; height:50px; border-radius:12px; border:1px solid var(--border); background:#f1f5f9; color:var(--text-sub); font-weight:700; font-size:16px; cursor:pointer;">ì·¨ì†Œ</button>
                        <button onclick="copyWorklog()" style="flex:1; height:50px; border-radius:12px; border:none; background:var(--header-navy); color:white; font-weight:700; font-size:16px; cursor:pointer;">ë³µì‚¬í•˜ê¸°</button>
                    </div>
                </div>
            </div>
            <style>
                .copy-item:hover { background:var(--bg-body); }
                .copy-item.selected { background:var(--primary-bg); border-left:4px solid var(--primary); }
                @media (max-width: 500px) { #copyDialog { align-items:flex-end; } #copyDialog > div { border-radius:16px 16px 0 0; padding:16px; } }
            </style>
        `;
        document.body.insertAdjacentHTML('beforeend', html);
        
        // Initialize Lucide icons for the copy dialog
        if (typeof lucide !== 'undefined' && lucide.createIcons) {
            setTimeout(() => lucide.createIcons(), 50);
        }
    }
    
    function copyWorklog() {
        const idxVal = document.getElementById('selectedCopyIdx').value;
        if(!idxVal) { alert('ë³µì‚¬í•  ì¼ì§€ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.'); return; }
        const idx = parseInt(idxVal);
        const sourcelog = copyLogs[idx];
        const newDate = new Date().toISOString().slice(0, 10);
        const newSiteKey = `site_copy_${Date.now()}`;
        
        // ë³µì‚¬ëœ ì‘ì—…ì¼ì§€ ìƒì„± (ë§¨ ìƒë‹¨ì— í‘œì‹œë˜ë„ë¡ ìµœì‹  ë‚ ì§œ ì ìš©)
        g_worklogs[newSiteKey] = {
            baseInfo: {
                ...JSON.parse(JSON.stringify(sourcelog.baseInfo)),
                createdDate: newDate,
                status: 'draft',
                rejectReason: null
            },
            dailyData: JSON.parse(JSON.stringify(sourcelog.dailyData || {})),
            status: 'draft'
        };
        
        // í•€ ê³ ì •í•˜ì—¬ ë§¨ ìƒë‹¨ì— í‘œì‹œ
        pinnedLogs.add(newSiteKey);
        
        saveData();
        document.getElementById('copyDialog').remove();
        showToast('ì‘ì—…ì¼ì§€ê°€ ë³µì‚¬ë˜ì–´ ìƒë‹¨ì— í‘œì‹œë©ë‹ˆë‹¤.');
        renderLogs();
        
        // ë³µì‚¬ëœ í•­ëª©ìœ¼ë¡œ ìë™ ì´ë™
        setTimeout(() => {
            const copiedCard = document.getElementById(`log-${newSiteKey}`);
            if (copiedCard) copiedCard.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }, 100);
    }
    
    // ========== PreviewModal ê°ì²´ (í†µí•© ë·°ì–´) ==========
    const PreviewModal = {
        overlay: null,
        viewport: null,
        wrapper: null,
        titleEl: null,
        zoomLevel: 1,
        pointX: 0,
        pointY: 0,
        startX: 0,
        startY: 0,
        isPanning: false,
        panBtn: null,

        init() {
            this.overlay = document.getElementById('pmOverlay');
            this.viewport = document.getElementById('pmViewport');
            this.wrapper = document.getElementById('pmContent');
            this.titleEl = document.getElementById('pmTitle');
            this.panBtn = document.getElementById('pmPanBtn');
            this.setupEvents();
        },

        open(title, content) {
            if (!this.overlay) this.init();
            this.titleEl.innerText = title;
            this.wrapper.innerHTML = content;
            this.resetView();
            this.overlay.classList.add('active');
            setTimeout(() => lucide.createIcons(), 100);
        },

        close() {
            this.overlay.classList.remove('active');
        },

        zoom(delta) {
            this.zoomLevel = Math.max(0.2, this.zoomLevel + delta);
            this.updateTransform();
        },

        resetView() {
            const screenW = window.innerWidth;
            this.zoomLevel = screenW < 800 ? screenW / 850 : 0.7;
            this.pointX = 0;
            this.pointY = 0;
            this.updateTransform();
        },

        togglePan() {
            this.isPanning = !this.isPanning;
            if (this.panBtn) {
                this.panBtn.classList.toggle('active', this.isPanning);
            }
            this.viewport.classList.toggle('panning', this.isPanning);
        },

        updateTransform() {
            if (this.wrapper) {
                this.wrapper.style.transform = `translate(${this.pointX}px, ${this.pointY}px) scale(${this.zoomLevel})`;
            }
        },

        setupEvents() {
            const start = (e) => {
                if (!this.isPanning) return;
                if (e.target.closest('.pm-controls') || ['BUTTON'].includes(e.target.tagName)) return;
                
                e.preventDefault();
                const evt = e.touches ? e.touches[0] : e;
                this.startX = evt.clientX - this.pointX;
                this.startY = evt.clientY - this.pointY;

                document.addEventListener('mousemove', move);
                document.addEventListener('touchmove', move, {passive:false});
                document.addEventListener('mouseup', end);
                document.addEventListener('touchend', end);
            };

            const move = (e) => {
                const evt = e.touches ? e.touches[0] : e;
                this.pointX = evt.clientX - this.startX;
                this.pointY = evt.clientY - this.startY;
                this.updateTransform();
            };

            const end = () => {
                document.removeEventListener('mousemove', move);
                document.removeEventListener('touchmove', move);
                document.removeEventListener('mouseup', end);
                document.removeEventListener('touchend', end);
            };

            this.viewport.addEventListener('mousedown', start);
            this.viewport.addEventListener('touchstart', start, {passive:false});
        },

        async savePDF() {
            this.showLoading(true);
            const fileName = this.titleEl.innerText || 'download';
            
            const oldTransform = this.wrapper.style.transform;
            this.wrapper.style.transform = 'scale(1)';
            this.wrapper.style.margin = '0';

            try {
                const canvas = await html2canvas(this.wrapper, { scale: 2, useCORS: true, backgroundColor: "#ffffff" });
                const imgData = canvas.toDataURL('image/jpeg', 0.9);
                
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('p', 'mm', 'a4');
                
                const imgProps = doc.getImageProperties(imgData);
                const pdfWidth = doc.internal.pageSize.getWidth();
                const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
                
                doc.addImage(imgData, 'JPEG', 0, 0, pdfWidth, pdfHeight);
                doc.save(`${fileName}.pdf`);
                this.showToast("PDF ì €ì¥ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
            } catch (e) {
                console.error(e);
                alert("ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            } finally {
                this.wrapper.style.transform = oldTransform;
                this.showLoading(false);
            }
        },

        async share() {
            if (!navigator.share) {
                alert("ê³µìœ ë¥¼ ì§€ì›í•˜ì§€ ì•ŠëŠ” í™˜ê²½ì…ë‹ˆë‹¤.");
                return;
            }
            this.showLoading(true);
            const oldTransform = this.wrapper.style.transform;
            this.wrapper.style.transform = 'scale(1)';

            try {
                const canvas = await html2canvas(this.wrapper, { scale: 2, useCORS: true });
                canvas.toBlob(async (blob) => {
                    const file = new File([blob], "share.jpg", { type: "image/jpeg" });
                    try {
                        await navigator.share({
                            title: this.titleEl.innerText,
                            files: [file]
                        });
                    } catch (err) {}
                }, 'image/jpeg', 0.9);
            } catch (e) {
                alert("ì´ë¯¸ì§€ ìƒì„± ì‹¤íŒ¨");
            } finally {
                this.wrapper.style.transform = oldTransform;
                this.showLoading(false);
            }
        },

        showLoading(visible) { 
            const loading = document.getElementById('pmLoading');
            if (loading) loading.style.display = visible ? 'flex' : 'none';
        },
        
        showToast(msg) {
            const toast = document.getElementById('pmToast');
            const toastMsg = document.getElementById('pmToastMsg');
            if (toast && toastMsg) {
                toastMsg.innerText = msg;
                toast.classList.add('show');
                setTimeout(() => toast.classList.remove('show'), 2000);
            }
        }
    };

    // íˆ¬ì…ì¸ì› íˆìŠ¤í† ë¦¬ í† ê¸€ í•¨ìˆ˜
    function toggleManpowerHistory() {
        const section = document.getElementById('manpowerHistorySection');
        const chevron = document.getElementById('manpowerChevron');
        const label = document.getElementById('toggleManpowerLabel');
        if (!section || !chevron) return;

        const isOpen = section.dataset.open === 'true';
        if (!isOpen) {
            section.dataset.open = 'true';
            section.style.display = 'block';
            section.style.opacity = '1';
            requestAnimationFrame(() => {
                section.style.maxHeight = section.scrollHeight + 'px';
            });
            chevron.style.transform = 'rotate(180deg)';
            if (label) label.textContent = 'ì ‘ê¸°';
        } else {
            section.dataset.open = 'false';
            section.style.maxHeight = '0px';
            section.style.opacity = '0';
            chevron.style.transform = 'rotate(0deg)';
            if (label) label.textContent = 'í¼ì¹˜ê¸°';
            setTimeout(() => { section.style.display = 'none'; }, 400);
        }
    }

    function toggleWorkHistory() {
        const section = document.getElementById('workHistorySection');
        const chevron = document.getElementById('workHistoryChevron');
        const btn = document.getElementById('toggleWorkHistoryBtn');
        if (!section || !chevron || !btn) return;

        const label = btn.querySelector('span');
        const isOpen = section.dataset.open === 'true';
        if (!isOpen) {
            section.dataset.open = 'true';
            section.style.display = 'block';
            section.style.opacity = '1';
            requestAnimationFrame(() => {
                section.style.maxHeight = section.scrollHeight + 'px';
            });
            chevron.style.transform = 'rotate(180deg)';
            if (label) label.textContent = 'ì ‘ê¸°';
        } else {
            section.dataset.open = 'false';
            section.style.maxHeight = '0px';
            section.style.opacity = '0';
            chevron.style.transform = 'rotate(0deg)';
            if (label) label.textContent = 'í¼ì¹˜ê¸°';
            setTimeout(() => { section.style.display = 'none'; }, 400);
        }
    }

    (function(){
        let bootInitialized = false;
        
        function __bootWorklog(){
            if (bootInitialized) return; // ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€
            bootInitialized = true;
            try { initData(); } catch(e) {}
            try { if (typeof ensureNonEmptyData === 'function') ensureNonEmptyData(); } catch(e) {}
            try { if (typeof ensureStatusSeedData === 'function') ensureStatusSeedData(); } catch(e) {}
            try { if (typeof PreviewModal !== 'undefined' && PreviewModal && typeof PreviewModal.init === 'function') PreviewModal.init(); } catch(e) {}

            // ì¦‰ì‹œ í•„í„° ìƒíƒœ ì„¤ì • ë° ë Œë”ë§
            try {
                currentFilter = 'all';
                const allChip = document.querySelector('.filter-chip.status-all');
                if (allChip) allChip.classList.add('active');
                document.querySelectorAll('.filter-chip').forEach((c) => {
                    if (!c.classList.contains('status-all')) c.classList.remove('active');
                });
            } catch(e) {}

            // ì²« ì§„ì… ì‹œ ë¸Œë¼ìš°ì € ìë™ë³µì› ê²€ìƒ‰ê°’ ì œê±°(ì „ì²´ ëª©ë¡ì´ ë°”ë¡œ ë³´ì´ë„ë¡)
            try {
                const __si = document.getElementById('siteSearchInput');
                if (__si && __si.value) {
                    __si.value = '';
                    siteSearchQuery = '';
                    dropdownQuery = '';
                    if (typeof updateClearButton === 'function') updateClearButton(__si);
                    const __dd = document.getElementById('siteDropdownList');
                    if (__dd) __dd.classList.remove('show');
                }
            } catch(e) {}

            // ë Œë”ë§(ë ˆì´ì•„ì›ƒ ì•ˆì •í™” ìœ„í•´ 2íšŒ)
            try { renderLogs(); } catch(e) {}
            requestAnimationFrame(() => {
                try { renderLogs(); } catch(e) {}
                if (typeof lucide !== 'undefined' && lucide.createIcons) {
                    lucide.createIcons();
                }
            });

            try {
                const params = new URLSearchParams(window.location.search || '');
                const focus = (params.get('focus') || '').trim();
                if (focus) {
                    let siteKey = null;
                    if (g_worklogs && typeof g_worklogs === 'object') {
                        if (g_worklogs[focus]) {
                            siteKey = focus;
                        } else {
                            const keys = Object.keys(g_worklogs);
                            siteKey = keys.find(k => {
                                const sn = g_worklogs[k]?.baseInfo?.siteName || '';
                                return sn && String(sn).includes(focus);
                            }) || null;
                        }
                    }

                    if (siteKey) {
                        try { openDetail(siteKey); } catch(e) {}
                        try {
                            const el = document.getElementById(`log-${siteKey}`);
                            if (el) el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        } catch(e) {}
                    }
                }
            } catch(e) {}
        }

        // DOMContentLoaded ë¯¸ë°œìƒ/ì§€ì—° í™˜ê²½ ëŒ€ì‘
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', __bootWorklog);
        } else {
            __bootWorklog();
        }
        window.addEventListener('load', __bootWorklog, { once: true });
        // BFCache/ë³µê·€ ì‹œì—ë„ ë‹¤ì‹œ ê·¸ë¦¬ê¸°
        window.addEventListener('pageshow', (e) => { if (e && e.persisted) __bootWorklog(); });
    })();

    // ========== ì‚¬ì§„ëŒ€ì§€ í˜ì´ì§€ ìƒì„± í•¨ìˆ˜ (@photo.html ì–‘ì‹ ê¸°ë°˜) ==========
    function generatePhotoSheetPages(photos, siteName, projectName, workSets) {
        if (!photos || photos.length === 0) return '';
        
        // ì‘ì—…ë‚´ìš©ì—ì„œ ë¶€ì¬ëª…, ê³µì •ëª… ì¶”ì¶œ
        const defaultMember = workSets && workSets.length > 0 ? workSets[0].member || '' : '';
        const defaultProcess = workSets && workSets.length > 0 ? (workSets[0].process ? workSets[0].process + ' ë³´ìˆ˜' : '') : '';
        
        let pagesHTML = '';
        const photosPerPage = 6; // í˜ì´ì§€ë‹¹ 6ì¥ (2ì—´ x 3í–‰)
        const totalPages = Math.ceil(photos.length / photosPerPage);
        
        for (let pageIdx = 0; pageIdx < totalPages; pageIdx++) {
            const startIdx = pageIdx * photosPerPage;
            const pagePhotos = photos.slice(startIdx, startIdx + photosPerPage);
            
            // 6ê°œ ìŠ¬ë¡¯ ì±„ìš°ê¸° (ë¹ˆ ìŠ¬ë¡¯ë„ í¬í•¨)
            while (pagePhotos.length < photosPerPage) {
                pagePhotos.push(null);
            }
            
            pagesHTML += `
            <div class="a4-print-layout" style="width: 794px; height: 1123px; background: #fff; color: #000; padding: 30px 40px 25px 40px; font-family: 'Pretendard', sans-serif; box-sizing: border-box; page-break-after: always;">
                <div style="text-align: center; margin-bottom: 8px;">
                    <div style="font-size: 28px; font-weight: 900; letter-spacing: -1px; margin-bottom: 2px; color: #000;">${siteName || 'ê³µì‚¬ ì‚¬ì§„ëŒ€ì§€'}</div>
                    <div style="text-align: right; font-size: 12px; font-weight: 700; color: #000;">(ì£¼)ì´ë…¸í”¼ì•¤ì”¨</div>
                </div>
                
                <table style="width: 100%; border-collapse: collapse; border: 2px solid #333; table-layout: fixed; border-bottom: none; margin-bottom: 0;">
                    <tr>
                        <td style="background: #f1f5f9; font-weight: 700; width: 15%; height: 30px; border: 1px solid #333; text-align: center; color: #000; font-size: 12px;">ê³µì‚¬ëª…</td>
                        <td style="text-align: left; padding-left: 10px; font-weight: 700; border: 1px solid #333; color: #000; font-size: 12px;">${projectName || siteName || ''}</td>
                    </tr>
                </table>
                
                <table style="width: 100%; border-collapse: collapse; border: 2px solid #333; table-layout: fixed;">
                    <colgroup><col style="width:15%"><col style="width:35%"><col style="width:15%"><col style="width:35%"></colgroup>
                    ${[0, 1, 2].map(rowIdx => {
                        const p1 = pagePhotos[rowIdx * 2];
                        const p2 = pagePhotos[rowIdx * 2 + 1];
                        const desc1 = p1 ? (p1.status === 'before' ? 'ë³´ìˆ˜ì „' : 'ë³´ìˆ˜í›„') : 'ë³´ìˆ˜í›„';
                        const desc2 = p2 ? (p2.status === 'before' ? 'ë³´ìˆ˜ì „' : 'ë³´ìˆ˜í›„') : 'ë³´ìˆ˜í›„';
                        const member1 = p1?.member || defaultMember;
                        const member2 = p2?.member || defaultMember;
                        const process1 = p1?.process || defaultProcess;
                        const process2 = p2?.process || defaultProcess;
                        
                        return `
                        <tr>
                            <td colspan="2" style="height: 235px; background: #f1f5f9; border: 1px solid #333; padding: 0; text-align: center; vertical-align: middle; overflow: hidden;">
                                ${p1 ? `<img src="${p1.url}" style="width: 100%; height: 100%; object-fit: cover; display: block;">` : '<div style="color: #cbd5e1; font-size: 30px;">+</div>'}
                            </td>
                            <td colspan="2" style="height: 235px; background: #f1f5f9; border: 1px solid #333; padding: 0; text-align: center; vertical-align: middle; overflow: hidden;">
                                ${p2 ? `<img src="${p2.url}" style="width: 100%; height: 100%; object-fit: cover; display: block;">` : '<div style="color: #cbd5e1; font-size: 30px;">+</div>'}
                            </td>
                        </tr>
                        <tr>
                            <td style="background: #f1f5f9; font-weight: 700; height: 26px; border: 1px solid #333; text-align: center; color: #000; font-size: 12px;">ë¶€ì¬ëª…</td>
                            <td style="border: 1px solid #333; text-align: center; font-size: 12px; font-weight: 500; color: #000;">${member1}</td>
                            <td style="background: #f1f5f9; font-weight: 700; border: 1px solid #333; text-align: center; color: #000; font-size: 12px;">ë¶€ì¬ëª…</td>
                            <td style="border: 1px solid #333; text-align: center; font-size: 12px; font-weight: 500; color: #000;">${member2}</td>
                        </tr>
                        <tr>
                            <td style="background: #f1f5f9; font-weight: 700; height: 26px; border: 1px solid #333; text-align: center; color: #000; font-size: 12px;">ê³µ ì •</td>
                            <td style="border: 1px solid #333; text-align: center; font-size: 12px; font-weight: 500; color: #000;">${process1}</td>
                            <td style="background: #f1f5f9; font-weight: 700; border: 1px solid #333; text-align: center; color: #000; font-size: 12px;">ê³µ ì •</td>
                            <td style="border: 1px solid #333; text-align: center; font-size: 12px; font-weight: 500; color: #000;">${process2}</td>
                        </tr>
                        <tr>
                            <td style="background: #f1f5f9; font-weight: 700; height: 26px; border: 1px solid #333; text-align: center; color: #000; font-size: 12px;">ë‚´ ìš©</td>
                            <td style="border: 1px solid #333; text-align: center; font-size: 12px; font-weight: 800; color: #000; padding: 6px;">${desc1}</td>
                            <td style="background: #f1f5f9; font-weight: 700; border: 1px solid #333; text-align: center; color: #000; font-size: 12px;">ë‚´ ìš©</td>
                            <td style="border: 1px solid #333; text-align: center; font-size: 12px; font-weight: 800; color: #000; padding: 6px;">${desc2}</td>
                        </tr>
                        `;
                    }).join('')}
                </table>
            </div>`;
        }
        
        return pagesHTML;
    }
    
    // ========== ë„ë©´ í˜ì´ì§€ ìƒì„± í•¨ìˆ˜ (A4 ê°€ë¡œí˜•: 1123x794) ==========
    function generateDrawingPages(drawings, siteName) {
        if (!drawings || drawings.length === 0) return '';
        
        let pagesHTML = '';
        const drawingsPerPage = 1; // í˜ì´ì§€ë‹¹ 1ì¥ (ê°€ë¡œí˜• ë„ë©´ ìµœì í™”)
        const totalPages = Math.ceil(drawings.length / drawingsPerPage);
        
        for (let pageIdx = 0; pageIdx < totalPages; pageIdx++) {
            const startIdx = pageIdx * drawingsPerPage;
            const pageDrawings = drawings.slice(startIdx, startIdx + drawingsPerPage);
            
            pagesHTML += `
            <div class="a4-print-layout" style="width: 1123px; height: 794px; background: #fff; color: #000; padding: 18px 22px; font-family: 'Pretendard', sans-serif; box-sizing: border-box; page-break-after: always;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                    <div style="flex: 1;">
                        <div style="font-size: 20px; font-weight: 900; letter-spacing: -1px; color: #000;">ë„ë©´ ê¸°ë¡</div>
                        <div style="font-size: 11px; color: #666; font-weight: 600; margin-top: 1px;">${siteName || ''}</div>
                    </div>
                    <div style="text-align: right; font-size: 11px; font-weight: 700; color: #000;">(ì£¼)ì´ë…¸í”¼ì•¤ì”¨</div>
                </div>
                
                <div style="border-bottom: 2px solid #000; margin-bottom: 8px;"></div>
                
                ${pageDrawings.map((d, idx) => `
                <div style="border: 2px solid #333; border-radius: 4px; overflow: hidden;">
                    <div style="background: #f1f5f9; padding: 5px 10px; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center;">
                        <span style="font-weight: 700; color: #000; font-size: 12px;">ë„ë©´ ${startIdx + idx + 1}</span>
                        <span style="font-size: 9px; padding: 2px 6px; border-radius: 20px; background: ${d.status === 'progress' ? '#dbeafe' : '#f1f5f9'}; color: ${d.status === 'progress' ? '#1d4ed8' : '#475569'}; font-weight: 600;">
                            ${d.status === 'progress' ? 'ì§„í–‰ë„ë©´' : 'ì™„ë£Œë„ë©´'}
                        </span>
                    </div>
                    <div style="height: 650px; display: flex; align-items: center; justify-content: center; background: #fafafa; padding: 8px;">
                        <img src="${d.url}" style="max-width: 100%; max-height: 100%; object-fit: contain;">
                    </div>
                    ${d.name ? `<div style="padding: 4px 10px; background: #f9fafb; border-top: 1px solid #e5e7eb; font-size: 9px; color: #666;">${d.name}</div>` : ''}
                </div>
                `).join('')}
            </div>`;
        }
        
        return pagesHTML;
    }
    
    // ========== ì‘ì—…ì™„ë£Œí™•ì¸ì„œ í˜ì´ì§€ ìƒì„± í•¨ìˆ˜ (A4 ì„¸ë¡œí˜•: 794x1123) ==========
    function generateConfirmPages(confirmData, siteName) {
        if (!confirmData) return '';
        
        // í™•ì¸ì„œê°€ ë°°ì—´ì¸ ê²½ìš°ì™€ ë‹¨ì¼ ê°ì²´ì¸ ê²½ìš° ëª¨ë‘ ì²˜ë¦¬
        const confirms = Array.isArray(confirmData) ? confirmData : [confirmData];
        
        let pagesHTML = '';
        
        confirms.forEach((confirm, idx) => {
            if (!confirm || !confirm.url) return;
            
            pagesHTML += `
            <div class="a4-print-layout" style="width: 794px; height: 1123px; background: #fff; color: #000; padding: 20px 30px; font-family: 'Pretendard', sans-serif; box-sizing: border-box; page-break-after: always;">
                <!-- ì‘ì—…ì™„ë£Œí™•ì¸ì„œ ì–‘ì‹ -->
                <div style="border: 2px solid #333; height: 100%; display: flex; flex-direction: column;">
                    <!-- í—¤ë” -->
                    <div style="text-align: center; padding: 15px 0; border-bottom: 2px solid #333;">
                        <div style="font-size: 24px; font-weight: 900; margin-bottom: 5px; color: #000;">ì‘ì—…ì™„ë£Œ í™•ì¸ì„œ</div>
                        <div style="font-size: 14px; color: #333; font-weight: 600;">${siteName || ''}</div>
                    </div>
                    
                    <!-- ê¸°ë³¸ ì •ë³´ -->
                    <div style="padding: 15px; border-bottom: 1px solid #333;">
                        <table style="width: 100%; border-collapse: collapse;">
                            <tr>
                                <td style="width: 20%; border: 1px solid #333; padding: 8px; text-align: center; font-weight: 700; background: #f1f5f9; font-size: 12px;">í˜„ì¥ëª…</td>
                                <td style="width: 30%; border: 1px solid #333; padding: 8px; font-size: 12px;">${siteName || ''}</td>
                                <td style="width: 20%; border: 1px solid #333; padding: 8px; text-align: center; font-weight: 700; background: #f1f5f9; font-size: 12px;">ì‘ì„±ì¼</td>
                                <td style="width: 30%; border: 1px solid #333; padding: 8px; font-size: 12px;">${confirm.uploadDate || new Date().toISOString().slice(0, 10)}</td>
                            </tr>
                            <tr>
                                <td style="border: 1px solid #333; padding: 8px; text-align: center; font-weight: 700; background: #f1f5f9; font-size: 12px;">ì‘ì„±ì</td>
                                <td style="border: 1px solid #333; padding: 8px; font-size: 12px;">(ì£¼)ì´ë…¸í”¼ì•¤ì”¨</td>
                                <td style="border: 1px solid #333; padding: 8px; text-align: center; font-weight: 700; background: #f1f5f9; font-size: 12px;">í™•ì¸ë²ˆí˜¸</td>
                                <td style="border: 1px solid #333; padding: 8px; font-size: 12px;">WR-${new Date().toISOString().slice(0, 10).replace(/-/g, '')}-${Math.floor(Math.random() * 1000)}</td>
                            </tr>
                        </table>
                    </div>
                    
                    <!-- ì‘ì—… ë‚´ìš© -->
                    <div style="padding: 15px; border-bottom: 1px solid #333;">
                        <div style="font-size: 14px; font-weight: 700; margin-bottom: 10px; color: #000;">ì‘ì—… ë‚´ìš©</div>
                        <div style="border: 1px solid #333; height: 120px; padding: 10px; font-size: 12px; line-height: 1.6;">
                            í˜„ì¥ ë³´ìˆ˜ ì‘ì—…ì´ ì™„ë£Œë˜ì—ˆìŒì„ í™•ì¸í•©ë‹ˆë‹¤. ëª¨ë“  ì‘ì—…ì€ ê³„íšëœ ëŒ€ë¡œ ìˆ˜í–‰ë˜ì—ˆìœ¼ë©°, í’ˆì§ˆ ê¸°ì¤€ì— ë¶€í•©í•©ë‹ˆë‹¤.
                        </div>
                    </div>
                    
                    <!-- í™•ì¸ì„œ ì´ë¯¸ì§€ -->
                    <div style="padding: 15px; border-bottom: 1px solid #333; flex: 1;">
                        <div style="font-size: 14px; font-weight: 700; margin-bottom: 10px; color: #000;">í™•ì¸ì„œ ì´ë¯¸ì§€</div>
                        <div style="border: 1px solid #333; height: 380px; display: flex; align-items: center; justify-content: center; background: #fafafa;">
                            <img src="${confirm.url}" style="max-width: 100%; max-height: 100%; object-fit: contain;">
                        </div>
                    </div>
                    
                    <!-- í™•ì¸ë€ -->
                    <div style="padding: 15px;">
                        <table style="width: 100%; border-collapse: collapse;">
                            <tr>
                                <td style="width: 50%; border: 1px solid #333; padding: 15px; text-align: center; vertical-align: top;">
                                    <div style="font-size: 12px; font-weight: 700; margin-bottom: 30px; color: #000;">ì‘ì„±ì í™•ì¸</div>
                                    <div style="height: 40px; border-bottom: 1px solid #333; margin-bottom: 5px;"></div>
                                    <div style="font-size: 11px; color: #666;">(ì£¼)ì´ë…¸í”¼ì•¤ì”¨</div>
                                </td>
                                <td style="width: 50%; border: 1px solid #333; padding: 15px; text-align: center; vertical-align: top;">
                                    <div style="font-size: 12px; font-weight: 700; margin-bottom: 30px; color: #000;">ìŠ¹ì¸ì í™•ì¸</div>
                                    <div style="height: 40px; border-bottom: 1px solid #333; margin-bottom: 5px;"></div>
                                    <div style="font-size: 11px; color: #666;">ë‹´ë‹¹ì</div>
                                </td>
                            </tr>
                        </table>
                    </div>
                </div>
            </div>`;
        });
        
        return pagesHTML;
    }

    // ë³´ê³ ì„œ ë³´ê¸° ê¸°ëŠ¥ (ì „ì—­ í•¨ìˆ˜ë¡œ ì´ë™) - ì‚¬ì§„ëŒ€ì§€/ë„ë©´/í™•ì¸ì„œ í†µí•© ë²„ì „
    window.openReportPreview = function() {
        if (!g_currentSite) return;
        
        const site = (g_worklogs || {})[g_currentSite];
        if (!site || !site.baseInfo) return;
        
        const bi = site.baseInfo;
        const dailyDates = Object.keys(site.dailyData || {}).sort();
        
        // ëª¨ë“  ë‚ ì§œì˜ ë°ì´í„° ìˆ˜ì§‘ (ë°©ì–´ì  í”„ë¡œê·¸ë˜ë°)
        let allWorkSets = [];
        let allManpower = [];
        let allMaterials = [];
        let allPhotos = [];
        let allDrawings = [];
        let allConfirms = [];
        
        dailyDates.forEach(dateKey => {
            const dayData = (site.dailyData || {})[dateKey];
            if (!dayData) return;
            
            allWorkSets = allWorkSets.concat(dayData.workSets || []);
            allManpower = allManpower.concat(dayData.manpower || []);
            allMaterials = allMaterials.concat(dayData.materials || []);
            if (dayData.assets) {
                allPhotos = allPhotos.concat(dayData.assets.photos || []);
                allDrawings = allDrawings.concat(dayData.assets.drawings || []);
                if (dayData.assets.confirm) {
                    allConfirms.push(dayData.assets.confirm);
                }
            }
        });
        
        // ì‘ì—… ë‚´ìš© ìš”ì•½
        const workSummary = [];
        if (allWorkSets.length > 0) {
            const uniqueMembers = [...new Set(allWorkSets.map(w => w?.member).filter(Boolean))];
            const uniqueProcesses = [...new Set(allWorkSets.map(w => w?.process).filter(Boolean))];
            const uniqueTypes = [...new Set(allWorkSets.map(w => w?.type).filter(Boolean))];
            
            if (uniqueMembers.length > 0) workSummary.push(`ë¶€ì¬ëª…: ${uniqueMembers.join(', ')}`);
            if (uniqueProcesses.length > 0) workSummary.push(`ê³µì •: ${uniqueProcesses.join(', ')}`);
            if (uniqueTypes.length > 0) workSummary.push(`ìœ„ì¹˜: ${uniqueTypes.join(', ')}`);
        }
        
        // ì´ ê³µìˆ˜ ê³„ì‚°
        const totalWorkers = new Set(allManpower.flatMap(m => (m?.workers || []).map(w => w?.name || ''))).size;
        const totalHours = allManpower.reduce((sum, m) => 
            sum + (m?.workers || []).reduce((s, w) => s + Number(w?.hours || 0), 0), 0);
        const workDays = dailyDates.length;
        
        // ========== 1. í˜„ì¥ê¸°ë¡ë³´ê³ ì„œ ë©”ì¸ í˜ì´ì§€ ==========
        const mainReportHTML = `
        <div class="a4-print-layout" style="width: 794px; min-height: 1123px; background: #fff; color: #000; padding: 50px; font-family: 'Pretendard', sans-serif; box-sizing: border-box; page-break-after: always;">
            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px;">
                <div style="flex: 1;">
                    <h1 style="font-size: 26px; font-weight: 900; margin: 0; text-align: left;">í˜„ì¥ê¸°ë¡ë³´ê³ ì„œ</h1>
                    <div style="display: flex; justify-content: flex-start; gap: 15px; margin-top: 10px; font-size: 12px; color: #444; font-weight: 600;">
                        <span>ë¬¸ì„œë²ˆí˜¸: WR-${(bi?.createdDate || '').replace(/-/g,'')}-${g_currentSite}</span>
                        <span>ì¶œë ¥ì¼: ${new Date().toLocaleDateString()}</span>
                    </div>
                </div>
                <table style="width: 180px; margin: 0; border-collapse: collapse; font-size: 11px;">
                    <tr><th style="border: 1px solid #444; background: #e5e7eb; padding: 5px 0; font-weight: 700; width: 50%;">ì‘ ì„±</th><th style="border: 1px solid #444; background: #e5e7eb; padding: 5px 0; font-weight: 700; width: 50%;">ìŠ¹ ì¸</th></tr>
                    <tr>
                        <td style="border: 1px solid #444; height: 60px; text-align: center; vertical-align: middle;">
                            <div style="position: relative; z-index: 1;">(ì£¼)ì´ë…¸í”¼ì•¤ì”¨<br>(ì¸)</div>
                        </td>
                        <td style="border: 1px solid #444; height: 60px; text-align: center; vertical-align: middle;"><br>(ì¸)</td>
                    </tr>
                </table>
            </div>
            
            <div style="border-bottom: 2px solid #000; margin-bottom: 20px;"></div>
            
            <div style="font-size: 15px; font-weight: 800; margin: 15px 0 8px 0; border-left: 4px solid #374151; padding-left: 8px; color: #111;">1. ê¸°ë³¸ ì •ë³´</div>
            <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px; font-size: 12px;">
                <tr><th style="border: 1px solid #444; background: #e5e7eb; padding: 12px 8px; font-weight: 700; text-align: center; width: 20%;">í˜„ì¥ëª…</th><td style="border: 1px solid #444; padding: 12px 8px;">${bi?.siteName || '-'}</td></tr>
                <tr><th style="border: 1px solid #444; background: #e5e7eb; padding: 12px 8px; font-weight: 700; text-align: center;">ì‘ì—…ê¸°ê°„</th><td style="border: 1px solid #444; padding: 12px 8px;">${dailyDates[0] || '-'} ~ ${dailyDates[dailyDates.length - 1] || '-'} (${workDays}ì¼)</td></tr>
                <tr><th style="border: 1px solid #444; background: #e5e7eb; padding: 12px 8px; font-weight: 700; text-align: center;">ì†Œì†</th><td style="border: 1px solid #444; padding: 12px 8px;">${bi?.dept || '-'}</td></tr>
                <tr><th style="border: 1px solid #444; background: #e5e7eb; padding: 12px 8px; font-weight: 700; text-align: center;">ì´ íˆ¬ì…ì¸ì›</th><td style="border: 1px solid #444; padding: 12px 8px;">${totalWorkers}ëª… (${totalHours.toFixed(1)}ê³µìˆ˜)</td></tr>
                <tr><th style="border: 1px solid #444; background: #e5e7eb; padding: 12px 8px; font-weight: 700; text-align: center;">ì‘ì„±</th><td style="border: 1px solid #444; padding: 12px 8px;">(ì£¼)ì´ë…¸í”¼ì•¤ì”¨</td></tr>
            </table>
            
            <div style="font-size: 15px; font-weight: 800; margin: 15px 0 8px 0; border-left: 4px solid #374151; padding-left: 8px; color: #111;">2. ì‘ì—… ë‚´ìš©</div>
            <div style="margin-bottom: 20px; line-height: 1.6; font-size: 13px;">
                ${workSummary.length > 0 ? workSummary.map(item => `<div style="margin-bottom: 5px;">- ${item}</div>`).join('') : '<div>- ì‘ì—… ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.</div>'}
            </div>
            
            ${allMaterials && allMaterials.length > 0 ? `
            <div style="font-size: 15px; font-weight: 800; margin: 15px 0 8px 0; border-left: 4px solid #374151; padding-left: 8px; color: #111;">3. ì‚¬ìš© ìì¬</div>
            <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px; font-size: 12px;">
                <tr><th style="border: 1px solid #444; background: #e5e7eb; padding: 12px 8px; font-weight: 700; text-align: center;">ìì¬ëª…</th><th style="border: 1px solid #444; background: #e5e7eb; padding: 12px 8px; font-weight: 700; text-align: center;">ìˆ˜ëŸ‰</th></tr>
                ${allMaterials.map(m => `<tr><td style="border: 1px solid #444; padding: 12px 8px;">${m.worker || m.name || '-'}</td><td style="border: 1px solid #444; padding: 12px 8px; text-align: center;">${m.quantity || '-'}${m.unit || ''}</td></tr>`).join('')}
            </table>
            ` : ''}
            
            <div style="font-size: 15px; font-weight: 800; margin: 15px 0 8px 0; border-left: 4px solid #374151; padding-left: 8px; color: #111;">4. ì²¨ë¶€ ë¬¸ì„œ í˜„í™©</div>
            <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px; font-size: 12px;">
                <tr>
                    <th style="border: 1px solid #444; background: #e5e7eb; padding: 12px 8px; font-weight: 700; text-align: center;">êµ¬ë¶„</th>
                    <th style="border: 1px solid #444; background: #e5e7eb; padding: 12px 8px; font-weight: 700; text-align: center;">ìˆ˜ëŸ‰</th>
                    <th style="border: 1px solid #444; background: #e5e7eb; padding: 12px 8px; font-weight: 700; text-align: center;">ë¹„ê³ </th>
                </tr>
                <tr>
                    <td style="border: 1px solid #444; padding: 12px 8px; text-align: center;">ì‚¬ì§„ëŒ€ì§€</td>
                    <td style="border: 1px solid #444; padding: 12px 8px; text-align: center;">${allPhotos.length}ì¥ (${Math.ceil(allPhotos.length / 6)}í˜ì´ì§€)</td>
                    <td style="border: 1px solid #444; padding: 12px 8px; text-align: center;">${allPhotos.length > 0 ? 'ë³„ì²¨' : '-'}</td>
                </tr>
                <tr>
                    <td style="border: 1px solid #444; padding: 12px 8px; text-align: center;">ë„ë©´</td>
                    <td style="border: 1px solid #444; padding: 12px 8px; text-align: center;">${allDrawings.length}ì¥ (${Math.ceil(allDrawings.length / 2)}í˜ì´ì§€)</td>
                    <td style="border: 1px solid #444; padding: 12px 8px; text-align: center;">${allDrawings.length > 0 ? 'ë³„ì²¨' : '-'}</td>
                </tr>
                <tr>
                    <td style="border: 1px solid #444; padding: 12px 8px; text-align: center;">ì‘ì—…ì™„ë£Œí™•ì¸ì„œ</td>
                    <td style="border: 1px solid #444; padding: 12px 8px; text-align: center;">${allConfirms.length}ê±´</td>
                    <td style="border: 1px solid #444; padding: 12px 8px; text-align: center;">${allConfirms.length > 0 ? 'ë³„ì²¨' : '-'}</td>
                </tr>
            </table>
        </div>`;
        
        // ========== 2. ì‚¬ì§„ëŒ€ì§€ í˜ì´ì§€ ìƒì„± (@photo.html ì–‘ì‹) ==========
        const photoSheetPages = generatePhotoSheetPages(allPhotos, bi?.siteName, bi?.siteName, allWorkSets);
        
        // ========== 3. ë„ë©´ í˜ì´ì§€ ìƒì„± ==========
        const drawingPages = generateDrawingPages(allDrawings, bi?.siteName);
        
        // ========== 4. ì‘ì—…ì™„ë£Œí™•ì¸ì„œ í˜ì´ì§€ ìƒì„± ==========
        const confirmPages = generateConfirmPages(allConfirms, bi?.siteName);
        
        // ========== ëª¨ë“  í˜ì´ì§€ í†µí•© ==========
        const fullReportHTML = mainReportHTML + photoSheetPages + drawingPages + confirmPages;
        
        // PreviewModalì„ ì‚¬ìš©í•˜ì—¬ ë³´ê³ ì„œ í‘œì‹œ
        PreviewModal.open('í˜„ì¥ê¸°ë¡ë³´ê³ ì„œ', fullReportHTML);
    };
    
    // ========== ìƒˆë¡œìš´ í•¨ìˆ˜ë“¤ ==========
    
    // ì‘ì—…ì¼ì§€ ì¶”ê°€ ëª¨ë‹¬ ê´€ë ¨ ë³€ìˆ˜
    let selectedMember = '';
    let selectedProcess = '';
    let selectedType = '';
    let modalManpowerList = []; // ì „ì—­ ë³€ìˆ˜ ì„ ì–¸ ì¶”ê°€
    
    // @main.htmlê³¼ ë™ì¼í•œ ìƒìˆ˜ ì •ì˜
    const PREDEFINED_WORKERS = ['ì´í˜„ìˆ˜', 'ê¹€ì² ìˆ˜', 'ë°•ì˜í¬', 'ì •ë¯¼ìˆ˜', 'ìµœì§€ì˜'];
    // const MEMBER_CHIPS = ['ìŠ¬ë¼ë¸Œ', 'ê±°ë”', 'ê¸°ë‘¥', 'ê¸°íƒ€']; // ì´ë¯¸ HTMLì— í•˜ë“œì½”ë”© ë˜ì–´ ìˆì–´ ì£¼ì„ ì²˜ë¦¬
    // const PROCESS_CHIPS = ['ê· ì—´', 'ë©´', 'ë§ˆê°', 'ê¸°íƒ€']; // ì´ë¯¸ HTMLì— í•˜ë“œì½”ë”© ë˜ì–´ ìˆì–´ ì£¼ì„ ì²˜ë¦¬
    // const TYPE_CHIPS = ['ì§€í•˜', 'ì§€ìƒ', 'ì§€ë¶•', 'ê¸°íƒ€']; // ì´ë¯¸ HTMLì— í•˜ë“œì½”ë”© ë˜ì–´ ìˆì–´ ì£¼ì„ ì²˜ë¦¬

    function openAddWorklogModal() {
        // ìˆ˜ì • ëª¨ë“œê°€ ì•„ë‹ ë•Œë§Œ ì´ˆê¸°í™” ì§„í–‰
        if (!g_isEditMode) {
            // ìˆ˜ì • ëª¨ë“œ ìƒíƒœ ì´ˆê¸°í™” (ì¶”ê°€ ëª¨ë“œë¡œ ì „í™˜)
            g_editSourceDate = null;
            g_isEditMode = false;
            
            // ì˜¤ëŠ˜ ë‚ ì§œ ìë™ ì„¤ì •
            const today = new Date().toISOString().slice(0, 10);
            
            // modalManpowerListê°€ ë¹„ì–´ìˆì„ ë•Œë§Œ ì´ˆê¸°í™”
            if (!modalManpowerList || modalManpowerList.length === 0) {
                // @main.htmlì˜ ìµœì‹  ì…ë ¥ ìƒíƒœë¥¼ ê°€ì ¸ì™€ ê¸°ë³¸ ì‘ì—…ì ì„¤ì •
                try {
                    const savedMain = localStorage.getItem('inopnc_work_log');
                    if (savedMain) {
                        const parsed = JSON.parse(savedMain);
                        // ë©”ì¸ í˜ì´ì§€ì˜ manpowerList êµ¬ì¡°ë¥¼ ê·¸ëŒ€ë¡œ ë³µì‚¬
                        modalManpowerList = parsed.manpowerList.map(m => ({
                            ...m,
                            id: Date.now() + Math.random() // ê³ ìœ  ID ì¬ìƒì„±
                        }));
                    } else {
                        // ê¸°ë³¸ê°’ (ë©”ì¸ê³¼ ë™ì¼í•œ í˜•ì‹)
                        modalManpowerList = [{ id: Date.now(), worker: '', workHours: 1.0, isCustom: false, locked: false }];
                    }
                } catch (e) {
                    modalManpowerList = [{ id: Date.now(), worker: '', workHours: 1.0, isCustom: false, locked: false }];
                }
            }
        }
        
        console.log('openAddWorklogModal - modalManpowerList:', modalManpowerList);
        
        const html = `
            <div style="position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:3000; display:flex; align-items:flex-end; justify-content:center;" id="addWorklogDialog" onclick="if(event.target.id==='addWorklogDialog') document.getElementById('addWorklogDialog').remove();">
                <div style="background:var(--bg-surface); border-radius:20px 20px 0 0; padding:0; width:100%; max-width:600px; max-height:90vh; overflow-y:auto; display:flex; flex-direction:column;" onclick="event.stopPropagation();">
                    <div style="padding:20px; border-bottom:1px solid var(--border);">
                        <div style="display:flex; align-items:center; justify-content:space-between;">
                            <h3 style="font-size:20px; font-weight:800; color:var(--text-main);">${g_isEditMode ? 'í˜„ì¥ê¸°ë¡ìˆ˜ì •' : 'í˜„ì¥ê¸°ë¡ì…ë ¥'}</h3>
                            <button onclick="document.getElementById('addWorklogDialog').remove()" style="background:none; border:none; cursor:pointer; padding:4px; color:var(--text-sub);">
                                <i data-lucide="x" style="width:24px;"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div style="padding:20px;">
                        <!-- ì‘ì—…ì¼ì -->
                        <div style="margin-bottom:20px;">
                            <input type="date" id="newWorklogDate" style="width:100%; height:54px; background:var(--bg-input); border:1px solid var(--border); border-radius:12px; padding:0 16px; font-size:17px; font-weight:500; outline:none;" />
                        </div>
                        
                        <!-- íˆ¬ì…ì¸ì› -->
                        <div style="background:var(--bg-surface); border-radius:16px; padding:20px; margin-bottom:16px; box-shadow:0 1px 3px rgba(0,0,0,0.1); border:1px solid var(--border);">
                            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                                <label style="display:block; font-size:17px; font-weight:700; color:var(--text-sub);">
                                    íˆ¬ì… ì¸ì›(ê³µìˆ˜) <span style="color: var(--danger)">*</span>
                                </label>
                                <button onclick="window.addManpowerToModal()" style="background:var(--primary-bg); color:var(--primary); height:32px; padding:0 14px; border-radius:12px; font-size:13px; font-weight:700; display:flex; align-items:center; gap:4px; border:none; cursor:pointer;">
                                    <span style="font-size:18px; font-weight:900;">+</span> ì¶”ê°€
                                </button>
                            </div>
                            <div id="modalManpowerList" style="display:flex; flex-direction:column; gap:10px;">
                                <!-- íˆ¬ì…ì¸ì› ëª©ë¡ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤ -->
                            </div>
                        </div>
                        
                        <!-- ì‘ì—…ë‚´ìš© -->
                        <div style="background:var(--bg-surface); border-radius:16px; padding:20px; margin-bottom:16px; box-shadow:0 1px 3px rgba(0,0,0,0.1); border:1px solid var(--border);">
                            
                            <!-- ë¶€ì¬ëª… -->
                            <div style="margin-bottom:16px;">
                                <label style="display:block; font-size:17px; font-weight:700; color:var(--text-sub); margin-bottom:8px;">ë¶€ì¬ëª… <span style="color:var(--danger);">*</span></label>
                                <div style="display:grid; grid-template-columns:repeat(4, 1fr); gap:8px; margin-bottom:8px;">
                                    <button onclick="window.selectMemberChip(this, 'ìŠ¬ë¼ë¸Œ')" class="member-chip" style="height:54px; border-radius:12px; border:1px solid var(--border); font-size:17px; font-weight:500; transition:all 0.2s; background:var(--bg-input); color:var(--text-sub); cursor:pointer;">
                                        ìŠ¬ë¼ë¸Œ
                                    </button>
                                    <button onclick="window.selectMemberChip(this, 'ê±°ë”')" class="member-chip" style="height:54px; border-radius:12px; border:1px solid var(--border); font-size:17px; font-weight:500; transition:all 0.2s; background:var(--bg-input); color:var(--text-sub); cursor:pointer;">
                                        ê±°ë”
                                    </button>
                                    <button onclick="window.selectMemberChip(this, 'ê¸°ë‘¥')" class="member-chip" style="height:54px; border-radius:12px; border:1px solid var(--border); font-size:17px; font-weight:500; transition:all 0.2s; background:var(--bg-input); color:var(--text-sub); cursor:pointer;">
                                        ê¸°ë‘¥
                                    </button>
                                    <button onclick="window.selectMemberChip(this, 'ê¸°íƒ€')" class="member-chip" style="height:54px; border-radius:12px; border:1px solid var(--border); font-size:17px; font-weight:500; transition:all 0.2s; background:var(--bg-input); color:var(--text-sub); cursor:pointer;">
                                        ê¸°íƒ€
                                    </button>
                                </div>
                                <input type="text" id="customMember" placeholder="ê¸°íƒ€ ì…ë ¥" style="width:100%; height:48px; background:var(--bg-input); border:1px solid var(--border); border-radius:12px; padding:0 16px; font-size:15px; outline:none; transition:all 0.2s;" onfocus="this.style.borderColor='var(--primary)'; this.style.boxShadow='0 0 0 3px rgba(14,165,233,0.1)';" onblur="this.style.borderColor='var(--border)'; this.style.boxShadow='none';" />
                            </div>
                            
                            <!-- ì‘ì—…ê³µì • -->
                            <div style="margin-bottom:16px;">
                                <label style="display:block; font-size:17px; font-weight:700; color:var(--text-sub); margin-bottom:8px;">ì‘ì—…ê³µì • <span style="color:var(--danger);">*</span></label>
                                <div style="display:grid; grid-template-columns:repeat(4, 1fr); gap:8px; margin-bottom:8px;">
                                    <button onclick="window.selectProcessChip(this, 'ê· ì—´')" class="process-chip" style="height:54px; border-radius:12px; border:1px solid var(--border); font-size:17px; font-weight:500; transition:all 0.2s; background:var(--bg-input); color:var(--text-sub); cursor:pointer;">
                                        ê· ì—´
                                    </button>
                                    <button onclick="window.selectProcessChip(this, 'ë©´')" class="process-chip" style="height:54px; border-radius:12px; border:1px solid var(--border); font-size:17px; font-weight:500; transition:all 0.2s; background:var(--bg-input); color:var(--text-sub); cursor:pointer;">
                                        ë©´
                                    </button>
                                    <button onclick="window.selectProcessChip(this, 'ë§ˆê°')" class="process-chip" style="height:54px; border-radius:12px; border:1px solid var(--border); font-size:17px; font-weight:500; transition:all 0.2s; background:var(--bg-input); color:var(--text-sub); cursor:pointer;">
                                        ë§ˆê°
                                    </button>
                                    <button onclick="window.selectProcessChip(this, 'ê¸°íƒ€')" class="process-chip" style="height:54px; border-radius:12px; border:1px solid var(--border); font-size:17px; font-weight:500; transition:all 0.2s; background:var(--bg-input); color:var(--text-sub); cursor:pointer;">
                                        ê¸°íƒ€
                                    </button>
                                </div>
                                <input type="text" id="customProcess" placeholder="ê¸°íƒ€ ì…ë ¥" style="width:100%; height:48px; background:var(--bg-input); border:1px solid var(--border); border-radius:12px; padding:0 16px; font-size:15px; outline:none; transition:all 0.2s;" onfocus="this.style.borderColor='var(--primary)'; this.style.boxShadow='0 0 0 3px rgba(14,165,233,0.1)';" onblur="this.style.borderColor='var(--border)'; this.style.boxShadow='none';" />
                            </div>
                            
                            <!-- ì¶”ê°€ ì •ë³´ ì ‘ê¸°/í¼ì¹˜ê¸° -->
                            <div style="margin-top:20px;">
                                <button id="toggleAdditionalInfo" onclick="window.toggleAdditionalInfoSection()" style="width:100%; display:flex; align-items:center; justify-content:space-between; background:var(--bg-input); border:1px solid var(--border); border-radius:12px; padding:14px 16px; cursor:pointer; transition:all 0.2s;">
                                    <span style="font-size:15px; font-weight:700; color:var(--text-sub);">ì¶”ê°€ ì •ë³´ ì…ë ¥ (ì„ íƒ)</span>
                                    <i data-lucide="chevron-down" id="additionalInfoChevron" style="width:20px; color:var(--text-sub); transition:transform 0.3s;"></i>
                                </button>
                                
                                <div id="additionalInfoSection" style="display:none; margin-top:12px; padding:16px; background:var(--bg-input); border-radius:12px; border:1px solid var(--border);">
                                    <!-- ì‘ì—…ìœ í˜• -->
                                    <div style="margin-bottom:16px;">
                                        <label style="display:block; font-size:17px; font-weight:700; color:var(--text-sub); margin-bottom:8px;">ì‘ì—…ìœ í˜•</label>
                                        <div style="display:grid; grid-template-columns:repeat(4, 1fr); gap:8px;">
                                            <button onclick="window.selectTypeChip(this, 'ì§€í•˜')" class="type-chip" style="height:54px; border-radius:12px; border:1px solid var(--border); font-size:17px; font-weight:500; transition:all 0.2s; background:var(--bg-surface); color:var(--text-sub); cursor:pointer;">
                                                ì§€í•˜
                                            </button>
                                            <button onclick="window.selectTypeChip(this, 'ì§€ìƒ')" class="type-chip" style="height:54px; border-radius:12px; border:1px solid var(--border); font-size:17px; font-weight:500; transition:all 0.2s; background:var(--bg-surface); color:var(--text-sub); cursor:pointer;">
                                                ì§€ìƒ
                                            </button>
                                            <button onclick="window.selectTypeChip(this, 'ì§€ë¶•')" class="type-chip" style="height:54px; border-radius:12px; border:1px solid var(--border); font-size:17px; font-weight:500; transition:all 0.2s; background:var(--bg-surface); color:var(--text-sub); cursor:pointer;">
                                                ì§€ë¶•
                                            </button>
                                            <button onclick="window.selectTypeChip(this, 'ê¸°íƒ€')" class="type-chip" style="height:54px; border-radius:12px; border:1px solid var(--border); font-size:17px; font-weight:500; transition:all 0.2s; background:var(--bg-surface); color:var(--text-sub); cursor:pointer;">
                                                ê¸°íƒ€
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <!-- ë¸”ëŸ­/ë™/ì¸µ -->
                                    <div>
                                        <label style="display:block; font-size:17px; font-weight:700; color:var(--text-sub); margin-bottom:8px;">ë¸”ëŸ­ / ë™ / ì¸µ</label>
                                        <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:8px;">
                                            <input id="blockInput" type="text" placeholder="ë¸”ëŸ­" style="height:54px; background:var(--bg-surface); border:1px solid var(--border); border-radius:12px; padding:0 16px; text-align:center; font-size:15px; outline:none; transition:all 0.2s; width:100%; box-sizing:border-box;" onfocus="this.style.borderColor='var(--primary)'; this.style.boxShadow='0 0 0 3px rgba(14,165,233,0.1)';" onblur="this.style.borderColor='var(--border)'; this.style.boxShadow='none';" />
                                            <input id="dongInput" type="text" placeholder="ë™" style="height:54px; background:var(--bg-surface); border:1px solid var(--border); border-radius:12px; padding:0 16px; text-align:center; font-size:15px; outline:none; transition:all 0.2s; width:100%; box-sizing:border-box;" onfocus="this.style.borderColor='var(--primary)'; this.style.boxShadow='0 0 0 3px rgba(14,165,233,0.1)';" onblur="this.style.borderColor='var(--border)'; this.style.boxShadow='none';" />
                                            <input id="floorInput" type="text" placeholder="ì¸µ" style="height:54px; background:var(--bg-surface); border:1px solid var(--border); border-radius:12px; padding:0 16px; text-align:center; font-size:15px; outline:none; transition:all 0.2s; width:100%; box-sizing:border-box;" onfocus="this.style.borderColor='var(--primary)'; this.style.boxShadow='0 0 0 3px rgba(14,165,233,0.1)';" onblur="this.style.borderColor='var(--border)'; this.style.boxShadow='none';" />
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="padding:20px; border-top:1px solid var(--border); display:flex; gap:12px;">
                        <button onclick="window.closeAddWorklogModal()" style="flex:1; height:50px; background:#f3f4f6; color:#6b7280; font-weight:700; border-radius:12px; border:1px solid #e5e7eb; font-size:16px; cursor:pointer;">ì·¨ì†Œ</button>
                        <button onclick="window.submitNewWorklogFromDialog()" style="flex:1; height:50px; color:white; font-weight:700; border-radius:12px; transition:all 0.2s; font-size:16px; cursor:pointer; background: var(--header-navy)">
                            ì¼ì§€ì €ì¥
                        </button>
                    </div>
                </div>
            </div>
            <style>
                @media (max-width: 600px) { #addWorklogDialog { align-items:flex-end; } #addWorklogDialog > div { border-radius:20px 20px 0 0; max-width:100%; } }
            </style>
        `;
        document.body.insertAdjacentHTML('beforeend', html);
        
        // íˆ¬ì…ì¸ì› ë Œë”ë§ (window ê°ì²´ í•¨ìˆ˜ í˜¸ì¶œ)
        if (typeof window.renderModalManpowerList === 'function') {
            window.renderModalManpowerList();
        }
        
        // ë‚ ì§œ í•„ë“œ ì„¤ì •
        setTimeout(() => {
            const dateInput = document.getElementById('newWorklogDate');
            if (dateInput) {
                if (g_isEditMode && g_currentDate) {
                    dateInput.value = g_currentDate; // ìˆ˜ì • ëª¨ë“œ: ê¸°ì¡´ ë‚ ì§œ
                } else {
                    const today = new Date().toISOString().slice(0, 10); // ì˜¤ëŠ˜ ë‚ ì§œ ì •ì˜
                    dateInput.value = today; // ì¶”ê°€ ëª¨ë“œ: ì˜¤ëŠ˜ ë‚ ì§œ
                }
            }
        }, 50);
        
        // ìˆ˜ì • ëª¨ë“œì¼ ë•Œ ë°ì´í„° ì£¼ì…
        if (g_isEditMode) {
            setTimeout(() => {
                injectModalData();
            }, 100);
        }
        
        setTimeout(() => {
            if (typeof lucide !== 'undefined' && lucide.createIcons) {
                lucide.createIcons();
            }
        }, 100);
    }
    
    // [í†µí•©] ëª¨ë‹¬ ì „ìš© íˆ¬ì…ì¸ì› ë¦¬ìŠ¤íŠ¸ ìƒíƒœ
    // (ìƒë‹¨ ì „ì—­ ë³€ìˆ˜ë¡œ ì´ë™ë¨)

// [í†µí•©] íˆ¬ì…ì¸ì› ì¶”ê°€ (ë©”ì¸ê³¼ ë™ì¼í•œ ì´ˆê¸°ê°’)
window.addManpowerToModal = function() {
    console.log('addManpowerToModal í˜¸ì¶œë¨');
    const newId = Date.now() + Math.random();
    modalManpowerList.push({
        id: newId,
        worker: '',       // ì´ë¦„
        workHours: 1.0,   // ê¸°ë³¸ ê³µìˆ˜
        isCustom: false,
        locked: false
    });
    console.log('íˆ¬ì…ì¸ì› ì¶”ê°€ë¨:', modalManpowerList);
    window.renderModalManpowerList();
};

// [í†µí•©] ê³µìˆ˜ ì¡°ì ˆ (0.5 ë‹¨ìœ„, 0~3.5 ì œí•œ) - ì •ë°€ë„ ê°œì„ 
window.updateModalHours = function(id, delta) {
    console.log('updateModalHours í˜¸ì¶œë¨', id, delta);
    const item = modalManpowerList.find(m => m.id === id);
    if (item) {
        let newH = (parseFloat(item.workHours) || 0) + delta;
        newH = Math.max(0, Math.min(3.5, newH)); // 0~3.5 ì œí•œ
        item.workHours = Math.round(newH * 2) / 2; // 0.5 ë‹¨ìœ„ ê³ ì •
        window.renderModalManpowerList();
    } else {
        console.error('í•´ë‹¹ IDì˜ íˆ¬ì…ì¸ì›ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ:', id);
    }
};

// [í†µí•©] ì‘ì—…ìëª… ì—…ë°ì´íŠ¸
window.updateModalWorker = function(id, value) {
    const item = modalManpowerList.find(m => m.id === id);
    if (!item) return;

    if (value === 'CUSTOM' || value === '__custom__') {
        item.isCustom = true;
        item.worker = '';
    } else if (value === 'CANCEL') {
        item.isCustom = false;
        item.worker = '';
    } else {
        item.worker = value;
        item.isCustom = false;
    }
    window.renderModalManpowerList();
};

// [í†µí•©] ëª¨ë‹¬ ë‚´ íˆ¬ì…ì¸ì› UI ë Œë”ë§ (ë©”ì¸ í˜ì´ì§€ ë””ìì¸ ì™„ë²½ ë³µì œ)
window.renderModalManpowerList = function() {
    const container = document.getElementById('modalManpowerList');
    if (!container) {
        console.error('modalManpowerList ì»¨í…Œì´ë„ˆë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
        return;
    }

    console.log('íˆ¬ì…ì¸ì› ë Œë”ë§ ì‹œì‘:', modalManpowerList);
    
    container.innerHTML = modalManpowerList.map(item => `
        <div class="grid grid-cols-[minmax(0,1.05fr)_minmax(0,0.95fr)_auto] gap-2 items-center bg-slate-50 p-3 rounded-2xl border border-slate-100 transition-all" style="margin-bottom: 8px;">
            <div class="relative w-full min-w-0">
                ${!item.isCustom ? `
                    <select onchange="window.updateModalWorker(${item.id}, this.value)" class="material-select" style="height:48px; font-size:15px; padding-right:30px;">
                        <option value="">ì‘ì—…ì</option>
                        ${PREDEFINED_WORKERS.map(w => `<option value="${w}" ${item.worker === w ? 'selected' : ''}>${w}</option>`).join('')}
                        ${item.worker && !PREDEFINED_WORKERS.includes(item.worker) ? `<option value="${item.worker}" selected>${item.worker}</option>` : ''}
                        <option value="CUSTOM">ì§ì ‘ì…ë ¥</option>
                    </select>
                ` : ` 
                    <input type="text" value="${item.worker}" placeholder="ì´ë¦„" 
                           onblur="window.updateModalWorker(${item.id}, this.value || 'CANCEL')"
                           class="w-full h-[48px] bg-white border border-slate-200 rounded-xl px-4 outline-none focus:border-primary text-[15px] font-medium" />
                `}
            </div>
            
            <div class="flex h-[48px] border border-slate-200 rounded-xl bg-white overflow-hidden w-full min-w-0">
                <button onclick="window.updateModalHours(${item.id}, -0.5)" class="flex-1 flex items-center justify-center text-xl text-slate-400 hover:bg-slate-50">ï¼</button>
                <span class="flex-1 flex items-center justify-center text-base font-bold border-x border-slate-100">${Number(item.workHours).toFixed(1)}</span>
                <button onclick="window.updateModalHours(${item.id}, 0.5)" class="flex-1 flex items-center justify-center text-xl text-slate-400 hover:bg-slate-50">ï¼‹</button>
            </div>

            <button onclick="window.removeModalManpower(${item.id})" class="bg-red-50 text-red-500 text-sm font-bold px-2.5 py-1 rounded-xl ml-1">ì‚­ì œ</button>
        </div>
    `).join('');
    
    if (typeof lucide !== 'undefined') lucide.createIcons();
};

window.removeModalManpower = function(id) {
    modalManpowerList = modalManpowerList.filter(m => m.id !== id);
    window.renderModalManpowerList();
};

// [í†µí•©] ëª¨ë‹¬ ë‹«ê¸° í•¨ìˆ˜ (ì„ì‹œ ë°ì´í„° í´ë¦¬ì–´ í¬í•¨)
window.closeAddWorklogModal = function() {
    const modal = document.getElementById('addWorklogDialog');
    if (modal) {
        modal.remove();
    }
    
    // ì„ì‹œ ë°ì´í„° ì´ˆê¸°í™” (ë‹¤ìŒ ëª¨ë‹¬ ì—´ê¸° ì‹œ ì¶©ëŒ ë°©ì§€)
    modalManpowerList = [];
    selectedMember = '';
    selectedProcess = '';
    selectedType = '';
    g_editSourceDate = null; // ìˆ˜ì • ëª¨ë“œ ìƒíƒœ ì´ˆê¸°í™”
    g_isEditMode = false;
};
    
    // ì¶”ê°€ ì •ë³´ ì ‘ê¸°/í¼ì¹˜ê¸°
    window.toggleAdditionalInfoSection = function() {
        const section = document.getElementById('additionalInfoSection');
        const chevron = document.getElementById('additionalInfoChevron');
        
        if (section.style.display === 'none') {
            section.style.display = 'block';
            if (chevron) chevron.style.transform = 'rotate(180deg)';
        } else {
            section.style.display = 'none';
            if (chevron) chevron.style.transform = 'rotate(0deg)';
        }
        
        if (typeof lucide !== 'undefined') {
            setTimeout(() => lucide.createIcons(), 50);
        }
    };
    
    // [í†µí•©] ì‘ì—…ìœ í˜• ì¹© ì„ íƒ
    window.selectTypeChip = function(button, value) {
        // ì´ë¯¸ ì„ íƒëœ ì¹©ì„ ë‹¤ì‹œ í´ë¦­í•˜ë©´ ì„ íƒ í•´ì œ
        if (selectedType === value) {
            button.style.background = 'var(--bg-surface)';
            button.style.color = 'var(--text-sub)';
            button.style.borderColor = 'var(--border)';
            button.style.fontWeight = '500';
            selectedType = '';
            const customInput = document.getElementById('customType');
            if (customInput) customInput.value = '';
            return;
        }
        
        document.querySelectorAll('.type-chip').forEach(chip => {
            chip.style.background = 'var(--bg-surface)';
            chip.style.color = 'var(--text-sub)';
            chip.style.borderColor = 'var(--border)';
            chip.style.fontWeight = '500';
        });
        
        button.style.background = 'var(--bg-surface)';
        button.style.color = 'var(--primary)';
        button.style.borderColor = 'var(--primary)';
        button.style.fontWeight = '700';
        
        selectedType = value;
    };
    
    // [í†µí•©] ë¶€ì¬ëª… ì¹© ì„ íƒ
    window.selectMemberChip = function(button, value) {
        // ì´ë¯¸ ì„ íƒëœ ì¹©ì„ ë‹¤ì‹œ í´ë¦­í•˜ë©´ ì„ íƒ í•´ì œ
        if (selectedMember === value) {
            button.style.background = 'var(--bg-input)';
            button.style.color = 'var(--text-sub)';
            button.style.borderColor = 'var(--border)';
            button.style.fontWeight = '500';
            selectedMember = '';
            const customInput = document.getElementById('customMember');
            if (customInput) customInput.value = '';
            return;
        }
        
        document.querySelectorAll('.member-chip').forEach(chip => {
            chip.style.background = 'var(--bg-input)';
            chip.style.color = 'var(--text-sub)';
            chip.style.borderColor = 'var(--border)';
            chip.style.fontWeight = '500';
        });
        
        button.style.background = 'var(--bg-surface)';
        button.style.color = 'var(--primary)';
        button.style.borderColor = 'var(--primary)';
        button.style.fontWeight = '700';
        
        selectedMember = value;
        const customInput = document.getElementById('customMember');
        if (customInput) customInput.value = '';
    };
    
    // [í†µí•©] ê³µì • ì¹© ì„ íƒ
    window.selectProcessChip = function(button, value) {
        // ì´ë¯¸ ì„ íƒëœ ì¹©ì„ ë‹¤ì‹œ í´ë¦­í•˜ë©´ ì„ íƒ í•´ì œ
        if (selectedProcess === value) {
            button.style.background = 'var(--bg-input)';
            button.style.color = 'var(--text-sub)';
            button.style.borderColor = 'var(--border)';
            button.style.fontWeight = '500';
            selectedProcess = '';
            const customInput = document.getElementById('customProcess');
            if (customInput) customInput.value = '';
            return;
        }
        
        document.querySelectorAll('.process-chip').forEach(chip => {
            chip.style.background = 'var(--bg-input)';
            chip.style.color = 'var(--text-sub)';
            chip.style.borderColor = 'var(--border)';
            chip.style.fontWeight = '500';
        });
        
        button.style.background = 'var(--bg-surface)';
        button.style.color = 'var(--primary)';
        button.style.borderColor = 'var(--primary)';
        button.style.fontWeight = '700';
        
        selectedProcess = value;
        const customInput = document.getElementById('customProcess');
        if (customInput) customInput.value = '';
    };
    
    // [4] ë°ì´í„° ì €ì¥ ë¡œì§ (ì¤‘ìš”: g_worklogs êµ¬ì¡°ë¡œ ë³€í™˜)
    window.submitNewWorklogFromDialog = function() {
    console.log('=== ì €ì¥ ì‹œì‘ ===');
    
    // 0. í˜„ì¥ ì„ íƒ í™•ì¸
    if (!g_currentSite) {
        alert('í˜„ì¥ì„ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.');
        console.error('g_currentSiteê°€ ì„¤ì •ë˜ì§€ ì•ŠìŒ');
        return;
    }
    
    console.log('í˜„ì¬ ì„ íƒëœ í˜„ì¥:', g_currentSite);
    
    // 1. ë‚ ì§œ í™•ì¸ (ê°•í™”ëœ ìœ íš¨ì„± ê²€ì¦)
    const dateInput = document.getElementById('newWorklogDate');
    const date = dateInput ? dateInput.value : '';
    console.log('ì„ íƒëœ ë‚ ì§œ:', date);
    
    // ë‚ ì§œ ìœ íš¨ì„± ê²€ì¦
    if (!date || date === 'ì˜¤ë¥˜' || date.length !== 10) { 
        alert('ì˜¬ë°”ë¥¸ ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.'); 
        // ë‚ ì§œë¥¼ ì˜¤ëŠ˜ë¡œ ìë™ ì„¤ì •
        if (dateInput) {
            dateInput.value = new Date().toISOString().slice(0, 10);
        }
        return; 
    }
    
    // ë‚ ì§œ í˜•ì‹ ê²€ì¦ (YYYY-MM-DD)
    const dateRegex = /^\d{4}-\d{2}-\d{2}$/;
    if (!dateRegex.test(date)) {
        alert('ë‚ ì§œ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
        return;
    }
    
    // ìœ íš¨í•œ ë‚ ì§œì¸ì§€ í™•ì¸
    const parsedDate = new Date(date + 'T00:00:00');
    if (isNaN(parsedDate.getTime())) {
        alert('ìœ íš¨í•˜ì§€ ì•Šì€ ë‚ ì§œì…ë‹ˆë‹¤.');
        return;
    }

    // 2. ìµœì†Œ ì¸ì› ê²€ì¦ (1ëª… ì´ìƒ)
    const validWorkers = modalManpowerList.filter(m => (m.worker || '').trim() !== '');
    if (validWorkers.length === 0) {
        alert('ìµœì†Œ 1ëª…ì˜ ì‘ì—…ìê°€ í•„ìš”í•©ë‹ˆë‹¤.');
        return;
    }

    // 3. ì‘ì—… ë‚´ìš© ìˆ˜ì§‘ ('ê¸°íƒ€' ì…ë ¥ ì²˜ë¦¬ ê°œì„ )
    const customMember = document.getElementById('customMember')?.value.trim() || '';
    const customProcess = document.getElementById('customProcess')?.value.trim() || '';
    
    // 'ê¸°íƒ€' ì„ íƒ ì‹œ ì§ì ‘ ì…ë ¥ê°’ ì‚¬ìš©, ê·¸ ì™¸ì—ëŠ” ì„ íƒëœ ì¹© ê°’ ì‚¬ìš©
    const finalMember = selectedMember === 'ê¸°íƒ€' ? customMember : selectedMember;
    const finalProcess = selectedProcess === 'ê¸°íƒ€' ? customProcess : selectedProcess;
    
    console.log('ë¶€ì¬ëª…:', finalMember, 'ê³µì •:', finalProcess);

    if (!finalMember || !finalProcess) { 
        alert('ë¶€ì¬ëª…ê³¼ ê³µì •ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.'); 
        return; 
    }

    // 4. ì¶”ê°€ ì •ë³´ ìˆ˜ì§‘
    const blockInput = document.getElementById('blockInput');
    const dongInput = document.getElementById('dongInput');
    const floorInput = document.getElementById('floorInput');
    
    const block = blockInput ? blockInput.value.trim() : '';
    const dong = dongInput ? dongInput.value.trim() : '';
    const floor = floorInput ? floorInput.value.trim() : '';
    
    // ì‘ì—…ìœ í˜• ìˆ˜ì§‘ (ê¸°íƒ€ ì„ íƒ ì‹œ ì§ì ‘ ì…ë ¥ê°’ ì‚¬ìš©)
    const customType = document.getElementById('customType')?.value.trim() || '';
    const finalType = selectedType === 'ê¸°íƒ€' ? customType : selectedType;
    
    console.log('ìœ„ì¹˜ì •ë³´ - ë¸”ëŸ­:', block, 'ë™:', dong, 'ì¸µ:', floor);
    console.log('ì‘ì—…ìœ í˜•:', finalType, '(selectedType:', selectedType, ', customType:', customType, ')');

    // 5. ë°ì´í„° êµ¬ì¡° ì•ˆì „í•˜ê²Œ ìƒì„± (ê°ì²´ ê²½ë¡œ ëˆ„ë½ ë°©ì§€)
    if (!g_worklogs[g_currentSite]) {
        g_worklogs[g_currentSite] = { 
            dailyData: {}, 
            status: 'draft', 
            baseInfo: {
                siteName: '',
                dept: '',
                createdDate: date
            }
        };
    }
    
    const site = g_worklogs[g_currentSite];
    if (!site.dailyData) {
        site.dailyData = {};
    }
    
    // ìˆ˜ì • ëª¨ë“œ íŒë³„: g_editSourceDateê°€ ìˆìœ¼ë©´ ê¸°ì¡´ ë°ì´í„° ìˆ˜ì •
    const isEditMode = !!g_editSourceDate;
    
    // ë‚ ì§œê°€ ë³€ê²½ëœ ê²½ìš° ê¸°ì¡´ ë‚ ì§œ ë°ì´í„° ì‚­ì œ
    if (isEditMode && g_editSourceDate !== date) {
        delete site.dailyData[g_editSourceDate];
    }
    
    // í•´ë‹¹ ë‚ ì§œì˜ ê¸°ì¡´ ë°ì´í„°(ì‚¬ì§„, ë„ë©´ ë“±) ë³´ì¡´
    const existingDay = site.dailyData[date] || {};
    const currentTimestamp = new Date().toISOString();
    
    // ë²„ì „ ê³„ì‚°
    const versions = existingDay.versions || [];
    const nextVer = versions.length + 1;

    // 3. ë°ì´í„° ì €ì¥ (ìˆ˜ì • ëª¨ë“œë©´ ë®ì–´ì“°ê¸°, ì¶”ê°€ ëª¨ë“œë©´ ëˆ„ì )
    if (isEditMode) {
        // ìˆ˜ì • ëª¨ë“œ: ê¸°ì¡´ workSets ìœ ì§€í•˜ë©´ì„œ ìœ„ì¹˜ ì •ë³´ ì—…ë°ì´íŠ¸
        const existingWorkSets = existingDay.workSets || [];
        const updatedWorkSets = existingWorkSets.map(ws => ({
            ...ws,
            member: finalMember, 
            process: finalProcess, 
            type: finalType || ws.type || '',
            location: { block, dong, floor }
        }));
        
        // ê¸°ì¡´ workSetsê°€ ì—†ëŠ” ê²½ìš° ìƒˆë¡œ ìƒì„±
        const finalWorkSets = updatedWorkSets.length > 0 ? updatedWorkSets : [{
            id: Date.now(),
            member: finalMember, 
            process: finalProcess, 
            type: finalType || '',
            location: { block, dong, floor }
        }];
        
        site.dailyData[date] = {
            ...existingDay, // ì‚¬ì§„, ìì¬ ë“± ê¸°ì¡´ ë°ì´í„° ë³´ì¡´
            workSets: finalWorkSets,
            manpower: [
                { 
                    date: date, 
                    workers: validWorkers.map(w => ({ name: w.worker, hours: parseFloat(w.workHours) })) 
                }
            ],
            versions: [
                ...versions,
                { 
                    ver: nextVer, 
                    time: currentTimestamp, 
                    type: 'edit', 
                    desc: `v${nextVer} ìˆ˜ì • ë°˜ì˜` 
                }
            ]
        };
    } else {
        // ì¶”ê°€ ëª¨ë“œ: ìµœì¢… ë°ì´í„°ë¡œ ë®ì–´ì“°ê¸° (ì¤‘ë³µ ë°©ì§€)
        site.dailyData[date] = {
            ...existingDay,
            workSets: [
                { 
                    id: Date.now(),
                    member: finalMember, 
                    process: finalProcess, 
                    type: finalType || '',
                    location: { block, dong, floor }
                }
            ],
            manpower: [
                { 
                    date: date, 
                    workers: validWorkers.map(w => ({ name: w.worker, hours: parseFloat(w.workHours) })) 
                }
            ],
            versions: [
                ...versions,
                { 
                    ver: nextVer, 
                    time: currentTimestamp, 
                    type: 'create', 
                    desc: `v${nextVer} ì¶”ê°€ ê¸°ë¡` 
                }
            ]
        };
    }
    
    console.log('ì €ì¥ëœ ë°ì´í„° êµ¬ì¡°:', site.dailyData[date]);

    // 6. ìµœì¢… ì €ì¥ ë° í›„ì²˜ë¦¬
    try {
        saveData(); // localStorage.setItem ì‹¤í–‰
        console.log('=== ì €ì¥ ì™„ë£Œ ===');
        console.log('ì €ì¥ëœ ë°ì´í„°:', g_worklogs[g_currentSite].dailyData[date]);
        
        g_editSourceDate = null; // ìˆ˜ì • ì„¸ì…˜ ì¢…ë£Œ
        
        // ì „ì—­ ë³€ìˆ˜ ì´ˆê¸°í™” (ë‹¤ìŒ ì…ë ¥ ì‹œ ì¶©ëŒ ë°©ì§€)
        selectedMember = '';
        selectedProcess = '';
        selectedType = '';
        
        window.closeAddWorklogModal(); // ëª¨ë‹¬ ë‹«ê¸° + ìƒíƒœ ì´ˆê¸°í™”
        
        // ë°ì´í„° ì €ì¥ í›„ ì•½ê°„ ì§€ì—° í›„ ë¦¬ìŠ¤íŠ¸ ê°±ì‹ 
        setTimeout(() => {
            renderLogs(); // ë©”ì¸ ë¦¬ìŠ¤íŠ¸ ê°±ì‹ 
        }, 100);
        
        if (typeof openDetail === 'function') {
            openDetail(g_currentSite, 'status'); // ìƒì„¸ì°½ ìœ ì§€
        }
        
        showToast(isEditMode ? `v${nextVer} ìˆ˜ì •ì‚¬í•­ì´ ë°˜ì˜ë˜ì—ˆìŠµë‹ˆë‹¤.` : `v${nextVer} ê¸°ë¡ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.`);
    } catch (error) {
        console.error('ì €ì¥ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
        alert('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
    }
}
    
    function submitNewWorklog() {
        const date = document.getElementById('newWorklogDate').value;
        const customMember = document.getElementById('customMember').value.trim();
        const customProcess = document.getElementById('customProcess').value.trim();
        const block = document.getElementById('blockInput').value.trim();
        const dong = document.getElementById('dongInput').value.trim();
        const floor = document.getElementById('floorInput').value.trim();
        
        const member = customMember || selectedMember;
        const process = customProcess || selectedProcess;
        const type = selectedType;
        
        if (!date) {
            showToast('ì‘ì—…ì¼ìë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”');
            return;
        }
        
        if (modalManpowerList.length === 0 || !modalManpowerList.some(m => m.worker && m.workHours > 0)) {
            showToast('íˆ¬ì…ì¸ì›ì„ ì¶”ê°€í•´ì£¼ì„¸ìš”');
            return;
        }
        
        if (!member) {
            showToast('ë¶€ì¬ëª…ì„ ì„ íƒí•˜ê±°ë‚˜ ì…ë ¥í•´ì£¼ì„¸ìš”');
            return;
        }
        
        if (!process) {
            showToast('ì‘ì—…ê³µì •ì„ ì„ íƒí•˜ê±°ë‚˜ ì…ë ¥í•´ì£¼ì„¸ìš”');
            return;
        }
        
        // ëª¨ë‹¬ì˜ íˆ¬ì…ì¸ì›ì„ g_worklogs ìŠ¤í‚¤ë§ˆ(workers ë°°ì—´)ì— ë§ê²Œ ë³€í™˜
        const manpowerData = modalManpowerList
            .filter(m => m.worker.trim() !== '')
            .map(m => ({
                date: date,
                workers: [{ name: m.worker, hours: m.workHours }] // ë‚´ë¶€ ë°ì´í„°ëŠ” 'hours' í‚¤ ì‚¬ìš© ìœ ì§€
            }));
        
        // ë²„ì „ ê´€ë¦¬: ë™ì¼ ë‚ ì§œ ë°ì´í„° ì¶”ê°€ ì‹œ version ì¦ê°€
        const site = g_worklogs[g_currentSite];
        const existingData = g_worklogs[g_currentSite].dailyData[date];
        
        if (existingData) {
            // ê¸°ì¡´ ë°ì´í„°ê°€ ìˆìœ¼ë©´ version ì¦ê°€
            const currentVersion = existingData.versions ? existingData.versions.length : 0;
            const newVersion = currentVersion + 1;
            
            // ìƒˆë¡œìš´ ì‘ì—… ì„¸íŠ¸ ì¶”ê°€
            existingData.workSets.push({
                id: Date.now(),
                member: member,
                process: process,
                type: type || '',
                location: { block: block, dong: dong, floor: floor }
            });
            
            // íˆ¬ì…ì¸ì› ì¶”ê°€
            existingData.manpower = existingData.manpower.concat(manpowerData);
            
            // ë²„ì „ íˆìŠ¤í† ë¦¬ ì¶”ê°€
            existingData.versions.push({
                ver: newVersion,
                time: new Date().toISOString(),
                type: 'update',
                desc: `ì‘ì—… ë‚´ìš© ì¶”ê°€ (v${newVersion})`
            });
            
            showToast(`${date} ì‘ì—…ì¼ì§€ê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤ (v${newVersion})`);
        } else {
            // ìƒˆë¡œìš´ ë‚ ì§œ ìƒì„±
            g_worklogs[g_currentSite].dailyData[date] = {
                baseInfo: {
                    siteName: site.baseInfo.siteName,
                    dept: site.baseInfo.dept,
                    workDate: date,
                    status: 'draft',
                    rejectReason: null
                },
                workSets: [{
                    id: Date.now(),
                    member: member,
                    process: process,
                    type: type || '',
                    location: { block: block, dong: dong, floor: floor }
                }],
                manpower: manpowerData,
                manpowerHistory: [],
                versions: [{ ver: 1, time: new Date().toISOString(), type: 'create', desc: 'ì‘ì—…ì¼ì§€ ìƒì„±' }],
                assets: { photos: [], drawings: [], confirm: null },
                materials: []
            };
            
            showToast(`${date} ì‘ì—…ì¼ì§€ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.`);
        }
        
        g_currentDate = date;
        saveData();
        closeAddWorklogModal();
        openDetail(g_currentSite);
        renderLogs();
    }
    
    // [ìˆ˜ì •] ê¸°ì¡´ ë°ì´í„° ë¡œë“œ ë° ìˆ˜ì • ëª¨ë“œ ì§„ì…
    window.editWorklogDate = function(dateKey) {
        const site = g_worklogs[g_currentSite];
        if (!site || !site.dailyData[dateKey]) return;
        
        const dayData = site.dailyData[dateKey];
        g_currentDate = dateKey;
        g_editSourceDate = dateKey; 
        g_isEditMode = true;

        // 1. íˆ¬ì…ì¸ì› ë³µì œ (Deep Copy)
        modalManpowerList = JSON.parse(JSON.stringify(dayData.manpower?.[0]?.workers || []))
            .map((w, idx) => ({
                id: Date.now() + idx + Math.random(),
                worker: w.name,
                workHours: w.hours,
                isCustom: !PREDEFINED_WORKERS.includes(w.name)
            }));

        // 2. ì‘ì—…ë‚´ìš© 100% ì¼ì¹˜ íŒë³„ (ì¹© vs ê¸°íƒ€)
        const lastWS = dayData.workSets?.[dayData.workSets.length - 1] || {};
        
        const checkChip = (val, options) => (options.includes(val) ? val : (val ? 'ê¸°íƒ€' : ''));
        const getCustomVal = (val, options) => (options.includes(val) ? '' : val);

        selectedMember = checkChip(lastWS.member, ['ìŠ¬ë¼ë¸Œ', 'ê±°ë”', 'ê¸°ë‘¥']);
        const customMem = getCustomVal(lastWS.member, ['ìŠ¬ë¼ë¸Œ', 'ê±°ë”', 'ê¸°ë‘¥']);

        selectedProcess = checkChip(lastWS.process, ['ê· ì—´', 'ë©´', 'ë§ˆê°']);
        const customProc = getCustomVal(lastWS.process, ['ê· ì—´', 'ë©´', 'ë§ˆê°']);

        // [ìš”ì²­ì‚¬í•­] ì‘ì—…ìœ í˜• 'ë§ˆê°' ì²˜ë¦¬ ì˜ˆì‹œ (ì§€í•˜, ì§€ìƒ, ì§€ë¶•ì— ì—†ìœ¼ë©´ ê¸°íƒ€+ë§ˆê°ì…ë ¥)
        selectedType = checkChip(lastWS.type, ['ì§€í•˜', 'ì§€ìƒ', 'ì§€ë¶•']);
        const customTyp = getCustomVal(lastWS.type, ['ì§€í•˜', 'ì§€ìƒ', 'ì§€ë¶•']);

        // 3. ëª¨ë‹¬ ì—´ê¸° ë° UI ì£¼ì…
        openAddWorklogModal();

        setTimeout(() => {
            document.getElementById('newWorklogDate').value = dateKey;
            
            // ì¹© ìŠ¤íƒ€ì¼ ê°•ì œ í™œì„±í™”
            window.applyActiveChipStyles();
            
            // ê¸°íƒ€ ì…ë ¥ê°’ ì£¼ì…
            if (customMem) document.getElementById('customMember').value = customMem;
            if (customProc) document.getElementById('customProcess').value = customProc;
            
            // ìœ„ì¹˜ ì •ë³´ ë° ì‘ì—…ìœ í˜• ê¸°íƒ€ ì²˜ë¦¬
            if (lastWS.location) {
                document.getElementById('blockInput').value = lastWS.location.block || '';
                document.getElementById('dongInput').value = lastWS.location.dong || '';
                document.getElementById('floorInput').value = lastWS.location.floor || '';
            }
            
            if (customTyp) {
                window.toggleAdditionalInfoSection(); // ì„¹ì…˜ í¼ì¹˜ê¸°
                // ì‘ì—…ìœ í˜• í…ìŠ¤íŠ¸ ë°•ìŠ¤ê°€ ìˆë‹¤ë©´ ì£¼ì… (HTMLì— customType id í™•ì¸ í•„ìš”)
                const typeInp = document.getElementById('customType');
                if(typeInp) typeInp.value = customTyp;
            }

            window.renderModalManpowerList();
        }, 150);
    };
    
        
    // [ë³´ì¡°] ì¹© í™œì„±í™” ë¹„ì£¼ì–¼ ì ìš© í•¨ìˆ˜
    function applyActiveChipStyles() {
        const apply = (selector, value) => {
            document.querySelectorAll(selector).forEach(btn => {
                if (btn.textContent.trim() === value) {
                    btn.style.background = 'var(--bg-surface)';
                    btn.style.color = 'var(--primary)';
                    btn.style.borderColor = 'var(--primary)';
                    btn.style.fontWeight = '700';
                    btn.classList.add('active-chip');
                } else {
                    btn.style.background = ''; // ì´ˆê¸°í™”
                    btn.style.color = '';
                    btn.style.borderColor = '';
                    btn.style.fontWeight = '';
                    btn.classList.remove('active-chip');
                }
            });
        };

        if (selectedMember) apply('.member-chip', selectedMember);
        if (selectedProcess) apply('.process-chip', selectedProcess);
        if (selectedType) apply('.type-chip', selectedType);
    }
    
    // ëª¨ë‹¬ì— ë°ì´í„° ì£¼ì… í•¨ìˆ˜
    function injectModalData(lastWS) {
        // ë‚ ì§œ ì£¼ì…
        const dateInput = document.getElementById('newWorklogDate');
        if (dateInput) dateInput.value = g_currentDate;

        // ì¶”ê°€ ì •ë³´(ë¸”ëŸ­/ë™/ì¸µ) ì£¼ì…
        if (lastWS && lastWS.location) {
            if (lastWS.type) {
                // íƒ€ì…ì´ ìˆìœ¼ë©´ ì¶”ê°€ì •ë³´ ì„¹ì…˜ ìë™ í¼ì¹¨
                const addSec = document.getElementById('additionalInfoSection');
                if (addSec) {
                    addSec.style.display = 'block';
                    const chevron = document.getElementById('additionalInfoChevron');
                    if (chevron) chevron.style.transform = 'rotate(180deg)';
                }
            }
            const blockInput = document.getElementById('blockInput');
            const dongInput = document.getElementById('dongInput');
            const floorInput = document.getElementById('floorInput');
            if (blockInput) blockInput.value = lastWS.location.block || '';
            if (dongInput) dongInput.value = lastWS.location.dong || '';
            if (floorInput) floorInput.value = lastWS.location.floor || '';
        }

        // ì¹© í™œì„±í™” ì‹œê°í™”
        applyActiveChipStyles();
        
        // ë°˜ë ¤ í•„ë“œ ê°•ì¡°
        highlightRejectFields();
    }
    
    // ëª¨ë‹¬ ì˜¤í”ˆ í›„ ì‹¤í–‰ë  ê°•ì¡° ë¡œì§
    function highlightRejectFields() {
        const site = g_worklogs[g_currentSite];
        if (!site || site.status !== 'reject') return;

        const reason = site.baseInfo.rejectReason || "";
        const status = getSectionStatus(site.baseInfo); // ì´ì „ ë‹¨ê³„ì—ì„œ ë§Œë“  ë¶„ì„ í•¨ìˆ˜

        if (status.manpower) {
            const manpowerSection = document.getElementById('modalManpowerList');
            if (manpowerSection) manpowerSection.classList.add('reject-field-focus');
        }
        if (status.workSets) {
            // ë¶€ì¬ëª…, ê³µì • ì¹© ê·¸ë£¹ ê°•ì¡°
            document.querySelectorAll('.member-chip, .process-chip').forEach(el => {
                el.parentElement.classList.add('reject-field-focus');
            });
        }
        if (status.confirm) {
            // ì‘ì—…ì™„ë£Œí™•ì¸ì„œ ì„¹ì…˜ ê°•ì¡°
            const confirmSection = document.querySelector('#addWorklogDialog .confirm-section, #addWorklogDialog [onclick*="confirm"]');
            if (confirmSection) {
                confirmSection.classList.add('reject-field-focus');
            }
        }
    }
    
    // íˆ¬ì…ì¸ì› ìˆ˜ì • ê´€ë ¨ ë³€ìˆ˜
    let currentEditManpowerIndex = -1;
    let currentEditWorkSetIndex = -1;
    let editSelectedMember = '';
    let editSelectedProcess = '';
    let editSelectedType = '';
    
    // íˆ¬ì…ì¸ì› ê´€ë¦¬ í•¨ìˆ˜ (ìˆ˜ì • ëª¨ë“œìš©)
    function addManpowerItem() {
        const container = document.getElementById('manpowerListEdit');
        if (!container) return;
        
        const newDate = g_currentDate || new Date().toISOString().slice(0, 10);
        const idx = container.querySelectorAll('.manpower-item').length;
        
        const newItem = document.createElement('div');
        newItem.className = 'manpower-item mb-3';
        newItem.innerHTML = `
            <div class="flex items-center gap-3 mb-2">
                <input type="date" class="h-[48px] bg-bg-input border border-border rounded-xl px-3 text-[15px] font-medium outline-none" value="${newDate}" style="background: var(--bg-input); border: 1px solid var(--border);">
                <button onclick="removeManpowerItem(${idx})" class="text-red-500 hover:text-red-700">
                    <i data-lucide="trash-2" style="width:16px;"></i>
                </button>
            </div>
            <div class="flex flex-wrap gap-2">
                <button onclick="addWorker(${idx})" class="bg-primary-bg text-primary h-8 px-3 rounded-xl text-sm font-bold flex items-center gap-1 hover:bg-sky-100 transition-colors" style="background: var(--primary-bg); color: var(--primary)">
                    <span class="text-lg font-black">+</span> ì‘ì—…ì ì¶”ê°€
                </button>
            </div>
        `;
        
        container.appendChild(newItem);
        if (typeof lucide !== 'undefined' && lucide.createIcons) {
            lucide.createIcons();
        }
    }
    
    function removeManpowerItem(idx) {
        const container = document.getElementById('manpowerListEdit');
        if (!container) return;
        
        const items = container.querySelectorAll('.manpower-item');
        
        // ìµœì†Œ 1ê°œ ì´ìƒ ìœ ì§€ í™•ì¸
        if (items.length <= 1) {
            showToast('ìµœì†Œ 1ê°œ ì´ìƒì˜ íˆ¬ì…ì¸ì› í•­ëª©ì´ í•„ìš”í•©ë‹ˆë‹¤.');
            return;
        }
        
        if (items[idx]) {
            items[idx].remove();
        }
        
        // ë°ì´í„° ì—…ë°ì´íŠ¸
        updateManpowerData();
    }
    
    function removeWorker(manpowerIdx, workerIdx) {
        const container = document.getElementById('manpowerListEdit');
        if (!container) return;
        
        const manpowerItem = container.querySelectorAll('.manpower-item')[manpowerIdx];
        if (!manpowerItem) return;
        
        const workers = manpowerItem.querySelectorAll('.flex.items-center.gap-2');
        
        // ìµœì†Œ 1ëª… ì´ìƒ ìœ ì§€ í™•ì¸
        if (workers.length <= 1) {
            showToast('ìµœì†Œ 1ëª… ì´ìƒì˜ ì‘ì—…ìê°€ í•„ìš”í•©ë‹ˆë‹¤.');
            return;
        }
        
        if (workers[workerIdx]) {
            workers[workerIdx].remove();
        }
        
        // ë°ì´í„° ì—…ë°ì´íŠ¸
        updateManpowerData();
    }
    
    // íˆ¬ì…ì¸ì› ë°ì´í„° ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
    function updateManpowerDate(idx, date) {
        if (!g_currentSite || !g_currentDate) return;
        
        const site = g_worklogs[g_currentSite];
        if (!site || !site.dailyData[g_currentDate]) return;
        
        // manpowerHistoryê°€ ì—†ìœ¼ë©´ ìƒì„±
        if (!site.dailyData[g_currentDate].manpowerHistory) {
            site.dailyData[g_currentDate].manpowerHistory = [{
                date: g_currentDate,
                workers: []
            }];
        }
        
        // ì¸ë±ìŠ¤ê°€ ë²”ìœ„ë¥¼ ë²—ì–´ë‚˜ë©´ ìƒˆ í•­ëª© ì¶”ê°€
        while (site.dailyData[g_currentDate].manpowerHistory.length <= idx) {
            site.dailyData[g_currentDate].manpowerHistory.push({
                date: g_currentDate,
                workers: []
            });
        }
        
        site.dailyData[g_currentDate].manpowerHistory[idx].date = date;
        saveData();
    }
    
    function updateWorkerName(manpowerIdx, workerIdx, name) {
        if (!g_currentSite || !g_currentDate) return;
        
        const site = g_worklogs[g_currentSite];
        if (!site || !site.dailyData[g_currentDate]) return;
        
        // manpowerHistoryê°€ ì—†ìœ¼ë©´ ìƒì„±
        if (!site.dailyData[g_currentDate].manpowerHistory) {
            site.dailyData[g_currentDate].manpowerHistory = [{
                date: g_currentDate,
                workers: []
            }];
        }
        
        const manpowerItem = site.dailyData[g_currentDate].manpowerHistory[manpowerIdx];
        if (!manpowerItem) return;
        
        // workers ë°°ì—´ì´ ì—†ìœ¼ë©´ ìƒì„±
        if (!manpowerItem.workers) {
            manpowerItem.workers = [];
        }
        
        const worker = manpowerItem.workers[workerIdx];
        if (!worker) return;
        
        if (name === 'CUSTOM') {
            worker.isCustom = true;
            worker.name = '';
        } else if (name === 'CANCEL') {
            worker.isCustom = false;
            worker.name = '';
        } else {
            worker.name = name;
            worker.isCustom = false;
        }
        
        saveData();
        
        // UI ì—…ë°ì´íŠ¸ë¥¼ ìœ„í•´ ì¬ë Œë”ë§ (g_currentTab ìœ ì§€)
        openDetail(g_currentSite, g_currentTab);
    }
    
    function updateWorkerHours(manpowerIdx, workerIdx, hours) {
        if (!g_currentSite || !g_currentDate) return;
        
        const site = g_worklogs[g_currentSite];
        if (site && site.dailyData[g_currentDate] && site.dailyData[g_currentDate].manpowerHistory) {
            site.dailyData[g_currentDate].manpowerHistory[manpowerIdx].workers[workerIdx].hours = parseFloat(hours) || 0;
            saveData();
        }
    }
    
    function increaseWorkerHours(manpowerIdx, workerIdx) {
        if (!g_currentSite || !g_currentDate) return;
        
        const site = g_worklogs[g_currentSite];
        if (!site || !site.dailyData[g_currentDate]) return;
        
        // manpowerHistoryê°€ ì—†ìœ¼ë©´ ìƒì„±
        if (!site.dailyData[g_currentDate].manpowerHistory) {
            site.dailyData[g_currentDate].manpowerHistory = [{
                date: g_currentDate,
                workers: []
            }];
        }
        
        const manpowerItem = site.dailyData[g_currentDate].manpowerHistory[manpowerIdx];
        if (!manpowerItem) return;
        
        // workers ë°°ì—´ì´ ì—†ìœ¼ë©´ ìƒì„±
        if (!manpowerItem.workers) {
            manpowerItem.workers = [];
        }
        
        const worker = manpowerItem.workers[workerIdx];
        if (!worker) return;
        
        // @main.html ë°©ì‹: 0.0 ~ 3.5 ë²”ìœ„, 0.5 ë‹¨ìœ„ ì¦ê°€
        let newHours = (parseFloat(worker.hours) || 0) + 0.5;
        newHours = Math.max(0, Math.min(3.5, newHours));
        worker.hours = Math.round(newHours * 10) / 10;
        
        saveData();
        
        // UI ì—…ë°ì´íŠ¸ë¥¼ ìœ„í•´ ì¬ë Œë”ë§ (g_currentTab ìœ ì§€)
        openDetail(g_currentSite, g_currentTab);
    }
    
    function decreaseWorkerHours(manpowerIdx, workerIdx) {
        if (!g_currentSite || !g_currentDate) return;
        
        const site = g_worklogs[g_currentSite];
        if (!site || !site.dailyData[g_currentDate]) return;
        
        // manpowerHistoryê°€ ì—†ìœ¼ë©´ ìƒì„±
        if (!site.dailyData[g_currentDate].manpowerHistory) {
            site.dailyData[g_currentDate].manpowerHistory = [{
                date: g_currentDate,
                workers: []
            }];
        }
        
        const manpowerItem = site.dailyData[g_currentDate].manpowerHistory[manpowerIdx];
        if (!manpowerItem) return;
        
        // workers ë°°ì—´ì´ ì—†ìœ¼ë©´ ìƒì„±
        if (!manpowerItem.workers) {
            manpowerItem.workers = [];
        }
        
        const worker = manpowerItem.workers[workerIdx];
        if (!worker) return;
        
        // @main.html ë°©ì‹: 0.0 ~ 3.5 ë²”ìœ„, 0.5 ë‹¨ìœ„ ê°ì†Œ
        let newHours = (parseFloat(worker.hours) || 0) - 0.5;
        newHours = Math.max(0, Math.min(3.5, newHours));
        worker.hours = Math.round(newHours * 10) / 10;
        
        saveData();
        
        // UI ì—…ë°ì´íŠ¸ë¥¼ ìœ„í•´ ì¬ë Œë”ë§ (g_currentTab ìœ ì§€)
        openDetail(g_currentSite, g_currentTab);
    }
    
    function updateManpowerData() {
        if (!g_currentSite || !g_currentDate) return;
        const container = document.getElementById('manpowerListEdit');
        if (!container) return;

        const site = g_worklogs[g_currentSite];
        const manpowerItems = container.querySelectorAll('.manpower-item');
        const history = [];
        const summaryManpower = []; // ë¦¬ìŠ¤íŠ¸ ì¹´ë“œ í‘œì‹œìš© ìš”ì•½ ë°°ì—´

        manpowerItems.forEach(item => {
            const date = item.querySelector('input[type="date"]').value;
            const workers = [];
            // ê° ì‘ì—…ì row ì„ íƒ
            const workerRows = item.querySelectorAll('.grid'); 
            
            workerRows.forEach(row => {
                const nameInput = row.querySelector('input[type="text"]') || row.querySelector('select');
                const hoursText = row.querySelector('span.flex-1').innerText;
                const name = nameInput.value.trim();
                const hours = parseFloat(hoursText) || 0;

                if (name && name !== 'CUSTOM') {
                    workers.push({ name, hours, isCustom: !!row.querySelector('input[type="text"]') });
                    summaryManpower.push({ name, hours }); // ìš”ì•½ ë°ì´í„°ì—ë„ ì¶”ê°€
                }
            });

            if (date && workers.length > 0) {
                history.push({ date, workers });
            }
        });

        site.dailyData[g_currentDate].manpowerHistory = history;
        site.dailyData[g_currentDate].manpower = summaryManpower; // ë¦¬ìŠ¤íŠ¸ ì¹´ë“œ ë°˜ì˜ìš©
    }
    
    // ì‘ì—…ìœ í˜• ì¹© í† ê¸€ í•¨ìˆ˜ (ìˆ˜ì • ëª¨ë“œ)
    function toggleWorkTypeChipEdit(idx, type) {
        if (!g_currentSite || !g_currentDate) return;
        
        const site = g_worklogs[g_currentSite];
        if (!site || !site.dailyData[g_currentDate]) return;
        
        const workSets = site.dailyData[g_currentDate].workSets || [];
        if (!workSets[idx]) return;
        
        // ê¸°íƒ€ ì…ë ¥ê°’ ì €ì¥
        const currentType = workSets[idx].type;
        const customInput = document.getElementById(`customTypeEdit${idx}`);
        if (currentType === 'ê¸°íƒ€' && customInput) {
            workSets[idx].customTypeValue = customInput.value;
        }
        
        // íƒ€ì… ë³€ê²½
        workSets[idx].type = type;
        
        // ê¸°íƒ€ì¼ ê²½ìš° ì…ë ¥ê°’ ë³µì›
        if (type === 'ê¸°íƒ€' && customInput) {
            customInput.value = workSets[idx].customTypeValue || '';
        }
        
        // UI ì—…ë°ì´íŠ¸ë¥¼ ìœ„í•´ ì¬ë Œë”ë§
        openDetail(g_currentSite, 'status');
        
        // ë°ì´í„° ì €ì¥
        saveData();
    }
    
    // ì‘ì—…ì ì¶”ê°€ í•¨ìˆ˜
    function addWorker(manpowerIdx) {
        if (!g_currentSite || !g_currentDate) return;
        
        const site = g_worklogs[g_currentSite];
        if (!site || !site.dailyData[g_currentDate]) return;
        
        // manpowerHistoryê°€ ì—†ìœ¼ë©´ ìƒì„±
        if (!site.dailyData[g_currentDate].manpowerHistory) {
            site.dailyData[g_currentDate].manpowerHistory = [{
                date: g_currentDate,
                workers: []
            }];
        }
        
        const manpowerItem = site.dailyData[g_currentDate].manpowerHistory[manpowerIdx];
        if (!manpowerItem) return;
        
        // workers ë°°ì—´ì´ ì—†ìœ¼ë©´ ìƒì„±
        if (!manpowerItem.workers) {
            manpowerItem.workers = [];
        }
        
        // ìƒˆ ì‘ì—…ì ì¶”ê°€ - @main.htmlê³¼ ë™ì¼í•˜ê²Œ 1.0 ê¸°ë³¸ê°’ ì‚¬ìš©
        manpowerItem.workers.push({
            name: '',
            hours: 1.0,
            isCustom: false,
            isDefault: false // ì¶”ê°€ëœ ì‘ì—…ì í‘œì‹œ
        });
        
        saveData();
        
        // UI ì—…ë°ì´íŠ¸ë¥¼ ìœ„í•´ ì¬ë Œë”ë§ (g_currentTab ìœ ì§€)
        openDetail(g_currentSite, g_currentTab);
    }
    
    function saveDetailedEdit() {
        const site = g_worklogs[g_currentSite];
        if (!site || !site.dailyData) {
            showToast('í˜„ì¥ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            return;
        }
        
        const daily = site.dailyData[g_currentDate] || {};

        // 1. íˆ¬ì…ì¸ì› ìˆ˜ì§‘ (ìˆ˜ì • ëª¨ë“œì—ì„œ)
        const workers = [];
        document.querySelectorAll('#editManpowerList .manpower-row').forEach((row, i) => {
            const nameInput = row.querySelector('input[type="text"]');
            const hoursSpan = row.querySelector('span[style*="font-weight:700"]');
            const name = nameInput?.value?.trim();
            const hours = parseFloat(hoursSpan?.innerText) || 0;
            if (name && name !== '') {
                workers.push({ name, hours });
            }
        });
        
        if (workers.length === 0) {
            showToast('ìµœì†Œ 1ëª…ì˜ ì‘ì—…ìê°€ í•„ìš”í•©ë‹ˆë‹¤.');
            return;
        }

        // 2. ë²„ì „ ê´€ë¦¬ (v1, v2...)
        const versions = daily.versions || [];
        const nextVer = versions.length + 1;
        
        // 3. ì‘ì—…ë‚´ìš©(WorkSets) ìˆ˜ì§‘ (ìˆ˜ì • ëª¨ë“œ)
        const workSetCards = document.querySelectorAll('#editWorkSetList .workset-card');
        const newWorkSets = Array.from(workSetCards).map((card, idx) => {
            const memberInput = card.querySelector(`#member_${idx}`);
            const processInput = card.querySelector(`#process_${idx}`);
            const typeInput = card.querySelector(`#type_${idx}`);
            
            const member = memberInput?.value?.trim() || '';
            const process = processInput?.value?.trim() || '';
            const type = typeInput?.value?.trim() || '';

            return {
                id: Date.now() + idx,
                member, 
                process, 
                type,
                location: {
                    block: document.getElementById(`block_${idx}`)?.value?.trim() || '',
                    dong: document.getElementById(`dong_${idx}`)?.value?.trim() || '',
                    floor: document.getElementById(`floor_${idx}`)?.value?.trim() || ''
                }
            };
        });
        
        // 4. ë°ì´í„° ì—…ë°ì´íŠ¸ (manpowerHistory êµ¬ì¡° ì‚¬ìš©)
        site.dailyData[g_currentDate] = {
            ...daily,
            manpowerHistory: [{ date: g_currentDate, workers }],
            workSets: newWorkSets,
            versions: [...versions, { 
                ver: nextVer, 
                time: new Date().toISOString(), 
                type: 'edit',
                desc: `v${nextVer} ìˆ˜ì • ë°˜ì˜` 
            }]
        };

        // ì¦‰ì‹œ ì €ì¥ ë° ë™ê¸°í™”
        saveData();
        
        // ìˆ˜ì • ëª¨ë“œ ì¢…ë£Œ
        g_isEditMode = false;
        
        // UI ê°±ì‹ 
        renderLogs();
        openDetail(g_currentSite, g_currentTab);
        
        showToast(`v${nextVer} ìˆ˜ì •ì‚¬í•­ì´ ë°˜ì˜ë˜ì—ˆìŠµë‹ˆë‹¤.`);
    }
    
    // íŠ¹ì • ë²„ì „ìœ¼ë¡œ ë³µêµ¬í•˜ëŠ” í•¨ìˆ˜
    function rollbackToVersion(siteKey, dateKey, versionNum) {
        const site = (g_worklogs || {})[siteKey];
        if (!site || !site.dailyData || !site.dailyData[dateKey]) {
            showToast("ë³µêµ¬í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
            return;
        }
        
        const daily = site.dailyData[dateKey];
        const targetVersion = daily.versions?.find(v => v.ver === versionNum);

        if (!targetVersion || !targetVersion.snapshot) {
            showToast("ë³µêµ¬í•  ìŠ¤ëƒ…ìƒ· ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
            return;
        }

        if (confirm(`v${versionNum} ìƒíƒœë¡œ ë³µêµ¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ? í˜„ì¬ ìˆ˜ì •ì¤‘ì¸ ë‚´ìš©ì€ ì‚¬ë¼ì§‘ë‹ˆë‹¤.`)) {
            // ìŠ¤ëƒ…ìƒ· ë°ì´í„°ë¥¼ í˜„ì¬ ë°ì´í„°ë¡œ êµì²´
            daily.manpower = JSON.parse(JSON.stringify(targetVersion.snapshot.manpower || []));
            daily.workSets = JSON.parse(JSON.stringify(targetVersion.snapshot.workSets || []));
            daily.assets = JSON.parse(JSON.stringify(targetVersion.snapshot.assets || { photos: [], drawings: [] }));
            
            // ë³µêµ¬ ê¸°ë¡ ì¶”ê°€
            daily.versions = daily.versions || [];
            daily.versions.push({
                ver: daily.versions.length + 1,
                time: new Date().toISOString(),
                type: 'rollback',
                desc: `v${versionNum}ìœ¼ë¡œ ë³µêµ¬ë¨` 
            });

            saveData();
            openDetail(siteKey, 'status'); // í™”ë©´ ìœ ì§€í•˜ë©° ê°±ì‹ 
            showToast(`v${versionNum} ìƒíƒœë¡œ ë³µêµ¬ë˜ì—ˆìŠµë‹ˆë‹¤.`);
            renderLogs();
        }
    }
    
    // íˆ¬ì…ì¸ì› ìˆ˜ì • ëª¨ë‹¬ ì—´ê¸°
    function editManpower(idx) {
        currentEditManpowerIndex = idx;
        const manpower = g_worklogs[g_currentSite].dailyData[g_currentDate].manpower || [];
        const m = manpower[idx];
        
        if (m && m.workers && m.workers.length > 0) {
            const worker = m.workers[0];
            document.getElementById('editWorkerName').value = worker.name || '';
            document.getElementById('editWorkHours').value = worker.hours || '';
        }
        
        const modal = document.getElementById('editManpowerModal');
        modal.style.display = 'block';
        
        setTimeout(() => {
            if (typeof lucide !== 'undefined' && lucide.createIcons) {
                lucide.createIcons();
            }
        }, 100);
    }
    
    function closeEditManpowerModal() {
        const modal = document.getElementById('editManpowerModal');
        modal.style.display = 'none';
    }
    
    function submitEditManpower() {
        const name = document.getElementById('editWorkerName').value.trim();
        const hours = parseFloat(document.getElementById('editWorkHours').value);
        
        if (!name) {
            showToast('ì‘ì—…ì ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”');
            return;
        }
        
        if (!hours || hours <= 0) {
            showToast('íˆ¬ì… ì‹œê°„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”');
            return;
        }
        
        const manpower = g_worklogs[g_currentSite].dailyData[g_currentDate].manpower || [];
        if (currentEditManpowerIndex >= 0 && manpower[currentEditManpowerIndex]) {
            manpower[currentEditManpowerIndex].workers = [{ name, hours }];
        }
        
        saveData();
        closeEditManpowerModal();
        openDetail(g_currentSite);
        showToast('íˆ¬ì…ì¸ì›ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
    }
    
    // ì‘ì—…ë‚´ìš© ìˆ˜ì • ëª¨ë‹¬ ì—´ê¸°
    function editWorkSet(idx) {
        currentEditWorkSetIndex = idx;
        const workSets = g_worklogs[g_currentSite].dailyData[g_currentDate].workSets || [];
        const ws = workSets[idx];
        
        // ì´ˆê¸°í™”
        editSelectedMember = '';
        editSelectedProcess = '';
        editSelectedType = '';
        document.getElementById('editCustomMember').value = '';
        document.getElementById('editCustomProcess').value = '';
        document.getElementById('editCustomType').value = '';
        
        // ê¸°ì¡´ ê°’ ì„¤ì •
        if (ws.member) {
            if (['ìŠ¬ë¼ë¸Œ', 'ê±°ë”', 'ê¸°ë‘¥', 'ê¸°íƒ€'].includes(ws.member)) {
                editSelectedMember = ws.member;
                // ì¹© í™œì„±í™”
                document.querySelectorAll('.edit-member-chip').forEach(chip => {
                    if (chip.textContent === ws.member) {
                        chip.style.background = 'var(--primary)';
                        chip.style.color = 'white';
                        chip.style.borderColor = 'var(--primary)';
                    }
                });
            } else {
                document.getElementById('editCustomMember').value = ws.member;
            }
        }
        
        if (ws.process) {
            if (['ê· ì—´', 'ë©´', 'ë§ˆê°', 'ê¸°íƒ€'].includes(ws.process)) {
                editSelectedProcess = ws.process;
                // ì¹© í™œì„±í™”
                document.querySelectorAll('.edit-process-chip').forEach(chip => {
                    if (chip.textContent === ws.process) {
                        chip.style.background = 'var(--primary)';
                        chip.style.color = 'white';
                        chip.style.borderColor = 'var(--primary)';
                    }
                });
            } else {
                document.getElementById('editCustomProcess').value = ws.process;
            }
        }
        
        if (ws.type) {
            if (['ì§€í•˜', 'ì§€ìƒ', 'ì§€ë¶•', 'ê¸°íƒ€'].includes(ws.type)) {
                editSelectedType = ws.type;
                // ì¹© í™œì„±í™”
                document.querySelectorAll('.edit-type-chip').forEach(chip => {
                    if (chip.textContent === ws.type) {
                        chip.style.background = 'var(--primary)';
                        chip.style.color = 'white';
                        chip.style.borderColor = 'var(--primary)';
                    }
                });
            } else {
                document.getElementById('editCustomType').value = ws.type;
            }
        }
        
        // ìœ„ì¹˜ ì •ë³´ ì„¤ì •
        if (ws.location) {
            document.getElementById('editBlock').value = ws.location.block || '';
            document.getElementById('editDong').value = ws.location.dong || '';
            document.getElementById('editFloor').value = ws.location.floor || '';
        }
        
        const modal = document.getElementById('editWorkSetModal');
        modal.style.display = 'block';
        
        setTimeout(() => {
            if (typeof lucide !== 'undefined' && lucide.createIcons) {
                lucide.createIcons();
            }
        }, 100);
    }
    
    function closeEditWorkSetModal() {
        const modal = document.getElementById('editWorkSetModal');
        modal.style.display = 'none';
        
        // ì¹© ì´ˆê¸°í™”
        document.querySelectorAll('.edit-member-chip, .edit-process-chip, .edit-type-chip').forEach(chip => {
            chip.style.background = 'white';
            chip.style.color = 'var(--text-main)';
            chip.style.borderColor = 'var(--border)';
        });
    }
    
    function selectEditMemberChip(button, value) {
        document.querySelectorAll('.edit-member-chip').forEach(chip => {
            chip.style.background = 'white';
            chip.style.color = 'var(--text-main)';
            chip.style.borderColor = 'var(--border)';
        });
        
        button.style.background = 'var(--primary)';
        button.style.color = 'white';
        button.style.borderColor = 'var(--primary)';
        
        editSelectedMember = value;
        document.getElementById('editCustomMember').value = '';
    }
    
    function selectEditProcessChip(button, value) {
        document.querySelectorAll('.edit-process-chip').forEach(chip => {
            chip.style.background = 'white';
            chip.style.color = 'var(--text-main)';
            chip.style.borderColor = 'var(--border)';
        });
        
        button.style.background = 'var(--primary)';
        button.style.color = 'white';
        button.style.borderColor = 'var(--primary)';
        
        editSelectedProcess = value;
        document.getElementById('editCustomProcess').value = '';
    }
    
    function selectEditTypeChip(button, value) {
        document.querySelectorAll('.edit-type-chip').forEach(chip => {
            chip.style.background = 'white';
            chip.style.color = 'var(--text-main)';
            chip.style.borderColor = 'var(--border)';
        });
        
        button.style.background = 'var(--primary)';
        button.style.color = 'white';
        button.style.borderColor = 'var(--primary)';
        
        editSelectedType = value;
        document.getElementById('editCustomType').value = '';
    }
    
    function submitEditWorkSet() {
        const customType = document.getElementById('editCustomType').value.trim();
        const type = customType || editSelectedType;
        
        const workSets = g_worklogs[g_currentSite].dailyData[g_currentDate].workSets || [];
        if (currentEditWorkSetIndex >= 0 && workSets[currentEditWorkSetIndex]) {
            workSets[currentEditWorkSetIndex].type = type;
            workSets[currentEditWorkSetIndex].location = {
                block: document.getElementById('editBlock').value.trim(),
                dong: document.getElementById('editDong').value.trim(),
                floor: document.getElementById('editFloor').value.trim()
            };
        }
        
        saveData();
        closeEditWorkSetModal();
        openDetail(g_currentSite);
        showToast('ì‘ì—…ë‚´ìš©ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
    }
    
    // íˆ¬ì…ì¸ì› ì¶”ê°€
    function addManpowerEntry() {
        const workerName = prompt('ì‘ì—…ì ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”:');
        if (!workerName) return;
        
        const hours = prompt('íˆ¬ì… ì‹œê°„ì„ ì…ë ¥í•˜ì„¸ìš”:', '8');
        if (!hours) return;
        
        const manpower = g_worklogs[g_currentSite].dailyData[g_currentDate].manpower || [];
        manpower.push({
            date: g_currentDate,
            workers: [{ name: workerName, hours: Number(hours) }]
        });
        
        g_worklogs[g_currentSite].dailyData[g_currentDate].manpower = manpower;
        saveData();
        openDetail(g_currentSite);
        showToast('íˆ¬ì…ì¸ì›ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.');
    }
    
    // íˆ¬ì…ì¸ì› ì‚­ì œ
    function deleteManpower(idx) {
        if (!confirm('ì´ íˆ¬ì…ì¸ì›ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
        
        const manpower = g_worklogs[g_currentSite].dailyData[g_currentDate].manpower || [];
        manpower.splice(idx, 1);
        
        saveData();
        openDetail(g_currentSite);
        showToast('íˆ¬ì…ì¸ì›ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
    }
    
    // ì‘ì—…ë‚´ìš© ì¶”ê°€
    function addWorkSetEntry() {
        // mainpage.htmlê³¼ ë™ì¼í•œ ì‘ì—… ì„¸íŠ¸ ì¶”ê°€ ë¡œì§
        const workSets = g_worklogs[g_currentSite].dailyData[g_currentDate].workSets || [];
        
        // ê¸°ë³¸ ë¶€ì¬ëª…ê³¼ ê³µì • ì„¤ì • (ì‘ì—…ì¼ì§€ ì¶”ê°€ì—ì„œ ì„¤ì •ëœ ê°’ ì‚¬ìš©)
        const defaultMember = selectedMember || 'ê¸°ë‘¥';
        const defaultProcess = selectedProcess || 'ê· ì—´';
        
        workSets.push({
            id: Date.now(),
            member: defaultMember,
            process: defaultProcess,
            type: '',
            location: { block: '', dong: '', floor: '' }
        });
        
        g_worklogs[g_currentSite].dailyData[g_currentDate].workSets = workSets;
        saveData();
        openDetail(g_currentSite);
        showToast('ì‘ì—…ë‚´ìš©ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.');
    }
    
    // ì‘ì—…ë‚´ìš© ìˆ˜ì •
    function editWorkSet(idx) {
        currentEditWorkSetIndex = idx;
        const workSets = g_worklogs[g_currentSite].dailyData[g_currentDate].workSets || [];
        const ws = workSets[idx];
        
        // ì´ˆê¸°í™”
        editSelectedType = '';
        document.getElementById('editCustomType').value = '';
        
        // ê¸°ì¡´ ê°’ ì„¤ì • (ì‘ì—…ìœ í˜•ë§Œ)
        if (ws.type) {
            if (['ì§€í•˜', 'ì§€ìƒ', 'ì§€ë¶•', 'ê¸°íƒ€'].includes(ws.type)) {
                editSelectedType = ws.type;
                // ì¹© í™œì„±í™”
                document.querySelectorAll('.edit-type-chip').forEach(chip => {
                    if (chip.textContent === ws.type) {
                        chip.style.background = 'var(--primary)';
                        chip.style.color = 'white';
                        chip.style.borderColor = 'var(--primary)';
                    }
                });
            } else {
                document.getElementById('editCustomType').value = ws.type;
            }
        }
        
        // ìœ„ì¹˜ ì •ë³´ ì„¤ì •
        if (ws.location) {
            document.getElementById('editBlock').value = ws.location.block || '';
            document.getElementById('editDong').value = ws.location.dong || '';
            document.getElementById('editFloor').value = ws.location.floor || '';
        }
        
        const modal = document.getElementById('editWorkSetModal');
        modal.style.display = 'block';
        
        setTimeout(() => {
            if (typeof lucide !== 'undefined' && lucide.createIcons) {
                lucide.createIcons();
            }
        }, 100);
    }
    
    // ì‘ì—…ë‚´ìš© ì‚­ì œ
    function deleteWorkSet(idx) {
        if (!confirm('ì´ ì‘ì—…ë‚´ìš©ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
        
        const workSets = g_worklogs[g_currentSite].dailyData[g_currentDate].workSets || [];
        workSets.splice(idx, 1);
        
        saveData();
        openDetail(g_currentSite);
        showToast('ì‘ì—…ë‚´ìš©ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
    }
    
    // ìì¬ ì¶”ê°€
    function addMaterialEntry() {
        const name = prompt('ìì¬ëª…ì„ ì…ë ¥í•˜ì„¸ìš”:');
        if (!name) return;
        
        const quantity = prompt('ìˆ˜ëŸ‰ì„ ì…ë ¥í•˜ì„¸ìš”:', '1');
        if (!quantity) return;
        
        const materials = g_worklogs[g_currentSite].dailyData[g_currentDate].materials || [];
        materials.push({
            name: name,
            quantity: Number(quantity),
            unit: 'ë§'
        });
        
        g_worklogs[g_currentSite].dailyData[g_currentDate].materials = materials;
        saveData();
        openDetail(g_currentSite);
        showToast('ìì¬ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.');
    }
    
    // ìì¬ ìˆ˜ì •
    function editMaterial(idx) {
        const materials = g_worklogs[g_currentSite].dailyData[g_currentDate].materials || [];
        const m = materials[idx];
        
        const name = prompt('ìì¬ëª…ì„ ì…ë ¥í•˜ì„¸ìš”:', m.worker);
        if (name === null) return;
        
        const quantity = prompt('ìˆ˜ëŸ‰ì„ ì…ë ¥í•˜ì„¸ìš”:', m.quantity);
        if (quantity === null) return;
        
        m.worker = name;
        m.quantity = Number(quantity);
        
        saveData();
        openDetail(g_currentSite);
        showToast('ìì¬ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
    }
    
  

    /* =============================
       ìë£Œì²¨ë¶€íƒ­(ëˆ„ì ) ì „ìš© í—¬í¼
       ============================= */
    function _ensureDay(siteKey, dateKey) {
        if (!g_worklogs[siteKey]) return null;
        const site = g_worklogs[siteKey];
        site.dailyData = site.dailyData || {};
        if (!site.dailyData[dateKey]) {
            site.dailyData[dateKey] = {
                date: dateKey,
                worklogList: [],
                workers: [],
                materials: [],
                memo: "",
                assets: { photos: [], drawings: [], confirmDoc: null }
            };
        }
        site.dailyData[dateKey].assets = site.dailyData[dateKey].assets || { photos: [], drawings: [], confirmDoc: null };
        site.dailyData[dateKey].assets.photos = site.dailyData[dateKey].assets.photos || [];
        site.dailyData[dateKey].assets.drawings = site.dailyData[dateKey].assets.drawings || [];
        return site.dailyData[dateKey];
    }

    function handleAttachmentMaterialSelectChange() {
        const sel = document.getElementById('materialSelect');
        const customBox = document.getElementById('customMaterialInput');
        if (!sel || !customBox) return;
        if (sel.value === 'custom') {
            customBox.classList.remove('hidden');
            setTimeout(() => {
                const inp = document.getElementById('customMaterialValue');
                if (inp) inp.focus();
            }, 0);
        } else {
            customBox.classList.add('hidden');
        }
    }

    function handleConfirmCustomMaterial() {
        const sel = document.getElementById('materialSelect');
        const valEl = document.getElementById('customMaterialValue');
        const customBox = document.getElementById('customMaterialInput');
        if (!sel || !valEl || !customBox) return;

        const v = (valEl.value || '').trim();
        if (!v) {
            showToast('ìì¬ëª…ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.');
            valEl.focus();
            return;
        }

        // ì¤‘ë³µ ì˜µì…˜ ë°©ì§€
        const exists = Array.from(sel.options).some(o => o.value === v);
        if (!exists) {
            const opt = document.createElement('option');
            opt.value = v;
            opt.textContent = v;
            // custom ë°”ë¡œ ì•ì— ì‚½ì…
            const customOpt = Array.from(sel.options).find(o => o.value === 'custom');
            if (customOpt) sel.insertBefore(opt, customOpt);
            else sel.appendChild(opt);
        }
        sel.value = v;

        valEl.value = '';
        customBox.classList.add('hidden');
    }

    function addMaterial() {
        const sel = document.getElementById('materialSelect');
        const qtyEl = document.getElementById('materialQty');
        if (!sel || !qtyEl) return;

        let name = sel.value;
        if (name === 'custom') {
            showToast('ìì¬ëª… ì§ì ‘ì…ë ¥ì„ í™•ì¸ í›„ ì¶”ê°€í•´ ì£¼ì„¸ìš”.');
            return;
        }
        name = (name || '').trim();
        const qty = Number(qtyEl.value || 0);

        if (!name) {
            showToast('ìì¬ë¥¼ ì„ íƒí•´ ì£¼ì„¸ìš”.');
            return;
        }
        if (!Number.isFinite(qty) || qty <= 0) {
            showToast('ìˆ˜ëŸ‰ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.');
            qtyEl.focus();
            return;
        }

        const day = _ensureDay(g_currentSite, g_currentDate);
        if (!day) return;

        day.materials = day.materials || [];
        day.materials.push({
            name,
            quantity: qty,
            unit: 'ë§'
        });

        saveData();
        openDetail(g_currentSite, g_currentTab);

        qtyEl.value = '';
        sel.value = 'NPC-1000';
        showToast('ìì¬ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.');
    }

    function deleteMaterialAt(dateKey, idx) {
        const site = g_worklogs[g_currentSite];
        if (!site || !site.dailyData || !site.dailyData[dateKey]) return;
        const day = site.dailyData[dateKey];
        day.materials = day.materials || [];

        if (idx < 0 || idx >= day.materials.length) return;

        if (!confirm('í•´ë‹¹ ìì¬ë¥¼ ì‚­ì œí• ê¹Œìš”?')) return;

        day.materials.splice(idx, 1);
        saveData();
        openDetail(g_currentSite, g_currentTab);
        showToast('ìì¬ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
    }

    function viewPhotoAt(dateKey, idx) {
        const site = g_worklogs[g_currentSite];
        const p = site?.dailyData?.[dateKey]?.assets?.photos?.[idx];
        if (!p) return;
        showPreviewModal(p.url, 'ì‚¬ì§„ ë¯¸ë¦¬ë³´ê¸°');
    }

    function togglePhotoStatusAt(dateKey, idx) {
        const site = g_worklogs[g_currentSite];
        const p = site?.dailyData?.[dateKey]?.assets?.photos?.[idx];
        if (!p) return;

        p.status = (p.status === 'before') ? 'after' : 'before';
        saveData();
        openDetail(g_currentSite, g_currentTab);
        showToast('ìƒíƒœê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.');
    }

    function replacePhotoAt(dateKey, idx) {
        const site = g_worklogs[g_currentSite];
        const day = site?.dailyData?.[dateKey];
        const p = day?.assets?.photos?.[idx];
        if (!p) return;

        const input = document.createElement('input');
        input.type = 'file';
        input.accept = 'image/*';
        input.onchange = (e) => {
            const file = e.target.files?.[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = () => {
                p.url = reader.result;
                p.fileName = file.name || p.fileName;
                p.uploadDate = new Date().toISOString().slice(0, 10);
                saveData();
                openDetail(g_currentSite);
                showToast('ì‚¬ì§„ì´ êµì²´ë˜ì—ˆìŠµë‹ˆë‹¤.');
            };
            reader.readAsDataURL(file);
        };
        input.click();
    }

    function deletePhotoAt(dateKey, idx) {
        const site = g_worklogs[g_currentSite];
        const arr = site?.dailyData?.[dateKey]?.assets?.photos;
        if (!arr || idx < 0 || idx >= arr.length) return;

        if (!confirm('í•´ë‹¹ ì‚¬ì§„ì„ ì‚­ì œí• ê¹Œìš”?')) return;

        arr.splice(idx, 1);
        saveData();
        openDetail(g_currentSite);
        showToast('ì‚¬ì§„ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
    }

    function clearAllPhotos() {
        const site = g_worklogs[g_currentSite];
        if (!site || !site.dailyData) return;

        if (!confirm('ì´ í˜„ì¥ì˜ ì‚¬ì§„ì„ ëª¨ë‘ ì‚­ì œí• ê¹Œìš”?')) return;

        Object.keys(site.dailyData).forEach(dk => {
            const day = site.dailyData[dk];
            if (day?.assets?.photos) day.assets.photos = [];
        });

        saveData();
        openDetail(g_currentSite);
        showToast('ì „ì²´ ì‚¬ì§„ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
    }

    function viewDrawingAt(dateKey, idx) {
        const site = g_worklogs[g_currentSite];
        const d = site?.dailyData?.[dateKey]?.assets?.drawings?.[idx];
        if (!d) return;
        showPreviewModal(d.url, 'ë„ë©´ ë¯¸ë¦¬ë³´ê¸°');
    }

    function toggleDrawingStatusAt(dateKey, idx) {
        const site = g_worklogs[g_currentSite];
        const d = site?.dailyData?.[dateKey]?.assets?.drawings?.[idx];
        if (!d) return;

        d.status = (d.status === 'complete') ? 'progress' : 'complete';
        saveData();
        openDetail(g_currentSite, g_currentTab);
        showToast('ìƒíƒœê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.');
    }

    function replaceDrawingAt(dateKey, idx) {
        const site = g_worklogs[g_currentSite];
        const d = site?.dailyData?.[dateKey]?.assets?.drawings?.[idx];
        if (!d) return;

        const input = document.createElement('input');
        input.type = 'file';
        input.accept = 'image/*';
        input.onchange = (e) => {
            const file = e.target.files?.[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = () => {
                d.url = reader.result;
                d.fileName = file.name || d.fileName;
                d.uploadDate = new Date().toISOString().slice(0, 10);
                saveData();
                openDetail(g_currentSite);
                showToast('ë„ë©´ì´ êµì²´ë˜ì—ˆìŠµë‹ˆë‹¤.');
            };
            reader.readAsDataURL(file);
        };
        input.click();
    }

    function deleteDrawingAt(dateKey, idx) {
        const site = g_worklogs[g_currentSite];
        const arr = site?.dailyData?.[dateKey]?.assets?.drawings;
        if (!arr || idx < 0 || idx >= arr.length) return;

        if (!confirm('í•´ë‹¹ ë„ë©´ì„ ì‚­ì œí• ê¹Œìš”?')) return;

        arr.splice(idx, 1);
        saveData();
        openDetail(g_currentSite);
        showToast('ë„ë©´ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
    }

    function clearAllDrawings() {
        const site = g_worklogs[g_currentSite];
        if (!site || !site.dailyData) return;

        if (!confirm('ì´ í˜„ì¥ì˜ ë„ë©´ì„ ëª¨ë‘ ì‚­ì œí• ê¹Œìš”?')) return;

        Object.keys(site.dailyData).forEach(dk => {
            const day = site.dailyData[dk];
            if (day?.assets?.drawings) day.assets.drawings = [];
        });

        saveData();
        openDetail(g_currentSite);
        showToast('ì „ì²´ ë„ë©´ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
    }


</script>
</body>
</html>