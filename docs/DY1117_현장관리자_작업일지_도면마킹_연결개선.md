'# DY1117 – 현장관리자 작업일지 × 도면마킹 연결 개선안

## 🎯 목표
- 작업자가 **작업일지 저장 → 도면 마킹 생성/연결**을 단일 흐름 안에서 끝낼 수 있도록 UX 단순화
- 현장/본사 관리자 모두가 **연결 상태를 즉시 파악**하고 재연결/해제 작업을 원화면에서 수행
- 도면 마킹 데이터 흐름을 통일하여 **복잡한 로컬스토리지·파라미터 의존** 제거

## 🧭 개선 방향 요약
1. **작성 흐름 통합**: 작업일지에서 “도면 마킹 추가” 버튼을 제공하고, 저장 전에는 비활성 툴팁으로 안내한다. 저장 이후에는 동일 패널에서 도면 선택→마킹→연결을 순차 실행한다.
2. **도면 선택 모듈 단순화**: 사이트/공정 기반 추천 도면 리스트 + 전체 검색 탭의 2단 구성으로 축소하고, 최근 사용 도면/연결 상태를 사이드 카드에 노출한다.
3. **연결 상태 시각화 표준화**: 작업일지 상세/목록에서 “도면 마킹” 카드 한 곳에서 연결 수·썸네일·연결/해제 버튼을 일관되게 제공하고, 연결이 없으면 CTA만 보여준다.
4. **마킹 저장 로직 정리**: `worklog.attachments.drawings`를 단일 데이터 소스로 사용하고, 마킹 페이지는 `worklogId` 하나만 필요하게 만든다. 저장 API가 linked_worklog_ids 갱신을 책임진다.
5. **동기화 피드백 강화**: 마킹 저장 토스트에 “작업일지로 이동/연결” CTA를 넣고, 리스트 카드에 “도면 연결됨” 배지를 추가해 상태를 한눈에 확인한다.

## ⚙️ 구현 방안

### 1. UI 구조 조정
- `modules/mobile/components/work-log/WorkLogModal.tsx`
  - 저장 상태(`mode !== 'create' && workLog.id`)일 때만 “도면 마킹 추가” 버튼 활성화.
  - 버튼 클릭 시 새 섹션을 확장하여 `DrawingBrowser`의 간소화 버전(추천 + 전체 검색)을 렌더링하고, 선택 후 `SharedMarkupEditor` 모달을 띄움.
- `app/mobile/worklog/[id]/TaskDetailPageClient.tsx`
  - 하단에 `MarkupCard` 컴포넌트 추가: 연결된 도면 썸네일, “도면 열기”, “연결 해제”, “새 도면 연결” 버튼 제공.
  - 연결 없음 시 “도면 마킹이 없습니다” 메시지 + CTA만 노출.

### 2. 도면 선택 데이터 흐름
- `modules/mobile/components/markup/DrawingBrowser`
  - props에 `worklogSiteId`, `workProcesses` 등을 받아 초기 API 요청에 포함 → 추천 리스트 (예: `/api/unified-documents?siteId=...&process=...`).
  - 최근 사용 도면 목록을 `GET /api/markup-documents?recent=1&siteId=...`로 가져와 사이드에 노출.
  - 선택 시 `onSelect(drawing)` 호출만 하고, 저장/연결 로직은 상위에서 처리.

### 3. 마킹 생성/연결 로직
- `app/mobile/markup-tool/page.tsx`
  - 진입 파라미터를 `worklogId` 하나로 축소(필요 시 siteId fetch). 기존 로컬스토리지 복구 로직 제거.
  - 저장 함수에서:
    1. `/api/markup-documents` POST/PUT 후, 응답에 `id`와 `linked_worklog_ids` 반환.
    2. `await fetch('/api/worklogs/{worklogId}/attachments', { method: 'POST', body: { markupDocumentId: savedDoc.id }})` 로 작업일지에 첨부로 등록.
    3. 토스트에 “연결 완료 · 작업일지 열기” CTA 포함.

### 4. API 및 데이터 모델
- `app/api/markup-documents/route.ts`
  - linked_worklog_ids 파라미터를 optional로 허용하되, 요청에 worklogId가 있다면 서버에서 자동으로 배열을 관리.
- `app/api/mobile/worklogs/[id]/attachments/route.ts` (신규)
  - body: `{ markupDocumentId: string, action: 'attach' | 'detach' }`
  - DB의 attachments JSON 업데이트 + activity 로그 남김.
- 기존 `worklog.attachments.drawings`/`detail.attachments.drawings`를 DB/응답에서 동일 구조로 유지하여 모든 화면이 해당 데이터를 사용.

### 5. 피드백 & 상태 표기
- 작업일지 목록 카드(`modules/worker-site-manager/pages/WorkLogHomePage.tsx`, `modules/mobile/components/worklogs/WorkLogCard.tsx`)
  - `hasDrawings` 여부를 표시하는 배지/아이콘 추가.
- 마킹 저장 토스트:
  ```ts
  toast.success('도면 마킹 저장 완료', {
    action: {
      label: '작업일지 보기',
      onClick: () => router.push(`/mobile/worklog/${worklogId}`),
    },
  })
  ```

## ✅ 기대 효과
- 작업자는 저장 후 즉시 동일 화면에서 도면을 선택·생성·연결할 수 있어 컨텍스트 전환 감소.
- 관리자/작업자 모두 작업일지 카드에서 도면 연결 상태를 직관적으로 파악 가능.
- 로컬스토리지/복잡한 URL 조합 제거로 유지보수 단순화, API 주도형 구조로 안정성 향상.
