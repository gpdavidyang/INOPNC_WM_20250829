# DY1024 자재관리 – 모바일 현장관리자 화면 개선 계획

문서 목적: DY1015/1017 요구사항에 따라 “현장관리자 화면 > 현장정보 > 자재 재고관리” 석션을 단일 자재(NPC-1000) 기반에서 다품목 자재관리로 일반화하고, 역할 기반 접근과 데이터 계약을 정리한다.

## 1) 배경과 목표

- 단일 자재 중심(NPC-1000) UI/로직을 다품목 기준으로 확장
- 현장관리자/작업자: 재고 조회 + 입고요청에 집중, 생산·출고·결제는 비노출
- 파트너(소속사): 자재관리 섹션 비노출(UI Track + RLS)
- 코드 내 NPC 하드코딩 제거, 공통 액션·타입으로 정리

참조 문서:

- docs/DY1015\_자재관리개선구현계획안.md
- docs/DY1015\_자재관리변경요구사항정리.txt
- docs/DY1017*자재관리변경요구사항정리*모바일.txt

## 2) 현행 이슈 요약

- NPC 전용 섹션/필터 하드코딩
  - modules/mobile/components/site/SiteInfoPage.tsx: NPC 전용 앵커(`npc-inventory-section`), 텍스트/버튼
  - modules/mobile/components/site/SiteInfoPage.tsx: NPC 코드 필터(`materials?.code === 'NPC-1000'`)
  - app/actions/npc-materials.ts: `.like('materials.code', 'NPC-%')` 등 NPC 전용 쿼리

## 3) 변경 범위(요약)

- 화면(UI): SiteInfoPage 내 “자재 재고관리” 섹션 전체를 다품목 기준으로 재구성
- 서버 액션: npc 전용 액션을 범용 materials 액션으로 대체/통합
- 타입/리포지토리: 도메인 타입/레포 유틸 정리(필요 시 신설)

## 4) 상세 UI 설계

섹션 식별/문구 일반화

- 섹션 id: `materials-inventory-section` (기존 `npc-inventory-section` 교체)
- 타이틀: “자재 재고관리” (NPC 문구 제거)

필터/선택 UX

- 현장 선택: 기존 동작 유지(사용자 배정 현장)
- 자재 선택: “전체/자재별” CustomSelect 필터 추가
- 기간(선택): 최근/이번달 토글 또는 간단 날짜 필터

지표(KPI)

- 선택 자재 기준 입고/사용/재고 지표 노출
- “전체” 선택 시 합계 + 저재고 카운트(배지) 표시

리스트/카드

- 자재별 카드: 자재명/규격·단위, 현재/최소재고, 상태 배지(정상/부족/없음)
- 정렬: 기본은 재고상태(부족/없음 우선) → 자재명

행동 버튼(권한 가드 포함)

- 로그 보기: 자재별/전체 입출고 로그 모달
- 자재 요청: 자재/수량/단위/메모 입력 폼 → 요청 생성
- 입고 기록: 현장관리자/작업자에서는 비노출 또는 비활성(정책 확정 시 적용)

접근 제어/빈 상태

- 파트너(role=partner): 섹션 비노출(조건부 렌더링)
- 데이터 없음: “등록된 재고가 없습니다/필터를 변경하세요” 안내

접근성/스타일

- 기존 카드/모달 패턴 유지, aria-label/role 속성 유지 및 명확화

## 5) 서버 액션/데이터 계약(범용화)

파일 정리 제안

- 기존: app/actions/npc-materials.ts (NPC 전용)
- 변경: app/actions/materials-inventory.ts (범용)

제공 함수(예시 시그니처)

```ts
// 현장 목록(사용자 배정) – 기존 함수 유지/이관
export async function getSitesForMaterials(): Promise<{
  success: boolean
  data: Array<{ id: string; name: string }>
  error?: string
}>

// 현장별 재고 요약/상세
export async function getSiteMaterialInventory(params: {
  siteId: string
  materialId?: string // 없으면 전체 요약
}): Promise<{ success: boolean; data: { inventory: any[]; summary: any } | null; error?: string }>

// 입출고 로그(최신순)
export async function getSiteMaterialTransactions(params: {
  siteId: string
  materialId?: string
  limit?: number // 기본 100
}): Promise<{ success: boolean; data: any[]; error?: string }>

// 입고요청 생성
export async function createMaterialRequest(params: {
  siteId: string
  materialId: string // materialCode 기반 조회 제거하고 id 기반으로 통일 권장
  qty: number
  unitId?: string
  notes?: string
}): Promise<{ success: boolean; data?: any; error?: string }>
```

쿼리 가이드

- `material_inventory`: (site_id, material_id) 기준 재고 집계 사용
- `material_transactions`: site_id + material_id(선택) + 기간/limit
- `materials`: 자재 메타(단위/코드/이름/규격)
- `material_requests`/`material_request_items`: 요청 생성/조회 경로

성능 고려

- 서버 컴포넌트에서 1차 데이터 주입, 클라이언트에서는 필터 변경 시 경량 재호출
- 인덱스 활용: `(site_id, material_id)`, `(transaction_date)`

## 6) 권한/노출 정책(요지)

- 현장관리자/작업자: 재고 조회, 입고요청 생성 가능
- 생산/출고/결제: 본 섹션 비노출(별도 화면/역할에서 처리)
- 파트너: 섹션 비노출 + 데이터 접근 차단(RLS)
- UI Track + Supabase RLS 이중 보호(현행 정책 준수)

## 7) 단계별 적용(롤아웃)

1단계: 범용 액션 작성/치환

- npc 전용 like 필터 제거 → materialId/조건 파라미터화
- 신규 파일 `app/actions/materials-inventory.ts` 추가, SiteInfoPage에서 교체 사용

2단계: UI 섹션 교체/일반화

- 섹션 id/라벨 교체, 필터/지표/리스트/모달 일반화
- “입고요청” 폼에서 자재 선택·수량·단위 입력 지원

3단계: 사용성·성능 보강

- 기간 필터, 저재고 정책(최소재고 기준) 반영
- 빈 상태/오류 처리, 로딩 상태 강화

4단계: NPC 잔여 레거시 제거

- 앵커/주석/스타일 등 NPC 전용 코드/텍스트 정리

## 8) 영향도/파일 변경 포인트

- modules/mobile/components/site/SiteInfoPage.tsx
  - 섹션 앵커/라벨 일반화, NPC 전용 코드 제거, 조건부 렌더링(파트너 비노출)
- app/actions/npc-materials.ts → app/actions/materials-inventory.ts
  - 함수명/파라미터/쿼리 범용화, materialId 기반 계약으로 정리
- lib/types/materials.ts, lib/repos/materials.ts (필요 시)
  - 도메인 타입/레포 유틸 분리 및 재사용화

## 9) 테스트 시나리오(필수)

- 현장관리자: 자재 선택 → 재고 지표/리스트 표시 → 입고요청 생성 → 관리자 탭 반영 확인
- 작업자: 동일 플로우 간단 검증
- 파트너: 섹션 비노출 및 직접 접근 차단 확인
- 데이터 미보유 현장: 빈 상태/가이드 문구 노출 확인
- 성능: 자재 100건/로그 500건 수준에서 초기 로드/필터 변경 응답 확인

## 10) 리스크/결정 필요사항

- 최소재고/저재고 기준값 출처: 자재별 설정 vs. 공통 기본값
- “입고 기록” 버튼 노출 정책(현장관리자/작업자): 비노출로 확정 여부
- 가격/금액 정보: 현장관리자 화면에서 비노출 유지 여부
- 테이블 명칭 통일: `material_requests/*` vs. 문서상의 `incoming_requests` – 레포/액션 레이어에서 흡수

---

본 계획안에 따라 1단계(액션 범용화 + 섹션 교체)부터 구현을 진행하고, 검수 후 단계적으로 고도화하겠습니다.
