# DY1007 · 시공업체(=소속사) × 공급 데이터 구분 + 가입요청 ‘미지정’ 플로우 개선 구현안

작성일: 2025-10-07
담당: 시스템관리(Administrator), 인증/계정 도메인

## 1) 배경/목표

- 용어 통일: “시공업체=소속사(본 시스템의 귀속 회사)”를 동일 개념으로 일관 표기/동작(UI 기준).
- 공급업체(자재/물류/인력 등)와 시공업체(소속사) 개념을 명확히 분리해 혼선 제거.
- 가입요청 시 신청자가 소속사를 모르는 경우를 대비해 ‘미지정’ 옵션을 제공하고, 최종 소속사 지정은 관리자 승인 단계에서 하도록 프로세스 개선.

## 2) 용어/개념

- 시공업체(=소속사): 본 시스템의 주체 회사. 현장(sites)을 총괄. 사용자(profiles)는 반드시 1개의 시공업체에 귀속.
  - DB Canonical: `organizations` 테이블
- 공급업체: 자재/물류/인력 등 공급 목적의 업체. 현장 접근/운영 권한과는 별개.
  - DB Canonical: `partner_companies` (company_type으로 세분화)

## 3) 요구사항(요약)

- 가입요청 화면: 소속사(시공업체) 선택 필드에 ‘미지정’(none) 옵션 제공.
- 승인(관리자/시스템관리자): 상세 화면에서 소속사가 ‘미지정’인 경우 필수로 선택하도록 강제 후 승인 가능.
- UI 텍스트/도움말:
  - “소속사(시공업체)는 동일 의미입니다. 승인 전까지 ‘미지정’으로 제출 가능합니다.”

## 4) 데이터 모델/정책

- `signup_requests`
  - `organization_id` 컬럼을 nullable로 유지/추가(없으면 마이그레이션). 미지정 시 NULL 저장.
  - (선택) `organization_name_candidate` VARCHAR NULL: 신청자가 자유 입력한 회사명이 있을 때 보조 참고값으로 보관.
- `profiles`
  - `organization_id` NOT NULL(본 시스템 정책). 승인 시 반드시 설정.
- 제약/정책
  - 승인 시 `signup_requests.organization_id IS NOT NULL` 또는 요청바디에 `organizationId`가 함께 전달되어야 함.
  - 관리자 상세 화면에서 ‘미지정’ 상태 승인 시도 → 에러 토스트/유효성 메시지.

## 5) API 변경(제안)

- 가입요청 제출: `POST /api/auth/signup-request`
  - Body: { fullName, phone, email, organizationId?: string | null }
  - organizationId 누락/‘none’/null → DB에는 NULL 저장(‘미지정’)
- 가입요청 승인: `POST /api/admin/signup-requests/:id/approve`
  - Body: { organizationId?: string, … }
  - 서버 로직: `organizationId || request.organization_id` 둘 중 하나라도 값이 있어야 승인. 없으면 400/422 반환.
  - 승인 성공 시 `profiles.organization_id` 세팅 필수, 환영 메일 발송(기 구현 연동).
- 가입요청 수정: `PATCH /api/admin/signup-requests/:id`
  - Body에 `organization_id` 갱신 허용(관리자가 상세에서 ‘미지정’→실제 소속사 선택 시 반영).

## 6) 화면/UX 설계

- 가입요청 화면(app/auth/signup-request/page)
  - “소속사(시공업체)” 셀렉트: 목록=organizations, + ‘미지정’ 옵션(value='none')
  - 안내문: “소속사가 불확실하면 ‘미지정’으로 제출하고, 관리자 승인 단계에서 지정됩니다.”
- 가입요청 상세(app/dashboard/admin/signup-requests/[id])
  - 상단 상태 박스 + 우측 액션: 저장, 승인, 거절
  - 소속사 필드: organizations 셀렉트(필수). 값이 null/none이면 ‘미지정’으로 표시
  - 승인 클릭 시 검사: 미지정이면 ‘소속사를 선택해주세요’ 경고 후 승인 차단
- 사용자 상세(app/dashboard/admin/users/[id])
  - “가입요청에서 생성됨” 표기 + 소속사 표시(이미 구현된 표기 유지)

## 7) 마이그레이션 계획

- 스키마(필요 시)
  - ALTER TABLE signup_requests ADD COLUMN organization_id UUID NULL REFERENCES organizations(id);
  - (옵션) ALTER TABLE signup_requests ADD COLUMN organization_name_candidate VARCHAR(255) NULL;
- 백필(있다면)
  - 기존 요청 중 회사 후보값이 시공업체/조직명에 매칭되면 organization_id 맵핑(수작업/관리 도구 제공)
- 롤백
  - UI: ‘미지정’ 옵션 숨김
  - 승인 API: organizationId 필수화 해제(단, profiles.organization_id NOT NULL 정책 때문에 권장하지 않음)

## 8) 보안/권한/리스크

- 권한: 승인 API는 관리자/시스템관리자만 허용(기 구현 그대로). 승인 시 조직 접근권한 검증 포함.
- 리스크: 신청자가 잘못된 소속사로 제출 → 상세에서 관리자 정정 가능.
- 스팸/남용: find-id/status/resend 등 인증 연계 API는 레이트리밋 적용(Phase 3 구현됨).

## 9) 단계별 로드맵

- Phase A (UI/문구/옵션)
  - 가입요청 화면: organizations 로딩 + ‘미지정’ 옵션 추가
  - 상세 화면: 소속사 셀렉트/검증 표기 강화(미지정 시 승인 차단)
  - 승인 API: organizationId 또는 request.organization_id 중 하나 필수 검증 추가
- Phase B (데이터 정합/운영)
  - signup_requests.organization_id 도입(없다면)
  - 기존 요청 백필/정리
  - 관리자 공지/문서화(소속사=시공업체 통일 안내)
- Phase C (선택)
  - 가입요청 리스트 필터: ‘미지정 소속사’ 빠른 필터 추가
  - 승인 모달에서 조직 자동 추천(이메일 도메인/휴대폰 앞자리 등 휴리스틱)

## 10) 수용 기준(Done)

- 가입요청 화면에 ‘미지정’ 옵션이 제공되고 제출 가능
- 상세 화면에서 소속사 미지정일 때 승인 차단 및 유효성 메시지 노출
- 승인 성공 시 사용자 프로필에 organization_id가 정확히 저장됨
- 관련 문구/도움말이 “소속사(시공업체)=동일”임을 명확히 설명

## 11) 추가 제안

- 메뉴/타이틀 통일(별도 문서 DY1007*가입요청관리*사용자관리*로그인*연계개선.md 참고)
  - “거래처 관리” → “시공업체(소속사) 관리”
  - UI에서는 공급업체 관리 메뉴 비노출(혼선 제거), 운영에서만 관리
- 장기: 역할 문자열 리네이밍(내부 role 값은 점진적 마이그레이션), DB View 별칭 도입(construction_companies)

---

본 문서는 ‘미지정’ 소속 가입요청을 안전하게 수용하고, 승인 단계에서 소속을 확정하도록 하여 사용자/시스템 혼선을 제거하는 것을 목표로 한다. 이 구현은 기존 스키마/권한 정책과 충돌하지 않으며, 단계적 적용이 가능하다.
