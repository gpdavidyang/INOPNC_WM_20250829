# INOPNC 본사 관리자 – 현장 상세 `사진` 탭 개선안 (DY1103)

작성일: 2025-11-03  
작성자: Admin UX Squad  
대상 화면: `/dashboard/admin/sites/[id]` → `사진` 탭

---

## 1. 배경 및 문제 인식

- 작업자/현장관리자가 모바일 작업일지에서 업로드한 **보수 전·보수 후 사진**을 본사 관리자가 한눈에 비교하기 어렵다.
- 현행 `사진` 탭은 단일 그리드 + 날짜 필터만 제공해 **전/후 구분, 묶음 전환, 일괄 작업**이 불가하다.
- 사진대지(사진대지 문서/photo grid) 생성 경로는 존재하지만, 현장별 사진대지 목록/상태를 확인하고 **관리 화면으로 이동**하는 흐름이 부족하다.
- 사진/사진대지 데이터는 이미 Supabase Storage + `daily_reports` JSON 필드에 축적되어 있어, UI/서버 계층을 개선하면 빠른 고도화가 가능하다.

## 2. 개선 목표

1. **비교 중심 뷰**: 보수 전/후 사진을 명확히 구분하고, 빠르게 전환·비교 가능.
2. **운영 편의성**: 사진 묶음 단위로 미리보기, 삭제, 구분 변경, 추가 업로드를 제공.
3. **문서 연계 강화**: 현장 사진 기반으로 사진대지 관리 메뉴 이동, 생성, 기존 사진대지 리스트 조회를 한 화면에서 처리.
4. **데이터 일관성**: 기존 `daily_reports`(추가 사진 JSON), Storage 파일, 사진대지 자료와 호환 유지.
5. **모바일-본사 싱크**: 작업자 앱 데이터와 실시간으로 정합성 유지.

## 3. 요구사항 요약

- 전/후 사진을 **탭 혹은 2열 레이아웃**으로 동시에 노출.
- 각 사진 카드에서: 확대 미리보기(모달/Lightbox), 전↔후 전환, 삭제, 대표/메모 표시, 원본 작업일지 이동.
- 다중 선택 > 일괄 삭제/구분 변경/사진대지 추가 항목에 포함.
- **관리자 업로드 사진도 반드시 특정 작업일지에 귀속**(일자/보고서 선택) → 후속 동기화 자동 반영.
- 사진대지 섹션: 현장 사진대지 리스트, 상태/작성일, 사진대지 관리 페이지로 이동 버튼, 새 사진대지 생성 CTA.
- 필터: 날짜, 작업일지, 업로더(작업자/관리자), 공종(있을 경우), 검색(메모/파일명).
- API는 Supabase Storage + `daily_reports.additional_{before,after}_photos`와 싱크, 관리자 액션 기록.

## 4. 화면 구조 제안

### 4.1 레이아웃

```
┌────────────────────────────────────────────┐
│ 상단 필터 바                               │
│ - 날짜(단일/범위), 작업일지, 업로더, 검색  │
│ - [사진대지 관리] 버튼(우측)               │
├────────────────────────────────────────────┤
│ 전/후 탭 또는 2열                         │
│  ┌──────────────┬──────────────┐            │
│  │ 작업 전(Before) │ 작업 후(After) │        │
│  │ 카드 그리드, Lazy load           │        │
│  │ - 사진, 메타(일자/작성자/메모)   │        │
│  │ - 액션: 미리보기, 전↔후, 삭제,   │        │
│  │         작업일지 링크, 선택 체크 │        │
│  └──────────────┴──────────────┘            │
│  선택 시 하단 바: [전↔후], [삭제], [사진대지에 추가] │
├────────────────────────────────────────────┤
│ 사진 업로드 섹션 (선택 구현)              │
│ - 파일 업로드 + 메모 + 날짜 + 유형 + 작업일지 지정 │
├────────────────────────────────────────────┤
│ 사진대지 섹션                             │
│ - 리스트(제목, 행×열, 상태, 생성일, 액션) │
│ - CTA: [사진대지 관리로 이동], [새 사진대지 만들기] │
└────────────────────────────────────────────┘
```

### 4.2 상단 CTA

- `사진대지 관리` 버튼: 신규 페이지 `/dashboard/admin/photo-sheets?site_id={id}` (기존 경로 정비 필요).
- `새 사진대지 생성` 버튼: `사진대지 관리` 페이지 내 생성 플로우로 연결.

## 5. 데이터 설계 및 동기화

### 5.1 소스 데이터

- `daily_reports` 테이블
  - `before_photos`, `after_photos`: 구형(단일 구조), 참고만.
  - `additional_before_photos`, `additional_after_photos`: JSON 배열(현재 주 사용처).
    - 속성: `url`, `description`, `photo_type`, `upload_order`, `uploaded_at`, `uploaded_by`, `daily_report_id`(신규 필드 강제), `storage_path`.
- Supabase Storage 버킷 `daily-reports` 등: 파일 경로 `/sites/{siteId}/daily-reports/{reportId}/{before|after}/...`.
- 사진대지: `photo_sheets`(가칭) 테이블 + Storage.

### 5.2 통합 View 제안

- 신규 뷰/함수 `admin_site_photos(site_id)`:
  - daily_reports 조인 → `jsonb_array_elements`로 사진 flatten.
  - 컬럼: `photo_id`, `site_id`, `daily_report_id`, `work_date`, `photo_type`, `url`, `description`, `uploaded_by`, `uploaded_at`, `storage_path`, `source`(`additional`/`primary`), `member_name`, `process_type`.
  - `photo_id`는 `md5(site_id || report_id || url || upload_order)` 등으로 생성.
- 필요 시 Materialized View + Trigger로 성능 개선.

### 5.3 사진대지 참조

- `photo_sheets` 테이블
  - 필수 컬럼: `id`, `site_id`, `title`, `rows`, `cols`, `orientation`, `status`, `created_at`, `created_by`.
  - 확장: `linked_photo_ids` (JSONB) → 사진대지 구성 사진 ID 저장, 수정 시 비교 가능.

## 6. Storage 경로 정책

- **파일 이동 강제**: 전↔후 유형 변경 시 Storage 내 경로도 `/before/` ↔ `/after/` 사이로 이동.
- 이동 절차: Storage `moveObject` → DB JSON path 업데이트 → 감사 로그 기록.
- 삭제 시에도 Storage 삭제 + JSON 제거를 원자적으로 처리.

## 7. API / 서버 액션 설계

| 목적                 | 경로/함수                                       | 메서드 | 설명                                                             |
| -------------------- | ----------------------------------------------- | ------ | ---------------------------------------------------------------- |
| 사진 목록 조회       | `GET /api/admin/sites/{id}/photos`              | GET    | 필터(날짜/업로더/유형/작업일지) 적용, before/after 동시 반환.    |
| 사진 유형 변경       | `PATCH /api/admin/sites/{id}/photos/{photoId}`  | PATCH  | `photo_type` 전환 + Storage 경로 이동 + JSON 업데이트.           |
| 사진 삭제            | `DELETE /api/admin/sites/{id}/photos/{photoId}` | DELETE | Storage 파일 + JSON에서 제거 (soft delete 로그).                 |
| 사진 추가 업로드     | `POST /api/admin/sites/{id}/photos`             | POST   | 파일 업로드, **반드시 `daily_report_id` 지정**, 메타데이터 저장. |
| 사진대지 목록        | `GET /api/admin/sites/{id}/photo-sheets`        | GET    | 현장 사진대지 목록, 정렬/필터 지원.                              |
| 사진대지 관리 페이지 | `/dashboard/admin/photo-sheets`                 | GET    | 신규 SSR 페이지, 사이트별 사진대지 CRUD.                         |

보안/권한: `withAdminAuth` + 조직 제한(`requireRestrictedOrgId`) 적용, Storage 작업은 서비스 키 사용.

## 8. 프론트엔드 구현 전략

### 8.1 상태 관리

- `SiteDetailTabs` 내 `photos` 섹션을 전용 컴포넌트 `SitePhotosPanel`로 리팩토링.
- 데이터 패칭: React Query(`useSitePhotos`) + optimistic update 패턴.
- 선택 상태 `selectedPhotoIds` + 하단 액션 바 컴포넌트화.
- 라이트박스: 기존 공통 뷰어(`PhotoPreviewDialog`) 확장 혹은 신규 구성.

### 8.2 UX 동선

- 카드 클릭 → 미리보기.
- 하단 액션 바:
  - `보수 전으로 이동` / `보수 후로 이동` (선택된 사진). Storage 이동 포함.
  - `삭제` → Confirm 모달.
  - `사진대지에 추가` → 사진대지 선택 모달(기존 `PhotoSheetActions` 확장).
- 업로드: Drag & Drop + 작업일지/유형 선택 + 메모. 업로드 후 목록 즉시 새로고침.

### 8.3 사진대지 섹션 개선

- 테이블 → `DataTable` 컴포넌트로 통일, 정렬/필터(상태, 작성자).
- 각 행 액션: `미리보기`, `편집`, `PDF 다운로드`, `삭제`. (`PhotoSheetActions` 확장).
- `사진대지 관리` 버튼 → 신규 페이지로 이동하여 전체 관리(필터, 대량 작업) 수행.

## 9. 데이터 일관성 & 마이그레이션

1. 관리자 업로드 사진 → **선택된 작업일지 `daily_report_id` 필수**. 작업일지 없는 경우 업로드 불가.
2. `photo_type` 전환 시 Storage 이동 & JSON 업데이트를 트랜잭션 수준으로 처리.
3. 기존 `before_photos`/`after_photos` 데이터를 `additional_*` 구조로 이관(마이그레이션 스크립트).
4. 관리자 업로드 사진은 `admin_uploaded` 플래그 부여 → 모바일 앱에서도 동일 데이터로 노출.
5. 감사 로그: `audit_logs` 또는 신규 `photo_activity_logs` 테이블에 기록.

## 10. 모바일 앱 연동

- 모바일 앱(작업자/현장 관리자)은 `daily_reports` JSON 필드 기반으로 이미 사진을 로드함 → 위 구조 확장 시 자동 반영.
- 관리자 전환(전↔후, 삭제, 업로드) 이후 모바일 앱에도 동일 결과가 즉시 반영되도록 API 응답 캐시 무효화 정책 점검.
- 필요 시 FCM/실시간 동기화(선택)로 현장 단말에 갱신 알림 제공.

## 11. 테스트 계획

- 단위:
  - API 입력 검증(필터 조합, 권한 제한), Storage 이동/삭제 로직.
  - 관리자 업로드 → 작업일지 귀속 검증.
- 통합:
  - `GET /photos` → 필터 조합, 페이징.
  - `PATCH`/`DELETE`/`POST` → JSON/Storage 동시 업데이트 및 감사 로그 확인.
- E2E (Playwright):
  1. 현장 상세 → 사진 탭 로드 → 전/후 탭 전환.
  2. 사진 선택 → 보수 후로 이동 → UI/백엔드 반영 확인.
  3. 관리자 업로드 → 특정 작업일지 선택 → 목록 반영.
  4. 사진대지 관리 버튼 클릭 → 신규 페이지 이동 확인.
  5. 사진대지 리스트에서 PDF 다운로드/편집 실행.

## 12. 단계별 롤아웃 제안

1. **Phase 1 – API/데이터 정비**
   - `/photos` CRUD API 구현, Storage 이동/삭제/업로드 로직 확립.
   - `admin_site_photos` 뷰 + 마이그레이션 반영.
2. **Phase 2 – 신 UI 도입**
   - `SitePhotosPanel` 교체, 다중 선택/액션, Lightbox/업로드 구현.
   - 사진대지 섹션 DataTable화 및 신규 `사진대지 관리` 페이지 연결.
3. **Phase 3 – 모바일 동기화 강화**
   - 모바일 앱 캐시 무효화/실시간 알림(선택) 적용, QA 진행.
4. **Phase 4 – 고급 기능(선택)**
   - 태그/AI 분류, 자동 전후 매칭, 보고서 다운로드 템플릿 개선.

## 13. 결정 사항 요약

- 관리자 업로드 사진은 **반드시 작업일지에 귀속**.
- 전↔후 전환 시 **Storage 경로 이동** 포함.
- **신규 `사진대지 관리` 페이지**를 관리자 대시보드에 추가.
- **모바일 앱과 데이터 동기화**는 필수, 캐시 무효화/알림으로 보강.
- **다국어 지원은 제외**(한국어 UI 기준 유지).

---

위 개선안을 바탕으로 UI 목업/프로토타입 작성 후 개발에 착수한다. 필요한 추가 요구사항은 제품팀과 협의 예정.
