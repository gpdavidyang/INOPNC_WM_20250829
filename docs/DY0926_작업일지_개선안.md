# DY0926 작업일지 개선안 (현장관리자 화면)

본 문서는 dy_memo/new_image_html_v3.0/inopnc-page/public/raw/task.html 요구 레퍼런스를 분석하여, 현 시스템의 구현 상태와 격차를 정리하고, 반영 계획(설계/개발/배포)을 제안합니다.

---

## 1) 요구 레퍼런스(task.html) 핵심 정리

- 상단 탭 네비게이션(3분할)
  - 작업일지 / 출력현황 / 급여현황 탭. 고정 헤더 하단 라인 탭, 활성 탭 하이라이트.
- 검색·필터 UX
  - 검색바(확장 애니메이션, ESC 초기화, Clear, Cancel), 현장/년월(2개 Select), 상태/배지.
- 작업일지 리스트(카드)
  - 현장, 작성자, 일자, 위치(블럭/동/호), 공정/유형, 진행률, 첨부(사진/도면/확인서/기타) 개수, 상태 배지.
  - 클릭 시 풀스크린 상세 뷰 호출. 더보기/무한 스크롤.
- 상세(Fullscreen) + 문서 탭
  - 기본정보(현장명/주소/부재명/공정/유형/블럭·동·층), 문서 탭(사진대지/진행도면/완료확인서/기타), 줌(+/−/100%), 탭 닫기, PDF 저장, 공유, 드래그&드롭 업로드.
- 캘린더 뷰
  - 월간 그리드(요일 헤더, 월 이동, 일자 호버/선택), 일자별 작업일지 수/상태 요약(제출/임시/전체), 리스트 연동.
- 통계(출력현황)
  - 출근일수/방문현장수/누적공수 카드(컬러 토큰, 다크모드 포함).
- 급여현황
  - 3개 배지(기간 합계), 세율 입력(자동/수동 토글), 인원 선택 칩(chips), 급여 미리보기, 내보내기.

---

## 2) 현재 시스템 구현 현황

- 라우팅/페이지
  - 작업일지 메인: `app/mobile/worklog/page.tsx:1` → `modules/worker-site-manager/pages/WorkLogHomePage.tsx:1`
  - 모바일 일일보고서(분리): `app/mobile/daily-reports/page.tsx:1` → `modules/mobile/pages/daily-reports-page.tsx:1`
  - 급여·근태(분리): `modules/mobile/pages/attendance-page.tsx:1`
  - 마킹 도면 툴(연동): `app/mobile/markup-tool/page.tsx:1`

- 데이터/서비스
  - 목록/상세 API: `app/api/mobile/daily-reports/route.ts:1` (필터/페이지네이션, 사이트/작성자 접근제어 포함)
  - 클라이언트 서비스: `modules/mobile/services/work-log.service.ts:1` (목록/생성/수정/승인/첨부 기록)
  - 업로드: `modules/mobile/hooks/use-file-upload.ts:1`, `modules/mobile/services/file-upload.service.ts:1` (Supabase Storage)

- UI 컴포넌트(이미 보유)
  - 검색/필터 바: `modules/mobile/components/worklogs/FilterBar.tsx:1`
  - 달력: `modules/mobile/components/worklogs/TaskCalendar.tsx:1` + 스타일 `modules/mobile/styles/worklogs.css:1`
  - 리스트: `modules/mobile/components/worklogs/TaskDiaryList.tsx:1`, `TaskDiaryListItem.tsx:1`
  - 상세 뷰어(풀스크린): `modules/mobile/components/worklogs/DiaryDetailViewer.tsx:1`
  - 카드/모달/업로드: `WorkLogCard.tsx:1`, `WorkLogModal.tsx:1`, `FileUploadSection.tsx:1`
  - 스타일 브릿지: `app/globals.css:1897` (worklog.html 매칭 주석 포함), `modules/mobile/styles/worklogs.css:1`

- 현 상태 주요 기능(WorkLogHomePage)
  - 요약 배지(임시저장/작성완료/NPC-1000/미작성 알림), 월간 통계 카드, 검색(제안/히스토리 옵션), 탭(임시저장/작성완료), 카드(조회/수정/제출/삭제), 작성/수정 모달, 첨부 업로드(사진/도면/확인서), 미작성 바텀시트.

---

## 3) 격차 분석(요구 대비)

- 상단 탭(작업일지/출력현황/급여현황)
  - 현황: 분리된 페이지로 존재. 단일 탭 UI로 통합되어 있지 않음.
- 검색·필터 UX 디테일
  - 검색 확장/Cancel/ESC/컨테이너 너비 동기 등 레퍼런스 수준까지 일치 X (구현 베이스는 있음: `WorkLogSearch`, `FilterBar`).
- 캘린더 연동
  - 캘린더 컴포넌트는 보유(집계 훅 포함)하나, WorkLog 화면에 통합되어 있지 않음. 리스트-캘린더 상호연동 미흡.
- 상세(Fullscreen)
  - DiaryDetailViewer 보유(사진/도면/확인서/기타까지 포함)하지만 WorkLog 화면에 연결되어 있지 않음. 줌/PDF/공유 액션은 미구현.
- 첨부/문서
  - 업로드/기록 흐름 존재. DB(document_attachments.document_type) 기준 ‘others’ 사용은 뷰어 기준 완비, 생성/수정 플로우에서 ‘기타’ 그룹 선택 UX 보강 필요.
- 출력현황(통계/캘린더)
  - 통계/캘린더 UI는 분산 구현(홈/attendance). 레퍼런스와 동일한 카드/토큰/레이아웃 합본 탭 없음.
- 급여현황
  - attendance 페이지에 기능 존재. 레퍼런스의 칩/세율 토글/미리보기 UI와 톤&매너 일치화 필요. 탭 통합 필요.

---

## 4) 개선 목표(요약)

- 현장관리자 ‘작업일지’ 단일 화면 내 3탭(작업일지/출력현황/급여현황) 구성으로 통합.
- 캘린더·리스트·상세·작성 플로우가 동일 데이터 소스(`/api/mobile/daily-reports`)를 공유하고 상호 연동.
- 문서 탭 뷰(사진/도면/확인서/기타)에 줌·PDF·공유·업로드 UI 일치화.
- 검색/필터/상태 칩/배지/다크모드 등 스타일을 task.html과 시각적으로 맞춤.

---

## 5) 구현 계획(Phase 별)

### Phase A. 탭 레이아웃 + Work 탭 정합

1. 탭 레이아웃 구축

- 신규 컨테이너(예: `modules/worker-site-manager/pages/WorkLogTabbedPage.tsx`)에서 3탭 스위치 구성.
- 탭 버튼 스타일은 `worklogs.css`/`globals.css` 라인 탭 토큰 재사용.

2. Work 탭 구성(레퍼런스 매칭)

- 상단 필터바(`FilterBar`) + 검색바(`WorkLogSearch`) 구성. ESC/Clear/Cancel 동작을 레퍼런스와 동일하게 맞춤.
- 현장/기간 셀렉트 → `useWorkLogs`/`WorkLogService.getWorkLogs` 파라미터 연동.
- 월간 캘린더(`TaskCalendar` + `useWorklogCalendar`) 추가, 일자 선택 → 리스트 필터링.
- 리스트(`TaskDiaryList` or 현재 `WorkLogCard` 목록)에서 아이템 클릭 시 `DiaryDetailViewer` 오픈(풀스크린).
- 상세 뷰어에 첨부 탭/기본정보 표시. ‘보기/다운로드/마킹 열기’ 액션 연결.

3. 상세 뷰어 기능 강화

- 줌: CSS scale + 50–200% 단계, 상태 유지.
- PDF: 클라이언트 `html2canvas + jsPDF` 기반 우선 적용(서버 PDF는 차기).
- 공유: Web Share API(지원 시)/링크 복사 폴백.
- 업로드: 뷰어 내 ‘기타’ 드롭존 허용(파일 추가 시 `updateWorkLog`로 첨부 동기).

4. 첨부 ‘기타’ 그룹 노출(작성/수정)

- `FileUploadSection`에 ‘others’ 그룹 옵션 추가(뷰/서비스/DB document_type: `other`).
- `WorkLogService.uploadAttachments`에서 `others`도 매핑 저장.

### Phase B. 출력현황 탭

1. 통계 카드(출근일수/방문현장수/누적공수)

- `WorkLogHomePage` 월 통계 로직 확장 → 별도 `OutputStats` 컴포넌트로 추출.
- 색상/모양은 task.html 토큰과 일치.

2. 캘린더(집계)

- `TaskCalendar`로 월 집계 표시(제출/임시/전체). 날짜 클릭 시 해당 일자 리스트/상세로 드릴다운.

3. 내보내기/프린트

- 선택 범위(월/현장) 요약을 PDF 저장(클라이언트) 또는 CSV 내보내기(추가).

### Phase C. 급여현황 탭

1. 요약 배지(3개) + 칩/세율 토글/입력

- attendance 페이지의 로직/컴포넌트 이식. 칩 상태/세율 입력은 상태 저장 및 접근성 개선.

2. 급여 미리보기/내보내기

- `PayslipPreviewModal` 연동, 탭 내 PDF 저장 버튼 제공.

3. 기간/현장 연동

- Work/출력현황과 동일한 기간/현장 필터를 공유.

### Phase D. 접근제어·성능·QA

- 접근: `MobileAuthGuard`/역할(site_manager, admin) 일관 적용.
- 성능: 리스트/상세 Lazy Load, 첨부 썸네일 지연 로딩, React Query 캐시 키 체계 정리.
- QA: 주요 시나리오(CRUD/필터/탭/첨부/PDF/공유) 수동 테스트 + Vitest 간단 유닛.

---

## 6) 변경 파일(예상)

- 신규(컨테이너)
  - `modules/worker-site-manager/pages/WorkLogTabbedPage.tsx` (탭 레이아웃)
- 수정(조립/연동)
  - `app/mobile/worklog/page.tsx` → 탭 페이지로 교체
  - `modules/worker-site-manager/pages/WorkLogHomePage.tsx` → 캘린더/필터 통합, 상세 뷰어 연동
  - `modules/mobile/components/work-log/FileUploadSection.tsx` → others 그룹 추가
  - `modules/mobile/services/work-log.service.ts` → others 매핑/업로드 반영
  - `modules/mobile/components/worklogs/DiaryDetailViewer.tsx` → 줌/PDF/공유 버튼/핸들러
  - `modules/mobile/styles/worklogs.css`, `app/globals.css` → 레퍼런스 토큰/상세 스타일 미세 조정
- (옵션) 서버
  - 서버 PDF 생성 라우트(차기), 캘린더 집계 전용 API(필요 시)

보호 파일(`/lib/supabase/server.ts`, `/lib/supabase/client.ts`, `/middleware.ts`, `/app/auth/actions.ts`)은 수정 대상 아님.

---

## 7) 데이터/스키마 영향

- document_attachments.document_type: 'photo' | 'drawing' | 'confirmation' | 'other' (others 추가 사용 점검)
- 집계: `/api/mobile/daily-reports` 응답에 이미 `worker_assignments`, `material_usage`, `document_attachments` 포함. 캘린더 집계는 프론트 집계 또는 경량 API로 확장 가능.

---

## 8) 일정(제안)

- A (탭/Work 정합) 2~3일: 탭/필터/캘린더/리스트/상세(연결) + others 첨부
- B (출력현황) 1~2일: 통계/캘린더 통합 + 내보내기
- C (급여현황) 2~3일: 칩/세율 토글/미리보기 + 내보내기
- D (다듬기) 1일: 접근성/다크모드/QA/문서화

총 6~9일(병행 여부/리소스에 따라 변동)

---

## 9) 리스크/대응

- PDF 품질/용량: 초기 클라이언트 생성 → 이후 서버 사이드 렌더러 도입 고려.
- 첨부 저장량: 썸네일 리사이즈/스토리지 수명주기 정책 적용.
- 권한/노출: API 레벨 필터(작성자/할당 현장) 유지, 상세/다운로드 가드.

---

## 10) 다음 액션

- 탭 컨테이너 스캐폴드 및 Work 탭 접합(상세 뷰어 연동)부터 진행.
- others 첨부 그룹 추가 개발(서비스/컴포넌트/스타일) 및 E2E 플로우 점검.
- 출력현황/급여현황은 기능 유지한 채 스타일·탭 통합 우선.

참고 파일(요구/구현 소스)

- 요구: `dy_memo/new_image_html_v3.0/inopnc-page/public/raw/task.html`
- 구현: `app/mobile/worklog/page.tsx`, `modules/worker-site-manager/pages/WorkLogHomePage.tsx`, `modules/mobile/components/worklogs/*`, `modules/mobile/services/*`, `app/api/mobile/daily-reports/route.ts`
