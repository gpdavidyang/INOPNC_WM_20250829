# 도면 관리 및 연동 시스템 개선안 (모바일 현장관리자)

## 1. 개요

현장관리자 모바일 화면의 "사진/도면 관리" 섹션 내 도면 관리 기능을 강화하여, 작업일지와 도면 간의 연동을 자동화하고 사용자 경험을 Seamless하게 개선한다.

- **대상**: 모바일 현장관리자 > 사진 도면 관리 > 도면 탭
- **핵심 목표**:
  - 불필요한 수동 매핑 단계 제거 (작업일지 맥락 자동 활용)
  - 도면 보기, 업로드, 마킹 기능을 통합된 컨테이너 내에서 제공
  - 데이터베이스 중심의 통합 연동 구조 확립 (현장/작업일지 상세 연동 대비)

---

## 2. 화면 구성 (UI/UX)

`DrawingManagerInline` 컴포넌트를 3개의 메인 탭으로 재구성한다.

### Tab 1: 업로드 된 도면 (조회)

- **목적**: 현재 선택된 작업일지에 연결된 모든 도면 확인
- **기능**:
  - 일반 업로드 도면(PDF/이미지) 및 마킹 도구 결과물 통합 리스트 표시
  - 썸네일, 파일명, 업로드 일시, 도면 구분(진행/공도면) 정보 노출
  - 항목 클릭 시 미리보기 연동

### Tab 2: 파일 업로드 (신규)

- **목적**: 기기 내 도면 파일을 즉시 업로드하고 작업일지에 자동 연결
- **UI 구성**:
  - 도면 종류 선택: [진행도면 / 공도면] 중 필수 선택 (Segmented Control)
  - 파일 선택 버튼 (갤러리/카메라/파일)
- **로직**: 업로드 완료 시 현재 `site_id`와 `worklog_id`를 메타데이터에 자동 기록하여 Tab 1 리스트에 즉시 반영

### Tab 3: 도면 마킹 도구 (도구 실행)

- **목적**: 기존 도면마킹 컴포넌트를 활용하여 컨테이너 내에서 마킹 작업 수행
- **UI 구성**:
  - 마킹 대상 파일 선택 (새로 찍기 / 갤러리 불러오기 / 현장 공도면 리스트에서 선택)
  - 선택 후 `SharedMarkupEditor`를 인라인 오버레이 형태로 실행
- **로직**: 저장 시 현재 `worklog_id`를 `markup_document_worklog_links` 및 `unified_document_system.metadata`에 자동 연결

---

## 3. 데이터베이스 및 API 연동 설계

### 3.1 통합 문서 스토리지 (Storage Hub)

- **핵심 테이블**: `unified_document_system`
- **구조적 연동**:
  - 모든 도면 데이터는 이 테이블을 통해 통합 조회된다.
  - `metadata` JSONB 컬럼 내에 아래 정보를 공통으로 관리한다:
    - `linked_worklog_id`: 연동된 작업일지 ID
    - `source_table`: 원본 테이블 (`site_documents` 또는 `markup_documents`)
    - `document_type`: 도면 종류 (`blueprint`, `progress_drawing` 등)

### 3.2 자동 연동 로직

- **API (Upload)**: `POST /api/site-documents/upload` 호출 시 `worklogId` 파라미터를 필수로 전달하여 처리.
- **API (Markup)**: `POST /api/markup-documents` 호출 시 `worklog_ids` 배열에 현재 작업일지 ID를 포함하여 저장.
- **조회**: `GET /api/mobile/media/drawings?worklog_id=...` 쿼리를 통해 해당 작업일지와 연결된 통합 리스트 반환.

---

## 4. 향후 확장성

본 개선안은 데이터베이스에 기반한 견고한 연동을 전제로 하므로, 차후 아래 페이지들과의 연동 시 별도의 작업 없이 도면 데이터를 공유할 수 있다.

- **작업일지 상세 페이지**: 특정 작업일지에 귀속된 증빙 도면 자동 노출
- **현장 상세 페이지 (Admin/Web)**: 현장 전체 도면 중 특정 작업일지와 연동된 도면 필터링 및 관리 기능을 동일한 데이터 구조 기반으로 제공

---

## 5. 실행 계획 (Phase 1)

1. `DrawingManagerInline`의 탭 구조 UI 개발
2. Tab 1: 통합 조회 API 연동 및 리스트 UI 구현
3. Tab 2: 도면 종류 선택 로직 및 자동 연동 업로드 기능 구현
4. Tab 3: 마킹 도구 인라인 연동 및 자동 연동 저장 로직 구현
5. 전체 연동 테스트 및 예외 처리 (권한, 파일 용량 등)

---

## 6. 최근 개선 사항 (2026. 02. 01) - 통합 뷰어 오버레이

모바일 환경에서의 사용자 혼선을 방지하기 위해, 도면을 클릭했을 때 새 창으로 나가는 대신 앱 내부에서 즉시 확인할 수 있는 **'통합 뷰어 오버레이'** 기능을 구현하였습니다.

### 6.1 인앱 뷰어(Internal Viewer) 도입

- 도면 연계 리스트에서 항목을 클릭하면 외부 브라우저 탭으로 이동하지 않고, 앱 화면 내에서 즉시 도면이 열립니다.
- 이로 인해 사용자가 '뒤로 가기' 버튼을 눌렀을 때 앱이 종료되거나 탭 목록으로 튕겨 나가는 불편함을 해소하였습니다.

### 6.2 모바일 최적화 UI

- **블랙 테마 적용**: 도면의 시인성을 높이기 위해 배경을 검은색으로 처리한 몰입형 뷰어를 적용했습니다.
- **상세 정보 및 닫기**: 상단바에 도면 제목을 표시하고, 명확한 [닫기] 버튼을 배치하여 언제든지 작업 리스트로 매끄럽게 돌아올 수 있습니다.
- **파일 타입 자동 대응**: 이미지 파일(.jpg, .png 등)은 전체 화면 크기에 맞춰 최적화하여 보여주며, PDF 파일은 브라우저 내장 뷰어를 통해 앱 안에서 렌더링됩니다.

### 6.3 마킹 도구와의 연동

- 마킹 도구(툴) 결과물은 기존처럼 '마킹 도구' 모드로 즉시 열리며, 일반 업로드 파일만 이 통합 뷰어를 통해 조회됩니다.
