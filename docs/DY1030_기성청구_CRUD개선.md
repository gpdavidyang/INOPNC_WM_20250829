# DY1030 기성청구 문서 CRUD 개선 계획

## 1. 문제 요약

- 관리자용 `기성청구 관리` 화면은 요약·설정 중심 UI로 구성되어 있으며, 실제 문서 업로드/교체/삭제는 상단의 단순 폼에 숨겨져 있어 workflows와 동 떨어져 있음.
- 현장 상세 화면의 `기성청구` 탭은 조회 전용 테이블만 제공해 현장 맥락에서 즉시 문서를 관리하기 어렵고, 누락/단계 상태를 한눈에 파악할 수 없음.
- 파트너는 읽기 전용이지만, 현재 뷰는 목록 수준이라 필수 문서 충족 여부를 직관적으로 알기 힘듦.

## 2. 개선 목표

1. 관리자가 현장 상세 화면에서 바로 기성 문서를 업로드·교체·삭제할 수 있게 한다.
2. 단계(착수/진행/완료)별 필수 문서 상태를 체크리스트 형태로 제공하여 진행 상황을 명확히 한다.
3. 파트너용 읽기 전용 화면에서도 동일한 체크리스트 구성을 제공해 문서 준비 현황을 쉽게 확인할 수 있게 한다.
4. 기성 문서 관리 UI와 현황 요약(진행률)을 연동해 관리 효율을 향상한다.

## 3. 상세 설계

### 3.1 현장 상세 > 기성청구 탭

- 새로운 `InvoiceDocumentsManager` 컴포넌트 도입
  - 착수/진행/완료 단계별 필수 문서를 배열로 정의하고 체크리스트 형태로 렌더링.
  - 각 항목에 다음 기능을 제공 (관리자 권한만 노출):
    - **업로드/교체**: `/api/invoice/upload`를 호출하는 모달. 사이트 ID·문서 유형·단계를 자동 지정하고 제목/설명/파일을 입력받음.
    - **삭제**: 신규 `/api/invoice/documents/:id` DELETE 라우트로 `unified_documents`와 스토리지에서 안전 삭제.
  - 업로드/삭제 후에는 SWR/React Query로 목록을 재검증하여 즉시 반영.
  - 각 문서 카드에 업로드 시각, 버전, 담당자(업로더)를 표시하고, 여러 버전이 있을 경우 “이력 보기” 버튼으로 버전 리스트 모달을 재사용.

### 3.2 관리자용 기성청구 대시보드

- 기존 탭 구조 재정비
  - `Summary`: 현황 통계 유지.
  - `Documents` (신규): 사이트별 진행률, 단계별 완료 여부, 업로드 버튼을 한 화면에서 관리. 현장 상세 탭과 동일한 모달/상태 관리 로직을 재사용.
  - `Settings`: 문서 유형 라벨/필수 단계/활성화 토글 관리 (코드는 자동 생성·표시 숨김).
- 기존 `By-site` 업로드 폼 제거 → “현장 상세에서 문서 관리” 안내 CTA만 유지.

### 3.3 파트너 뷰 개선 (읽기 전용)

- 현장별 체크리스트를 동일한 레이아웃으로 렌더링하되 업로드/삭제 버튼은 숨김.
- 각 항목에 “업로드됨 / 미등록” 배지를 표시하고, 마지막 업로드 시각·버전·업로드 주체(관리자 이름)를 보여줘 진행 상황을 명확히 전달.
- 추후 확장을 고려해, 문서별 다운로드 링크는 현 구조를 유지.

### 3.4 현장 개요 연동

- SiteDetail 개요 카드에 “기성 문서 진행도” 섹션 추가
  - 단계별 완료율 (예: 착수 2/3, 진행 1/2, 완료 0/2)을 배지 형태로 요약.
  - `InvoiceDocumentsManager`에서 사용하는 동일한 데이터 소스를 활용해 일관성 확보.

## 4. 백엔드 작업

1. `GET /api/invoice/site/:siteId` (신규): 사이트별 필수 문서 목록과 현재 업로드 상태, 버전 정보를 반환.
2. `DELETE /api/invoice/documents/:id` (신규): 문서를 삭제하고 스토리지 파일도 정리.
3. 기존 `/api/invoice/upload` 보완: title/description 입력을 모달에서 받을 수 있도록 허용.

## 5. 프론트엔드 작업 항목

- [x] `InvoiceDocumentsManager` 컴포넌트 구현 및 SiteDetailTabs에 연결.
- [x] `InvoiceTabsClient`에 `Documents` 탭 신설, 기존 `By-site` 폼 제거.
- [x] 공통 업로드 모달 컴포넌트화 (`InvoiceUploadDialog` 등) 및 관리자·대시보드에서 재사용.
- [x] 파트너 뷰 체크리스트 렌더링 개선 (버튼 숨김 + 상태 배지).
- [x] 현장 개요 카드에 진행도 배지 추가.

## 6. 롤아웃 및 이슈 대응

- 기능 개발 후 관리자 화면에서 단계별 업로드/삭제를 실제로 수행해 보고 스토리지와 DB 정합성을 검증.
- 파트너 계정으로 로그인해 읽기 전용 체크리스트가 올바르게 노출되는지 확인.
- 기존 문서 유형 데이터에 코드가 없는 경우가 없도록 백필/마이그레이션 확인.
- 새로운 API 라우트는 Supabase RLS 정책과 충돌하지 않는지 검증 필요.
