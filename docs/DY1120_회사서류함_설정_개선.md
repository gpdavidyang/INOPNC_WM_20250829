# DY1120 회사서류함 & 설정 화면 개선 제안

## 1. 요청 배경

- 본사관리자(B) 화면 `/dashboard/admin/documents/company`는 `COMPANY_DOCS` 상수로 4종의 문서만 가정해 탭과 업로드 드롭다운을 고정 구성하고 있다. 유형이 늘어나거나 이름이 바뀌면 코드 수정·배포를 반복해야 하고, 한 유형 카드가 여러 건 반복 노출돼 “사업자등록증 여러 장을 관리하는 화면”처럼 보인다.
- 현장/작업 관리자(A) 화면 `app/documents/hub/page.tsx`의 `CompanyTab`은 목록에서 제목만 노출하고, 보기·저장·공유 액션이 각각 다른 동작 방식을 사용한다. 문서가 어떤 목적/최신 버전인지 알기 어렵고, 선택/저장 UX도 반복 터치가 필요하다.
- 문서 열람/공유는 `DY1119_문서_보기열기다운로드공유_처리로직_컴포넌트화.md`의 공통 로직을 따르도록 합의돼 있어, UI 개선 시에도 해당 모듈(예: `openFileRecordInNewTab`)을 확장 활용해야 한다.

## 2. 현황 진단

### 2.1 본사관리자 B 화면

- `COMPANY_DOCS`, `COMPANY_TYPE_ALIASES` 상수 (`app/dashboard/admin/documents/company/page.tsx:10-35`)가 슬러그/레이블을 고정시켜 새로운 문서 종류를 즉시 반영할 수 없다.
- 업로드 UI(같은 파일의 최신본/버전 선택 관리가 없음)와 테이블 리스트(`.../page.tsx:280-441`)는 단순하게 나열만 하고, 각 문서가 어느 유형/버전인지 명확히 구분되지 않는다.
- CRUD 중 Delete만 테이블과 bulk 삭제로 제공되고, Update(메타데이터 수정)·Replace(버전 교체)는 따로 지원하지 않는다. 미리보기는 버튼 하나뿐이고, 공유/다운로드는 관리자 화면에서 제공되지 않는다.

### 2.2 현장 관리자 A 화면

- `CompanyTab` (`app/documents/hub/page.tsx:1235-1419`)는 회사서류 목록을 모두 같은 카드로 나열해 유형이나 최신 여부를 알기 어렵다.
- 선택 기반 `저장하기/공유하기` (`.../page.tsx:1346-1390`)는 각각 Web Share / 임시 `<a>` 다운로드로 동작하며, 공유 시 멀티 선택 불가·저장 시 파일명이 빈 문자열로 내려가는 등 UX가 제한적이다.
- 카드에는 미리보기(웹뷰) 외 추가 액션이 없으며, 모바일에서 기대하는 “파일명 · 업로드일 · 담당자” 같은 정보가 빠져 있다.

## 3. 개선 목표

1. **문서 종류의 동적 관리**: 본사 관리자가 UI에서 유형(이름·설명·정렬)을 CRUD 할 수 있고, 화면과 API가 자동 반영되도록 한다.
2. **버전 중심 UI/UX**: 유형당 최신본을 강조하고, 이전 버전 이력/미리보기를 한 패널에서 처리해 “어떤 문서가 최신인가”를 명확히 한다.
3. **웹 네이티브 액션 일관화**: A·B 화면 모두 `DY1119` 문서의 공용 미리보기/다운로드/공유 컴포넌트를 사용해 로직 중복을 제거한다.
4. **관리 편의 + 안전성**: 업로드/수정 시 필수 메타데이터(버킷·경로·태그)를 강제하고, 삭제/교체 시 영향도와 감사 로그를 남긴다.

## 4. 본사관리자(B) 화면 개선안

### 4.1 회사 문서 유형 메타데이터 CRUD

| 변경 항목     | 제안 내용                                                                                                                                                                    |
| ------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 데이터 스키마 | `company_document_types`(id, slug, name, description, order, is_required, is_active, default_visibility) 신설. 기존 태그 `company_slug:*`와 매핑되도록 slug를 공용으로 사용. |
| UI 구성       | 상단에 “회사 문서 유형” 카드 추가: 목록/검색 + 생성/수정 모달. 줄바꿈 없이 정렬 순서 수정(드래그/번호)와 on/off 토글.                                                        |
| 연동          | Supabase RLS에서 관리자만 CRUD 가능하게 제한. 저장 즉시 `/api/unified-documents`에서 사용할 수 있도록 캐싱을 무효화하거나 `useSWR` mutate.                                   |

### 4.2 문서 목록/버전 UI

1. **타입별 카드 + 버전 리스트**: 기존 테이블 대신 “사업자등록증” 카드 안에 최신본(업로드일/업로더/용량)과 버전 히스토리를 accordion으로 배치. 파일이 없으면 빈 카드에 “등록 필요” CTA 노출.
2. **유형 필터/검색**: 우측 사이드바에 `회사 문서 유형`, “미리보기 가능 여부”, “최근 X일” 필터를 배치해 파일 수가 늘어나도 탐색이 쉽도록 한다.
3. **상세 패널(미리보기 + 메모)**: 리스트 클릭 시 우측 패널에서 서류 썸네일/미리보기, 비고 입력, 연결 현장/파트너를 확인하도록 구성. preview는 `FilePreviewPanel`(공용 컴포넌트) 사용.

### 4.3 CRUD & 안정성

- **업로드/교체 폼**: “신규 업로드”와 “기존 버전 교체”를 명시적으로 구분하고, version note(예: “2024.08 세무서 재발급본”)을 필수 입력으로 받아 감사 로그를 남긴다.
- **미리보기/다운로드/공유**: 각 버전 row에 `보기`, `다운로드`, `공유`, `링크 복사` 아이콘 버튼을 배치하고, 내부 동작은 `openFileRecordInNewTab` + `FileActionMenu`(공용 헬퍼)로 통일.
- **일괄 작업**: bulk delete 외에도 bulk share/export (ZIP 혹은 링크 목록 복사)를 제공해 여러 문서를 한 번에 현장 관리자에게 전달할 수 있게 한다.
- **검증/에러 처리**: 업로드 시 `storage_bucket/path` 누락을 서버에서 차단하고, 실패 시 `useToast`로 상세 메시지를 보여준다. 삭제/교체는 double confirmation + 영향도 텍스트를 표기.

## 5. 현장 관리자(A) 화면 개선안

### 5.1 정보 구조

- **유형별 정렬 + 최신 강조**: `CompanyTab`에서 API 응답을 유형 메타데이터와 조인해 “카드 하나 = 한 유형”으로 보여주고, 최신 파일 기준으로 미리보기 버튼을 배치한다.
- **세부 정보 노출**: 카드 내에 `업로드일`, `업로더`, `버전 메모`, `파일 크기`를 2열 리스트로 노출해 작업자가 문서 상태를 즉시 판단할 수 있게 한다.
- **결측 안내**: 파일이 없거나 만료된 경우 빨간 배지로 알림을 띄우고, 바로 본사 담당자에게 전화/톡을 연결할 수 있는 CTA를 추가.

### 5.2 액션 일관화

- **미리보기**: `FilePreviewButton`(혹은 `FilePreviewSheet`)을 사용해 PWA/모바일에서도 확대/스크롤이 편한 뷰어를 제공.
- **저장**: `FileDownloadButton`을 이용해 파일명을 유지한 채 다운로드하도록 하고, iOS/Android에서 지원되는 경우 Files 앱 저장을 안내한다.
- **공유**: Web Share API를 우선 사용하되, 미지원 환경에서는 `link copy` fallback을 동일 버튼(1회 탭)에서 제공. 다중 선택 공유 시 선택된 문서들의 signed URL 목록을 메모장 형식으로 복사해 준다.

### 5.3 추가 UX 개선

- **검색/필터**: 상단에 검색창을 두어 “통장”처럼 키워드로 빠르게 찾을 수 있게 하고, “최근 업데이트 순/이름순” 정렬도 제공.
- **오프라인 대비**: 이미 열람한 파일을 `IndexedDB` + `sw-docs.js` 캐시에 저장해 지하에서도 다시 확인 가능하게 한다. 스토리지가 부족하면 캐시 관리 토스트를 띄운다.
- **알림**: 본사에서 새 버전이 업로드되면 푸시/PWA 알림으로 알려 작업자들이 최신 서류를 쓰도록 유도한다.

## 6. 공통 처리 전략

- **데이터 소스 통일**: 모든 회사서류는 `unified-documents` 테이블에서 `category_type=shared` + `company_slug` 태그를 사용하고, 새 유형 CRUD가 slug를 보장하도록 한다.
- **파일 액션 공통화**: `DY1119` 문서에 정의된 `buildFileRequest` → `/api/files/signed-url` → `FilePreviewButton/FileActionMenu` 흐름을 그대로 재사용해, A/B 화면 모두 동일 콜드패스를 갖도록 한다.
- **접근 제어**: 본사 관리자 외 사용자는 유형 CRUD API를 호출할 수 없게 RLS/미들웨어를 적용하고, 문서 열람은 Worker/Site Manager/Partner 역할에 맞춘 권한 토글로 통제한다.
- **감사 로그**: 모든 CRUD(생성, 수정, 삭제, 버전 교체)에 대해 `documents_audit_log`를 남겨 누가 어떤 문서를 언제 바꿨는지 추적할 수 있게 한다.

## 7. 구축 단계 제안

1. **데이터 모델링**: `company_document_types` 테이블과 Supabase RLS 정책 작성 → 기존 태그 데이터 백필 → 마이그레이션 문서화.
2. **API & 헬퍼 정비**: `/api/company-doc-types`, `/api/unified-documents` 확장, `lib/documents/company-types.ts` 헬퍼 추가.
3. **B 화면 리디자인**: 유형 관리 패널 + 버전 카드 컴포넌트 구현, 공용 FileActionMenu 연결, QA로 버전 히스토리 검증.
4. **A 화면 개선**: `CompanyTab` UI 리팩터, 선택/액션 컴포넌트 교체, 오프라인 캐시/검색 추가.
5. **테스트 & 롤아웃**: 관리자/현장 QA → 릴리스 노트 공유 → 사용 매뉴얼(스크린샷 포함) 배포 → 피드백 수집 후 추가 개선.

## 8. API/UI 연동 설계

### 8.1 API

- `GET /api/company-doc-types`: `company_document_types` 테이블을 정렬 순으로 반환하며, 로그인 사용자는 누구나 조회 가능.
- `POST /api/company-doc-types`: slug/정렬/설명 등을 등록. 관리자 전용이며 slug는 `company_slug:*` 태그 규칙과 중복 불가 검사를 수행.
- `PATCH /api/company-doc-types/:id`: 이름·설명·표시 순서·필수 여부·활성 상태·기본 가시성을 수정하고, 감사 로그에 diff를 남김.
- `DELETE /api/company-doc-types/:id`: 미사용 시 실제 삭제, 참조 중이면 `is_active=false`로 soft delete 처리.
- `/api/unified-documents/v2/upload`: `company_doc_type_id` 또는 `slug`를 함께 받아 태그(`company_slug:slug`)·metadata(`company_slug`, `company_doc_type_id`)를 강제 세팅.
- `/api/unified-documents/v2`: `company_slug` / `company_doc_type_id` 파라미터를 추가해 유형별 문서 목록을 빠르게 필터링.

### 8.2 관리자 화면(B)

- `useSWR('/api/company-doc-types')`로 유형 리스트를 불러오고 `lib/documents/company-types.ts`의 `buildCompanyDocTypeMap`으로 slug→label 매핑을 구성.
- 업로드/버전 교체 시 form-data에 `company_doc_type_id`/slug를 포함하고, 성공 후 `mutate`로 목록과 유형 캐시를 동기화.
- 버전 카드의 `보기/다운로드/공유/링크복사/삭제`는 `FileActionMenu`(공용 파일 액션 컴포넌트)를 연결해 로직을 일원화.
- 유형 CRUD 모달은 slug 편집 시 기존 문서 태그 재매핑 여부를 경고하고, soft delete 시 어떤 화면에서 숨겨지는지 안내.

### 8.3 현장 관리자 화면(A)

- 앱 진입 시 `GET /api/company-doc-types` 결과를 IndexedDB에 캐시하고, 오프라인일 때는 캐시+최근 문서 목록으로 뷰를 구성.
- `CompanyTab`은 “유형 카드 → 최신본 미리보기 → 구버전 accordion” 형태로 렌더링하며, `detectCompanyDocSlug`/`resolveCompanyDocLabel` 헬퍼로 slug/라벨을 판별.
- `보기/저장/공유`는 각각 `FilePreviewButton`, `FileDownloadButton`, `FileShareButton`으로 교체해 signed URL·Web Share fallback을 재사용.
- 다중 선택 공유 시 선택 문서 slug/제목을 정리한 텍스트를 Web Share API나 복사 토스트로 함께 전달해 작업자가 어떤 파일을 산출했는지 인지하도록 돕는다.
- 새 버전 업로드 이벤트는 Supabase trigger → Edge Function → PWA push 로 전달해 현장 관리자에게 최신본이 등록됐음을 알림.
