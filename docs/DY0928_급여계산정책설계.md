# DY0928 급여 계산 정책 · 구현/검증 보고서

## 목적

- 모바일(명세서/급여현황)과 관리자(급여관리 도구)의 계산을 하나의 로직으로 일원화
- 일용직/프리랜서(3.3%)와 상용직(4대보험) 정책을 정확 적용
- 관리자가 입력한 개인별 세율(custom_tax_rates)을 최우선 반영

## 데이터 원천과 우선순위

1. `worker_salary_settings` (is_active=true, effective_date≤기준일)
   - employment_type: `freelancer` | `daily_worker` | `regular_employee`
   - daily_rate, custom_tax_rates(JSON, %) – income_tax, local_tax, national_pension, health_insurance, employment_insurance
2. `salary_info` (레거시) – 1)이 없을 때 폴백
   - hourly_rate, overtime_rate (daily_rate는 hourly×8)
   - employment_type가 없으므로, `profiles.role`로 유추
     - role=worker/site_manager → `daily_worker`
     - 그 외 → `regular_employee`
3. `employment_tax_rates` – 상용직 4대보험/소득세 기본치 (없을 때 가드 세율 사용)

## 계산 정책(요약)

- 공통: 1공수=8시간, 기본시급=일급/8, 연장시급=기본시급×1.5
- 일용직/프리랜서(daily_worker/freelancer)
  - 연장수당 없음(초과시간 0), 4대보험 없음
  - 공제는 3.3%: 소득세 3% + 지방소득세 0.3%
- 상용직(regular_employee)
  - employment_tax_rates 사용(국민 4.5, 건강 3.43, 고용 0.9 + 소득세는 테이블 값)
  - 테이블이 비면 보수적 가드: 소득세 8%, 국민 4.5, 건강 3.43, 고용 0.9
- 개인별 세율(custom_tax_rates)이 있으면 위 모든 것을 덮어씀(퍼센트)

## 월 집계 로직 보강

- labor_hours가 비어 있고 work_hours만 있는 레코드는 labor=work_hours/8으로 환산
- status가 출근 계열(`present/late/in-progress/working/checked_in/checked-out/checkedout/done`)이거나 check_in/out이 있으면 1공수(8h) 보정

## 구현 포인트

- 서비스(공유 엔진): `lib/services/salary-calculation.service.ts`
  - getSalaryInfo: worker_salary_settings → salary_info 폴백, `profiles.role`로 고용형태 추론, custom_tax_rates 반환
  - calculateMonthlySalary: 위 보정/환산/연장제외(일용·프리) 적용
  - calculateTaxDeductions(gross, type, customRates?): customRates 우선 → 일용/프리=3.3% → 상용=employment_tax_rates(없으면 가드)
- 월 API(공용 진입점): `app/api/salary/monthly/route.ts`
  - 스냅샷 우선 → 서비스 롤 기반 월 계산 폴백
  - employment_type/daily_rate: worker_salary_settings 우선
  - `?debug=1`로 records/sum_work_hours/sum_labor_hours_field/sample 제공
- 모바일 급여현황/명세서: `modules/mobile/pages/attendance-page.tsx`, `/payslip/[userId]/[year]/[month]`
  - 로컬 추정 계산 제거 → `/api/salary/monthly` 결과 사용(최근 N개월 포함)
  - 명세서 UI를 간결 요약으로 정리(상세시급/시간/노동시간 항목 제거)

## 검증

- 스크립트: `scripts/debug-calc.ts` – 특정 사용자/연월 월계산, 서비스 롤 사용
- 스크립트: `scripts/debug-regular.ts` – regular_employee 사용자 1명 자동 선택 후 월계산
- 수동 확인
  - GET `/api/salary/monthly?year=2025&month=7&debug=1` → success: true, data.workDays>0, data.salary.\* 숫자
  - 모바일: 최근 급여 내역과 명세서 금액이 동일(같은 API 소스)

## 남은 확인/보완 포인트

- 관리자 도구의 스냅샷 발행 시, 스냅샷에도 개인세율/형태를 저장하여 월 API와 1:1 일치 유지(현재 월 API는 스냅샷 우선)
- 명세서 상단에 ‘세율 출처’ 배지(개인설정/형태기본/스냅샷) + 툴팁(적용세율 %) 추가(선택)

## 롤아웃

- Phase 1: 서비스/라우트/모바일 반영(완료)
- Phase 2: 배지/툴팁/관리자 미리보기 통합(선택)
