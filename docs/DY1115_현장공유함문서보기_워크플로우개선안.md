## DY1115 – 현장공유함 문서 보기 워크플로우 개선안

### 1. 배경

- 현장공유함 > 도면 리스트에는 공도면, 진행도면, 마킹 도면(도면마킹 도구에서 생성) 등이 혼재되어 있음.
- 현재 구현은 `markup-`으로 저장된 문서를 클릭하면 모바일 도면마킹 도구(`/mobile/markup-tool`)를 새 창으로 열어 데이터를 다시 렌더링함.
- 사용자 관점에서 일반 문서(이미지/PDF)와 다른 흐름이기 때문에 UI/UX 일관성이 떨어지고, 공유/다운로드·오프라인 보기 등이 제한됨.
- 시스템 확장성 측면에서도 “보기” 시 항상 뷰어로 이동해야 하므로 향후 승인/결재/외부문서 전달 시 어려움이 있음.

### 2. 목표

1. **모든 “보기” 버튼의 동작을 동일하게** 만들어 사용자 경험을 단순화한다.
2. **마킹 문서를 이미지 또는 PDF로 자동 변환·보관**하여 네이티브 보기/공유 기능을 사용할 수 있게 한다.
3. 기존 편집 가능 데이터(`markup_data`)는 그대로 유지하여 향후 재편집이 가능하도록 한다.
4. 모바일/관리자 워크플로우 전체(공도면 선택 → 마킹 → 저장 → 공유)를 리프레시한다.

### 3. 개선 방향 요약

| 구분              | 현재                                | 개선안                                                                  |
| ----------------- | ----------------------------------- | ----------------------------------------------------------------------- |
| 저장 포맷         | `markup_data`만 보관                | `markup_data` + 보기용 스냅샷(이미지 또는 PDF) 동시 저장                |
| 보기 동작         | `markup-` 문서 → 도면마킹 뷰어 이동 | 모든 문서 → 웹 네이티브 뷰어(이미지/PDF), 필요 시 “마킹 열기” 별도 버튼 |
| 공유/다운로드     | 뷰어 진입 필요                      | 스냅샷 URL을 사용해 즉시 공유/다운로드                                  |
| 모바일 워크플로우 | 공도면 → 마킹 → 저장(뷰어 호출)     | 공도면 → 마킹 → 저장(스냅샷 생성) → 문서함에서 동일 UX                  |

### 4. 구현 단계

#### 4.1 도면마킹 도구 저장 로직 확장

- **클라이언트(SharedMarkupEditor)**
  - 저장 버튼 클릭 시 `markup_data`와 함께 `exportSnapshot()` 호출.
  - `<canvas>` 또는 `<svg>`를 이용해 현재 상태를 렌더링하고 `toDataURL`로 PNG/WEBP 생성.
  - 필요 시 `pdf-lib` 등을 사용해 PDF 변환(벡터+이미지) 옵션 제공.
- **서버(API: `app/api/docs/drawings/markups/save`)**
  - 기존 `markup_documents` 인서트 로직을 유지.
  - 요청 바디에 `preview_image` 또는 `preview_pdf` 필드를 추가.
  - 수신한 데이터는 Supabase Storage `documents` 버킷(or `markups`)에 저장하고 URL을 `preview_image_url`, `preview_pdf_url` 등에 기록.
- **백필 예외 처리**
  - 과거 문서에 대해 일괄 스냅샷이 필요한 경우를 대비해, `markup_data`를 불러와 서버에서 변환할 수 있는 batch 스크립트 초안도 준비.

#### 4.2 문서 리스트/보기 UX 통일

- `app/docs/drawings` API 응답에 `preview_image_url` 또는 `preview_pdf_url` 포함.
  - `category: progress` 이면서 `source_table: markup_documents`인 경우 우선 스냅샷 URL을 사용.
  - 스냅샷이 없으면 기존 fallback(URL) 사용 + “마킹 열기” 버튼 노출.
- `app/documents/hub/page.tsx` (현장관리자)
  - 보기 버튼은 항상 `resolveDocUrl`이 반환한 스냅샷 URL을 새 탭에 열도록 변경.
  - “마킹 다시 열기” 보조 버튼을 추가해 편집 필요 시 `/mobile/markup-tool?mode=start&docId=…`로 이동.
- `app/dashboard/admin/documents/...` 등 관리자 화면에도 동일 정책을 적용.

#### 4.3 모바일 워크플로우 개선

- `app/mobile/markup-tool`
  - 도면 선택 시 `selected_drawing`에 원본 파일 URL + 스냅샷 URL 저장.
  - 저장 후에는 `/api/docs/drawings` 목록을 다시 로딩해 새 스냅샷을 즉시 확인 가능하게 한다.
- 공유/다운로드/전송 시 항상 스냅샷 URL을 사용하므로 네이티브 공유 API, 채팅 첨부 등이 단순화된다.

### 5. 기술 고려사항

1. **파일 확장자 결정**: PNG 기본, 필요 시 업로드 시점에서 사용자 선택으로 PDF/PNG 동시 생성.
2. **용량 관리**: 스냅샷 이미지에 대해 WebP 옵션을 제공하거나 해상도를 최적화한다.
3. **권한/RLS**: 스냅샷 파일도 원본과 동일한 RLS 정책을 적용해야 하므로 `documents` 버킷 내 `site-documents/...` 경로를 재사용.
4. **백필 전략**: 과거 `markup_documents`에 대해 nightly batch 또는 사용자 요청 시 “스냅샷 생성” 기능을 제공.
5. **에러 폴백**: 스냅샷 생성 실패 시 기존 뷰어 호출 방식을 임시로 유지해 사용자가 작업을 계속할 수 있도록 한다.

### 6. 향후 확장

- 스냅샷을 활용한 **전자결재/보고서 자동 첨부**, **문서 버전 비교(이전 스냅샷 diff)**, **AI 인식(스탬프 분석)** 등이 가능해진다.
- 모바일/데스크탑 공통 워크플로우가 단순화되므로 교육/매뉴얼도 축약 가능하다.

### 7. 화면/시스템 영향도 예측

#### 7.1 현장관리자 화면(모바일/웹)

- **DrawingsTab 리스트**
  - API 응답 필드 변경(`preview_image_url`, `preview_pdf_url`) 반영.
  - 보기 버튼은 preview URL을 열고, “마킹 다시 열기” 보조 액션 추가.
  - 선택 공유/다운로드 로직은 preview URL 기반으로 단순화.
- **모바일 도면마킹 도구**
  - 저장 시 스냅샷 생성 요청을 포함하도록 API 호출 변경.
  - 저장 성공 후 문서함 리스트를 재호출하여 즉시 반영.
  - 기존 `selected_drawing` 로컬 스토리지 구조에 `previewUrl` 필드 추가.

#### 7.2 본사관리자 화면(관리자 포털)

- **문서 관리 대시보드** (`app/dashboard/admin/documents/...`)
  - 통합 문서 리스트 및 상세 모달에서 preview URL을 사용하여 모든 문서를 동일 뷰어로 표시.
  - “도면마킹 편집” 버튼은 필요 시만 노출(권한/상태에 따라).
  - 승인/보관/다운로드 플로우는 preview URL을 공통으로 사용해 단순화.
- **도면마킹 도구 (관리자 버전)**
  - 저장 API 확장 동일 적용.
  - 기존 문서 열기/저장 시 preview 상태 표시(스냅샷 생성 여부, 마지막 생성 시간 등) 추가.

#### 7.3 API / DB 스키마 변화

- `markup_documents` 테이블
  - `preview_image_url`, `preview_pdf_url`, `snapshot_generated_at` 컬럼 추가.
  - 필요 시 `snapshot_storage_path` (버킷/경로) 메타데이터도 저장하여 RLS와 연결.
- `site_documents` & `unified_document_system`
  - markup 기반 진행도면 추가 시 preview URL을 기록하도록 필드 확장.
  - `metadata` JSON에 `source_table`, `source_markup_document_id` 외에 `snapshot_url` 등 저장.
- API
  - `POST /api/docs/drawings/markups/save`: `preview_image`/`preview_pdf` payload 수신 및 업로드 처리.
  - `GET /api/docs/drawings`: 응답 스키마에 preview 필드 포함, `category=progress` 항목은 preview 우선.
  - `GET /api/markup-documents/[id]`: preview 관련 정보 반환(생성 여부, URL).
  - 백필/재생성용 `POST /api/markup-documents/[id]/snapshot` (관리자 권한) 고려.

#### 7.4 기능/워크플로우 변화

1. **생성 단계**: 마킹 저장 시 자동 스냅샷 생성 → Storage 업로드 → URL 기록.
2. **열람 단계**: 현장/관리자/파트너 등 모든 화면의 기본 보기 = preview 파일.
3. **편집 단계**: “마킹 열기” 버튼을 명시적으로 제공하여 사용자가 의도적으로 에디터 진입.
4. **공유/다운로드**: preview URL을 공통으로 사용하므로 UX와 권한 로직이 단순해짐.
5. **백필/유지보수**: 과거 문서는 스냅샷 유무를 표시하고, 필요 시 새로 생성할 수 있는 admin 툴을 제공.

### 8. 작업일지-도면 연계 강화

- **데이터/서비스 공통화**
  - `markup_documents`, `site_documents`, `unified_document_system` 모두에 `site_id`, `linked_worklog_id`(또는 `metadata.worklog_ids`)를 표준 필드로 유지.
  - `/api/docs/drawings`, `/api/worklogs/[id]`, `/api/sites/[id]/documents` 등 주요 API에서 동일 키를 노출.
  - 누락된 링크를 일괄 정비할 수 있는 관리자용 백필 스크립트/화면 제공.
- **화면별 개선 포인트**
  - 현장공유함: 문서 카드에 “연결된 작업일지” 표시 및 편집 모달 제공, 스냅샷이 없을 때만 “마킹 열기” fallback. (연동 모드, 링크 배지 1차 구현 완료)
  - 현장/본사 현장 상세: 공유자료 카드에 작업일지 링크 배지 추가.
  - 작업일지 상세/작성(현장 & 본사): 도면 카드 UI 재사용, “보기/마킹/공유/현장공유함 이동” 버튼 제공.
  - 도면마킹 도구: 저장 시 작업일지 선택/재연결 UI 제공.
- **개발 순서 제안**
  1. 스키마/메타데이터 정비 → 표준 키 정의.
  2. API 확장 및 연동 검증.
  3. 현장공유함, 현장/작업일지 화면 개편.
  4. 관리자/도면마킹 도구 확장.
  5. 기존 문서 백필 도구 제공 및 워크플로우 가이드 정리.

---

이 문서는 현장공유함 “보기” UX 일관성 및 작업일지 연계 강화를 위한 설계 초안이며, 구현 시 구체적인 API·스토리지 구조를 추가 업데이트한다.

### 9. 남은 구현 체크리스트

1. **현장/작업일지 화면 전역 연동 표시**
   - 현장 상세(모바일/본사)에서 문서 카드에 작업일지 배지/리스트 추가.
   - 통합 문서 대시보드 등에서도 동일한 UI 적용.
2. **도면마킹 도구(관리자) 확장**
   - 저장 시 다중 작업일지 선택, 기존 연결 해제/확인 UI.
   - 임의 문서의 작업일지 재매핑 워크플로우.
3. **API/DB 표준화 보완**
   - `worklog_ids` 다중 매핑 스키마 검토 및 관련 API (`/api/worklogs/[id]/drawings` 등) 정리.
   - `/api/admin/sites/[id]/documents` 등 다른 목록 API도 `linked_worklog_id`를 보장.
4. **현장공유함 보조 기능**
   - 작업일지 검색/선택 UI(현재 URL 쿼리 기반)와 연결 이력, 해제, 재연결 기능.
   - 연동 상태를 필터링하거나 정렬하는 옵션.
5. **백필/관리 도구**
   - 기존 마킹 문서의 스냅샷/연계 정보를 일괄 생성·보정하는 관리자 도구 또는 스크립트.
   - 링크 상태 모니터링/로그/알림 체계.
6. **워크플로우 가이드 및 도움말**
   - “작업일지 작성 → 현장공유함 → 마킹 → 작업일지 연결” 프로세스를 명확히 안내하는 배너·툴팁.
   - 연동 모드 진입/해제에 대한 사용자 인스트럭션.

### 10. 다중 작업일지 링크 DB/백엔드 설계 요약

1. **스키마**
   - `markup_document_worklog_links` (신규): `markup_document_id`, `worklog_id`, `created_at`, PK/UNIQUE/Index 구성으로 다중 연결 지원.
   - `markup_documents`는 기존 `linked_worklog_id`를 대표값으로 유지(호환성).
   - `unified_document_system.metadata`에 `linked_worklog_ids` 배열 추가.
2. **저장/수정 API**
   - `worklogIds: string[]` 입력을 받아 링크 테이블 insert/delete 처리.
   - 단일 필드(`linked_worklog_id`)는 `worklogIds[0]`와 동기화.
3. **조회 API**
   - `/api/docs/drawings`, `/api/mobile/daily-reports/[id]`, `/api/admin/sites/[id]/documents` 등에서 `linked_worklog_ids` 배열 반환.
   - 작업일지 상세는 helper(`fetchLinkedDrawingsForWorklog`)로 연관 도면 리스트 생성.
4. **도구/UI 연계**
   - 현장공유함 연동 모드, 관리자 도면마킹 도구, 공유자료 테이블 등에서 동일한 API를 통해 배열을 전송/표시.
5. **백필/점검**
   - 기존 `linked_worklog_id` 데이터를 링크 테이블로 이관하는 스크립트.
   - 주기적 정합성 검사/알림을 위한 관리 도구 마련.
