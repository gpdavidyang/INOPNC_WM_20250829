# DY0928*급여현황화면*개선안

본 문서는 현장관리자 화면 > 출력정보 > 급여현황 탭의 “최근 급여 내역” UX 개선 및 상세 보기(스냅샷/HTML, PDF 저장) 흐름을 정의합니다. DY0926*급여현황화면*개선안\_v2.0.md를 기반으로 실제 구현 방안을 구체화했습니다.

## 목표

- 최근 급여 내역에 ‘더보기’ 제공 → 최대 12개월 이력 한 화면에서 확인
- ‘보기’ 클릭 시 관리자/시스템이 발행한 스냅샷이 있으면 우선 노출, 없으면 동적 생성 HTML 노출
- PWA/브라우저 환경 모두에서 자연스러운 열람 경험 제공(브라우저 인쇄로 PDF 저장 유도)

## 핵심 UX 결정

- ‘더보기’ 버튼: 최근 3개월 → 12개월로 확장 표시(토글형). 스크롤 가능한 카드 리스트 유지
- 상세 보기: 동일 도메인의 `/payslip/[userId]/[year]/[month]` 경로 사용
  - HTML-first 뷰. 브라우저 인쇄 기능(⌘P / Ctrl+P)으로 PDF 저장 유도
  - 스냅샷 존재 시 스냅샷 기반 렌더링, 없으면 현재 데이터로 동적 생성
- 새 창/현재 창 정책
  - 브라우저(탭 UI)에서는 새 탭(`_blank`)로 열기 → 사용자가 뒤로가기로 페이지 복귀 용이
  - PWA(standalone)에서는 현재 창 내 네비게이션(새 창 제한/경험 저하 회피)
  - 판별: `matchMedia('(display-mode: standalone)')` 또는 iOS `navigator.standalone`

## 기술 설계

- 라우팅: `app/payslip/[userId]/[year]/[month]/page.tsx`
  - 1순위: `GET /api/salary/snapshot?year=&month=&workerId=`로 스냅샷 조회
  - 2순위: 스냅샷 없으면 서버 API(`/api/salary/monthly`) + Supabase 보조 조회로 HTML 생성
  - HTML은 `payslipGeneratorKorean` 템플릿 사용, `@media print`로 인쇄 최적화
- 스냅샷 API(이미 존재)
  - `GET /api/salary/snapshot`: 조회(본인/관리자 권한)
  - `POST /api/salary/snapshot`: 발행(본인 또는 관리자 위임)
  - `GET /api/salary/snapshot/list`: 관리자 목록
  - (옵션) 승인/지급 API: `POST /api/salary/snapshot/approve`, `POST /api/salary/snapshot/pay`
- 접근 제어
  - 본인은 본인 것만 열람, 관리자는 `workerId` 쿼리 허용

## UI 변경 요약(모바일)

- 파일: `modules/mobile/pages/attendance-page.tsx`
  - [추가] ‘더보기’ 버튼(최근 급여 내역 하단)
  - [개선] ‘보기’ 클릭 시 PWA 감지 → PWA면 현창 이동, 브라우저면 새 탭
  - [유지] 올해/월 선택 및 핵심 통계 UI

## 단계별 구현 계획

1. Phase A: 모바일 이력 확장 및 열람 방식 개선

- 최근 3개월 → 12개월 확장 토글(‘더보기’) 구현
- PWA 감지 후 라우팅 분기(open vs location.assign)
- 페이지 내 가이드(‘인쇄로 PDF 저장’) 문구 추가(옵션)

2. Phase B: 스냅샷 우선 열람 통합

- `/payslip/...` 페이지에서 스냅샷 조회 후 없으면 동적 생성으로 폴백
- 스냅샷 메타(발행일, 버전) 표기(상단 캡션)

3. Phase C: 관리자 연계 강화(선택)

- 관리자 급여관리 화면에서 스냅샷 발행/승인/지급 플로우 확정
- ‘급여 내역 전체 보기’ 전용 페이지 추가(필터/검색/페이지네이션)

## PWA 고려사항

- iOS/Android PWA의 `window.open` 제약: 새창이 시스템 브라우저로 전환되거나 차단될 수 있음
- 대안: PWA에서는 내부 라우팅(모달/드로어 가능) → 기본은 전체 페이지 라우팅 권장
- 인쇄: PWA에서도 브라우저 인쇄 가능. iOS는 공유시트에서 ‘PDF로 저장’ 동작으로 대체될 수 있음

## QA 체크리스트

- ‘더보기’ 클릭 시 렌더 성능(12개 항목)과 스크롤 UX
- PWA/브라우저 환경별 열람 경로 분기 정상 동작
- 스냅샷/동적 생성 결과가 같은 금액으로 일치(정합성)
- 인쇄 미디어 쿼리 적용(여백/폰트/페이지 나눔)

## 변경 요약(이번 PR 기준)

- 모바일 급여현황 탭에 ‘더보기’ 구현 및 PWA 분기 열람 로직 도입
- 스타일 미변경(기존 카드/텍스트 사용)

## 후속 과제

- `/payslip/...`에서 스냅샷 우선 로딩 로직 반영(서버/클라이언트 혼합)
- 전체 급여 내역 전용 페이지(필터/검색) 여부 결정
- 인쇄용 CSS 세부 조정(브랜드/직인/서명 노출 범위)

---

참고 문서: `docs/DY0926_급여현황화면_개선안_v2.0.md`
