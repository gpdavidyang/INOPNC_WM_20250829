# 작업보고서 (Work Report) 기능 구현 계획안

## 1. 개요 (Overview)

**작업보고서(Work Report)**는 '승인(Approved)'된 **작업일지(Daily Report)**를 기반으로 본사 관리자가 생성하는 공식적인 **A4 세로 양식의 PDF 문서**입니다.
단순한 데이터 조회를 넘어, 현황판이나 제출용으로 활용될 수 있는 정형화된 포맷을 제공하며, 본사/현장/파트너사 모두가 공유할 수 있는 최종 산출물로서의 성격을 가집니다.

## 2. 핵심 요구사항 (Requirements)

### 2.1 생성 권한 및 조건

- **생성 권한**: **본사 관리자(HQ Admin)**만 생성 가능.
- **선행 조건**: 해당 작업일지의 상태가 반드시 **'승인(Approved)'**이어야 함.
- **진입점**: 본사 관리자 웹 > 작업일지 상세 페이지 > 상단 헤더 영역.

### 2.2 주요 기능

1.  **작업보고서 생성 (Generate)**:
    - '상태 초기화' 버튼 우측에 **[작업보고서 생성]** CTA 버튼 배치.
    - 클릭 시 해당 일지의 데이터를 기반으로 PDF 생성 및 저장.
2.  **작업보고서 관리 (Manage)**:
    - **본사 관리자**: 작업일지 상세 하단에 별도 섹션 제공 (생성 이력, 미리보기, 다운로드, 삭제, 공유).
    - **현장 관리자**: 작업일지 목록 카드에 **[보고서]** 버튼 표시 (조건: 보고서가 생성된 건). 클릭 시 모달로 미리보기.
3.  **일관된 UX**:
    - 현장 관리자용 미리보기 모달은 기존 '작업완료확인서' 모달과 동일한 Look & Feel (검은 배경, 아이콘 위치 등) 유지.

### 2.3 보고서 구성 항목 (Content)

A4 세로 레이아웃에 다음 항목들을 구조적으로 배치:

1.  **헤더**: 문서 제목 (예: "작 업 보 고 서"), 현장명, 결재란(생략 가능하나 양식상 공간 유지 고려).
2.  **기본 정보**:
    - 작성자, 작업일자.
    - 작업 위치 (부재명, 위치 상세).
    - 작업 개요 (공종 - 작업공정, 작업유형).
3.  **인력 투입 현황**:
    - 작업자 명단 및 개인별 공수 (Total Man-hours).
4.  **자재 투입 내역**:
    - 사용된 자재명, 수량, 단위.
5.  **도면 현황**:
    - 연동된 도면 수량 요약 (공도면 / 진행 중 / 완료).
6.  **현장 사진**:
    - 작업 전/중/후 사진을 격자 형태(Grid)로 배치.

## 3. 상세 설계 (Detailed Design)

### 3.1 아이디어 및 개선 제안 (Assistant's Suggestions)

사용자의 기본 요구사항을 바탕으로, 시스템의 완성도를 높이기 위한 제안입니다.

1.  **동적 PDF 생성 (Client-side vs Server-side)**:
    - **제안**: **`@react-pdf/renderer`**를 사용하여 클라이언트(브라우저)에서 즉시 생성하거나, **Puppeteer**를 이용한 서버 사이드 생성을 고려할 수 있습니다.
    - _이유_: 데이터 보안 및 서버 부하를 고려할 때, React 컴포넌트를 그대로 PDF로 변환하는 방식(`react-to-print` 또는 `@react-pdf/renderer`)이 유지보수와 스타일링에 유리합니다. 여기서는 **`@react-pdf/renderer`**를 추천합니다 (정교한 A4 레이아웃 제어 가능).
2.  **데이터 스냅샷 (Data Snapshot)**:
    - **제안**: 보고서 생성 시점의 데이터를 고정(Freeze)해야 합니다. 작업일지가 수정되더라도 이미 생성된 보고서는 변하지 않아야 신뢰성이 유지됩니다.
    - _구현_: PDF 파일을 물리적 파일(Storage)로 저장하고, DB에는 해당 파일의 URL과 생성 메타데이터를 저장합니다.
3.  **QR 코드 연동**:
    - **제안**: 출력물 우측 상단에 해당 작업일지 상세 페이지로 바로 접근할 수 있는 QR 코드를 삽입합니다. (현장 실물 관리 시 유용)
4.  **버전 관리**:
    - **제안**: 만약 작업일지가 수정되어 재수사가 필요한 경우, 기존 보고서를 덮어쓰거나 'V2'로 버전을 관리하는 정책이 필요합니다. (초기에는 '삭제 후 재생성'으로 단순화 추천)

### 3.2 UI/UX 디자인 (Layout Draft)

**A4 Vertical Layout Structure:**

```
+-------------------------------------------------------+
|  [로고]                 작 업 보 고 서                  |
+-------------------------------------------------------+
|  현 장 명 : OO 아파트 건설공사 3공구                     |
|  작 업 일 : 2026-02-11 (수)          작성자 : 홍길동     |
+-------------------------------------------------------+
|  1. 작업 개요                                          |
|  ---------------------------------------------------  |
|  | 부재명 : 슬라브 | 작업공정 : 면 | 작업유형 : 지붕 | 위치 : 101블록  |
|  ---------------------------------------------------  |
+-------------------------------------------------------+
|  2. 인력 투입 현황 (총 3.5 공수)                        |
|  ---------------------------------------------------  |
|  | 김반장 (1.0) | 이목수 (1.0) | 박조공 (1.0) | ...     |
|  ---------------------------------------------------  |
+-------------------------------------------------------+
|  3. 자재 투입 내역                                     |
|  ---------------------------------------------------  |
|  | NPC-1000 : 300 (말)                                 |
|  ---------------------------------------------------  |
+-------------------------------------------------------+
|  4. 도면 현황                                          |
|  ---------------------------------------------------  |
|  [도면 현황: 전체 5 / 진행 2 / 완료 3]                   |
|  * 완료 도면 이미지 (페이지 넘김 처리)                      |
|  +---------------------+  +---------------------+     |
|  |      도면  1        |  |      도면  2        |     |
|  +---------------------+  +---------------------+     |
|  ---------------------------------------------------  |
+-------------------------------------------------------+
|  5. 현장 사진                                          |
|  ---------------------------------------------------  |
|  * 현장 사진 이미지 (페이지 넘김 처리)                      |
|  +---------------------+  +---------------------+     |
|  |      사진  1        |  |      사진  2        |     |
|  +---------------------+  +---------------------+     |
+-------------------------------------------------------+
|                    (주) 이 노 피 앤 씨                   |
+-------------------------------------------------------+
```

## 4. 데이터베이스 설계 (Database Schema)

기존 `daily_reports` 테이블에 보고서 정보를 담는 컬럼을 추가하거나, 1:1 관계의 별도 테이블을 구성합니다. 관리의 편의성을 위해 **`work_reports`** 별도 테이블 구성을 권장합니다.

**Table: `work_reports`**

| Column Name       | Type        | Description                             |
| :---------------- | :---------- | :-------------------------------------- |
| `id`              | UUID        | PK                                      |
| `daily_report_id` | UUID        | FK -> `daily_reports.id` (Unique)       |
| `file_url`        | TEXT        | 생성된 PDF 파일 경로 (Supabase Storage) |
| `created_at`      | TIMESTAMPTZ | 생성 일시                               |
| `created_by`      | UUID        | 생성자 (본사 관리자)                    |
| `metadata`        | JSONB       | 스냅샷 데이터 (선택적)                  |

## 5. 구현 단계 (Implementation Steps)

1.  **DB 스키마 구성**: `work_reports` 테이블 및 Storage Bucket(`reports`) 설정.
2.  **API 개발**:
    - `POST /api/admin/work-reports`: 보고서 생성 (PDF 생성 -> Storage 업로드 -> DB 저장).
    - `GET /api/work-reports/:id`: 보고서 조회.
    - `DELETE /api/admin/work-reports/:id`: 보고서 삭제.
3.  **PDF 생성 로직 구현**:
    - `@react-pdf/renderer` 도입.
    - A4 레이아웃 컴포넌트 개발 (사진이 많은 경우 자동 페이지 넘김 처리).
4.  **UI 구현 (본사)**:
    - **Progress Feedback**: '작업보고서 생성' 버튼 클릭 시 **진행 상태 모달 또는 토스트** 표시 ("보고서를 생성 중입니다..."). 완료 시 알림 제공.
    - 작업일지 상세 상단 및 하단 관리 섹션 구현.
5.  **UI 구현 (현장/모바일 & 파트너)**:
    - 일지 목록 카드에 '보고서' 버튼 추가.
    - 현장관리자 및 파트너사 화면에서 모두 접근 가능하도록 구현.
    - PDF 미리보기 모달 구현.

---

**확정 사항**:

1.  **PDF 라이브러리**: `@react-pdf/renderer` 사용 확정.
2.  **사진 처리**: 개수 제한 없이 모두 포함하며, 필요 시 페이지를 나누어 출력.
3.  **UX 개선**: 생성 중 **Progress Bar/Loading Indicator** 및 완료 알림 필수 구현.
